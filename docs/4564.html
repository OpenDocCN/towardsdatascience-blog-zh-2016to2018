<html>
<head>
<title>SQLAlchemy — Python Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQLAlchemy-Python 教程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sqlalchemy-python-tutorial-79a577141a91?source=collection_archive---------0-----------------------#2018-08-23">https://towardsdatascience.com/sqlalchemy-python-tutorial-79a577141a91?source=collection_archive---------0-----------------------#2018-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8071" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们经常遇到作为关系数据库的数据。为了使用它们，我们通常需要编写原始的 SQL 查询，将它们传递给数据库引擎，并将返回的结果作为普通的记录数组进行解析。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/285c31f6086fb575feb6ebc687b6f090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D1TpfUof-8amlhN1E2A6JA.png"/></div></div></figure><p id="d403" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SQLAlchemy 提供了一种很好的与数据库交互的“Pythonic 式”方法。因此，您可以利用 SQLAlchemy 的 Pythonic 框架来简化您的工作流并更高效地查询数据，而不是处理传统 SQL(如 MySQL、PostgreSQL 或 Oracle)的特定方言之间的差异。</p><h2 id="2120" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">关于数据科学的其他故事可以在<a class="ae lq" href="https://medium.com/hacking-datascience" rel="noopener">这里</a>找到</h2></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="bc2f" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">安装软件包</h2><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="8acb" class="kx ky iq lz b gy md me l mf mg">pip install sqlalchemy</span></pre><h2 id="d9e5" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">连接到数据库</h2><p id="c5d9" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">为了开始与数据库交互，我们首先需要建立一个连接。</p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="b385" class="kx ky iq lz b gy md me l mf mg">import sqlalchemy as db<br/>engine = db.create_engine('dialect+driver://user:pass<strong class="lz ir">@host</strong>:port/db')</span></pre><p id="7a90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">连接到各种数据库的一些例子可以在<a class="ae lq" href="http://docs.sqlalchemy.org/en/latest/core/engines.html#postgresql" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">这里</strong> </a>找到</p><h2 id="5b21" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">查看表格详细信息</h2><p id="1b79" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">SQLAlchemy 可以用来通过反射从数据库中自动加载表。反射是读取数据库并基于该信息构建元数据的过程。</p><p id="daf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">示例</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mm mn l"/></div></figure><h2 id="a17e" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">询问</h2><p id="b220" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated"><code class="fe mo mp mq lz b">Table</code>和<code class="fe mo mp mq lz b">MetaData</code>已经被导入。元数据以<code class="fe mo mp mq lz b">metadata.</code>的形式提供</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="47f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ResultProxy: <em class="mr">由</em> <code class="fe mo mp mq lz b"><em class="mr">.execute()</em></code> <em class="mr">方法返回的对象。可以通过多种方式使用它来获取查询返回的数据。</em></p><p id="1605" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ResultSet: <em class="mr">在 ResultProxy 上使用诸如</em> <code class="fe mo mp mq lz b"><em class="mr">.fetchall()</em></code> <em class="mr">之类的获取方法时，查询中要求的实际数据。</em></p><p id="8499" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">处理大型 ResultSet </strong></p><p id="f7c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用<code class="fe mo mp mq lz b">.fetchmany()</code>来加载最佳行数，并克服大数据集情况下的内存问题</p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="0683" class="kx ky iq lz b gy md me l mf mg">while flag:<br/>    partial_results = ResultProxy.fetchmany(50)<br/>    if(partial_results == []): <br/>	flag = False<br/>    //<br/>	code<br/>   //<br/>ResultProxy.close()</span></pre><p id="9cc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">转换为数据帧</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="ca74" class="kx ky iq lz b gy md me l mf mg">df = pd.DataFrame(ResultSet)<br/>df.columns = ResultSet[0].keys()</span></pre><p id="1a81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">过滤数据</strong></p><p id="54c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看一些原始 SQLite 查询和使用 SQLAlchemy 的查询的例子。</p><p id="24a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">其中</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="73e7" class="kx ky iq lz b gy md me l mf mg"><strong class="lz ir">SQL :</strong><br/>SELECT * FROM census <br/>WHERE sex = F</span><span id="a738" class="kx ky iq lz b gy ms me l mf mg"><strong class="lz ir">SQLAlchemy :<br/></strong>db.select([census])<!-- -->.<em class="mr">where</em>(census.columns.sex == 'F')</span></pre><p id="1eff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">中的</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="fb19" class="kx ky iq lz b gy md me l mf mg"><strong class="lz ir">SQL :</strong><br/>SELECT state, sex<br/>FROM census<br/>WHERE state IN (Texas, New York)</span><span id="568e" class="kx ky iq lz b gy ms me l mf mg"><strong class="lz ir">SQLAlchemy :</strong><br/>db.select([census.columns.state, <!-- -->census.columns.<!-- -->sex])<!-- -->.where(census.columns.state.<em class="mr">in_</em>(['Texas', 'New York']))</span></pre><p id="7472" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">与，或，非</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="4f71" class="kx ky iq lz b gy md me l mf mg"><strong class="lz ir">SQL :</strong><br/>SELECT * FROM census<br/>WHERE state = 'California' AND NOT sex = 'M'</span><span id="883a" class="kx ky iq lz b gy ms me l mf mg"><strong class="lz ir">SQLAlchemy :</strong><br/>db.select([census])<!-- -->.where(db.<em class="mr">and_</em>(census.columns.state == 'California', census.columns.sex != 'M'))</span></pre><p id="92c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">排序依据</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="5a33" class="kx ky iq lz b gy md me l mf mg"><strong class="lz ir">SQL :</strong><br/>SELECT * FROM census<br/>ORDER BY State DESC, pop2000</span><span id="ef52" class="kx ky iq lz b gy ms me l mf mg"><strong class="lz ir">SQLAlchemy :</strong><br/>db.select([census])<!-- -->.<em class="mr">order_by</em>(db.desc(census.columns.state), census.columns.pop2000)</span></pre><p id="a49e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">功能</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="149c" class="kx ky iq lz b gy md me l mf mg"><strong class="lz ir">SQL :</strong><br/>SELECT SUM(pop2008)<br/>FROM census</span><span id="629f" class="kx ky iq lz b gy ms me l mf mg"><strong class="lz ir">SQLAlchemy :</strong><br/>db.select([db.<em class="mr">func.sum</em>(census.columns.pop2008)])</span></pre><p id="675f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他功能包括<em class="mr">平均值、计数、最小值、最大值</em> …</p><p id="c351" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">分组依据</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="941c" class="kx ky iq lz b gy md me l mf mg"><strong class="lz ir">SQL :</strong><br/>SELECT SUM(pop2008) as pop2008, sex<br/>FROM census</span><span id="96af" class="kx ky iq lz b gy ms me l mf mg"><strong class="lz ir">SQLAlchemy :</strong><br/>db.select([db.func.sum(census.columns.pop2008).label('pop2008'), census.columns.sex]).<em class="mr">group_by</em>(census.columns.sex)</span></pre><p id="87fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">截然不同的</strong></p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="1e82" class="kx ky iq lz b gy md me l mf mg"><strong class="lz ir">SQL :</strong><br/>SELECT DISTINCT state<br/>FROM census</span><span id="eb36" class="kx ky iq lz b gy ms me l mf mg"><strong class="lz ir">SQLAlchemy :</strong><br/>db.select([census.columns.state.<em class="mr">distinct</em>()])</span></pre><p id="85e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">案例&amp;投</strong></p><p id="42fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mo mp mq lz b">case()</code>表达式接受匹配的条件列表和条件匹配时返回的列，如果没有匹配的条件，则接受一个<code class="fe mo mp mq lz b">else_</code>。</p><p id="4dda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mo mp mq lz b">cast()</code>将表达式转换成特定类型的函数</p><p id="acb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">举例</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="e672" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当结果只包含单个值时，我们对结果使用<code class="fe mo mp mq lz b">.scalar</code></p><p id="5254" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">加入</strong></p><p id="da19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有两个已经建立了关系的表，那么只需将每个表中需要的列添加到 select 语句中，就可以自动使用这种关系。</p><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="090a" class="kx ky iq lz b gy md me l mf mg">select([census.columns.pop2008, state_fact.columns.abbreviation])</span></pre><p id="8288" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">例子</strong></p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mm mn l"/></div></figure></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="28e6" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">创建数据并将其插入表格</h2><p id="4b84" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">通过将不存在的数据库传递给引擎，sqlalchemy 会自动创建一个新的数据库。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mm mn l"/></div></figure><h2 id="abc2" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">更新数据库中的数据</h2><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="b02e" class="kx ky iq lz b gy md me l mf mg">db.update(table_name).values(attribute = new_value).where(condition)</span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mm mn l"/></div></figure><h2 id="5188" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">删除表格</h2><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="e766" class="kx ky iq lz b gy md me l mf mg">db.delete(table_name).where(condition)</span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mm mn l"/></div></figure><h2 id="b796" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">放下一张桌子</h2><pre class="km kn ko kp gt ly lz ma mb aw mc bi"><span id="f310" class="kx ky iq lz b gy md me l mf mg">table_name.drop(engine) #drops a single table</span><span id="a3d7" class="kx ky iq lz b gy ms me l mf mg">metadata.drop_all(engine) #drops all the tables in the database</span></pre></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="e2c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个故事的 IPython 笔记本和其他资产可以在<a class="ae lq" href="https://github.com/vinaykudari/hacking-datascience/tree/master/notebooks/sqlalchemy" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">这里</strong> </a>找到</p><p id="2bbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再见😃</p><p id="6cef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">我的其他故事</strong></p><ul class=""><li id="3ee2" class="mt mu iq jp b jq jr ju jv jy mv kc mw kg mx kk my mz na nb bi translated"><a class="ae lq" rel="noopener" target="_blank" href="/build-any-deep-learning-image-classifier-under-15-lines-of-code-using-fastai-v2-123c81c13b">在 15 行代码下构建任意深度学习分类器</a></li><li id="3b43" class="mt mu iq jp b jq nc ju nd jy ne kc nf kg ng kk my mz na nb bi translated"><a class="ae lq" href="https://medium.com/@vinaykudari/protecting-your-internet-identity-4d8ef368caa7" rel="noopener">如何保护自己的互联网身份？</a></li></ul></div></div>    
</body>
</html>