<html>
<head>
<title>An End-to-End Project on Time Series Analysis and Forecasting with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 进行时间序列分析和预测的端到端项目</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/an-end-to-end-project-on-time-series-analysis-and-forecasting-with-python-4835e6bf050b?source=collection_archive---------0-----------------------#2018-07-09">https://towardsdatascience.com/an-end-to-end-project-on-time-series-analysis-and-forecasting-with-python-4835e6bf050b?source=collection_archive---------0-----------------------#2018-07-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/474bc556860f919833f271999d33dff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGJbFHcjXhgUOrWCvho8jg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo credit: Pexels</figcaption></figure><p id="e2b2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://en.wikipedia.org/wiki/Time_series" rel="noopener ugc nofollow" target="_blank">时间序列</a>分析包括分析时间序列数据的方法，以提取有意义的统计数据和数据的其他特征。时间序列预测是使用模型根据以前观察到的值来预测未来值。</p><p id="c3c1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">时间序列广泛用于非平稳数据，如经济、天气、股票价格和本文中的零售额。我们将展示预测零售时间序列的不同方法。我们开始吧！</p><h1 id="842b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">数据</h1><p id="1468" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">我们使用的是<a class="ae la" href="https://community.tableau.com/docs/DOC-1236" rel="noopener ugc nofollow" target="_blank">超市销售数据</a>，可以从<a class="ae la" href="https://community.tableau.com/docs/DOC-1236" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b8e8" class="mn lc iq mj b gy mo mp l mq mr">import warnings<br/>import itertools<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>warnings.filterwarnings("ignore")<br/>plt.style.use('fivethirtyeight')<br/>import pandas as pd<br/>import statsmodels.api as sm<br/>import matplotlib</span><span id="292e" class="mn lc iq mj b gy ms mp l mq mr">matplotlib.rcParams['axes.labelsize'] = 14<br/>matplotlib.rcParams['xtick.labelsize'] = 12<br/>matplotlib.rcParams['ytick.labelsize'] = 12<br/>matplotlib.rcParams['text.color'] = 'k'</span></pre><p id="5d9f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在超市销售数据中有几个类别，我们从家具销售的时间序列分析和预测开始。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="da95" class="mn lc iq mj b gy mo mp l mq mr">df = pd.read_excel("Superstore.xls")<br/>furniture = df.loc[df['Category'] == 'Furniture']</span></pre><p id="f3f3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们有良好的 4 年家具销售数据。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ba8e" class="mn lc iq mj b gy mo mp l mq mr">furniture['Order Date'].min(), furniture['Order Date'].max()</span></pre><p id="f1eb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">时间戳(' 2014–01–06 00:00:00 ')，时间戳(' 2017–12–30 00:00:00 ')</em></strong></p><h1 id="1e3e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">数据预处理</h1><p id="3dd5" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">这一步包括删除我们不需要的列，检查缺少的值，按日期合计销售额等等。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="110b" class="mn lc iq mj b gy mo mp l mq mr">cols = ['Row ID', 'Order ID', 'Ship Date', 'Ship Mode', 'Customer ID', 'Customer Name', 'Segment', 'Country', 'City', 'State', 'Postal Code', 'Region', 'Product ID', 'Category', 'Sub-Category', 'Product Name', 'Quantity', 'Discount', 'Profit']<br/>furniture.drop(cols, axis=1, inplace=True)<br/>furniture = furniture.sort_values('Order Date')</span><span id="1faf" class="mn lc iq mj b gy ms mp l mq mr">furniture.isnull().sum()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/a9020018661ce1afd7560c751626b376.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*M6hu6OC2tztF7mMgfCk8oA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 1</figcaption></figure><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="de89" class="mn lc iq mj b gy mo mp l mq mr">furniture = furniture.groupby('Order Date')['Sales'].sum().reset_index()</span></pre><h1 id="82db" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用时间序列数据进行索引</h1><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e92a" class="mn lc iq mj b gy mo mp l mq mr">furniture = furniture.set_index('Order Date')<br/>furniture.index</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/de557193937832b1e97b4e7b6bd16c57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DzW7KYLD_M6KLtdKBV38TA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 2</figcaption></figure><p id="c791" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们当前的日期时间数据可能很难处理，因此，我们将使用该月的平均日销售额，并且我们使用每个月的月初作为时间戳。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ce63" class="mn lc iq mj b gy mo mp l mq mr">y = furniture['Sales'].resample('MS').mean()</span></pre><p id="97c8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">快速一瞥 2017 年家具销售数据。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="af3f" class="mn lc iq mj b gy mo mp l mq mr">y['2017':]</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/36e0a107631f1d0d05f7f8da3fce7dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sThmSkOvLOGvyYPula8TDA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 3</figcaption></figure><h1 id="00de" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">可视化家具销售时间序列数据</strong></h1><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="43fc" class="mn lc iq mj b gy mo mp l mq mr">y.plot(figsize=(15, 6))<br/>plt.show()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/6efdb7f82cdea3de9b111eb437104ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xDCVJvqJkRymEv2dSIRIPg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 4</figcaption></figure><p id="b234" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当我们绘制数据时，出现了一些明显的模式。该时间序列具有季节性模式，例如销售额总是在年初低，在年底高。在任何一年中，总会有一个上升的趋势，在年中会有几个低的月份。</p><p id="7453" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们还可以使用一种称为时间序列分解的方法来可视化我们的数据，这种方法允许我们将时间序列分解为三个不同的部分:趋势、季节性和噪声。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="007b" class="mn lc iq mj b gy mo mp l mq mr">from pylab import rcParams<br/>rcParams['figure.figsize'] = 18, 8</span><span id="f947" class="mn lc iq mj b gy ms mp l mq mr">decomposition = sm.tsa.seasonal_decompose(y, model='additive')<br/>fig = decomposition.plot()<br/>plt.show()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/73e6da9c2c4a41d6ff6f974fc6fa128f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pmdxT4So6iA4S983UYgTvQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 5</figcaption></figure><p id="8a8f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上图清楚地显示了家具销售的不稳定性，以及其明显的季节性。</p><h1 id="10e1" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">ARIMA 时间序列预测</strong></h1><p id="e12e" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">我们将应用一种最常用的时间序列预测方法，称为 ARIMA，它代表自回归综合移动平均。</p><p id="19dd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">ARIMA 模型用符号<code class="fe mz na nb mj b">ARIMA(p, d, q)</code>表示。这三个参数说明了数据中的季节性、趋势和噪声:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f2b4" class="mn lc iq mj b gy mo mp l mq mr">p = d = q = range(0, 2)<br/>pdq = list(itertools.product(p, d, q))<br/>seasonal_pdq = [(x[0], x[1], x[2], 12) for x in list(itertools.product(p, d, q))]</span><span id="8f99" class="mn lc iq mj b gy ms mp l mq mr">print('Examples of parameter combinations for Seasonal ARIMA...')<br/>print('SARIMAX: {} x {}'.format(pdq[1], seasonal_pdq[1]))<br/>print('SARIMAX: {} x {}'.format(pdq[1], seasonal_pdq[2]))<br/>print('SARIMAX: {} x {}'.format(pdq[2], seasonal_pdq[3]))<br/>print('SARIMAX: {} x {}'.format(pdq[2], seasonal_pdq[4]))</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/731407c47db976e149ca6defb1136bef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ob3xAxvdjdYNRoSxGJUN0g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 6</figcaption></figure><p id="abd2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这一步是为我们的家具销售 ARIMA 时间序列模型选择参数。我们在这里的目标是使用“网格搜索”来找到为我们的模型产生最佳性能的最佳参数集。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0d58" class="mn lc iq mj b gy mo mp l mq mr">for param in pdq:<br/>    for param_seasonal in seasonal_pdq:<br/>        try:<br/>            mod = sm.tsa.statespace.SARIMAX(y,<br/>                                            order=param,<br/>                                            seasonal_order=param_seasonal,<br/>                                            enforce_stationarity=False,<br/>                                            enforce_invertibility=False)</span><span id="1c63" class="mn lc iq mj b gy ms mp l mq mr">results = mod.fit()</span><span id="a822" class="mn lc iq mj b gy ms mp l mq mr">print('ARIMA{}x{}12 - AIC:{}'.format(param, param_seasonal, results.aic))<br/>        except:<br/>            continue</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/790edc40599788e71c1b05a0b0d61fc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tmZVNbBjrxPY5VJOqFxKEw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 7</figcaption></figure><p id="a9e4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面的输出表明<code class="fe mz na nb mj b">SARIMAX(1, 1, 1)x(1, 1, 0, 12)</code>产生最低的<code class="fe mz na nb mj b">AIC</code>值 297.78。因此，我们应该认为这是最佳选择。</p><h1 id="5e25" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">拟合 ARIMA 模型</h1><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f7e9" class="mn lc iq mj b gy mo mp l mq mr">mod = sm.tsa.statespace.SARIMAX(y,<br/>                                order=(1, 1, 1),<br/>                                seasonal_order=(1, 1, 0, 12),<br/>                                enforce_stationarity=False,<br/>                                enforce_invertibility=False)</span><span id="321d" class="mn lc iq mj b gy ms mp l mq mr">results = mod.fit()</span><span id="33e2" class="mn lc iq mj b gy ms mp l mq mr">print(results.summary().tables[1])</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/77a1640a2215a8bd6b5d2ded012b6a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_XmeNOk8CshoEfyb6vDvQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 8</figcaption></figure><p id="5dd2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们应该始终运行模型诊断来调查任何不寻常的行为。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fb22" class="mn lc iq mj b gy mo mp l mq mr">results.plot_diagnostics(figsize=(16, 8))<br/>plt.show()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/71400578cf9ebb8b71b3f24beae353b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HSfgtd2iIp7CQgVlPMRdUw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 9</figcaption></figure><p id="7745" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它并不完美，但是，我们的模型诊断表明，模型残差接近正态分布。</p><h1 id="120d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">验证预测</strong></h1><p id="3487" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">为了帮助我们了解预测的准确性，我们将时间序列的预测销售额与实际销售额进行比较，并将预测从 2017 年 1 月 1 日开始设置到数据结束。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="1ecd" class="mn lc iq mj b gy mo mp l mq mr">pred = results.get_prediction(start=pd.to_datetime('2017-01-01'), dynamic=False)<br/>pred_ci = pred.conf_int()</span><span id="9e18" class="mn lc iq mj b gy ms mp l mq mr">ax = y['2014':].plot(label='observed')<br/>pred.predicted_mean.plot(ax=ax, label='One-step ahead Forecast', alpha=.7, figsize=(14, 7))</span><span id="c826" class="mn lc iq mj b gy ms mp l mq mr">ax.fill_between(pred_ci.index,<br/>                pred_ci.iloc[:, 0],<br/>                pred_ci.iloc[:, 1], color='k', alpha=.2)</span><span id="c6f4" class="mn lc iq mj b gy ms mp l mq mr">ax.set_xlabel('Date')<br/>ax.set_ylabel('Furniture Sales')<br/>plt.legend()</span><span id="16a5" class="mn lc iq mj b gy ms mp l mq mr">plt.show()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/e22e52229ac5db2c334b7736fe722f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3nRjq-BbTJkf0EchAUih8w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 10</figcaption></figure><p id="0bc6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">线形图显示了观测值与滚动预测值的对比。总的来说，我们的预测与真实值非常吻合，显示了从年初开始的上升趋势，并在年底抓住了季节性。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d6a2" class="mn lc iq mj b gy mo mp l mq mr">y_forecasted = pred.predicted_mean<br/>y_truth = y['2017-01-01':]</span><span id="2c15" class="mn lc iq mj b gy ms mp l mq mr">mse = ((y_forecasted - y_truth) ** 2).mean()<br/>print('The Mean Squared Error of our forecasts is {}'.format(round(mse, 2)))</span></pre><p id="8eda" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">我们预测的均方差是 22993.58 </em> </strong></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="af14" class="mn lc iq mj b gy mo mp l mq mr">print('The Root Mean Squared Error of our forecasts is {}'.format(round(np.sqrt(mse), 2)))</span></pre><p id="a31b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">我们预测的均方根误差是 151.64 </em> </strong></p><p id="1ebe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在统计学中，估计量的<a class="ae la" href="https://en.wikipedia.org/wiki/Mean_squared_error" rel="noopener ugc nofollow" target="_blank">均方误差(MSE) </a>衡量误差的平方平均值，即估计值和估计值之间的平均平方差。MSE 是对估计量质量的一种度量，它总是非负的，MSE 越小，我们就越接近找到最佳拟合线。</p><p id="78fb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://en.wikipedia.org/wiki/Root-mean-square_deviation" rel="noopener ugc nofollow" target="_blank">均方根误差(RMSE) </a>告诉我们，我们的模型能够在实际销售额的 151.64 范围内预测测试集中的平均每日家具销售额。我们的家具日销售量从 400 件左右到 1200 多件不等。在我看来，到目前为止这是一个相当不错的模型。</p><h1 id="ac67" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">生成和可视化预测</strong></h1><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ab98" class="mn lc iq mj b gy mo mp l mq mr">pred_uc = results.get_forecast(steps=100)<br/>pred_ci = pred_uc.conf_int()</span><span id="e535" class="mn lc iq mj b gy ms mp l mq mr">ax = y.plot(label='observed', figsize=(14, 7))<br/>pred_uc.predicted_mean.plot(ax=ax, label='Forecast')<br/>ax.fill_between(pred_ci.index,<br/>                pred_ci.iloc[:, 0],<br/>                pred_ci.iloc[:, 1], color='k', alpha=.25)<br/>ax.set_xlabel('Date')<br/>ax.set_ylabel('Furniture Sales')</span><span id="1ccd" class="mn lc iq mj b gy ms mp l mq mr">plt.legend()<br/>plt.show()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/a9bd33c416be4b761b465e7430e4fad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KkKMhgmjYnYIDG-whuywFA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 11</figcaption></figure><p id="bd6e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们的模型清楚地捕捉到了家具销售的季节性。随着我们对未来的进一步预测，我们对自己的价值观变得不那么自信是很自然的。这反映在我们的模型生成的置信区间上，随着我们向未来进一步发展，置信区间变得更大。</p><p id="ee98" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面对家具的时间序列分析让我对其他类别感到好奇，随着时间的推移，它们是如何相互比较的。因此，我们将比较家具和办公用品供应商的时间序列。</p><h1 id="1096" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">家具与办公用品的时间序列</strong></h1><p id="dde1" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">根据我们的数据，这些年来，办公用品的销售额远远高于家具。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f66b" class="mn lc iq mj b gy mo mp l mq mr">furniture = df.loc[df['Category'] == 'Furniture']<br/>office = df.loc[df['Category'] == 'Office Supplies']<br/>furniture.shape, office.shape</span></pre><p id="5bc3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt"> ((2121，21)，(6026，21)) </em> </strong></p><h1 id="0856" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">数据探索</h1><p id="2b65" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">我们将比较两个类别在同一时期的销售额。这意味着将两个数据帧合并成一个，并将这两个类别的时间序列绘制成一个图。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0520" class="mn lc iq mj b gy mo mp l mq mr">cols = ['Row ID', 'Order ID', 'Ship Date', 'Ship Mode', 'Customer ID', 'Customer Name', 'Segment', 'Country', 'City', 'State', 'Postal Code', 'Region', 'Product ID', 'Category', 'Sub-Category', 'Product Name', 'Quantity', 'Discount', 'Profit']<br/>furniture.drop(cols, axis=1, inplace=True)<br/>office.drop(cols, axis=1, inplace=True)</span><span id="d771" class="mn lc iq mj b gy ms mp l mq mr">furniture = furniture.sort_values('Order Date')<br/>office = office.sort_values('Order Date')</span><span id="a977" class="mn lc iq mj b gy ms mp l mq mr">furniture = furniture.groupby('Order Date')['Sales'].sum().reset_index()<br/>office = office.groupby('Order Date')['Sales'].sum().reset_index()</span><span id="3fd1" class="mn lc iq mj b gy ms mp l mq mr">furniture = furniture.set_index('Order Date')<br/>office = office.set_index('Order Date')</span><span id="ceb3" class="mn lc iq mj b gy ms mp l mq mr">y_furniture = furniture['Sales'].resample('MS').mean()<br/>y_office = office['Sales'].resample('MS').mean()</span><span id="a189" class="mn lc iq mj b gy ms mp l mq mr">furniture = pd.DataFrame({'Order Date':y_furniture.index, 'Sales':y_furniture.values})<br/>office = pd.DataFrame({'Order Date': y_office.index, 'Sales': y_office.values})</span><span id="ab65" class="mn lc iq mj b gy ms mp l mq mr">store = furniture.merge(office, how='inner', on='Order Date')<br/>store.rename(columns={'Sales_x': 'furniture_sales', 'Sales_y': 'office_sales'}, inplace=True)<br/>store.head()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/90d22c30b39b62e271801cda6282e8ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*XZdcRvYiFe_AKZs43TPrAg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 12</figcaption></figure><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="473d" class="mn lc iq mj b gy mo mp l mq mr">plt.figure(figsize=(20, 8))<br/>plt.plot(store['Order Date'], store['furniture_sales'], 'b-', label = 'furniture')<br/>plt.plot(store['Order Date'], store['office_sales'], 'r-', label = 'office supplies')<br/>plt.xlabel('Date'); plt.ylabel('Sales'); plt.title('Sales of Furniture and Office Supplies')<br/>plt.legend();</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/09966fece7e49561f8c1a5ebc4e61889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ABh-_dlzzEdAQeKjwD6egA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 13</figcaption></figure><p id="2d5d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们观察到家具和办公用品的销售也有类似的季节性模式。年初是这两个类别的淡季。对于办公用品来说，夏天似乎也很安静。此外，在大多数月份里，家具的平均日销售额都高于办公用品。这是可以理解的，因为家具的价值应该远远高于办公用品。偶尔，办公用品的日平均销售额会超过家具。让我们来看看办公用品的销售额第一次超过家具的销售额是什么时候。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c1c4" class="mn lc iq mj b gy mo mp l mq mr">first_date = store.ix[np.min(list(np.where(store['office_sales'] &gt; store['furniture_sales'])[0])), 'Order Date']</span><span id="b595" class="mn lc iq mj b gy ms mp l mq mr">print("Office supplies first time produced higher sales than furniture is {}.".format(first_date.date()))</span></pre><p id="cfc3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">办公用品首次产生高于家具的销量是 2014–07–01</em></strong>。</p><p id="505d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">那是 2014 年 7 月！</p><h1 id="5943" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">用 Prophet 进行时间序列建模</strong></h1><p id="9c94" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">脸书于 2017 年发布的预测工具<a class="ae la" href="https://research.fb.com/prophet-forecasting-at-scale/" rel="noopener ugc nofollow" target="_blank"> Prophet </a>旨在分析时间序列，这些时间序列在不同的时间尺度上显示模式，如每年、每周和每天。它还具有高级功能，可以对节假日对时间序列的影响进行建模，并实现自定义的变点。因此，我们使用 Prophet 来启动并运行一个模型。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f847" class="mn lc iq mj b gy mo mp l mq mr">from fbprophet import Prophet</span><span id="a8a5" class="mn lc iq mj b gy ms mp l mq mr">furniture = furniture.rename(columns={'Order Date': 'ds', 'Sales': 'y'})<br/>furniture_model = Prophet(interval_width=0.95)<br/>furniture_model.fit(furniture)</span><span id="d500" class="mn lc iq mj b gy ms mp l mq mr">office = office.rename(columns={'Order Date': 'ds', 'Sales': 'y'})<br/>office_model = Prophet(interval_width=0.95)<br/>office_model.fit(office)</span><span id="829d" class="mn lc iq mj b gy ms mp l mq mr">furniture_forecast = furniture_model.make_future_dataframe(periods=36, freq='MS')<br/>furniture_forecast = furniture_model.predict(furniture_forecast)</span><span id="a914" class="mn lc iq mj b gy ms mp l mq mr">office_forecast = office_model.make_future_dataframe(periods=36, freq='MS')<br/>office_forecast = office_model.predict(office_forecast)</span><span id="55b8" class="mn lc iq mj b gy ms mp l mq mr">plt.figure(figsize=(18, 6))<br/>furniture_model.plot(furniture_forecast, xlabel = 'Date', ylabel = 'Sales')<br/>plt.title('Furniture Sales');</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/c37ac0a40acde4a7cf7d4a6dbc2e0c1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qZs_ojNijThKzBPNk9m-Mw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 14</figcaption></figure><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="c1e5" class="mn lc iq mj b gy mo mp l mq mr">plt.figure(figsize=(18, 6))<br/>office_model.plot(office_forecast, xlabel = 'Date', ylabel = 'Sales')<br/>plt.title('Office Supplies Sales');</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/8e487996ce32cded7437e70d52036fa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bIXmoCO8fNr0VrVPEXryNQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 15</figcaption></figure><h1 id="3f2b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">比较预测</strong></h1><p id="030f" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">我们已经有了这两个类别未来三年的预测。我们现在将他们放在一起比较他们对未来的预测。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e77d" class="mn lc iq mj b gy mo mp l mq mr">furniture_names = ['furniture_%s' % column for column in furniture_forecast.columns]<br/>office_names = ['office_%s' % column for column in office_forecast.columns]</span><span id="afc6" class="mn lc iq mj b gy ms mp l mq mr">merge_furniture_forecast = furniture_forecast.copy()<br/>merge_office_forecast = office_forecast.copy()</span><span id="26d0" class="mn lc iq mj b gy ms mp l mq mr">merge_furniture_forecast.columns = furniture_names<br/>merge_office_forecast.columns = office_names</span><span id="918d" class="mn lc iq mj b gy ms mp l mq mr">forecast = pd.merge(merge_furniture_forecast, merge_office_forecast, how = 'inner', left_on = 'furniture_ds', right_on = 'office_ds')</span><span id="a019" class="mn lc iq mj b gy ms mp l mq mr">forecast = forecast.rename(columns={'furniture_ds': 'Date'}).drop('office_ds', axis=1)<br/>forecast.head()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/42c9dc77ca2fe4bf2cbd346088ac640b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wZNvQLTTtIm3YTYCauCaOQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 16</figcaption></figure><h1 id="1152" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">趋势和预测可视化</h1><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="21d2" class="mn lc iq mj b gy mo mp l mq mr">plt.figure(figsize=(10, 7))<br/>plt.plot(forecast['Date'], forecast['furniture_trend'], 'b-')<br/>plt.plot(forecast['Date'], forecast['office_trend'], 'r-')<br/>plt.legend(); plt.xlabel('Date'); plt.ylabel('Sales')<br/>plt.title('Furniture vs. Office Supplies Sales Trend');</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/75e2129a7e88c0d9e89ea2116c81322a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*edG7312_ETG3FgTiXaFk1g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 17</figcaption></figure><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b12b" class="mn lc iq mj b gy mo mp l mq mr">plt.figure(figsize=(10, 7))<br/>plt.plot(forecast['Date'], forecast['furniture_yhat'], 'b-')<br/>plt.plot(forecast['Date'], forecast['office_yhat'], 'r-')<br/>plt.legend(); plt.xlabel('Date'); plt.ylabel('Sales')<br/>plt.title('Furniture vs. Office Supplies Estimate');</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/971e45cb111c3a98fdd0926cd8ab034c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AIri_6z7hjmBhHa_Vv8saA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 18</figcaption></figure><h1 id="50a7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">趋势和模式</strong></h1><p id="4ac5" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">现在，我们可以使用 Prophet 模型来检查数据中这两个类别的不同趋势。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3d69" class="mn lc iq mj b gy mo mp l mq mr">furniture_model.plot_components(furniture_forecast);</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/7bacd4fa733640d5d48c739e6a72af50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FYJ3n87lMXpr0v_4r9j4Tg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 19</figcaption></figure><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="60a4" class="mn lc iq mj b gy mo mp l mq mr">office_model.plot_components(office_forecast);</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/f37b28f1bfa16e4a1258c710d102d168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXw-tN-WvTheIzRi7i_QNg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 20</figcaption></figure><p id="5e38" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">很高兴看到家具和办公用品的销售一直呈线性增长，并将继续增长，尽管办公用品的增长似乎略显强劲。</p><p id="c5f6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">家具最差的月份是四月，办公用品最差的月份是二月。家具最好的月份是 12 月，办公用品最好的月份是 10 月。</p><p id="954c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">今后可以探索的时间序列分析方法有很多，如不确定界预测、变点和异常检测、外部数据源预测时间序列等。我们才刚刚开始。</p><p id="5b67" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">源代码可以在<a class="ae la" href="https://github.com/susanli2016/Machine-Learning-with-Python/blob/master/Time%20Series%20Forecastings.ipynb" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。我期待听到反馈或问题。</p><p id="48ab" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">参考资料:</p><p id="4c10" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://www.digitalocean.com/community/tutorials/a-guide-to-time-series-forecasting-with-arima-in-python-3" rel="noopener ugc nofollow" target="_blank">Python 3 中的 ARIMA 时间序列预测指南</a></p><p id="a0c6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://www.digitalocean.com/community/tutorials/a-guide-to-time-series-forecasting-with-prophet-in-python-3" rel="noopener ugc nofollow" target="_blank">Python 3 中的 Prophet 时间序列预测指南</a></p></div></div>    
</body>
</html>