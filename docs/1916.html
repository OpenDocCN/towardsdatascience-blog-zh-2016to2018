<html>
<head>
<title>Predict Customer Churn with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用R预测客户流失</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predict-customer-churn-with-r-9e62357d47b4?source=collection_archive---------0-----------------------#2017-11-16">https://towardsdatascience.com/predict-customer-churn-with-r-9e62357d47b4?source=collection_archive---------0-----------------------#2017-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/86bb683a96ad80c338ce06c8b7bcb3bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fjeEluO2Te0U4HzK-keIYw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo credit: Pixabay</figcaption></figure><p id="1a96" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于任何一家定期计费的服务公司来说，一个关键的变量就是流失率。《哈佛商业评论》2016年3月 </p><p id="673f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="la">对于这个“即服务”的世界中几乎所有的成长型公司来说，两个最重要的指标是客户流失率和终身价值。创业者，2016年2月</em> </strong></p><h1 id="e0c1" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">介绍</h1><p id="d747" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">当客户或订户停止与公司或服务做生意时，就会发生客户流失，也称为客户流失。它也被称为失去客户或顾客。流失率特别有用的一个行业是电信业，因为大多数客户在一个地理位置内有多种选择。</p><p id="4364" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">类似于<a class="ae me" rel="noopener" target="_blank" href="/predict-employee-turnover-with-python-da4975588aa3">预测员工流动</a>的概念，我们将使用<a class="ae me" href="https://www.ibm.com/communities/analytics/watson-analytics-blog/guide-to-sample-datasets/" rel="noopener ugc nofollow" target="_blank">电信数据集</a>预测客户流失。我们将介绍逻辑回归、决策树和随机森林。但这一次，我们将在r中完成上述所有工作。让我们开始吧！</p><h1 id="39c4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">数据预处理</h1><p id="9422" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">数据是从<a class="ae me" href="https://www.ibm.com/communities/analytics/watson-analytics-blog/guide-to-sample-datasets/" rel="noopener ugc nofollow" target="_blank"> IBM样本数据集</a>下载的。每行代表一个客户，每列包含该客户的属性:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="26e6" class="mo lc iq mk b gy mp mq l mr ms">library(plyr)<br/>library(corrplot)<br/>library(ggplot2)<br/>library(gridExtra)<br/>library(ggthemes)<br/>library(caret)<br/>library(MASS)<br/>library(randomForest)<br/>library(party)</span><span id="1663" class="mo lc iq mk b gy mt mq l mr ms">churn &lt;- read.csv('Telco-Customer-Churn.csv')<br/>str(churn)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/9409139b991862d82cb7fe7a3c398346.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*lCzqRLkaBqLy_c6gg7r3mA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 1</figcaption></figure><ul class=""><li id="5c11" class="mv mw iq ke b kf kg kj kk kn mx kr my kv mz kz na nb nc nd bi translated">customerID</li><li id="64ed" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">性别(女性、男性)</li><li id="3f9c" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">老年人(无论客户是否是老年人(1，0))</li><li id="4730" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">合作伙伴(无论客户是否有合作伙伴(是，否))</li><li id="3c3f" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">家属(客户是否有家属(是，否))</li><li id="2509" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">任期(客户在公司工作的月数)</li><li id="0132" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">电话服务(无论客户是否有电话服务(是，否))</li><li id="cd5f" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">多条线路(客户是否有多条线路(是，否，无电话服务)</li><li id="e684" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">互联网服务(客户的互联网服务提供商(DSL、光纤、否)</li><li id="1624" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">在线安全(客户是否有在线安全(是，否，无互联网服务)</li><li id="006f" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">在线备份(无论客户是否有在线备份(是，否，无互联网服务)</li><li id="2e9f" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">设备保护(客户是否有设备保护(是，否，无互联网服务)</li><li id="f935" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">技术支持(无论客户是否有技术支持(是，否，无互联网服务)</li><li id="1d05" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">流媒体电视(客户是否有流媒体电视(是，否，无互联网服务)</li><li id="b2b9" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">流媒体电影(无论客户是否有流媒体电影(是，否，无互联网服务)</li><li id="df54" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">合同(客户的合同期限(逐月、一年、两年)</li><li id="b67b" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">无纸账单(无论客户是否有无纸账单(是，否))</li><li id="5d23" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">付款方式(客户的付款方式(电子支票、邮寄支票、银行转账(自动)、信用卡(自动)))</li><li id="79e9" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">月度费用(每月向客户收取的金额—数字)</li><li id="1167" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">总费用(向客户收取的总额——数字)</li><li id="3e6c" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">客户流失(客户是否流失(是或否))</li></ul><p id="da1b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">原始数据包含7043行(客户)和21列(特性)。“客户流失”专栏是我们的目标。</p><p id="26fd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们使用sapply来检查每一列中是否有缺失值。我们发现“总费用”列中有11个缺失值。因此，让我们删除所有缺少值的行。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="c96e" class="mo lc iq mk b gy mp mq l mr ms">sapply(churn, function(x) sum(is.na(x)))</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/541d27ceca8b00fd2c23ee2d2d1544be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*TNYVhN3fLBZaDyV1WXA49g.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 2</figcaption></figure><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="833e" class="mo lc iq mk b gy mp mq l mr ms">churn &lt;- churn[complete.cases(churn), ]</span></pre><p id="f181" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">看变量，可以看到我们有些扯皮要做</strong>。</p><ol class=""><li id="c9bc" class="mv mw iq ke b kf kg kj kk kn mx kr my kv mz kz nk nb nc nd bi translated">我们将六个栏目的“无互联网服务”改为“无”，它们是:“在线安全”、“在线备份”、“设备保护”、“技术支持”、“流媒体电视”、“流媒体电影”。</li></ol><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="373a" class="mo lc iq mk b gy mp mq l mr ms">cols_recode1 &lt;- c(10:15)<br/>for(i in 1:ncol(churn[,cols_recode1])) {<br/>        churn[,cols_recode1][,i] &lt;- as.factor(mapvalues<br/>                                              (churn[,cols_recode1][,i], from =c("No internet service"),to=c("No")))<br/>}</span></pre><p id="4c11" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">2.我们将把“多线”栏中的“无电话服务”改为“无”</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="f0c8" class="mo lc iq mk b gy mp mq l mr ms">churn$MultipleLines &lt;- as.factor(mapvalues(churn$MultipleLines, <br/>                                           from=c("No phone service"),<br/>                                           to=c("No")))</span></pre><p id="fd70" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">3.由于最短任期为1个月，最长任期为72个月，我们可以将他们分为五个任期组:“0-12个月”、“12-24个月”、“24-48个月”、“48-60个月”、“60个月以上”</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="1f99" class="mo lc iq mk b gy mp mq l mr ms">min(churn$tenure); max(churn$tenure)</span></pre><p id="d4a5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"><em class="la">【1】1</em></strong></p><p id="ca81" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"><em class="la">【1】72</em></strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="3299" class="mo lc iq mk b gy mp mq l mr ms">group_tenure &lt;- function(tenure){<br/>    if (tenure &gt;= 0 &amp; tenure &lt;= 12){<br/>        return('0-12 Month')<br/>    }else if(tenure &gt; 12 &amp; tenure &lt;= 24){<br/>        return('12-24 Month')<br/>    }else if (tenure &gt; 24 &amp; tenure &lt;= 48){<br/>        return('24-48 Month')<br/>    }else if (tenure &gt; 48 &amp; tenure &lt;=60){<br/>        return('48-60 Month')<br/>    }else if (tenure &gt; 60){<br/>        return('&gt; 60 Month')<br/>    }<br/>}</span><span id="ab20" class="mo lc iq mk b gy mt mq l mr ms">churn$tenure_group &lt;- sapply(churn$tenure,group_tenure)<br/>churn$tenure_group &lt;- as.factor(churn$tenure_group)</span></pre><p id="24b9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">4.将“老年人”列中的值从0或1更改为“否”或“是”。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="75d9" class="mo lc iq mk b gy mp mq l mr ms">churn$SeniorCitizen &lt;- as.factor(mapvalues(churn$SeniorCitizen,<br/>                                      from=c("0","1"),<br/>                                      to=c("No", "Yes")))</span></pre><p id="a71e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">5.删除分析中不需要的列。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="fdfd" class="mo lc iq mk b gy mp mq l mr ms">churn$customerID &lt;- NULL<br/>churn$tenure &lt;- NULL</span></pre><h1 id="9f95" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">探索性数据分析和特征选择</h1><p id="6689" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated"><strong class="ke ir">数值变量之间的相关性</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="fe8b" class="mo lc iq mk b gy mp mq l mr ms">numeric.var &lt;- sapply(churn, is.numeric)<br/>corr.matrix &lt;- cor(churn[,numeric.var])<br/>corrplot(corr.matrix, main="\n\nCorrelation Plot for Numerical Variables", method="number")</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/65e44a57f32393dd9eb7e1efa1802c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DK3lmlJn9pHJ2LiYeUdvgQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 3</figcaption></figure><p id="703f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每月费用和总费用是相互关联的。因此其中一个将从模型中移除。我们取消所有指控。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="1aa9" class="mo lc iq mk b gy mp mq l mr ms">churn$TotalCharges &lt;- NULL</span></pre><p id="7106" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">分类变量柱状图</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="def0" class="mo lc iq mk b gy mp mq l mr ms">p1 &lt;- ggplot(churn, aes(x=gender)) + ggtitle("Gender") + xlab("Gender") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p2 &lt;- ggplot(churn, aes(x=SeniorCitizen)) + ggtitle("Senior Citizen") + xlab("Senior Citizen") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p3 &lt;- ggplot(churn, aes(x=Partner)) + ggtitle("Partner") + xlab("Partner") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p4 &lt;- ggplot(churn, aes(x=Dependents)) + ggtitle("Dependents") + xlab("Dependents") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>grid.arrange(p1, p2, p3, p4, ncol=2)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/3a51fc5720fc2554a265f107d9cb315d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1u56gvFs5KrsolFEqkJrPQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 4</figcaption></figure><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="98b5" class="mo lc iq mk b gy mp mq l mr ms">p5 &lt;- ggplot(churn, aes(x=PhoneService)) + ggtitle("Phone Service") + xlab("Phone Service") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p6 &lt;- ggplot(churn, aes(x=MultipleLines)) + ggtitle("Multiple Lines") + xlab("Multiple Lines") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p7 &lt;- ggplot(churn, aes(x=InternetService)) + ggtitle("Internet Service") + xlab("Internet Service") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p8 &lt;- ggplot(churn, aes(x=OnlineSecurity)) + ggtitle("Online Security") + xlab("Online Security") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>grid.arrange(p5, p6, p7, p8, ncol=2)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/63ffef201dfacd2d5ca1df955a8d780d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1iuzicf6etsPA_xgE2DhTA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 5</figcaption></figure><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="29e8" class="mo lc iq mk b gy mp mq l mr ms">p9 &lt;- ggplot(churn, aes(x=OnlineBackup)) + ggtitle("Online Backup") + xlab("Online Backup") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p10 &lt;- ggplot(churn, aes(x=DeviceProtection)) + ggtitle("Device Protection") + xlab("Device Protection") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p11 &lt;- ggplot(churn, aes(x=TechSupport)) + ggtitle("Tech Support") + xlab("Tech Support") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p12 &lt;- ggplot(churn, aes(x=StreamingTV)) + ggtitle("Streaming TV") + xlab("Streaming TV") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>grid.arrange(p9, p10, p11, p12, ncol=2)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/48930d0533d38c2eb671995e60f779b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UH5yuFzkmZrpx0jHmOlR5g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 6</figcaption></figure><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="fe91" class="mo lc iq mk b gy mp mq l mr ms">p13 &lt;- ggplot(churn, aes(x=StreamingMovies)) + ggtitle("Streaming Movies") + xlab("Streaming Movies") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p14 &lt;- ggplot(churn, aes(x=Contract)) + ggtitle("Contract") + xlab("Contract") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p15 &lt;- ggplot(churn, aes(x=PaperlessBilling)) + ggtitle("Paperless Billing") + xlab("Paperless Billing") + <br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p16 &lt;- ggplot(churn, aes(x=PaymentMethod)) + ggtitle("Payment Method") + xlab("Payment Method") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>p17 &lt;- ggplot(churn, aes(x=tenure_group)) + ggtitle("Tenure Group") + xlab("Tenure Group") +<br/>  geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.5) + ylab("Percentage") + coord_flip() + theme_minimal()<br/>grid.arrange(p13, p14, p15, p16, p17, ncol=2)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/f4a671ea3442ea282e484a1ab7161a74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LksNF90mGVM2ulelwg1_Hg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 7</figcaption></figure><p id="c4b9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所有的分类变量似乎有一个合理的广泛分布，因此，他们都将被保留，以供进一步分析。</p><h1 id="4483" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">逻辑回归</h1><p id="0f19" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated"><strong class="ke ir">首先，我们将数据分成训练集和测试集</strong>:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="7a07" class="mo lc iq mk b gy mp mq l mr ms">intrain&lt;- createDataPartition(churn$Churn,p=0.7,list=FALSE)<br/>set.seed(2017)<br/>training&lt;- churn[intrain,]<br/>testing&lt;- churn[-intrain,]</span></pre><p id="0b66" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">确认分割正确</strong>:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="8ce5" class="mo lc iq mk b gy mp mq l mr ms">dim(training); dim(testing)</span></pre><p id="ab9e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"><em class="la">【1】4924</em>19</strong></p><p id="3c06" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"><em class="la">【1】2108 19</em></strong></p><p id="01db" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">拟合逻辑回归模型</strong>:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="51ec" class="mo lc iq mk b gy mp mq l mr ms">LogModel &lt;- glm(Churn ~ .,family=binomial(link="logit"),data=training)<br/>print(summary(LogModel))</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/ecb35cc6186a3ca095d0cb51e380e53e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*CT_idKUmPa_Ugq4WoJIHkA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 8</figcaption></figure><p id="3dfc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">特征分析</strong>:</p><p id="a57d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">前三个最相关的功能包括合同，任期_组和无纸账单。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="4758" class="mo lc iq mk b gy mp mq l mr ms">anova(LogModel, test="Chisq")</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/b4f93301fa66a678056f8e050eda61a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*ouZR49yERQHKJHC8qbu14g.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 9</figcaption></figure><p id="b565" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">分析偏差表，我们可以看到每次增加一个变量时偏差的下降。加入互联网服务、合同和保有权组显著降低了剩余偏离度。其他变量如PaymentMethod和Dependents对模型的改善似乎较小，尽管它们都具有较低的p值。</p><p id="fad7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">评估逻辑回归模型的预测能力</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="07e9" class="mo lc iq mk b gy mp mq l mr ms">testing$Churn &lt;- as.character(testing$Churn)<br/>testing$Churn[testing$Churn=="No"] &lt;- "0"<br/>testing$Churn[testing$Churn=="Yes"] &lt;- "1"<br/>fitted.results &lt;- predict(LogModel,newdata=testing,type='response')<br/>fitted.results &lt;- ifelse(fitted.results &gt; 0.5,1,0)<br/>misClasificError &lt;- mean(fitted.results != testing$Churn)<br/>print(paste('Logistic Regression Accuracy',1-misClasificError))</span></pre><p id="49f7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"><em class="la">【1】Logistic回归精度0.789373814041746 </em> </strong></p><p id="9929" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">逻辑回归混淆矩阵</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a51b" class="mo lc iq mk b gy mp mq l mr ms">print("Confusion Matrix for Logistic Regression"); table(testing$Churn, fitted.results &gt; 0.5)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/16fe54aefb84559879e131e148e53b90.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*rhZrnmf7oO2tiDbZdQ1ccw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 10</figcaption></figure><p id="3c19" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">赔率比</strong></p><p id="0e45" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">逻辑回归中一个有趣的性能测量是优势比。基本上，比值比是一个事件发生的概率。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="afa2" class="mo lc iq mk b gy mp mq l mr ms">library(MASS)<br/>exp(cbind(OR=coef(LogModel), confint(LogModel)))</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/11254fb6e738a99f8968b928e1df3c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*zYF3ny7Rlc2ch72GdNOZRA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 11</figcaption></figure><h1 id="7e60" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">决策树</strong></h1><p id="0c90" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated"><strong class="ke ir">决策树可视化</strong></p><p id="291c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了便于说明，我们将只使用三个变量来绘制决策树，它们是“合同”、“任期_组”和“无纸账单”。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="cd77" class="mo lc iq mk b gy mp mq l mr ms">tree &lt;- ctree(Churn~Contract+tenure_group+PaperlessBilling, training)<br/>plot(tree)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/8349ed665a4a7683107835f746091324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HrhnLQEvxkj2_a6hnjrSvg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 12</figcaption></figure><ol class=""><li id="2a78" class="mv mw iq ke b kf kg kj kk kn mx kr my kv mz kz nk nb nc nd bi translated">在我们使用的三个变量中，合同是预测客户流失与否的最重要变量。</li><li id="0910" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz nk nb nc nd bi translated">如果客户是一年期或两年期合同，无论他(她)是否有纸质账单，他(她)都不太可能流失。</li><li id="3126" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz nk nb nc nd bi translated">另一方面，如果客户签订的是逐月合同，租期为0-12个月，并且使用无纸化账单，那么该客户更有可能流失。</li></ol><p id="1191" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">决策树混淆矩阵</strong></p><p id="4efc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们使用所有变量来制作混淆矩阵表并做出预测。</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="2921" class="mo lc iq mk b gy mp mq l mr ms">pred_tree &lt;- predict(tree, testing)<br/>print("Confusion Matrix for Decision Tree"); table(Predicted = pred_tree, Actual = testing$Churn)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/876b9be4d26afdfb8c84bdf5b28ab144.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*UvSMS64NUo-Mzk9CiH2DPQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 13</figcaption></figure><p id="01a4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">决策树精度</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a4a8" class="mo lc iq mk b gy mp mq l mr ms">p1 &lt;- predict(tree, training)<br/>tab1 &lt;- table(Predicted = p1, Actual = training$Churn)<br/>tab2 &lt;- table(Predicted = pred_tree, Actual = testing$Churn)<br/>print(paste('Decision Tree Accuracy',sum(diag(tab2))/sum(tab2)))</span></pre><p id="26e9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"><em class="la">【1】决策树准确率0.780834914611006 </em> </strong></p><p id="5847" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">决策树的准确性几乎没有提高。让我们看看使用随机森林是否能做得更好。</p><h1 id="7cfe" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">随机森林</h1><p id="7659" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated"><strong class="ke ir">随机森林初始模型</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="2e3e" class="mo lc iq mk b gy mp mq l mr ms">rfModel &lt;- randomForest(Churn ~., data = training)<br/>print(rfModel)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/e9335bf26e9ce7ec14984d4616f82fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*Km-q5h753Lqt65peMrVOHw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 14</figcaption></figure><p id="98d8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">预测“否”时错误率相对较低，预测“是”时错误率高得多。</p><p id="b892" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">随机森林预测和混淆矩阵</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="209f" class="mo lc iq mk b gy mp mq l mr ms">pred_rf &lt;- predict(rfModel, testing)<br/>caret::confusionMatrix(pred_rf, testing$Churn)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/89750ab450fcddde51185c1facf38ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*_28y652lqzk_f_ivNHpy4Q.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 15</figcaption></figure><p id="7b02" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">随机森林错误率</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="cea8" class="mo lc iq mk b gy mp mq l mr ms">plot(rfModel)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/b5dde8ef7478a2905a3fbecff20e1e81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpNaTyIXTppf8sYLLKqNOA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 16</figcaption></figure><p id="606c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们用这个图来帮助我们确定树的数量。随着树的数量增加，OOB错误率降低，然后变得几乎恒定。我们不能在大约100到200棵树后降低OOB错误率。</p><p id="0e99" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">调整随机森林模型</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="b8bb" class="mo lc iq mk b gy mp mq l mr ms">t &lt;- tuneRF(training[, -18], training[, 18], stepFactor = 0.5, plot = TRUE, ntreeTry = 200, trace = TRUE, improve = 0.05)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/9ecf3fef4413ce0c21198f811cd02a89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WRjfwFBrvY429h6jie-Bjw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 17</figcaption></figure><p id="ed4a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们用这个图来给我们一些选择项目数量的想法。当mtry为2时，OOB误码率最低。因此，我们选择mtry=2。</p><p id="71fa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">调整后拟合随机森林模型</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="254f" class="mo lc iq mk b gy mp mq l mr ms">rfModel_new &lt;- randomForest(Churn ~., data = training, ntree = 200, mtry = 2, importance = TRUE, proximity = TRUE)<br/>print(rfModel_new)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/270002f92a0be20ddb772aff42cdb11c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*7VCNV3gzo0lOgn8kG4ZQYg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 18</figcaption></figure><p id="8f44" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">OOB误差率从图14的20.61%下降到20.41%。</p><p id="b43f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">随机森林预测和调优后的混乱矩阵</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="a1ad" class="mo lc iq mk b gy mp mq l mr ms">pred_rf_new &lt;- predict(rfModel_new, testing)<br/>caret::confusionMatrix(pred_rf_new, testing$Churn)</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/48b27ac96bb9f6fe706d309d7bb87910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*NmXcw685gb3Qkrjq4LwPoQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 19</figcaption></figure><p id="93e9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">与图15相比，精确度和灵敏度都得到了提高。</p><p id="da97" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">随机森林特征重要性</strong></p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="4647" class="mo lc iq mk b gy mp mq l mr ms">varImpPlot(rfModel_new, sort=T, n.var = 10, main = 'Top 10 Feature Importance')</span></pre><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/493069d7b475146c3515ee996503c967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yk6IcGibGtNCUNj9rM5c-g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 20</figcaption></figure><h1 id="22cc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">摘要</h1><p id="1aa5" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">从上面的例子，我们可以看到，逻辑回归，决策树和随机森林可以用于客户流失分析这一特定的数据集一样好。</p><p id="c59b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在整个分析过程中，我学到了几件重要的事情:</p><ul class=""><li id="ae3f" class="mv mw iq ke b kf kg kj kk kn mx kr my kv mz kz na nb nc nd bi translated">诸如使用权组、合同、无纸账单、月费和互联网服务等功能似乎在客户流失中发挥了作用。</li><li id="cd87" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">性别和客户流失之间似乎没有关系。</li><li id="0d4c" class="mv mw iq ke b kf ne kj nf kn ng kr nh kv ni kz na nb nc nd bi translated">月结合同、无单据账单且任期在12个月以内的客户更有可能流失；另一方面，拥有一年或两年合同、超过12个月任期、不使用无纸化计费的客户不太可能流失。</li></ul><p id="c4e1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建这篇文章的源代码可以在<a class="ae me" href="https://github.com/susanli2016/Data-Analysis-with-R/blob/master/customer_churn.Rmd" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我将很高兴收到关于上述任何反馈或问题。</p></div></div>    
</body>
</html>