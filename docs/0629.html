<html>
<head>
<title>Tutorial: Data Wrangling and Mapping in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">教程:R 中的数据争论和映射</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tutorial-data-wrangling-and-mapping-in-r-ec828acc8073?source=collection_archive---------2-----------------------#2017-05-30">https://towardsdatascience.com/tutorial-data-wrangling-and-mapping-in-r-ec828acc8073?source=collection_archive---------2-----------------------#2017-05-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d983" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">揭露了推动布鲁克林中产阶级化的房东</h2></div><p id="2cbd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想我以前说过…但是我喜欢地图。几乎每个人都在使用它们，这使得地图成为一种惊人的即时交流大量数据的方式，而不用担心淹没你的观众。</p><p id="b524" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我最喜欢的处理空间数据的工具之一是 r。除了非常适合处理数据之外，其广泛的用户基础意味着有许多软件包可以使定制地图制作变得超级快速和简单。</p><p id="88c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本教程旨在提供一个使用 R 操作和映射数据的粗略的端到端示例。目标是创建一幅地图，展示纽约布鲁克林区住宅建筑所有权的集中情况。</p><p id="aee3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除了最近发布的<a class="ae lb" href="https://cran.r-project.org/web/packages/cartography/index.html" rel="noopener ugc nofollow" target="_blank">制图</a>包之外，我们还将使用来自纽约市 OpenData 门户网站的一些数据集。</p><p id="0646" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要完成本教程，您需要以下工具:</p><ul class=""><li id="2c4a" class="lc ld iq kh b ki kj kl km ko le ks lf kw lg la lh li lj lk bi translated"><a class="ae lb" href="https://cran.r-project.org/" rel="noopener ugc nofollow" target="_blank">T3】RT5】</a></li><li id="3222" class="lc ld iq kh b ki ll kl lm ko ln ks lo kw lp la lh li lj lk bi translated"><a class="ae lb" href="https://www.rstudio.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> R Studio </strong> </a> <strong class="kh ir">或任何其他 IDE </strong></li></ul><h2 id="4645" class="lq lr iq bd ls lt lu dn lv lw lx dp ly ko lz ma mb ks mc md me kw mf mg mh mi bi translated">设置环境和下载数据</h2><p id="01fd" class="pw-post-body-paragraph kf kg iq kh b ki mj jr kk kl mk ju kn ko ml kq kr ks mm ku kv kw mn ky kz la ij bi translated"><strong class="kh ir"> 1)克隆 GitHub 库</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="13fa" class="lq lr iq mt b gy mx my l mz na"><a class="ae lb" href="https://github.com/spnichol/mapping_tutorial.git" rel="noopener ugc nofollow" target="_blank">git clone https://github.com/spnichol/mapping_tutorial.git</a><br/>cd mapping_tutorial</span></pre><p id="61c2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2)创建一个新的 R 脚本并设置你的工作目录</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ee64" class="lq lr iq mt b gy mx my l mz na">setwd("/home/you/mapping_tutorial")</span></pre><p id="a97d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3)安装软件包并加载前两个数据集</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="8237" class="lq lr iq mt b gy mx my l mz na">install.packages(c("cartography", "rgdal", "sp"))<br/><br/>#ownership registrations <br/>owners &lt;- read.csv("data/owners.csv")<br/><br/>#building data <br/>bldgs &lt;- read.csv("data/bldg.csv")</span></pre><p id="9e7e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个文件是<a class="ae lb" href="https://data.cityofnewyork.us/Housing-Development/Multiple-Dwelling-Registrations/tesw-yqqr" rel="noopener ugc nofollow" target="_blank">多处住所登记</a>，一个有三个或更多单元的住宅建筑的登记。第二个是<a class="ae lb" href="https://data.cityofnewyork.us/Housing-Development/Registration-Contacts/feu5-w2e2" rel="noopener ugc nofollow" target="_blank">注册联系人</a>，包含以前文件中与建筑物所有者相关的信息。</p><h1 id="5297" class="nb lr iq bd ls nc nd ne lv nf ng nh ly jw ni jx mb jz nj ka me kc nk kd mh nl bi translated">探索数据</h1><p id="fb28" class="pw-post-body-paragraph kf kg iq kh b ki mj jr kk kl mk ju kn ko ml kq kr ks mm ku kv kw mn ky kz la ij bi translated">我们这个项目的目标是了解布鲁克林建筑所有权的集中情况。因此，一个自然的起点是所有权文件。</p><p id="8f2c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看几个记录来了解一下我们的情况。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="86d0" class="lq lr iq mt b gy mx my l mz na">head(owners)</span></pre><p id="f3f8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您的输出应该如下所示:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nm"><img src="../Images/dd00287712ae19dd71e704b92dc16244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Z6GsN6F7FqJ7ZAvzAtk3Q.png"/></div></div></figure><p id="b6d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来我们有两个 ID 变量:<strong class="kh ir"> RegistrationContactID </strong>和<strong class="kh ir"> RegistrationID </strong>。第一个是指该行中列出的个人/公司，而第二个是指该个人/实体进行的特定建筑登记。</p><p id="9e30" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还有<strong class="kh ir"> CorporationName </strong>栏，可以提供一些关于谁拥有什么的信息。让我们对<strong class="kh ir"> RegistrationContactID </strong>和<strong class="kh ir"> CorporationName </strong>使用<code class="fe nu nv nw mt b">aggregate</code>函数。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="5c60" class="lq lr iq mt b gy mx my l mz na">owner_count &lt;- aggregate(RegistrationID ~ RegistrationContactID, data=owners, FUN=length)<br/>names(owner_count) &lt;- c("RegistrationContactID", "Building_Count")<br/>head(owner_count)<br/>nrow(owner_count[owner_count$Building_Count &gt; 2 ,])</span></pre><p id="450e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您的输出应该如下所示:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nx"><img src="../Images/5c4ecb6f0e25cbcba8f07a4f1aa9cd37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b-ek3X6u5qlZtEqSfoNO1Q.png"/></div></div></figure><p id="d9ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们有了一个列，其中包含每个唯一的<strong class="kh ir"> RegistrationContactID </strong>以及与之对应的建筑数量。除了一些看起来很奇怪的 id(只是杂乱的数据)，有点奇怪的是，我们只有 274 个拥有两栋以上建筑的业主。让我们试试<strong class="kh ir">公司名称</strong>。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0391" class="lq lr iq mt b gy mx my l mz na">owner_count &lt;- aggregate(org_agg &lt;- aggregate(RegistrationID ~ CorporationName, data=owners, FUN=length)<br/>names(org_agg) &lt;- c("CorporationName", "Building_Count")<br/>head(org_agg)<br/>nrow(org_agg[org_agg$Building_Count &gt; 2 ,])</span></pre><p id="307e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/6badf42e212abf54f9eee636cfe72642.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*1pQ1HmMHMl1JPdAws2pKIw.png"/></div></figure><p id="7962" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">呀。建筑数量要好得多，但这些是一些令人讨厌的错别字。让我们通过删除所有非字母数字字符，然后设置子集以仅保留非空行来修复它们。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="aa24" class="lq lr iq mt b gy mx my l mz na">org_agg$CorporationName&lt;- gsub("[^[:alnum:][:blank:]]", "", org_agg$CorporationName)<br/>org_agg &lt;- org_agg[org_agg$CorporationName !="" ,]<br/>head(org_agg)<br/>nrow(org_agg[org_agg$Building_Count &gt; 2 ,])</span></pre><p id="61df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nz"><img src="../Images/7134dfe9eeab86d840b7664f5dcd8bd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GflnMxQtqnxiLEXjmb0gRw.png"/></div></div></figure><p id="eb7b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗯嗯。公司名称看起来好一点，但我仍然不相信拥有两栋以上建筑的业主数量。这个数据集包括整个纽约市。这个城市有很多建筑，有很多房东。会不会是同一个房东或者管理公司用不同的名字/id 登记了不同的楼栋？</p><p id="d670" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们看看他们的邮寄地址呢？让我们假设一个用不同名字注册的房东仍然想只在一个办公室接收他/她的邮件。我们可以通过合并 BusinessHouseNumber 和 BusinessStreetName 列来创建一个新变量，并再次运行我们的聚合。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3506" class="lq lr iq mt b gy mx my l mz na">owners$RealID &lt;- paste(owners$BusinessHouseNumber, owners$BusinessStreetName, sep=" ")<br/>real_agg &lt;- aggregate(RegistrationID ~ RealID, data=owners, FUN=length)<br/>names(real_agg) &lt;- c("RealID", "Building_Count")<br/>nrow(real_agg[real_agg$Building_Count &gt; 2 ,])</span></pre><p id="32ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是的——这更有道理。我们不能 100%确定其中的一些实际上不是共享同一个邮件地址的不同房东，但是我认为我们可以假设这不是本教程的情况。</p><p id="94d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，有一个问题。如果您还没有注意到，许多<strong class="kh ir">注册 id</strong>包括多个联系人，每个联系人的<strong class="kh ir">类型</strong>的值都不同。在我们开始过滤它们之前，让我们先了解一下值的范围。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ce80" class="lq lr iq mt b gy mx my l mz na">summary(owners$Type)</span></pre><p id="b9c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们得到的结果:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi oa"><img src="../Images/272f0f70d685097388e9d677d382c87d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*do7XI3KF12U_Soyty7KDgQ.png"/></div></div></figure><p id="ccc3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们<em class="ob">可以</em>对数据帧进行子集化，只保留与所有者相关的角色类型。但这可能会导致一些问题，因为所有者不需要成为这类注册的“联系人”。</p><p id="81d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相反，让我们删除重复的<strong class="kh ir"> RegistrationID </strong>并重新运行我们的<code class="fe nu nv nw mt b">aggregate</code>函数。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="1e85" class="lq lr iq mt b gy mx my l mz na">owners &lt;- owners[! duplicated(owners$RegistrationID) ,]<br/>real_agg &lt;- aggregate(RegistrationID ~ RealID, data=owners, FUN=length)<br/>names(real_agg) &lt;- c("RealID", "Building_Count")<br/>nrow(real_agg[real_agg$Building_Count &gt; 2 ,])</span></pre><p id="f4d7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来，在删除重复的注册 id 后，我们有大约 5000 名拥有两栋以上建筑物的业主。</p><p id="bab8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们进入教程的下一步之前，让我们将 Building_Count 列与主 owners 数据帧结合起来。我们可以用一个简单的<code class="fe nu nv nw mt b">merge</code>来做这件事。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3a65" class="lq lr iq mt b gy mx my l mz na">owners &lt;- merge(x=owners, y=real_agg, by="RealID")</span></pre><h1 id="ad4b" class="nb lr iq bd ls nc nd ne lv nf ng nh ly jw ni jx mb jz nj ka me kc nk kd mh nl bi translated">组合数据帧</h1><p id="8699" class="pw-post-body-paragraph kf kg iq kh b ki mj jr kk kl mk ju kn ko ml kq kr ks mm ku kv kw mn ky kz la ij bi translated">既然我们有了如何定义建筑物所有权的策略，我们需要将最近更新的所有者数据框架与建筑物数据集合并。这将为我们提供教程的制图部分所需的 GIS 信息。</p><p id="44df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 1)探索建筑数据框架的变量</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="cd0a" class="lq lr iq mt b gy mx my l mz na">head(bldgs)</span></pre><p id="81ac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的输出如下所示:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi oc"><img src="../Images/93b22b1e31eca7a23bc53b0263c0bbca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1l-DJZGSNlUKQ0__ptqf3A.png"/></div></div></figure><p id="c3f5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">很好，看起来两个数据集共享了<strong class="kh ir">注册 ID </strong>变量。这意味着该数据帧中的每个条目对应于所有者数据帧中的一个注册 ID。我们可以使用这个列作为<code class="fe nu nv nw mt b">merge</code>函数的 ID。</p><p id="d0b9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2)注册 ID 合并</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2e14" class="lq lr iq mt b gy mx my l mz na">bldg_counts&lt;- merge(x=bldgs, y=owners, by="RegistrationID")</span></pre><p id="f9f2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">合并成功了，但是我们丢失了几行。令人恼火的是，事实证明某些类型的属性被允许使用相同的注册 ID，即使它们有不同的地址。这在数据文档中有更详细的解释。</p><h1 id="e59b" class="nb lr iq bd ls nc nd ne lv nf ng nh ly jw ni jx mb jz nj ka me kc nk kd mh nl bi translated">探索空间变量</h1><p id="faa1" class="pw-post-body-paragraph kf kg iq kh b ki mj jr kk kl mk ju kn ko ml kq kr ks mm ku kv kw mn ky kz la ij bi translated">现在是有趣的事情。我们需要弄清楚我们可以使用什么样的 GIS 变量来汇总和绘制这些信息。让我们再来看看我们最近合并的数据框架。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="99a9" class="lq lr iq mt b gy mx my l mz na">bldg_counts&lt;- merge(x=bldgs, y=owners, by="RegistrationID")</span></pre><p id="c155" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi od"><img src="../Images/41ff1fb576ddfcee654789a7327836ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8r8anAXDJN9dKDB6PmGHcg.png"/></div></div></figure><p id="9708" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来我们有两个地理变量的选择。第一个是建筑物地址，可以通过组合<strong class="kh ir">门牌号</strong>和<strong class="kh ir">街道名称</strong>列得到。然而，为了绘制这些信息，我们必须首先对地址进行地理编码。工作太多。</p><p id="068b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还有<strong class="kh ir">块</strong>和<strong class="kh ir">批次</strong>变量。纽约市的街区编号是唯一的，这意味着我们可以汇总每个街区的建筑数量，因为房东拥有不止一栋建筑。该城市还提供带有块级多边形的形状文件，允许我们绘制数据。然而，布鲁克林有成千上万个街区，每个街区只有少数几栋建筑，所以这可能不会太有意义。</p><p id="1586" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事实上，这些变量中没有一个能提供我们真正需要的。相反，我们来介绍一个新的数据集:冥王星。<a class="ae lb" href="https://www1.nyc.gov/site/planning/data-maps/open-data/dwn-pluto-mappluto.page" rel="noopener ugc nofollow" target="_blank">冥王星数据集</a>是纽约市建筑统计的圣杯，包括从纬度和经度到财产价值的一切。</p><p id="f3b2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 1)读入 PLUTO CSV 文件并探索变量</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3e21" class="lq lr iq mt b gy mx my l mz na">pluto_bk &lt;- read.csv("data/pluto.csv")<br/>names(pluto_bk)</span></pre><p id="a4b4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi oe"><img src="../Images/824593b369e30cb7f9527a2754a8c4a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wcQYCtTBtsBC4LUMPJSHpA.png"/></div></div></figure><p id="ca06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">明白我的意思了吗？让我们只保留相关的列。</p><p id="0d5b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2)删除不必要的列</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="8265" class="lq lr iq mt b gy mx my l mz na">pluto_bk &lt;- pluto_bk[, c(4, 5, 6, 58,71, 73, 74, 75)]</span></pre><p id="f72f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只剩下以下几列:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi of"><img src="../Images/3402c52f89beb304d6d7099a02d43062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7-RSPxzlg1W_0DGGjKuUHQ.png"/></div></div></figure><p id="4e4b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有很多选择。我选择使用 Census tract，由 CT2010 和 Tract2010 变量以不同的形式表示。这似乎是一个很好的汇总水平，因为布鲁克林大约有 750 个人口普查区。此外，人口普查局提供区域级形状文件，使绘制地图变得轻而易举。</p><p id="6f41" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要将这些信息与我们之前创建的建筑列表合并。不幸的是，PLUTO 没有我们之前使用的 RegistrationID 变量。相反，他们使用更常见的 BBL，代表“自治市、街区、地段”</p><p id="ff79" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的建筑物数据没有<strong class="kh ir"> BBL </strong>变量，但是我们可以通过组合区、建筑物和地段列来创建一个变量。然而，首先，我们将使用<code class="fe nu nv nw mt b">sprintf</code>函数填充我们的<strong class="kh ir">块</strong>和<strong class="kh ir">块</strong>变量。</p><p id="26ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">填充向小于特定位数的值添加额外的零。这使得我们最终的 BBL 长度为十位数，而不管组成它的组件的值。</p><p id="9dae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还将借此机会对我们的建筑数据框架进行子集划分，仅包括布鲁克林的房产。我们使用<code class="fe nu nv nw mt b">3</code>的<strong class="kh ir"> BoroID </strong>来实现这一点。</p><p id="0560" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3)在建筑物数据框中创建 BBL 变量</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="049f" class="lq lr iq mt b gy mx my l mz na">#subset dataframe for just Brooklyn <br/>bldg_counts  &lt;- bldg_counts [bldg_counts $BoroID == 3 ,]</span><span id="9166" class="lq lr iq mt b gy og my l mz na">#create new columns with padded values <br/>bldg_counts ["New_Block"] &lt;- lapply(bldg_counts ["Block"], function(x) sprintf("%05d", x))<br/>bldg_counts ["New_Lot"] &lt;- lapply(bldg_counts ["Lot"], function(x) sprintf("%04d", x))</span><span id="5434" class="lq lr iq mt b gy og my l mz na">#use paste function to combine everything into one variable <br/>bldg_counts ["BBL"] &lt;- as.numeric(paste(bldg_counts $BoroID, bldg_counts $New_Block, bldg_counts $New_Lot, sep=""))</span></pre><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi oh"><img src="../Images/23774c23c0d10024d6817b24779100f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OZXGprlLDOcLh5GULymq6Q.png"/></div></div></figure><p id="7111" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我觉得不错。让我们继续把这个数据帧和冥王星的数据合并。我们想要的只是每栋建筑的普查区域，因此我们可以相应地进行分组。</p><p id="62b7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 4)将区域信息与建筑物数据集合并</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3c42" class="lq lr iq mt b gy mx my l mz na">names(pluto_bk)<br/>pluto_bk &lt;- pluto_bk[, c(5, 2)]<br/>nrow(bldg_counts)</span><span id="b78f" class="lq lr iq mt b gy og my l mz na">bldg_counts &lt;- merge(x=bldg_counts, y=pluto_bk1, by="BBL")<br/>nrow(bldg_counts)</span></pre><p id="91ac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们丢失了几百行数据，不管是什么原因，它们都不在 PLUTO 数据集中。</p><p id="dd00" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于<strong class="kh ir"> BBL </strong> s 的一个重要旁注:这个值实际上不是唯一的标识符——一些<strong class="kh ir">地段</strong>有不止一个建筑。这没什么大不了的，因为我们需要从冥王星数据帧中提取的只是人口普查区域，这对于位于同一地块上的建筑来说是一样的。</p><p id="c0f0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们想要更精确，我们可以通过结合<strong class="kh ir"> BBL </strong>和每栋建筑的街道号来创建一个唯一的 ID 变量。</p><p id="6a23" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 5)按普查地区汇总</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f0f7" class="lq lr iq mt b gy mx my l mz na">#aggregate by census tract <br/>multiple &lt;- bldg_counts[bldg_counts$Building_Count &gt; 2 ,]<br/>tract_counts &lt;- aggregate(Building_Count ~ CT2010, data=multiple, FUN=length )<br/>names(tract_counts)[1] &lt;- "CTLabel"<br/>nrow(tract_counts)<br/>length(unique(pluto_bk$CT2010))</span></pre><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi oi"><img src="../Images/d44fa551c76876a20ce694bd149a5e6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_6eFPLumJ60V_MQFhSqcA.png"/></div></div></figure><p id="6d6f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先映入我眼帘的是，我们丢失了一些人口普查地图。解释很简单。虽然该区总共有 761 块土地，但其中一些要么 1)非常小，要么 2)几乎全部是平房，不需要在该市登记。由于这些地块没有“多层建筑”房东，它们不会出现在汇总列表中。</p><p id="ea11" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧。我们有每个普查区域的数据框架和“多层建筑”业主拥有的房产数量。数量少得惊人，但话说回来，人口普查区实际上并没有那么大。我们来绘制地图吧！</p><h1 id="a74b" class="nb lr iq bd ls nc nd ne lv nf ng nh ly jw ni jx mb jz nj ka me kc nk kd mh nl bi translated">绘图</h1><p id="6f6a" class="pw-post-body-paragraph kf kg iq kh b ki mj jr kk kl mk ju kn ko ml kq kr ks mm ku kv kw mn ky kz la ij bi translated">R 中任何映射项目的第一步都是读入我们的 shapefile。我们将在本教程中使用的 shapefile 来自纽约市规划局。虽然人口普查局通常是 shapefiles 的首选资源，但纽约市规划部的版本已经裁剪了水域，因此更加简洁。</p><p id="224a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 1)加载形状文件</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3248" class="lq lr iq mt b gy mx my l mz na">bk_shape &lt;- readOGR(dsn = "shapefiles", layer = "nyct2010")<br/>head(bk_shape@data)</span></pre><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi oj"><img src="../Images/074b49b42f4167a4bd4a3752d49fbc85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B2RQHmFJDtesKwOi3KgRRQ.png"/></div></div></figure><p id="2fc3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以看到这个 shapefile 实际上有 2166 个不同的人口普查区域，因为它包括了所有的行政区。我们还可以看到，它有数据绑定到多边形，使其成为一个空间多边形数据帧(SPDF)。除了关于面本身的信息之外，该数据还包括人口普查区域标签。我们希望将数据绑定到 SPDF，但首先我们需要解决一些问题。</p><p id="62a9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">子集 SPDF  <br/>给 R 中的 SPDF 设置子集简单得荒谬。你可以像一个普通的数据帧那样做。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="ed33" class="lq lr iq mt b gy mx my l mz na">#remember "3" is the BoroCode for Brooklyn <br/>bk_shape &lt;- bk_shape[bk_shape@data$BoroCode == "3" ,]<br/>head(bk_shape@data)</span></pre><p id="c95c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 3)将我们的数据与 SPDF </strong>合并</p><p id="c250" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在 R 中向多边形添加数据也很容易。在这种情况下，我们只需要确保 ID 变量有相同的名称，就可以了。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="e290" class="lq lr iq mt b gy mx my l mz na">bk_shape &lt;- merge(bk_shape, tract_counts, by="CTLabel")</span></pre><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi ok"><img src="../Images/db11756fb5f6d697be715950f5307c70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5AUFMicbGE671ez9IvWAOA.png"/></div></div></figure><p id="ad3c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，您可以看到，我们现在已经将数据绑定到了 SPDF，并准备好开始绘制地图。</p><p id="2f94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 4)绘制底图</strong> <br/>这就是制图包的用武之地。为了开始绘制我们的地图，我们需要首先绘制地图的“范围”(即它将占据的空间区域)，然后是陆地。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="4032" class="lq lr iq mt b gy mx my l mz na">plot(bk_shape, border = NA, col = NA, bg = "#A6CAE0")<br/>plot(bk_shape, col  = "#E3DEBF", border=NA, add=TRUE)</span></pre><p id="6aa6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它应该是这样的:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi ol"><img src="../Images/221f7f41162612ac186aea835a2107b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K0pN9lKasWmI3wrjfQGMbA.png"/></div></div></figure><p id="bab5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 5)添加边界线</strong> <br/>现在我们要添加第三层，这将是人口普查区域的边界。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6e3d" class="lq lr iq mt b gy mx my l mz na">plot(bk_shape, col = "grey60",border = "white", lwd=0.4, add=TRUE)</span></pre><p id="e759" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在你应该有这个:</p><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi om"><img src="../Images/4b7c1830f0a84ac1c9bf85952a81c84f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ihLOdRqByYim3munIGrC2g.png"/></div></div></figure><p id="684a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 6)选择调色板</strong> <br/>制图包中有很多漂亮的预制调色板。我选择了简单的绿色，但你可以在第 4 页的这里看看其他的<a class="ae lb" href="https://cran.r-project.org/web/packages/cartography/cartography.pdf" rel="noopener ugc nofollow" target="_blank">。我也选择使用 8 种不同的颜色，尽管这总是取决于你所使用的数据的分布。</a></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="3e41" class="lq lr iq mt b gy mx my l mz na">cols &lt;- carto.pal(pal1 = "green.pal" ,n1 = 8)</span></pre><p id="1c50" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 7)添加 choropleth 层</strong> <br/>这个包有很多不同的显示数据的特性，但是我们将坚持使用一个简单的 choropleth 地图。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="1e89" class="lq lr iq mt b gy mx my l mz na">choroLayer(spdf = bk_shape, <br/>           df = bk_shape@data, <br/>           var = "Building_Count", <br/>           breaks = c(0, 10, 30, 50, 70, 90, 110, 150), <br/>           col = cols, <br/>           border = "grey40", <br/>           lwd = 0.5, <br/>           legend.pos = "left",<br/>           legend.title.txt = "Number of Buildings", <br/>           legend.values.rnd = 10,<br/>           add = TRUE)</span></pre><figure class="mo mp mq mr gt nn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi on"><img src="../Images/c9a5f019d5d46029cca0d0acf199b83a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7YjeRcvYU1lf2H30iWK-Uw.png"/></div></div></figure><p id="2358" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嘣。事实证明这很好，因为这非常符合我多年来与布鲁克林房东打交道的经验。深绿色区域也与经历了最大中产阶级化的区域非常接近。</p><p id="0e86" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我为布鲁克林公共图书馆制作的许多地图看起来非常相似，尤其是在观察中产阶级化前后收入和租金的变化时。</p><p id="c0d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加布局层 <br/>我们可以通过创建一个布局层来给地图添加一点元数据。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="9a90" class="lq lr iq mt b gy mx my l mz na">layoutLayer(title = "Census Tracts by Building Ownership Concentration", <br/>            author = "Pres Nichols",  <br/>            sources = "Source: NYC OpenData", <br/>            scale = NULL, <br/>            col = NA, <br/>            coltitle = "black", <br/>            frame = FALSE,  <br/>            bg = NA)</span></pre><h1 id="6e49" class="nb lr iq bd ls nc nd ne lv nf ng nh ly jw ni jx mb jz nj ka me kc nk kd mh nl bi translated">结论</h1><p id="99f4" class="pw-post-body-paragraph kf kg iq kh b ki mj jr kk kl mk ju kn ko ml kq kr ks mm ku kv kw mn ky kz la ij bi translated">有一个重要的方面我没有考虑到:如果地图上的北部地区，拥有更集中的所有权，只是总共有更多的建筑呢？</p><p id="8a1a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你正在学习这篇教程，我会让你自己去发现并报告你的发现！</p><p id="35d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意:那些不熟悉布鲁克林地理的人可能会对地图上的白色区域有点担心。看起来比实际情况更糟。这是因为最大的白色区域(展望公园、格林伍德公墓和洛克威)实际上没有人居住。如果他们仍然困扰你，你可以随时给无人居住的地区一个不同的颜色。</p></div></div>    
</body>
</html>