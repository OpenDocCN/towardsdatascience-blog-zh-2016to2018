<html>
<head>
<title>Troubleshooting GCP + CUDA/NVIDIA + Docker and Keeping it Running!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">排除 GCP + CUDA/NVIDIA + Docker 故障并保持其运行！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/troubleshooting-gcp-cuda-nvidia-docker-and-keeping-it-running-d5c8b34b6a4c?source=collection_archive---------4-----------------------#2018-01-15">https://towardsdatascience.com/troubleshooting-gcp-cuda-nvidia-docker-and-keeping-it-running-d5c8b34b6a4c?source=collection_archive---------4-----------------------#2018-01-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/9bd5cbb92903b468d08bd078e81c5a59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*1md2PXe36kB1nRFN3i4iMw.png"/></div></figure><p id="bd8d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我有一个谷歌云平台(GCP)实例，一天前已经设置好并运行良好，它是在我的<a class="ae ks" rel="noopener" target="_blank" href="/whats-after-setting-up-a-gcp-computing-instance-running-a-custom-docker-container-with-tensorflow-eb0f077983c6">之前的教程</a>之后设置的。</p><div class="kt ku gp gr kv kw"><a href="https://medium.com/@thushv89/whats-after-setting-up-a-gcp-computing-instance-running-a-custom-docker-container-with-tensorflow-eb0f077983c6" rel="noopener follow" target="_blank"><div class="kx ab fo"><div class="ky ab kz cl cj la"><h2 class="bd ir gy z fp lb fr fs lc fu fw ip bi translated">设置 GCP 计算实例后会发生什么？使用 Tensorflow 运行自定义 Docker 容器</h2><div class="ld l"><h3 class="bd b gy z fp lb fr fs lc fu fw dk translated">介绍</h3></div><div class="le l"><p class="bd b dl z fp lb fr fs lc fu fw dk translated">medium.com</p></div></div><div class="lf l"><div class="lg l lh li lj lf lk js kw"/></div></div></a></div><p id="daaf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我告诉你一些关于我的机器的事情，</p><ul class=""><li id="1248" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr lq lr ls lt bi translated">Ubuntu: 16.04</li><li id="7cd6" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">GPU: 1 个 P100</li><li id="a18e" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">CUDA: 9.1</li><li id="7913" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">英伟达:387.xx</li></ul><p id="573c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是，当我昨天启动我的 GCP 实例并尝试运行 docker 容器时，发生了一些非常奇怪的事情，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="a955" class="mi mj iq me b gy mk ml l mm mn">sudo docker start &lt;container_name&gt;<br/>sudo docker attach &lt;container_name&gt;</span></pre><h1 id="5015" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">发生了什么事？</h1><p id="1525" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">不，它不像我希望的那样工作，并把我带进了集装箱。相反，它给了我以下错误</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="4417" class="mi mj iq me b gy mk ml l mm mn">Error response from daemon: linux runtime spec devices: error gathering device information while adding custom device “/dev/nvidiactl”: no such file or directory<br/>Error: failed to start containers: x</span></pre><p id="7a53" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这很可能已经发生了，因为我的 GCP 实例勇敢地决定继续下去并更新一切本身是完全没问题的，事情会神奇地变得更好！嗯，我有消息！不会这样的。<strong class="jw ir">所以如果 GCP 能给我们一个在初始设置时关闭自动更新的方法，我将不胜感激</strong>。事实上，已经有许多关于 NVIDIA 驱动程序发疯(或失踪)以及其他更新的报告(证据<a class="ae ks" href="https://ubuntuforums.org/showthread.php?t=2117801" rel="noopener ugc nofollow" target="_blank"> 1 </a>、<a class="ae ks" href="https://askubuntu.com/questions/799815/lost-nvidia-drivers-on-14-04" rel="noopener ugc nofollow" target="_blank"> 2 </a>、<a class="ae ks" href="https://codeyarns.com/2013/02/07/how-to-fix-nvidia-driver-failure-on-ubuntu/" rel="noopener ugc nofollow" target="_blank"> 3 </a>)。</p><h1 id="8bd5" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">向下钻取…</h1><p id="8d4e" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">好了，在进入故障诊断的细节之前，让我一步一步总结一下我要做的事情。</p><ul class=""><li id="08e0" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr lq lr ls lt bi translated">检查机器是否(在物理上)识别了我的 GPU</li><li id="8803" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">检查 NVIDIA 是否可以看到 GPU</li><li id="31ae" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">如果 NVIDIA 看不到 GPU，请查看您是否安装了 CUDA/NVIDIA 软件包，并检查 NVIDIA 驱动程序是否正确加载</li><li id="831b" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">如果 CUDA/NVIDIA 软件包安装正确，尝试修复路径变量</li><li id="499e" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">如果修复路径变量没有修复，卸载任何现有的 CUDA/NVIDIA 软件包，并尝试重新安装兼容的 CUDA 和 NVIDIA 软件包</li><li id="7f89" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">关闭自动更新，所以我会手动更新，而不会破坏一切。</li></ul><h1 id="ff59" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">我的 GPU 被机器识别了吗？</h1><p id="2bf6" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">首先也是最重要的，在检查库是否正确安装之前，请通过键入，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="45fd" class="mi mj iq me b gy mk ml l mm mn">lspci | grep 3D</span></pre><p id="8895" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这应该给出类似于，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="7308" class="mi mj iq me b gy mk ml l mm mn">00:04.0 3D controller: NVIDIA Corporation Device 15f8 (rev a1)</span></pre><p id="bd75" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果没有，这可能是由于 GPU 被拔掉或只是从插座中轻轻推出，因为你移动了机器或其他东西。</p><h1 id="f1a8" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">使用 NVIDIA 系统管理界面(NVIDIA-SMI)检查 GPU 的状态</h1><p id="0765" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">首先要做的是，<strong class="jw ir">而不是</strong>妄下结论，并严格地开始输入<code class="fe nq nr ns me b">sudo apt-get install &lt;this-and-that&gt; </code>希望得到最好的结果！事实上，在这种情况下，最好的事情(也是大多数人忽略的)是找出问题所在。首先让我们看看我们有什么。继续打字，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="7cfb" class="mi mj iq me b gy mk ml l mm mn">nvidia-smi</span></pre><p id="ee3f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">理想情况下，您应该得到这样的结果，</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nu nv di nw bf nx"><div class="gh gi nt"><img src="../Images/1b0b52bccbef9ec12db2e68593fd5efc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Tqn93SxvPwH9rEr52tkSA.png"/></div></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">Figure 1: Output of nvidia-smi</figcaption></figure><h1 id="77e6" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">那没用:(…</h1><p id="f3c1" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">如果你得到这样的信息，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="fa21" class="mi mj iq me b gy mk ml l mm mn">NVIDIA-SMI has failed because it couldn’t communicate with the NVIDIA driver. Make sure that the latest NVIDIA driver is installed and running.</span></pre><p id="787e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这可能是由于两个原因，</p><ul class=""><li id="a729" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr lq lr ls lt bi translated">您没有以 root 用户身份登录，因此 NVIDIA 无法通信(<strong class="jw ir">解决方案:</strong>键入<code class="fe nq nr ns me b">sudo -s</code>以 root 用户身份登录，然后再次尝试<code class="fe nq nr ns me b">nvidia-smi</code></li><li id="5d20" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">您实际上没有安装兼容的 NVIDIA 驱动程序(或者配置已损坏)(<strong class="jw ir">解决方案需要更多工作</strong>)。这也是我在这里讨论的问题类型)</li></ul><h1 id="f341" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">修复缺失的 CUDA/NVIDIA 库</h1><p id="7a2c" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">因此，为了让 NVIDIA-SMI 正常工作，您需要一些适当的设置。他们是，</p><ul class=""><li id="ae5f" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr lq lr ls lt bi translated">CUDA(包括 cuda- <version>、cuda-blas- <version>、cuda-nvcc- <version>、cuda-toolkit- <version>等。)</version></version></version></version></li><li id="c344" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">NVIDIA 库(包括 nvidia- <version>、nvidia-docker、nvidia-modprobe、nvidia-settings 等)。)</version></li></ul><p id="471f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下是否安装了这些，试着键入</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="4f0d" class="mi mj iq me b gy mk ml l mm mn">dpkg -l | grep nvidia</span></pre><p id="9995" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你应该得到</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/fe303a9a0b48edde5ff62ed8ce316f9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*VR8m0s2hg3kfAUOzXtX89A.png"/></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">Figure 2: Output of dpkg -l | grep nvidia</figcaption></figure><p id="516b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一次尝试，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="661f" class="mi mj iq me b gy mk ml l mm mn">dpkg -l | grep cuda</span></pre><p id="2770" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这应该给</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/ecd68d0dfeac9ab78ffd7b7ca6d93e20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*aHq4R5BDUTEb9nMi8Y32qg.png"/></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">Figure 3: Output of dpkg -l | grep cuda</figcaption></figure><p id="c1f9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请注意，实际列表要长得多。但是如果 CUDA 获得了相当多的点击，事情应该是好的。但是不要太舒服了！我遇到过即使安装了这些东西也无法工作的情况。</p><h1 id="11a7" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">检查是否加载了 NVIDIA 内核模块</h1><p id="5f10" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">让我们再做一次检查，看看 NVIDIA 内核模块是否被正确加载，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="b0d0" class="mi mj iq me b gy mk ml l mm mn">dmesg | grep NVIDIA</span></pre><p id="8294" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">理想情况下，你应该看到，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="2acc" class="mi mj iq me b gy mk ml l mm mn">[ 2.261511] nvidia: module license ‘NVIDIA’ taints kernel.<br/>[ 2.316304] NVRM: loading NVIDIA UNIX x86_64 Kernel Module 384.111 Tue Dec 19 23:51:45 PST 2017 (using threaded interrupts)<br/>[ 2.319524] nvidia-modeset: Loading NVIDIA Kernel Mode Setting Driver for UNIX platforms 384.111 Tue Dec 19 22:56:18 PST 2017</span></pre><p id="fd31" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你什么都看不到，那就有问题了！这意味着 NVIDIA 驱动程序没有被正确加载。</p><h1 id="d980" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">会不会是路径变量配置错误？</h1><p id="0598" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">如果您得到如图所示的这两个输出，但不是正确的<code class="fe nq nr ns me b">dmesg</code>消息，那么您需要的东西都在机器中了。所以这可能是由于路径变量的一些简单的错误配置。所以打开<code class="fe nq nr ns me b">.bashrc</code>文件，在它后面添加下面两行。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="5d52" class="mi mj iq me b gy mk ml l mm mn">PATH=/usr/local/cuda-9.1/bin${PATH:+:${PATH}}<br/>LD_LIBRARY_PATH=/usr/local/cuda-9.1/lib64\                          ${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}</span></pre><p id="b91d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后退出文本编辑器并运行，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="70e1" class="mi mj iq me b gy mk ml l mm mn">source ~/.bashrc</span></pre><p id="e059" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重启机器，再次尝试<code class="fe nq nr ns me b">nvidia-smi</code>看看是否一切正常。(PS:记得用<code class="fe nq nr ns me b">sudo</code>权限试试)</p><h1 id="3141" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">没那么幸运？是时候手动重装了</h1><p id="b1af" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">如果你正在读这部分，你可能没有其他人那么幸运。好吧，让我们继续耕耘土地吧！在我看来，不值得再深入挖掘，试图在满是库的碗里找到一粒错误。事实上，如果我们移除当前损坏的库并从头开始正确安装，事情会容易得多。</p><h1 id="7280" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">找出正确的库版本</h1><p id="35e7" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">首先，我们需要弄清楚哪一个与哪一个相配。我的意思是，我们需要确保我们下载的特定(正确)版本的 CUDA 和 NVIDIA 驱动程序与您的显卡相匹配。所以让我们先去了解一下最新的情况。</p><p id="c94c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到，</p><div class="kt ku gp gr kv kw"><a href="http://www.nvidia.com/Download/index.aspx?lang=en-us" rel="noopener  ugc nofollow" target="_blank"><div class="kx ab fo"><div class="ky ab kz cl cj la"><h2 class="bd ir gy z fp lb fr fs lc fu fw ip bi translated">下载驱动程序| NVIDIA</h2><div class="ld l"><h3 class="bd b gy z fp lb fr fs lc fu fw dk translated">下载 NVIDIA 产品的驱动程序，包括 GeForce 显卡、nForce 主板、Quadro 工作站和…</h3></div><div class="le l"><p class="bd b dl z fp lb fr fs lc fu fw dk translated">www.nvidia.com</p></div></div><div class="lf l"><div class="oe l lh li lj lf lk js kw"/></div></div></a></div><p id="152b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并输入详细信息，</p><ul class=""><li id="9b68" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr lq lr ls lt bi translated">显卡:我有一个英伟达特斯拉 P100</li><li id="16e9" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">CUDA:我们用 9.x 吧</li></ul><p id="17d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是我得到的结果，</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi of"><img src="../Images/b6bf8c2bd54a30954a85294145c8f79d.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*xAf77mxjfuk2ceg4V77Ghw.png"/></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">Figure 4: Driver/Library versions</figcaption></figure><p id="1c55" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们将确保在安装时坚持使用这些特定的版本，以避免任何差异。</p><h1 id="43c1" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">移除现有的 CUDA/NVIDIA 库</h1><p id="8f35" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">首先让我们删除任何现有的 CUDA/NVIDIA 库，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="ae4e" class="mi mj iq me b gy mk ml l mm mn">sudo apt-get remove --purge cuda*<br/>sudo apt-get remove --purge nvidia*</span></pre><h1 id="3120" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">安装 CUDA/NVIDIA</h1><p id="1c3d" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">首先获得 CUDA 工具包<code class="fe nq nr ns me b">.deb</code>,</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="e318" class="mi mj iq me b gy mk ml l mm mn">wget <a class="ae ks" href="http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_9.1.85-1_amd64.deb" rel="noopener ugc nofollow" target="_blank">http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_9.1.85-1_amd64.deb</a></span><span id="951a" class="mi mj iq me b gy og ml l mm mn">sudo dpkg -i cuda-repo-*</span><span id="4e66" class="mi mj iq me b gy og ml l mm mn">sudo apt-get update</span><span id="5414" class="mi mj iq me b gy og ml l mm mn">sudo apt-get install cuda -y</span></pre><p id="131b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重启系统并尝试，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="666e" class="mi mj iq me b gy mk ml l mm mn">sudo dpkg -l | grep cuda<br/>sudo dpkg -l | grep nvidia</span></pre><p id="35ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您应该会看到如图 2 和图 3 所示的正确输出。</p><h1 id="e05b" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">是时候进行一些黑客攻击了…</h1><p id="4e40" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">我刚刚意识到搭载 CUDA 9.1 的 NVIDIA 驱动程序<strong class="jw ir"> 387.xx </strong>在我的 NVIDIA Tesla P100 上不工作。所以我必须先卸载它，然后安装 NVIDIA <strong class="jw ir"> 384.xx </strong>。根据您实例中的 GPU 卡，这可能会有所不同。</p><p id="12b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你知道什么是怪异吗！如图 1 所示，我完全可以使用 CUDA 9.1 和 NVIDIA 387.xx。但是现在，NVIDIA 387.xx 不再与 CUDA 9.1 兼容。我不知道为什么，但希望能找到原因！</p><p id="1d86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们这样做，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="b6c1" class="mi mj iq me b gy mk ml l mm mn">sudo apt-get remove --purge nvidia-*</span></pre><p id="2a00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，让我们手动安装 NVIDIA 384.xx 驱动程序，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="088f" class="mi mj iq me b gy mk ml l mm mn">sudo apt-get install nvidia-384<br/>sudo apt-get install nvidia-modprobe</span></pre><p id="a83d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于<code class="fe nq nr ns me b">nvidia-docker</code>，你将需要<code class="fe nq nr ns me b">nvidia-modprobe </code>。现在快速检查一下路径变量，看看它们的设置是否正确</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f56f" class="mi mj iq me b gy mk ml l mm mn">echo $PATH : You should have /usr/local/cuda-&lt;version&gt;/bin in this variable<br/>echo $LD_LIBRARY_PATH : You should have/usr/local/cuda-&lt;version&gt;/lib64 in this variable</span></pre><p id="dd16" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在尝试<code class="fe nq nr ns me b">nvidia-smi</code>，您应该会看到类似于图 1 的内容，这意味着一切都恢复正常了(希望如此！).</p><h1 id="6ab9" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">关闭自动更新！</h1><p id="5e04" class="pw-post-body-paragraph ju jv iq jw b jx nl jz ka kb nm kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">还有一件事，不要忘记是什么开始了这整个折磨。是自动更新。更新是重要的，以保持您的机器安全，从外部威胁和一切，但如果它将打破我的机器每 5 秒钟我更新，没有谢谢你！我自己手动更新。为此，请在文本编辑器中打开以下文件，</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="ba3b" class="mi mj iq me b gy mk ml l mm mn">/etc/apt/apt.conf.d/10periodic</span></pre><p id="bda0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并设置</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="548b" class="mi mj iq me b gy mk ml l mm mn">APT::Periodic::Update-Package-Lists “0”;</span></pre><p id="5bfe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这将阻止那些“讨厌的”(然而，重要的)自动更新。但是记住要持续更新你的操作系统，因为你不希望有人侵入你的机器。</p><h1 id="7ddb" class="mo mj iq bd mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk bi translated">结论</h1><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nu nv di nw bf nx"><div class="gh gi oh"><img src="../Images/103155e866fc846581021913399a493a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rcXjoJABX7Dmtn48clsN2g.jpeg"/></div></div><figcaption class="ny nz gj gh gi oa ob bd b be z dk">pixabay.com</figcaption></figure><p id="0c3e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，在这篇文章中，我们讨论了如果您遇到配置损坏、驱动程序丢失等问题，如何对 GCP 实例进行故障诊断。我推荐的过程是，</p><ul class=""><li id="ba5d" class="ll lm iq jw b jx jy kb kc kf ln kj lo kn lp kr lq lr ls lt bi translated">检查机器是否(在物理上)识别了我的 GPU</li><li id="316a" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">检查 NVIDIA 是否可以看到 GPU</li><li id="3cee" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">如果 NVIDIA 看不到 GPU，请查看您是否安装了 CUDA/NVIDIA 软件包，并检查 NVIDIA 驱动程序是否正确加载</li><li id="178f" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">如果 CUDA/NVIDIA 软件包安装正确，尝试修复路径变量</li><li id="75df" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">如果修复路径变量没有修复，卸载任何现有的 CUDA/NVIDIA 软件包，并尝试重新安装兼容的 CUDA 和 NVIDIA 软件包</li><li id="39a1" class="ll lm iq jw b jx lu kb lv kf lw kj lx kn ly kr lq lr ls lt bi translated">关闭自动更新，所以我会手动更新，而不会破坏一切。</li></ul><p id="8320" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">干杯！</p></div></div>    
</body>
</html>