<html>
<head>
<title>Keep calm and do more testing!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保持冷静，多做测试！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/keep-calm-and-do-more-testing-42c6678707ee?source=collection_archive---------15-----------------------#2018-09-19">https://towardsdatascience.com/keep-calm-and-do-more-testing-42c6678707ee?source=collection_archive---------15-----------------------#2018-09-19</a></blockquote><div><div class="fc ig ih ii ij ik"/><div class="il im in io ip"><div class=""/><p id="cd9f" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">作为数据科学家，我们都很熟悉流程、包或应用程序中断时会发生什么。我们饶有兴趣地深入其中，试图诊断意外错误发生在哪里。原始数据中是否发生了意想不到的事情？我们的代码没有预料到特定的输入排列吗？</p><p id="c955" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">由于令人沮丧的调试和重写，修复问题的过程可能从简单的调整到几天的揪头发和敲打头部。</p><p id="7d94" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">最近，我开始接触 R 语言的测试，对它的直观性感到惊喜。当我们开发一个过程、包或应用程序时，在工作流程中增加测试并不需要花费太多的精力，但是在调试方面的好处是巨大的。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/73500c9c2c4708b00fca4fdb0a8b99fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ueGM5wbnRvys6FDA.jpg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk">Debugging can be a nightmare — do yourself a favor and set up a testing workflow</figcaption></figure><h2 id="2ea1" class="ld le is bd lf lg lh dn li lj lk dp ll ka lm ln lo ke lp lq lr ki ls lt lu lv bi translated">R 中的测试基础设施</h2><p id="f045" class="pw-post-body-paragraph jp jq is jr b js lw ju jv jw lx jy jz ka ly kc kd ke lz kg kh ki ma kk kl km il bi translated">R 中支持平滑、自动化测试的关键包是<code class="fe mb mc md me b">testthat</code>。在您的 R 项目中，您可以通过一个简单的命令来初始化测试基础设施</p><pre class="ko kp kq kr gt mf me mg mh aw mi bi"><span id="4ed7" class="ld le is me b gy mj mk l ml mm">devtools::use_testthat()</span></pre><p id="8d86" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">这个命令将在您的项目中创建一个名为<code class="fe mb mc md me b">tests/testthat</code>的目录，您可以在其中放置执行测试的 R 脚本。</p><p id="18f8" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">如果您的测试需要在本地设置环境变量，例如数据库凭证，您可以通过使用</p><pre class="ko kp kq kr gt mf me mg mh aw mi bi"><span id="c9c0" class="ld le is me b gy mj mk l ml mm">usethis::edit_r_environ("project")</span></pre><p id="9042" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">这将在 RStudio 中打开一个可编辑的文件，您可以在其中输入特定项目的变量名和值。</p><p id="7ddd" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">为了编写测试本身，您可以创建包含测试代码的 R 脚本，并将它们放在新的<code class="fe mb mc md me b">tests/testthat</code>子目录中。这些脚本就像任何其他的 R 代码，除了它们使用方便的包装和为测试设计的<code class="fe mb mc md me b">testthat</code>函数。关键函数是<code class="fe mb mc md me b">testthat::test_that()</code> <strong class="jr it"> </strong>，它有两个参数:</p><ol class=""><li id="8032" class="mn mo is jr b js jt jw jx ka mp ke mq ki mr km ms mt mu mv bi translated"><code class="fe mb mc md me b">desc</code>，字符串形式的测试描述，如<code class="fe mb mc md me b">"Test that I have all the cat data I expect"</code></li><li id="970f" class="mn mo is jr b js mw jw mx ka my ke mz ki na km ms mt mu mv bi translated"><code class="fe mb mc md me b">code</code>，代码执行您需要的计算，然后测试这些计算是否返回预期值，包含在<code class="fe mb mc md me b">{}</code>中。</li></ol><p id="89ad" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">通常情况下,<code class="fe mb mc md me b">code</code>会以某种形式的比较函数结束。<code class="fe mb mc md me b">testthat</code>包含多个比较功能，例如:</p><ul class=""><li id="43da" class="mn mo is jr b js jt jw jx ka mp ke mq ki mr km nb mt mu mv bi translated"><code class="fe mb mc md me b">testthat::expect_equal()</code>测试两个参数是否相等。</li><li id="26c1" class="mn mo is jr b js mw jw mx ka my ke mz ki na km nb mt mu mv bi translated"><code class="fe mb mc md me b">testthat::expect_gte()</code>测试第一个参数是否大于或等于第二个参数</li><li id="0d80" class="mn mo is jr b js mw jw mx ka my ke mz ki na km nb mt mu mv bi translated"><code class="fe mb mc md me b">testthat::expect_s3_class()</code>测试第一个参数是否具有第二个参数中给出的 S3 类</li><li id="e04c" class="mn mo is jr b js mw jw mx ka my ke mz ki na km nb mt mu mv bi translated"><code class="fe mb mc md me b">testthat::expect_true()</code>测试包含在参数中的语句评估为<code class="fe mb mc md me b">TRUE</code></li></ul><p id="e9b9" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">一旦您编写了测试脚本，您就可以使用简单的命令<code class="fe mb mc md me b">devtools::test()</code>自动运行所有的测试并查看性能摘要。</p><h2 id="ba12" class="ld le is bd lf lg lh dn li lj lk dp ll ka lm ln lo ke lp lq lr ki ls lt lu lv bi translated">测试代码的示例</h2><p id="b70e" class="pw-post-body-paragraph jp jq is jr b js lw ju jv jw lx jy jz ka ly kc kd ke lz kg kh ki ma kk kl km il bi translated">这里有几个非常简单的例子。假设我们有一个进程，它通过<code class="fe mb mc md me b">mtcars</code>数据集中的<code class="fe mb mc md me b">cyl</code>生成平均值<code class="fe mb mc md me b">mpg</code>，并将其写入名为<code class="fe mb mc md me b">mpg_by_cyl</code>的数据库表中。</p><p id="d622" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">现在，作为一名优秀的 R 公民，您非常了解您的<code class="fe mb mc md me b">mtcars</code>数据集，并且您知道有三个<code class="fe mb mc md me b">cyl</code>值，因此您会期望您的<code class="fe mb mc md me b">mpg_by_cyl</code>数据库表有三行。因此，在您的测试脚本中，您可以从数据库中获取<code class="fe mb mc md me b">mpg_by_cyl</code>,并且您可以编写以下简单的测试:</p><pre class="ko kp kq kr gt mf me mg mh aw mi bi"><span id="1ca4" class="ld le is me b gy mj mk l ml mm">testthat::test_that("mpg_by_cyl has expected number of rows", {<br/>    <br/>    mpg_by_cyl %&gt;%<br/>      nrow() %&gt;% <br/>      testthat::expect_equal(3)</span><span id="ec1a" class="ld le is me b gy nc mk l ml mm">})</span></pre><p id="ef79" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">当您运行您的测试时，如果<code class="fe mb mc md me b">mpg_by_cyl</code>确实有三行，您将从<code class="fe mb mc md me b">devtools::test()</code>那里得到一个好的<code class="fe mb mc md me b">Woot!</code>或者类似的鼓励话语。如果它没有像预期的那样返回，您将会被警告失败的条件，并得到一条像<code class="fe mb mc md me b">Nobody`s perfect!</code>这样的安慰信息，然后您就会知道与<code class="fe mb mc md me b">mpg_by_cyl</code>相关的事情没有像预期的那样发生。</p><p id="93ae" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">这是另一个例子。假设您有一个脚本，它生成一个对象<code class="fe mb mc md me b">date</code>，该对象包含一个表示格式<code class="fe mb mc md me b">"%d %B %Y"</code>的最近日期的字符串，例如<code class="fe mb mc md me b">"14 December 2017"</code>，您的流程将这个字符串写入某个数据库。您希望测试是否确实生成了有意义的日期并将其写入数据库。一种方法是检查字符串是否包含<code class="fe mb mc md me b">" 20"</code>,这是您对任何最近日期的预期格式。因此，您可以让您的测试文件从它被写入的数据库中获取<code class="fe mb mc md me b">date</code>，然后编写下面的测试:</p><pre class="ko kp kq kr gt mf me mg mh aw mi bi"><span id="ebd4" class="ld le is me b gy mj mk l ml mm">testthat::test_that("date contains a recent date", {<br/>    <br/>  testthat::expect_true(grepl(" 20", date))</span><span id="fb81" class="ld le is me b gy nc mk l ml mm">})</span></pre><p id="4b6e" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">这将评估写入数据库的内容是否包含预期的字符串，如果失败，您就知道这个过程出错了。(当然，这并不能完全验证预期日期已被写入，但数据科学家将确定如何编写特定的测试，以提供他们所需的确定程度)。</p><p id="1817" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">就个人而言，我发现 R 中的测试基础设施非常直观，我建议您养成为所有的包、过程和应用程序编写测试的习惯。你可以以后再谢我！</p><p id="fe59" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated"><em class="nd">关于 R 中测试的更多信息，查看 Hadley Wickham 的开卷</em> <a class="ae ne" href="http://r-pkgs.had.co.nz/tests.html" rel="noopener ugc nofollow" target="_blank"> <em class="nd">这里</em> </a> <em class="nd">。</em></p><p id="5340" class="pw-post-body-paragraph jp jq is jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km il bi translated">最初我是一名纯粹的数学家，后来我成为了一名心理计量学家和数据科学家。我热衷于将所有这些学科的严谨性应用到复杂的人的问题上。我也是一个编码极客和日本 RPG 的超级粉丝。在<a class="ae ne" href="https://www.linkedin.com/in/keith-mcnulty/" rel="noopener ugc nofollow" target="_blank"><em class="nd">LinkedIn</em></a><em class="nd">或</em><a class="ae ne" href="https://twitter.com/dr_keithmcnulty" rel="noopener ugc nofollow" target="_blank"><em class="nd">Twitter</em></a><em class="nd">上找我。</em></p></div></div>    
</body>
</html>