<html>
<head>
<title>How to tune a BigQuery ML classification model to achieve a desired precision or recall</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何调优 BigQuery ML 分类模型以达到期望的精度或召回率</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-tune-a-bigquery-ml-classification-model-to-achieve-a-desired-precision-or-recall-e4d40b93016a?source=collection_archive---------15-----------------------#2018-12-10">https://towardsdatascience.com/how-to-tune-a-bigquery-ml-classification-model-to-achieve-a-desired-precision-or-recall-e4d40b93016a?source=collection_archive---------15-----------------------#2018-12-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2973" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">基于 ROC 曲线选择概率阈值</h2></div><p id="42ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery 为在大型结构化数据集上训练机器学习模型提供了一种令人难以置信的便捷方式。在之前的一篇文章中，我向您展示了如何训练一个分类模型来预测航班延误。以下是预测航班是否会晚点 15 分钟或更久的 SQL 查询:</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="3efe" class="ll lm iq lh b gy ln lo l lp lq">CREATE OR REPLACE MODEL flights.delayed</span><span id="af37" class="ll lm iq lh b gy lr lo l lp lq">OPTIONS (model_type='logistic_reg', input_label_cols=['late'], <br/>         data_split_method='custom', data_split_col='is_train_row') AS</span><span id="8ee4" class="ll lm iq lh b gy lr lo l lp lq">SELECT<br/>  IF(arr_delay &lt; 15, 0, 1) AS late,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance,<br/>  is_train_day = 'True' AS is_train_row<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr` as f<br/>JOIN `cloud-training-demos.flights.trainday` as t<br/>USING(FL_DATE)<br/>WHERE<br/>  arr_delay IS NOT NULL</span></pre><p id="3198" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将在名为 flights 的数据集中创建一个名为 delayed 的模型。该模型将使用载体、原点等列。作为模型的输入，并预测航班是否会晚点。地面实况来自美国航班到达延误的历史数据。请注意，我已经按天将数据预拆分为一行是训练数据(is_train_day=True)还是应该用于独立评估(is_train_day=False)。这很重要，因为同一天的航班延误往往高度相关。</p><p id="0f83" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当训练完成时，BigQuery 报告训练统计数据，但是我们应该查看保留数据集的评估统计数据(is_train_day=False):</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="5558" class="ll lm iq lh b gy ln lo l lp lq">SELECT * from ML.EVALUATE(MODEL flights.delayed,<br/>(<br/>SELECT<br/>  IF(arr_delay &lt; 15, 0, 1) AS late,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr` as f<br/>JOIN `cloud-training-demos.flights.trainday` as t<br/>USING(FL_DATE)<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>  AND is_train_day = 'False'<br/>))</span></pre><p id="c17a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这给了我们:</p><figure class="lc ld le lf gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ls"><img src="../Images/8429da240cd428b8acb1fc4fd9f858c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BYSW78RFtN0l6T8d7X_ZUQ.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Evaluation statistics for flight delay model</figcaption></figure><p id="1083" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">航班延误数据是一个不平衡的数据集——只有 18%的航班晚点(这是我通过实践发现的):</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="776f" class="ll lm iq lh b gy ln lo l lp lq">SELECT<br/>  SUM(IF(arr_delay &lt; 15, 0, 1))/COUNT(arr_delay) AS fraction_late<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr` as f<br/>JOIN `cloud-training-demos.flights.trainday` as t<br/>USING(FL_DATE)<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>  AND is_train_day = 'True'</span></pre><p id="0925" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这样一个不平衡的数据集中，准确性并不那么有用，通常有一个业务目标来满足期望的精度(如果 1 更常见)或召回(如果 0 更常见)。</p><h2 id="a9e1" class="ll lm iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">受试者工作特征曲线</h2><p id="746c" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">一个分类模型实际上返回的是航班晚点的概率；上表中的评估统计数据是通过将该概率阈值设定为 0.5 来计算的。我们可以改变这个阈值，并在不同的阈值下获得精度和召回率。这被称为 ROC 曲线(这是一个可以追溯到雷达时代的首字母缩写词)，我们可以让 BigQuery 使用以下方法生成这条曲线:</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="bdd2" class="ll lm iq lh b gy ln lo l lp lq">SELECT * from ML.ROC_CURVE(MODEL flights.delayed,<br/>(<br/>SELECT<br/>  IF(arr_delay &lt; 15, 0, 1) AS late,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr` as f<br/>JOIN `cloud-training-demos.flights.trainday` as t<br/>USING(FL_DATE)<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>  AND is_train_day = 'True'<br/>))</span></pre><p id="c919" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本质上，它和 ML 是一样的。评估查询，除了您使用 ML。ROC _ CURVE 因为我们要调整阈值，所以我们应该对训练数据进行调整(is_train_day=True)。该表返回 101 行，每个阈值都有一个误报率(1 精度)和召回率。默认情况下，阈值基于对训练数据集的百分位数的计算:</p><figure class="lc ld le lf gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi na"><img src="../Images/f2e532c94f1e73991b1db741729dedfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O_S3dD1TJYybSuGH23yZlg.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Recall, false positive rate, etc. as the probability threshold of the classification model is changed</figcaption></figure><p id="cba4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以点击 BigQuery UI 中的“Explore in Data Studio”链接，得到一个图(设置 false_positive_rate 为维度，recall 为度量):</p><figure class="lc ld le lf gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nb"><img src="../Images/589b13eb394df819022fc87c2a6c9015.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rYUKHTv9-V9kO0QjdVQhWw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">ROC curve in Data Studio</figcaption></figure><p id="4aeb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更有用的观点是将阈值作为维度，将另外两个统计数据作为维度:</p><figure class="lc ld le lf gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nc"><img src="../Images/823fe5ac1323c12444194335c701d155.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XX_aVqeI4D6_4XeIhF4ALg.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Graph the variation of recall and false_positive_rate by threshold in Data Studio and choose the threshold that gives you a recall close to 70%.</figcaption></figure><p id="7b19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以调整阈值来实现一定的回忆(然后你将生活在你得到的任何精度)。假设我们想要确保识别至少 70%的晚点航班，即我们想要 0.7 的召回率。从上图可以看出，概率阈值需要为 0.335。这意味着我们会错误地将 1%的准点航班识别为晚点。</p><h2 id="7aac" class="ll lm iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">SQL 中的优化概率阈值</h2><p id="7d89" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">下面是一个查询，它将返回阈值，而无需绘制图形并将鼠标悬停在其上:</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="e178" class="ll lm iq lh b gy ln lo l lp lq">WITH roc AS (</span><span id="724f" class="ll lm iq lh b gy lr lo l lp lq">SELECT * from ML.ROC_CURVE(MODEL flights.delayed,<br/>(<br/>SELECT<br/>  IF(arr_delay &lt; 15, 0, 1) AS late,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr` as f<br/>JOIN `cloud-training-demos.flights.trainday` as t<br/>USING(FL_DATE)<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>  AND is_train_day = 'True'<br/>)))</span><span id="06dd" class="ll lm iq lh b gy lr lo l lp lq">SELECT <br/>threshold, recall, false_positive_rate,<br/><strong class="lh ir">ABS(recall - 0.7) AS from_desired_recall</strong><br/>FROM roc<br/><strong class="lh ir">ORDER BY from_desired_recall ASC</strong><br/>LIMIT 1</span></pre><p id="6514" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这给了我们获得 0.7 召回所需的阈值:</p><figure class="lc ld le lf gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nd"><img src="../Images/599fa0a0306eafed33a2bcbd37c65c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B6biVnlZ2hFtyWxVy9D06w.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Choosing the threshold that gives us a recall of 0.7.</figcaption></figure><figure class="lc ld le lf gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi ne"><img src="../Images/046774526a5fe12cc13ba568984033cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*skDNcmqJdBWq5n_D2f-PAQ.jpeg"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Nicely tuned! Photo by <a class="ae lb" href="https://unsplash.com/photos/RyVXnQdcw_4?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Ali Morshedlou</a> on <a class="ae lb" href="https://unsplash.com/search/photos/tune?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="6a65" class="ll lm iq bd me mf mg dn mh mi mj dp mk ko ml mm mn ks mo mp mq kw mr ms mt mu bi translated">用新的概率阈值进行评估和预测</h2><p id="29b3" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我们可以(对保留的数据集)进行评估，看看我们是否达到了预期的召回率:</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="bbf9" class="ll lm iq lh b gy ln lo l lp lq">SELECT * from ML.EVALUATE(MODEL flights.delayed,<br/>(<br/>SELECT<br/>  IF(arr_delay &lt; 15, 0, 1) AS late,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr` as f<br/>JOIN `cloud-training-demos.flights.trainday` as t<br/>USING(FL_DATE)<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>  AND is_train_day = 'False'<br/>), <strong class="lh ir">STRUCT(0.3348 AS threshold)</strong>)</span></pre><p id="db7c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这给了我们:</p><figure class="lc ld le lf gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nf"><img src="../Images/d4bb6afbf05c80ddf30049321be29705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mZsJqculXeGFvshDFXCUw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">We get the hoped-for recall of 70% on the independent evaluation dataset!</figcaption></figure><p id="6717" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">万岁！我们在独立评估数据集上也获得了 70%的召回率，所以看起来我们没有过度拟合。</p><p id="005e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">和 ML 一样。评估，当我们进行最大似然预测时，我们可以指定概率的期望阈值:</p><pre class="lc ld le lf gt lg lh li lj aw lk bi"><span id="c0eb" class="ll lm iq lh b gy ln lo l lp lq">SELECT * from ML.PREDICT(MODEL flights.delayed,<br/>(<br/>SELECT<br/>  IF(arr_delay &lt; 15, 0, 1) AS late,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr` as f<br/>JOIN `cloud-training-demos.flights.trainday` as t<br/>USING(FL_DATE)<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>  AND is_train_day = 'False'<br/>LIMIT 10<br/>), <strong class="lh ir">STRUCT(0.3348 AS threshold)</strong>)</span></pre><p id="46af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p></div></div>    
</body>
</html>