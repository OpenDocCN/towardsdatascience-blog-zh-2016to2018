<html>
<head>
<title>Doing Data Science at the command line in Google Cloud Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Google 云平台的命令行上做数据科学</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/doing-data-science-at-the-command-line-38fe9f17121d?source=collection_archive---------10-----------------------#2018-10-03">https://towardsdatascience.com/doing-data-science-at-the-command-line-38fe9f17121d?source=collection_archive---------10-----------------------#2018-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><p id="0684" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">数据工程是关于收集和收集数据，以适当的方式存储数据，进行一些处理并提供给数据科学家。</p><p id="297c" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">每个数据科学家在享受总是期待的建模阶段之前，都必须面对许多数据工程和数据准备任务。此外，当开始一个新项目时，你必须考虑选择正确的语言和平台的权衡。</p><p id="4769" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">此刻抛开平台，R，Python，Julia，Matlab，Octave 等。是数据科学中使用的一些语言吗，特别是 R 和 Python，它们在过去几年中有了很大的发展，并且有很大的社区支持。</p><p id="7bca" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">然而，现在我想解释你如何通过使用你的操作系统命令行来面对许多初始任务，以及 shell 如何必须是你的堆栈的一部分。</p><p id="2530" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">我们将发现像 curl、<a class="ae kt" href="https://www.gnu.org/software/sed/manual/sed.html" rel="noopener ugc nofollow" target="_blank"> sed </a>、<a class="ae kt" href="https://stedolan.github.io/jq/" rel="noopener ugc nofollow" target="_blank"> jq </a>或<a class="ae kt" href="https://csvkit.readthedocs.io" rel="noopener ugc nofollow" target="_blank"> csvkit </a>这样的命令行程序如何通过编写更少的代码来简化您的许多重复任务，通过使用低级接口使其可移植甚至更快。</p><p id="87b6" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">在这篇文章中，我们将一起使用这些神奇的工具，不需要任何 IDE、笔记本等就可以通过管道传输它们的命令。下载、转换、转换并加载到大数据仓库中。</p><p id="2034" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">这些数据由<a class="ae kt" href="https://www.emtmadrid.es" rel="noopener ugc nofollow" target="_blank">EMT de Madrid</a>(Empresa municipal de transportes de Madrid)发布，可在<a class="ae kt" href="http://opendata.emtmadrid.es/Datos-estaticos/Datos-generales-(1)" rel="noopener ugc nofollow" target="_blank">http://open data . EMT Madrid . es</a>获得，这是一组文件，记录了从 2017 年 4 月到 2018 年 8 月<a class="ae kt" href="https://www.bicimad.com/" rel="noopener ugc nofollow" target="_blank"> BiciMad </a>(马德里的公共自行车租赁服务)用户的所有旅行。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ku"><img src="../Images/3d4397a73b0d23df99de027cf3046400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LLL3KPQmyHp3oM5dtz_fRw.jpeg"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk">© Oriol Salvador (<a class="ae kt" href="https://www.flickr.com/photos/boarderland/" rel="noopener ugc nofollow" target="_blank">https://www.flickr.com/photos/boarderland/</a>)</figcaption></figure><p id="6670" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">该集合 ATOW 由 17 个文件和 26.35 GB 的 28.550.144 条记录组成，其中每一条记录记录了两个自行车站点之间的自行车旅行，这两个站点的信息也在一个单独的文件中提供，我们将在后面展示。</p><p id="2a91" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">为了下载所有这些文件，我更喜欢做一些 web 清理，这样我甚至可以自动下载并以编程方式获取新数据。</p><p id="b7ac" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">这可以使用<strong class="jx ir">命令行</strong>轻松完成。首先，我们必须检查所有的链接有一个共同的模式来识别所有的文件。通过使用浏览器开发人员控制台，我们可以检查 DOM 和 HTML 文档源代码来找到链接。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi lk"><img src="../Images/cb2fc7422a2053d4f8652eff2bae1b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*izq4UzmSgHpPigeeNz3eNQ.png"/></div></div></figure><p id="471a" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">前面的图片显示了所有的文件都有一个共同的结构，所以，是时候做一些编码了！</p><h2 id="13cf" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kg lu lv lw kk lx ly lz ko ma mb mc md bi translated">可选择的</h2><blockquote class="me mf mg"><p id="587b" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ij bi translated">我喜欢<a class="ae kt" href="https://en.wikipedia.org/wiki/Serverless_computing" rel="noopener ugc nofollow" target="_blank">无服务器</a>架构和云计算，因为它们通过向每个数据科学家提供无限、可扩展、容错和廉价的资源，使数据科学民主化，而不需要特定的硬件或系统维护。谷歌云平台是我最喜欢的平台之一，我将使用它来启动一个计算引擎实例，并在那里执行所有命令。</p><p id="c90a" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ij bi translated">这基本上和在我自己的笔记本电脑上做是一样的，但我将受益于谷歌云数据中心的巨大带宽。Google 还为所有机器提供了 Google Cloud SDK，无需管理本练习最后步骤所需的身份验证即可使用。这非常符合我做<a class="ae kt" href="https://www.oreilly.com/ideas/a-manifesto-for-agile-data-science" rel="noopener ugc nofollow" target="_blank">敏捷数据科学</a>的想法。</p></blockquote><p id="7d56" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">我们有几种方式与谷歌云平台互动:一个令人敬畏的网络界面，强大的 API，主要编程语言的库，…和实用的 SDK。因为我将只使用 shell，所以 SDK 是我的首选。通过使用它，我也可以确信所有的德 GCP 命令可以在任何操作系统中执行，并很容易向你展示我在做什么。</p><p id="3c60" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">如果你想自己做，你可以在这里有<a class="ae kt" href="https://cloud.google.com/sdk/docs/quickstarts" rel="noopener ugc nofollow" target="_blank">指令</a>下载并在你的操作系统中设置它，但是如果你使用的是 Linux 或 Mac(我希望你这样做)，它就像:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="2851" class="ll lm iq mm b gy mq mr l ms mt">curl https://sdk.cloud.google.com | bash<br/>exec -l $SHELL</span></pre><p id="1600" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">安装完成后，您可以通过以下方式开始安装:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="edf0" class="ll lm iq mm b gy mq mr l ms mt">gcloud init</span></pre><blockquote class="me mf mg"><p id="e578" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ij bi translated">对于上一步，你需要一个谷歌云平台帐户。是<a class="ae kt" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank">免费</a>。</p></blockquote><p id="b3cc" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">现在我准备启动一个虚拟机。我不需要一个非常强大的硬盘，但必须有足够的存储空间来下载所有文件，所以我会安装一个 200G 的硬盘。</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="e532" class="ll lm iq mm b gy mq mr l ms mt">gcloud beta compute --project=datascience-open-data instances create bicimad-vm --zone=europe-west1-b --machine-type=n1-standard-2 --subnet=default --network-tier=PREMIUM --maintenance-policy=MIGRATE --service-account=874126907357-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/cloud-platform --image=ubuntu-minimal-1804-bionic-v20180917 --image-project=ubuntu-os-cloud --boot-disk-size=200GB --boot-disk-type=pd-standard --boot-disk-device-name=bicimad-vm</span></pre><p id="20fc" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">一旦部署了虚拟机，be 就可以从<a class="ae kt" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank"> Google Cloud Shell </a>或我们的本地计算机登录到它:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="78e4" class="ll lm iq mm b gy mq mr l ms mt">gcloud compute --project "datascience-open-data" ssh --zone "europe-west1-b" "bicimad-vm"</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mu"><img src="../Images/9dda4957ca0be86c8da520b254abba8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wQuS5Jf73VXapk4TcstGYw.png"/></div></div></figure></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><h2 id="e728" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kg lu lv lw kk lx ly lz ko ma mb mc md bi translated">下载数据</h2><p id="c007" class="pw-post-body-paragraph jv jw iq jx b jy mv ka kb kc mw ke kf kg mx ki kj kk my km kn ko mz kq kr ks ij bi translated">现在，我们准备将文档源代码下载到本地文件中:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="391a" class="ll lm iq mm b gy mq mr l ms mt">curl '<a class="ae kt" href="http://opendata.emtmadrid.es/Datos-estaticos/Datos-generales-(1)'" rel="noopener ugc nofollow" target="_blank">http://opendata.emtmadrid.es/Datos-estaticos/Datos-generales-(1)'</a> &gt; bicimad.html</span></pre><p id="ce8d" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">我们可以检查源代码:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="697f" class="ll lm iq mm b gy mq mr l ms mt">cat bicimad.html</span></pre><p id="41d9" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">在这里，我们再次检查文件链接是否具有相同的结构:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="7617" class="ll lm iq mm b gy mq mr l ms mt">&lt;li style="margin-bottom: 6px;margin-left: 12px;list-style-type: none;display: list-item;"&gt;</span><span id="1d12" class="ll lm iq mm b gy na mr l ms mt">&lt;img src="/Imagenes/Extensiones-de-archivos/zip_logo.aspx"/&gt;&lt;a target="_blank" href="/getattachment/8bb73c41-eab0-4e6a-ac92-80c8c68aacc2/201704_Usage_Bicimad.aspx" title="Datos de uso de Abril de 2017. Nueva ventana" &gt; Datos de uso de Abril de 2017&lt;/a&gt;</span><span id="8ad6" class="ll lm iq mm b gy na mr l ms mt">&lt;/li&gt;&lt;li style="margin-bottom: 6px;margin-left: 12px;list-style-type: none;display: list-item;"&gt;</span><span id="7b4f" class="ll lm iq mm b gy na mr l ms mt">&lt;img src="/Imagenes/Extensiones-de-archivos/zip_logo.aspx"/&gt;&lt;a target="_blank" href="/getattachment/11054216-35d1-4003-b76b-8421c4a46eb4/201705_Usage_Bicimad.aspx" title="Datos de uso de Mayo de 2017. Nueva ventana" &gt; Datos de uso de Mayo de 2017&lt;/a&gt;</span><span id="a665" class="ll lm iq mm b gy na mr l ms mt">&lt;/li&gt;</span></pre><p id="287b" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">现在我们必须得到那些文件链接。通过将<code class="fe nb nc nd mm b">sed</code>与一些正则表达式知识结合起来，这非常容易:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="8e11" class="ll lm iq mm b gy mq mr l ms mt">cat bicimad.html | sed -n 's/.*href="\/getattachment\([^"]*Bicimad\.aspx\).*/\1/p'</span></pre><p id="7575" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">这是我们得到的结果:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mu"><img src="../Images/298896fa22ed2ddd8ed5c264066ed0bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*42LU1MjRas8zsInVere9iA.png"/></div></div></figure><p id="37fa" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">现在我们只需要用域名(<em class="mh">http://open data . EMT Madrid . es</em>)完成远程服务器中的文件路径就可以获得完整的 URL:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="8dd8" class="ll lm iq mm b gy mq mr l ms mt">cat bicimad.html | sed -n 's/.*href="\/getattachment\([^"]*Bicimad\.aspx\).*/\1/p' | sed -e 's/^/http:\/\/opendata.emtmadrid.es\/getattachment/'</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mu"><img src="../Images/418c79a3a617bb1a3ea371748a40efdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IKJjYe2nq3GwXIJXqrBXBQ.png"/></div></div></figure><p id="6eeb" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">我们将<code class="fe nb nc nd mm b">sed</code>所做的最终处理保存到一个临时文件<code class="fe nb nc nd mm b">tmp_file</code>:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="0846" class="ll lm iq mm b gy mq mr l ms mt">cat bicimad.html | sed -n 's/.*href="\/getattachment\([^"]*Bicimad\.aspx\).*/\1/p' | sed -e 's/^/http:\/\/opendata.emtmadrid.es\/getattachment/' &gt; tmp_file</span></pre><p id="98f1" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">这个临时文件包含指向压缩数据文件的所有 URL:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="6ba7" class="ll lm iq mm b gy mq mr l ms mt">cat tmp_file</span></pre><p id="d630" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">结果是:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mu"><img src="../Images/c709568df6257d169c74e62e6c2e571a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*juCSBJLBFdN3ivTVvgfM_Q.png"/></div></div></figure><p id="eeb2" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">现在，我们只需浏览之前的每个 URL，并将它们下载到我们的系统中。一种方法是结合<code class="fe nb nc nd mm b">curl</code> + <code class="fe nb nc nd mm b">parallel</code>。这样我们可以同时下载几个文件。首先我们安装<code class="fe nb nc nd mm b">parallel</code>:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="d18a" class="ll lm iq mm b gy mq mr l ms mt">sudo apt-get update<br/>sudo apt-get install parallel</span></pre><p id="711a" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">安装完成后，我们读取<code class="fe nb nc nd mm b">tmp_file</code>，将所有链接发送到<code class="fe nb nc nd mm b">curl</code>:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="cdb0" class="ll lm iq mm b gy mq mr l ms mt">cat tmp_file | parallel -j 4 curl -O</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mu"><img src="../Images/334e65db6754b8d2e69cfc1210746ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0_cHS2JEtHZt1N39ZzFTzA.png"/></div></div></figure><p id="2426" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">这个过程需要几分钟。完成后，我们可以通过在当前目录中执行<code class="fe nb nc nd mm b">ls -l</code>来检查下载的文件:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mu"><img src="../Images/2d222b7409ace45f36960be97045e50b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SlPPcF6ceX3Qted4PmUydA.png"/></div></div></figure><p id="081d" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">下一步是解压缩文件。我们需要先安装<code class="fe nb nc nd mm b">unzip</code>:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="610d" class="ll lm iq mm b gy mq mr l ms mt">sudo apt-get install unzip</span></pre><p id="dfc4" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">…然后我们解压缩所有以<em class="mh"> Bicimad.aspx </em>结尾的文件:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="8f7a" class="ll lm iq mm b gy mq mr l ms mt">TMP_DIR="."<br/>ZIP_FILES=*Bicimad.aspx</span><span id="9adb" class="ll lm iq mm b gy na mr l ms mt">for FILE in `ls  ${TMP_DIR}/${ZIP_FILES} `; do<br/>  echo $FILE<br/>  unzip -o $FILE<br/>done</span></pre><p id="3c43" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">所有压缩文件都在同一个文件夹中解压缩，因此<code class="fe nb nc nd mm b">ls -l *.json</code>显示为 Json 文件，其中包含数据:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi mu"><img src="../Images/3647fe5e943028e628d37274765d313a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0rrz9kYVPTsyyXevHtQajQ.png"/></div></div></figure><p id="2123" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">接下来，我们将检查 Json 文件的内容，以理解提供给我们的结构化数据。为了处理 Json 文件，<code class="fe nb nc nd mm b">jq</code>是我们最好的朋友，所以 web 将像我们通常做的那样安装它。然后我们打印任何文件的第一行:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="070d" class="ll lm iq mm b gy mq mr l ms mt">sudo apt-get install jq</span><span id="b1a2" class="ll lm iq mm b gy na mr l ms mt">cat 201808_Usage_Bicimad.json | head -1 | jq</span></pre><p id="5113" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">我们可以检查这个 Json 是否遵循了从 MongoDB 导出数据的典型模式:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="6be9" class="ll lm iq mm b gy mq mr l ms mt">{<br/>  "_id": {<br/>    "$oid": "5b6779012f384302541d6813"<br/>  },<br/>  "user_day_code": "6c30d6e283ea7a160379fa9adb20b93d2c06e16853ad0804e26485e98066f6ba",<br/>  "idplug_base": 11,<br/>  "track": {<br/>    "type": "FeatureCollection",<br/>    "features": [<br/>      {<br/>        "geometry": {<br/>          "type": "Point",<br/>          "coordinates": [<br/>            -3.7078158,<br/>            40.4127144997222<br/>          ]<br/>        },<br/>        "type": "Feature",<br/>        "properties": {<br/>          "var": "28005,ES,Madrid,Madrid,CALLE SAN BRUNO 1,Madrid",<br/>          "speed": 6.19,<br/>          "secondsfromstart": 190<br/>        }<br/>      },<br/>      {<br/>        "geometry": {<br/>          "type": "Point",<br/>          "coordinates": [<br/>            -3.7071841,<br/>            40.4156114997222<br/>          ]<br/>        },<br/>        "type": "Feature",<br/>        "properties": {<br/>          "var": "28012,ES,Madrid,Madrid,PLAZA MAYOR 27,Madrid",<br/>          "speed": 3.47,<br/>          "secondsfromstart": 130<br/>        }<br/>      },<br/>      {<br/>        "geometry": {<br/>          "type": "Point",<br/>          "coordinates": [<br/>            -3.7048058,<br/>            40.4167895<br/>          ]<br/>        },<br/>        "type": "Feature",<br/>        "properties": {<br/>          "var": "28013,ES,Madrid,Madrid,CALLE ARENAL 1,Madrid",<br/>          "speed": 3.61,<br/>          "secondsfromstart": 71<br/>        }<br/>      }<br/>    ]<br/>  },<br/>  "user_type": 1,<br/>  "idunplug_base": 7,<br/>  "travel_time": 228,<br/>  "idunplug_station": 1,<br/>  "ageRange": 0,<br/>  "idplug_station": 43,<br/>  "unplug_hourTime": {<br/>    "$date": "2018-08-01T01:00:00.000+0200"<br/>  },<br/>  "zip_code": ""<br/>}</span></pre><p id="9f53" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">每条记录为我们提供了以下变量:</p><ul class=""><li id="56d8" class="ne nf iq jx b jy jz kc kd kg ng kk nh ko ni ks nj nk nl nm bi translated">_id:记录标识</li><li id="a603" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">user_day_code:当天的用户标识</li><li id="5d7e" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">idunplug_station:起点自行车站</li><li id="4ce2" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">idunplug_base:原点自行车站中的 base</li><li id="21f8" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">idplug_station:落客自行车站</li><li id="438d" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">idplug_base:落客自行车站中的基地</li><li id="c950" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">unplug_hourTime:租赁开始时间。</li><li id="efea" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">travel_time:以秒为单位，自行车拔掉插头和插上插头之间的时间</li><li id="25ba" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">轨道:行程路径</li><li id="9c60" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">用户类型:1。-按年订阅的用户，2。-偶尔使用者，3。-企业用户</li><li id="fb59" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">ageRange: 1。-[0–16]年，2。- [17–18], 3.- [19–26], 4.-[27–40], 5.-[41–65], 6.- [&gt;66]</li><li id="ea8f" class="ne nf iq jx b jy nn kc no kg np kk nq ko nr ks nj nk nl nm bi translated">zip_code:用户邮政编码。</li></ul><blockquote class="me mf mg"><p id="4a38" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ij bi translated"><a class="ae kt" href="http://opendata.emtmadrid.es/Documentos/Servicios-y-estructuras-Bicimad-V1-1.aspx" rel="noopener ugc nofollow" target="_blank">完整描述</a>(西班牙语)</p></blockquote><p id="0445" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">从前面所有的变量中，有一个具有特殊的结构:<em class="mh"> track。</em>该密钥为<a class="ae kt" href="http://geojson.org/" rel="noopener ugc nofollow" target="_blank"> GeoJson </a>格式，这是一种在使用过程中注册自行车位置地理数据的便捷方式。看一下这个键，你会注意到系统每 60 秒跟踪一次自行车的位置。非常遗憾的是，这些信息在提供的某些时期是不可用的。</p></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><h2 id="3139" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kg lu lv lw kk lx ly lz ko ma mb mc md bi translated">将数据加载到 BigQuery</h2><p id="6620" class="pw-post-body-paragraph jv jw iq jx b jy mv ka kb kc mw ke kf kg mx ki kj kk my km kn ko mz kq kr ks ij bi translated">Google BigQuery 可能是最强大的无服务器数据仓库，是在几秒钟内处理大量数据的好地方。可以将 Json 文件导入到 BigQuery 表中，但它还不能处理 GeoJson，尽管它支持地理信息系统(GIS)。</p><p id="ca34" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">同时，我决定皈依*。json 文件转换成*。csv，但是在开始之前，建议更改文件编码。所提供的是 iso-8859–1 编码，这将在一些字符串中产生一些特殊西班牙字符的问题。</p><p id="bab8" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">我们可以使用以下代码检查文件编码:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="e9f2" class="ll lm iq mm b gy mq mr l ms mt">file --mime-encoding 201808_Usage_Bicimad.json</span></pre><p id="df14" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">最好的解决方案是使用<code class="fe nb nc nd mm b">iconv</code>将文件转换成 UTF-8:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="4916" class="ll lm iq mm b gy mq mr l ms mt">iconv -f iso-8859-1 -t UTF-8 201808_Usage_Bicimad.json &gt; tmp_file.json  &amp;&amp; mv -f tmp_file.json 201808_Usage_Bicimad.json</span></pre><p id="fe50" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">现在是时候从 Json ton CSV 转换了。正如之前指出的，并不是所有的每月 Json 文件都有带有地理位置值的<code class="fe nb nc nd mm b">track</code>键，我已经请求 EMT 来解决这个问题。同时，我们将只处理带有该信息的对象。</p><p id="eb1a" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">首先，我们检查<code class="fe nb nc nd mm b">track</code>是否存在，然后我们遍历所有的键，以获取它们的值，并以非规范化的方式将它们展平。一旦完成，我们可以使用 de '@csv' decorator 并将结果写入文件。</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="3b5d" class="ll lm iq mm b gy mq mr l ms mt">cat 201808_Usage_Bicimad.json | jq -r '. | select(.track != null) | .track.features[]  as $track | [._id[], .user_day_code, .idplug_base, .user_type, .idunplug_base, .travel_time, .idunplug_station, .ageRange, .idplug_station, .unplug_hourTime[], .zip_code]  + [$track.geometry.coordinates[0], $track.geometry.coordinates[1], $track.properties.var, $track.properties.speed, $track.properties.secondsfromstart]|<a class="ae kt" href="http://twitter.com/csv" rel="noopener ugc nofollow" target="_blank">@csv</a>' &gt; 201804_Usage_Bicimad.csv<br/></span></pre><p id="4cc2" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">强烈推荐使用的处理 CSV 文件的工具是<code class="fe nb nc nd mm b">csvkit</code>。尽管并非绝对必要，但我们将使用它以更好的方式检查 CSV 文件。以下是运行它所需的步骤:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="a847" class="ll lm iq mm b gy mq mr l ms mt">sudo apt-get install python-dev python-pip python-setuptools build-essential<br/>pip install --upgrade setuptools<br/>pip install --user csvkit<br/>export PATH=$HOME/.local/bin:$PATH</span></pre><p id="0b57" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">让我们检查一些随机列的结果:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="18fd" class="ll lm iq mm b gy mq mr l ms mt">cat 201804_Usage_Bicimad.csv | head -10 | csvcut -c 1,3,10,12,13,14  | csvlook --max-columns 6 --no-header-row</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi ns"><img src="../Images/21c595ef52c9bb991f184ed69d1aceb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*971EOwDsGYCSjBHFHCF47w.png"/></div></div></figure><p id="88eb" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">是时候将 CSV 文件加载到 BigQuery 中了！因为我们不能直接从本地机器加载数据，所以让我们将文件复制到 Google 云存储桶中。以下命令创建一个存储桶并将文件上传到其中:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="2048" class="ll lm iq mm b gy mq mr l ms mt">gsutil mb open-datasets<br/>gsutil -m cp 201808_Usage_Bicimad.csv gs://open-datasets/bicimad</span></pre><p id="b1cf" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">然后，我们将在 BigQuery 中创建新的数据集:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="1525" class="ll lm iq mm b gy mq mr l ms mt">bq --location=EU mk <!-- -->bicimad</span></pre><p id="c569" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">然后，我们必须在数据集中创建一个表。在这个例子中，我包括了表模式:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="852f" class="ll lm iq mm b gy mq mr l ms mt">bq mk --table bicimad.usage_201808 oid:STRING,user_day_code:STRING,idplug_base:STRING,user_type:INTEGER,idunplug_base:INTEGER,travel_time:INTEGER,idunplug_station:INTEGER,ageRange:INTEGER,idplug_station:INTEGER,unplug_hourTime:STRING,zip_code:STRING,latitude:FLOAT,longitude:STRING,var:STRING,speed:FLOAT,secondsfromstart:INTEGER</span></pre><p id="3cda" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">最后，我们创建一个加载作业，将 CSV 文件从 Google 云存储桶导入到新表中:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="ea14" class="ll lm iq mm b gy mq mr l ms mt">bq load --source_format=CSV --replace --quote='"'  bicimad.usage_201808 gs://open-datasets/bicimad/201804_Usage_Bicimad.csv</span></pre><blockquote class="me mf mg"><p id="ccf2" class="jv jw mh jx b jy jz ka kb kc kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ks ij bi translated">向 BigQuery 加载大量数据时，建议使用<a class="ae kt" href="https://cloud.google.com/bigquery/docs/partitioned-tables" rel="noopener ugc nofollow" target="_blank">分区表</a>。分区表使查询数据变得容易，提高了查询性能并减少了您的账单。在这种情况下，我们将每个月的数据加载到不同的表中，这是一种旧的数据分区方式，但是可以随意改进。</p></blockquote><p id="aec2" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">加载作业完成后，我们可以查询数据并检查结果:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="7633" class="ll lm iq mm b gy mq mr l ms mt">bq query --use_legacy_sql=false  'SELECT travel_time, unplug_hourTime, var FROM `datascience-open-data.bicimad.usage_201808` LIMIT 10'</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nt"><img src="../Images/0a742afef2eba302761110a8b7c2165a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fXm3eprYkNCt2pRy5yLdZw.png"/></div></div></figure><p id="5a0f" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">或者我们也可以使用 Google Cloud 控制台中的 BigQuery UI，这是开发 SQL 查询的推荐方式:</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nu"><img src="../Images/b975142d387d937fada77ecccbdc2d74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ibMZtNI83C7A9f-gQqVShw.png"/></div></div></figure></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><h1 id="f4ab" class="nv lm iq bd ln nw nx ny lq nz oa ob lt oc od oe lw of og oh lz oi oj ok mc ol bi translated">现在一起！</h1><p id="90e6" class="pw-post-body-paragraph jv jw iq jx b jy mv ka kb kc mw ke kf kg mx ki kj kk my km kn ko mz kq kr ks ij bi translated">因此，将 CSV 文件加载到我们的数据库的过程。为了加载它们，我们可以编写一个小的 bash 脚本来遍历目录中的所有 Json 文件，转换成 CSV 文件，上传到云中并加载到相应的表中。</p><p id="6e30" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">这正是<code class="fe nb nc nd mm b">transform_and_load.sh</code>要做的:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="9d3c" class="ll lm iq mm b gy mq mr l ms mt">#! /bin/bash</span><span id="bb93" class="ll lm iq mm b gy na mr l ms mt">TMP_DIR="."</span><span id="88d4" class="ll lm iq mm b gy na mr l ms mt">REPORT_FILENAME_PATTERN=*Bicimad.json</span><span id="c5b1" class="ll lm iq mm b gy na mr l ms mt">for FILE in `ls  ${TMP_DIR}/${REPORT_FILENAME_PATTERN} `; do</span><span id="1fe2" class="ll lm iq mm b gy na mr l ms mt">BASENAME=$(basename $FILE .json)</span><span id="e60d" class="ll lm iq mm b gy na mr l ms mt">YEAR_MONTH=`echo ${BASENAME:0:6}`</span><span id="a3a2" class="ll lm iq mm b gy na mr l ms mt">iconv -f iso-8859-1 -t UTF-8 "$FILE" &gt; "$FILE.new"  &amp;&amp; mv -f "$FILE.new" "$FILE"</span><span id="5d32" class="ll lm iq mm b gy na mr l ms mt">cat $FILE | jq -r '. | select(.track != null) | .track.features[]  as $track | [._id[], .user_day_code, .idplug_base, .user_type, .idunplug_base, .travel_time, .idunplug_station, .ageRange, .idplug_station, .unplug_hourTime[], .zip_code]  + [$track.geometry.coordinates[0], $track.geometry.coordinates[1], $track.properties.var, $track.properties.speed, $track.properties.secondsfromstart]|<a class="ae kt" href="http://twitter.com/csv" rel="noopener ugc nofollow" target="_blank">@csv</a>' &gt; $BASENAME.csv</span><span id="d9d2" class="ll lm iq mm b gy na mr l ms mt">gsutil -m cp $BASENAME.csv gs://open-datasets/bicimad</span><span id="aa0e" class="ll lm iq mm b gy na mr l ms mt">bq mk --table bicimad.usage_$YEAR_MONTH oid:STRING,user_day_code:STRING,idplug_base:STRING,user_type:INTEGER,idunplug_base:INTEGER,travel_time:INTEGER,idunplug_station:INTEGER,ageRange:INTEGER,idplug_station:INTEGER,unplug_hourTime:STRING,zip_code:STRING,latitude:FLOAT,longitude:STRING,var:STRING,speed:FLOAT,secondsfromstart:INTEGER</span><span id="509a" class="ll lm iq mm b gy na mr l ms mt">bq load --source_format=CSV --replace --quote='"'  bicimad.usage_$YEAR_MONTH gs://open-datasets/bicimad/$BASENAME.csv</span><span id="0da6" class="ll lm iq mm b gy na mr l ms mt">done</span></pre><p id="6f4d" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">我们将所有用户的执行权限添加到脚本中并运行它:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="3e38" class="ll lm iq mm b gy mq mr l ms mt">chmod 755 transform_and_load.sh<br/>./transform_and_load.sh</span></pre><p id="d476" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">完成后，我们可以查询所有 2018 年的数据，以获得按年龄范围划分的自行车租赁时长中位数(我不喜欢没有正态分布数据的平均值)。</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="2c04" class="ll lm iq mm b gy mq mr l ms mt">SELECT<br/>  ageRange,<br/>  ROUND(APPROX_QUANTILES(travel_time/60,1000)[OFFSET(500)], 2) AS median_travel_time<br/>FROM<br/>  `datascience-open-data.bicimad.usage_2018*`<br/>GROUP BY<br/>  ageRange<br/>ORDER BY<br/>  2 DESC</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi om"><img src="../Images/1c24feeb27a5c2b67140b9d675c333a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*luJU09mHuE52gjwT_LuTVQ.png"/></div></div></figure><p id="0651" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">就自行车租赁持续时间而言，似乎最年轻的用户(年龄 1)也是最大的用户。我们可以知道检查他们是否也是最频繁的用户等等。</p></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><h1 id="afac" class="nv lm iq bd ln nw nx ny lq nz oa ob lt oc od oe lw of og oh lz oi oj ok mc ol bi translated">自行车站点数据</h1><p id="5ccd" class="pw-post-body-paragraph jv jw iq jx b jy mv ka kb kc mw ke kf kg mx ki kj kk my km kn ko mz kq kr ks ij bi translated">正如我之前告诉您的，我们将对包含每个自行车站点信息的数据集重复相同的步骤。</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="a054" class="ll lm iq mm b gy mq mr l ms mt">curl -o Bicimad_Estacions_201808.rar <a class="ae kt" href="http://opendata.emtmadrid.es/getattachment/8321277e-4f8b-4a45-89fd-63cbeefa1cf1/Bicimad_Estacions_201808.aspx" rel="noopener ugc nofollow" target="_blank">http://opendata.emtmadrid.es/getattachment/8321277e-4f8b-4a45-89fd-63cbeefa1cf1/Bicimad_Estacions_201808.aspx</a> &amp;&amp; unrar x Bicimad_Estacions_201808.rar &amp;&amp; rm Bicimad_Estacions_201808.rar</span><span id="cc5b" class="ll lm iq mm b gy na mr l ms mt">iconv -f iso-8859-1 -t UTF-8 Bicimad_Estacions_201808.json &gt; tmp_file.json  &amp;&amp; mv -f tmp_file.json Bicimad_Estacions_201808.json</span></pre><p id="56b6" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">这是数据集中可用的信息:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="2af7" class="ll lm iq mm b gy mq mr l ms mt">{<br/>  "activate": 1,<br/>  "name": "Colón A",<br/>  "reservations_count": 0,<br/>  "light": 0,<br/>  "total_bases": 18,<br/>  "free_bases": 14,<br/>  "number": "106a",<br/>  "longitude": "-3.6877227",<br/>  "no_available": 0,<br/>  "address": "Calle Serrano nº 34",<br/>  "latitude": "40.4251002",<br/>  "dock_bikes": 3,<br/>  "id": 111<br/>}</span></pre><p id="bfd7" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">让我们转换成 CSV 格式:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="23c1" class="ll lm iq mm b gy mq mr l ms mt">cat Bicimad_Estacions_201808.json | jq -r '.stations[] | [.[]] | <a class="ae kt" href="http://twitter.com/csv" rel="noopener ugc nofollow" target="_blank">@csv</a>' &gt; bike_stations.csv</span></pre><p id="9532" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">因为这个数据集很小(12.9 MB)，所以我们可以直接从本地磁盘加载到 BigQuery 中。</p><p id="838d" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">第一个 web 制作新表格:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="f032" class="ll lm iq mm b gy mq mr l ms mt">bq mk --table bicimad.bike_stations activate:INTEGER,name:STRING,reservations_count:INTEGER,light:INTEGER,total_bases:INTEGER,free_bases:INTEGER,number:STRING,longitude:FLOAT,no_available:INTEGER,address:STRING,latitude:FLOAT,dock_bikes:INTEGER,id:INTEGER</span></pre><p id="8671" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">然后我们创建一个加载作业:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="37a5" class="ll lm iq mm b gy mq mr l ms mt">bq load --source_format=CSV --replace --quote='"'  bicimad.bike_stations bike_stations.csv</span></pre><p id="696b" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">通过观察数据，我们可以看到每个自行车站点都有几个记录，记录了数据集未提供的时间段内<code class="fe nb nc nd mm b">freee_bases</code>和其他字段的变化。</p><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi on"><img src="../Images/4a689183ed07b3a3f5251d748b08115a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dhwbl3CO1w8-fJMbOFO6OA.png"/></div></div></figure><p id="ec6c" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">尽管如此，我们可以查看可用自行车站的数量:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="591b" class="ll lm iq mm b gy mq mr l ms mt">SELECT<br/>  COUNT(DISTINCT name) AS total<br/>FROM<br/>  `datascience-open-data.bicimad.bike_stations`</span></pre><figure class="kv kw kx ky gt kz gh gi paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gh gi nt"><img src="../Images/5d6099721c00f1cb590830e78eb6c0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dcJBjCiYWH5e5zmKrlTPPw.png"/></div></div></figure><p id="67bb" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">加载完所有数据后，我们可以删除计算实例:</p><pre class="kv kw kx ky gt ml mm mn mo aw mp bi"><span id="0532" class="ll lm iq mm b gy mq mr l ms mt">gcloud compute instances delete bicimad-vm --zone=europe-west1-b --quiet</span></pre></div><div class="ab cl jo jp hu jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="ij ik il im in"><p id="c904" class="pw-post-body-paragraph jv jw iq jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ij bi translated">目前就这些。在下一篇文章中，我们将使用 SQL 进行一些探索性的数据分析。也不是 R 或 Python，我保证！</p></div></div>    
</body>
</html>