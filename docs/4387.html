<html>
<head>
<title>Stock Market Analysis in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 中的股票市场分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stock-market-analysis-in-python-part-1-getting-data-by-web-scraping-cb0589aca178?source=collection_archive---------2-----------------------#2018-08-13">https://towardsdatascience.com/stock-market-analysis-in-python-part-1-getting-data-by-web-scraping-cb0589aca178?source=collection_archive---------2-----------------------#2018-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9724" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第 1 部分:通过 Web 抓取获取数据</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/31210e8fe8d8f5fbaa9317b1b195bccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*okJsgoJDXQD5Nvyu-waDIw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Staying Invested! What was your gain?</figcaption></figure><p id="b8a5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">自 2013 年以来，全球股市经历了一轮壮观的牛市。在印度，许多公司增长了 10 倍以上。即使是行业领导者，nifty 50 或印度 50 强公司也增长了两倍以上。2017 年，Nifty 50 的年增长率(或回报率)超过 20%，2018 年的趋势似乎也是如此。人们正在投资共同基金和交易所交易基金来跟随这一趋势。</p><p id="de70" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这种情况下，我们似乎应该更多地投资股票，但如果你看看新闻，你会发现大多数市场分析师都认为目前的市场投资非常昂贵。那么，我们是相信他们的话，还是自己做一些数据分析来找出答案呢？我们如何在一个被高度高估的市场中找到好公司？这是又一次类似比特币/加密货币泡沫的炒作吗？</p><p id="cb5e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这一系列教程中，我们将使用 python 来找出答案。</p><p id="c8e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在第 1 部分中，我们学习如何获取数据。在第 2 部分中，我们将看看如何进行分析。</p><p id="87de" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本教程(第 1 部分)中，我们将学习</p><ul class=""><li id="d714" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">通过请求库在 python 中发出 http 请求。</li><li id="232b" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用 chrome 开发工具来查看数据在页面上的位置。</li><li id="83fb" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用 BeautifulSoup 库，当数据无法以结构化形式获得时，从下载的页面中抓取数据。</li><li id="5326" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">将表等数据解析为 python 2D 数组。</li><li id="87ad" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">抓取功能以字典的形式获取数据(键-值对)。</li></ul><p id="9478" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里需要的 Jupyter 笔记本是<a class="ae mf" href="https://github.com/faizanahemad/data-science-utils/blob/master/data_science_utils/financial/Web%20Scraping%20and%20Financial%20Data%20Exploration%20in%20Python-Tutorial.ipynb" rel="noopener ugc nofollow" target="_blank">这里是</a>。</p><h1 id="6594" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">设置</h1><ol class=""><li id="2b68" class="lr ls iq kx b ky my lb mz le na li nb lm nc lq nd lx ly lz bi translated">通过安装<a class="ae mf" href="https://www.anaconda.com/download/" rel="noopener ugc nofollow" target="_blank">蟒蛇</a>来安装 Jupyter 笔记本。关于在 Linux 服务器上安装，参见我的<a class="ae mf" href="https://medium.com/@faizanahemad/participating-in-kaggle-data-science-competitions-part-1-step-by-step-guide-and-baseline-model-5b0c6973022a" rel="noopener">上一篇文章</a>。</li><li id="f40a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq nd lx ly lz bi translated">确保除了 Anaconda 的默认包集之外，还安装了以下 python 包。</li></ol><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="f596" class="nj mh iq nf b gy nk nl l nm nn">beautifulsoup4<br/>fastnumbers<br/>dill</span></pre><p id="1faf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">3.启动一个 python 3 jupyter 笔记本并添加以下导入。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="3ad5" class="nj mh iq nf b gy nk nl l nm nn"><strong class="nf ir">import</strong> numpy <strong class="nf ir">as</strong> np <em class="no"># linear algebra</em><br/><strong class="nf ir">import</strong> pandas <strong class="nf ir">as</strong> pd <em class="no"># pandas for dataframe based data processing and CSV file I/O</em></span><span id="a54b" class="nj mh iq nf b gy np nl l nm nn"><strong class="nf ir">import</strong> requests <em class="no"># for http requests</em><br/><strong class="nf ir">from</strong> bs4 <strong class="nf ir">import</strong> BeautifulSoup <em class="no"># for html parsing and scraping<br/></em><strong class="nf ir">import</strong> bs4</span><span id="7eae" class="nj mh iq nf b gy np nl l nm nn"><strong class="nf ir">from</strong> fastnumbers <strong class="nf ir">import</strong> isfloat <br/><strong class="nf ir">from</strong> fastnumbers <strong class="nf ir">import</strong> fast_float<br/><strong class="nf ir">from</strong> multiprocessing.dummy <strong class="nf ir">import</strong> Pool <strong class="nf ir">as</strong> ThreadPool <br/><br/><strong class="nf ir">import</strong> matplotlib.pyplot <strong class="nf ir">as</strong> plt<br/><strong class="nf ir">import</strong> seaborn <strong class="nf ir">as</strong> sns<br/><strong class="nf ir">import</strong> json<br/><strong class="nf ir">from</strong> tidylib <strong class="nf ir">import</strong> tidy_document <em class="no"># for tidying incorrect html</em><br/><br/>sns.set_style('whitegrid')<br/>%matplotlib inline<br/><strong class="nf ir">from</strong> IPython.core.interactiveshell <strong class="nf ir">import</strong> InteractiveShell<br/>InteractiveShell.ast_node_interactivity = "all"</span></pre><p id="238c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们准备好开始了。如果有任何困难，请查看我在 Github 上的<a class="ae mf" href="https://github.com/faizanahemad/data-science-utils/blob/master/data_science_utils/financial/Web%20Scraping%20and%20Financial%20Data%20Exploration%20in%20Python-Tutorial.ipynb" rel="noopener ugc nofollow" target="_blank"> jupyter 笔记本。</a></p><h1 id="407f" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">我们收集数据时需要的一些实用程序</h1><h2 id="e782" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">字符串到浮点的转换</h2><p id="1369" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">网页中的很多数字都是用逗号和%符号组成的字符串。我们使用<a class="ae mf" href="https://pypi.org/project/fastnumbers/" rel="noopener ugc nofollow" target="_blank"> fastnumbers </a>库中的<code class="fe oe of og nf b">fast_float</code>函数。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="b80f" class="nj mh iq nf b gy nk nl l nm nn"><strong class="nf ir">def</strong> ffloat(string):<br/>    <strong class="nf ir">if</strong> string <strong class="nf ir">is</strong> <strong class="nf ir">None</strong>:<br/>        <strong class="nf ir">return</strong> np.nan<br/>    <strong class="nf ir">if</strong> type(string)==float <strong class="nf ir">or</strong> type(string)==np.float64:<br/>        <strong class="nf ir">return</strong> string<br/>    <strong class="nf ir">if</strong> type(string)==int <strong class="nf ir">or</strong> type(string)==np.int64:<br/>        <strong class="nf ir">return</strong> string<br/>    <strong class="nf ir">return</strong> fast_float(string.split(" ")[0].replace(',','').replace('%',''),<br/>                      default=np.nan)</span></pre><p id="c633" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们检查输入是否已经是 float/int，然后返回相同的值，否则删除逗号和%,然后转换。</p><p id="dbd5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">另一个函数来完成字符串列表的转换</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="8b4b" class="nj mh iq nf b gy nk nl l nm nn"><strong class="nf ir">def</strong> ffloat_list(string_list):<br/>    <strong class="nf ir">return</strong> list(map(ffloat,string_list))</span></pre><h2 id="a695" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">从字符串中删除多个空格</h2><p id="896c" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">当从网页中提取文本时，一些字符串在单词之间有多个空格，以保持一致性。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="993f" class="nj mh iq nf b gy nk nl l nm nn"><strong class="nf ir">def</strong> remove_multiple_spaces(string):<br/>    <strong class="nf ir">if</strong> type(string)==str:<br/>        <strong class="nf ir">return</strong> ' '.join(string.split())<br/>    <strong class="nf ir">return</strong> string</span></pre><h1 id="3083" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">用 Python 发出 Http 请求</h1><p id="aa7c" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">为此，我们将使用 python 请求库。您需要知道您将请求的页面的 url。</p><p id="421b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用方法<code class="fe oe of og nf b">requests.get</code>发出请求，我们用<code class="fe oe of og nf b">response.status_code</code>和<code class="fe oe of og nf b">response.content</code>分别获取 http 状态和页面内容</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="647e" class="nj mh iq nf b gy nk nl l nm nn">response <strong class="nf ir">=</strong> requests.get("http://www.example.com/", timeout=240)<br/>response<strong class="nf ir">.</strong>status_code<br/>response<strong class="nf ir">.</strong>content</span></pre><p id="a6b9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请注意，requests library 并不在页面上运行 javascript，因此在通过 javascript 加载 html 内容之后获取的任何数据/内容都将不可用。这不是一个问题，因为大多数金融网站通常遵循服务器端脚本，并向客户发送完整的页面。</p><h2 id="1b43" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">获取 Json 内容并解析它</h2><p id="f2a3" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">要从页面中获取 json 内容，只需做<code class="fe oe of og nf b">response.json()</code></p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="1987" class="nj mh iq nf b gy nk nl l nm nn">url <strong class="nf ir">=</strong> "<strong class="nf ir">https://jsonplaceholder.typicode.com/posts/1</strong>"<br/>response <strong class="nf ir">=</strong> requests.get(url, timeout=240)<br/>response.status_code<br/>response.json()<br/><br/>content <strong class="nf ir">=</strong> page_response.json()<br/>content.keys()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/7902f01ded2dbc4a8b637ea132e107e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t_6o0raazmQ1cvxrstaJ4w.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Json Response</figcaption></figure><p id="8d1e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了确保您的请求成功，请务必检查<code class="fe oe of og nf b">response.status_code</code>。</p><h1 id="219c" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">通过解析和遍历 HTML 抓取数据</h1><p id="f524" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">我们将使用 beautifulsoup4 库将 html 字符串解析成树状表示。</p><h2 id="b5f0" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">在 Jupyter 笔记本中呈现 HTML 字符串</h2><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="aff9" class="nj mh iq nf b gy nk nl l nm nn"><strong class="nf ir">from</strong> <strong class="nf ir">IPython.core.display</strong> <strong class="nf ir">import</strong> HTML<br/>HTML("<strong class="nf ir">&lt;b&gt;Rendered HTML&lt;/b&gt;</strong>")</span></pre><h2 id="6be2" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">使用 Chrome 检查器(开发工具)获取内容的位置</h2><p id="7dca" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">我们将会看到这个网址:<a class="ae mf" href="https://www.moneycontrol.com/india/stockpricequote/auto-2-3-wheelers/heromotocorp/HHM" rel="noopener ugc nofollow" target="_blank">https://www . money control . com/India/stockprice quote/auto-2-3-wheelers/hero moto corp/HHM</a></p><p id="f3b0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是一家在印度生产摩托车的公司的网页。请查看该页面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/6b16164f89aff045d10e539e14f3a4de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pgDbmzwzF9lu8M6iJfPqUQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Snapshot of the link</figcaption></figure><p id="3f29" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，要从页面中获取任何内容，您需要知道内容在 HTML 中的位置。所以首先我们会得到标题(“Hero Motocorp Ltd .”)。让我们用 Chrome inspector 检查页面。要在 mac 上使用 chrome inspector，请使用<code class="fe oe of og nf b">cmd+option+i</code>，在 windows 和 linux 上使用<code class="fe oe of og nf b">Control+Shift+I</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/5dc23ad0b79324ef83e5213f344339ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tm1Q6m_vo0Dcv-6mTgNBSw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Using inspector</figcaption></figure><p id="c308" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">打开 chrome inspector -&gt;点击元素(1) -&gt;点击光标框项目(2) -&gt;指向“Hero Motocorp Ltd .”然后点击。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/1cf885dfe128907f9923db0cb540e8f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-mUVC3ePaVColCadfslDiQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Finding element location</figcaption></figure><p id="6877" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如您所见，公司名称在<h1>标签中。接下来，我们看看如何在笔记本中获取这些内容。</h1></p><h2 id="b588" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">使用 BeautifulSoup4 解析和显示内容</h2><p id="4186" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">为此，我们需要获得响应，然后使用<code class="fe oe of og nf b">BeautifulSoup</code>类解析内容。最后，我们从&lt; h1 &gt;标签中获取内容并呈现出来。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="0e24" class="nj mh iq nf b gy nk nl l nm nn">response <strong class="nf ir">=</strong> requests.get("<a class="ae mf" href="https://www.moneycontrol.com/india/stockpricequote/auto-2-3-wheelers/heromotocorp/HHM" rel="noopener ugc nofollow" target="_blank"><strong class="nf ir">https://www.moneycontrol.com/india/stockpricequote/auto-2-3-wheelers/heromotocorp/HHM</strong></a>", timeout=240)<br/>page_content = <strong class="nf ir">BeautifulSoup</strong>(response.content, "<strong class="nf ir">html.parser</strong>")<br/>HTML(<strong class="nf ir">str</strong>(page_content.find("<strong class="nf ir">h1</strong>")))</span></pre><h2 id="7a16" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">通过属性获取 HTML 元素</h2><p id="f2d3" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">我们将在 id 为“b_changetext”的<div>中获取当天的价格变化。为此，您只需将一个<code class="fe oe of og nf b">attrs</code>对象传递给<code class="fe oe of og nf b">page_content.find</code></div></p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="8bcc" class="nj mh iq nf b gy nk nl l nm nn">response = requests.get("<a class="ae mf" href="https://www.moneycontrol.com/india/stockpricequote/auto-2-3-wheelers/heromotocorp/HHM" rel="noopener ugc nofollow" target="_blank"><strong class="nf ir">https://www.moneycontrol.com/india/stockpricequote/auto-2-3-wheelers/heromotocorp/HHM</strong></a>", timeout=240)<br/>content = BeautifulSoup(response.content, "<strong class="nf ir">html.parser</strong>")</span><span id="96e8" class="nj mh iq nf b gy np nl l nm nn">price_div = content.find("<strong class="nf ir">div</strong>",attrs={"<strong class="nf ir">id</strong>":'<strong class="nf ir">b_changetext</strong>'})<br/>HTML(str(price_div))</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/d6ccbb7f5a12a11e922e617547b4390d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3kkzfKvCTC-1EsLhEGJxg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Output of price getter code</figcaption></figure><p id="48a4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">find 的一些其他变体如下</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="91e4" class="nj mh iq nf b gy nk nl l nm nn">content.find_all("p")<br/>content.find_next("p",attrs={"class":"my-id"})</span></pre><p id="88d7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe oe of og nf b">.find_all</code>查找页面中出现的所有给定规格。<code class="fe oe of og nf b">.find_next</code>查找下一个事件。一旦你有了元素，你可以做<code class="fe oe of og nf b">.text</code>来获得它的文本内容(浏览器 DOM 的<code class="fe oe of og nf b">innerText</code>)。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="6a2d" class="nj mh iq nf b gy nk nl l nm nn">elem = content.find("p",attrs={"class":"my-id"})<br/>text = elem.text</span></pre><h2 id="82e8" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">获取子元素</h2><p id="b5fb" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">要找到一个元素(通过上述方法找到的元素)的子元素，你需要对这个元素做<code class="fe oe of og nf b">.children</code>。这将给你一个可以在循环中使用的 iterable。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="d273" class="nj mh iq nf b gy nk nl l nm nn">list(price_div.children)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/387ff1ffcbfe9b6b4dd34b417376460f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QDb5FlkrcYKYOIFOdVfuNA.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">getting children of element</figcaption></figure><p id="c051" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如你在上面看到的,<code class="fe oe of og nf b">.children</code>给了你 3 个孩子，其中第一个是除了空间什么都没有的元素。我们将创建一个函数来过滤它，只给我们适当的元素。解析后页面上的任何实际元素都由<code class="fe oe of og nf b">bs4.element.Tag</code>类型表示。我们删除任何只有空格或换行符的字符串，除非它们包含在标签元素中。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="185d" class="nj mh iq nf b gy nk nl l nm nn"><strong class="nf ir">def</strong> get_children(html_content):<br/>    <strong class="nf ir">return</strong> [item <strong class="nf ir">for</strong> item <strong class="nf ir">in</strong> html_content.children <strong class="nf ir">if</strong> type(item)==bs4.element.Tag <strong class="nf ir">or</strong> len(str(item).replace("<strong class="nf ir">\n</strong>","").strip())&gt;0]</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/e29101d63d5016dc4f7a516c69cc43e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T4ZbN1KvKAonWFXd3_vAfQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Get children filter function output</figcaption></figure><h2 id="86f3" class="nj mh iq bd mi nq nr dn mm ns nt dp mq le nu nv ms li nw nx mu lm ny nz mw oa bi translated">解析表格</h2><p id="8d90" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">到目前为止，我们已经学会了如何从单个元素中找到我们需要的数据。但是桌子呢？每次一个单元格一个单元格地遍历表格来查找必要的信息将会非常麻烦。注意，可以使用<table>标签创建表格，也可以使用其他标签在 html 中创建类似表格的结构，我们将学习解析这两种类型。</table></p><p id="4c17" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，我们将创建一个函数，帮助以 2D 数组格式从表中获取表格数据。</p><p id="d22a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，我们创建一个表格并显示它。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="88ad" class="nj mh iq nf b gy nk nl l nm nn">html = '''<br/><strong class="nf ir">&lt;table&gt;<br/>    &lt;tr&gt;<br/>        &lt;td&gt;Month&lt;/td&gt;<br/>        &lt;td&gt;Price&lt;/td&gt;<br/>    &lt;/tr&gt;<br/>    &lt;tr&gt;<br/>        &lt;td&gt;July&lt;/td&gt;<br/>        &lt;td&gt;2&lt;/td&gt;<br/>    &lt;/tr&gt;<br/>    &lt;tr&gt;<br/>        &lt;td&gt;August&lt;/td&gt;<br/>        &lt;td&gt;4&lt;/td&gt;<br/>    &lt;/tr&gt;<br/>    &lt;tr&gt;<br/>        &lt;td&gt;September&lt;/td&gt;<br/>        &lt;td&gt;3&lt;/td&gt;<br/>    &lt;/tr&gt;<br/>    &lt;tr&gt;<br/>        &lt;td&gt;October&lt;/td&gt;<br/>        &lt;td&gt;2&lt;/td&gt;<br/>    &lt;/tr&gt;<br/>&lt;/table&gt;</strong></span><span id="4883" class="nj mh iq nf b gy np nl l nm nn">'''</span><span id="132c" class="nj mh iq nf b gy np nl l nm nn">HTML(html)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/01e0b785181bbd4f8fe589f297795ab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*-ZFU7vnIGwKI7JLzyLHEGQ.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Table to be parsed</figcaption></figure><p id="c42a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在实际实现之前，让我用伪代码解释一下解析过程</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="a3f7" class="nj mh iq nf b gy nk nl l nm nn">Step 1: Initialise final <strong class="nf ir">row_data</strong> as empty list.<br/>Step 2: Get all rows in a list<br/>Step 3: <strong class="nf ir">For</strong> each row in the list of rows<br/>        - Initialise <strong class="nf ir">current_row_data</strong> as empty list<br/>        - Get a list of cells in the row.<br/>        - <strong class="nf ir">For</strong> each cell get its text content<br/>          # <strong class="nf ir">if</strong> no text content present skip to next cell <br/>          # <strong class="nf ir">else</strong> put the text content into <strong class="nf ir">current_row_data<br/>        - </strong>Put <strong class="nf ir">current_row_data </strong>into <strong class="nf ir">row_data<br/></strong>Step 4: return <strong class="nf ir">row_data</strong></span></pre><p id="789c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下 python 函数实现了这些步骤。我们将使用它来解析前面的表。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="7650" class="nj mh iq nf b gy nk nl l nm nn"><strong class="nf ir">def</strong> <em class="no">get_table_simple</em>(table,is_table_tag=<strong class="nf ir">True</strong>):<br/>    elems = table.find_all('tr') <strong class="nf ir">if</strong> is_table_tag <strong class="nf ir">else</strong> get_children(table)<br/>    table_data = list()<br/>    <strong class="nf ir">for</strong> row <strong class="nf ir">in</strong> elems:<br/>        row_data = list()<br/>        row_elems = get_children(row)<br/>        <strong class="nf ir">for</strong> elem <strong class="nf ir">in</strong> row_elems:<br/>            text = elem.text.strip().replace("<strong class="nf ir">\n</strong>","")<br/>            text = remove_multiple_spaces(text)<br/>            <strong class="nf ir">if</strong> <strong class="nf ir"><em class="no">len</em></strong>(text)==0:<br/>                <strong class="nf ir">continue</strong><br/>            row_data.append(text)<br/>        table_data.append(row_data)<br/>    <strong class="nf ir">return</strong> table_data</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/5326452d463b882af6bd4e139fbfb73c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D3gpAvw-mqRPdEtdyCBZXQ.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Using get_table_simple</figcaption></figure><p id="de28" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们看看它是否能解析另一种类型的表。用<div>而不是<table>标签创建的。</table></div></p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="524a" class="nj mh iq nf b gy nk nl l nm nn">html = '''<br/>&lt;html&gt;<br/>&lt;body&gt;<br/>&lt;div id="table" class="FL" style="width:210px; padding-right:10px"&gt;<br/>    &lt;div class="PA7 brdb"&gt;<br/>        &lt;div class="FL gL_10 UC"&gt;MARKET CAP (Rs Cr)&lt;/div&gt;<br/>        &lt;div class="FR gD_12"&gt;63,783.84&lt;/div&gt;<br/>        &lt;div class="CL"&gt;&lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="PA7 brdb"&gt;<br/>        &lt;div class="FL gL_10 UC"&gt;P/E&lt;/div&gt;<br/>        &lt;div class="FR gD_12"&gt;17.27&lt;/div&gt;<br/>        &lt;div class="CL"&gt;&lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="PA7 brdb"&gt;<br/>        &lt;div class="FL gL_10 UC"&gt;BOOK VALUE (Rs)&lt;/div&gt;<br/>        &lt;div class="FR gD_12"&gt;589.29&lt;/div&gt;<br/>        &lt;div class="CL"&gt;&lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="PA7 brdb"&gt;<br/>        &lt;div class="FL gL_10 UC"&gt;DIV (%)&lt;/div&gt;<br/>        &lt;div class="FR gD_12"&gt;4750.00%&lt;/div&gt;<br/>        &lt;div class="CL"&gt;&lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="PA7 brdb"&gt;<br/>        &lt;div class="FL gL_10 UC"&gt;Market Lot&lt;/div&gt;<br/>        &lt;div class="FR gD_12"&gt;1&lt;/div&gt;<br/>        &lt;div class="CL"&gt;&lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="PA7 brdb"&gt;<br/>        &lt;div class="FL gL_10 UC"&gt;INDUSTRY P/E&lt;/div&gt;<br/>        &lt;div class="FR gD_12"&gt;19.99&lt;/div&gt;<br/>        &lt;div class="CL"&gt;&lt;/div&gt;<br/>    &lt;/div&gt;<br/>&lt;/div&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;<br/>'''<br/>HTML(html)</span><span id="26f1" class="nj mh iq nf b gy np nl l nm nn">content = BeautifulSoup(html,"html.parser")<br/>get_table_simple(content.find("div",attrs={"id":"table"}),is_table_tag=<strong class="nf ir">False</strong>)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/91706caaffcd951c3fe4769b75b39171.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jkBzwsS8dT92h3UNOjDiAw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Parsed 2D table in python</figcaption></figure><p id="aa31" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如你所见，它也成功地解析了这个。</p><h1 id="54bf" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">把它放在一起</h1><p id="1630" class="pw-post-body-paragraph kv kw iq kx b ky my jr la lb mz ju ld le ob lg lh li oc lk ll lm od lo lp lq ij bi translated">让我们看看页面上我可以获取数据的地方。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/cfcb5b3987d16da18724bd39458d3351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HFWBuz9tyd_Njk_0ccL9sg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">data locations</figcaption></figure><p id="4920" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我使用 chrome 开发工具检查了这些区域，并找到了正确的 id。对于下面的两个大框，我使用了我们之前写的<code class="fe oe of og nf b">get_table_simple</code>函数。分步过程如下</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="f3a6" class="nj mh iq nf b gy nk nl l nm nn">Step 1: Get page content using requests<br/>Step 2: Parse page content using BeautifulSoup<br/>Step 3: Use chrome dev tool to find id of each highlighted block<br/>Step 4: Get Price and yearly low, high.<br/>Step 5: Get the lower two boxes enclosing tag.<br/>Step 6: 1st box is 1st child, parse it as table.<br/>Step 7: 2nd box is 2nd child, parse it as table.<br/>Step 8: Combine the tables into a single dict named <strong class="nf ir">collector</strong>.<br/>Step 9: Populate the final dict <strong class="nf ir">key_val_pairs.</strong></span></pre><p id="353f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后一个函数如下。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/8610318004e276bea3903ccc7cd19703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YG6TzFOBc0Ce4ekTqs0xtg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Final Scrapping Function</figcaption></figure><p id="5f7e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了使用这个函数，我们将页面 url 传递给它。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="eb2b" class="nj mh iq nf b gy nk nl l nm nn">get_scrip_info("<strong class="nf ir">https://www.moneycontrol.com/india/stockpricequote/auto-2-3-wheelers/heromotocorp/HHM</strong>")</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/c4a8a2407ab879eb66d7a02d02096101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5zt12b75Rg5zf-0gdLNsw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Final Data from Scraping.</figcaption></figure><h1 id="1390" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">我们下一步能做什么？</h1><ul class=""><li id="416f" class="lr ls iq kx b ky my lb mz le na li nb lm nc lq lw lx ly lz bi translated">按 NSE 脚本名做搜索功能查找。(就像苹果是 APPL 一样，印度股票也有简称)</li><li id="5d6a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">获取过去的价格以分析回报</li><li id="f381" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">处理 html 不正确的页面(没有语法正确的 html 的页面，浏览器会纠正它们，然后呈现，但是抓取它们会很困难)。</li><li id="3286" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">简单的地图操作并行化，加快抓取速度。</li><li id="a15a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用 dill 或 pickle 库存储抓取数据的快照。</li><li id="af7c" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用各种图探索股票数据，如年度回报和价格偏差。</li><li id="ccf3" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">比较 Nifty 50、Nifty 100 和 Nifty Mid-cap 50 等指数的相互表现。ETF 跟踪指数，因此如果你投资 ETF，你需要了解指数的表现。</li><li id="fe7c" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">以市盈率、市净率等方式选股。</li></ul><p id="88d6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我将在以后的教程中介绍这些内容。</p><p id="1412" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae mf" href="https://github.com/faizanahemad/data-science-utils/blob/master/data_science_utils/financial/Web%20Scraping%20and%20Financial%20Data%20Exploration%20in%20Python-Tutorial.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本链接供参考。</a></p><h1 id="96fd" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">参考</h1><div class="ou ov gp gr ow ox"><a href="https://developers.google.com/web/tools/chrome-devtools/shortcuts" rel="noopener  ugc nofollow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd ir gy z fp pc fr fs pd fu fw ip bi translated">键盘快捷键参考 Web 开发人员工具| Google 开发人员</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">Chrome DevTools 中所有快捷键的参考。</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">developers.google.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl kp ox"/></div></div></a></div><div class="ou ov gp gr ow ox"><a href="https://ntguardian.wordpress.com/2016/09/19/introduction-stock-market-data-python-1/" rel="noopener  ugc nofollow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd ir gy z fp pc fr fs pd fu fw ip bi translated">用 Python 进行股票市场数据分析的介绍(第 1 部分)</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">这篇文章是过时的:这篇文章信息的更新在这里的链接！(我还打赌 WordPress.com…</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">ntguardian.wordpress.com</p></div></div><div class="pg l"><div class="pm l pi pj pk pg pl kp ox"/></div></div></a></div><div class="ou ov gp gr ow ox"><a href="https://mapattack.wordpress.com/2017/02/14/python-for-stocks-2/" rel="noopener  ugc nofollow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd ir gy z fp pc fr fs pd fu fw ip bi translated">用于股票的 Python</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">这是我上一篇文章的延续，这一次我们将做更多的图表来寻找多重…</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">mapattack.wordpress.com</p></div></div><div class="pg l"><div class="pn l pi pj pk pg pl kp ox"/></div></div></a></div></div></div>    
</body>
</html>