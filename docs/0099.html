<html>
<head>
<title>Write the code:</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写代码:</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/write-the-code-f6d58c728df0?source=collection_archive---------1-----------------------#2017-03-10">https://towardsdatascience.com/write-the-code-f6d58c728df0?source=collection_archive---------1-----------------------#2017-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e158" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Skyscanner推荐目的地背后的架构</h2></div><p id="e096" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">安德烈·巴博萨</p><p id="933c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Skyscanner，我们处理大量数据。一部分来自我们的合作伙伴的机票、酒店或租车费用，一部分来自我们的用户。传统上，我们的产品专注于使用我们从合作伙伴那里收集的数据来为我们的旅行者产品提供支持，我们使用来自用户的匿名行为数据来验证我们的假设并做出商业决策。</p><p id="9292" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在开始构建新一代产品，这些产品不仅基于我们合作伙伴的数据，还基于匿名化的用户行为数据，以提供更好、更个性化的体验。这些新产品带来了新的挑战，我们正在用新的方法和技术应对这些挑战。<a class="ae lc" href="http://tr4ckit.com/andre_codevoyagersmailinglist" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">你可以通过订阅我们的CodeVoyagers简讯</strong> </a>在这里看到更多我们的报道。</p><p id="b8fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近，我们在移动应用程序的“探索”屏幕上添加了推荐目的地。</p><div class="ld le lf lg gt ab cb"><figure class="lh li lj lk ll lm ln paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><img src="../Images/0b96657eecbaebe908a37fb93e8701b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*wykb_G7ly3UUrZD0cfXXOg.jpeg"/></div></figure><figure class="lh li lj lk ll lm ln paragraph-image"><img src="../Images/3dc64ac0093bd61c5b6109f04ff9eefb.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*ZhVQxrDiDLOPU3IiUfDo1g.jpeg"/><figcaption class="lu lv gj gh gi lw lx bd b be z dk ly di lz ma">Skyscanner’s Recommended Destinations functionality pictured above</figcaption></figure></div><p id="2a77" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着我们的用户不仅可以获得最优惠的价格，还可以利用我们的集体知识为他们的旅行寻找灵感。我们每天都会计算这些建议，并根据用户位置对其进行个性化设置。</p><p id="e2c7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">历史上，这个屏幕上的发现提要是由我们的“无处不在”搜索提供的，允许用户探索市场上最好的交易。对于推荐的feed，我们采取了一种稍微不同的方法，将价格放在一边，专注于用户的实际去向。到目前为止，自发布以来，我们已经看到我们的转化率增加了5%以上。</p><p id="94b6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章将概述我们为提供目的地推荐而构建的技术架构。</p><h2 id="81ac" class="mb mc iq bd md me mf dn mg mh mi dp mj ko mk ml mm ks mn mo mp kw mq mr ms mt bi translated">要求</h2><p id="c472" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">让我们先来看看支持这些建议的平台要求。从高层次的角度来看，有三点是问题的核心。我们需要:</p><ul class=""><li id="a09c" class="mz na iq kh b ki kj kl km ko nb ks nc kw nd la ne nf ng nh bi translated">存储大量历史数据，可用于训练和测试我们的模型；</li><li id="db22" class="mz na iq kh b ki ni kl nj ko nk ks nl kw nm la ne nf ng nh bi translated">处理大量数据；</li><li id="11e1" class="mz na iq kh b ki ni kl nj ko nk ks nl kw nm la ne nf ng nh bi translated">以最小的延迟向用户提供结果建议。</li></ul><p id="8efc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，当我们开始深入挖掘时，我们需要关心的事情更多了:</p><ul class=""><li id="0e8a" class="mz na iq kh b ki kj kl km ko nb ks nc kw nd la ne nf ng nh bi translated">快速实验——我们依靠用户反馈来验证我们的假设，因此我们需要能够轻松地即插即用新算法，并从管道的另一端获得结果；</li><li id="296f" class="mz na iq kh b ki ni kl nj ko nk ks nl kw nm la ne nf ng nh bi translated">最低运营成本—我们专注于产品，因此我们负担不起花费太多时间来运行手动工作或维护基础架构。</li></ul><h2 id="ba9e" class="mb mc iq bd md me mf dn mg mh mi dp mj ko mk ml mm ks mn mo mp kw mq mr ms mt bi translated">体系结构</h2><p id="db48" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">考虑到这些需求，我们设计了一个两层架构，如下图所示。</p><figure class="ld le lf lg gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nn"><img src="../Images/6a9d31a9b755162853c06987fdbb67fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FHTc7dov--yHKWf7ML5QUQ.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk">Two-tiered architecture behind Skyscanner’s Recommended Destinations</figcaption></figure><p id="3ec0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在最底部，我们有“日志数据存储”,它存储任何Skyscanner团队通过我们的数据平台记录的每个用户事件。我们的批处理层离线运行，并通过消费数据和运行一系列算法来利用这个数据存储。完成后，它会向实时数据存储提供新的推荐。这个数据存储是一个低延迟web API的基础，它为我们的用户提供计算数据。</p><p id="7592" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在批处理和实时之间进行明确分离的主要优势之一是，它为试验新算法和数据集提供了很大的空间。只要结果符合预定义的模式，我们知道它们可以由API提供服务。</p><p id="a627" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我们希望保持较低的运营成本，所以该架构构建为在AWS云上运行。日志数据存储基于S3，由我们的数据管理团队维护。</p><h2 id="1d75" class="mb mc iq bd md me mf dn mg mh mi dp mj ko mk ml mm ks mn mo mp kw mq mr ms mt bi translated">深入探讨批处理</h2><figure class="ld le lf lg gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nn"><img src="../Images/99e959a8f8d1591b025e548315289888.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ljqsm-fpWsMFdUUojPQ7Sw.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk">The batch processing layer is where we do all the data transformations that generate the recommendations that we serve through the live service.</figcaption></figure><p id="5ffe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">批处理层是我们进行所有数据转换的地方，这些数据转换生成我们通过实时服务提供的建议。</p><p id="fe26" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lc" href="https://aws.amazon.com/datapipeline/" rel="noopener ugc nofollow" target="_blank">我们使用AWS数据管道</a>来协调这项工作。DataPipeline非常适合我们的用例，有助于为我们的批处理作业带来可靠性。</p><p id="bb43" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">附加到我们的数据管道，我们有一个时间表，我们希望我们的批处理作业运行。这并不比普通的cron工作更花哨。但是将它与整个系统集成并完全由AWS管理是非常方便的。</p><p id="2f11" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还附加了一系列先决条件。这些有助于使管道更加可靠。我们使用这个特性来确保在开始这个过程之前，我们已经得到了我们需要的所有数据。当一些输入是不同批处理作业的输出时，这尤其重要。也可以将前提条件配置为等待一段时间，因此即使在计划的时间没有满足某个条件，也不一定意味着作业会失败，它可能只是稍微晚一点执行。这还意味着，如果先决条件从未得到满足，作业将在配置任何硬件之前失败，因此我们不会产生任何不必要的成本。</p><p id="0294" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当所有先决条件通过时，DataPipeline将提供一个<a class="ae lc" href="https://aws.amazon.com/emr/" rel="noopener ugc nofollow" target="_blank"> EMR集群</a>。EMR是AWS托管的<a class="ae lc" href="https://hadoop.apache.org/docs/r2.7.2/hadoop-yarn/hadoop-yarn-site/YARN.html" rel="noopener ugc nofollow" target="_blank"> Hadoop YARN </a>版本，适合您选择的分布式数据处理系统。<a class="ae lc" href="http://spark.apache.org/" rel="noopener ugc nofollow" target="_blank">我们选择了星火</a>。我们选择Spark有两个主要原因:它非常快，很大程度上是因为它的内存缓存，而且它对开发人员非常友好。我们特别喜欢Spark SQL和DataFrame抽象。此外，PySpark是我们的一大卖点。</p><p id="d926" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们编写的大部分代码都是作为Spark作业运行的。即使细节可能变得有点复杂，从高层次的角度来看，代码如下图所示。</p><figure class="ld le lf lg gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lo lp di lq bf lr"><div class="gh gi nn"><img src="../Images/eb356c2d940455a3176c5f8c2c0a80ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Az34Cgml2zNhQX1wesdMtw.png"/></div></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk">Read Clean Rank Write</figcaption></figure><h2 id="5330" class="mb mc iq bd md me mf dn mg mh mi dp mj ko mk ml mm ks mn mo mp kw mq mr ms mt bi translated">现场服务的深度探讨</h2><p id="f1bf" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">我们已经看了我们如何产生推荐；现在让我们来看看我们是如何为他们服务的。你可能已经猜到了，这一层非常薄，我们尽最大努力让它尽可能的轻和简单。</p><p id="d940" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于我们的实时数据存储，我们决定使用<a class="ae lc" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> Postgres </a>。我们选择它是因为:</p><ul class=""><li id="0cd9" class="mz na iq kh b ki kj kl km ko nb ks nc kw nd la ne nf ng nh bi translated">它在<a class="ae lc" href="https://aws.amazon.com/rds/" rel="noopener ugc nofollow" target="_blank"> RDS </a>中可用，AWS的托管关系数据库具有<a class="ae lc" href="https://aws.amazon.com/about-aws/whats-new/2016/06/amazon-rds-for-postgresql-now-supports-cross-region-read-replicas/" rel="noopener ugc nofollow" target="_blank">开箱即用的多区域复制</a>，这意味着我们的维护工作最少</li><li id="2d96" class="mz na iq kh b ki ni kl nj ko nk ks nl kw nm la ne nf ng nh bi translated">它具有非常低的延迟(我们一贯测量每个查询低于5毫秒)</li><li id="e729" class="mz na iq kh b ki ni kl nj ko nk ks nl kw nm la ne nf ng nh bi translated">很容易针对读取密集型工作负载进行扩展</li><li id="cc91" class="mz na iq kh b ki ni kl nj ko nk ks nl kw nm la ne nf ng nh bi translated">随着产品的成熟，修改模式和查询相对容易</li></ul><p id="beea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在数据存储的前面有一个服务REST API的web服务。在Skyscanner，我们相信微服务，最近开始向前端的后端发展。这意味着我们的移动客户端不需要直接查询这个API，他们通过一个BFF服务来完成，这个BFF服务聚合了他们渲染最终UI所需的所有数据。这个特殊的架构决策使得我们在这一层的工作变得更加容易。这意味着我们可以提供一个非常简单的API，供另一个内部服务使用。这样，我们最大化了可重用性，并使我们能够在不改变合同的情况下试验许多不同的UI。</p><h2 id="f447" class="mb mc iq bd md me mf dn mg mh mi dp mj ko mk ml mm ks mn mo mp kw mq mr ms mt bi translated">结论</h2><p id="3c95" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">我们已经在生产中运行了一段时间。到目前为止，它基本上是无痛的，但也不是没有学习和迭代的公平份额。在批处理层编写新算法并让它们立即投入使用的灵活性已经得到了回报，我们正在不断迭代。另一方面，维护DataPipeline所需的维护工作可能被低估了一点，因为我们最终花费了相当多的时间来处理服务中的许多警告。</p><p id="c534" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们预计未来面临的挑战之一是扩大批处理层的输出规模。输出的大小与我们使用的个性化因子成比例。例如，如果我们开始计算为每个Skyscanner用户单独定制的推荐，输出的大小将乘以我们用户群的大小。我们当前替换实时数据存储上的数据集的策略可能无法在这种规模下保持，在某个时候，我们将需要重新考虑该架构决策。</p><p id="0dd2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还有实时模型的问题。目前，一切都是批量完成的，但可能有产品需要更新鲜的结果。在Skyscanner，我们已经使用<a class="ae lc" href="http://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>进行流式数据处理，使用<a class="ae lc" href="http://samza.apache.org/" rel="noopener ugc nofollow" target="_blank"> Samza </a>进行一些实时处理。所以基础设施的这一面不会是最难的部分。但是，我们可能需要重新考虑我们为实时数据存储选择的Postgres，并可能转向更容易在写入繁重的工作负载上扩展的东西。</p><h2 id="78df" class="mb mc iq bd md me mf dn mg mh mi dp mj ko mk ml mm ks mn mo mp kw mq mr ms mt bi translated">与我们合作</h2><p id="748d" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">我们在Skyscanner以不同的方式做事，我们正在全球办事处寻找更多的工程团队成员。看看我们的<a class="ae lc" href="http://andre_skyscannerjobspage" rel="noopener ugc nofollow" target="_blank"> Skyscanner职位</a>寻找更多空缺。</p><h2 id="8960" class="mb mc iq bd md me mf dn mg mh mi dp mj ko mk ml mm ks mn mo mp kw mq mr ms mt bi translated">关于作者</h2><p id="5be9" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">大家好，我是André，是Skyscanner的一名软件工程师。我是忠诚的常客部落中的一员，我们致力于改善那些知道乘务员名字的旅客的体验。我热衷于提供产品，为人们的生活增加价值，并将其发展到世界规模。</p><figure class="ld le lf lg gt li gh gi paragraph-image"><div class="gh gi no"><img src="../Images/aa076bd6660e39e87b324c84fba9892f.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*MaNRxFIKhPLu356r82VCnw.jpeg"/></div><figcaption class="lu lv gj gh gi lw lx bd b be z dk">Andre Barbosa</figcaption></figure></div></div>    
</body>
</html>