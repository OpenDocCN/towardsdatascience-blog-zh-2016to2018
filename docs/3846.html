<html>
<head>
<title>Let’s make a map! Using Geopandas, Pandas and Matplotlib to make a Choropleth map</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们做一张地图吧！利用 Geopandas、pandas 和 Matplotlib 制作 Choropleth 地图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/lets-make-a-map-using-geopandas-pandas-and-matplotlib-to-make-a-chloropleth-map-dddc31c1983d?source=collection_archive---------0-----------------------#2018-06-25">https://towardsdatascience.com/lets-make-a-map-using-geopandas-pandas-and-matplotlib-to-make-a-chloropleth-map-dddc31c1983d?source=collection_archive---------0-----------------------#2018-06-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/52c4ed8a588f4282afb64372cd3429a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D33SyH0qKH-el2rzg6Nymg.png"/></div></div></figure><p id="0056" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以你想用 Python 做地图。我们开始吧！</p><p id="d764" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你已经开始用 Matplotlib 和 Pandas 做一些数据可视化，但是正在寻找地理数据入门的下一个简单步骤，我有你。我去过那里。事实上，我花了几个小时浏览在线教程，寻找最简单的软件包来开始制作地图(特别是 choropleths)。虽然有很多选择，但我最终选择了地质公园作为门槛最低的地方。</p><p id="9158" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Geopandas 很棒，因为它就像熊猫一样(但使用的是形状文件之类的地理数据)。Geopandas 数据帧与 pandas 数据帧非常相似，因此两者通常配合得很好。最重要的是，Geopandas 允许您创建快速、独立的 choropleth 地图，而没有许多其他依赖项(也没有太多代码行！).</p><p id="ff1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我们将要制作的预览。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kx"><img src="../Images/93b3ee4a7c9b3746f52be5bdf2d6766c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*abd6Vjl2b63X3G8GcUekxQ.png"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">It’s London! Made with Python.</figcaption></figure><p id="3d0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">顺便说一句，有很多制作地图的好方法(值得注意的是，<a class="ae kw" href="https://www.datawrapper.de/" rel="noopener ugc nofollow" target="_blank"> Datawrapper </a>刚刚添加了一个 GeoJson 包装器来加载你自己的定制地图)。没有放之四海而皆准的方法。然而，大多数这些服务都有某种限制(比如不能下载 svg 格式的文件。此外，用 Python 制作地图有几个独特的好处:</p><ul class=""><li id="1711" class="lg lh iq ka b kb kc kf kg kj li kn lj kr lk kv ll lm ln lo bi translated"><strong class="ka ir">再现性</strong>——Python 的一大卖点，尤其是制作超级快速图表。本教程将尽可能简化创建地图的过程(使用全局变量、清理等)，以便下次您想要创建地图时，您只需更改 csv 文件(假设它是相同的地理位置)。</li><li id="c7bc" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated"><strong class="ka ir">最大控制</strong> —定制，下载任何你想要的格式，你打电话。尽管可能需要修改一些代码，但 Matplotlib 非常强大。</li><li id="2a54" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated"><strong class="ka ir">很多很多的地图</strong> —如果你需要可视化同一个有很多变量的地图(多个小地图？)或显示随时间变化的地图，将这些代码包装在 for 循环中是一个明智的做法(我将在下一篇文章中介绍)。带有 GUI 界面的图表生成器很棒，但通常不擅长自动化任务。Python 很好。</li><li id="ae82" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated"><strong class="ka ir">不需要设计技能</strong>——嗯，几乎不需要设计技能。好的数据设计的眼光是有帮助的。但不需要 Adobe Illustrator 或 Photoshop 技能。</li></ul><p id="d2c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好，我们开始吧。这是你需要的。我用一个 Jupyter 笔记本来存放所有的代码(我强烈推荐，这样你就可以预览渲染)，但是你可以。</p><ul class=""><li id="26f6" class="lg lh iq ka b kb kc kf kg kj li kn lj kr lk kv ll lm ln lo bi translated">熊猫</li><li id="786f" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated">地质公园</li><li id="f6b1" class="lg lh iq ka b kb lp kf lq kj lr kn ls kr lt kv ll lm ln lo bi translated">Matplotlib</li></ul><p id="598f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！</p><h1 id="5603" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated"><strong class="ak">获取数据</strong></h1><p id="3c74" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">让我们把一些数据记在笔记本上。由于我目前住在伦敦，我将按地方选区(自治区级)制作伦敦地图。伦敦数据存储在使大量数据公开和可访问方面做得很好，我发现这个页面有一堆不同详细程度的形状文件。不错！</p><p id="00d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击→下载→另存为→移动到笔记本本地目录。搞定了。</p><p id="7803" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是 shapefile 只是一层数据。这将有助于绘制地图，但如果我们想将数据绑定到它，我们还需要另一个数据集。回到伦敦数据存储:让我们下载<a class="ae kw" href="https://data.london.gov.uk/dataset/london-borough-profiles" rel="noopener ugc nofollow" target="_blank">伦敦自治市档案数据集</a>作为 csv 文件(已经预先清理干净)。这个 csv 文件有很多列，我们可以用它们作为变量来可视化。</p><p id="edd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在两个数据集都准备好了，我又回到了我的 Jupyter 笔记本上。是时候载入了。shp 和。csv 文件。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="422b" class="nc lv iq my b gy nd ne l nf ng"># set the filepath and load in a shapefile</span><span id="edc9" class="nc lv iq my b gy nh ne l nf ng">fp = “datasets/geo-data/gis-boundaries-london/ESRI/London_Borough_Excluding_MHW.shp”</span><span id="7e5c" class="nc lv iq my b gy nh ne l nf ng">map_df = gpd.read_file(fp)</span><span id="e6cd" class="nc lv iq my b gy nh ne l nf ng"># check data type so we can see that this is not a normal dataframe, but a GEOdataframe</span><span id="d83e" class="nc lv iq my b gy nh ne l nf ng">map_df.head()</span></pre><p id="6885" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们预览一下没有数据的地图是什么样子。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="9a99" class="nc lv iq my b gy nd ne l nf ng">map_df.plot()</span></pre><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/472c8ed5448ba7b9a6ca14da87234405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kplxPr9KuUdtnfI0S4EIag.png"/></div></div></figure><p id="9bc4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">酷，是伦敦！</p><p id="d538" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们加载一个 csv 数据文件来连接地理数据框架。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="130d" class="nc lv iq my b gy nd ne l nf ng">df = pd.read_csv(“datasets/london-borough-profile.csv”, header=0)</span><span id="ba81" class="nc lv iq my b gy nh ne l nf ng">df.head()</span></pre><h1 id="50dc" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated"><strong class="ak">清洗和连接数据框</strong></h1><p id="77de" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">太好了。现在我们有两个数据帧准备好了。让我们获取一份我们将要使用的数据。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="a606" class="nc lv iq my b gy nd ne l nf ng">df = df[[‘borough’,’Happiness_score_2011–14_(out_of_10)’, ‘Anxiety_score_2011–14_(out_of_10)’, ‘Population_density_(per_hectare)_2017’, ‘Mortality_rate_from_causes_considered_preventable_2012/14’]]</span></pre><p id="ec11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些列名真的很糟糕。让我们将它们重命名为更简单的名称。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="4b5b" class="nc lv iq my b gy nd ne l nf ng">data_for_map = df.rename(index=str, columns={“Happiness_score_2011–14_(out_of_10)”: “happiness”,</span><span id="94ff" class="nc lv iq my b gy nh ne l nf ng">“Anxiety_score_2011–14_(out_of_10)”: “anxiety”,</span><span id="6815" class="nc lv iq my b gy nh ne l nf ng">“Population_density_(per_hectare)_2017”: “pop_density_per_hectare”,</span><span id="9271" class="nc lv iq my b gy nh ne l nf ng">“Mortality_rate_from_causes_considered_preventable_2012/14”: ‘mortality’})</span><span id="de06" class="nc lv iq my b gy nh ne l nf ng"># check dat dataframe</span><span id="4ce7" class="nc lv iq my b gy nh ne l nf ng">data_for_map.head()</span></pre><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/a2498f5bbf3cf645d06b69c2e193bd9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S_1R9OvGOI9SvEchrNPBoQ.png"/></div></div></figure><p id="cce8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好多了。现在，我们需要将地理数据与清理后的伦敦数据集合并。我们将使用 pd.join()来实现这一点。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="d153" class="nc lv iq my b gy nd ne l nf ng"># join the geodataframe with the cleaned up csv dataframe</span><span id="fb55" class="nc lv iq my b gy nh ne l nf ng">merged = map_df.set_index(‘NAME’).join(data_for_map.set_index(‘borough’))</span><span id="9c9c" class="nc lv iq my b gy nh ne l nf ng">merged.head()</span></pre><h1 id="d2fb" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated"><strong class="ak">地图时间！</strong></h1><p id="e32b" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">开始贴图吧。首先我们需要为 Matplotlib 做一些准备工作。我们首先将一个变量设置为 map，设置范围并为要绘制的地图创建图形。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="c784" class="nc lv iq my b gy nd ne l nf ng"># set a variable that will call whatever column we want to visualise on the map</span><span id="0ca5" class="nc lv iq my b gy nh ne l nf ng">variable = ‘pop_density_per_hectare’</span><span id="3aa5" class="nc lv iq my b gy nh ne l nf ng"># set the range for the choropleth</span><span id="fbb7" class="nc lv iq my b gy nh ne l nf ng">vmin, vmax = 120, 220</span><span id="3107" class="nc lv iq my b gy nh ne l nf ng"># create figure and axes for Matplotlib</span><span id="743a" class="nc lv iq my b gy nh ne l nf ng">fig, ax = plt.subplots(1, figsize=(10, 6))</span></pre><p id="9548" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">舞台已经搭好了。地图时间。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="512a" class="nc lv iq my b gy nd ne l nf ng"># create map</span><span id="5dca" class="nc lv iq my b gy nh ne l nf ng">merged.plot(column=variable, cmap=’Blues’, linewidth=0.8, ax=ax, edgecolor=’0.8')</span></pre><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/5cb760fcb8af23b05cea98eba48abbc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ma9YWau9YTFltmxyzgoGKw.png"/></div></div></figure><p id="86a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就在那里！不完美。有点扭曲，有一个奇怪的轴围绕着整个东西，这并不意味着什么。但是我们有一个 choropleth。现在让我们做一些美化，让它看起来新鲜。</p><h1 id="ae20" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated"><strong class="ak">定制地图</strong></h1><p id="d64b" class="pw-post-body-paragraph jy jz iq ka b kb ms kd ke kf mt kh ki kj mu kl km kn mv kp kq kr mw kt ku kv ij bi translated">首先，那个轴心需要被移除。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="5893" class="nc lv iq my b gy nd ne l nf ng"># remove the axis</span><span id="2df9" class="nc lv iq my b gy nh ne l nf ng">ax.axis(‘off’)</span></pre><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/db45eaefedb9ea665ff4c966087aea58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZPRpLZVJd_P9PeCeR5ogEA.png"/></div></div></figure><p id="a0d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，让我们添加一个标题到我们的地图，和一些说明来源的文字。地图通常看起来很好，但是如果你不提供背景信息，它就没有多大意义。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="0cfd" class="nc lv iq my b gy nd ne l nf ng"># add a title</span><span id="25ba" class="nc lv iq my b gy nh ne l nf ng">ax.set_title(‘Preventable death rate in London’, fontdict={‘fontsize’: ‘25’, ‘fontweight’ : ‘3’})</span><span id="5b34" class="nc lv iq my b gy nh ne l nf ng"># create an annotation for the data source</span><span id="5eaa" class="nc lv iq my b gy nh ne l nf ng">ax.annotate(‘Source: London Datastore, 2014’,xy=(0.1, .08),  xycoords=’figure fraction’, horizontalalignment=’left’, verticalalignment=’top’, fontsize=12, color=’#555555')</span></pre><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/14a2ab12d2040db732e5b6659497abcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mUx_0YKjlX73PyfYfSfZCg.png"/></div></div></figure><p id="205c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">漂亮！但是还缺少一样东西。我们可能应该添加一个图例，为用户显示值的范围。这将有助于它看起来不那么压扁。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="0aa3" class="nc lv iq my b gy nd ne l nf ng"># Create colorbar as a legend</span><span id="4082" class="nc lv iq my b gy nh ne l nf ng">sm = plt.cm.ScalarMappable(cmap=’Blues’, norm=plt.Normalize(vmin=vmin, vmax=vmax))</span><span id="7dcd" class="nc lv iq my b gy nh ne l nf ng"># empty array for the data range</span><span id="cccb" class="nc lv iq my b gy nh ne l nf ng">sm._A = []</span><span id="3f37" class="nc lv iq my b gy nh ne l nf ng"># add the colorbar to the figure</span><span id="ec31" class="nc lv iq my b gy nh ne l nf ng">cbar = fig.colorbar(sm)</span></pre><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kx"><img src="../Images/93b3ee4a7c9b3746f52be5bdf2d6766c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*abd6Vjl2b63X3G8GcUekxQ.png"/></div></div></figure><p id="151a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">地图。制造。</p><p id="abb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一件事:我们需要保存地图，这样我们就可以发布一条带有#dataviz 标签的 tweet。</p><p id="7e6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Matplotlib 在如何保存数据方面给了你很多自由。下面的代码将图片保存为 png 格式，但是如果你想在 Illustrator 中对它进行更多的修改，你也可以保存为 svg 格式。如果保存为 png，请确保使用 200 或更高的 dpi。否则地图和文字看起来会很模糊。没人想这样。</p><pre class="ky kz la lb gt mx my mz na aw nb bi"><span id="6041" class="nc lv iq my b gy nd ne l nf ng">fig.savefig(“map_export.png”, dpi=300)</span></pre><p id="5d7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们的工作目录中已经有了一份可以发布的地图！太神奇了。</p><p id="6e3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">原来如此。您已经设置好了 Geopandas(至少对于 choropleths 是这样)。接下来，我将看看如何使用 Geopandas 制作多个地图，并将其转换成一个很酷的 gif 地图。敬请期待！</p><p id="ce6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在 Github 上查看并下载我的 Jupyter 笔记本。</p></div></div>    
</body>
</html>