<html>
<head>
<title>Forecasting with Python and Tableau</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 和 Tableau 进行预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/forecasting-with-python-and-tableau-dd37a218a1e5?source=collection_archive---------1-----------------------#2018-08-12">https://towardsdatascience.com/forecasting-with-python-and-tableau-dd37a218a1e5?source=collection_archive---------1-----------------------#2018-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ccb05b343288e5c9cfb3071025b9f173.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IALnkfKYsppzPHZDaPxgxQ.jpeg"/></div></div></figure><p id="8265" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我写了一本关于脸书先知的书，已经由 Packt 出版社出版了！这本书在<a class="ae kw" href="https://amzn.to/373oIcf" rel="noopener ugc nofollow" target="_blank">亚马逊</a>上有售。</p><p id="9ced" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这本书涵盖了使用 Prophet 的每个细节，从安装到模型评估和调整。十几个数据集已经可用，并用于演示 Prophet 功能，从简单到高级，代码完全可用。如果你喜欢这篇中帖，请考虑在这里订购:【https://amzn.to/373oIcf】T4！在超过 250 页的篇幅中，它涵盖的内容远远超过了媒体所能教授的内容！</p><p id="9cf4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">非常感谢你支持我的书！</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="f347" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我是 Greg Rafferty，湾区的数据科学家。你可以在我的<a class="ae kw" href="https://github.com/raffg/air-passengers-arima" rel="noopener ugc nofollow" target="_blank"> github </a>上查看这个项目的代码。如有任何问题，请随时联系我！</p><p id="1243" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我将展示如何在 Tableau 中使用 Python 代码来构建一个实现时间序列预测的交互式仪表板。如果你只是想先玩一下仪表盘，探索一下 SARIMAX 算法，请在这里下载完整的 python 实现的仪表盘<a class="ae kw" href="https://github.com/raffg/air-passengers-arima/blob/master/sarimax.twbx" rel="noopener ugc nofollow" target="_blank">，或者在</a><a class="ae kw" href="https://public.tableau.com/profile/greg4084#!/vizhome/sarimaxmodel/SARIMAXdashboard" rel="noopener ugc nofollow" target="_blank"> Tableau Public </a>上下载这个稍微有点笨的版本(Tableau Public 明智但令人失望地不允许上传外部脚本，所以我不得不用硬编码的数据集来伪造 Python 脚本)。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="899b" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">因为当你想不出一个好名字的时候，试试一个旅行箱</h1><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mc"><img src="../Images/c0046c28ad3662f095d4e6dbf37e0286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7SYyv5SyAuvuFlV8LzHBag.png"/></div></div></figure><p id="8238" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">去年，Tableau 发布了 10.2 版本，其中包括与 Python 的集成。不过，如何使用它并不是非常简单，所以当一个客户要求一个时间序列预测仪表板时，我想我会弄清楚的。<a class="ae kw" href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average" rel="noopener ugc nofollow" target="_blank"> ARIMA </a>模型没有内置到 Tableau 中(Tableau 的<a class="ae kw" href="https://onlinehelp.tableau.com/current/pro/desktop/en-us/forecast_create.html" rel="noopener ugc nofollow" target="_blank">预测</a>模块使用<a class="ae kw" href="https://en.wikipedia.org/wiki/Exponential_smoothing" rel="noopener ugc nofollow" target="_blank">指数平滑</a>，在这种特殊情况下，我确实需要使用 ARIMA 算法的更高预测能力，所以<a class="ae kw" href="https://github.com/tableau/TabPy" rel="noopener ugc nofollow" target="_blank">tabby</a>似乎是我唯一的选择。</p><p id="cbf7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我不会详细介绍如何安装 TabPy(提示:<code class="fe mh mi mj mk b">pip install tabpy-server</code>)，也不会详细介绍如何安装 Python(我想，如果你想在 Tableau 中运行 Python 代码，你可能已经知道如何使用 Python 了。如果没有，<a class="ae kw" href="https://www.python.org/about/gettingstarted/" rel="noopener ugc nofollow" target="_blank">从这里开始</a>。)</p><p id="c815" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦安装了 TabPy 发行版，您将需要导航到包含在<em class="ml"> /site-packages </em>中的源代码，然后进入 tabpy-server 目录(在我的例子中，是在默认位置安装了 Anaconda 3 的 MacOS 上，<code class="fe mh mi mj mk b">/anaconda3/lib/python3.7/site-packages/tabpy_server</code>)。从那里运行<code class="fe mh mi mj mk b">sh startup.sh</code>或<code class="fe mh mi mj mk b">python tabpy.py</code>来启动服务器。您需要指示 Tableau 不断地嗅探端口 9004，这是 Tableau 和 Python 的通信方式。为了做到这一点，在 Tableau 内部，</p><ol class=""><li id="4696" class="mm mn iq ka b kb kc kf kg kj mo kn mp kr mq kv mr ms mt mu bi translated">转到帮助→设置和性能→管理外部服务连接…</li><li id="4e28" class="mm mn iq ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated">输入服务器(如果在同一台计算机上运行 TabPy，则为 localhost)和端口(默认为 9004)。</li></ol><figure class="md me mf mg gt jr gh gi paragraph-image"><div class="gh gi na"><img src="../Images/84cb26bbb9de2aa17377959381f87e5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*FpDf2u-XyqaUApE05_bXbA.png"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk">And you’re off to the races!</figcaption></figure><p id="ffde" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果到目前为止你有任何困难，试试这个教程。</p><h1 id="f265" class="le lf iq bd lg lh nf lj lk ll ng ln lo lp nh lr ls lt ni lv lw lx nj lz ma mb bi translated">ARIMA:如果你的公文包听起来笨重，那就用首字母缩略词</h1><p id="b393" class="pw-post-body-paragraph jy jz iq ka b kb nk kd ke kf nl kh ki kj nm kl km kn nn kp kq kr no kt ku kv ij bi translated">ARIMA 代表一个独立的整体平均值。在本教程中，我使用了它的更高级的兄弟，SARIMAX(<strong class="ka ir">S</strong>easonal<strong class="ka ir">A</strong>uto-<strong class="ka ir">R</strong>egressive<strong class="ka ir">I</strong>integrated<strong class="ka ir">M</strong>oving<strong class="ka ir">A</strong>average with e<strong class="ka ir">X</strong>ogen 回归变量)。好吧，那是什么？</p><p id="40b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">先从<a class="ae kw" href="https://en.wikipedia.org/wiki/Regression_analysis" rel="noopener ugc nofollow" target="_blank">回归</a>说起。你知道那是什么，对吧？基本上，给定一组点，它会计算出最能解释图案的直线。</p><p id="19c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来是 ARMA 模型(自回归移动平均)。自回归部分意味着它是一个基于以前的值预测未来值的回归模型。这类似于说明天会很暖和，因为前三天都很暖和。(附注:这就是时间序列模型比标准回归复杂得多的原因。数据点不是相互独立的！).均线部分其实根本不是均线(别问我为什么，我也不知道)。这仅仅意味着回归误差可以建模为误差的线性组合。</p><p id="8722" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果 ARMA 模型不太符合你的数据，你可以试试 ARIMA。额外的 I 代表集成。这个术语解释了先前值之间的差异。直觉上，这意味着明天很可能和今天一样的温度，因为过去一周没有太大变化。</p><p id="8090" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们转到萨里马克斯。S 代表季节性-它有助于对重复模式进行建模。这些季节性模式本身并不一定每年都会发生；例如，如果我们在一个繁忙的城市地区模拟地铁交通，模式将每周重复一次。而 X 代表外源性的(抱歉。这个不是我想出来的)。这个术语允许将外部变量添加到模型中，比如天气预报(尽管我在本教程中的模型没有添加任何外部变量)。</p><p id="9abc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一个<a class="ae kw" href="https://www.statsmodels.org/dev/generated/statsmodels.tsa.statespace.sarimax.SARIMAX.html" rel="noopener ugc nofollow" target="_blank"> SARIMAX </a>模型采用 SARIMAX(p，D，q) x (P，D，Q)m 的形式，其中 P 是 AR 项，D 是 I 项，Q 是 MA 项。大写的 P、D 和 Q 是相同的术语，但与季节成分有关。小写的 m 是模式重复之前的季节周期数(因此，如果您正在处理月度数据，就像在本教程中一样，m 将是 12)。在实现时，这些参数都是整数，数字越小越好(即不太复杂)。对于我的模型，我选择的最适合模型的参数是 SARIMAX(2，1，2) x (0，2，2)12。</p><p id="d991" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我进行了网格搜索以得出这些术语。我试图最小化的错误是<a class="ae kw" href="https://en.wikipedia.org/wiki/Akaike_information_criterion" rel="noopener ugc nofollow" target="_blank">赤池信息标准</a> (AIC)。AIC 是一种衡量模型与数据拟合程度的方法，同时降低了复杂性。在 Tableau 仪表板中，我报告均方误差，因为这更直观。</p><p id="11a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样一来，让我们看看如何在 Tableau 中实现它！</p><h1 id="f835" class="le lf iq bd lg lh nf lj lk ll ng ln lo lp nh lr ls lt ni lv lw lx nj lz ma mb bi translated">航空乘客数据</h1><p id="24e4" class="pw-post-body-paragraph jy jz iq ka b kb nk kd ke kf nl kh ki kj nm kl km kn nn kp kq kr no kt ku kv ij bi translated">如果你想跟进，你可以在我的 github 上下载<a class="ae kw" href="https://github.com/raffg/air-passengers-arima/blob/master/sarimax.twbx" rel="noopener ugc nofollow" target="_blank">打包的 Tableau 工作簿</a>。我使用的是航空乘客数据集(<a class="ae kw" href="https://www.kaggle.com/rakannimer/air-passengers" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/rakannimer/air-passengers</a>)，其中包含了 1949 年至 1961 年间航空乘客数量的月度数据。让我们来看看发生了什么:</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="9cb2" class="le lf iq bd lg lh nf lj lk ll ng ln lo lp nh lr ls lt ni lv lw lx nj lz ma mb bi translated">（舞台上由人扮的）静态画面</h1><p id="ea17" class="pw-post-body-paragraph jy jz iq ka b kb nk kd ke kf nl kh ki kj nm kl km kn nn kp kq kr no kt ku kv ij bi translated">我希望我的仪表板是完全交互式的，这样我可以更改所有的 p、d 和 q，同时观察它们对模型的影响。因此，首先(这里的“第一”，我指的是“第二，在您连接到上面链接的航空乘客数据集之后”)，让我们为这些变量创建参数。</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/ee8c49b6628bf538cac431b86ab46f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJXz1ILT1L_wemBOdXudzw.png"/></div></div></figure><p id="afe8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你需要创建 8 个参数:<em class="ml"> AR(时滞)</em>、<em class="ml"> I(季节性)</em>、<em class="ml"> MA(移动平均线)</em>、<em class="ml">月预测</em>、<em class="ml">期</em>、<em class="ml">季节性 AR(时滞)</em>、<em class="ml">季节性 I(季节性)</em>、<em class="ml">季节性 MA(移动平均线)</em>。确保所有的数据类型都是整数，否则 Python 稍后会抛出一些错误(并且 TabPy 非常无益地拒绝为您提供错误行号)。对于<em class="ml">月预测</em>和<em class="ml">期间</em>，我使用了一个允许值范围，从 1 到 48(对于<em class="ml">月预测</em>)和 1 到 24(对于<em class="ml">期间</em>)。接下来我们需要创建一个名为<em class="ml">预测日期</em>的计算字段，这样 Tableau 将扩展 x 轴以包含预测值。在计算字段中，输入:</p><pre class="md me mf mg gt ns mk nt nu aw nv bi"><span id="19c8" class="nw lf iq mk b gy nx ny l nz oa">DATE(DATETRUNC('month', DATEADD('month', [Months Forecast], [Month])))</span></pre><p id="d6eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还将创建一个<em class="ml">乘客数量</em>计算字段，以确保我们的 SARIMAX 数据与实际数据相符:</p><pre class="md me mf mg gt ns mk nt nu aw nv bi"><span id="a7c9" class="nw lf iq mk b gy nx ny l nz oa">LOOKUP(SUM([#Passengers]), [Months Forecast])</span></pre><p id="c0a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，还有一个名为<em class="ml">过去与未来</em>的计算字段，我们稍后将使用它将预测格式化为不同的颜色:</p><pre class="md me mf mg gt ns mk nt nu aw nv bi"><span id="2af9" class="nw lf iq mk b gy nx ny l nz oa">IF LAST() &lt; [Months Forecast]<br/>THEN 'Model Forecast'<br/>ELSE 'Model Prediction'<br/>END</span></pre><h1 id="cd23" class="le lf iq bd lg lh nf lj lk ll ng ln lo lp nh lr ls lt ni lv lw lx nj lz ma mb bi translated">计算机编程语言</h1><p id="6130" class="pw-post-body-paragraph jy jz iq ka b kb nk kd ke kf nl kh ki kj nm kl km kn nn kp kq kr no kt ku kv ij bi translated">好了，终于！在蟒蛇身上。让我们创建我们的第一个脚本。创建一个计算字段并将其命名为<em class="ml">预测</em>。在字段中，粘贴以下代码:</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="87d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还将创建一个名为均方误差的计算字段，这样我们就可以在图表上有一个漂亮的动态标题:</p><figure class="md me mf mg gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="3d02" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，将<em class="ml">预测日期</em>拖到列架上，将<em class="ml">乘客数量</em>和<em class="ml">预测</em>拖到列架上。使其成为双轴图表，并使轴同步。将<em class="ml">过去与未来</em>放在<em class="ml">预测</em>卡的色标上，就大功告成了！那很容易，不是吗？(不，实际上不是。令人尴尬的是，我花了很长时间才弄明白如何让这些脚本工作，而且 Tableau 极其<em class="ml">无益的</em>不显示错误发生在哪里的习惯使得故障排除成为一项令人沮丧的工作。为了增加一点趣味，将这些参数添加到侧栏中，这样您就可以交互地更改它们。哦！我差点忘了那个时髦的标题。右键单击标题→编辑标题… →并键入以下代码:</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/7361c562e3e0263652ee5502631b84b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aAb3t-qxQqoo4zSlR6vqAw.png"/></div></div></figure><p id="e43a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是最终的仪表板应该是什么样子。如果你想让它看起来和我的一样，你会有一些格式化任务要处理，或者你可以下载我的仪表板<a class="ae kw" href="https://github.com/raffg/air-passengers-arima/blob/master/sarimax.twbx" rel="noopener ugc nofollow" target="_blank">在这里</a>并完成它。Tableau Public 不允许上传任何外部脚本，很遗憾，这意味着我不能分享如下所示的确切版本。相反，我只是运行了数百个 SARIMAX 参数的排列，并将每个预测保存到一个 csv 文件中，这个版本虽然没有那么漂亮，也没有那么酷，但可以直接在 Tableau Public <a class="ae kw" href="https://public.tableau.com/profile/greg4084#!/vizhome/sarimaxmodel/SARIMAXdashboard" rel="noopener ugc nofollow" target="_blank">这里</a>上玩。</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/a47faa962664792b18844a19264b9c28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oMeyD0Mwfy5WfnUj7FB9AQ.png"/></div></div></figure><p id="1d25" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如你所见，模型相当不错！这就是 SARIMAX 的强大之处:它准确地模拟了随着时间推移的总体增长趋势，全年季节的起伏，甚至是随着时间的推移数据的增长方差(波峰高点和波谷低点之间的距离增加)。你需要小心选择你的参数，如果你不小心，一些有趣的事情会发生。例如，我表现最差的模型是这样的(看看这个误差幅度！):</p><figure class="md me mf mg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/059e559425eea90a9ea61fff5f2e4efc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5uGNVVJpW4teBGdXoXOkiw.png"/></div></div></figure></div></div>    
</body>
</html>