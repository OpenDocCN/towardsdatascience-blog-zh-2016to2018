<html>
<head>
<title>How to train a Tensorflow face object detection model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何训练一个Tensorflow人脸对象检测模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-train-a-tensorflow-face-object-detection-model-3599dcd0c26f?source=collection_archive---------2-----------------------#2017-09-26">https://towardsdatascience.com/how-to-train-a-tensorflow-face-object-detection-model-3599dcd0c26f?source=collection_archive---------2-----------------------#2017-09-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="17f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">人工智能使得分析图像成为可能。在这篇博文中，我将着重于用定制的类来训练一个对象检测器。你要做的第一件事是设置。在<a class="ae kl" href="https://github.com/tensorflow/models/blob/4f32535fe7040bb1e429ad0e3c948a492a89482d/research/object_detection/g3doc/installation.md" rel="noopener ugc nofollow" target="_blank"> Tensorflow文档</a>中写了如何在本地机器上设置。我们将使用Tensorflow对象检测来训练实时对象识别应用程序。<a class="ae kl" href="https://github.com/qdraw/tensorflow-face-object-detector-tutorial" rel="noopener ugc nofollow" target="_blank">训练好的模型在这个库中可用</a></p><p id="bfbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="km">这是一个翻译的'</em><a class="ae kl" href="https://qdraw.nl/blog/design/train-een-tensorflow-gezicht-object-detectie-model/" rel="noopener ugc nofollow" target="_blank"><em class="km">Train een tensor flow gezi cht object detectie model</em></a><em class="km">和</em><a class="ae kl" href="https://medium.com/@qdraw/objectherkenning-met-de-computer-vision-library-tensorflow-fc88efe1f35a" rel="noopener"><em class="km">Objectherkenning meet de计算机视觉库Tensorflow </em> </a></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/054cc29a458845932c83cc41e6dc9b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0uv9F1JSNPQieOogdFKsQ.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk"><em class="ld">MS COCO Tensorflow Nürburgring example (own picture)</em></figcaption></figure><h1 id="a429" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">OpenCV</h1><p id="d1f1" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">你可以在Ubuntu上的<em class="km"> /usr/local中自动安装OpenCV。</em>用下面的脚本。该脚本安装OpenCV 3.2并与Ubuntu 16.04一起工作。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="cd77" class="mm lf iq mi b gy mn mo l mp mq">$ curl -L <a class="ae kl" href="https://raw.githubusercontent.com/qdraw/tensorflow-object-detection-tutorial/master/install.opencv.ubuntu.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/qdraw/tensorflow-object-detection-tutorial/master/install.opencv.ubuntu.sh</a> | bash</span></pre><p id="7837" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的Mac上，我使用OpenCV 3.3.0 en Python 2.7.13。我在OpenCV 3.2和3.3中试过，但是在Python 3.6中失败了。然而，在Ubuntu Linux上，这种组合确实有效。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="623e" class="mm lf iq mi b gy mn mo l mp mq">$ brew install homebrew/science/opencv</span></pre><h1 id="40f9" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">“超薄”和对象检测模块的设置</h1><p id="497d" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">第一步是克隆Tensorflow-models存储库。在本教程中，我们只使用了<em class="km"> slim </em>和<em class="km"> object_detection </em>模块。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="8361" class="mm lf iq mi b gy mn mo l mp mq">$ nano .profile</span><span id="8c3f" class="mm lf iq mi b gy mr mo l mp mq">export PYTHONPATH=$PYTHONPATH:/home/dion/models/research:/home/dion/models/research/slim</span></pre><p id="20df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还需要编译protobuf库</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="4d84" class="mm lf iq mi b gy mn mo l mp mq">$ protoc object_detection/protos/*.proto --python_out=.</span></pre><h1 id="195f" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">克隆教程存储库并安装依赖项</h1><p id="672c" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">示例代码可在<em class="km">tensor flow-face-object-detector-tutorial</em>资源库中找到。你可以克隆这个回购。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="e3d9" class="mm lf iq mi b gy mn mo l mp mq">$ git clone <a class="ae kl" href="https://github.com/qdraw/tensorflow-face-object-detector-tutorial.git" rel="noopener ugc nofollow" target="_blank">https://github.com/qdraw/tensorflow-face-object-detector-tutorial.git</a></span></pre><p id="87cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">转到子文件夹:</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="4193" class="mm lf iq mi b gy mn mo l mp mq"> $ cd tensorflow-face-object-detector-tutorial/</span></pre><p id="1c06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用PIP安装依赖项:我使用Python 3.6，OpenCV使用Python绑定安装。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="e566" class="mm lf iq mi b gy mn mo l mp mq">$ pip install -r requirements.txt</span></pre><h1 id="eea8" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">下载培训和验证数据</h1><p id="0cd8" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">香港中文大学有一个庞大的标签图像数据集。较宽的人脸数据集是人脸检测基准数据集。我已经使用了标签来显示边界框。所选文本是面标注。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/ce7e10af613970750fae36ac7842156d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yiF1gDhK47EaKwPdVSPfBw.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk"><em class="ld">WIDER example using labelImg (credits: </em><a class="ae kl" href="http://mmlab.ie.cuhk.edu.hk/projects/WIDERFace/)" rel="noopener ugc nofollow" target="_blank"><em class="ld">http://mmlab.ie.cuhk.edu.hk/projects/WIDERFace/)</em></a></figcaption></figure><p id="a7d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">脚本<em class="km"> 001_down_data.py </em>将用于下载<a class="ae kl" href="http://mmlab.ie.cuhk.edu.hk/projects/WIDERFace/" rel="noopener ugc nofollow" target="_blank"> WIDERFace </a>和<a class="ae kl" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/detection_model_zoo.md" rel="noopener ugc nofollow" target="_blank">SSD _ mobilenet _ v1 _ coco _ 11 _ 06 _ 2017</a>。我将使用预训练模型来加快训练时间。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="9eb7" class="mm lf iq mi b gy mn mo l mp mq">$ python 001_down_data.py</span></pre><h1 id="d589" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">将WIDERFace转换为Pascal XML</h1><p id="4377" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">首先，我们需要将数据集转换成Pascal XML。Tensorflow和labelImg使用不同的格式。图像被下载到<em class="km"> WIDER_train </em>文件夹中。使用<em class="km">002 _ data-to-Pascal-XML . py</em>我们转换宽面数据并将其复制到不同的子文件夹。我的电脑处理9263张图片需要5分钟。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="d9ee" class="mm lf iq mi b gy mn mo l mp mq">$ python 002_data-to-pascal-xml.py</span></pre><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/ddcfa15927524c505f465a6ddefe6039.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iozsrjrmUJeUriBDbIeahg.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk"><em class="ld">From the dataset WIDERFace and the film Marching Band (2009) with XML and LabelImg interface.</em></figcaption></figure><h1 id="6a05" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Pascal XML到Tensorflow CSV索引</h1><p id="4159" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">当数据被转换成Pascal XML时，就会创建一个索引。通过训练和验证数据集，我们使用这些文件作为输入来生成TFRecords。但是，也可以使用labelImg之类的工具手动标记图像，并使用此步骤在此创建索引。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="17cd" class="mm lf iq mi b gy mn mo l mp mq">$ python 003_xml-to-csv.py</span></pre><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/6ad79d08a4b82238839b9092878d3a89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XuMNcLHamGnY3qAslxeJGw.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk"><em class="ld">Excel and OS X Finder with list of files</em></figcaption></figure><h1 id="4445" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建TFRecord文件</h1><p id="b6ac" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">TFRecords文件是一个很大的二进制文件，可以读取它来训练机器学习模型。在下一步中，Tensorflow将顺序读取该文件。训练和验证数据将被转换为二进制文件。</p><p id="0c9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">训练数据到TFRecord (847.6 MB) </strong></p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="2bd2" class="mm lf iq mi b gy mn mo l mp mq">$ python 004_generate_tfrecord.py --images_path=data/tf_wider_train/images --csv_input=data/tf_wider_train/train.csv  --output_path=data/train.record</span></pre><p id="b37d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">验证数据到TFRecord (213.1MB) </strong></p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="c55a" class="mm lf iq mi b gy mn mo l mp mq">$ python 004_generate_tfrecord.py --images_path=data/tf_wider_val/images --csv_input=data/tf_wider_val/val.csv  --output_path=data/val.record</span></pre><h1 id="a4de" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置配置文件</h1><p id="2987" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">在储存库中，<em class="km">SSD _ mobilenet _ v1 _ face . config</em>是用于训练人工神经网络的配置文件。这个文件基于一个pet探测器。</p><p id="13fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，<em class="km"> num_classes </em>的数量保持为1，因为只有面部会被识别。</p><p id="1e03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">变量<em class="km"> fine_tune_checkpoint </em>用于指示获取学习的前一模型的路径。这个位置将适合你在这个文件。微调检查点文件用于应用迁移学习。迁移学习是机器学习中的一种方法，专注于将从一个问题获得的知识应用到另一个问题。</p><p id="a5bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在类<em class="km"> train_input_reader </em>中，与用于训练模型的TFRecord文件建立链接。在配置文件中，您需要将其定制到正确的位置。</p><p id="28cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">变量<em class="km"> label_map_path </em>包含索引id和名称。在这个文件中，零被用作占位符，所以我们从1开始。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="d26a" class="mm lf iq mi b gy mn mo l mp mq">item {<br/>  id: 1<br/>  name: 'face'<br/>}</span></pre><p id="8326" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于验证，两个变量很重要。类<em class="km"> eval_config </em>中的变量<em class="km"> num_examples </em>用于设置示例的数量。<br/>T5<em class="km">eval _ input _ reader</em>类描述了验证数据的位置。这个位置也有一条小路。<br/> <br/>此外，还可以更改学习率、批量和其他设置。目前，我保留了默认设置。</p><h1 id="c052" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">让我们训练；)</h1><p id="de06" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">现在要开始真正的工作了。计算机将从数据集中学习，并在这里建立一个神经网络。由于我在CPU上模拟火车，这将需要几天才能得到一个好的结果。有了强大的Nvidia显卡，这是有可能缩短到几个小时。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="9bfe" class="mm lf iq mi b gy mn mo l mp mq">$ python ~/tensorflow_models/object_detection/train.py --logtostderr --pipeline_config_path=ssd_mobilenet_v1_face.config  --train_dir=model_output</span></pre><p id="05d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Tensorboard让我们深入了解学习过程。该工具是Tensorflow的一部分，是自动安装的。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="c492" class="mm lf iq mi b gy mn mo l mp mq">$ tensorboard --logdir= model_output</span></pre><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/22c1e5c0dc19613d63f428a201f901d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rXzJawdUpMLqLGQepI4w6g.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk"><em class="ld">Tensorflow Tensorboard TotalLoss</em></figcaption></figure><h1 id="166d" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">将检查点转换为protobuf</h1><p id="2854" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">通过计算机视觉库Tensorflow在对象识别中使用该模型。下面的命令提供了模型库和最后一个检查点的位置。文件夹folder将包含freezed _ inference _ graph . Pb。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="b020" class="mm lf iq mi b gy mn mo l mp mq">$ python ~/tensorflow_models/object_detection/export_inference_graph.py \<br/>--input_type image_tensor \<br/>--pipeline_config_path ssd_mobilenet_v1_face.config \<br/>--trained_checkpoint_prefix model_output/model.ckpt-12262 \<br/>--output_directory model/</span></pre><p id="0432" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">TL；DR；</strong> <br/>中的<em class="km">模型/冻结_推理_图形。</em>github知识库上的pb文件夹是一个人工神经网络的冻结模型。香港中文大学拥有广泛的研究面，该数据集已被用于训练模型。</p><h1 id="70d6" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">估价</h1><p id="149f" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">除了用于训练的数据之外，还有一个评估数据集。基于该评估数据集，可以计算准确度。对于我的模型，我计算了精度(平均精度)。我在14337步(epochs)时得到了83.80%的分数。对于这个过程，Tensorflow有一个脚本，可以在Tensorboard中看到分数。除了培训之外，建议您运行评估流程。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="812c" class="mm lf iq mi b gy mn mo l mp mq">python ~/tensorflow_models/object_detection/eval.py --logtostderr --pipeline_config_path=ssd_mobilenet_v1_face.config  --checkpoint_dir=model_output --eval_dir=eval</span></pre><p id="1bd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后你可以用Tensorboard监控这个过程。</p><pre class="ko kp kq kr gt mh mi mj mk aw ml bi"><span id="3323" class="mm lf iq mi b gy mn mo l mp mq">tensorboard --logdir=eval --port=6010</span></pre><h1 id="1428" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">冻结模型的结论和使用</h1><p id="6a62" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">训练人脸识别模型已经成为可能。冻结模型<em class="km">model/frozen _ inference _ graph . Pb</em>可以部署在例如<a class="ae kl" href="https://github.com/qdraw/tensorflow-object-detection-tutorial" rel="noopener ugc nofollow" target="_blank">具有计算机视觉库Tensorflow </a>的对象识别中。</p><p id="17dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">计算机视觉的世界应该让你感兴趣，但是你仍然不知道如何应用它，并且有必要的问题吗？给我发一封电子邮件，然后我们可以一起喝杯咖啡。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/a427014c6c26839a46d8118c5554bb77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*VA4WMMm9wnpjKIEnv3gzIg.gif"/></div><figcaption class="kz la gj gh gi lb lc bd b be z dk">Me and a cup of coffee</figcaption></figure><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/86cd0ec4f1263d1c4fbbe259dfe40adc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*La-9tKL57O9u5slv5CH27w.jpeg"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk">In this example, 43 faces are recognized. Source image: Ricardo Lago <a class="ae kl" href="https://www.flickr.com/photos/kruzul/4763629720/" rel="noopener ugc nofollow" target="_blank">https://www.flickr.com/photos/kruzul/4763629720/</a></figcaption></figure></div></div>    
</body>
</html>