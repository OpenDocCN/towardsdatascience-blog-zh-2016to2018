<html>
<head>
<title>Kaggle Planet Challenge: Solution Outline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">卡格尔星球挑战:解决方案概述</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/my-solution-to-kaggle-planet-challenge-fa554ec16c8c?source=collection_archive---------7-----------------------#2017-07-24">https://towardsdatascience.com/my-solution-to-kaggle-planet-challenge-fa554ec16c8c?source=collection_archive---------7-----------------------#2017-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6ae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个好的理由和一个浏览一些最令人惊叹的航拍照片的机会足以让我加入这个竞赛；当然，这也是一个尝试各种 convnet 架构的重要场所。</p><p id="628c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“每一分钟，世界都会失去 48 个足球场大小的森林面积。亚马逊盆地的森林砍伐占了最大的份额，导致了生物多样性减少、栖息地丧失、气候变化和其他灾难性影响。但是，关于森林砍伐和人类对森林的侵犯的位置的更好的数据可以帮助政府和当地利益相关者更快和更有效地做出反应。</p><p id="fb5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这场比赛中，Planet 和它的巴西合作伙伴 SCCON 正在挑战 Kagglers，以大气条件和各种土地覆盖/土地利用类别来标记卫星图像芯片。由此产生的算法将帮助全球社会更好地理解世界各地发生森林砍伐的地点、方式和原因，以及最终如何应对。"</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/e9c9e608bfbd442eaeb2f491edaa321a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wmbcz0hoVdByJSGl0P1jGA.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk"><em class="lb">A large city in the Amazon basin (from competition website)</em></figcaption></figure><p id="51f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里找到更多关于比赛的信息。</p><h2 id="8f52" class="ld le iq bd lf lg lh dn li lj lk dp ll jy lm ln lo kc lp lq lr kg ls lt lu lv bi translated"><strong class="ak">数据</strong></h2><p id="e639" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">大约 40k 个 255x255 jpeg 图片及其相应的带有 NIR 通道的 Tif 文件。测试集在 61k 左右，结构相同。<a class="ae lc" href="https://www.kaggle.com/c/planet-understanding-the-amazon-from-space/data" rel="noopener ugc nofollow" target="_blank">更多详情</a>。</p><p id="484d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">训练数据中的每个区块具有一个或多个类别标签，例如“多云”、“水”、“道路”等。</p><p id="2914" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">天气标签是互斥的，而其他标签可以一起出现在某个标签中。目标基本上是预测每个图块的类别标签。</p><h1 id="7638" class="mb le iq bd lf mc md me li mf mg mh ll mi mj mk lo ml mm mn lr mo mp mq lu mr bi translated">解决方案大纲</h1><p id="33b3" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我的解决方案的要点是微调和集成许多 convnet 架构:VGG、inception v3、resnet50 和 xception。其中，resnet50 运行得最好，因为它需要的运行时间相对较少，所以我花了大部分时间对它进行优化和微调。</p><p id="b88c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我从数据的小子集(50%)和非常小的照片(50x50)开始，以找到正确的建筑结构和参数搜索(例如，用于数据扩充)。最终的网络使用了 224x224 像素的 jpeg 图像。</p><p id="8a69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有趣的是，Tif 文件并没有帮助改善结果。起初，这听起来可能毫无启发性；例如，我们可以用 NIR“看穿”雾霾，并提供更准确的标记。一个常见的假设是，由于标记是由不能利用 NIR 通道的人类完成的，利用 NIR 通道实际上会使我们偏离那些“真正的标签”。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/dbf43e67523a4abee8dd1a6e6135ba15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cf5XyIfhUfoJWp8vvBHtIQ.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk"><em class="lb">An agricultural area that showing the end state of “fishbone” deforestation</em></figcaption></figure><p id="5df0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">网络架构</strong></p><p id="ec37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出:17 级输出，二进制日志丢失，adam 优化器。我尝试了几种变体；其中一个具有两种输出类型:用于天气类别的 4x 输出(softmax +分类交叉熵，因为天气标签是互斥的)和用于其他标签的 13x 二进制输出(sigmoid +二进制对数损失，因为它们可以同时出现)。</p><p id="ff88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，与统一的 17x 级输出相比，它们都给出了较差的 f2 分数。我甚至尝试了两种不同的天气和非天气网络，尽管精确度上升了，回忆下降了，这实际上伤害了对比赛很重要的 f2 分数。</p><p id="f949" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以<a class="ae lc" href="https://keras.io/applications/#resnet50" rel="noopener ugc nofollow" target="_blank"> Resnet50 </a>为例，我去掉了顶层，用大小为 1024 的隐藏层进行扩展，后面是大小为 17 的预测层。中途退出是为了避免过度适应。</p><p id="0192" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我开始以较高的学习速率(从 1e-3 一直到 1e-6)微调顶层，随着我在网络中的深入，在确保我不能从未冻结的层中榨取更多之后，不断解冻更多的 conv 块。我的最好成绩一直保持到 conv 50 分的 5a 区。</p><p id="0804" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">阈值处理</strong></p><p id="516c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了训练一个好的模型，找到合适的阈值在这场比赛中也很关键。基本上，预期的预测是类别标签，如“多云”或“道路”，而不是每个类别的概率。因此，您必须找到正确的阈值来决定某个预测的类别概率是否足够高，以分配该标签。我通过强力优化每个通道的阈值获得了最佳结果。</p><p id="2af0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简而言之，我在 0 到 0.99 的范围内搜索了每个类别的所有可能的阈值，以获得最佳 f2 验证集。进一步改进我的结果(~0.001)的是在验证集上进行 10 倍的数据扩充，并在进行阈值搜索之前取模型预测的平均值。</p><p id="f381" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">组装</strong></p><p id="c15e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于我使用的是相对较慢的 AWS 机器(p2.xlarge)，我负担不起为每个型号进行 k-folding。因此，对于每个模型，我留出 20%的数据作为验证集，并针对相应的训练/测试分割优化每个模型。每个模型还使用了不同的输入大小和非常细微的数据扩充差异。我相信这有助于增加合奏的多样性。做测试时间增加(TTA)也被证明是对每个模型的一个很好的促进，特别是因为我在基于 k 倍的方法中没有测试预测平均的优势。</p><p id="a364" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我根据每个模型的输出进行了“多数投票”。虽然我没有进行 k 折叠，因此不能进行堆叠，但我的结果与我的队友秦相当，他花了相当多的时间对每个模型进行 k 折叠和堆叠。</p><p id="df1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们的最佳解决方案是基于我的 resnet 和他的 resnet 的平均值，然后叠加他的模型。Densenet 的后期添加也被证明是有帮助的，因为它具有与我们的最佳性能 resnets 相当的结果。</p><p id="b0b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，不幸的是，由于合并中的一个错误，我们失去了我们的位置。事情是，公共和私人排行榜的文件名是不同的，我们的合并算法只在私人 LB 文件名上失败；因此，虽然我们在公共 LB 上没有看到任何异常，但我们混合了私人 LB 提交的结果。我不会 100%地责怪我们，因为这是一个超级难抓的漏洞，特别是在最后几个比赛日的抢劫期间，也因为我不认为训练和测试集应该这样划分。这一问题以及许多与数据相关的问题(tif 文件中的数据泄漏、比赛期间数据集的重新发布、tif 和 jpegs 之间的不匹配)使我对这场比赛及其组织失去了信心。令人欣慰的是，我们不是唯一因为文件名问题而失去阵地的人。</p><p id="182a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了抱怨之外，我们学到了一个很好的教训来避免将来出现这种情况:利用提交之间的相关性。结果是，我和秦的最佳提交结果的相关系数为 0.88，合并结果将会显著提高分数。然而，这并没有发生，合并的结果是微不足道的；这是一个强烈的信号，表明有猫腻。在修复了这个错误之后，事实证明实际的相关性是 0.98，这是更容易接受的。这是我的第一次团队合作，团队合作的所有动力和兴奋实际上都超过了这个小小的挫折:D</p><p id="5239" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">不起作用的事情</strong></p><ul class=""><li id="fef2" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated">XGB 和 ETR 模型对图像汇总统计和基于近红外的指数，应该是有助于检测水和绿色植物。除了 tif 在总体上没有帮助的事实之外，我已经得出结论，convnet 架构在提取特征方面要强大得多</li><li id="9118" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated"><a class="ae lc" href="https://arxiv.org/pdf/1602.02660.pdf" rel="noopener ugc nofollow" target="_blank">循环池</a>:我是从之前比赛的 Sander 的解决方案分享中得到的想法；试了几次后，我没有观察到多少收获；这可能是由于我的实现，但也可能是当前的架构比当时可用的架构强大得多，数据增强有助于使网络旋转不变。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/90e2dfa9802b654231db649262c4b1fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ybQd_JW2_w7TAu2PvG4uKg.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk"><em class="lb">Approximately 25,000 acres of untouched primary rainforest.</em></figcaption></figure><p id="810a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">特技</strong></p><ul class=""><li id="54f1" class="ms mt iq jp b jq jr ju jv jy mu kc mv kg mw kk mx my mz na bi translated">我之前提到过这一点，但从一小组小照片开始是在合理的时间内用不同的架构、超参数和数据扩充进行实验的关键。</li><li id="180f" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">伪标记:所以训练集的大小大约是 40k 图像和 60k 测试集。这是一个相当大的差异，在训练中有很多看不见的照片。根据杰瑞米·霍华德在 fast.ai 上分享的笔记，我利用伪标签/知识提炼将我的模型暴露给更多数据。基本上，在从微调中挤出最后一点梯度后，我继续在每批 75%的训练数据和 25%的测试数据上训练模型。测试集标签将是(增强的)模型预测。这帮我减少了大约 0.002 的损失。</li><li id="aa60" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">到最后，我意识到多云标签与所有其他标签是相互排斥的。这是因为对于多云的瓷砖，人类贴标签机看不到其他任何东西。我很确定我可以利用这个观察来对我们的结果进行后处理。我用了我最好的 resnet 模型，并将其作为单一模型进行微调，以检测多云或非多云(使用样本加权)。然后，我根据模型的输出整理了最终的预测:如果我们非常确信是多云，就去掉其他标签；如果我们确信不是多云，就去掉多云标签。虽然去除浑浊标签效果很好，但去除其他标签更敏感，我必须更有选择性地选择要去除的标签。最后，我可以观察到私人银行的一些显著收益。</li><li id="fa06" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">AWS p2 实例<a class="ae lc" href="https://blog.slavv.com/the-1700-great-deep-learning-box-assembly-setup-and-benchmarks-148c5ebe6415" rel="noopener ugc nofollow" target="_blank">众所周知的慢</a>；虽然我可以坐在那里等待，但我决定利用 spot 实例的灵活性。在通过运行 spot 实例和安装丢失的 nvidia 驱动程序的设置曲线后(我真的长出了白头发)，我设法轻松地生成新的 p2 实例并同时训练不同的模型。这大大提高了我的运行时间。</li></ul><p id="f0f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong></p><p id="e4cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">巴西球迷在 2014 年世界杯上的感受可能最能描述我的感受:你充满了激情和希望，但你却被排除在这个特殊的派对之外。如果在脖子上挂一块金属不是你唯一的目标，那也没什么大不了的。虽然有时会让我筋疲力尽，但对我来说，这是另一次尝试新方法的宝贵经历，也是我第一次享受在 kaggle 比赛中作为一个团队工作的乐趣。</p><p id="712a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代号:【https://github.com/olix20/kaggle-planet T4】</p></div></div>    
</body>
</html>