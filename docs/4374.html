<html>
<head>
<title>Deploying Keras Deep Learning Models with Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Java 部署 Keras 深度学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-keras-deep-learning-models-with-java-62d80464f34a?source=collection_archive---------2-----------------------#2018-08-12">https://towardsdatascience.com/deploying-keras-deep-learning-models-with-java-62d80464f34a?source=collection_archive---------2-----------------------#2018-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/860a9a43cc8147545809360eb0331b69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fGC6nw4eeR89cQX4.jpg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Source: Wikipedia</figcaption></figure><div class=""/><p id="f427" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Keras 库为深度学习提供了一个可接近的接口，使神经网络可以为广大受众所用。然而，我所面临的挑战之一是从在 Keras 中探索模型过渡到产品化模型。Keras 是用 Python 编写的，直到最近，在这些语言之外还只有有限的支持。虽然 Flask、PySpark 和 Cloud ML 等工具使得直接用 Python 将这些模型产品化成为可能，但我通常更喜欢用 Java 来部署模型。</p><p id="9d2b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">像<a class="ae la" href="https://github.com/onnx/onnx" rel="noopener ugc nofollow" target="_blank"> ONNX </a>这样的项目正在走向深度学习的标准化，但支持这些格式的运行时仍然有限。一种常用的方法是将 Keras 模型转换成张量流图，然后在其他支持张量流的运行程序中使用这些图。我最近发现了 Deeplearning4J (DL4J)项目，该项目原生支持 Keras 模型，使得用 Java 进行深度学习变得很容易。</p><div class="ip iq gp gr ir lb"><a href="https://deeplearning4j.org/docs/latest/keras-import-overview" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd jg gy z fp lg fr fs lh fu fw je bi translated">Keras 导入概述| Deeplearning4j</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">Keras 模型导入提供了导入最初使用 Keras 配置和训练的神经网络模型的例程…</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">deeplearning4j.org</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp ix lb"/></div></div></a></div><p id="d7be" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我一直在探索的深度学习的一个用例是使用 Keras 在 Python 中训练模型，然后使用 Java 将模型产品化。这对于需要直接在客户端进行深度学习的情况很有用，比如 Android 设备应用模型，以及想要利用现有的用 Java 编写的生产系统的情况。关于使用 Keras 的 DL4J 介绍可以在<a class="ae la" href="https://deeplearning4j.org/docs/latest/keras-import-overview" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="0f20" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这篇文章概述了用 Python 训练 Keras 模型，并用 Java 部署它。我使用 Jetty 提供实时预测，使用 Google 的数据流构建批量预测系统。GitHub 上提供了运行这些示例所需的全部代码和数据。</p><div class="ip iq gp gr ir lb"><a href="https://github.com/bgweber/DeployKeras/tree/master" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd jg gy z fp lg fr fs lh fu fw je bi translated">bgweber/DeployKeras</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">GitHub 是人们构建软件的地方。超过 2800 万人使用 GitHub 来发现、分享和贡献超过…</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">github.com</p></div></div><div class="lk l"><div class="lq l lm ln lo lk lp ix lb"/></div></div></a></div><h2 id="cead" class="lr ls jf bd lt lu lv dn lw lx ly dp lz kn ma mb mc kr md me mf kv mg mh mi mj bi translated">模特培训</h2><p id="bbcb" class="pw-post-body-paragraph kc kd jf ke b kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv mo kx ky kz ij bi translated">第一步是使用 Python 中的 Keras 库训练一个模型。一旦有了准备部署的模型，就可以将其保存为 h5 格式，并在 Python 和 Java 应用程序中使用它。在本教程中，我们将使用我在 Flask 上的博客文章中训练的预测哪些玩家可能会购买新游戏的相同模型。</p><div class="ip iq gp gr ir lb"><a rel="noopener follow" target="_blank" href="/deploying-keras-deep-learning-models-with-flask-5da4181436a2"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd jg gy z fp lg fr fs lh fu fw je bi translated">使用 Flask 部署 Keras 深度学习模型</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">这篇文章演示了如何使用 Keras 构建的深度学习模型来设置端点以服务于预测。它…</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">towardsdatascience.com</p></div></div><div class="lk l"><div class="mp l lm ln lo lk lp ix lb"/></div></div></a></div><p id="05d9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">模型的输入是描述玩家已经购买的游戏的十个二元特征(<em class="mq"> G1，G2，…，G10 </em>),标签是描述用户是否购买了不包括在输入中的游戏的单个变量。培训过程中涉及的主要步骤如下所示:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="3a19" class="lr ls jf mw b gy na nb l nc nd">import keras<br/>from keras import models, layers</span><span id="baae" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg"># Define the model structure<br/></strong>model = models.Sequential()<br/>model.add(layers.Dense(64, activation='relu', input_shape=(10,)))<br/>...<br/>model.add(layers.Dense(1, activation='sigmoid'))</span><span id="dac2" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg"># Compile and fit the model<br/></strong>model.compile(optimizer='rmsprop',loss='binary_crossentropy',<br/>              metrics=[auc])<br/>history = model.fit(x, y, epochs=100, batch_size=100,<br/>                    validation_split = .2, verbose=0)</span><span id="c117" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg"># Save the model in h5 format <br/></strong>model.save("games.h5")</span></pre><p id="ef8a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这个过程的输出是一个 h5 文件，它表示我们可以在 Python 和 Java 应用程序中部署的经过训练的模型。在我过去的帖子中，我展示了如何使用 Flask 在 Python 中提供实时模型预测。在这篇文章中，我将展示如何用 Java 构建批处理和实时预测。</p><h2 id="e3eb" class="lr ls jf bd lt lu lv dn lw lx ly dp lz kn ma mb mc kr md me mf kv mg mh mi mj bi translated">Java 设置</h2><p id="2c38" class="pw-post-body-paragraph kc kd jf ke b kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv mo kx ky kz ij bi translated">为了用 Java 部署 Keras 模型，我们将使用 Deeplearing4j 库。它为 Java 中的深度学习提供了功能，并可以加载和利用用 Keras 训练的模型。我们还将使用数据流进行批量预测，使用 Jetty 进行实时预测。以下是我在这个项目中使用的库:</p><ul class=""><li id="d0bc" class="nf ng jf ke b kf kg kj kk kn nh kr ni kv nj kz nk nl nm nn bi translated"><a class="ae la" href="https://deeplearning4j.org/" rel="noopener ugc nofollow" target="_blank"><strong class="ke jg">deep learning 4j</strong></a><strong class="ke jg">:</strong>为 Java 提供深度神经网络功能。</li><li id="3787" class="nf ng jf ke b kf no kj np kn nq kr nr kv ns kz nk nl nm nn bi translated"><a class="ae la" href="https://nd4j.org/" rel="noopener ugc nofollow" target="_blank"><strong class="ke jg">ND4J</strong></a><strong class="ke jg">:</strong>为 Java 提供张量运算。</li><li id="4a8c" class="nf ng jf ke b kf no kj np kn nq kr nr kv ns kz nk nl nm nn bi translated"><a class="ae la" href="https://www.eclipse.org/jetty/" rel="noopener ugc nofollow" target="_blank"><strong class="ke jg">Jetty</strong></a><strong class="ke jg">:</strong>用于设置 web 端点。</li><li id="2c89" class="nf ng jf ke b kf no kj np kn nq kr nr kv ns kz nk nl nm nn bi translated"><a class="ae la" href="https://cloud.google.com/dataflow/" rel="noopener ugc nofollow" target="_blank"> <strong class="ke jg">云数据流:</strong> </a>为 GCP 上的批量预测提供自动缩放。</li></ul><p id="a9bc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我使用下面显示的<a class="ae la" href="https://github.com/bgweber/DeployKeras/blob/master/pom.xml" rel="noopener ugc nofollow" target="_blank"> pom.xml </a>将它们导入到我的项目中。对于 DL4J，使用 Keras 时需要核心库和模型导入库。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="7851" class="lr ls jf mw b gy na nb l nc nd">&lt;dependencies&gt;<br/>  &lt;dependency&gt;      <br/>    &lt;groupId&gt;org.deeplearning4j&lt;/groupId&gt;      <br/>    &lt;artifactId&gt;deeplearning4j-core&lt;/artifactId&gt;<br/>    &lt;version&gt;1.0.0-beta2&lt;/version&gt;    <br/>  &lt;/dependency&gt;         <br/>  &lt;dependency&gt;      <br/>    &lt;groupId&gt;org.deeplearning4j&lt;/groupId&gt;      <br/>    &lt;artifactId&gt;deeplearning4j-modelimport&lt;/artifactId&gt;      <br/>    &lt;version&gt;1.0.0-beta2&lt;/version&gt;    <br/>  &lt;/dependency&gt;                       <br/>  &lt;dependency&gt;      <br/>    &lt;groupId&gt;org.nd4j&lt;/groupId&gt;      <br/>    &lt;artifactId&gt;nd4j-native-platform&lt;/artifactId&gt;<br/>    &lt;version&gt;1.0.0-beta2&lt;/version&gt;    <br/>  &lt;/dependency&gt;<br/>  &lt;dependency&gt;      <br/>    &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;      <br/>    &lt;artifactId&gt;jetty-server&lt;/artifactId&gt;      <br/>    &lt;version&gt;9.4.9.v20180320&lt;/version&gt;   <br/>  &lt;/dependency&gt;  &lt;dependency&gt;      <br/>    &lt;groupId&gt;com.google.cloud.dataflow&lt;/groupId&gt;      <br/>    &lt;artifactId&gt;google-cloud-dataflow-java-sdk-all&lt;/artifactId&gt;  <br/>    &lt;version&gt;2.2.0&lt;/version&gt;     <br/>  &lt;/dependency&gt;<br/>&lt;/dependencies&gt;</span></pre><p id="e19a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我在 Eclipse 中设置了我的项目，一旦我正确配置了 pom 文件，就不需要额外的设置就可以开始了。</p><h2 id="a8a0" class="lr ls jf bd lt lu lv dn lw lx ly dp lz kn ma mb mc kr md me mf kv mg mh mi mj bi translated">使用 DL4J 的 Keras 预测</h2><p id="e464" class="pw-post-body-paragraph kc kd jf ke b kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv mo kx ky kz ij bi translated">现在我们已经建立了库，我们可以开始使用 Keras 模型进行预测。我编写了下面的脚本来测试加载 Keras 模型并对样本数据集进行预测。第一步是从 h5 文件中加载模型。接下来，我定义一个长度为 10 的 1D 张量，并生成随机的二进制值。最后一步是对模型调用 output 方法来生成预测。因为我的模型只有一个输出节点，所以我使用<em class="mq"> getDouble(0) </em>来返回模型的输出。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="b99d" class="lr ls jf mw b gy na nb l nc nd"><strong class="mw jg">// imports<br/></strong>import org.deeplearning4j.nn.modelimport.keras.KerasModelImport;<br/>import org.deeplearning4j.nn.multilayer.MultiLayerNetwork;<br/>import org.nd4j.linalg.api.ndarray.INDArray;<br/>import org.nd4j.linalg.factory.Nd4j;<br/>import org.nd4j.linalg.io.ClassPathResource;</span><span id="4924" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">// load the model<br/></strong>String simpleMlp = new ClassPathResource(<br/>                          "games.h5").getFile().getPath();<br/>MultiLayerNetwork model = KerasModelImport.<br/>                    importKerasSequentialModelAndWeights(simpleMlp);</span><span id="56f1" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">// make a random sample<br/></strong>int inputs = 10;<br/>INDArray features = Nd4j.zeros(inputs);<br/>for (int i=0; i&lt;inputs; i++) <br/>    features.putScalar(new int[] {i}, Math.random() &lt; 0.5 ? 0 : 1);</span><span id="ffbd" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">// get the prediction<br/></strong>double prediction = model.output(features).getDouble(0);</span></pre><p id="24b1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用 DL4J 时需要熟悉的一个关键概念是张量。Java 没有高效张量选项的内置库，这就是为什么 NDJ4 是先决条件。它提供了用 Java 实现深度学习后端的 N 维数组。要在张量对象中设置一个值，需要传递一个整数数组，该数组为张量提供一个 n 维索引，并提供要设置的值。因为我用的是 1D 张量，所以数组的长度是 1。</p><p id="aa6d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">模型对象提供了<em class="mq">预测</em>和<em class="mq">输出</em>方法。predict 方法返回一个类预测(0 或 1)，而 output 方法返回一个连续的标签，类似于 scikit-learn 中的<em class="mq"> predict_proba </em>。</p><h2 id="3b14" class="lr ls jf bd lt lu lv dn lw lx ly dp lz kn ma mb mc kr md me mf kv mg mh mi mj bi translated">实时预测</h2><p id="98d7" class="pw-post-body-paragraph kc kd jf ke b kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv mo kx ky kz ij bi translated">现在我们已经有了一个用 Java 运行的 Keras 模型，我们可以开始为模型预测服务了。我们将采用的第一种方法是使用 Jetty 在 web 上设置一个端点来提供模型预测。我之前在关于<a class="ae la" rel="noopener" target="_blank" href="/data-science-for-startups-tracking-data-4087b66952a1">跟踪数据</a>和<a class="ae la" rel="noopener" target="_blank" href="/data-science-for-startups-model-production-b14a29b2f920">模型生产</a>的帖子中提到过 Jetty 的设置。模型端点的完整代码可在<a class="ae la" href="https://github.com/bgweber/DeployKeras/blob/master/JettyDL4J.java" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><p id="a27c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">模型端点被实现为加载 Keras 模型并提供预测的单个类。它实现 Jetty 的<em class="mq"> AbstractHandler </em>接口来提供模型结果。下面的代码展示了如何设置 Jetty 服务在端口 8080 上运行，并实例化 JettyDL4J 类，该类在构造函数中加载 Keras 模型。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="2022" class="lr ls jf mw b gy na nb l nc nd"><strong class="mw jg">// Setting up the web endpoint<br/></strong>Server server = new Server(8080);<br/>server.setHandler(new JettyDL4J());<br/>server.start();<br/>server.join();</span><span id="2e04" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">// Load the Keras model <br/></strong>public JettyDL4J() throws Exception {  <br/>    String p=new ClassPathResource("games.h5").getFile().getPath(); <br/>    model=KerasModelImport.importKerasSequentialModelAndWeights(p); <br/>}</span></pre><p id="b2ae" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">管理 web 请求的处理程序如下面的代码片段所示。传入的参数(<em class="mq"> G1，G2，…，G10 </em>)被转换成 1D 张量对象，并传递给 Keras 模型的输出方法。然后，请求被标记为已处理，预测作为字符串返回。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="8bf7" class="lr ls jf mw b gy na nb l nc nd"><strong class="mw jg">// Entry point for the model prediction request <br/></strong>public void handle(String target,Request baseRequest, <br/>    HttpServletRequest request, HttpServletResponse response) <br/>    throws IOException, ServletException {</span><span id="5948" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">  // create a dataset from the input parameters<br/>  </strong>INDArray features = Nd4j.zeros(inputs);<br/>  for (int i=0; i&lt;inputs; i++) <br/>      features.putScalar(new int[] {i},  Double.parseDouble(<br/>                          baseRequest.getParameter("G" + (i + 1))));</span><span id="9031" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">  // output the estimate<br/>  </strong>double prediction = model.output(features).getDouble(0);<br/>  response.setStatus(HttpServletResponse.SC_OK);<br/>  response.getWriter().println("Prediction: " + prediction);<br/>  baseRequest.setHandled(true);<br/>}</span></pre><p id="2275" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当您运行该类时，它会在端口 8080 上设置一个端点。您可以通过将浏览器指向以下 URL 来调用模型服务:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="6533" class="lr ls jf mw b gy na nb l nc nd"><strong class="mw jg">// Request</strong><a class="ae la" href="http://localhost:8080/?G1=1&amp;G2=0&amp;G3=1&amp;G4=1&amp;G5=0&amp;G6=1&amp;G7=0&amp;G8=1&amp;G9=1&amp;G10=1" rel="noopener ugc nofollow" target="_blank"><strong class="mw jg"><br/></strong>http://localhost:8080/?G1=1&amp;G2=0&amp;G3=1&amp;G4=1&amp;G5=0&amp;G6=1&amp;G7=0&amp;G8=1&amp;G9=1&amp;G10=1</a></span><span id="8a91" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">// Result<br/></strong>Prediction: 0.735433042049408</span></pre><p id="5170" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">结果是一个 Keras 模型，你现在可以实时调用它来从你的深度学习模型中获得预测。对于生产系统，您可能希望在 Jetty 端点前设置一个服务，而不是直接在 web 上公开端点。</p><h2 id="9920" class="lr ls jf bd lt lu lv dn lw lx ly dp lz kn ma mb mc kr md me mf kv mg mh mi mj bi translated">批量预测</h2><p id="df38" class="pw-post-body-paragraph kc kd jf ke b kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv mo kx ky kz ij bi translated">Keras 模型的另一个用例是批量预测，在这种情况下，您可能需要对数百万条记录应用估计量。您可以使用 Keras 模型在 Python 中直接实现这一点，但是这种方法的可伸缩性有限。我将展示如何使用 Google 的数据流，通过完全管理的管道将预测应用于海量数据集。我之前在关于<a class="ae la" rel="noopener" target="_blank" href="/data-science-for-startups-model-production-b14a29b2f920">模型制作</a>和<a class="ae la" rel="noopener" target="_blank" href="/scaling-game-simulations-with-dataflow-172926612d50">游戏模拟</a>的帖子中提到过设置数据流。</p><p id="816d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用数据流，您可以指定要在数据集上执行的操作的图形，其中源和目标数据集可以是关系数据库、消息服务、应用程序数据库和其他服务。这些图形可以作为批处理操作执行，其中基础架构启动以处理大型数据集，然后关闭；或者以流模式执行，其中维护基础架构并在请求到达时进行处理。在这两种情况下，服务将自动伸缩以满足需求。它经过全面管理，非常适合可以独立执行的大型计算。</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/a6d37e82da2ea45e84c800f58da43a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:454/format:webp/1*dIXlw2ZEwQu56bEZXZlF8w.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">DataFlow DAG for Batch Deep Learning</figcaption></figure><p id="d3cc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我的数据流流程中的 DAG 操作如上所示。第一步是为要评分的模型创建数据集。在本例中，我从示例 CSV 加载值，而实际上我通常使用 BigQuery 作为模型预测的源和同步。下一步是转换，将<em class="mq">表行</em>对象作为输入，将行转换为 1D 张量，将模型应用于每个张量，并使用预测值创建新的输出<em class="mq">表行</em>。DAG 的完整代码可在<a class="ae la" href="https://github.com/bgweber/DeployKeras/blob/master/DataFlowDL4J.java" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><p id="0fbb" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这个管道中的关键步骤是<em class="mq"> Keras Predict </em>转换，如下面的代码片段所示。转换对对象集合进行操作，并返回对象集合。在转换器中，您可以定义诸如 Keras 模型之类的对象，这些对象在转换器中定义的每个流程元素步骤之间共享。结果是，模型为每个转换器加载一次，而不是为需要预测的每个记录加载一次。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="dd53" class="lr ls jf mw b gy na nb l nc nd"><strong class="mw jg">// Apply the transform to the pipeline<br/></strong>.apply("Keras Predict", new PTransform&lt;PCollection&lt;TableRow&gt;, <br/>                                       PCollection&lt;TableRow&gt;&gt;() {       </span><span id="fbb3" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">  // Load the model in the transformer<br/></strong>  public PCollection&lt;TableRow&gt; expand(PCollection&lt;TableRow&gt; input) {                        </span><span id="563d" class="lr ls jf mw b gy ne nb l nc nd">    final int inputs = 10;<br/>    final MultiLayerNetwork model;       <br/>    try {        <br/>     String p= newClassPathResource("games.h5").getFile().getPath();<br/>     model=KerasModelImport.importKerasSequentialModelAndWeights(p);<br/>  }             <br/>  catch (Exception e) {<br/>     throw new RuntimeException(e);<br/>  }</span><span id="62bf" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">  // create a DoFn for applying the Keras model to instances  <br/></strong>  return input.apply("Pred",ParDo.of(new DoFn&lt;TableRow,TableRow&gt;(){<br/>    @ProcessElement<br/>    public void processElement(ProcessContext c) throws Exception {<br/><strong class="mw jg">       ...  // Apply the Keras model<br/></strong>    }}));         <br/>}})</span></pre><p id="599d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">process element 方法的代码如下所示。它读取输入记录，从表行创建张量，应用模型，然后保存记录。输出行包含预测值和实际值。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="b4a2" class="lr ls jf mw b gy na nb l nc nd"><strong class="mw jg">  // get the record to score<br/>  </strong>TableRow row = c.element();      </span><span id="cc58" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">  // create the feature vector                   <br/>  </strong>INDArray features = Nd4j.zeros(inputs);                 <br/>  for (int i=0; i&lt;inputs; i++)                   <br/>    features.putScalar(new int[] {i}, <br/>          Double.parseDouble(row.get("G" + (i+1)).toString()));                                              </span><span id="e85d" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">  // get the prediction                  <br/>  </strong>double estimate = model.output(features).getDouble(0);              </span><span id="321a" class="lr ls jf mw b gy ne nb l nc nd"><strong class="mw jg">  // save the result                  <br/>  </strong>TableRow prediction = new TableRow();                    <br/>  prediction.set("actual", row.get("actual"));                  <br/>  prediction.set("predicted", estimate);                        <br/>  c.output(prediction);</span></pre><p id="c14d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我在本文中排除了 CSV 加载和 BigQuery 编写代码块，因为您可能使用不同的端点。如果你想试着运行 DAG，可以在 GitHub 上找到代码和 CSV。要将结果保存到 BigQuery，您需要如下设置<em class="mq"> tempLocation </em>程序参数:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="8a98" class="lr ls jf mw b gy na nb l nc nd">--tempLocation=gs://your-gs-bucket/temp-dataflow-location</span></pre><p id="8a66" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运行 DAG 后，将在 BigQuery 中创建一个新表，其中包含数据集的实际值和预测值。下图显示了我应用 Keras 模型的样本数据点。</p><figure class="mr ms mt mu gt is gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/cd98758b24390629dc12469f70e73341.png" data-original-src="https://miro.medium.com/v2/resize:fit:510/format:webp/1*DSDcJYdrUdq3DZt7uq6feg.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Prediction results in BigQuery</figcaption></figure><p id="3ab5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将数据流与 DL4J 结合使用的结果是，您可以使用批量预测的自动缩放基础设施对数百万条记录进行评分。</p><h2 id="a9cb" class="lr ls jf bd lt lu lv dn lw lx ly dp lz kn ma mb mc kr md me mf kv mg mh mi mj bi translated">结论</h2><p id="c48c" class="pw-post-body-paragraph kc kd jf ke b kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv mo kx ky kz ij bi translated">随着深度学习越来越受欢迎，越来越多的语言和环境支持这些模型。随着库开始标准化模型格式，使用不同的语言进行模型训练和模型部署变得可能。这篇文章展示了使用 Python 中的 Keras 库训练的神经网络如何使用 Java 中的 DL4J 库进行批量和实时预测。我第一次能够建立一个批处理过程，将深度学习应用于数百万个数据点。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="5dc9" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://www.linkedin.com/in/ben-weber-3b87482/" rel="noopener ugc nofollow" target="_blank">本·韦伯</a>是 Zynga 的首席数据科学家。我们正在<a class="ae la" href="https://www.zynga.com/careers/positions/categories/data-analytics-user-research" rel="noopener ugc nofollow" target="_blank">招聘</a>！</p></div></div>    
</body>
</html>