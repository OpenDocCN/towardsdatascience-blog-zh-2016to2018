<html>
<head>
<title>How to write tidy SQL queries in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 R 编写整洁的 SQL 查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-write-tidy-sql-queries-in-r-d6d6b2a3e17?source=collection_archive---------8-----------------------#2018-10-06">https://towardsdatascience.com/how-to-write-tidy-sql-queries-in-r-d6d6b2a3e17?source=collection_archive---------8-----------------------#2018-10-06</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><p id="6f38" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">如今，我们大多数人都必须与数据库进行交互，而 SQL 是目前最常用的语言。然而，在 R 中使用 SQL 可能会很麻烦。如果您的查询很复杂，您必须将它们编码为文本字符串，这很容易出错，并且面临格式方面的挑战。此外，当您想要构建包含变量的 SQL 查询时，您必须进行替换或粘贴，这有点麻烦。</p><p id="3e86" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">理想情况下，您希望能够使用 tidy 原则处理您的数据库，利用 tidyverse 的奇迹，最好不要先将整个数据库下载到您的会话中。这就是<code class="fe kq kr ks kt b">dbplyr</code>的魔力所在。</p><p id="494d" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated"><code class="fe kq kr ks kt b">dbplyr</code>充当 SQL 翻译器，允许你使用<code class="fe kq kr ks kt b">tidyverse</code>来处理数据库。所以现在你可以尽情宣泄了。如果你还没有用过这个，我现在就开始用。编写整洁的数据库查询有许多优点。当你过一段时间再回到你的工作时，你可以更容易地理解你的工作，你可以更清楚地评论，并且它也迫使你去思考你的查询的最有效的结构。</p><h2 id="4d1c" class="ku kv iv bd kw kx ky dn kz la lb dp lc kd ld le lf kh lg lh li kl lj lk ll lm bi translated">在 dbplyr 中工作的基本原则</h2><p id="1eae" class="pw-post-body-paragraph js jt iv ju b jv ln jx jy jz lo kb kc kd lp kf kg kh lq kj kk kl lr kn ko kp io bi translated">要在<code class="fe kq kr ks kt b">dbplyr</code>中工作，您需要像在 R 会话中一样设置数据库连接，我们称之为<code class="fe kq kr ks kt b">myconn</code>。您将使用<code class="fe kq kr ks kt b">dbplyr::in_schema()</code>在 R 会话中设置数据库对象。这需要两个参数:第一，您希望在数据库连接中访问的模式，第二，您在该模式中感兴趣的表。下面是一个如何设置的示例:</p><pre class="ls lt lu lv gt lw kt lx ly aw lz bi"><span id="ee56" class="ku kv iv kt b gy ma mb l mc md">catdata &lt;- dplyr::tbl(<br/>  myconn,<br/>  dbplyr::in_schema("ANIMAL_ANALYSTS", "CAT_TABLE")<br/>)</span></pre><p id="d4bf" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">现在<code class="fe kq kr ks kt b">catdata</code>是一个数据库对象。上面的命令连接到数据库并下载关于字段、数据类型等的最少信息。—足以允许操纵对象，而无需物理下载数据。</p><p id="f84e" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">现在，您可以像操作 r 中的其他表一样操作<code class="fe kq kr ks kt b">catdata</code>。例如:</p><pre class="ls lt lu lv gt lw kt lx ly aw lz bi"><span id="65d3" class="ku kv iv kt b gy ma mb l mc md">weight_by_age &lt;- catdata %&gt;%<br/>  dplyr::group_by(AGE) %&gt;%<br/>  dplyr::summarise(AVG_WT = mean(WT, na.rm = TRUE))</span></pre><p id="13e6" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">所有这些操作都是通过在后台将您的代码翻译成 SQL，而无需实际下载数据。由于数据下载通常是最耗时的步骤，这允许您在提取数据之前考虑您希望在服务器上完成多少工作。</p><p id="736d" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">准备拉数据的时候，用<code class="fe kq kr ks kt b">dplyr::collect()</code>就可以了。这将把后台编译的 SQL 查询发送到数据库并执行它。例如:</p><pre class="ls lt lu lv gt lw kt lx ly aw lz bi"><span id="3fb6" class="ku kv iv kt b gy ma mb l mc md">weight_by_age %&gt;%<br/>  dplyr::rename(`Age of Cat` = AGE,<br/>                `Average Weight` = AVG_WT) %&gt;%<br/>  dplyr::collect() </span></pre><h2 id="2555" class="ku kv iv bd kw kx ky dn kz la lb dp lc kd ld le lf kh lg lh li kl lj lk ll lm bi translated">dbplyr 中更复杂的 SQL 操作</h2><p id="2c6d" class="pw-post-body-paragraph js jt iv ju b jv ln jx jy jz lo kb kc kd lp kf kg kh lq kj kk kl lr kn ko kp io bi translated"><code class="fe kq kr ks kt b">dbplyr</code>非常灵活，我还没有发现我不能用<code class="fe kq kr ks kt b">dbplyr</code>重写 tidy 的 SQL 查询。</p><p id="a86a" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">连接通过在数据库对象上使用<code class="fe kq kr ks kt b">dplyr</code>的连接函数来工作，例如:</p><pre class="ls lt lu lv gt lw kt lx ly aw lz bi"><span id="3249" class="ku kv iv kt b gy ma mb l mc md">fullcatdata &lt;- dplyr::left_join(<br/>  catregistrationdetails, <br/>  catdata, <br/>  by = "SERIAL_NO"<br/>) %&gt;%<br/>  dplyr::left_join(<br/>    cathealthrecord, <br/>    by = "SERIAL_NO"<br/>)</span></pre><p id="7f77" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">可以使用<code class="fe kq kr ks kt b">dplyr::mutate()</code>将新列添加到数据中，甚至可以用于更复杂的连接。例如，如果您的卡特彼勒序列号在一个表中有“CAT-”开头，但在另一个表中没有:</p><pre class="ls lt lu lv gt lw kt lx ly aw lz bi"><span id="a0e7" class="ku kv iv kt b gy ma mb l mc md"> fullcatdata &lt;- catregistrationdetails %&gt;%<br/>  dplyr::mutate(SERIAL_NO = paste0("CAT-", SERIAL_NO)) %&gt;%<br/>  dplyr::left_join(catdata, by = "SERIAL_NO")</span></pre><p id="5434" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated"><code class="fe kq kr ks kt b">dbplyr</code>巧妙地将 R 函数翻译成 SQL 等价物。您可以使用<code class="fe kq kr ks kt b">dbplyr::translate_sql()</code>功能来查看它的功能。例如:</p><pre class="ls lt lu lv gt lw kt lx ly aw lz bi"><span id="203d" class="ku kv iv kt b gy ma mb l mc md">dbplyr::translate_sql(substr(NAME, -3, -1))<br/>&lt;SQL&gt; substr("NAME", -3, 3)</span></pre><p id="9f03" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">我发现<code class="fe kq kr ks kt b">dbplyr</code>也让我在反应式环境中更容易编码。如果你要建立一个闪亮的应用程序，根据输入计算猫的平均体重<code class="fe kq kr ks kt b">input$age</code>:</p><pre class="ls lt lu lv gt lw kt lx ly aw lz bi"><span id="5686" class="ku kv iv kt b gy ma mb l mc md">weight &lt;- reactive({<br/>  catdata %&gt;%<br/>  dplyr::filter(AGE == input$age) %&gt;%<br/>  dplyr::select(WT) %&gt;%<br/>  mean(na.rm = TRUE) %&gt;%<br/>  dplyr::collect()<br/>})</span></pre><p id="16f4" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">这些只是<code class="fe kq kr ks kt b">dbplyr</code>帮助您在 SQL 中更整洁地工作的许多方式中的一部分。我强烈推荐。</p><p id="7231" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated"><em class="me">关于</em> <code class="fe kq kr ks kt b"><em class="me">dbplyr</em></code> <em class="me">的更多信息，请点击</em> <a class="ae mf" href="https://dbplyr.tidyverse.org/" rel="noopener ugc nofollow" target="_blank"> <em class="me">这里</em> </a> <em class="me">。</em></p><p id="5340" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">最初我是一名纯粹的数学家，后来我成为了一名心理计量学家和数据科学家。我热衷于将所有这些学科的严谨性应用到复杂的人的问题上。我也是一个编码极客和日本 RPG 的超级粉丝。在<a class="ae mf" href="https://www.linkedin.com/in/keith-mcnulty/" rel="noopener ugc nofollow" target="_blank"><em class="me">LinkedIn</em></a><em class="me">或</em><a class="ae mf" href="https://twitter.com/dr_keithmcnulty" rel="noopener ugc nofollow" target="_blank"><em class="me">Twitter</em></a><em class="me">上找我。</em></p><figure class="ls lt lu lv gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mg"><img src="../Images/50704f5353ad62709f15c575a4dba836.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cI0cPbphccdE4sev.jpg"/></div></div></figure></div></div>    
</body>
</html>