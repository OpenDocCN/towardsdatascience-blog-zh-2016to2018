<html>
<head>
<title>Visualizing Japan cherry blossom season forecast 2018 — doing it all in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可视化 2018 年日本樱花季预测——尽在 R</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualizing-japan-cherry-blossom-season-forecast-2018-doing-it-all-in-r-8b0ef46a6762?source=collection_archive---------14-----------------------#2018-08-07">https://towardsdatascience.com/visualizing-japan-cherry-blossom-season-forecast-2018-doing-it-all-in-r-8b0ef46a6762?source=collection_archive---------14-----------------------#2018-08-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0755" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一种用于教育目的的动画数据可视化体验，利用 FFmpeg 将图像转换为 MP4</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/88adae805ddfc30b073ed265aa4aea4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qi7b2rY6eGJ-y8kOLHIYSA.jpeg"/></div></div></figure><p id="8a1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近，我怀着无比的喜悦第一次访问了日本。这次旅行是对日本美丽迷人的风景、历史和丰富文化的完美介绍。我非常怀念的一件事是能够看到樱花。所以我决定把它作为这次可视化的主题。</p><p id="bba4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">四处寻找数据集(最好是带日期的 geojson)，不幸的是没有这样的可用数据集。</p><p id="5af3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没问题。我决定从 2018 年 JR 铁路通行证的<a class="ae kx" href="https://www.jrailpass.com/blog/japan-cherry-blossom-forecast" rel="noopener ugc nofollow" target="_blank">官方预报网页</a>建立一个简单的网络抓取。它包括下载一个表，然后将该表映射到日本地区的名称。有一些必要的数据清理操作，以确定开花、完全开花和花期结束。幸运的是，官方预报网页给了我所需的开花前 1 周和开花后 1 周的假设:</p><blockquote class="ky kz la"><p id="a938" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated">“请记住，<strong class="jp ir">大多数花一旦开始开花，通常需要一周的时间达到盛开</strong>，而<strong class="jp ir">的盛开也要持续一周左右”(JR 铁路通行证博客)</strong></p></blockquote><p id="398c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我们将构建的体验的结果。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lf"><img src="../Images/053899271d5c24925e62e1bb16b8bac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*g7hwQMBVfScv5qMOZt9YUQ.gif"/></div></figure><p id="4e84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种方法不使用任何库。目标是帮助人们更好地理解幕后发生的事情。电影是一系列静止的图像，当一个图像一个图像地播放时，会产生运动的错觉。本教程将通过生成 55 张图片(每天一张)来做同样的事情，并将使用 FFmpeg 将它们转换成一部电影(2 行代码)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lg"><img src="../Images/61b2b3134324e7d2dfca3232a7f7e841.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*IJIsw9in4IZ4Wld2.gif"/></div><figcaption class="lh li gj gh gi lj lk bd b be z dk">Sallie Gardner at a Gallop — made by Eadweard Muybridge in 1878</figcaption></figure><h1 id="7c95" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用 R:</h1><p id="30f3" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">我们将跳过步骤 0 (webscraping 和数据清理以创建数据集),专注于步骤 1 到 3——加载文件、生成图像并将其转换为电影。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mo"><img src="../Images/cd56a65cdd2b9c0c2f77d64626fc9e89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kf3fxoBBeaAVimNFVBHwhg.png"/></div></div></figure><p id="bcbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤 1——加载并准备文件</strong></p><p id="8b24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用 2 个文件:1)从 JR 铁路通道获得的数据集和来自日本的 Geojson 文件，我们将把它们转换成带有每个地区名称的数据帧。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="a99e" class="mu lm iq mq b gy mv mw l mx my">#Step 1 - Loading datasets<br/>myurl&lt;-'<a class="ae kx" href="https://raw.githubusercontent.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018/master/sakura_2018.csv" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018/master/sakura_2018.csv</a><a class="ae kx" href="https://raw.githubusercontent.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018/master/sakura_2018.csv'" rel="noopener ugc nofollow" target="_blank">'</a><br/>sakuradf&lt;- read.csv(myurl)<br/>sakuradf$sakura &lt;- as.factor(sakuradf$sakura)</span><span id="8c45" class="mu lm iq mq b gy mz mw l mx my">#Loading geojson Japan map and convert it into dataframe<br/>myurl &lt;- '<a class="ae kx" href="https://raw.githubusercontent.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018/master/Japan.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018/master/Japan.json</a><a class="ae kx" href="https://raw.githubusercontent.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018/master/Japan.json'" rel="noopener ugc nofollow" target="_blank">'</a><br/>map_japan &lt;- geojson_read(myurl,  what = "sp")<br/>map_japan.df &lt;- fortify(map_japan)</span><span id="8f94" class="mu lm iq mq b gy mz mw l mx my">#Adding the name to the region<br/>myid &lt;- as.data.frame(map_japan@data)<br/>myid$id &lt;- seq.int(nrow(myid))-1<br/>myid &lt;- myid  %&gt;% select(id, name)<br/>map_japan.df &lt;- merge(map_japan.df, myid,  by.x="id", by.y="id")</span></pre><p id="548e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤 2 —生成 55 幅图像</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi na"><img src="../Images/e11fa382a52c6adfcee3918862b302cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x_U53fMxLlvAVmU5Mgrrig.png"/></div></div></figure><p id="1210" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们首先必须创建一个包含所有唯一日期的过滤器。由于像冲绳这样的一些地区在使用的 geojson 地图上看不太清楚，所以最好从樱花预测的第 65 天开始一直到结束，而不是第 1 天。</p><p id="c8a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要从 ggplot 获得更好的结果，需要 ggplot 的主题(参见 theme_map)。</p><p id="67f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，从第 65 天到最后创建一个简单的循环，过滤当天的内容并与 JSON 合并，然后将图像保存到地图文件夹中。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="2c78" class="mu lm iq mq b gy mv mw l mx my">#Step 2 - Generating 55 images</span><span id="6553" class="mu lm iq mq b gy mz mw l mx my">#Creating a filter of all the dates<br/>mydates =unique(sakuradf$date)</span><span id="0f7e" class="mu lm iq mq b gy mz mw l mx my">#Displaying only the last 55 days of the season (skipping Okinawa region)<br/>startdate = 65<br/>enddate = length(mydates)</span><span id="5a8c" class="mu lm iq mq b gy mz mw l mx my">#Generating a style<br/>theme_map &lt;- function(base_size = 12) {<br/>  theme_minimal() +<br/>    theme(<br/>      axis.line = element_blank(),<br/>      axis.text.x = element_blank(),<br/>      axis.text.y = element_blank(),<br/>      axis.ticks = element_blank(),<br/>      axis.title.x = element_blank(),<br/>      axis.title.y = element_blank(),<br/>      # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),<br/>      panel.grid.major = element_line(color = "#ebebe5", size = 0.2),<br/>      panel.grid.minor = element_blank(),<br/>      plot.background = element_rect(fill = "#f5f5f2", color = NA), <br/>      panel.background = element_rect(fill = "#f5f5f2", color = NA), <br/>      legend.position = 'None', legend.title = element_blank(),<br/>      panel.border = element_blank()<br/>    )<br/>}</span><span id="d757" class="mu lm iq mq b gy mz mw l mx my">#Creating a loop to filter on each day, generate a chart and saving 55 images in a map folder<br/>for (x in startdate:enddate){<br/>  my_x = mydates[x]<br/>  print(paste("The year is", my_x))<br/>  sakuradf_x &lt;- sakuradf %&gt;% filter(date == my_x)<br/>  map_japan.df_x &lt;- merge(map_japan.df, sakuradf_x,  by.x="name", by.y="name")<br/>  japanplot &lt;- ggplot(map_japan.df_x) +<br/>    geom_polygon(aes(x = long, y = lat, fill = sakura, group = group)) +<br/>    theme_map()+scale_fill_manual(values=c("4"='#d2618c',"3"='#e3adcb' , "2"="#f7e0f4", "1"="#9db6c7")) +<br/>    ylim(30,46)+ <br/>    xlim(127,148)+ <br/>    labs(x = NULL, <br/>         y = NULL, <br/>         title = "Japan Sakura Seasons", <br/>         subtitle = paste("Date: ", my_x, sep=""),<br/>         caption = "Japan Weather Forecast 2018")<br/>  filename &lt;- paste0("maps/img_" , str_pad(x-64, 7, pad = "0"),  ".png")<br/>  ggsave(filename = filename, plot = japanplot, width = 5, height = 5, dpi = 150, type = "cairo-png")<br/>}</span></pre><p id="0df9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤 3 —从图像到电影</strong></p><p id="14f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只要你下载了 FFmeg 并解压到本地文件夹，比如 C:/ffmpeg，只需要简单的几行代码就可以创建电影。如果您没有 FFmeg，可以从以下网址下载:</p><div class="nb nc gp gr nd ne"><a href="https://www.ffmpeg.org/" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd ir gy z fp nj fr fs nk fu fw ip bi translated">FFmpeg</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">Stanislav Dolganov 设计并实现了无损运动估计和补偿的实验支持。</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">www.ffmpeg.org</p></div></div></div></a></div><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="7bfa" class="mu lm iq mq b gy mv mw l mx my">#Step 3 - Creating a movie from the images (please note that ffmeg is on my C:/)<br/>makemovie_cmd &lt;- paste0("C:/ffmpeg/bin/ffmpeg -framerate 5 -y -i ", paste0(getwd(), "/maps/img_%7d.png"),  " -r 56 -pix_fmt yuv420p ",  paste0(getwd(), "/maps/"), "sakura_movie.mp4")<br/>system(makemovie_cmd)</span></pre><p id="e531" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在地图文件夹中创建一个 sakura_movie.mp4。你可以在<a class="ae kx" href="https://github.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到完整的代码和文件。</p><div class="nb nc gp gr nd ne"><a href="https://github.com/tristanga/Visualizing-Japan-cherry-blossom-season-forecast-2018" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd ir gy z fp nj fr fs nk fu fw ip bi translated">特里斯坦加/可视化-日本-樱花-季节-预测-2018 年</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">可视化-日本-樱花-季节-预测-2018 -另一个用于教育目的的动画数据可视化</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">github.com</p></div></div><div class="nn l"><div class="no l np nq nr nn ns kv ne"/></div></div></a></div><p id="41bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这个可视化效果，别忘了用文章页面上的鼓掌按钮鼓掌👏。每篇帖子最多可以鼓掌 50 次。如果您有任何问题，请随时通过<a class="ae kx" href="https://www.linkedin.com/in/tristanganry/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/ebd3f8cfe174532f03aae12371794fef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*ETzfjKn55RLOvXWYxJ1xLQ.png"/></div></figure></div></div>    
</body>
</html>