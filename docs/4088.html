<html>
<head>
<title>Productive research with custom IPython extensions, part 2: BigQuery magic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用定制 IPython 扩展进行富有成效的研究，第 2 部分:BigQuery 魔术</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/productive-research-with-custom-ipython-extensions-part-2-bigquery-magic-edc3e311fdc5?source=collection_archive---------9-----------------------#2018-07-17">https://towardsdatascience.com/productive-research-with-custom-ipython-extensions-part-2-bigquery-magic-edc3e311fdc5?source=collection_archive---------9-----------------------#2018-07-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="9b66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在完成了用于导入数据科学库的自定义 IPython 自动加载器扩展之后，我试图为自己节省更多的时间。我想通过从 IPython 查询 BigQuery 直接访问我的数据仓库中的数据。这篇博文描述了我解决这个问题的方法。我在底部添加了一个“附录”，展示了使用我的扩展对<a class="ae kl" href="https://cloud.google.com/bigquery/public-data/hacker-news" rel="noopener ugc nofollow" target="_blank"> BigQuery HackerNews 数据集</a>进行的一些示例分析。</p><p id="3c3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，我应该指出，BigQuery Python 客户端实际上内置了<a class="ae kl" href="https://googlecloudplatform.github.io/google-cloud-python/latest/_modules/google/cloud/bigquery/magics.html" rel="noopener ugc nofollow" target="_blank"> IPython 支持</a>。我在不知道这一点的情况下构建了我的扩展，但我仍然发现这个练习很有用，因为它揭开了 IPython 扩展的神秘面纱。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="a431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用<a class="ae kl" href="https://cloud.google.com/bigquery/" rel="noopener ugc nofollow" target="_blank"> Google 的 BigQuery </a>作为我的首选数据仓库；它非常健壮，速度非常快，易于使用，而且<em class="kt">性价比超高。大多数时候，我发现自己在查询 BigQuery，并使用<a class="ae kl" href="https://google-cloud-python.readthedocs.io/en/latest/bigquery/usage.html" rel="noopener ugc nofollow" target="_blank"> BigQuery 的 python 客户端库</a>将结果加载到 dataframe 中。如果我可以在 IPython 单元格中键入一个 SQL 查询，并让单元格在 BigQuery 上执行该 SQL 并将结果存储在 DataFrame 中，这不是很棒吗？我希望能够做这样的事情:</em></p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="kz la l"/></div></figure><p id="ee2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">事实证明，通过使用<strong class="jp ir">单元格魔术</strong>，在 IPython 中将 BigQuery 的 SQL 直接嵌入笔记本单元格是可能的。单元格魔术是那些看起来像<code class="fe lb lc ld le b">%%this</code>的命令，它读取整个单元格的内容并调用注册的<strong class="jp ir">魔术函数</strong>，这两个位置参数<code class="fe lb lc ld le b">line</code>和<code class="fe lb lc ld le b">cell.</code><code class="fe lb lc ld le b">line</code>包含用于调用单元格魔术的行的字符串，例如<code class="fe lb lc ld le b">%%bq</code>行。<code class="fe lb lc ld le b">cell</code>参数也是一个包含单元格其余内容的字符串，<em class="kt">不包括</em>行。<br/>如果我们以上面的例子为例，魔术函数<code class="fe lb lc ld le b">bq</code>将被调用，其中<code class="fe lb lc ld le b">"--name hn_daily_comment_counts"</code>作为<code class="fe lb lc ld le b">line</code>参数，而<code class="fe lb lc ld le b">"SELECT\n...\nday ASC;"</code>——或者初始行之后的剩余单元格的内容——作为<code class="fe lb lc ld le b">cell</code>参数。</p><p id="2295" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以将 BigQuery python 客户端与 cell magic API 一起使用，让 magic 函数查询 BigQuery 并返回结果。</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="kz la l"/></div></figure><p id="12d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你在上面看到的，我在一个<code class="fe lb lc ld le b">ResearchEnvMagics</code>类中包含了我所有的魔法(在这个例子中只有一个)。重要的是，这个类继承自 IPython 的 Magics 类，并且附加了<code class="fe lb lc ld le b">@magics_class</code>装饰器。</p><p id="5773" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还使用了 IPython 的<a class="ae kl" href="http://ipython.readthedocs.io/en/stable/api/generated/IPython.core.magic_arguments.html" rel="noopener ugc nofollow" target="_blank"> magic_arguments 包</a>，以便允许向我的 cell magic 传递额外的配置参数，类似于您在命令行上使用的。这是 IPython magics 的一个常见模式，因此他们为它提供了一个内置的包，这太棒了！</p><p id="1a56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的最后一步是通过扩展加载钩子向 IPython 注册这些 magics:</p><figure class="ku kv kw kx gt ky"><div class="bz fp l di"><div class="kz la l"/></div></figure><p id="b2b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是全部了！现在，magic 功能已注册，可以在 Jupyter 笔记本中使用，轻松进行研究并获得见解。</p><p id="306c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，在构建了这个 BigQuery magic 之后，有一天晚上我通过挖掘客户端库 API 文档发现它已经<a class="ae kl" href="https://google-cloud-python.readthedocs.io/en/latest/bigquery/generated/google.cloud.bigquery.magics.html" rel="noopener ugc nofollow" target="_blank">随 IPython magics 一起发布了</a>😑。我希望在某个地方已经记录了这一点<em class="kt">，但是我仍然喜欢构建它，并且在 IPython 中学到了很多关于细胞魔法的知识。下一步，我想弄清楚如何为 BigQuery 单元格魔术添加 SQL 语法突出显示。</em></p><p id="c21d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望您觉得这很有用，如果您在研究环境中使用特殊的定制 IPython magics，请在评论中告诉我！愿意分享信息和建议。请查看下面的内容，了解 BigQuery 的 HackerNews 数据集中一些示例查询的扩展。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lf"><img src="../Images/80a3324f6a64d3e8c9f3c3a56caf1944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hcR2EWahjw-qPHjtzTx4Ww.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">Simple example using BigQuery to display daily comment counts.</figcaption></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lq"><img src="../Images/78dd1fb30ab2aae1eb015cfa742f9508.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QaX9UKBrEy9hz89xCsfMrg.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">A more advanced example looking at comment “shocks” by taking the weekly moving average and dividing it by the weekly moving standard deviation.</figcaption></figure><figure class="ku kv kw kx gt ky gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi lr"><img src="../Images/0a0e5bc77745607adedd417a16703366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k_ArS_YXlKCy8QDIzw8Pqw.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">Cleaning, annotating, and charting the data from the previous query. Note that I used scale() above while I was examining the data in order to de-mean it. Apparently, a <a class="ae kl" href="https://news.ycombinator.com/item?id=436331" rel="noopener ugc nofollow" target="_blank">post on dealing with alienation</a> was a huge driver of comments on HackerNews around the 2008–2010 time. Very poignant, and probably deserves an article unto itself.</figcaption></figure></div></div>    
</body>
</html>