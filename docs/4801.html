<html>
<head>
<title>Famished on the Freeway: Visualizing, mapping LA restaurant inspections</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在高速公路上挨饿:可视化，映射洛杉矶餐馆检查</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/famished-on-the-freeway-visualizing-mapping-la-restaurant-inspections-cb6bc8338111?source=collection_archive---------11-----------------------#2018-09-07">https://towardsdatascience.com/famished-on-the-freeway-visualizing-mapping-la-restaurant-inspections-cb6bc8338111?source=collection_archive---------11-----------------------#2018-09-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="5289" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">使用 Python，Matplotlib，Plotly 分析，查看地图上的分级餐厅</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/e8a1e7dcb8f1f4e15a1a3f3d1dae185b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uOEUYRp12RYI9eJe"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">“pizza and nachos chip” by <a class="ae le" href="https://unsplash.com/@rpnickson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Roberto Nickson (@g)</a> on <a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="01a0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你好。我使用 Python，matplotlib，Plotly 来分析加州洛杉矶县餐馆检查结果数据集，并通过绘制 C 级餐馆来可视化。也许你可以在高速公路上(或者更有可能的是，在堵车时:)仔细阅读这些信息。以下是一个概述:</p><ul class=""><li id="c193" class="lf lg it js b jt ju jx jy kb lh kf li kj lj kn lk ll lm ln bi translated">从 ka ggle-inspections，violations 文件导入<a class="ae le" href="https://www.kaggle.com/cityofLA/la-restaurant-market-health-data" rel="noopener ugc nofollow" target="_blank">数据集</a></li><li id="5282" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">创建数据框架</li><li id="aef4" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">按违规数量、类型等进行分析、排序。</li><li id="8e12" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">分组、按等级计数、风险并以图形方式显示</li><li id="50dc" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">提取低等级(C)的餐馆及其地址</li><li id="83e2" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">从谷歌地图中获取他们的地理坐标(纬度，经度)以在地图中使用，将它们存储到[创建]地图</li><li id="3594" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">在地图上标出那些餐馆的位置</li></ul><p id="b3ae" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">开始之前:</p><ul class=""><li id="44fc" class="lf lg it js b jt ju jx jy kb lh kf li kj lj kn lk ll lm ln bi translated">确保您有 Python 编辑器或笔记本可用于分析</li><li id="1029" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">拥有一个<a class="ae le" href="https://www.wpgmaps.com/documentation/creating-a-google-maps-api-key/" rel="noopener ugc nofollow" target="_blank">谷歌地图 API </a>令牌(获取餐馆位置的坐标)</li><li id="7ee5" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated">有一个<a class="ae le" href="https://www.mapbox.com/help/define-access-token/" rel="noopener ugc nofollow" target="_blank">地图框令牌</a>(将坐标映射到地图上)</li></ul><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="d08f" class="ly lz it lu b gy ma mb l mc md">Start a new notebook file:</span><span id="5e96" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu">#TSB - Hari Santanam, 2018</strong><br/><strong class="lu iu"><em class="mf">#import tools required to run the code</em></strong><br/>from mpl_toolkits.mplot3d import Axes3D<br/>from sklearn.preprocessing import StandardScaler<br/>import matplotlib.pyplot as plt<br/>import numpy as np <br/>import os<br/>import pandas as pd <br/>import requests<br/>import logging<br/>import time<br/>import seaborn as sns</span></pre><p id="d484" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">读取两个数据集文件:</p><ul class=""><li id="4102" class="lf lg it js b jt ju jx jy kb lh kf li kj lj kn lk ll lm ln bi translated"><strong class="js iu">检查</strong>文件是所有被检查的餐厅、菜场的清单</li><li id="9962" class="lf lg it js b jt lo jx lp kb lq kf lr kj ls kn lk ll lm ln bi translated"><strong class="js iu">违规</strong>文件是发现的所有违规和相应设施的列表(一个设施可能有多个违规)</li></ul><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="a369" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#read in file with all inspections and put in dataframe</em></strong><br/>df1 = pd.read_csv('../input/restaurant-and-market-health-inspections.csv', delimiter=',')<br/>nRow, nCol = df1.shape<br/><strong class="lu iu"><em class="mf">#print number of rows and columns</em></strong><br/>print({nRow}, {nCol})</span><span id="525d" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#read in file with all health VIOLATIONS and put in dataframe</em></strong><br/>df2 = pd.read_csv('../input/restaurant-and-market-health-violations.csv')</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mg"><img src="../Images/4eef5e8cc3ab203162cde544924f9807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ey5vU4-NBNydP9TFLpS7gA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Output of file rows x columns</figcaption></figure><p id="8d07" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用原始检查分数创建一个数据框架，并绘制在直方图上:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="11da" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#Put these two lines before each plot/graph, otherwise it sometimes #re-draws over the same graph or does other odd things</em></strong></span><span id="2b34" class="ly lz it lu b gy me mb l mc md">from matplotlib import reload<br/>reload(plt)<br/>%matplotlib notebook<br/><strong class="lu iu"><em class="mf">#draw the histogram for scores</em></strong><br/>df2['score'].hist().plot()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/5e67f5dc3524597c5327e6be0e3f3170.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*A5PpMTc7L6C-5yjkAtYuWg.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Histogram for score distribution — x-axis is score value bins, y-axis is count for each value bin</figcaption></figure><p id="5d6f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为标签描述键入以下内容:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="bf92" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#search for missing grade, i.e, that is not A or B or C</em></strong><br/>df1[~df1['grade'].isin(['A','B','C'])]<br/><strong class="lu iu"><em class="mf">#one record (record # 49492) popped up, so we fix it by assigning it a grade C</em></strong><br/>df1.loc[49492,['grade']] = 'C'</span><span id="2d6f" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#find out the distribution of the grades, i.e, how many records in each grade</em></strong><em class="mf"><br/></em><strong class="lu iu"><em class="mf">#basically, group dataframe column grade by grade letter, then count and index on that, and print it</em></strong><br/>grade_distribution = df1.groupby('grade').size()<br/>pd.DataFrame({'Count of restaurant grade totals':grade_distribution.values}, index=grade_distribution.index)</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/c67a3cb9776e6cb3b12a5d987d6f6ffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*IGLBh0m0qDBZDbo5xrx3Wg.png"/></div></figure><h2 id="018b" class="ly lz it bd mj mk ml dn mm mn mo dp mp kb mq mr ms kf mt mu mv kj mw mx my mz bi translated">注意，上面的总数加起来是 58，872，这是文件中的总行数，这意味着没有没有等级的行。</h2><p id="8390" class="pw-post-body-paragraph jq jr it js b jt na jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj ne kl km kn im bi translated">按餐厅类型(座位类型)分组，并计数和绘制图表</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="4790" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#group by restaurant type and count # in each category<br/>#then sort from highest # to lowest, then create a bar graph</em></strong><br/>temp = df1.groupby('pe_description').size()<br/>description_distribution = pd.DataFrame({'Count':temp.values}, index=temp.index)<br/>description_distribution = description_distribution.sort_values(by=['Count'], ascending=True)<br/>df2['pe_description'].hist().plot()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nf"><img src="../Images/c3775f86e0b4ecf918ca59d2781680f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z_3G7uJQSoifvc2U0MrIUw.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Grouped by pe_description field (ex: “Restaurant (seats 31–60, high risk”)</figcaption></figure><p id="c2e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用原始检查分数创建一个数据框架，并绘制在直方图上:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="1905" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#the previous charts and graphs show breakdown of various types food restaurants with risk<br/>#broken down to high, medium, low.<br/>#This procedure use the split function to break the pe_description field into the sub-string<br/>#after the 2nd space from the end - ex: string x = "Aa Bb Cc", when split applied like this: x.split(' ')[-2] -&gt;sub-string after(not before) 2nd space '=&gt;Bb'</em></strong></span><span id="908e" class="ly lz it lu b gy me mb l mc md">def sub_risk(x):<br/>    return x.split(' ')[-2]<br/><strong class="lu iu"><em class="mf">#apply function to get only high, medium, low<br/></em></strong>df2['risk'] = df2['pe_description'].astype(str).apply(sub_risk)</span><span id="48ef" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#group, count by risk level</em></strong><br/>temp = df2.groupby('risk').size()                                       <strong class="lu iu"><em class="mf"><br/>#plot the histogram for the 3 levels of risk</em></strong><br/>df2['risk'].hist().plot()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/ee0b31c285ecbb833327de3dc84834a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*rew3s8C1jvvZVpCAPKILcA.jpeg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Count by Risk type (High, Medium, Low) , extracted from restaurant type field string</figcaption></figure><p id="a10b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用原始检查分数创建一个数据框架，并绘制在直方图上:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="28f6" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#show first 10 rows of the violations file dataframe </em></strong><br/>df2.head(10)<br/><strong class="lu iu"><em class="mf">#groupb by violation_description, count and sort them from largest violation by count to smallest</em></strong><br/>violation_description = df2.groupby('violation_description').size()<br/>pd.DataFrame({'Count':violation_description.values},index = violation_description.index).sort_values(by = 'Count',ascending=False)</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/b58a7e0855c5b95faa0ca697e52b61e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*nQIXA6GFGJjiel9ASXnntA.jpeg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Screen shot — Counts for each type of violation</figcaption></figure><p id="1bb7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个函数，将字符串定义的值转换为数字，并制作一个热图:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="3ad9" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#create a simple proc for heat map for risk - low, moderate, high</em></strong><br/>def convert_risk_value(x):<br/>    if x == 'LOW':<br/>        return 10<br/>    elif x == 'MODERATE':<br/>        return 5<br/>    else:<br/>        return 0<br/><strong class="lu iu"><em class="mf">#create simple proc to map grade to value </em></strong>   <br/>def convert_grade_value(x):<br/>    if x == 'A':<br/>        return 10<br/>    elif x == 'B':<br/>        return 5<br/>    else:<br/>        return 0<br/><strong class="lu iu"><em class="mf">#call (apply) procs created above    </em></strong><br/>df2['risk_value']=df2['risk'].apply(convert_risk_value)<br/>df2['grade_value']=df2['grade'].apply(convert_grade_value)<br/>df3 = df2.loc[:,['score', 'grade_value', 'risk_value']]<br/>corr = df3.corr()<br/>corr = (corr)<br/>reload(plt)<br/>%matplotlib notebook<br/>sns.heatmap(corr, xticklabels = corr.columns.values, yticklabels=corr.columns.values, cmap="Purples", center=0)</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/a3d00c618c311f600fad054f34b199db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*cDNAu0DINpB5OsRbXh3f_A.jpeg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Screen shot — Heat map — score, grade_value and risk_value</figcaption></figure><p id="4fc1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从最常见的违规开始按降序显示违规计数:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="d063" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#violations listing from most common, descending - violation description, violation code, counts</em></strong><br/>violation_desc=df2.groupby(['violation_description','violation_code']).size()<br/>pd.DataFrame({'Count':violation_desc.values}, index=violation_desc.index).sort_values(by = 'Count', ascending=False)</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nj"><img src="../Images/9c2451ce785f919cf1a79c8a81a40a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7EQZ2_uyUbNW6iLaqKfqjw.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Screen shot — Violation count by description and code</figcaption></figure><p id="de9c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">显示违规最多的设施点:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="2ba2" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#list facilities with most violations and type of violation<br/>#create a dataframe with facility and violation columns, aggregate by size, then count and sort them</em></strong><br/>violation_desc2 = df2.groupby(['facility_name','violation_description']).size()<br/>pd.DataFrame({'Count':violation_desc2.values}, index=violation_desc2.index).sort_values(by='Count', ascending=False)</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nk"><img src="../Images/376465584b40dfb8dabbaa51655603e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wEaMeUUSebWva62fJx3Jrg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Screen shot — Facilities with the most violations and type of violation</figcaption></figure><p id="d706" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">分离并提取等级为“C”的餐厅进行映射。使用 loc 函数，然后删除重复项，这样每个餐馆名称只出现一次。我们稍后将在地图中使用它。</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="10e0" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#get a list of all the restaurants with grade C</em></strong><br/>df4 = df2.loc[(df2['grade'] == 'C'),['facility_name','facility_address','facility_zip']]</span><span id="9d6e" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#only want each restaurant listed once, since many of them have multiple violations, or may be listed more than once for multiple inspections or other reasons</em></strong><br/>df4=df4.drop_duplicates(['facility_name'])</span><span id="03a4" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#print</em></strong><br/>df4</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nl"><img src="../Images/a27aa6e196568119b0dbcf274c970d26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DAiatJ0AE_KTp7-UEWnPLw.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Screen shot — list of restaurants with grade C</figcaption></figure><p id="d2d6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面，我们列出上面的地址(C 级餐馆)并添加城市和州(所有地址都相同)作为完整地址(位置#、街道、城市、州)。这是必需的，因为在国家和世界的其他地区可能有同名的街道和城镇，作为调用 google maps api 的参数，它将为我们提供地理坐标(纬度、经度),然后我们将这些坐标叠加在加利福尼亚州洛杉矶县的地图上。</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="b2a8" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#visualize bad restaurants (grade C)on a map, so that if you are in that area, you can avoid them :)</em></strong><br/><strong class="lu iu"><em class="mf">#some of them might have remediated their violations, or may be operating under "new management" or maybe even turned over a new leaf - we just don't know</em></strong><br/>addresses_to_avoid = df4['facility_address'].tolist()<br/>addresses_to_avoid = (df4['facility_name'] + ',' + df4['facility_address'] + ',' + 'LOS ANGELES' + ',CA').tolist()</span></pre><p id="ea5c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">添加一些控制台处理，一些常数:</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="2d0e" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#some logging and console handling system items</em></strong><br/>logger = logging.getLogger("root")<br/>logger.setLevel(logging.DEBUG)<br/>ch = logging.StreamHandler()      #console handler<br/>ch.setLevel(logging.DEBUG)<br/>logger.addHandler(ch)</span><span id="55dc" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#some constants for our upcoming function</em></strong><br/>address_column_name = 'facility_address'<br/>restaurant_name = 'facility_name'<br/>RETURN_FULL_RESULTS = False<br/>BACKOFF_TIME = 30                 <strong class="lu iu"><em class="mf">#for when you hit the query limit</em></strong></span><span id="abca" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#api key needed for the call to google maps -if you are wondering #what this is, you missed the 1st couple of paragraphs, please go #back and re-read</em></strong></span><span id="9e7f" class="ly lz it lu b gy me mb l mc md">API_KEY = 'your api key here'<br/>output_filename = '../output-2018.csv'     <br/><strong class="lu iu"><em class="mf">#output file stores lat,lon</em></strong></span></pre><p id="5595" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建一个函数，从上面的列表中调用每个地址，并通过调用 google maps 来获取将用于叠加在加利福尼亚州洛杉矶地图上的坐标。</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="e2bd" class="ly lz it lu b gy ma mb l mc md">logger = logging.getLogger("root")<br/>logger.setLevel(logging.DEBUG)<br/>ch = logging.StreamHandler()      #console handler<br/>ch.setLevel(logging.DEBUG)<br/>logger.addHandler(ch)</span><span id="b350" class="ly lz it lu b gy me mb l mc md">address_column_name = 'facility_address'<br/>restaurant_name = 'facility_name'<br/>RETURN_FULL_RESULTS = False<br/>BACKOFF_TIME = 30</span><span id="a910" class="ly lz it lu b gy me mb l mc md">API_KEY = 'Your API key here'<br/>output_filename = '../output-2018.csv'<br/>#print(addresses)</span><span id="9803" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#adapted from Shane Lynn - thanks</em></strong><br/>def get_google_results(address, api_key=None, return_full_response=False):<br/>    geocode_url = "<a class="ae le" href="https://maps.googleapis.com/maps/api/geocode/json?address={" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/geocode/json?address={</a>}".format(address)<br/>    if api_key is not None:<br/>        geocode_url = geocode_url + "&amp;key={}".format(api_key)<br/>        <br/>        #ping google for the results:<br/>        results = requests.get(geocode_url)<br/>        results = results.json()             <br/>        <br/>        if len(results['results']) == 0:<br/>            output = {<br/>                "formatted_address" : None,<br/>                "latitude": None,<br/>                "longitude": None,<br/>                "accuracy": None,<br/>                "google_place_id": None,<br/>                "type": None,<br/>                "postcode": None<br/>            }<br/>        else:<br/>            answer = results['results'][0]<br/>            output = {<br/>                "formatted_address" : answer.get('formatted_address'),<br/>                "latitude": answer.get('geometry').get('location').get('lat'),<br/>                "longitude": answer.get('geometry').get('location').get('lng'),<br/>                "accuracy": answer.get('geometry').get('location_type'),<br/>                "google_place_id": answer.get("place_id"),<br/>                "type": ",".join(answer.get('types')),<br/>                "postcode": ",".join([x['long_name'] for x in answer.get('address_components') <br/>                                  if 'postal_code' in x.get('types')])<br/>            }<br/>            <br/>        #append some other details<br/>        output['input_string'] = address<br/>        output['number_of_results'] = len(results['results'])<br/>        output['status'] = results.get('status')<br/>        if return_full_response is True:<br/>            output['response'] = results<br/>        <br/>        return output</span></pre><p id="5cef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">调用这个函数，如果一切顺利，它将把结果写到指定的文件中。注意:这个调用经常会遇到 Google 强加的“查询限制”,所以您要么必须手动调用它们(从文件中过滤后),要么从输出文件中删除它们。</p><pre class="kp kq kr ks gt lt lu lv lw aw lx bi"><span id="9a8d" class="ly lz it lu b gy ma mb l mc md"><strong class="lu iu"><em class="mf">#for each address in the addresses-to-avoid list, call the function we just created above, to get the coordinates, and add to a new list called results2</em></strong><br/>results2=[]<br/>for address in addresses_to_avoid:<br/>    geocode_result = get_google_results(address, API_KEY, return_full_response=RETURN_FULL_RESULTS)<br/>    results2.append(geocode_result)</span><span id="72cb" class="ly lz it lu b gy me mb l mc md"><strong class="lu iu"><em class="mf">#now, convert the list with our geo coordinates into a csv file that will be called by another program to overlay on a map.</em></strong></span><span id="bf40" class="ly lz it lu b gy me mb l mc md">pd.DataFrame(results2).to_csv('/Users/hsantanam/datascience-projects/LA-restaurant-analysis/restaurants_to_avoid.csv', encoding='utf8')</span></pre><p id="3ca6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们差不多完成了。我本可以用相同的代码创建一个函数，但是为了便于阅读和理解，我用一个新的程序创建了这个函数，这个程序为地图设置配置，从输出文件中调用我们刚才创建的地址坐标数据，并在浏览器选项卡上绘制它。这是它的输出:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6777" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是最后的结果——上面代码的可视化地图输出。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi no"><img src="../Images/b8a13bad56109c2bd1be883e09b2d344.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iz1zW_ezCK148QWNHz3txg.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Restaurants with C grade — mapped out for LA county, CA — opens in default browser, new tab</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi np"><img src="../Images/76879ce8dd44de2b5eef7e5a4b6bfc37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*aUVNZG9ifcFNI5Xd2zsOlA.jpeg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Popups with name, coordinates, address appear when you hover over any location dot</figcaption></figure><p id="09c0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢您耐心通读此文:)。你现在可能饿了——如果你碰巧在这个地区，找一家餐馆吃饭，只是不要在那些等级不好的餐馆里！</p><p id="f2c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">github 到这里的链接是<a class="ae le" href="https://github.com/HariSan1/LA-restaurant-inspections-analysis" rel="noopener ugc nofollow" target="_blank">这里是</a>。</p><p id="0971" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你感兴趣，可以看看我的其他文章:</p><div class="nq nr gp gr ns nt"><a href="https://medium.com/google-cloud/using-google-datalab-and-bigquery-for-image-classification-comparison-13b2ffb26e67" rel="noopener follow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">使用 Google Datalab 和 BigQuery 进行图像分类比较</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">样本数据，简单用法</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">medium.com</p></div></div><div class="oc l"><div class="od l oe of og oc oh ky nt"/></div></div></a></div><div class="nq nr gp gr ns nt"><a href="https://medium.com/google-cloud/using-google-cloud-ml-engine-to-train-a-regression-model-e2a582de389e" rel="noopener follow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">使用 Google Cloud ML 引擎训练回归模型</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">在 Google Cloud Datalab 中提交一个培训模型作业</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">medium.com</p></div></div><div class="oc l"><div class="oi l oe of og oc oh ky nt"/></div></div></a></div><div class="nq nr gp gr ns nt"><a href="https://medium.com/@hari.santanam/using-keras-to-predict-fashion-dataset-and-see-images-used-by-machine-learning-5f4a889fb1b0" rel="noopener follow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">使用 Keras 预测时尚数据集并查看机器学习使用的图像</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">人工智能使用图像识别学习过程来处理成千上万的图像，并“学习”哪些图像属于哪个…</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">medium.com</p></div></div><div class="oc l"><div class="oj l oe of og oc oh ky nt"/></div></div></a></div><div class="nq nr gp gr ns nt"><a href="https://medium.com/@hari.santanam/value-proposition-of-ai-for-it-1c8903c0ec25" rel="noopener follow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">人工智能对 IT 的价值主张</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">人工智能对于公司内部的大多数业务领域来说都很棒。它有望带来新的洞察力、预测和分析，这使得…</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">medium.com</p></div></div><div class="oc l"><div class="ok l oe of og oc oh ky nt"/></div></div></a></div></div></div>    
</body>
</html>