<html>
<head>
<title>How to build Animated Charts like Hans Rosling — doing it all in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何像汉斯·罗斯林一样制作动画图表——全部用 R 语言完成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-build-animated-charts-like-hans-rosling-doing-it-all-in-r-570efc6ba382?source=collection_archive---------3-----------------------#2018-05-19">https://towardsdatascience.com/how-to-build-animated-charts-like-hans-rosling-doing-it-all-in-r-570efc6ba382?source=collection_archive---------3-----------------------#2018-05-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="63a9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个学习数据可视化技能的小型教育项目，利用了两个库(gganimate 和 plot . ly)——更新了新的 gganimate 版本</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/87d95cec303cab4cb01c3e8a838a4bb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UyP_gLCCjtL-1_PJV_gDZA.jpeg"/></div></div></figure><p id="2eec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">汉斯·罗斯林是统计学大师。他毕生致力于推动使用数据和动画图表来探索发展问题，并分享基于事实的世界观。他最受欢迎的 TED 演讲:“<a class="ae ln" href="https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen" rel="noopener ugc nofollow" target="_blank">你见过的最好的统计数据</a>”点击量超过 1200 万次。这也是世界上 100 个最受欢迎的<a class="ae ln" href="https://www.ted.com/talks?sort=popular" rel="noopener ugc nofollow" target="_blank"> TED 演讲之一。</a></p><p id="4e14" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">你曾经梦想过像他的</strong> <a class="ae ln" href="https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen#t-185608" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir">最受欢迎的一张</strong> </a> <strong class="kt ir">一样免费制作动画图表吗，从零开始，不到 5 分钟，并且可以以不同的格式(gif，html 用于你的网站等)共享。)?</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/6502b02e61176c73c1832e8fe4ed8233.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*I6jyama-6XzUfdMEjzWP5w.gif"/></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk">What we will be building with gganimate ;)</figcaption></figure><p id="23e9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">本文将向您展示如何使用两种方法用 R 构建动画图表:</p><ul class=""><li id="dc8b" class="lt lu iq kt b ku kv kx ky la lv le lw li lx lm ly lz ma mb bi translated">将创建 GIF 文件的 R + gganimate 库</li><li id="cb4a" class="lt lu iq kt b ku mc kx md la me le mf li mg lm ly lz ma mb bi translated">R + plot.ly 将生成一个 HTML 文件，您可以将它嵌入到您的网站中(参见下面的 plot.ly 版本)</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/d57a85dda91b8c72b3db35423de777b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*wAnnndldzoqAQkNdb5RHWQ.png"/></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk">What we will be building with plot.ly ;)</figcaption></figure><p id="149e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">假设您已经安装了 Rstudio，并且了解一些基础知识，因为本文将只介绍生成视觉效果的步骤和代码。完整代码可从<a class="ae ln" href="https://github.com/tristanga/animatedcharts" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得，用于教育目的。</p><p id="2812" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">第一步:搜索并下载你需要的数据集</strong></p><p id="e7c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第一站是在<a class="ae ln" href="https://www.gapminder.org/data/" rel="noopener ugc nofollow" target="_blank">gapminder.com</a>下载所需的 3 个数据集。这个基金会是罗斯林家族创立的。它有奇妙的可视化和数据集，每个人都应该检查“用每个人都能理解的基于事实的世界观来战胜无知”。</p><p id="ef14" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将下载 3 个 excel 文件(xlsx):</p><ol class=""><li id="3d42" class="lt lu iq kt b ku kv kx ky la lv le lw li lx lm mi lz ma mb bi translated"><a class="ae ln" href="//docs.google.com/spreadsheet/pub?key=phAwcNAVuyj0TAlJeCEzcGQ&amp;output=xlsx" rel="noopener ugc nofollow" target="_blank">每名妇女的子女数(总生育率)</a></li><li id="4cfc" class="lt lu iq kt b ku mc kx md la me le mf li mg lm mi lz ma mb bi translated"><a class="ae ln" href="https://docs.google.com/spreadsheet/pub?key=phAwcNAVuyj0XOoBL_n5tAQ&amp;output=xlsx" rel="noopener ugc nofollow" target="_blank">人口总数</a></li><li id="44bb" class="lt lu iq kt b ku mc kx md la me le mf li mg lm mi lz ma mb bi translated"><a class="ae ln" href="https://docs.google.com/spreadsheet/pub?key=phAwcNAVuyj2tPLxKvvnNPA&amp;output=xlsx" rel="noopener ugc nofollow" target="_blank">预期寿命(年)</a></li></ol><p id="0013" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦文件被下载并保存在你的工作文件夹中，就该清理并合并数据集了。</p><p id="4969" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">第二步:清理并合并数据</strong></p><p id="a778" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">a1)用 xlsx 库加载数据(替换'..'您的文件夹旁)</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="b9ad" class="mo mp iq mk b gy mq mr l ms mt"># Please note that loading xlsx in R is really slow compared to csv</span><span id="9348" class="mo mp iq mk b gy mu mr l ms mt">library(xlsx)</span><span id="7b39" class="mo mp iq mk b gy mu mr l ms mt">population_xls &lt;- read.xlsx("indicator gapminder population.xlsx", encoding = "UTF-8",stringsAsFactors= F, sheetIndex = 1, as.data.frame = TRUE, header=TRUE)</span><span id="6fee" class="mo mp iq mk b gy mu mr l ms mt">fertility_xls &lt;- read.xlsx("indicator undata total_fertility.xlsx", encoding = "UTF-8",stringsAsFactors= F, sheetIndex = 1, as.data.frame = TRUE, header=TRUE)</span><span id="0888" class="mo mp iq mk b gy mu mr l ms mt">lifeexp_xls &lt;- read.xlsx("indicator life_expectancy_at_birth.xlsx", encoding = "UTF-8", stringsAsFactors= F, sheetIndex = 1, as.data.frame = TRUE, header=TRUE)</span></pre><p id="c07c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">a2)更新—在 R 版本 5.3+上安装 gganimate 新版本</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="8c78" class="mo mp iq mk b gy mq mr l ms mt">library(devtools)<br/>library(RCurl)<br/>library(httr)<br/>set_config( config( ssl_verifypeer = 0L ) )<br/>devtools::install_github("RcppCore/Rcpp")<br/>devtools::install_github("thomasp85/gganimate", force = TRUE)</span></pre><p id="2492" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">b)使用 reshape 和 dplyr 库清理和合并数据</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="f2e3" class="mo mp iq mk b gy mq mr l ms mt"># Load libraries<br/>library(reshape)<br/>library(gapminder)<br/>library(dplyr)<br/>library(ggplot2)</span><span id="1774" class="mo mp iq mk b gy mu mr l ms mt"># Create a variable to keep only years 1962 to 2015<br/>myvars &lt;- paste("X", 1962:2015, sep="")</span><span id="b010" class="mo mp iq mk b gy mu mr l ms mt"># Create 3 data frame with only years 1962 to 2015<br/>population &lt;- population_xls[c('Total.population',myvars)]<br/>fertility &lt;- fertility_xls[c('Total.fertility.rate',myvars)]<br/>lifeexp &lt;- lifeexp_xls[c('Life.expectancy',myvars)]</span><span id="86dd" class="mo mp iq mk b gy mu mr l ms mt"># Rename the first column as "Country"<br/>colnames(population)[1] &lt;- "Country"<br/>colnames(fertility)[1] &lt;- "Country"<br/>colnames(lifeexp)[1] &lt;- "Country"</span><span id="0b76" class="mo mp iq mk b gy mu mr l ms mt"># Remove empty lines that were created keeping only 275 countries<br/>lifeexp &lt;- lifeexp[1:275,]<br/>population &lt;- population[1:275,]</span><span id="fbf2" class="mo mp iq mk b gy mu mr l ms mt"># Use reshape library to move the year dimension as a column<br/>population_m &lt;- melt(population, id=c("Country")) <br/>lifeexp_m &lt;- melt(lifeexp, id=c("Country")) <br/>fertility_m &lt;- melt(fertility, id=c("Country"))</span><span id="371c" class="mo mp iq mk b gy mu mr l ms mt"># Give a different name to each KPI (e.g. pop, life, fert)<br/>colnames(population_m)[3] &lt;- "pop"<br/>colnames(lifeexp_m)[3] &lt;- "life"<br/>colnames(fertility_m)[3] &lt;- "fert"</span><span id="0261" class="mo mp iq mk b gy mu mr l ms mt"># Merge the 3 data frames into one<br/>mydf &lt;- merge(lifeexp_m, fertility_m, by=c("Country","variable"), header =T)<br/>mydf &lt;- merge(mydf, population_m, by=c("Country","variable"), header =T)</span><span id="08fe" class="mo mp iq mk b gy mu mr l ms mt"># The only piece of the puzzle missing is the continent name for each country for the color - use gapminder library to bring it<br/>continent &lt;- gapminder %&gt;% group_by(continent, country) %&gt;% distinct(country, continent)<br/>continent &lt;- data.frame(lapply(continent, as.character), stringsAsFactors=FALSE)<br/>colnames(continent)[1] &lt;- "Country"</span><span id="7545" class="mo mp iq mk b gy mu mr l ms mt"># Filter out all countries that do not exist in the continent table<br/>mydf_filter &lt;- mydf %&gt;% filter(Country %in% unique(continent$Country))</span><span id="3a13" class="mo mp iq mk b gy mu mr l ms mt"># Add the continent column to finalize the data set<br/>mydf_filter &lt;- merge(mydf_filter, continent, by=c("Country"), header =T)</span><span id="a739" class="mo mp iq mk b gy mu mr l ms mt"># Do some extra cleaning (e.g. remove N/A lines, remove factors, and convert KPIs into numerical values)<br/>mydf_filter[is.na(mydf_filter)] &lt;- 0<br/>mydf_filter &lt;- data.frame(lapply(mydf_filter, as.character), stringsAsFactors=FALSE)<br/>mydf_filter$variable &lt;- as.integer(as.character(gsub("X","",mydf_filter$variable)))<br/>colnames(mydf_filter)[colnames(mydf_filter)=="variable"] &lt;- "year"<br/>mydf_filter$pop &lt;- round(as.numeric(as.character(mydf_filter$pop))/1000000,1)<br/>mydf_filter$fert &lt;- as.numeric(as.character(mydf_filter$fert))<br/>mydf_filter$life &lt;- as.numeric(as.character(mydf_filter$life))</span></pre><p id="c223" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">第三步——升级到新版 gganimate:用 gganimate 构建图表并生成 GIF 文件与你的朋友分享</strong></p><p id="1b2b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们有了一个包含 3 个 KPI(人口、生育率和预期寿命)和 3 个维度(国家、年份、洲)的清晰数据集，我们可以用 gganimate 生成可视化效果。</p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="e9d6" class="mo mp iq mk b gy mq mr l ms mt"># Load libraries<br/>library(ggplot2)<br/>library(gganimate)<br/>#library(gifski)<br/>#library(png)</span><span id="03cc" class="mo mp iq mk b gy mu mr l ms mt"># Add a global theme<br/>theme_set(theme_grey()+ theme(legend.box.background = element_rect(),legend.box.margin = margin(6, 6, 6, 6)) )</span><span id="9b48" class="mo mp iq mk b gy mu mr l ms mt"># OLD VERSION<br/># Create the plot with years as frame, limiting y axis from 30 years to 100<br/># p &lt;- ggplot(mydf_filter, aes(fert, life, size = pop, color = continent, frame = variable)) +<br/>#  geom_point()+ ylim(30,100)  + labs(x="Fertility Rate", y = "Life expectancy at birth (years)", caption = "(Based on data from Hans Rosling - gapminder.com)", color = 'Continent',size = "Population (millions)") + <br/>#  scale_color_brewer(type = 'div', palette = 'Spectral') <br/># gganimate(p, interval = .2, "output.gif")</span><span id="bec5" class="mo mp iq mk b gy mu mr l ms mt"># NEW VERSION</span><span id="6a58" class="mo mp iq mk b gy mu mr l ms mt"># Create the plot with years as frame, limiting y axis from 30 years to 100<br/>p &lt;- ggplot(mydf_filter, aes(fert, life, size = pop, color = continent, frame = year)) +<br/>  labs(x="Fertility Rate", y = "Life expectancy at birth (years)", caption = "(Based on data from Hans Rosling - gapminder.com)", color = 'Continent',size = "Population (millions)") + <br/>  ylim(30,100) +<br/>  geom_point() +<br/>  scale_color_brewer(type = 'div', palette = 'Spectral') + <br/>  # gganimate code<br/>  ggtitle("Year: {frame_time}") +<br/>  transition_time(year) +<br/>  ease_aes("linear") +<br/>  enter_fade() +<br/>  exit_fade()</span><span id="2014" class="mo mp iq mk b gy mu mr l ms mt"># animate<br/>animate(p, width = 450, height = 450)</span><span id="d142" class="mo mp iq mk b gy mu mr l ms mt"># save as a GIF<br/>anim_save("output.gif")</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/6502b02e61176c73c1832e8fe4ed8233.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*I6jyama-6XzUfdMEjzWP5w.gif"/></div></figure><p id="59e5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在你可以享受你当之无愧的 GIF 动画，并与你的朋友分享。</p><p id="7020" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">第四步:用 plot.ly 构建图表并生成一个 HTML 文件嵌入你的网站</strong></p><pre class="kg kh ki kj gt mj mk ml mm aw mn bi"><span id="2cf3" class="mo mp iq mk b gy mq mr l ms mt"># Load libraries<br/>library(plotly)<br/>library(ggplot2)</span><span id="f92f" class="mo mp iq mk b gy mu mr l ms mt"># Create the plot<br/>p &lt;- ggplot(mydf_filter, aes(fert, life, size = pop, color = continent, frame = year)) +<br/>  geom_point()+ ylim(30,100)  + labs(x="Fertility Rate", y = "Life expectancy at birth (years)", color = 'Continent',size = "Population (millions)") + <br/>  scale_color_brewer(type = 'div', palette = 'Spectral')</span><span id="9d0d" class="mo mp iq mk b gy mu mr l ms mt"># Generate the Visual and a HTML output<br/>ggp &lt;- ggplotly(p, height = 900, width = 900) %&gt;%<br/>  animation_opts(frame = 100,<br/>                 easing = "linear",<br/>                 redraw = FALSE)<br/>ggp<br/>htmlwidgets::saveWidget(ggp, "index.html")</span></pre><p id="d4ba" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">代码可在<a class="ae ln" href="https://github.com/tristanga/animatedcharts" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得。感谢你阅读我的帖子，如果你喜欢，请鼓掌。如果你想在你的组织内制作动画图表，请随时联系我。</p><p id="b127" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">其他有趣的链接，了解有关 R 动画图表的更多信息:</p><div class="mv mw gp gr mx my"><a href="https://www.gapminder.org/about-gapminder/" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">了解关于 Gapminder 的更多信息</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">Gapminder 是一个独立的瑞典基金会，没有任何政治、宗教或经济背景。Gapminder 是一个…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">www.gapminder.org</p></div></div></div></a></div><div class="mv mw gp gr mx my"><a href="https://github.com/dgrtwo/gganimate/blob/master/README.md" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">dgrtwo/gganimate</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">用 ggplot2 创建简单的动画</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">github.com</p></div></div></div></a></div><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure></div></div>    
</body>
</html>