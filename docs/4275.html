<html>
<head>
<title>How to do serverless machine learning with scikit-learn on Google Cloud ML Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 scikit 进行无服务器机器学习-在 Google Cloud ML 引擎上学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-do-serverless-machine-learning-with-scikit-learn-on-google-cloud-ml-engine-db26dcc558a2?source=collection_archive---------9-----------------------#2018-08-03">https://towardsdatascience.com/how-to-do-serverless-machine-learning-with-scikit-learn-on-google-cloud-ml-engine-db26dcc558a2?source=collection_archive---------9-----------------------#2018-08-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3d40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在 Google 云平台上，Cloud ML Engine 提供无服务器的机器学习，用于训练、超参数优化和预测。直到最近，这还只是针对 TensorFlow 的。不过最近，该团队已经为 scikit-learn 实现了所有三种功能。在这篇文章中，我将带它兜一圈。</p><p id="da79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">问题是在给定一些怀孕信息的情况下预测婴儿的体重。这是我用 TensorFlow 端到端解决的一个问题，在我为 GCP NEXT 2018 开发的训练营中。现在让我来谈谈 scikit-learn。跟着我一起看看 GitHub 上的这个<a class="ae kl" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/sklearn/babyweight_skl.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter 笔记本。</a></p><h1 id="7f03" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">输入数据，从 BigQuery 到 Pandas</h1><p id="0754" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">输入数据在 BigQuery 中，我将整个数据集的 1/1000 放入熊猫数据帧:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="0275" class="ly kn iq lu b gy lz ma l mb mc"><strong class="lu ir">def</strong> query_to_dataframe(query):<br/>  <strong class="lu ir">import</strong> <strong class="lu ir">pandas</strong> <strong class="lu ir">as</strong> <strong class="lu ir">pd</strong><br/>  <strong class="lu ir">import</strong> <strong class="lu ir">pkgutil</strong><br/>  privatekey = pkgutil.get_data(KEYDIR, 'privatekey.json')<br/>  <strong class="lu ir">print</strong>(privatekey[:200])<br/>  <strong class="lu ir">return</strong> pd.read_gbq(query,<br/>                     project_id=PROJECT,<br/>                     dialect='standard',<br/>                     private_key=privatekey)<br/><br/><strong class="lu ir">def</strong> create_dataframes(frac):  <br/>  <em class="md"># small dataset to fit into memory</em><br/>  <strong class="lu ir">if</strong> frac &gt; 0 <strong class="lu ir">and</strong> frac &lt; 1:<br/>    sample = " AND RAND() &lt; {}".format(frac)<br/>  <strong class="lu ir">else</strong>:<br/>    sample = ""<br/><br/>  train_query, eval_query = create_queries()<br/>  train_query = "{} {}".format(train_query, sample)<br/>  eval_query =  "{} {}".format(eval_query, sample)<br/><br/>  train_df = query_to_dataframe(train_query)<br/>  eval_df = query_to_dataframe(eval_query)<br/>  <strong class="lu ir">return</strong> train_df, eval_df</span><span id="d97c" class="ly kn iq lu b gy me ma l mb mc">train_df, eval_df = create_dataframes(0.001)</span></pre><p id="d04d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我使用较大的虚拟机，就有可能使用完整的数据集，我将在最后一步进行服务培训时这样做。然而，对于开发模型来说，拥有一个小的数据集是很有帮助的。</p><h1 id="4f97" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">培训 sci kit-学习模型</h1><p id="333c" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">为了训练模型，我首先编写了一个函数来获取用于训练的 x 和 y(我将它们称为特征和标签):</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="df51" class="ly kn iq lu b gy lz ma l mb mc"><strong class="lu ir">def</strong> input_fn(indf):<br/>  <strong class="lu ir">import</strong> <strong class="lu ir">copy</strong><br/>  <strong class="lu ir">import</strong> <strong class="lu ir">pandas</strong> <strong class="lu ir">as</strong> <strong class="lu ir">pd</strong><br/>  df = copy.deepcopy(indf)<br/><br/>  <em class="md"># one-hot encode the categorical columns</em><br/>  df["plurality"] = df["plurality"].astype(pd.api.types.CategoricalDtype(<br/>                    categories=["Single","Multiple","1","2","3","4","5"]))<br/>  df["is_male"] = df["is_male"].astype(pd.api.types.CategoricalDtype(<br/>                  categories=["Unknown","false","true"]))<br/>  <em class="md"># features, label</em><br/>  label = df['label']<br/>  <strong class="lu ir">del</strong> df['label']<br/>  features = pd.get_dummies(df)<br/>  <strong class="lu ir">return</strong> features, label</span></pre><p id="a9c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我创建了一个 RandomForestRegressor，并将 x 和 y 传递给它的 fit()方法:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="b746" class="ly kn iq lu b gy lz ma l mb mc"><strong class="lu ir">from</strong> <strong class="lu ir">sklearn.ensemble</strong> <strong class="lu ir">import</strong> RandomForestRegressor<br/>estimator = RandomForestRegressor(max_depth=5, n_estimators=100, random_state=0)<br/>estimator.fit(train_x, train_y)</span></pre><p id="1450" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过在评估数据帧上调用 predict()并计算 RMSE，可以评估模型的性能:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="a04f" class="ly kn iq lu b gy lz ma l mb mc"><strong class="lu ir">import</strong> <strong class="lu ir">numpy</strong> <strong class="lu ir">as</strong> <strong class="lu ir">np</strong><br/>eval_x, eval_y = input_fn(eval_df)<br/>eval_pred = estimator.predict(eval_x)<br/><strong class="lu ir">print</strong>(eval_pred[1000:1005])<br/><strong class="lu ir">print</strong>(eval_y[1000:1005])<br/><strong class="lu ir">print</strong>(np.sqrt(np.mean((eval_pred-eval_y)*(eval_pred-eval_y))))</span></pre><h1 id="c76a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">将教练打包成一个包</h1><p id="1741" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">代码运行后，我将以下 Jupyter 魔术添加到笔记本的单元格中，将单元格写出到 Python 文件中:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="c216" class="ly kn iq lu b gy lz ma l mb mc"><em class="md">#%writefile -a babyweight/trainer/model.py</em></span></pre><p id="5c2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还将许多硬编码的数字(比如随机森林中的树的数量)作为命令行参数。通过让它们成为命令行参数，我可以对它们进行超参数调优。</p><p id="c05b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在本地测试了这个包，仍然是在 1/1000 的数据集上:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="ec77" class="ly kn iq lu b gy lz ma l mb mc">%bash<br/>export PYTHONPATH=${PYTHONPATH}:${PWD}/babyweight<br/>python -m trainer.task \<br/>   --bucket=${BUCKET} --frac=0.001 --job-dir=gs://${BUCKET}/babyweight/sklearn --projectId $PROJECT</span></pre><h1 id="7dad" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">无服务器培训</h1><p id="0e96" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">关于 Cloud ML Engine 的培训就像提交 Python 包一样简单:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e51a" class="ly kn iq lu b gy lz ma l mb mc">RUNTIME_VERSION="1.8"<br/>PYTHON_VERSION="2.7"<br/>JOB_NAME=babyweight_skl_$(date +"%Y%m<strong class="lu ir">%d</strong>_%H%M%S")<br/>JOB_DIR="gs://$BUCKET/babyweight/sklearn/${JOBNAME}"<br/><br/>gcloud ml-engine jobs submit training $JOB_NAME \<br/>  --job-dir $JOB_DIR \<br/>  --package-path $(pwd)/babyweight/trainer \<br/>  --module-name trainer.task \<br/>  --region us-central1 \<br/>  --runtime-version=$RUNTIME_VERSION \<br/>  --python-version=$PYTHON_VERSION \<br/>  -- \<br/>  --bucket=${BUCKET} --frac=0.1 --projectId $PROJECT</span></pre><p id="dac0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一次，我在全部数据集的 1/10 上进行训练。为了在完整数据集上训练，我需要一台更大的机器。我可以通过更改为自定义层来做到这一点:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="200b" class="ly kn iq lu b gy lz ma l mb mc">%writefile largemachine.yaml<br/>trainingInput:<br/>  scaleTier: CUSTOM<br/>  masterType: large_model</span></pre><p id="2ad1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并传入上面的配置文件:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="edcf" class="ly kn iq lu b gy lz ma l mb mc">RUNTIME_VERSION="1.8"<br/>PYTHON_VERSION="2.7"<br/>JOB_NAME=babyweight_skl_$(date +"%Y%m<strong class="lu ir">%d</strong>_%H%M%S")<br/>JOB_DIR="gs://$BUCKET/babyweight/sklearn/${JOBNAME}"<br/><br/>gcloud ml-engine jobs submit training $JOB_NAME \<br/>  --job-dir $JOB_DIR \<br/>  --package-path $(pwd)/babyweight/trainer \<br/>  --module-name trainer.task \<br/>  --region us-central1 \<br/>  --runtime-version=$RUNTIME_VERSION \<br/>  --python-version=$PYTHON_VERSION \<br/>  --scale-tier=CUSTOM \<br/>  --config=largemachine.yaml \<br/>  -- \<br/>  --bucket=${BUCKET} --frac=1 --projectId $PROJECT --maxDepth 8 --numTrees 90</span></pre><p id="bd02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我如何获得最大深度和最大树数？为此，我做了超参数调整。</p><h1 id="bc02" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">超参数调谐</h1><p id="ef73" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">对于 ML 引擎中的超参数调整，在评估后写出一个摘要度量。这是代码，假设您有一个名为 rmse 的变量，它保存最终的评估度量:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="193c" class="ly kn iq lu b gy lz ma l mb mc">## this is for hyperparameter tuning<br/>hpt = hypertune.HyperTune()<br/>hpt.report_hyperparameter_tuning_metric(<br/>    hyperparameter_metric_tag=’rmse’,<br/>    metric_value=rmse,<br/>    global_step=0)</span></pre><p id="daec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要提交超参数优化作业，请使用要优化的参数编写一个配置文件:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="049a" class="ly kn iq lu b gy lz ma l mb mc">%writefile hyperparam.yaml<br/>trainingInput:<br/>  hyperparameters:<br/>    goal: MINIMIZE<br/>    maxTrials: 100<br/>    maxParallelTrials: 5<br/>    hyperparameterMetricTag: rmse<br/>    params:<br/>    - parameterName: maxDepth<br/>      type: INTEGER<br/>      minValue: 2<br/>      maxValue: 8<br/>      scaleType: UNIT_LINEAR_SCALE<br/>    - parameterName: numTrees<br/>      type: INTEGER<br/>      minValue: 50<br/>      maxValue: 150<br/>      scaleType: UNIT_LINEAR_SCALE</span></pre><p id="4d96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，通过以下方式将其传递给 ML 引擎:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="dbf6" class="ly kn iq lu b gy lz ma l mb mc">--config=hyperparam.yaml</span></pre><p id="dd4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">试验的输出将开始填充，如果您查看 GCP web 控制台，将会列出具有最低 RMSE 的试验及其运行时参数。</p><h1 id="1be7" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">部署模型</h1><p id="0f4e" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">经过培训后，可以部署 scitkit 学习模型:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="8adb" class="ly kn iq lu b gy lz ma l mb mc">gcloud alpha ml-engine versions create ${MODEL_VERSION} --model ${MODEL_NAME} --origin ${MODEL_LOCATION} \<br/>    --framework SCIKIT_LEARN --runtime-version 1.8  --python-version=2.7</span></pre><p id="17af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署的模型有一个端点，您可以访问它来获得预测:</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="694b" class="ly kn iq lu b gy lz ma l mb mc"><strong class="lu ir">from</strong> <strong class="lu ir">googleapiclient</strong> <strong class="lu ir">import</strong> discovery<br/><strong class="lu ir">from</strong> <strong class="lu ir">oauth2client.client</strong> <strong class="lu ir">import</strong> GoogleCredentials<br/><strong class="lu ir">import</strong> <strong class="lu ir">json</strong><br/><br/>credentials = GoogleCredentials.get_application_default()<br/>api = discovery.build('ml', 'v1', credentials=credentials)<br/><br/>request_data = {'instances':<br/>  <em class="md"># [u'mother_age', u'gestation_weeks', u'is_male_Unknown', u'is_male_0',</em><br/>  <em class="md">#     u'is_male_1', u'plurality_Single', u'plurality_Multiple',</em><br/>  <em class="md">#     u'plurality_1', u'plurality_2', u'plurality_3', u'plurality_4',</em><br/>  <em class="md">#     u'plurality_5']</em><br/>  [[24, 38, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0], <br/>   [34, 39, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0]]<br/>}<br/><br/>parent = 'projects/<strong class="lu ir">%s</strong>/models/<strong class="lu ir">%s</strong>/versions/<strong class="lu ir">%s</strong>' % (PROJECT, 'babyweight', 'skl')<br/>response = api.projects().predict(body=request_data, name=parent).execute()<br/><strong class="lu ir">print</strong> "response={0}".format(response)</span></pre><p id="33f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前，请求必须是文本行的形式，并且必须是预处理的数据。自然，这就对 scikit-learn 模型的可操作性提出了一些警告。</p><p id="032b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再说一遍，我的<a class="ae kl" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/sklearn/babyweight_skl.ipynb" rel="noopener ugc nofollow" target="_blank">完整代码在 GitHub </a>上。编码快乐！</p></div></div>    
</body>
</html>