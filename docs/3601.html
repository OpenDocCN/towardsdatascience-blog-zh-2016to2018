<html>
<head>
<title>How to enable Pandas to access BigQuery from a service account</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何让 Pandas 从服务帐户访问 BigQuery</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-enable-pandas-to-access-bigquery-from-a-service-account-205a216f0f68?source=collection_archive---------7-----------------------#2018-05-29">https://towardsdatascience.com/how-to-enable-pandas-to-access-bigquery-from-a-service-account-205a216f0f68?source=collection_archive---------7-----------------------#2018-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b315" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务账户是一种严格控制你的应用程序在谷歌云平台上做什么的方式。您通常希望应用程序对组织资源的访问受到严格限制，而不是使用您的用户帐户拥有的所有权限来运行应用程序。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ed63814cd6d0839a460d899f01352ced.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dxc_EVJIk1RJcMKlbnR3-g.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">How to use a private key in a service account to access BigQuery from Pandas</figcaption></figure><p id="306d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您希望 Pandas 针对 BigQuery 运行一个查询。您可以使用熊猫的<a class="ae lb" href="https://pandas.pydata.org/pandas-docs/version/0.21/generated/pandas.read_gbq.html" rel="noopener ugc nofollow" target="_blank"> read_gbq(在 pandas-gbq 包中提供):</a></p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="a5ff" class="lh li iq ld b gy lj lk l ll lm">import pandas as pd</span><span id="7d0c" class="lh li iq ld b gy ln lk l ll lm">query = """<br/>SELECT<br/>  year,<br/>  COUNT(1) as num_babies<br/>FROM<br/>  publicdata.samples.natality<br/>WHERE<br/>  year &gt; 2000<br/>GROUP BY<br/>  year<br/>"""</span><span id="28b9" class="lh li iq ld b gy ln lk l ll lm">df = pd.read_gbq(query,<br/>                     project_id='MY_PROJECT_ID',<br/>                     dialect='standard')</span><span id="5317" class="lh li iq ld b gy ln lk l ll lm"><br/>print(df.head())</span></pre><p id="084d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您在本地运行它，这将会起作用(因为它使用您的身份，并且假设您有能力在您的项目中运行查询)。</p><p id="7a83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果您尝试从一个基本帐户运行上面的代码，它将不起作用。您将被要求通过一个 OAuth2 工作流来专门授权该应用程序。为什么？因为您不希望一个任意的应用程序运行一个 BigQuery 账单(或者更糟，访问您的公司数据)，所以您必须为它提供所需的权限。</p><p id="4892" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们试一试。</p><h1 id="ac11" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">1.创建 GCE 实例</h1><p id="d277" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">要跟随我，使用 GCP web 控制台并创建一个具有默认访问权限的 Google 计算引擎实例(这通常只包括最基本的内容，不包括对 BigQuery 的访问权限):</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mq"><img src="../Images/4a88e04cd4538bb716689d4a9a97cddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ZSRjtPOuXsQ9ZM99U3VhA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">Creating a Google Compute Engine instance with restricted access</figcaption></figure><h1 id="3f8e" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">2.创建一个准系统服务帐户</h1><p id="c8fd" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">从 GCP web 控制台，创建一个新的服务帐户。这是您将为其生成私钥的帐户。为了额外的安全性和审计，我建议为每个应用程序创建一个全新的服务帐户，并且不要在应用程序之间重用服务帐户。</p><p id="c22a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进入 IAM &amp; Admin，选择“服务帐户”,然后点击+创建服务帐户。按如下方式填写表格:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/32d9032b78ab7d55689ca5dfa51da3c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*cUtwX0zPiORMBvKvxpP4Yg.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">Creating a barebones service account for Pandas</figcaption></figure><p id="8203" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述角色允许服务帐户运行查询，并将这些查询记入项目。但是，数据集所有者仍然需要允许服务帐户查看他们的数据集。</p><p id="2b40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您使用非公共的 BigQuery 数据集，请通过转到 BigQuery 控制台并与服务帐户的电子邮件地址共享数据集，授予服务帐户对该数据集的适当(通常只是查看)访问权限。出于本教程的目的，我将使用一个公共的 BigQuery 数据集，所以我们可以跳过这一步。</p><h1 id="479a" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">3.将示例代码放在 GCE 实例上</h1><p id="d125" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">SSH 到 GCE 实例，并在命令行中键入以下命令:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="aec2" class="lh li iq ld b gy lj lk l ll lm">sudo apt-get install -y git python-pip</span><span id="c026" class="lh li iq ld b gy ln lk l ll lm">git clone <a class="ae lb" href="https://github.com/GoogleCloudPlatform/training-data-analyst" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/training-data-analyst</a></span><span id="a001" class="lh li iq ld b gy ln lk l ll lm">sudo pip install pandas-gbq==0.4.1</span></pre><h1 id="e460" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">4.不使用默认凭据运行</h1><p id="5a5a" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">更改<a class="ae lb" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/pandas-pvtkey/nokey_query.py" rel="noopener ugc nofollow" target="_blank"> nokey_query.py </a>中的项目 id，然后运行它:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="f9dd" class="lh li iq ld b gy lj lk l ll lm">cd training-data-analyst/blogs/pandas-pvtkey</span><span id="0dfb" class="lh li iq ld b gy ln lk l ll lm"># EDIT nokey_query.py to set the PROJECT ID</span><span id="2512" class="lh li iq ld b gy ln lk l ll lm">python nokey_query.py</span></pre><p id="917e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它将要求您完成一个 OAuth2 工作流。按 Ctrl-C 退出。您不希望此应用程序使用*您的*凭据运行。</p><p id="e6d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">遇到这种错误时，您会听到一个常见的建议，那就是运行:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="1ad7" class="lh li iq ld b gy lj lk l ll lm"># BAD IDEA! DO NOT DO THIS<br/>gcloud auth application-default login</span></pre><p id="f154" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并在启动应用程序之前在 shell 中完成交互式 OAuth 2 工作流。要小心这样做:(1)上面的命令是一个火箭筒，允许应用程序做你能做的任何事情。(2)不可脚本化。每次运行应用程序时，您都必须这样做。</p><p id="d436" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最好的方法是创建计算引擎虚拟机，不是使用最基本的服务帐户，而是使用您已经授予 BigQuery 查看器权限的服务帐户。换句话说，交换步骤 1 和 2，当您创建 GCE 实例时，使用新创建的服务帐户。</p><p id="3e65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果您不在 GCP 上(因此您的机器不是由服务帐户 auth 创建的)或者您正在使用云数据流或云 ML 引擎等托管服务(因此虚拟机是由该服务的服务帐户创建的)，该怎么办呢？在这种情况下，更好的方法是按如下方式更改熊猫代码:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="aafc" class="lh li iq ld b gy lj lk l ll lm">    df = pd.read_gbq(query,<br/>                     project_id='MY_PROJECT_ID',<br/>                    <strong class="ld ir"> private_key='path_to/privatekey.json',</strong><br/>                     dialect='standard',<br/>                     verbose=False)</span></pre><p id="efde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序现在将使用与该私钥相关联的权限。</p><h1 id="39bc" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">5.不使用私钥运行</h1><p id="5892" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">在<a class="ae lb" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/blogs/pandas-pvtkey/query.py" rel="noopener ugc nofollow" target="_blank"> query.py </a>中更改项目 id，然后运行它:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="4e6b" class="lh li iq ld b gy lj lk l ll lm">cd training-data-analyst/blogs/pandas-pvtkey</span><span id="cc22" class="lh li iq ld b gy ln lk l ll lm"># EDIT query.py to set the PROJECT ID</span><span id="5323" class="lh li iq ld b gy ln lk l ll lm">python query.py </span></pre><p id="3a46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它会失败，说找不到私钥</p><h1 id="2349" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">6.为服务帐户生成私钥</h1><p id="c333" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">还记得在创建服务帐户时创建了一个 JSON 私有密钥吗？你需要把它上传到 GCE 虚拟机。(如果您没有创建密钥文件，请导航到 IAM &gt;服务帐户，并为 pandas 服务帐户创建一个私钥。这将创建一个 JSON 文件，并将其下载到您的本地计算机。您也可以从这里撤销密钥。)</p><p id="5bf8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在 SSH 窗口的右上角，有一个上传文件的方法。将生成的 JSON 文件上传到 GCE 实例，并将其移动到位:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="8cdd" class="lh li iq ld b gy lj lk l ll lm">mv ~/*.json trainer/privatekey.json</span></pre><h1 id="1024" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">7.用私钥运行</h1><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="cef7" class="lh li iq ld b gy lj lk l ll lm">python query.py</span></pre><p id="b696" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在它可以工作了，您将得到查询的结果。</p><h1 id="d9d2" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">8.将私钥放入 Python 包中</h1><p id="fe23" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">如果您没有使用 GCE，而是使用托管服务(云数据流、云 ML 引擎等),该怎么办？)反而？</p><p id="934f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这种情况下，您将提交一个 Python 包。使用 package_data 属性在 setup.py 中将私钥标记为资源:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="1add" class="lh li iq ld b gy lj lk l ll lm">from setuptools import setup</span><span id="e62f" class="lh li iq ld b gy ln lk l ll lm">setup(name='trainer',<br/>      version='1.0',<br/>      description='Showing how to use private key',<br/>      url='<a class="ae lb" href="http://github.com/GoogleCloudPlatform/training-data-analyst'" rel="noopener ugc nofollow" target="_blank">http://github.com/GoogleCloudPlatform/training-data-analyst'</a>,<br/>      author='Google',<br/>      <a class="ae lb" href="mailto:author_email='nobody@google.com" rel="noopener ugc nofollow" target="_blank">author_email='nobody@google.com</a>',<br/>      license='Apache2',<br/>      packages=['trainer'],<br/>      <strong class="ld ir">## WARNING! Do not upload this package to PyPI<br/>      ## BECAUSE it contains a private key</strong><br/>      <strong class="ld ir">package_data={'trainer': ['privatekey.json']},</strong><br/>      install_requires=[<br/>          'pandas-gbq==0.4.1',<br/>          'urllib3',<br/>          'google-cloud-bigquery'<br/>      ],<br/>      zip_safe=False)</span></pre><p id="0e21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，执行以下操作，而不是硬编码 privatekey.json 文件的路径:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="ebe4" class="lh li iq ld b gy lj lk l ll lm">private_key = pkgutil.get_data('trainer', 'privatekey.json')</span></pre><p id="adb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有一个<a class="ae lb" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/sklearn" rel="noopener ugc nofollow" target="_blank">更完整的例子</a>。注意 Python 没有将包标记为私有的方法，所以您应该小心不要错误地将这个包发布在公共存储库中，比如 PyPI。</p><h1 id="ab47" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">9.保护私钥</h1><p id="0b83" class="pw-post-body-paragraph jn jo iq jp b jq ml js jt ju mm jw jx jy mn ka kb kc mo ke kf kg mp ki kj kk ij bi translated">私钥实质上为提供它的任何人解锁了已经可用的资源。在这种情况下，任何提供私钥的人都可以进行 BigQuery 查询。没有第二种形式的身份验证(IP 地址、用户登录、硬件令牌等)。)是必需的。因此，要注意如何/在哪里存储私钥。我的建议是:</p><p id="4c7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(1)确保 Python 包中有一个显式忽略私钥的. gitignore:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="7919" class="lh li iq ld b gy lj lk l ll lm">$cat trainer/.gitignore<br/>privatekey.json</span></pre><p id="822a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(2)使用<a class="ae lb" href="https://github.com/awslabs/git-secrets" rel="noopener ugc nofollow" target="_blank"> git 秘密</a>来帮助防止密钥泄漏</p><p id="b627" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(3)旋转你的钥匙。详见本<a class="ae lb" href="https://cloudplatform.googleblog.com/2017/07/help-keep-your-Google-Cloud-service-account-keys-safe.html?m=1" rel="noopener ugc nofollow" target="_blank">博客</a>。</p><p id="d0cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(4)确保不要将 Python 包发布到任何 Python 包的存储库中，因为您的存储库中包含私钥。</p><h1 id="0da3" class="lo li iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">摘要</h1><ul class=""><li id="2a2c" class="ms mt iq jp b jq ml ju mm jy mu kc mv kg mw kk mx my mz na bi translated">使用 JSON private_key 属性来限制 Pandas 代码对 BigQuery 的访问。</li><li id="0b7a" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">创建具有准系统权限的服务帐户</li><li id="5689" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">与服务帐户共享特定的 BigQuery 数据集</li><li id="e54f" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">为服务帐户生成私钥</li><li id="e0f3" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">将私钥上传到 GCE 实例或将私钥添加到可提交的 Python 包中</li><li id="ac12" class="ms mt iq jp b jq nb ju nc jy nd kc ne kg nf kk mx my mz na bi translated">确保不要将私钥签入代码或包存储库中。使用密钥旋转器和 git 机密。</li></ul><p id="0e7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是 GitHub 中这篇文章的<a class="ae lb" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/pandas-pvtkey" rel="noopener ugc nofollow" target="_blank">示例代码。编码快乐！</a></p><p id="98a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">鸣谢:感谢我的同事 Tim Swast 和 Grace Mollison 的帮助和建议。文章中的任何错误都是我自己的。</p></div></div>    
</body>
</html>