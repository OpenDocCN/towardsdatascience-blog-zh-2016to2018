<html>
<head>
<title>Trading Strategy: Back testing with Backtrader</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">交易策略:用 Backtrader 进行回溯测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/trading-strategy-back-testing-with-backtrader-6c173f29e37f?source=collection_archive---------5-----------------------#2018-08-13">https://towardsdatascience.com/trading-strategy-back-testing-with-backtrader-6c173f29e37f?source=collection_archive---------5-----------------------#2018-08-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4d710d8591b4c85df137d6fdca23ca7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8l5ftTfMjM03HzEH"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by <a class="ae kf" href="https://unsplash.com/@chrisliverani?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Chris Liverani</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9ce5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">(我的<a class="ae kf" href="https://kylelix7.github.io/Back-testing-with-Backtrader/" rel="noopener ugc nofollow" target="_blank">博客</a>里也有这个帖子)</p><p id="8364" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我的一篇<a class="ae kf" href="https://medium.com/@kyle.jinhai.li/trading-strategy-technical-analysis-with-python-ta-lib-3ce9d6ce5614" rel="noopener">旧文章</a>中，我演示了如何计算技术指标，这些指标可以逻辑地结合起来建立交易策略。正如帖子中所强调的，在将策略应用于实际市场之前，应该先验证策略在回溯测试中的表现。</p><blockquote class="le lf lg"><p id="0d90" class="kg kh lh ki b kj kk kl km kn ko kp kq li ks kt ku lj kw kx ky lk la lb lc ld im bi translated">回溯测试是将交易策略或分析方法应用于历史数据的过程，以查看该策略或方法预测实际结果的准确性。<br/> -摘自<a class="ae kf" href="https://investinganswers.com/financial-dictionary/stock-market/backtesting-865" rel="noopener ugc nofollow" target="_blank">投资答案</a></p></blockquote><p id="f044" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">回溯测试就像机器学习中的交叉验证。但也不完全一样。回溯测试需要像交叉验证一样将数据分成两部分。一套用于训练，另一套用于验证。不同的是，训练测试分割可以随机进行交叉验证。在交易回溯测试中，你的数据是时间序列。您的训练数据必须比您的测试数据旧。否则你会偷窥未来，导致对你的策略的不正确衡量。因此，在回溯测试中，数据集的分割不能是随机的。回溯测试涉及真实世界中的市场模拟。实现自己的回溯测试库可能很难，而且容易出错。幸运的是，还有反向交易者。</p><p id="4d38" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Backtrader 是一个非常棒的开源 python 框架，它可以让你专注于编写可重用的交易策略、指标和分析工具，而不是花时间构建基础设施。它还支持回溯测试，让你评估自己想出的策略！</p><p id="3404" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">也就是说，这是一个免费的完整的技术人员建立自己的策略的解决方案。让我们开始浏览一下。</p><h2 id="81dd" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">安装和设置</h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0501" class="ll lm it mj b gy mn mo l mp mq">pip install backtrader[plotting]</span></pre><h2 id="7129" class="ll lm it bd ln lo lp dn lq lr ls dp lt kr lu lv lw kv lx ly lz kz ma mb mc md bi translated">制定战略</h2><p id="90d0" class="pw-post-body-paragraph kg kh it ki b kj mr kl km kn ms kp kq kr mt kt ku kv mu kx ky kz mv lb lc ld im bi translated">Backtrader 为您定义了一个<a class="ae kf" href="https://www.backtrader.com/docu/strategy.html" rel="noopener ugc nofollow" target="_blank">策略</a>界面。您需要创建一个实现此接口的类。一个重要的方法是 next()，你应该根据某一天的技术指标来决定是买进、卖出还是什么都不做。一个简单的策略是这样的。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5094" class="ll lm it mj b gy mn mo l mp mq"><strong class="mj iu">import </strong>backtrader <strong class="mj iu">as </strong>bt<strong class="mj iu"><br/>class</strong> <strong class="mj iu">MyStrategy</strong>(bt.Strategy):<br/><br/>    <strong class="mj iu">def</strong> __init__(self):<br/>        self.sma = bt.indicators.SimpleMovingAverage(period=15)<br/><br/>    <strong class="mj iu">def</strong> next(self):<br/>        <strong class="mj iu">if</strong> self.sma &gt; self.data.close:<br/>            <em class="lh"># Do something</em><br/>            <strong class="mj iu">pass</strong><br/><br/>        <strong class="mj iu">elif</strong> self.sma &lt; self.data.close:<br/>            <em class="lh"># Do something else</em><br/>            <strong class="mj iu">pass</strong></span></pre><p id="78c6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如你所见，backtrader 附带了一套通用的技术指标。意味着你不需要在你自己或 TA lib 上回复来计算技术指标。</p><p id="44d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Backtrader 还提供模拟市场交易的功能。Once 可以在您的交易操作中根据美元或百分比计算佣金。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="10be" class="ll lm it mj b gy mn mo l mp mq">cerebro.broker.setcommission(commission=0.001) </span></pre><p id="f410" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是用脸书历史市场数据进行回溯测试的完整示例。注意，历史交易数据是从<a class="ae kf" href="https://finance.yahoo.com/quote/FB/history?p=FB&amp;.tsrc=fin-srch-v1" rel="noopener ugc nofollow" target="_blank">雅虎财经</a>下载的。它还支持<a class="ae kf" href="https://www.backtrader.com/docu/pandas-datafeed/pandas-datafeed.html" rel="noopener ugc nofollow" target="_blank">熊猫数据帧</a>。我有一个关于收集熊猫<a class="ae kf" href="https://medium.com/@kyle.jinhai.li/collect-trading-data-with-pandas-library-8904659f2122" rel="noopener">交易数据的帖子。这个例子由一个简单的 TestStrategy 和一段启动回溯测试的驱动代码组成。简单策略只考虑买入/卖出信号的 RSI。你应该为你选择的股票添加更多的逻辑。</a></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="36ff" class="ll lm it mj b gy mn mo l mp mq"><strong class="mj iu">from </strong>__future__ <strong class="mj iu">import </strong>(absolute_import, division, print_function,<br/>                        unicode_literals)<br/><br/><strong class="mj iu">import </strong>datetime<br/><strong class="mj iu">import </strong>os.path<br/><strong class="mj iu">import </strong>sys<br/><strong class="mj iu">import </strong>backtrader <strong class="mj iu">as </strong>bt<br/><em class="lh"><br/></em><strong class="mj iu">class </strong>TestStrategy(bt.Strategy):<br/>    <strong class="mj iu">def </strong>log(self, txt, dt=<strong class="mj iu">None</strong>):<br/>        dt = dt <strong class="mj iu">or </strong>self.datas[0].datetime.date(0)<br/>        print(<strong class="mj iu">'%s, %s' </strong>% (dt.isoformat(), txt))<br/><br/>    <strong class="mj iu">def </strong>__init__(self):<br/>        self.dataclose = self.datas[0].close<br/>        self.order = <strong class="mj iu">None<br/>        </strong>self.buyprice = <strong class="mj iu">None<br/>        </strong>self.buycomm = <strong class="mj iu">None<br/><br/>        </strong>self.sma = bt.indicators.SimpleMovingAverage(self.datas[0], period=15)<br/>        self.rsi = bt.indicators.RelativeStrengthIndex()<br/><br/>    <strong class="mj iu">def </strong>notify_order(self, order):<br/>        <strong class="mj iu">if </strong>order.status <strong class="mj iu">in </strong>[order.Submitted, order.Accepted]:<br/>            <strong class="mj iu">return<br/><br/>        if </strong>order.status <strong class="mj iu">in </strong>[order.Completed]:<br/>            <strong class="mj iu">if </strong>order.isbuy():<br/>                self.log(<br/>                    <strong class="mj iu">'BUY EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f' </strong>%<br/>                    (order.executed.price,<br/>                     order.executed.value,<br/>                     order.executed.comm))<br/><br/>                self.buyprice = order.executed.price<br/>                self.buycomm = order.executed.comm<br/>            <strong class="mj iu">else</strong>:  <em class="lh"># Sell<br/>                </em>self.log(<strong class="mj iu">'SELL EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f' </strong>%<br/>                         (order.executed.price,<br/>                          order.executed.value,<br/>                          order.executed.comm))<br/><br/>            self.bar_executed = len(self)<br/><br/>        <strong class="mj iu">elif </strong>order.status <strong class="mj iu">in </strong>[order.Canceled, order.Margin, order.Rejected]:<br/>            self.log(<strong class="mj iu">'Order Canceled/Margin/Rejected'</strong>)<br/><br/>        <em class="lh"># Write down: no pending order<br/>        </em>self.order = <strong class="mj iu">None<br/><br/>    def </strong>notify_trade(self, trade):<br/>        <strong class="mj iu">if not </strong>trade.isclosed:<br/>            <strong class="mj iu">return<br/><br/>        </strong>self.log(<strong class="mj iu">'OPERATION PROFIT, GROSS %.2f, NET %.2f' </strong>%<br/>                 (trade.pnl, trade.pnlcomm))<br/><br/>    <strong class="mj iu">def </strong>next(self):<br/>        self.log(<strong class="mj iu">'Close, %.2f' </strong>% self.dataclose[0])<br/>        print(<strong class="mj iu">'rsi:'</strong>, self.rsi[0])<br/>        <strong class="mj iu">if </strong>self.order:<br/>            <strong class="mj iu">return<br/><br/>        if not </strong>self.position:<br/>            <strong class="mj iu">if </strong>(self.rsi[0] &lt; 30):<br/>                self.log(<strong class="mj iu">'BUY CREATE, %.2f' </strong>% self.dataclose[0])<br/>                self.order = self.buy(size=500)<br/><br/>        <strong class="mj iu">else</strong>:<br/>            <strong class="mj iu">if </strong>(self.rsi[0] &gt; 70):<br/>                self.log(<strong class="mj iu">'SELL CREATE, %.2f' </strong>% self.dataclose[0])<br/>                self.order = self.sell(size=500)<br/><br/><br/><strong class="mj iu">if </strong>__name__ == <strong class="mj iu">'__main__'</strong>:<br/>    cerebro = bt.Cerebro()<br/>    cerebro.addstrategy(TestStrategy)<br/>    cerebro.broker.setcommission(commission=0.001)<br/><br/>    datapath = <strong class="mj iu">'FB.csv'<br/><br/>    </strong><em class="lh"># Create a Data Feed<br/>    </em>data = bt.feeds.YahooFinanceCSVData(<br/>        dataname=datapath,<br/>        fromdate=datetime.datetime(2013, 1, 1),<br/>        todate=datetime.datetime(2018, 8, 5),<br/>        reverse=<strong class="mj iu">True</strong>)<br/><br/>    cerebro.adddata(data)<br/>    cerebro.broker.setcash(100000.0)<br/>    print(<strong class="mj iu">'Starting Portfolio Value: %.2f' </strong>% cerebro.broker.getvalue())<br/>    cerebro.run()<br/>    print(<strong class="mj iu">'Final Portfolio Value: %.2f' </strong>% cerebro.broker.getvalue())<br/>    cerebro.plot()</span></pre><p id="52de" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在执行结束时，你可以找出你的投资组合的最终价值。此外，你还可以根据时间绘制股票价格、技术指标、你的买入/卖出操作和你的投资组合价值。</p><figure class="me mf mg mh gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/0f9cb22a6f17189fafd20d36e538d6c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2sahspHlViQ38jnH5eaBvA.png"/></div></div></figure><p id="c053" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">正如你所看到的，这个简单的策略对 FB 很有效，因为它抓住了一些买卖机会。</p><p id="e2b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是 backtrader 的回溯测试。如果你想深入了解，我建议你访问<a class="ae kf" href="https://www.backtrader.com/docu/introduction.html" rel="noopener ugc nofollow" target="_blank"> backtrader 的文档</a>了解更多高级用法。如果你想了解更多关于机器学习的知识，在 educative.io 网站上有一系列<a class="ae kf" href="https://www.educative.io/profile/view/6083138522447872?aff=VEzk" rel="noopener ugc nofollow" target="_blank">有用的课程。这些课程包括像基本的 ML，NLP，图像识别等主题。编码和交易快乐！</a></p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><p id="905e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">推荐阅读:</p><p id="394e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.amazon.com/gp/product/1492032646/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1492032646&amp;linkCode=as2&amp;tag=blog023b-20&amp;linkId=e6994d31d10e7ac4d35d9889cfe5622e" rel="noopener ugc nofollow" target="_blank">动手机器学习</a></p><p id="b268" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.amazon.com/gp/product/1491957662/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1491957662&amp;linkCode=as2&amp;tag=blog023b-20&amp;linkId=be0bbd6ab4fd578397d9c14facc76911" rel="noopener ugc nofollow" target="_blank">用于数据分析的 Python:与 Pandas、NumPy 和 IPython 的数据争论</a></p><p id="4898" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.amazon.com/gp/product/1631570897/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1631570897&amp;linkCode=as2&amp;tag=blog023b-20&amp;linkId=d7bb68173b008df1b500073e3a8d054e" rel="noopener ugc nofollow" target="_blank">对冲基金真正在做什么</a></p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><p id="1643" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的帖子:</p><p id="f7ff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://medium.com/@fin.techology/my-posts-about-faang-interview-20e529c5f13f?source=your_stories_page---------------------------" rel="noopener">我关于 FAANG 访谈的帖子</a></p><p id="d431" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://bit.ly/3bBOjtJ" rel="noopener ugc nofollow" target="_blank">我的 YouTube 频道</a></p><p id="77e2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://medium.com/@fin.techology/my-posts-about-finance-and-tech-7b7e6b2e57f4?source=your_stories_page---------------------------" rel="noopener">我关于金融和科技的帖子</a></p><p id="728e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://medium.com/@fin.techology/from-crud-app-dev-to-sde-in-voice-assistant-my-ongoing-journey-to-ml-4ea11ec4966e?" rel="noopener">从 CRUD web 应用开发到语音助手中的 SDE——我正在进行的机器学习之旅</a></p><p id="1f93" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" rel="noopener" target="_blank" href="/full-stack-development-tutorial-integrate-aws-lambda-serverless-service-into-angular-spa-abb70bcf417f">全栈开发教程:将 AWS Lambda 无服务器服务集成到 Angular SPA 中</a></p><p id="3e4f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" rel="noopener" target="_blank" href="/full-stack-development-tutorial-serverless-rest-api-running-on-aws-lambda-a9a501f54405">全栈开发教程:用运行在 AWS Lambda 上的无服务器 REST API 提供交易数据</a></p><p id="7991" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" rel="noopener" target="_blank" href="/full-stack-development-tutorial-visualize-trading-data-on-angular-spa-7ec2a5749a38">全栈开发教程:在 Angular SPA 上可视化交易数据</a></p><p id="4d4c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://medium.com/@kyle.jinhai.li/reinforcement-learning-introduction-to-q-learning-444c951e292c" rel="noopener">强化学习:Q 学习简介</a></p></div></div>    
</body>
</html>