<html>
<head>
<title>Ad Demand Forecast with Catboost &amp; LightGBM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用 Catboost 和 LightGBM 进行广告需求预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ad-demand-forecast-with-catboost-lightgbm-819e5073cd3e?source=collection_archive---------11-----------------------#2018-12-31">https://towardsdatascience.com/ad-demand-forecast-with-catboost-lightgbm-819e5073cd3e?source=collection_archive---------11-----------------------#2018-12-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/9316fac062b4d3c119c111cadbc1fdfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0iICLV1PG5wG-kAgqECjsw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Photo credit: Pixabay</figcaption></figure><div class=""/><div class=""><h2 id="a28b" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">预测在线分类广告的需求，特征工程</h2></div><p id="456f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">Avito.ru 是一个俄罗斯分类广告网站，有出售一般商品、工作、房地产、个人、出售汽车和服务等板块。</p><p id="2748" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">它是俄罗斯最受欢迎的分类广告网站，也是仅次于 Craigslist 和中国网站 58.com 的世界第三大分类广告网站。2016 年 12 月，它的独立月访问量超过 3500 万。平均而言，Avito.ru 的用户每天发布超过 500，000 条新广告，整体广告约为 3，000 万个活跃列表。</p><p id="6cf3" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们希望帮助 Avito.ru 根据在线广告的特征(如类别、标题、图像、上下文(发布的地理位置)以及在类似上下文中对类似广告的历史需求)来预测对在线广告的需求。有了这些信息，Avito 可以通知卖家如何最好地优化他们的列表，并提供一些他们实际上应该期望收到多少兴趣的指示。</p><h1 id="77c8" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">数据</h1><p id="c769" class="pw-post-body-paragraph ku kv jf kw b kx mj kg kz la mk kj lc ld ml lf lg lh mm lj lk ll mn ln lo lp ij bi translated">训练数据包含以下特征:</p><ul class=""><li id="5b1c" class="mo mp jf kw b kx ky la lb ld mq lh mr ll ms lp mt mu mv mw bi translated"><code class="fe mx my mz na b">item_id</code> -广告 id。</li><li id="f998" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">user_id</code> -用户 id。</li><li id="2462" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">region</code>——公元地区。</li><li id="d205" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">city</code> - Ad 城。</li><li id="f0c3" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">parent_category_name</code>-Avito 广告模型分类的顶级广告类别。</li><li id="a7df" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">category_name</code>-Avito 广告模型分类的精细颗粒广告类别。</li><li id="3d55" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">【Avito 广告模型的可选参数。</li><li id="6114" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">【Avito 广告模型的可选参数。</li><li id="34d7" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">【Avito 广告模型的可选参数。</li><li id="14ec" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">title</code> -广告标题。</li><li id="e0ba" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">description</code> -广告描述。</li><li id="1b7c" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">price</code> -广告价格。</li><li id="4310" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">item_seq_number</code> -用户的广告序列号。</li><li id="822e" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">activation_date</code> -投放广告的日期。</li><li id="c420" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">user_type</code> -用户类型。</li><li id="fe86" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">image</code> -图像的 Id 代码。绑定到 train_jpg 中的 jpg 文件。不是每个广告都有图像。</li><li id="6fb1" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">image_top_1</code> - Avito 对图像的分类代码。</li><li id="8cf1" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">deal_probability</code> -目标变量。这是一个广告实际卖出东西的可能性。这个特性的值可以是从零到一的任意浮点数。</li></ul><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="a1ee" class="no ls jf na b gy np nq l nr ns">df = pd.read_csv('train_avito.csv', parse_dates = ['activation_date'])<br/>df.head()</span></pre><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nt"><img src="../Images/9bb4d17e8153d789492ed68283ab5b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQB3EvPb_QuhUVD8VPbm7A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 1</figcaption></figure><p id="28c7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">由于<code class="fe mx my mz na b">deal_probability</code>是我们的目标变量，我们想更详细地研究它。</p><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="828c" class="no ls jf na b gy np nq l nr ns">import seaborn as sns<br/>import matplotlib.pyplot as plt<br/>pd.set_option('display.float_format', '{:.2f}'.format)<br/>plt.figure(figsize = (10, 4))<br/>n, bins, patches = plt.hist(df['deal_probability'], 100, facecolor='blue', alpha=0.75)<br/>plt.xlabel('Ad price')<br/>plt.xlim(0, 1)<br/>plt.title('Histogram of deal probability')<br/>plt.show();</span></pre><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nu"><img src="../Images/811a093525b483a8ee2d879d911ad8bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oN627fsh3YBLpZiYSzHEhw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 2</figcaption></figure><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="d985" class="no ls jf na b gy np nq l nr ns">plt.figure(figsize = (10, 4))<br/>plt.scatter(range(df.shape[0]), np.sort(df['deal_probability'].values))<br/>plt.xlabel('index')<br/>plt.ylabel('deal probability')<br/>plt.title("Deal Probability Distribution")<br/>plt.show();</span></pre><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nv"><img src="../Images/78a78b9c15c6cd217386fc6a15203115.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wFD4FciLWu1zFcNcwKFJig.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 3</figcaption></figure><p id="6745" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">几乎一百万个广告的概率为 0，这意味着它没有卖出任何东西，很少有广告的概率为 1，这意味着它确实卖出了一些东西。其他广告的概率在 0 到 1 之间。</p><h1 id="3f4d" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">CatBoost</h1><p id="835b" class="pw-post-body-paragraph ku kv jf kw b kx mj kg kz la mk kj lc ld ml lf lg lh mm lj lk ll mn ln lo lp ij bi translated">由<a class="ae lq" href="https://research.yandex.com/" rel="noopener ugc nofollow" target="_blank"> Yandex </a>研究人员和工程师开发的 CatBoost 是一种在决策树上使用梯度推进的机器学习算法。它是一个开源库。听了很多关于 CatBoost 的好东西，我们应该试一试。</p><h2 id="194c" class="no ls jf bd lt nw nx dn lx ny nz dp mb ld oa ob md lh oc od mf ll oe of mh og bi translated">特征工程</h2><p id="f70f" class="pw-post-body-paragraph ku kv jf kw b kx mj kg kz la mk kj lc ld ml lf lg lh mm lj lk ll mn ln lo lp ij bi translated"><strong class="kw jg">缺失值</strong></p><p id="96ae" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">以下是要素中缺失值的数量。</p><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="3cf5" class="no ls jf na b gy np nq l nr ns">null_value_stats = df.isnull().sum()<br/>null_value_stats[null_value_stats != 0]</span></pre><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oh"><img src="../Images/69ce9a1028c3444aec9626350f12d816.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/1*5-pvOiJJqhwi-9J79DcJPA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 4</figcaption></figure><p id="cfa1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们决定用-999 来填充这些缺失值，通过从它们的分布中填充缺失值，模型将能够很容易地区分它们并将其考虑在内。</p><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="f197" class="no ls jf na b gy np nq l nr ns">df.fillna(-999, inplace=True)</span></pre><p id="ce72" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">日期时间特征</strong></p><p id="7838" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在删除此列之前，我们使用原始的<code class="fe mx my mz na b">activation_date</code>列创建了几个新的日期时间特性。</p><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="095b" class="no ls jf na b gy np nq l nr ns">df['year'] = df['activation_date'].dt.year<br/>df['day_of_year'] = df['activation_date'].dt.dayofyear<br/>df['weekday'] = f['activation_date'].dt.weekday<br/>df['week_of_year'] = df['activation_date'].dt.week<br/>df['day_of_month'] = df['activation_date'].dt.day<br/>df['quarter'] = df['activation_date'].dt.quarter</span><span id="c3a7" class="no ls jf na b gy oi nq l nr ns">df.drop('activation_date', axis=1, inplace=True)</span></pre><p id="91d8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们的特征有不同的类型——一些是数字的，一些是分类的，还有一些是文本的，比如<code class="fe mx my mz na b">title</code>和<code class="fe mx my mz na b">description</code>，我们可以把这些文本特征当作分类特征。</p><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="7715" class="no ls jf na b gy np nq l nr ns">categorical = ['item_id', 'user_id', 'region', 'city', 'parent_category_name', 'category_name', 'param_1', 'param_2', 'param_3', 'title', 'description', 'item_seq_number', 'user_type', 'image', 'image_top_1']</span></pre><p id="3166" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们不需要对分类特征进行编码。CatBoost 支持数字和分类特征。然而，我们确实需要确定分类特征指数。</p><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="70f5" class="no ls jf na b gy np nq l nr ns">X = df.drop('deal_probability', axis=1)<br/>y = df.deal_probability</span><span id="05cf" class="no ls jf na b gy oi nq l nr ns">def column_index(df, query_cols):<br/>    cols = df.columns.values<br/>    sidx = np.argsort(cols)<br/>    return sidx[np.searchsorted(cols, query_cols, sorter=sidx)]</span><span id="e952" class="no ls jf na b gy oi nq l nr ns">categorical_features_indices = column_index(X, categorical)</span></pre><h2 id="a3f7" class="no ls jf bd lt nw nx dn lx ny nz dp mb ld oa ob md lh oc od mf ll oe of mh og bi translated">CatBoost 模型训练</h2><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="348e" class="no ls jf na b gy np nq l nr ns">X_train, X_valid, y_train, y_valid = train_test_split(<br/>    X, y, test_size=0.25, random_state=42)</span><span id="9310" class="no ls jf na b gy oi nq l nr ns">model=CatBoostRegressor(iterations=50, depth=3, learning_rate=0.1, loss_function='RMSE')<br/>model.fit(X_train, y_train,cat_features=categorical_features_indices,eval_set=(X_valid, y_valid),plot=True);</span></pre><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oj"><img src="../Images/8d01c07cbbd8f36d8fca8aaf3a45a61c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_d0PJgq118Lt_K0k_lOdAg.png"/></div></div></figure><figure class="ng nh ni nj gt is gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/48b27b0af2f09dfbaa35c24999fa4db9.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*wj5-SPMD49lIJMJCmazKUQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 6</figcaption></figure><p id="3712" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一个基本模型给出了一个公平的解决方案，训练和测试误差几乎是同步的。我们将尝试调整模型参数和功能来改善结果。</p><h2 id="447c" class="no ls jf bd lt nw nx dn lx ny nz dp mb ld oa ob md lh oc od mf ll oe of mh og bi translated">CatBoost 模型调整</h2><ul class=""><li id="467d" class="mo mp jf kw b kx mj la mk ld ol lh om ll on lp mt mu mv mw bi translated"><code class="fe mx my mz na b">iterations</code>是解决机器学习问题时可以建立的最大树数。</li><li id="274b" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">learning_rate</code>用于减少梯度步长。</li><li id="36d8" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">depth</code>是树的深度。使用 CPU 时，最大为 16 的任何整数。</li><li id="818b" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">我们用公制计算 RMSE。</li><li id="7a2e" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">bagging_temperature</code>定义贝叶斯自举的设置，值越高，装袋越积极。我们不希望它太高。</li><li id="c948" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">我们将使用过拟合检测器，因此，如果发生过拟合，CatBoost 可以在训练参数指示之前停止训练。过拟合检测器的类型是“Iter”。</li><li id="ce25" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">metric_period</code>是计算目标和指标值的迭代频率。</li><li id="a32b" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">od_wait</code>，认为模型过拟合，从具有最优度量值的迭代开始，在指定的迭代次数(100)后停止训练。</li><li id="1ad8" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">eval_set</code>是用于过拟合检测器、最佳迭代选择和监控指标变化的验证数据集。</li><li id="a40d" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">use_best_model=True</code>如果输入了一个验证集(定义了<code class="fe mx my mz na b">eval_set</code>参数),并且该集中至少有一个对象的标签值与其他不同。</li></ul><figure class="ng nh ni nj gt is"><div class="bz fp l di"><div class="oo op l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">CatBoost.py</figcaption></figure><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oq"><img src="../Images/bbf0fd91c547937ac634bf7e78e9a879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kqEkkK1CdxSPfZM1gWjBTg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 7</figcaption></figure><h2 id="1a64" class="no ls jf bd lt nw nx dn lx ny nz dp mb ld oa ob md lh oc od mf ll oe of mh og bi translated">CatBoost 功能重要性</h2><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="cd0b" class="no ls jf na b gy np nq l nr ns">fea_imp = pd.DataFrame({'imp': model.feature_importances_, 'col': X.columns})<br/>fea_imp = fea_imp.sort_values(['imp', 'col'], ascending=[True, False]).iloc[-30:]<br/>fea_imp.plot(kind='barh', x='col', y='imp', figsize=(10, 7), legend=None)<br/>plt.title('CatBoost - Feature Importance')<br/>plt.ylabel('Features')<br/>plt.xlabel('Importance');</span></pre><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/b456dfca3f964b70d5faca23d6f2fc76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ul90vRy1caPLV37XbiPBCg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 8</figcaption></figure><p id="19b8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">CatBoost 功能重要性排名的结果显示，属性“价格”对交易概率的影响最大。另一方面，日期时间特征对交易概率的影响很小。</p><h1 id="8be1" class="lr ls jf bd lt lu lv lw lx ly lz ma mb kl mc km md ko me kp mf kr mg ks mh mi bi translated">LightGBM</h1><p id="fe5b" class="pw-post-body-paragraph ku kv jf kw b kx mj kg kz la mk kj lc ld ml lf lg lh mm lj lk ll mn ln lo lp ij bi translated"><a class="ae lq" href="https://lightgbm.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> LightGBM </a>是一个基于决策树算法的快速、分布式、高性能梯度提升框架。它隶属于微软的 DMTK 项目。</p><p id="43c1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们将训练一个<a class="ae lq" href="https://github.com/Microsoft/LightGBM" rel="noopener ugc nofollow" target="_blank"> LightGBM </a>模型来预测交易概率。我们将经历与训练 CatBoost 模型时相似的特征工程过程，此外，我们还将对分类特征进行编码。</p><h2 id="3966" class="no ls jf bd lt nw nx dn lx ny nz dp mb ld oa ob md lh oc od mf ll oe of mh og bi translated">特征工程</h2><figure class="ng nh ni nj gt is"><div class="bz fp l di"><div class="oo op l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">lightGBM_feature_engineering.py</figcaption></figure><p id="23b6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">将数据转换为 LightGBM 数据集格式。这是 LightGBM 培训的必修内容。</p><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="b09d" class="no ls jf na b gy np nq l nr ns">X_train, X_valid, y_train, y_valid = train_test_split(<br/>    X, y, test_size=0.25, random_state=42)<br/>    <br/># LightGBM dataset formatting <br/>lgtrain = lgb.Dataset(X_train, y_train,<br/>                feature_name=feature_names,<br/>                categorical_feature = categorical)<br/>lgvalid = lgb.Dataset(X_valid, y_valid,<br/>                feature_name=feature_names,<br/>                categorical_feature = categorical)</span></pre><h2 id="b775" class="no ls jf bd lt nw nx dn lx ny nz dp mb ld oa ob md lh oc od mf ll oe of mh og bi translated">LightGBM 模型训练</h2><ul class=""><li id="19fa" class="mo mp jf kw b kx mj la mk ld ol lh om ll on lp mt mu mv mw bi translated"><code class="fe mx my mz na b">num_leaves</code>是控制树模型复杂度的主要参数。当试图调整<code class="fe mx my mz na b">num_leaves</code>时，我们应该让它小于<code class="fe mx my mz na b">2^(max_depth)</code> (225)。</li><li id="5c6b" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">我们使用<code class="fe mx my mz na b">max_depth</code>来限制深树的生长。</li><li id="fe42" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">为了更精确，我们用大的<code class="fe mx my mz na b">num_iterations</code>代替小的<code class="fe mx my mz na b">learning_rate</code>。</li><li id="83a6" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">为了加快训练速度和处理过拟合，我们设置了<code class="fe mx my mz na b">feature_fraction=0.6</code>，即在训练每棵树之前选择 60%的特征。</li><li id="df40" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated">Set <code class="fe mx my mz na b">verbosity = -1</code>，eval set 上的 eval metric 在每个详细增强阶段打印。</li><li id="a741" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">early_stopping_rounds = 500</code>，模型将进行训练，直到验证分数停止提高。验证分数需要至少每 500 轮提高一次才能继续训练。</li><li id="dec0" class="mo mp jf kw b kx nb la nc ld nd lh ne ll nf lp mt mu mv mw bi translated"><code class="fe mx my mz na b">verbose_eval = 500</code>，每 500 个升压阶段打印一个评估指标。</li></ul><figure class="ng nh ni nj gt is"><div class="bz fp l di"><div class="oo op l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">lightGBM_model_training.py</figcaption></figure><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi os"><img src="../Images/e21b3d4c40ca9a0a29b3ef1b68375f2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zztJec7AivujAp3G2Vjxjw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 8</figcaption></figure><h2 id="a9b9" class="no ls jf bd lt nw nx dn lx ny nz dp mb ld oa ob md lh oc od mf ll oe of mh og bi translated">LightGBM 功能重要性</h2><pre class="ng nh ni nj gt nk na nl nm aw nn bi"><span id="a33c" class="no ls jf na b gy np nq l nr ns">fig, ax = plt.subplots(figsize=(10, 7))<br/>lgb.plot_importance(lgb_clf, max_num_features=30, ax=ax)<br/>plt.title("LightGBM - Feature Importance");</span></pre><figure class="ng nh ni nj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ot"><img src="../Images/921bcd4571fd126fcce2abbfac8e6a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DlotUquDbGDPrLkBNJ-t0Q.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 9</figcaption></figure><p id="e697" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">看到价格仍然处于最高水平并不奇怪。有趣的是，在 lightGBM 模型中,<code class="fe mx my mz na b">item_seq_number</code>对交易概率的影响最大，但在 CatBoost 模型中，它仅是第 12 个特征。</p><p id="404d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">今天就到这里，<a class="ae lq" href="https://github.com/susanli2016/Machine-Learning-with-Python/blob/master/Ad%20Demand%20Forecast%20Avito.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter 笔记本</a>可以在<a class="ae lq" href="https://github.com/susanli2016/Machine-Learning-with-Python/blob/master/Ad%20Demand%20Forecast%20Avito.ipynb" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。新年快乐</p><p id="750d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">参考:<a class="ae lq" href="https://www.kaggle.com/c/avito-demand-prediction" rel="noopener ugc nofollow" target="_blank">卡格尔</a></p></div></div>    
</body>
</html>