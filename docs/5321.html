<html>
<head>
<title>Implementing Auto-complete with Postgres and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Postgres 和 Python 实现自动完成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/implementing-auto-complete-with-postgres-and-python-e03d34824079?source=collection_archive---------5-----------------------#2018-10-11">https://towardsdatascience.com/implementing-auto-complete-with-postgres-and-python-e03d34824079?source=collection_archive---------5-----------------------#2018-10-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b55001ed55dd0890e96ffcc09e3d94e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2rWfiNi7QfUIi_UOpwtNPA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">(linguistics something linguistics) Photo by <a class="ae kc" href="https://unsplash.com/@skylargereld?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Skyler Gerald</a> on <a class="ae kc" href="https://unsplash.com/s/photos/linguistics?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="790c" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">介绍</h1><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/c2247cc3c1c6b61fd78b3b93b9bc3810.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ReXlX3_9Fh2QrRhrbO5OiQ.gif"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">No, she hasn’t learned Python yet. © alphabet inc</figcaption></figure><p id="3882" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">如果没有某种自动完成功能，搜索引擎看起来几乎是不完整的。这里有一个从头构建你自己的自动完成的快速指南。我们将使用 Python，Postgres 和 Spacy。弹性搜索是 Postgres 的一个非常好的替代品，但是对于不涉及数百万行的简单任务，Postgres 尽管没有内存能力，但也不算太差。<a class="ae kc" href="https://db-engines.com/en/system/Elasticsearch;PostgreSQL" rel="noopener ugc nofollow" target="_blank">这里的</a>是一篇强调两者区别的有趣文章。</p><p id="8c66" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">我们将遵循的流程概述:</p><ul class=""><li id="aab0" class="me mf iq li b lj lk ln lo lr mg lv mh lz mi md mj mk ml mm bi translated">处理文本数据以提取搜索时弹出的相关短语。</li><li id="fd43" class="me mf iq li b lj mn ln mo lr mp lv mq lz mr md mj mk ml mm bi translated">将这些数据存储在搜索优化的实体化视图中。</li><li id="8f68" class="me mf iq li b lj mn ln mo lr mp lv mq lz mr md mj mk ml mm bi translated">创建相关索引。</li><li id="c221" class="me mf iq li b lj mn ln mo lr mp lv mq lz mr md mj mk ml mm bi translated">查询该视图并解析自动完成的结果。</li></ul><h1 id="846d" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">提取关键短语</h1><p id="fa09" class="pw-post-body-paragraph lg lh iq li b lj ms ll lm ln mt lp lq lr mu lt lu lv mv lx ly lz mw mb mc md ij bi translated"><a class="ae kc" href="https://spacy.io/" rel="noopener ugc nofollow" target="_blank"> Spacy </a>提供了一个工业级的文本解析框架。我们将使用它从文本中提取名词块。代码就像这样简单:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Extraction of noun chunks</figcaption></figure><p id="e44b" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">此外，您可以使用 Python 的<code class="fe mz na nb nc b">Counter</code>来计算这些短语的频率，用于排名和其他目的。下面的代码片段还显示了一个 pg 查询，用于在数据库中插入这些短语，并在发生冲突时采取必要的措施。在我们的例子中，我们通过添加新发现的短语来更新现有短语的频率。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Storing the noun chunks</figcaption></figure><p id="8610" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">对于事务性目的，表更适合。我们将把这个表的精选版本放入一个物化视图，用于分析任务，比如搜索。</p><h1 id="f6a3" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">物化视图</h1><p id="9963" class="pw-post-body-paragraph lg lh iq li b lj ms ll lm ln mt lp lq lr mu lt lu lv mv lx ly lz mw mb mc md ij bi translated">了解 Postgres 提供的不同类型的视图之间的区别是很重要的，我们将会看到两种类型:(普通)视图和物化视图。</p><p id="54b0" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">物化视图将它包含的数据存储在磁盘上，而普通视图在每次查询视图时运行底层查询。这意味着物化视图必须定期刷新。刷新<em class="nd"> es </em>既可以手动进行，也可以通过主表上的触发器或监听/通知系统之类的机制进行。我们暂时不讨论这个问题。</p><p id="3ef0" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">主表<code class="fe mz na nb nc b"><em class="nd">prompts</em></code> <em class="nd"> </em>看起来如下:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">You can add several conditions on the types of phrases that you want: ngram size, presence of certain POS tags, all phrase as lowercase text, excluding certain stop-words, and so on.</figcaption></figure><p id="4070" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">这里的<em class="nd">，id </em>是这个表的主键。在<em class="nd"> ngram </em>字段上有一个唯一的约束，类型为 varchar(256)。我们不希望关键词太长，因此太具体。</p><p id="c0b7" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">我们现在将创建这个表的物化视图，并在这个视图上建立一个索引。对底层提示表的任何更改都可以通过简单地刷新该视图来解决。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Creation, Indexing and Refreshing of a Materialized View</figcaption></figure><p id="6fc2" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">对于生产级应用程序，请查看<a class="ae kc" href="https://www.postgresql.org/docs/9.4/static/sql-refreshmaterializedview.html" rel="noopener ugc nofollow" target="_blank">并发刷新视图。</a></p><h1 id="7067" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">获取提示</h1><p id="dc2e" class="pw-post-body-paragraph lg lh iq li b lj ms ll lm ln mt lp lq lr mu lt lu lv mv lx ly lz mw mb mc md ij bi translated">有几种搜索视图的方法，我们将坚持使用下面的方法:</p><pre class="lc ld le lf gt ne nc nf ng aw nh bi"><span id="2029" class="ni ke iq nc b gy nj nk l nl nm">select ngram from &lt;schema_name&gt;.mv_prompts<br/>where tsquery('charges' || ':*') @@ to_tsvector(ngram) <br/>limit 10</span></pre><p id="3bb2" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">另一个巧妙的技巧是在查询的<code class="fe mz na nb nc b">tsquery(‘charges’ || ‘:*’)</code>部分包含<code class="fe mz na nb nc b">|| ‘:*’</code>。这也可以通过正则表达式搜索得到不完整单词的搜索结果！</p><h2 id="04db" class="ni ke iq bd kf nn no dn kj np nq dp kn lr nr ns kr lv nt nu kv lz nv nw kz nx bi translated"><strong class="ak">搜索结果</strong></h2><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="9782" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">这里，'<em class="nd"> charges' </em>'是一个示例搜索词。我们有一个关于<code class="fe mz na nb nc b">to_tsvector(ngram)</code>的索引，这将优化搜索。</p><p id="39af" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">查询执行时间:109 毫秒。</p><p id="1e6c" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><strong class="li ir">注意</strong>:此搜索词仅检索到 9 个结果。</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Prompts for search term ‘charg’</figcaption></figure><p id="1667" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">下图显示了搜索术语'<em class="nd"> charg </em>'的前 10 个结果。这完全符合我们的目的，因为除了搜索<em class="nd">“费用”</em>得到的提示外，我们还得到类似于<em class="nd">“应支付利息”</em>和<em class="nd">“应支付会计期间”</em>的提示。</p><p id="a0ff" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">查询执行时间:182 毫秒。</p><p id="3c88" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">没有通配符搜索应该会缩短执行时间，但也会限制结果的数量。这是一个应用程序特有的功能。</p><h1 id="bb82" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">用一个 API 把它包装起来</h1><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/205c0be47b7d06234be2ad4d20a71f65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DJiMdjuTRcNn_GsmE1S6fA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">(i had a nice dad joke about hitting a space-bar after long day at work, turns out everyone is paranoid about potential copyright infringement and i could not find the source for the original dad joke. So here, enjoy this mildly futuristic bar :/). Photo by <a class="ae kc" href="https://unsplash.com/@skylargereld?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Skyler Gerald</a> on <a class="ae kc" href="https://unsplash.com/s/photos/2049?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d3f7" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><em class="nd">后端现已准备就绪。</em>现在我们需要反复调用 API 端点来获取用户输入的搜索建议。从<em class="nd">前端</em>应用程序中获取方法应该能行。这个调用可以在每次按键、按下空格键、输入延迟达到某个阈值或者这些情况的任意组合时触发。</p><h1 id="e80f" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">包扎</h1><p id="681d" class="pw-post-body-paragraph lg lh iq li b lj ms ll lm ln mt lp lq lr mu lt lu lv mv lx ly lz mw mb mc md ij bi translated">带有 Flask API 处理程序和后续数据库查询的 Python 脚本如下所示:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="mx my l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">We done yet?</figcaption></figure><h1 id="048e" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">在活动</h1><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/6b6cff9374a3931338e958bc5ce35375.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/1*xP1jBLS7ssNcqrd_V2db3Q.gif"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Straight outta iOS! © ME 😎</figcaption></figure><p id="c5ba" class="pw-post-body-paragraph lg lh iq li b lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">进一步的部分包括包括相关的动词短语，解析以保持语义的相似性，以及理解为什么媒体不允许作者定制他们的媒体。</p></div></div>    
</body>
</html>