<html>
<head>
<title>Building a dataset for the São Paulo Subway operation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为圣保罗地铁运营构建数据集</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-dataset-for-the-s%C3%A3o-paulo-subway-operation-2d8c5a430688?source=collection_archive---------11-----------------------#2018-08-23">https://towardsdatascience.com/building-a-dataset-for-the-s%C3%A3o-paulo-subway-operation-2d8c5a430688?source=collection_archive---------11-----------------------#2018-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/338cf4ca48c345c302e8fa8370d390b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v51QEUUcdW3cvLGXcYStXw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/photos/bC5bAMUvaOs?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Rafael De Nadai</a> on <a class="ae kc" href="https://unsplash.com/@rafaelnadai?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9bda" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你坐过拥挤的地铁吗？我知道大多数大城市都会出现这种情况，但在圣保罗，情况可能是这样的:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/4324bd49fb69f91e437d8eb38b268dd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/0*tzR23wDmSyLyXmv3.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">This is what a crowded subway station may look like here in SP</figcaption></figure><p id="dda0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，作为一名巴西人和一名<em class="lg">保利斯塔诺</em>T5】，我能做些什么呢？(这是葡萄牙语中“住在圣保罗的人”的意思)</p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><p id="78de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Metr 地铁公司的<a class="ae kc" href="https://transparencia.metrosp.com.br/" rel="noopener ugc nofollow" target="_blank">透明</a>网页提供了关于乘客需求的数据，但粒度较低，对每条地铁线工作日和周末的平均条目进行了分组。这还不错，但我们可以做得更好。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lo"><img src="../Images/f3df9b64daec0803615381559f695572.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fzRFxtFMbuagonJv9bADVg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">The <a class="ae kc" href="https://transparencia.metrosp.com.br/" rel="noopener ugc nofollow" target="_blank">transparency</a> webpage for the Metrô subway company provides data on the passenger demand but with low granularity</figcaption></figure><p id="5843" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我知道 ViaQuatro 公司的网页提供了所有地铁线路的(几乎)实时运营状态，该公司与政府有一个地铁线路运营联合体:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lp"><img src="../Images/a0e1162bf0e216eede12b00e88b637f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuRQhqgnHN6gujWE5EPiHQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">The ViaQuatro company webpage provides operation status for all of the subway lines, as highlighted in red</figcaption></figure><p id="fa44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">每天乘坐 SP 地铁的人直观地知道，一个<strong class="kf ir"> <em class="lg">正常</em> </strong>运行状态不足以推断车站不会拥挤，但是一个<strong class="kf ir"> <em class="lg">减速</em> </strong>或<strong class="kf ir"> <em class="lg">瘫痪</em> </strong>状态可能与第一张图中所示的混乱有关。</p><p id="0a21" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不幸的是，这些数据没有被存储。至少对我们这些普通公民来说不是这样，所以我们可以对它进行访问、监控、评估、展示等等。我们为什么不使用 Python 来解决这个问题呢？</p><p id="45c8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文剩余部分显示的步骤是一个教导性的，尽管是项目的完全功能性演示。万一你是开发者或者想直奔最终结果，可以随意探索 <a class="ae kc" href="http://github.com/douglasnavarro/sp-subway-scraper" rel="noopener ugc nofollow" target="_blank"> <em class="lg"> Github 资源库</em> </a> <em class="lg">。</em></p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><p id="cf0c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以…</p><h1 id="7653" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">我们的目标是以非侵入性的方式持续存储圣保罗地铁线的运营状态历史，并使任何公民都可以方便地使用。</h1><h1 id="f0ae" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">为了达到这个目标，我们将编写一个能够请求 ViaQuatro 网页，提取操作状态和时间戳并存储它的自治 web scraper。</h1></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><p id="5800" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们将需要<code class="fe mo mp mq mr b">requests</code>包来下载网页，并需要<code class="fe mo mp mq mr b">BeautifulSoup</code>来轻松处理网页:</p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="786b" class="mw lr iq mr b gy mx my l mz na">&gt;&gt;&gt; import requests<br/>&gt;&gt;&gt; from bs4 import BeautifulSoup</span></pre><p id="9c7c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，要下载这个页面，我们需要做的就是</p><p id="a972" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mo mp mq mr b">&gt;&gt;&gt; vq_home_request = requests.get('http://www.viaquatro.com.br')</code></p><p id="a3c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果请求成功，我们就有了 HTML 代码</p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="5599" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; vq_home_content = <!-- -->vq_home_request<!-- -->.text <br/>&gt;&gt; vq_home_content</span><span id="4adc" class="mw lr iq mr b gy nb my l mz na">'\r\n&lt;!DOCTYPE HTML&gt;\r\n&lt;html lang="pt-BR"&gt;\r\n&lt;head&gt;\r\n\t&lt;meta charset="UTF-8"&gt;\r\n    <strong class="mr ir">&lt;title&gt;ViaQuatro | Seja Bem-vindo&lt;/title&gt;</strong>\r\n\t&lt;meta name="description" content="ViaQuatro - Informa&amp;#231;&amp;#245;es sobre rotas, tarifas, esta&amp;#231;&amp;#245;es e muito mais." /&gt; \r\n\t&lt;meta name="keywords" content="" /&gt;\r\n    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge" &gt;\r\n\t&lt;script src="/Content/js/3rd/modernizr.custom.97134.js"&gt;&lt;/script&gt;\r\n    &lt;!-- Use Zepto for best performance on WebKit based browser --&gt;\r\n\t\t&lt;!-- &lt;script src="js/zepto/zepto.js" type="text/javascript" charset="utf-8"&gt;&lt;/script&gt; --&gt;\r\n\t&lt;link rel="stylesheet" type="text/css" href="/Content/css/default.css" media="all" /&gt; <strong class="mr ir">&lt;!-- pra ser carregado em todas as páginas --&gt;</strong>\r\n<br/>(...)</span></pre><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/6f96a2a721fc157e59ece7736cf44539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5E6R_D7qN_9PotdhNiJHjg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">We do have the HTML inside our environment!</figcaption></figure><p id="5cf7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们使用<em class="lg"> BeautifulSoup </em>来浏览 DOM 并提取标题页面，以检查我们是否在 BeautifulSoup 对象中组织了 HTML 元素:</p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="4309" class="mw lr iq mr b gy mx my l mz na">&gt;&gt;&gt; soup = BeautifulSoup(vq_home_content, 'html.parser')<br/>&gt;&gt;&gt; soup.title<br/>&lt;title&gt;ViaQuatro | Seja Bem-vindo&lt;/title&gt;</span></pre><p id="59c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在到了困难的部分——提取真正重要的东西。使用开发工具检查 HTML，我们看到显示地铁线路当前状态的“操作”面板由一个<code class="fe mo mp mq mr b">&lt;section class="operacao"&gt;</code>元素组成。里面有我们需要的所有数据。因此，让我们把它拉出来，这样我们就可以对它进行以下查询:</p><p id="dbef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mo mp mq mr b">&gt;&gt; operation_column = soup.find(class_= "operacao")</code></p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/aa306cce9c428d2460ab4b6c14df5f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2eDEj3aHVQJ2K794xAvmw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">We need to inspect the page code in order to find out what element contains the data we want</figcaption></figure><p id="24ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们也使用<a class="ae kc" href="https://www.python.org/dev/peps/pep-0274/" rel="noopener ugc nofollow" target="_blank"> <em class="lg">字典理解</em> </a> <em class="lg"> : </em>初始化一个字典来存储行状态</p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="6ceb" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; lines_metro = ['azul', 'verde', 'vermelha', 'amarela', 'lilás', 'prata']</span><span id="2324" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; lines_cptm  = ['rubi', 'diamante', 'esmeralda', 'turquesa', 'coral', 'safira', 'jade']</span><span id="a536" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; all_lines = lines_metro + lines_cptm</span><span id="ddaf" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; <strong class="mr ir">extracted_status = {line:'' for line in all_lines}</strong></span><span id="8479" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; extracted_status<br/>{'amarela': '', 'vermelha': '', 'diamante': '', 'turquesa': '', 'coral': '', 'prata': '', 'lilás': '', 'esmeralda': '', 'safira': '', 'rubi': '', 'verde': '', 'azul': '', 'jade': ''}</span></pre><p id="9f82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续我们的调查，我们看到 Amarela(黄色)地铁线的状态包含在一个带有名为<em class="lg">状态的<em class="lg"> </em> css 类的<em class="lg"> span </em>标签中。</em></p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="b0b6" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; <!-- -->status_amarela = operation_column.find(class_="status").text<br/>&gt;&gt; extracted_status['amarela'] = status_amarela</span></pre><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/7f8a325b8e2cfbf12bb3b9920626767f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BHFPiMzZbGaGZQC8VNP0gA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">The operation status for the Amarela (yellow) subway line is wrapped around a <strong class="bd nf"><em class="ng">span </em></strong>tag with a<em class="ng"> </em>css class called <strong class="bd nf"><em class="ng">status</em></strong></figcaption></figure><p id="2046" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于所有其他线路，数据被分成三个标签<code class="fe mo mp mq mr b">&lt;div class="linhas"&gt;</code>，每个标签代表一家参与城市铁路系统的公司。在每一个<em class="lg">div</em>中，我们都有一个<em class="lg">无序列表</em>标签，其中每一个<em class="lg">条目</em>都包含行号、其名称和当前在<strong class="kf ir">另一个看起来像<code class="fe mo mp mq mr b">&lt;div class="info"&gt;</code>的 div </strong>中的操作状态。</p><p id="49b4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了提取所有这些内容，我们将遍历<code class="fe mo mp mq mr b">&lt;div class="linhas"&gt;</code>div，然后遍历每个<code class="fe mo mp mq mr b">&lt;div class="info"&gt;</code> div，以获得我们真正想要的内容:操作状态和行名:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/084d6c2efc88600e9fb83c022cf44ec1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sGMB-iTO6w9mwWHQJvLjCw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">we will iterate over the <code class="fe mo mp mq mr b">&lt;div class="linhas"&gt;</code> divs and then iterate over each <code class="fe mo mp mq mr b">&lt;div class="info"&gt;</code> div to get what we really want</figcaption></figure><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="0e56" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; lines_containers = <!-- -->operation_column<!-- -->.find_all(class_ = "linhas")</span><span id="dba5" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; for container in lines_containers:<br/>       line_info_divs = container.find_all(class_ = "info")<br/>       for div in line_info_divs:<br/>           line_title  = ''<br/>           line_status = ''<br/>           spans = div.find_all("span")<br/>           line_title = spans[0].text.lower()<br/>           line_status = spans[1].text.lower()<br/>           extracted_status[line_title] = line_status</span><span id="1438" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; extracted_status<br/>{'safira': 'normal', 'prata': 'normal', 'rubi': 'normal', 'azul': 'normal', 'turquesa': 'normal', 'amarela': 'Operaç\xe3o Normal', 'lilás': 'normal', 'esmeralda': 'normal', 'coral': 'normal', 'verde': 'normal', 'diamante': 'normal', 'jade': 'normal', 'vermelha': 'normal'}</span></pre><p id="4e01" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了字典中所有行的操作状态！另一个重要信息是该数据的时间戳。它显示在“操作”面板中，就在标题的右边。这是页面中唯一的<code class="fe mo mp mq mr b">&lt;time&gt;</code>元素。让我们把它拉出来:</p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="323c" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; <!-- -->time_data = soup.find('time').text<br/>&gt;&gt; time_data<br/>'18/08/2018 23:11'</span></pre><p id="143c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">终于，我们有了所有的数据！我承认我需要一点时间来欣赏这一点。</strong></p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/b749ed30cfbe74df068ae116f10904f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*pkEDEICR0wEIa_TEEB_DgA.gif"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Web scraping is so cool! <a class="ae kc" href="https://giphy.com/gifs/curbyourenthusiasm-l1J9yTco40EU5JzTW" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><p id="3b88" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此时，我们可以简单地将<code class="fe mo mp mq mr b">extracted_status</code>和<code class="fe mo mp mq mr b">time_data</code>写入本地系统中的一个文件，或者利用互联网的魔力将其存储在任何地方。</p><p id="d42e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是让我们更进一步，使用<strong class="kf ir"> Google Sheets </strong>,因为它非常受欢迎，非开发人员也可以访问，并且提供了一个有良好文档记录的 API。最重要的是，<a class="ae kc" href="https://github.com/burnash/gspread" rel="noopener ugc nofollow" target="_blank"> gspread 包</a>为我们包装了所有的请求，并且<a class="ae kc" href="https://github.com/google/oauth2client" rel="noopener ugc nofollow" target="_blank"> oauth2client </a>使用我们的 API 凭证处理令牌获取过程。</p><p id="09be" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我知道有很多隐藏的东西，但是能够用这么少的代码做这么多的事情是用 Python 这样的语言编程的美妙之处之一。</p><p id="99b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简单地说，我们需要做的是:</p><ul class=""><li id="b5aa" class="nj nk iq kf b kg kh kk kl ko nl ks nm kw nn la no np nq nr bi translated">获取我们的谷歌证书，以便以后使用它们进行授权(这是手动的，只需要做一次)</li><li id="88cd" class="nj nk iq kf b kg ns kk nt ko nu ks nv kw nw la no np nq nr bi translated">通过我们的代码使用凭据获得授权</li><li id="aeb7" class="nj nk iq kf b kg ns kk nt ko nu ks nv kw nw la no np nq nr bi translated">通过我们的代码将数据写入公共电子表格</li></ul><p id="73b6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要获得证书，我们可以按照 gspread 文档提供的这个逐步指南<a class="ae kc" href="https://gspread.readthedocs.io/en/latest/oauth2.html" rel="noopener ugc nofollow" target="_blank">进行操作。在这个过程结束时，您得到的是一个类似如下的<code class="fe mo mp mq mr b">client_secret.json</code>文件:</a></p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="0230" class="mw lr iq mr b gy mx my l mz na">{<br/>    "private_key_id": "2cd … ba4",<br/>    "private_key": "-----BEGIN PRIVATE KEY-----\nNrDyLw … jINQh/9\n-----END PRIVATE KEY-----\n",<br/>    "client_email": "473000000000-yoursisdifferent@developer.gserviceaccount.com",<br/>    "client_id": "473 … hd.apps.googleusercontent.com",<br/>    "type": "service_account"<br/>}</span></pre><p id="e898" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这很重要:我们需要与我们的 API 用户共享我们将要使用的电子表格。否则，在尝试写入数据时，我们会收到拒绝访问错误。这个用户由 json 文件中的<em class="lg"> client_email </em>字段表示。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/91ae4079c183073d0d8e8568edd1e312.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-8gEG3DyygZ49S2pzKr3-A.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">This is important: we need to share the spreadsheet we will be using with our API user</figcaption></figure><p id="adf9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">回到代码，让我们导入<em class="lg"> gspread </em>和<em class="lg"> oauth2client </em>并从。json 文件到我们的环境中:</p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="1688" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; import gspread<br/>&gt;&gt; from oauth2client.service_account import ServiceAccountCredentials</span><span id="d663" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; scope = ['https://spreadsheets.google.com/feeds',<br/>            'https://www.googleapis.com/auth/drive']<br/>&gt;&gt; creds = ServiceAccountCredentials.from_json_keyfile_name(<br/>           'client_secret.json',<br/>           scope)</span></pre><p id="895e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们使用我们的凭据获得授权，并初始化电子表格。要初始化电子表格，我们需要它的 ID，它显示在我们用来在浏览器中访问它的 URL 中:</p><p id="d494" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">https://docs.google.com/spreadsheets/d/<strong class="kf ir">1 wiki 6 sucqaauf 9 qojog _ tme OSA _ lm _ kjm 83 qwxf 9 dsg</strong></p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="6edb" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; client = gspread.authorize(creds)</span><span id="1a6a" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; SPREADSHEET_ID = "1WiKE6SUCqAaUF9qOJOg_tMeOSA_lm_kjm83qwXF9dSg"</span><span id="4748" class="mw lr iq mr b gy nb my l mz na">&gt;&gt; data_sheet = client.open_by_key(SPREADSHEET_ID).worksheet("data")</span></pre><p id="dc76" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，我们不直接使用电子表格对象，而是使用其中的工作表，因此我们需要指定它的名称。</p><p id="059a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们写我们的数据！<em class="lg"> append_row </em>方法确实如其名，我们只需要传递一个列表，其中每个元素将被写入该行的不同列。</p><pre class="lc ld le lf gt ms mr mt mu aw mv bi"><span id="5f1a" class="mw lr iq mr b gy mx my l mz na">&gt;&gt; for line in all_lines:<br/>    data_sheet.append_row([time_data, line, extracted_status[line]])</span></pre><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/37bfca3d15c01aa2f6f2a41423b300dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*qrDfwo55SfXpjI_EYt-QQw.gif"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">We can actually see the data being stored in real time!</figcaption></figure><p id="cc9f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了拥有一个不会让你的电脑一直开着的自主刮刀，我们必须组织这段代码，并让它在云服务上运行。针对异常的一些保护也很重要，但是这些超出了本文的范围。如果你想了解更多的细节，可以随意看看 github 的回购。</p><p id="b401" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将在以后的文章中分析这些数据。我们看看会有什么结果！</p><p id="d45f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">【编辑】保罗<a class="ae kc" href="https://github.com/pmhaddad" rel="noopener ugc nofollow" target="_blank">做了一个很棒的分析！看这里</a><a class="ae kc" href="https://github.com/pmhaddad/ds_subway_analysis/blob/master/subway_analysis.md" rel="noopener ugc nofollow" target="_blank"/>！</p></div></div>    
</body>
</html>