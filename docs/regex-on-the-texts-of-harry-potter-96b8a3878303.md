# 《哈利·波特》文本的正则表达式

> 原文：<https://towardsdatascience.com/regex-on-the-texts-of-harry-potter-96b8a3878303?source=collection_archive---------15----------------------->

## 深入的案例研究

![](img/740c9799e446635d9ad972ade30284c1.png)

Regular Expressions: more mind-boggling than arithmancy

我是 Greg Rafferty，湾区的数据科学家。你可以在我的 [github](https://github.com/raffg/harry_potter_nlp) 上查看这个项目的代码。如有任何问题，请随时联系我！

在这一系列的文章中，我通过《哈利·波特》的镜头来看一些简便的自然语言处理技术。我在这个关于基本自然语言处理的系列文章中的上一篇文章关注了使用潜在狄利克雷分配的[主题建模](/basic-nlp-on-the-texts-of-harry-potter-topic-modeling-with-latent-dirichlet-allocation-f3c00f77b0f5)，下一篇文章将关注文本摘要。

在这个 NLP 项目中，我一直使用七本关于哈利波特的书作为我的文本语料库。但是在我可以通过我的算法发送这些书之前，我首先必须将 pdf 保存为 txt 文件，然后将章节提取为单独的文档。为此，我使用了正则表达式。要想很好地了解 Python 中的正则表达式，请查看谷歌的快速课程。

正则表达式可以被认为是 crack 上的通配符搜索。它们在描述文本字符串中的模式时具有惊人的灵活性。如果你以前从未见过它们，正则表达式模式可能看起来像一团乱麻，毫无意义。但是混乱中有秩序，有强大的力量。让我们用我在这些文本上使用的模式来探索一下:

```
pattern = r"((?:[A-Z-][ ]){9,}[A-Z])\s+([A-Z \n',.-]+)\b(?![A-Z]+(?=\.))\b(?![a-z']|[A-Z.])(.*?)(?=(?:[A-Z][ ]){9,}|This book)"
```

当使用`re.findall`应用于保存为文本文件的哈利波特书籍时，输出是一个由 3 个元素组成的元组列表。列表中的每个元组对应于书中的一个章节，并且采用`(‘C H A P T E R O N E’, ‘THE BOY WHO LIVED’, ‘Mr. and Mrs. Dursley, of number four, Privet Drive, blah, blah, blah...’)`的形式，包含整个章节的文本。我们需要从中提取:

> 中国英语学习网
> 
> 男孩世卫组织活着
> 
> 女贞路 4 号的德思礼夫妇自豪地说，他们完全正常，非常感谢。他们是你最不可能想到会卷入任何奇怪或神秘的事情的人，因为他们不喜欢这样...

让我们看看上面的模式，看看它是如何做到这一点的。我将描述这个表达式背后的逻辑，但是关于精确语法的更多细节，请跟随[这里的](https://regex101.com/r/orgYwY/8)进行逐字符的描述。该铁路图显示了管道:

![](img/0680bb6a27489ce632e37332c76f3aca.png)

[Source](https://regexper.com/#%28%28%3F%3A%5BA-Z-%5D%5B%20%5D%29%7B9%2C%7D%5BA-Z%5D%29%5Cs%2B%28%5BA-Z%20%5Cn'%2C.-%5D%2B%29%5Cb%28%3F!%5BA-Z%5D%2B%28%3F%3D%5C.%29%29%5Cb%28%3F!%5Ba-z'%5D%7C%5BA-Z.%5D%29%28.*%3F%29%28%3F%3D%28%3F%3A%5BA-Z%5D%5B%20%5D%29%7B9%2C%7D%7CThis%20book%20%5Cn%29)

组#1 是这个部分:`((?:[A-Z-][ ]){9,}[A-Z])`。这是上图中左边的第一个方框。外面的括号告诉 python 捕获 Group 1 中的内容(这将最终成为`'C H A P T E R O N E'`)。内括号是一个子模式的分组，`?:`指示 python 不要将它作为第二个分组来捕获。子模式`([A-Z][ ]){9,}[A-Z]`表示任何大写字母后跟一个空格，重复 9 次或更多次，以最后一个大写字母结束。这是获取章节号的方式。

后面跟着`\s+`，它不在括号中，所以不会被捕获，并指示 python 一次或多次查找空白(换行符、制表符、空格等)。这实际上是跳到了第二组中的章节标题，下一组括号:`([A-Z]\n',.-]+)`。这再次意味着任何大写字母，和/或换行符(`\n`)、撇号、逗号、句号和破折号，一次或多次。有些章节标题有换行符或其他各种标点符号，例如:

> 阿兹卡班的囚徒，第 18 章:穆尼，虫尾巴，大脚板和尖头叉子
> 
> 火焰杯，第 21 章:家养小精灵解放阵线
> 
> 《凤凰社》第八章:韦斯莱夫人的 WOES

然而，这里有一个问题:第一册的第四章以

> 嘣。他们又敲门了…

所以通过寻找所有大写字母，那个“嘣”将作为标题的一部分被捕获。我们需要使用所谓的负前瞻，用`?!` : `/b(?![A-Z]+(?=\.))/b`声明。符号表示单词边界。因此，上面的章节标题捕获字符串捕获所有大写字母*，除非*下一个单词也是全部大写，但后面紧跟一个句点，用肯定的前瞻`?=`声明。太好了！现在我们能够找到那个“爆炸”把它排除在我们的抓捕范围之外。但这又引入了另一个问题。我在上一段提到的其中一章“韦斯莱夫人的 WOES”也包含一个单词，后面跟一个句号，所以现在我们只把这一章的标题记为“韦斯莱夫人的 WOES”。我们需要*另一个*负前视，`(?![a-z']|[A-Z.])`，以确保所有大写单词后面跟一个句点不是*也不是*后面跟小写单词(章节文本)，或者不是大写字符串中的最后一个单词(因为尽管章节标题可能包含一个句点，但它绝不会以一个句点结尾)。

第三组是最简单的一组:`(.*?)`。这意味着捕捉任何角色，任何次数，并且要贪婪。一直走，直到被迫停下来，有了下一部分。

正则表达式的最后一部分告诉 python 在什么点停止捕获文本:`(?=(?:[A-Z][ ]){9,}|This book \n)`。这是另一个非捕获的前瞻。它提供了一旦一个大写字母和空格的序列重复至少 9 次就停止捕获文本的指令(因为这样就开始了下一章，“C H A P T E R T W O”)，或者直到字符串`This book \n`。这最后一串标志着这本书的结束；《哈利·波特》七本书的结尾都是这样的:

> 这本书
> 由
> 大卫·塞勒担任美术指导，由贝基
> 特胡恩设计。夹克和内部的艺术都是用彩色蜡笔在调色版画纸上创作的。文本采用 12 号 Adobe Garamond 字体，这种字体基于 16 世纪 Claude Garamond 的字体设计，由 Robert slim Bach 在 1989 年重新绘制。这本书是在俄亥俄州威拉德的 RR Donnelley Sons 印刷装订的。安吉拉·比奥拉负责监督制作

唷！我希望这些都有意义！我强烈建议你访问[这个链接](https://regex101.com/r/orgYwY/8)来看看这一切的运行，甚至更多的细节和每个角色的描述。