<html>
<head>
<title>An R-docker hello world example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个 R-docker hello world 的例子</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/an-r-docker-hello-world-example-881e771214e2?source=collection_archive---------3-----------------------#2018-01-04">https://towardsdatascience.com/an-r-docker-hello-world-example-881e771214e2?source=collection_archive---------3-----------------------#2018-01-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d9786e0a7856efeb94d476183b3b650d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kS6ip-oyz61XiC0YY6FtuA.png"/></div></div></figure><p id="47cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，我变成了那种“我们可以用集装箱装这个！”人们。</p><p id="e6a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我保证我不仅仅是一个趋势追随者——容器技术对于我们为自己和客户构建定制分析应用的团队来说有着惊人的前景。</p><p id="e3bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们使用 R 统计编程语言/环境来构建从机器学习解决方案到报告仪表板的一切。r 对于分析和快速原型开发来说是一个很好的环境，但是它传统上是一个统计脚本环境，并且缺少一些传统编程语言的“生产就绪”特性。</p><blockquote class="kw kx ky"><p id="19a0" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">Docker 为我们提供了一种基于每个应用管理依赖项和库的方法(当在一个服务器上部署多个应用时)。</p><p id="d566" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">这也意味着在我的机器上工作的东西有很好的机会在生产中工作。就这样，挽救了许多深夜恐慌。</p></blockquote><h1 id="4142" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">关于本教程</h1><p id="2265" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">这篇文章是我去年为我们公司的博客写的一篇博客的更新版本。它将带您完成构建、运行和连接一个运行 r 的 docker 容器的步骤</p><ul class=""><li id="864a" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv mm mn mo mp bi translated">建立一个档案</li><li id="a2cf" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">建造一个容器</li><li id="ab1d" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">运行容器以服务于 Rstudio 环境</li><li id="216b" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">连接到该容器并运行脚本</li><li id="131e" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">将输出写回到主机上装载的数据文件夹中</li><li id="43ed" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">喝一杯好茶来祝贺我们自己(开个玩笑——你可能自己就知道了)</li></ul><p id="6767" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要在家玩，从<a class="ae mg" href="https://github.com/SymbolixAU/r_docker_hello" rel="noopener ugc nofollow" target="_blank">我们的 github </a>库克隆或下载目录。代码已经在 Linux 和 Mac 上测试过——你可能需要在 Windows 上做一些小的改动(请在评论中添加任何额外的提示)。</p><h1 id="9623" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">关于 Docker</h1><p id="ad90" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">Docker 是一个使用容器的管理系统/环境。<strong class="ka ir">容器</strong>建立在<strong class="ka ir">主机</strong>之上。它们共享相同的内核和硬件控制器，但可能有不同的 Linux 风格或库集。</p><p id="7884" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们设置容器<strong class="ka ir">映像</strong>,就像我们想要的容器的快照——所有的库、文件等等。然后我们<strong class="ka ir">运行</strong>容器来建立一个包含所有工作文件的临时实例。</p><blockquote class="kw kx ky"><p id="14b5" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">完成后，我们<strong class="ka ir">停止</strong>容器，并且<strong class="ka ir">所有数据和任何本地更改都将永远丢失。</strong></p></blockquote><p id="1ab3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了保存容器实例的输出，我们必须将数据写回主机或其他永久的地方。</p><p id="9f5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于这个例子，我假设你正在一台已经安装了 docker 的机器上工作。</p><h1 id="8d12" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">这个例子</h1><p id="4bee" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">从<a class="ae mg" href="https://github.com/SymbolixAU/r_docker_hello" rel="noopener ugc nofollow" target="_blank">https://github.com/SymbolixAU/r_docker_hello</a>克隆或下载存储库。</p><p id="d991" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用您使用的命令行终端导航到您的新目录<code class="fe mv mw mx my b">R_docker_hello</code>。</p><p id="1f2f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个文件夹中，您会发现:</p><ul class=""><li id="d912" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv mm mn mo mp bi translated"><code class="fe mv mw mx my b">Dockerfile</code>:它位于顶层目录中，指定了我们的构建选项。</li><li id="f8bd" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">分析文件夹:保存一个简单的<code class="fe mv mw mx my b">hello_world.R</code>脚本，我们将在我们的容器中运行它</li><li id="eed0" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">数据文件夹:你所见过的最简单的输入数据。我们还将在运行容器时挂载这个文件夹，并将输出写回其中。</li><li id="e1dc" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated">DockerConfig:每个人都喜欢特定的库，所以我做了一个<code class="fe mv mw mx my b">requirements.R</code>，它将在你构建容器时运行。</li></ul><h1 id="77cf" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">准备好了吗？让我们开始吧…</strong></h1><figure class="na nb nc nd gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/6fccd760090c5974f941c9110ada4599.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*Vd6e-EueUcm8VPOIJjjVHQ.jpeg"/></div></figure><h1 id="b7d9" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">在 Dockerfile 文件中</h1><p id="d4b0" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">Dockerfile 文件包含以下内容:</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="ab6a" class="ni le iq my b gy nj nk l nl nm"># Base image https://hub.docker.com/u/rocker/ <br/>FROM rocker/rstudio </span><span id="bd97" class="ni le iq my b gy nn nk l nl nm">## Install extra R packages using requirements.R <br/>##   Specify requirements as R install commands e.g.  <br/>##   install.packages("&lt;myfavouritepacakge&gt;") or <br/>## devtools::install("SymbolixAU/googleway") </span><span id="9471" class="ni le iq my b gy nn nk l nl nm">COPY ./DockerConfig/requirements.R /tmp/requirements.R <br/>RUN Rscript /tmp/requirements.R </span><span id="e527" class="ni le iq my b gy nn nk l nl nm">## uncomment to include shiny server <br/># RUN export ADD=shiny &amp;&amp; bash /etc/cont-init.d/add </span><span id="4a57" class="ni le iq my b gy nn nk l nl nm"># create an R user <br/>ENV USER rstudio </span><span id="f73a" class="ni le iq my b gy nn nk l nl nm">## Copy your working files over <br/>COPY ./Analysis /home/$USER/Analysis <br/>COPY ./Data /home/$USER/Data</span></pre><p id="5001" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">docker 文件用于构建容器映像。</p><p id="cc99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们从基础图像的开始<strong class="ka ir">。然后我们<strong class="ka ir">复制</strong>文件或者<strong class="ka ir">运行</strong>额外的命令或者设置特定的<strong class="ka ir"> ENV </strong>变量。Dockerfile 位于项目的顶部，应该用大写字母<strong class="ka ir"> D </strong>来命名<strong class="ka ir"> Dockerfile </strong>。</strong></p><p id="998a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本例中，我们从来自<a class="ae mg" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> docker hub </a>的 rocker/rstudio 图像开始。这些是公开的(非官方的),但是它们是可靠的，并且得到了很好的支持。Rocker 也有 r-base (rocker/r-base)的图像和一个地理空间套件(rocker/rstudio-geospatial)。这里安装了所有基本的空间库(sp，sf ),以及所有你需要的 R 之外的东西(比如 GDAL 库)。</p><p id="d5ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了安装额外的 R 库，我们在<code class="fe mv mw mx my b">requirements.R</code>中指定它们。在构建时，该脚本被复制到实例上，并运行以安装库。</p><p id="7726" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，构建复制我们的文件到<code class="fe mv mw mx my b">Analysis</code>文件夹和<code class="fe mv mw mx my b">Data</code>文件夹。我们将它们放在用户的主目录中，名为<code class="fe mv mw mx my b">rstudio</code>。</p><h1 id="3c30" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">建造它</h1><p id="31da" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">在命令行中键入以下命令。您必须与 docker 文件在同一个目录中。根据您配置服务器的方式，您可能需要在命令前使用<code class="fe mv mw mx my b">sudo</code></p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="6256" class="ni le iq my b gy nj nk l nl nm">docker build --rm --force-rm -t rstudio/hello-world .</span></pre><p id="ca08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦脚本运行或者你注销，这个<code class="fe mv mw mx my b">--rm --force-rm</code>就强制容器删除它自己。它只是阻止我们用大量的容器填充服务器，而什么也不做。</p><p id="acdb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦这已经建立运行</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="bbae" class="ni le iq my b gy nj nk l nl nm">docker image list</span></pre><p id="357a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看到您的图像被添加到列表中。我们称它为<code class="fe mv mw mx my b">rstudio/hello-world</code>，但你可以称它为任何东西。</p><h1 id="9fe6" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">运行它</h1><p id="1f2c" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">我们希望使用此映像访问 Rstudio，因此我们希望它作为后台服务运行(即在分离模式下)。我们使用标志<code class="fe mv mw mx my b">-d</code>来做这件事。如果想访问 bash shell 或其他交互模式，需要指定<code class="fe mv mw mx my b">-it</code>。</p><p id="e386" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Rstudio 在容器内的端口 8787 上运行。我们需要用一个<code class="fe mv mw mx my b">-p &lt;host port&gt;:&lt;container port&gt;</code>将它映射到主机上一个未使用的端口，我们将使用 28787，但这可以是任何未使用的端口。</p><p id="1be8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将称我们的容器为<code class="fe mv mw mx my b">hello-world</code>。这是简单的运行命令:</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="94a2" class="ni le iq my b gy nj nk l nl nm">sudo docker run -d --rm -p 28787:8787 --name hello-world rstudio/hello-world</span></pre><p id="8bfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行这个命令并通过您在<code class="fe mv mw mx my b">&lt;yourhostip:28787&gt;</code>的 web 浏览器访问容器。用户名和密码都是<code class="fe mv mw mx my b">rstudio</code>。</p><p id="e46f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在 rstudio 中，键入</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="6a7f" class="ni le iq my b gy nj nk l nl nm">source("Analysis/hello.world.R")</span></pre><p id="8e5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该能够看到分析和数据文件夹，但是有两个问题。</p><ol class=""><li id="916f" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv no mn mo mp bi translated">写入本地容器当然很好，但是这个<strong class="ka ir">数据不会是永久的</strong>。我们可以通过使用<code class="fe mv mw mx my b">-v /full/path/to/directory</code>将主机目录挂载为容器上的卷，将输出写回主机目录。这在开发中也很有用，因为您可以在永久主机文件夹中进行更改，这些更改无需重新构建就可以立即在容器中使用。</li><li id="8639" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv no mn mo mp bi translated">为了<strong class="ka ir">写入 Docker 中的文件(通过 rstudio)，您需要拥有正确的用户 id </strong>。有了这些摇杆图像，您可以通过在 run 命令中指定<code class="fe mv mw mx my b">-e USERID=$UID</code>来实现。然后，您可以编写并更改文件，并将它们保存在容器中。</li></ol><p id="f5c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们修复问题之前，我们需要停止正在运行的容器(这对我们没有好处):</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="fd7b" class="ni le iq my b gy nj nk l nl nm">sudo docker stop hello-world</span></pre><p id="7f17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们再试一次。如果您查看<code class="fe mv mw mx my b">run_docker.sh</code>，您将看到运行命令的更完整版本:</p><pre class="na nb nc nd gt ne my nf ng aw nh bi"><span id="09d7" class="ni le iq my b gy nj nk l nl nm">DATA_DIR=${PWD}/Data sudo docker run -d --rm -p 28787:8787 --name hello-world2 -e USERID=$UID -e PASSWORD=SoSecret! -v $DATA_DIR:/home/rstudio/Data rstudio/hello-world</span></pre><p id="b7f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，在上面我也手动设置了密码——你可以随意设置。</p><p id="e3f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行上面的命令，登录<code class="fe mv mw mx my b">&lt;yourhostip:28787&gt;</code>并尝试获取脚本。</p><p id="8a5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它应该运行并写入数据文件夹。<code class="fe mv mw mx my b">&lt;/yourhostip:28787&gt;</code></p><p id="9c17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，再次回到命令行。键入<code class="fe mv mw mx my b">ls Data</code>，您应该也会在那里看到输出文件。</p><p id="d7ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还有一件事。在 rstudio 窗口中，打开<code class="fe mv mw mx my b">Analysis/hello.world.R</code>在底部添加一行命令，保存并运行它。</p><blockquote class="kw kx ky"><p id="7fe6" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">最后一个问题——如果我在命令行上检查<code class="fe mv mw mx my b">Analysis/hello.world.R</code>的内容(即回到主机上),它会有你的新行吗？</p><p id="8575" class="jy jz kz ka b kb kc kd ke kf kg kh ki la kk kl km lb ko kp kq lc ks kt ku kv ij bi translated">为什么？</p></blockquote><h1 id="88ce" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">最后一个挑战:</h1><p id="7d5f" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">(先停旧容器)。</p><p id="104a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在再次运行它，但是设置它以便您可以在命令行上对<code class="fe mv mw mx my b">hello_world.R </code>进行更改，并立即让它们在 Rstudio 中显示和工作。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="4bf5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kz">原载于【www.symbolix.com.au】<a class="ae mg" href="https://www.symbolix.com.au/blog-main/r-docker-hello" rel="noopener ugc nofollow" target="_blank"><em class="kz"/></a><em class="kz">。</em></em></p></div></div>    
</body>
</html>