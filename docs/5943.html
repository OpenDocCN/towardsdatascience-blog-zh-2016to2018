<html>
<head>
<title>Introduction to procedures and cursors in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL 中的过程和游标介绍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introduction-to-procedures-and-cursors-in-sql-f9d9b9ea1fe7?source=collection_archive---------6-----------------------#2018-11-17">https://towardsdatascience.com/introduction-to-procedures-and-cursors-in-sql-f9d9b9ea1fe7?source=collection_archive---------6-----------------------#2018-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1926a6d94d5233e79bba2752ad2cbbe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gG2lZ2dBYa_8yorF"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@casparrubin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Caspar Rubin</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="228b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">学习如何为一个</strong> <a class="ae kc" href="https://en.wikipedia.org/wiki/Relational_database_management_system" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> RDBMS </strong> </a> <strong class="kf ir">编写程序和游标。</strong></p><p id="4225" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想从数据科学的角度了解更多关于 SQL 的知识，你可以参加 DataCamp 的免费课程<a class="ae kc" href="https://www.datacamp.com/courses/intro-to-sql-for-data-science" rel="noopener ugc nofollow" target="_blank">“数据科学的 SQL 介绍”</a>。</p><p id="65de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">SQL 是任何现代软件工程师的必备技能。因为大多数软件依赖于某种类型的数据，并且与 RDBMS(关系数据库管理系统)集成得很好。无论是 web 应用程序、API 还是内部应用程序，RDBMS 都在那里。SQL 是查询 RDBMS 的语言。</p><p id="c445" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为一名数据科学家，了解 SQL 及其相关技术是非常初级的。为了能够查询 RDBMS 并获得关于您正在处理的数据的特定问题的答案，SQL 是最低要求。</p><p id="c560" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在他与 DataCamp 的最新视频中，<a class="ae kc" href="http://varianceexplained.org/about/" rel="noopener ugc nofollow" target="_blank">大卫·罗宾逊</a>(首席数据科学家@ DataCamp) <a class="ae kc" href="https://www.youtube.com/watch?v=6M0W-zmau8I" rel="noopener ugc nofollow" target="_blank">向我们展示了他如何在一个数据科学问题中使用 SQL</a>。请检查一下，他的工作流程非常有趣。</p><p id="cb80" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本教程中，您将学习编写过程和游标；SQL 的另一个重要方面。您是否曾经希望 RDBMS 在执行特定操作时自动执行某些操作？例如，假设您已经在名为<code class="fe lb lc ld le b">Employees</code>的表中创建了一个新的雇员记录，并且您希望它反映在其他相关的表中，如<code class="fe lb lc ld le b">Departments</code>。好吧，你将选择正确的教程。</p><p id="b650" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本教程中，您将学习:</p><ul class=""><li id="d511" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated">RDBMS 中的过程是什么？</li><li id="c566" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">如何编写一个过程呢？</li><li id="d9d3" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">不同类型的程序</li><li id="d2e7" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">RDBMS 中的游标是什么？</li><li id="6f5b" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">如何编写不同类型的游标？</li><li id="024b" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">不同类型的光标</li></ul><p id="5156" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">听起来很刺激？让我们开始吧。</p><h1 id="8994" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">RDBMS 中的过程是什么？</h1><p id="37da" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">在继续学习过程和游标之前，您需要了解一些关于<code class="fe lb lc ld le b">PL/SQL</code>的知识，它是一种块结构语言，使像您这样的开发人员能够将 SQL 的强大功能与过程语句结合起来。但是你不会以传统的方式学习，你会随着你的前进和需要而学习。</p><p id="93a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以如果你有一个 SQL 查询，你想多次执行它。程序是解决方法之一。通常在这种情况下调用过程，因为它们保持存储状态，并在特定操作或一系列操作时被触发。程序也被称为<code class="fe lb lc ld le b">Procs</code>。</p><p id="0131" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在您将看到如何编写一个过程。</p><h1 id="8d59" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">写作程序:</h1><p id="6756" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">编写过程的一般语法如下:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="2f0c" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CREATE</strong> <strong class="le ir">PROCEDURE</strong> procedure_name<br/><strong class="le ir">AS</strong><br/>sql_statement<br/><strong class="le ir">GO</strong>;</span></pre><p id="f6c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，这些语法适用于几乎所有 RDBMS，无论是 Oracle、PostgreSQL 还是 MySQL。</p><p id="84d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建过程后，您必须执行它。下面是它的语法。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="9672" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">EXEC</strong> procedure_name;</span></pre><p id="770c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们写一个简单的程序。考虑下面来自 RDBMS 的快照，它包含一个名为<code class="fe lb lc ld le b">Customers</code>的表。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/b7f66509f3f90e3f6b2caff749d39744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VB1vZUBxF4GWeB4P"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk"><strong class="bd nk">Source</strong>: <a class="ae kc" href="https://www.w3schools.com/" rel="noopener ugc nofollow" target="_blank">W3Schools</a></figcaption></figure><p id="2eb7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将编写一个名为<code class="fe lb lc ld le b">SelectAllCustomers</code>的程序，它将从<code class="fe lb lc ld le b">Customers</code>中选择所有的客户。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="8747" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CREATE</strong> <strong class="le ir">PROCEDURE</strong> SelectAllCustomers<br/><strong class="le ir">AS</strong><br/><strong class="le ir">SELECT</strong> * <strong class="le ir">FROM</strong> Customers<br/><strong class="le ir">GO</strong>;</span></pre><p id="72d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">执行<code class="fe lb lc ld le b">SelectAllCustomers</code>的人:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="4b9f" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">EXEC</strong> SelectAllCustomers;</span></pre><p id="1ba0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">过程也可以是独立的语句块，这使得它们独立于任何表，不像前面的表。下面的示例创建了一个显示字符串“Hello World！”的简单过程作为执行时的输出。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="50de" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CREATE</strong> <strong class="le ir">PROCEDURE</strong> welcome<br/><strong class="le ir">AS</strong><br/><strong class="le ir">BEGIN</strong><br/>dbms_output.put_line('Hello World!');<br/><strong class="le ir">END</strong>;</span></pre><p id="2505" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有两种执行独立过程的方法。</p><ul class=""><li id="1354" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated">使用<code class="fe lb lc ld le b">EXEC</code>关键字</li><li id="cc4a" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">从 PL/SQL 块调用过程名</li></ul><p id="01b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">可以使用关键字<code class="fe lb lc ld le b">EXEC</code>调用上述名为“welcome”的过程，如下所示:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="da05" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">EXEC</strong> welcome;</span></pre><p id="1d2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在您将看到下一个方法，即从另一个 PL/SQL 块调用过程。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="eaec" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">BEGIN</strong><br/>welcome;<br/><strong class="le ir">END</strong>;</span></pre><p id="c273" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">程序也可以被替换。你只需要在创建程序时添加<code class="fe lb lc ld le b">REPLACE</code>关键字。这将替换已经存在的过程(如果),否则将创建一个新的过程。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="3fdc" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CREATE</strong> <strong class="le ir">OR</strong> <strong class="le ir">REPLACE</strong> <strong class="le ir">PROCEDURE</strong> welcome<br/><strong class="le ir">AS</strong><br/><strong class="le ir">BEGIN</strong><br/>dbms_output.put_line('Hello World!');<br/><strong class="le ir">END</strong>;</span></pre><p id="0e18" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">删除存储过程没什么大不了的:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="5a96" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">DROP</strong> <strong class="le ir">PROCEDURE</strong> <strong class="le ir">procedure</strong>-name;</span></pre><p id="43a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据参数的不同，程序也会有所不同。可以有单参数过程，也可以有多参数过程。现在你将研究这些变体。</p><p id="dd63" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，您将使用同一个表<code class="fe lb lc ld le b">Customers</code>。为了方便起见，下面的部分再次给出了快照。</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/ffd6d902ff0183a9940609d710d9b0b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Xgjb2PRPSXtM-1sA"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk"><strong class="bd nk">Source</strong>: <a class="ae kc" href="https://www.w3schools.com/" rel="noopener ugc nofollow" target="_blank">W3Schools</a></figcaption></figure><p id="b83b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将编写一个存储过程，从表中选择特定城市的客户:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="76e9" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CREATE</strong> <strong class="le ir">PROCEDURE</strong> SelectAllCustomers @City nvarchar(30)<br/><strong class="le ir">AS</strong><br/><strong class="le ir">SELECT</strong> * <strong class="le ir">FROM</strong> Customers <strong class="le ir">WHERE</strong> City = @City<br/><strong class="le ir">GO</strong>;</span></pre><p id="8076" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们在这里剖析一下共同的原则:</p><ul class=""><li id="a01a" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated">您编写了第一个<code class="fe lb lc ld le b">@City</code>，并将其类型和大小定义为程序执行时将给出的参数之一。</li><li id="5031" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">第二个<code class="fe lb lc ld le b">@City</code>被分配给条件变量<code class="fe lb lc ld le b">City</code>，它只是<code class="fe lb lc ld le b">Customers</code>表中的一列。</li></ul><p id="be4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该过程执行如下:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="d160" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">EXEC</strong> SelectAllCustomers City = "London";</span></pre><p id="6efd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们看看另一个变体。</p><p id="ea42" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nl">多参数</em>的编写程序与前面的完全相同。你只需要添加它们。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="6699" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CREATE</strong> <strong class="le ir">PROCEDURE</strong> SelectAllCustomers @City nvarchar(30), @PostalCode nvarchar(10)<br/><strong class="le ir">AS</strong><br/><strong class="le ir">SELECT</strong> * <strong class="le ir">FROM</strong> Customers <strong class="le ir">WHERE</strong> City = @City <strong class="le ir">AND</strong> PostalCode = @PostalCode<br/><strong class="le ir">GO</strong>;</span></pre><p id="05bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按照以下方式执行程序:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="aaf5" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">EXEC</strong> SelectAllCustomers City = "London", PostalCode = "WA1 1DP";</span></pre><p id="f2a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面的代码可读性不是很好吗？当代码可读时，做起来更有趣。手续到此为止。现在您将学习光标。</p><h1 id="a7e8" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">RDBMS 中的游标是什么？</h1><p id="6f7c" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">Oracle 等数据库创建了一个内存区域，称为<em class="nl">上下文区域</em>，用于处理 SQL 语句，其中包含处理该语句所需的所有信息，例如处理的行数。</p><p id="8a16" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">光标是指向该上下文区域的指针。PL/SQL 通过一个<em class="nl">光标</em>控制上下文区域。游标是执行 SQL 语句时在系统内存中创建的临时工作区。游标包含有关 select 语句及其所访问的数据行的信息。因此，游标用于加快大型数据库中查询的处理时间。您可能需要使用数据库游标的原因是，您需要对单独的行执行操作。</p><p id="23fc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">光标有两种类型:</p><ul class=""><li id="5efa" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated">隐式光标</li><li id="1f29" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">显式光标</li></ul><p id="34d6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在您将看到如何编写不同类型的游标。</p><h1 id="1c39" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">写入光标:</h1><p id="e390" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">您将从理解什么是隐式游标开始这一部分。</p><p id="44e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">当没有为 SQL 语句定义显式游标时，每当执行该语句时，Oracle 都会自动创建隐式游标</strong>。程序员不能控制隐式光标和其中的信息。每当发出 DML(数据操作语言)语句(INSERT、UPDATE 和 DELETE)时，都会有一个隐式游标与该语句相关联。对于插入操作，光标保存需要插入的数据。对于更新和删除操作，光标标识将受影响的行。</p><p id="61a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以将最近的隐式游标称为 SQL 游标，它始终具有如下属性:</p><ul class=""><li id="c8ff" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated">找到%个，</li><li id="428b" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">%ISOPEN，</li><li id="707f" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">%未找到，</li><li id="e8e1" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">%ROWCOUNT</li></ul><p id="a6af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下图简要描述了这些属性:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/23f970c34b7df5d5930967c5c272de29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*2h4PEFfo6rgezSOSwvBmUQ.jpeg"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk"><strong class="bd nk">Source</strong>: <a class="ae kc" href="https://www.tutorialspoint.com/plsql/plsql_cursors.htm" rel="noopener ugc nofollow" target="_blank">TutorialsPoint</a></figcaption></figure><p id="e2bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们考虑一个数据库的快照，它包含一个名为<code class="fe lb lc ld le b">Employee</code>的表:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/a360f9d5061e20dc8e79d42552984faa.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/1*bze5BgE9L6TPRzGqfwOVvg.jpeg"/></div></figure><p id="ea1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您将编写一个游标，将年龄小于 30 岁的人的薪水增加 1000 英镑。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="4a09" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">DECLARE</strong><br/>total_rows number(2);</span><span id="8262" class="ne lu iq le b gy no ng l nh ni"><strong class="le ir">BEGIN</strong><br/><strong class="le ir">UPDATE</strong> Employee<br/><strong class="le ir">SET</strong> salary = salary + 1000<br/><strong class="le ir">where</strong> age &lt; 30;<br/><strong class="le ir">IF</strong> <strong class="le ir">sql</strong>%notfound <strong class="le ir">THEN</strong><br/>    dbms_output.put_line('No employees found for under 30 age');<br/><strong class="le ir">ELSIF</strong> <strong class="le ir">sql</strong>%<strong class="le ir">found</strong> <strong class="le ir">THEN</strong><br/>    total_rows := <strong class="le ir">sql</strong>%rowcount;<br/>    dbms_output.put_line( total_rows || ' employees updated ');<br/><strong class="le ir">END</strong> <strong class="le ir">IF</strong>;<br/><strong class="le ir">END</strong>;</span></pre><p id="5115" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们回顾一下你所写的一切:</p><ul class=""><li id="3a9c" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated">您定义了一个名为<code class="fe lb lc ld le b">total_rows</code>的变量，用于存储将受光标操作影响的雇员数量。</li><li id="031f" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">您用<code class="fe lb lc ld le b">BEGIN</code>开始了 cursors 块，并编写了一个简单的 SQL 查询来更新那些年龄小于 30 岁的人的工资。</li><li id="f527" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">如果数据库中没有雇员年龄小于 30 岁的条目，您可以处理输出。您为此使用了<code class="fe lb lc ld le b">%notfound</code>属性。注意，这里的隐式光标<code class="fe lb lc ld le b">sql</code>存储了所有相关信息。</li><li id="7c7d" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">最后，您使用<code class="fe lb lc ld le b">%rowcount</code>属性打印出受游标影响的记录数。</li></ul><p id="c7b3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太好了！你做得很好！</p><p id="dcda" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当在 SQL 提示符下执行上述代码时，它会产生以下结果:</p><blockquote class="np nq nr"><p id="7c95" class="kd ke nl kf b kg kh ki kj kk kl km kn ns kp kq kr nt kt ku kv nu kx ky kz la ij bi translated"><strong class="kf ir">更新了 2 名员工(假设有 2 条记录，其中年龄&lt; 30) </strong></p></blockquote><p id="e4b8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您将学习显式游标。</p><p id="f1cb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">显式光标</strong>对上下文区域进行更多定义的控制。它是在返回多行的 SELECT 语句上创建的。</p><p id="5335" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建显式游标的语法是</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="6461" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CURSOR</strong> <strong class="le ir">cursor_name</strong> <strong class="le ir">IS</strong> select_statement;</span></pre><p id="fcdd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在使用显式游标，您需要遵循如下一系列步骤:</p><ul class=""><li id="72ef" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated">在内存中声明用于初始化的光标</li><li id="46c0" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">打开光标分配内存区域</li><li id="aa95" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">获取用于检索数据的光标</li><li id="141a" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated">关闭光标以释放内存</li></ul><p id="f0b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下图表示典型显式游标的生命周期:</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/a93d84d1d5fb19078c1cff130e79fc07.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/0*rTDQzZNikWs2Eg-O"/></div></figure><p id="e454" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您将进一步了解这些步骤。</p><h1 id="db2c" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">声明光标:</h1><p id="e0e7" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">您声明了一个游标和一个<code class="fe lb lc ld le b">SELECT</code>语句。例如:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="2d54" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CURSOR</strong> <strong class="le ir">C</strong> <strong class="le ir">IS</strong> <strong class="le ir">SELECT</strong> id, name, address <strong class="le ir">FROM</strong> Employee <strong class="le ir">where</strong> age &gt; 30;</span></pre><h1 id="9e01" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">打开光标:</h1><p id="2748" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">当您打开游标时，CPU 会为游标分配内存，并准备好获取 SQL 语句返回的行。例如，我们将打开上面定义的光标，如下所示:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="5a78" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">OPEN</strong> <strong class="le ir">C</strong>;</span></pre><h1 id="49f9" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">获取光标:</h1><p id="68ca" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">获取游标涉及到从游标所需的 SQL 中的关联表中一次访问一行。</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="26de" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">FETCH</strong> <strong class="le ir">C</strong> <strong class="le ir">INTO</strong> C_id, C_name, C_address;</span></pre><h1 id="3e11" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">关闭光标:</h1><p id="5422" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">关闭游标意味着释放分配的内存。您将关闭上面打开的光标，如下所示:</p><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="49a1" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">CLOSE</strong> <strong class="le ir">C</strong>;</span></pre><p id="43a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你现在要以一种有意义的方式把所有这些部分组合在一起。</p><h1 id="a705" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">组装这些零件:</h1><pre class="mw mx my mz gt na le nb nc aw nd bi"><span id="873e" class="ne lu iq le b gy nf ng l nh ni"><strong class="le ir">DECLARE</strong><br/>C_id Employee.ID%<strong class="le ir">type</strong>;<br/>C_name Employee.NAME%<strong class="le ir">type</strong>;<br/>C_address Employee.ADDRESS%<strong class="le ir">type</strong>;<br/><strong class="le ir">CURSOR</strong> <strong class="le ir">C</strong> <strong class="le ir">is</strong><br/><strong class="le ir">SELECT</strong> id, name, address <strong class="le ir">FROM</strong> Employee <strong class="le ir">where</strong> age &gt; 30;<br/><strong class="le ir">BEGIN</strong><br/><strong class="le ir">OPEN</strong> <strong class="le ir">C</strong>;<br/>LOOP<br/><strong class="le ir">FETCH</strong> <strong class="le ir">C</strong> <strong class="le ir">INTO</strong> C_id, C_name, C_address; <br/>dbms_output.put_line(ID || ' ' || NAME || ' ' || ADDRESS); <br/>EXIT <strong class="le ir">WHEN</strong> <strong class="le ir">C</strong>%notfound;<br/><strong class="le ir">END</strong> LOOP;<br/><strong class="le ir">CLOSE</strong> <strong class="le ir">C</strong>;<br/><strong class="le ir">END</strong>;</span></pre><p id="973d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您还学习了声明游标变量 C_id、C_name 和 C_address。<code class="fe lb lc ld le b">C_id Employee.ID%type;</code> -这确保了创建 C_id 的数据类型与在<code class="fe lb lc ld le b">Employee</code>表中 id 的数据类型相同。</p><p id="1d7e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过使用<code class="fe lb lc ld le b">LOOP</code>,您可以通过光标循环读取记录并显示出来。如果光标没有找到记录，您也可以处理这种情况。</p><p id="c9a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当在 SQL 提示符下执行代码时，它会产生</p><figure class="mw mx my mz gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/abe2e1c06a3af5e9418277fe30659f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/0*RUdmEYmIY9DUoVGk.jpg"/></div></figure><h1 id="8dcb" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">结论:</h1><p id="32f9" class="pw-post-body-paragraph kd ke iq kf b kg mr ki kj kk ms km kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">恭喜你。你已经坚持到最后了。您讨论了数据库世界中最流行的两个主题——过程和游标。这些在处理大量事务的应用程序中很常见。是的，你猜对了！银行自古以来就在使用这些。您学习了如何编写一个过程，它有哪些不同的类型以及为什么会这样。您还学习了游标及其几种变体，以及如何编写它们。</p><p id="e21b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太神奇了！</p><p id="188c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是撰写本教程的一些参考资料:</p><ul class=""><li id="b15d" class="lf lg iq kf b kg kh kk kl ko lh ks li kw lj la lk ll lm ln bi translated"><a class="ae kc" href="https://www.amazon.com/Oracle-SQL-Programming-Steven-Feuerstein/dp/1565923359" rel="noopener ugc nofollow" target="_blank"> Oracle PL/SQL 编程</a></li><li id="31d2" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated"><a class="ae kc" href="https://www.tutorialspoint.com/plsql/plsql_cursors.htm" rel="noopener ugc nofollow" target="_blank">光标上的 TutorialsPoint 博客</a></li><li id="7591" class="lf lg iq kf b kg lo kk lp ko lq ks lr kw ls la lk ll lm ln bi translated"><a class="ae kc" href="https://www.w3schools.com/sql/sql_stored_procedures.asp" rel="noopener ugc nofollow" target="_blank"> SQL 存储过程— W3Schools </a></li></ul></div></div>    
</body>
</html>