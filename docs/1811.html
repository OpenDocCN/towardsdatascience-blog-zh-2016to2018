<html>
<head>
<title>Distributed training in the cloud: Cloud Machine Learning Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云中的分布式训练:云机器学习引擎</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/distributed-training-in-the-cloud-cloud-machine-learning-engine-9e264ddde27f?source=collection_archive---------0-----------------------#2017-10-27">https://towardsdatascience.com/distributed-training-in-the-cloud-cloud-machine-learning-engine-9e264ddde27f?source=collection_archive---------0-----------------------#2017-10-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eeea41cb65c25bfe5fcad11ddbdf8cf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PT6dmb_kl1fjdE5kXQcMaA.jpeg"/></div></div></figure><p id="1d62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我关于在云中训练大模型的<a class="ae kw" href="https://medium.com/towards-data-science/big-data-for-training-models-in-the-cloud-32e0df348196" rel="noopener">集</a>的这个激动人心的结论中，我将向您展示如何为机器学习扩展您的计算能力，甚至召集一些GPU！</p><p id="5db2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的培训会有足够的资源吗？观看视频(或阅读下文)了解详情！</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="lb lc l"/></div></figure></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><p id="b5fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://medium.com/towards-data-science/big-data-for-training-models-in-the-cloud-32e0df348196" rel="noopener">上一集</a>中，我们讨论了当数据集太大而不适合本地机器时会遇到的问题，我们还讨论了如何通过可扩展的存储将数据转移到云中。</p><h2 id="ad90" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">机器学习中的并行训练</h2><p id="7066" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">今天，我们继续这个问题的第二部分——将这些计算资源放在一起。当训练更大的模型时，当前的方法包括并行进行训练<em class="mi"/>。我们的数据被分割并发送到许多工作机器，然后模型必须将从每台机器获得的信息和信号重新组合在一起，以创建完全训练的模型。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/c290c7b3e005ccb05bc21e246346b067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YcyIWYfKpROVzUvxB69ILA.png"/></div></div></figure><h2 id="1e95" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">你爱配置吗？</h2><p id="4120" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">如果你愿意，你可以<em class="mi">启动一些虚拟机，安装必要的库，将它们联网，并配置它们运行分布式机器学习。当你完成后，你一定要把那些机器拿下来。</em></p><p id="ed76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然对于一些人来说，这表面上看起来很容易，但如果你不熟悉安装GPU驱动程序、不同版本的底层库之间的兼容性问题，这可能是一个挑战。</p><h1 id="6a62" class="mk ll iq bd lm ml mm mn lp mo mp mq ls mr ms mt lv mu mv mw ly mx my mz mb na bi translated">云机器学习引擎</h1><p id="a095" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">幸运的是，我们将使用云机器学习引擎的训练功能，从Python代码到训练好的模型，不需要任何基础设施工作！该服务根据需要自动获取和配置资源，并在完成训练后关闭系统。</p><p id="a31e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用云ML引擎有3个主要步骤:</p><blockquote class="nb"><p id="2ffe" class="nc nd iq bd ne nf ng nh ni nj nk kv dk translated">1)打包您的Python代码<br/> 2)创建一个描述您想要的机器类型的配置文件<br/> 3)将您的培训作业提交到云</p></blockquote><p id="9733" class="pw-post-body-paragraph jy jz iq ka b kb nl kd ke kf nm kh ki kj nn kl km kn no kp kq kr np kt ku kv ij bi translated">让我们看看如何设置我们的培训来利用这项服务。</p><h2 id="0406" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">步骤1:打包您的Python代码</h2><p id="b603" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">我们已经将我们的Python代码从Jupyter笔记本中转移到一个独立的脚本中。让我们把那个文件叫做<code class="fe nq nr ns nt b">task.py</code>。这将作为我们的Python模块，然后可以从其他文件中调用它。</p><p id="e064" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们将<code class="fe nq nr ns nt b">task.py</code>包装在一个Python包中。Python包的制作方法是将模块放在另一个文件夹中，姑且称之为“<code class="fe nq nr ns nt b">trainer</code>”，并将一个空文件<code class="fe nq nr ns nt b">__init__.py</code>放在<code class="fe nq nr ns nt b">task.py</code>旁边。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/139e7c274c456ab47a9d98eabde58c07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hTpHdWjazrz8bHk2MIQHFw.png"/></div></div></figure><p id="7f4e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们最终的文件结构由一个名为trainer的文件夹组成，包含两个文件:<code class="fe nq nr ns nt b">__init__.py</code>和<code class="fe nq nr ns nt b">task.py</code>。我们的包叫做<em class="mi"> trainer </em>，我们的模块路径是<em class="mi"> trainer.task </em>。如果您想将代码分解成更多的组件，您也可以将这些组件包含在这个文件夹中。例如，您可能在<code class="fe nq nr ns nt b">trainer</code>文件夹中有一个<code class="fe nq nr ns nt b">util.py</code>。</p><h2 id="7396" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">步骤2:配置文件:config.yaml</h2><p id="11d4" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">一旦我们的代码被打包到一个Python包中，就该创建一个配置文件来指定您希望在什么机器上运行您的培训了。您可以选择在少量机器(少至一台)上运行培训，也可以在多台机器上运行，并附带GPU。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/dee018d1b66fa20aa5e9ff328de9c190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*OCVRxu9A9TYvnr8M-xje9g.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk">Using a predefined scale tier is as simple as it gets</figcaption></figure><p id="b768" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有几个<a class="ae kw" href="https://cloud.google.com/ml-engine/docs/concepts/training-overview#scale_tier" rel="noopener ugc nofollow" target="_blank">预定义的规范</a>使入门变得格外容易，一旦你不再需要这些规范，你就可以随心所欲地配置一个<a class="ae kw" href="https://cloud.google.com/ml-engine/docs/training-overview#machine_type_table" rel="noopener ugc nofollow" target="_blank">定制架构</a>。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/5fda05153ab1a95443de21b123225f3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mvBbi8X_dnussNI5__FHsg.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk">For a custom cluster, all you need to do is specify the machine types you want</figcaption></figure><p id="9c9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们已经打包好python代码，并写出了配置文件。让我们进入你们期待已久的一步，训练！</p><h2 id="95f4" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">步骤3:提交您的培训工作</h2><p id="24f3" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">为了提交一个培训作业，我们将使用<code class="fe nq nr ns nt b">gcloud</code>命令行工具并运行<code class="fe nq nr ns nt b">gcloud ml-engine jobs submit training</code>。这个调用还有一个REST API等价物。</p><p id="8f33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们指定一个惟一的作业名、包路径和模块名、运行作业的区域以及存放培训输出的云存储目录。确保使用与存储数据相同的区域，以获得最佳性能。</p><p id="ea7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe nq nr ns nt b">gcloud ml-engine jobs submit training \<br/> job-id $JOB_ID \<br/> package-path=trainer \<br/> module-path=trainer.task \<br/> region=us-central-1 \<br/> job_dir=gs://cloudml-demo/widendeep</code></p><p id="b332" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦您运行这个命令，您的python包将被压缩并上传到我们刚刚指定的目录中。从那里，包将在云中运行，在我们在配置中指定的机器上运行。</p><h2 id="1a81" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">看着训练进行！</h2><p id="59dd" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">您可以在<a class="ae kw" href="https://console.cloud.google.com/home/dashboard?project=serverless-ml" rel="noopener ugc nofollow" target="_blank">云控制台</a>中通过进入ML引擎并选择作业来监控您的培训作业。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/24470e16ad817a60f2bf89a1ad0f4d80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jqpi1zr_C1QNCyyDJcMnwQ.png"/></div></div></figure><p id="83fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在那里，我们将看到我们曾经运行过的所有作业的列表，包括当前作业。右边是一个计时器，显示了作业所用的时间，还有一个链接指向来自模型的日志信息。</p><figure class="kx ky kz la gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/c5c07cca087d53953541ff96d2a27409.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MmL9kVpjaNWFfiNF4GtB3g.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk">Some models take a bit longer to train than others ;-)</figcaption></figure><h2 id="bc63" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">预测呢？</h2><p id="39c8" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">我们的代码将训练好的模型导出到我们在作业目录中提供的云存储路径，因此从这里我们可以轻松地将预测服务直接指向输出，并创建一个预测服务，正如我们在第4集<a class="ae kw" href="https://medium.com/@yufengg/serverless-predictions-at-scale-28ab77203a42" rel="noopener">中讨论的无服务器大规模预测</a>。</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="008a" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">后续步骤</h2><p id="f2fe" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">使用云机器学习引擎，我们可以实现分布式训练，而不用自己处理基础设施。因此，我们可以花更多时间处理数据！只需打包代码，添加一个配置文件，然后提交培训作业。如果你想看更完整的例子，你可以查看云机器学习<a class="ae kw" href="https://cloud.google.com/ml-engine/docs/getting-started-training-prediction" rel="noopener ugc nofollow" target="_blank">入门指南</a>。</p><p id="dbd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想知道TensorFlow的分布式培训模式是如何工作的，请查看来自TensorFlow发展峰会的深度演讲:【https://youtu.be/la_M6bCV91M<a class="ae kw" href="https://youtu.be/la_M6bCV91M" rel="noopener ugc nofollow" target="_blank"/></p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><p id="6078" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢阅读本集<a class="ae kw" href="https://goo.gl/UC5usG" rel="noopener ugc nofollow" target="_blank">云AI冒险</a>。如果你喜欢这个系列，请为这篇文章鼓掌让我知道。如果你想要更多的机器学习动作，一定要关注Medium上的<a class="ae kw" href="https://medium.com/@yufengg" rel="noopener">me</a>或<a class="ae kw" href="https://goo.gl/S0AS51" rel="noopener ugc nofollow" target="_blank">订阅YouTube频道</a>以捕捉未来的剧集。更多剧集即将推出！</p></div></div>    
</body>
</html>