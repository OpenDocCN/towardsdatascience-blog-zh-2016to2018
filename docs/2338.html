<html>
<head>
<title>What’s After Setting up a GCP Computing Instance? Running a Custom Docker Container with Tensorflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设置 GCP 计算实例后会发生什么？使用 Tensorflow 运行自定义 Docker 容器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/whats-after-setting-up-a-gcp-computing-instance-running-a-custom-docker-container-with-tensorflow-eb0f077983c6?source=collection_archive---------7-----------------------#2018-01-11">https://towardsdatascience.com/whats-after-setting-up-a-gcp-computing-instance-running-a-custom-docker-container-with-tensorflow-eb0f077983c6?source=collection_archive---------7-----------------------#2018-01-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0ef5c36946cb62b9e4eae49819f2fd4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nv8KUH2eNlhVK-jheFkmfQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">pixabay.com</figcaption></figure><figure class="kd ke kf kg gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kc"><img src="../Images/29f3d9cf2b815997af4a1e28a475457c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RAiVtPyJ_pe-cg8Dlg4gFQ.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">What we should see after setting up</figcaption></figure><h1 id="b1fe" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">介绍</h1><p id="69de" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">随着深度学习的出现和“模型越深，性能越好”的实现，谷歌云平台(GCP)等基于云的计算平台获得了相当多的关注(我在这里不是为了争论这个概念的真实性，而只是陈述一个被广泛接受的信念)。以及“模型越深，计算资源应该越好”。</p><p id="1866" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">无论何时发布最新的 GPU 卡，购买并安装它们都不是经济可行的策略(尤其是对于中小型技术机构)。如果一个人采用这种策略，他应该为下面的挑战做好准备。</p><ul class=""><li id="feee" class="mi mj iq lh b li md lm me lq mk lu ml ly mm mc mn mo mp mq bi translated">做出巨大的金钱牺牲来购买最新的 GPU 卡和必要的基础设施</li><li id="e367" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated">维护基础设施以确保不间断服务</li><li id="aa19" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated">为多个用户开发资源分配方案</li></ul><p id="ecaf" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">然而，GCP 提供了这种服务，只收取很少的费用(当然从长远来看会增加)。但重要的是，您不必担心维护或初始设置(例如安装操作系统(OS))，并提供多种定制选项供您选择(例如操作系统、磁盘存储、GPU 类型、GPU 数量等)。).例如，你可以选择一个使用 Ubuntu 16.04、50GB 存储、2 特斯拉 P100 图形处理器等的实例。</p><p id="3bbc" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">在这篇文章中，我将讨论如何设置一个自定义的 docker 映像，创建一个包含该映像的容器，并在其中运行 python + Tensorflow 脚本。</p><h1 id="8cd8" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">初始设置</h1><p id="e219" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">我不打算进行设置，有很多很好的资源解释了如何在 GCP 上创建和设置一个计算实例。我最喜欢的一个是，</p><div class="mx my gp gr mz na"><a href="https://medium.com/google-cloud/jupyter-tensorflow-nvidia-gpu-docker-google-compute-engine-4a146f085f17" rel="noopener follow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd ir gy z fp nf fr fs ng fu fw ip bi translated">jupyter+tensor flow+Nvidia GPU+Docker+Google 计算引擎</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">TL；DR:按照下面的方法使用 Tensorflow、Jupyter、Docker 和 Nvidia GPUs，可以节省时间，减少麻烦…</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">medium.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no jw na"/></div></div></a></div><p id="3523" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">我会用简单的英语总结一下里面的内容，</p><ul class=""><li id="3f73" class="mi mj iq lh b li md lm me lq mk lu ml ly mm mc mn mo mp mq bi translated">首先定义防火墙规则，允许 TCP 通过几个端口进行通信(tensorboard:6006，ftp:21-22，jupyter:8888)</li><li id="61c5" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated">使用防火墙规则在 GCP 上设置一个计算实例</li><li id="d882" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated">在实例上安装 CUDA</li><li id="e6e6" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated">在实例上安装 Docker 和 Nvidia-Docker</li></ul><h1 id="4cb7" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">那么初始设置之后会发生什么呢？</h1><p id="a8dc" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">在这里我们要讨论从这里向何处去。首先让我说明我将使用的库和版本。</p><ul class=""><li id="f2e5" class="mi mj iq lh b li md lm me lq mk lu ml ly mm mc mn mo mp mq bi translated">Python: 3.4</li><li id="4ba2" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated">张量流:1.3</li></ul><p id="0bd7" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">我现在简要总结一下我们要做的事情。我们将首先下载一个支持<strong class="lh ir"> python 3.x Tensorflow </strong>的图片。然后我们将用下载的图像创建一个容器。最后，我们将运行一些命令，以确保它的工作。</p><p id="89b8" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">PS: 你想用哪个 python 版本取决于你想解决的问题。python 3.x 和 python 2.x 之间存在<a class="ae mw" href="https://wiki.python.org/moin/Python2orPython3" rel="noopener ugc nofollow" target="_blank">差异</a>，然而，python 2.x 将在不久的将来<a class="ae mw" href="https://pythonclock.org/" rel="noopener ugc nofollow" target="_blank">退役</a>，python 3.x 将取而代之。所以最好从 python 2.x 迁移到 python 3.x</p><h1 id="7472" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">SSH 到实例中</h1><p id="9aa4" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">要 ssh 到 GCP 实例，您可以使用</p><ul class=""><li id="b813" class="mi mj iq lh b li md lm me lq mk lu ml ly mm mc mn mo mp mq bi translated"><a class="ae mw" href="https://cloud.google.com/shell/docs/" rel="noopener ugc nofollow" target="_blank"> gcloud Shell </a></li><li id="504d" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated"><a class="ae mw" href="https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys" rel="noopener ugc nofollow" target="_blank">第三方外壳</a>(例如 Windows 上的 Ubuntu 外壳或 Putty)</li></ul><h1 id="969e" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">下载兼容的 Docker 映像</h1><p id="952a" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">遗憾的是，gcr.io 并没有为我们提供一张 python 3.x 兼容的 Tensorflow 图片，而只是 python 2.x 兼容的 Tensorflow 图片。所以我们必须从<a class="ae mw" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> DockerHub </a>下载一个兼容 python 3.x 的 Tensorflow 图像。并且可以在 DockerHub 中看到所有的<a class="ae mw" href="https://hub.docker.com/r/tensorflow/tensorflow/tags/" rel="noopener ugc nofollow" target="_blank"> Tensorflow 图片。</a></p><p id="c1ad" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">我将使用<strong class="lh ir"> 1.3.0-gpu-py3 </strong>图像(如果您向下滚动 DockerHub 中的<a class="ae mw" href="https://hub.docker.com/r/tensorflow/tensorflow/tags/" rel="noopener ugc nofollow" target="_blank"> Tensorflow 图像，您会看到这一点)</a></p><p id="87af" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">使用 gcloud shell 或终端将第一个 ssh 下载到您的实例中。一旦有了访问类型，</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="d3f6" class="nu ki iq nq b gy nv nw l nx ny">sudo docker pull tensorflow/tensorflow:1.3.0-gpu-py3</span></pre><p id="1922" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">当您键入这个内容时，Docker 将自动查找带有在双冒号后指定的标记名的图像(当然是在 DockerHub 中)。然后，您应该在 shell 中看到正在下载和提取的图像。要确保图像已下载，请尝试</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="299e" class="nu ki iq nq b gy nv nw l nx ny">sudo docker images</span></pre><p id="ee95" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">您应该会看到列出的图像</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="bb2e" class="nu ki iq nq b gy nv nw l nx ny">REPOSITORY            TAG             IMAGE ID       CREATED   SIZE<br/>nvidia/cuda           latest          af786b192aa5   10 days ago   2.16GB<br/>tensorflow/tensorflow 1.3.0-gpu-py3   ae2207c21bc1   5 months ago 3.29GB</span></pre><h1 id="486c" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">用图像创建并运行 Docker 容器</h1><p id="cb1d" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">这个操作完成后，我们可以用图像创建一个 docker 容器。但在此之前，先创建一个名为<strong class="lh ir">docker _ tensor flow _ example</strong>的文件夹。这将保存我们在容器内运行时创建的数据，稍后我们将讨论如何进行映射。然后将该文件夹的权限更改为:</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="2a93" class="nu ki iq nq b gy nv nw l nx ny">​ sudo chmod 755 ~/docker_tensorflow_example/</span></pre><p id="8456" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">所以主人有完全的权限。然后我们创建 docker 容器，</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="2dbb" class="nu ki iq nq b gy nv nw l nx ny">nvidia-docker run -it -v ~/docker_tensorflow_example/:/root/docker_tensorflow_example — name docker-py3-tensorflow tensorflow/tensorflow:1.3.0-gpu-py3 bash<br/>​</span></pre><p id="2b11" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">那是一口不是吗？那我们就把这个宝贝拆成碎片吧，</p><ul class=""><li id="c2b4" class="mi mj iq lh b li md lm me lq mk lu ml ly mm mc mn mo mp mq bi translated"><a class="ae mw" href="https://github.com/NVIDIA/nvidia-docker" rel="noopener ugc nofollow" target="_blank"><strong class="lh ir">NVIDIA-docker</strong></a>——是一个在 NVIDIA GPU 上运行 Docker 容器的 Docker 引擎实用程序。docker 顶部的包装</li><li id="2b38" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated"><a class="ae mw" href="https://docs.docker.com/engine/reference/run/" rel="noopener ugc nofollow" target="_blank"><strong class="lh ir"/></a><strong class="lh ir"/>—意思是运行 docker 容器</li><li id="a6d8" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated"><strong class="lh ir">-it</strong>-表示即使没有连接任何东西，也要保持容器打开(这样我们就可以运行东西，脱离遥控器，在我们这边，关闭本地计算机。</li><li id="33c7" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated"><strong class="lh ir"> -v src_dir:target_dir </strong> —将本地目录映射到容器中的一个目录。请记住，当您停止容器时，容器以及其中保存的所有数据都会消失。因此，该选项将在容器文件夹(target_dir)中创建的所有数据映射到存储上的实际目录(source_dir)。</li><li id="59c7" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated"><strong class="lh ir">-name docker-py3-tensor flow</strong>-这是我们正在创建的容器的名称。使用一个特定的名字也将阻止我们盲目地创建容器(因为如果你不指定一个名字，docker 会用一个随机的名字创建容器。如果你指定了一个名字，docker 将会抱怨同名的容器已经存在)</li><li id="9edf" class="mi mj iq lh b li mr lm ms lq mt lu mu ly mv mc mn mo mp mq bi translated"><strong class="lh ir">tensor flow/tensor flow:1 . 3 . 0-GPU-py3</strong>—告诉 docker 使用哪个图像来创建容器。</li></ul><h1 id="05ad" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">关于 nvidia-docker 要记住的事情</h1><p id="233a" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">如果您看到错误，</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="25d9" class="nu ki iq nq b gy nv nw l nx ny">nvidia-docker: command not found</span></pre><p id="bd06" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">那么您可能必须首先以 root 用户身份登录，</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="b5bb" class="nu ki iq nq b gy nv nw l nx ny">sudo -s</span></pre><p id="1d77" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">并重试该命令。</p><h1 id="7b89" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">正在启动 Jupyter 笔记本服务器</h1><p id="685e" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">如果您需要运行 Jupyter 笔记本服务器，请使用上面的命令，不要使用 bash。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="8e65" class="nu ki iq nq b gy nv nw l nx ny">nvidia-docker run -it -v ~/docker_tensorflow_example/:/root/docker_tensorflow_example — name docker-py3-tensorflow tensorflow/tensorflow:1.3.0-gpu-py3<br/>​</span></pre><h1 id="8025" class="kh ki iq bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">测试容器</h1><p id="11ca" class="pw-post-body-paragraph lf lg iq lh b li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">现在，您应该已经运行了 docker 容器，并且您的 shell 应该在容器中，终端应该有提示，</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="2bcf" class="nu ki iq nq b gy nv nw l nx ny">root@8301xxxxxxxx: ~/</span></pre><p id="fb4e" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">其中 8301xxxxxxxx 是容器 ID。现在试试，</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="3813" class="nu ki iq nq b gy nv nw l nx ny">python3</span></pre><p id="01ae" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">试着，</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="8392" class="nu ki iq nq b gy nv nw l nx ny">import tensorflow as tf<br/>print(tf.__version__)</span></pre><p id="95a1" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">这应该可以正常工作，您应该得到 1.3.0 作为输出。如果出现这种情况，恭喜你！您已经安装了库。如果没有，请确保您遵循了当前初始设置和设置 docker 容器的步骤。</p><p id="8e25" class="pw-post-body-paragraph lf lg iq lh b li md lk ll lm me lo lp lq mf ls lt lu mg lw lx ly mh ma mb mc ij bi translated">干杯！</p></div></div>    
</body>
</html>