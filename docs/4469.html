<html>
<head>
<title>Interpreting your deep learning model by SHAP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解读 SHAP 的深度学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/interpreting-your-deep-learning-model-by-shap-e69be2b47893?source=collection_archive---------0-----------------------#2018-08-18">https://towardsdatascience.com/interpreting-your-deep-learning-model-by-shap-e69be2b47893?source=collection_archive---------0-----------------------#2018-08-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/915cf86423701bda636705d6a09e5f1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fF_O5qydEjBZVUSg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Photo by <a class="ae kf" href="https://unsplash.com/@jeshoots?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">JESHOOTS.COM</a> on <a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e276" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">前面的<a class="ae kf" rel="noopener" target="_blank" href="/3-ways-to-interpretate-your-nlp-model-to-management-and-customer-5428bc07ce15">篇</a>提到过，模型解释非常重要。这篇文章继续这个话题，但分享另一个著名的库是夏普利附加解释(SHAP)[1]。Lundberg 等人提出了解释模型预测的统一方法。</p><p id="82d8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">看完这篇文章，你会明白:</p><ul class=""><li id="7626" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">什么是沙普利值</li><li id="ac79" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">沙普利添加剂解释(SHAP)</li><li id="9b75" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">用例</li><li id="2a8e" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">外卖食品</li></ul><h1 id="6a33" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">沙普利值</h1><p id="51fe" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">在介绍 SHAP 之前，我们先来看看合作博弈理论中的解概念——沙普利值。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/53210a6ebed6a2ebbeb823517971d8b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*i1hBNV_nM-qQoOFOvNz8sg.png"/></div></figure><p id="d36a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们以一个开发团队为例。我们的目标是交付一个深度学习模型，它需要完成 100 行代码，而我们有 3 个数据科学家(L，M，N)。他们中的 3 个人必须一起工作来完成这个项目。鉴于:</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi na"><img src="../Images/b7a322e6c078c10b2d8a087a8bdb6690.png" data-original-src="https://miro.medium.com/v2/resize:fit:492/format:webp/1*ArZVijQ-I_nNpn-0pukSpg.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Contribution among coalition</figcaption></figure><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/257ea9192eeb0b30e85950c2a2dcca11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DLL5sCQKeVXboAYIvdgwUw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">Marginal Contribution by different orders</figcaption></figure><p id="e5f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们有 3 名球员，所以总组合是 3！也就是 6。上表显示了不同联盟顺序的贡献。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/75cf854a5e23bbbbe55fbb94cf39a37d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*uGjQRe9U0ebC5HxYXAzg3A.png"/></div></figure><p id="fb59" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据 Sherley 值公式，我们有上表。虽然 M 的能力比 N 大 6 倍(30 比 5)，但是 M 应该得到 41.7%的奖励，而 N 应该得到 24.17%的奖励。</p><h1 id="4f03" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">沙普利添加剂解释(SHAP)</h1><p id="8410" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">这个想法是用博弈论来解释目标模型。所有特征都是“贡献者”,并试图预测“游戏”任务，而“回报”是实际预测减去解释模型的结果。</p><p id="689b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 SHAP，特征重要性被分配给每个特征，其等同于所提到的贡献。让我们以汽车贷款(车贷)为例。我们有“新司机”、“有孩子”、“4 门”、“年龄”。</p><p id="ef7f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">理论上，组合数是 2^n，其中 n 是特征数。鉴于我们想知道“年龄”的 Shapley 值。我们将预测以下所有带有和不带有“年龄”特征的组合。提到了一些优化</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/126ee1b42f1adecc8e5818df317c9847.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*fdqZ1XivRBZzuuvyv8yvhw.png"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk">All possible combinations</figcaption></figure><p id="0b80" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过使用沙普利公式，SHAP 将计算所有上述情况，并返回平均贡献和。换句话说，当特定功能错过了时，<strong class="ki iu">没有谈论差异。</strong></p><h1 id="4e3d" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">用例</h1><p id="99cd" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">SHAP 为不同类型的模型提供了多种解释者。</p><ul class=""><li id="7259" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">TreeExplainer:支持 XGBoost、LightGBM、CatBoost 和 scikit-learn 模型，由 Tree SHAP 开发。</li><li id="8fc7" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">DeepExplainer(深度 SHAP):通过使用 DeepLIFT 和 Shapley 值支持 TensorFlow 和 Keras 模型。</li><li id="9ded" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">GradientExplainer:支持 TensorFlow 和 Keras 模型。</li><li id="5732" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">KernelExplainer(内核 SHAP):通过使用 LIME 和 Shapley 值应用于任何模型。</li></ul><p id="343b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面的示例代码将展示我们如何使用 DeepExplainer 和 KernelExplainer 来解释文本分类问题。</p><p id="3293" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">深度解说</strong></p><pre class="mw mx my mz gt ne nf ng nh aw ni bi"><span id="acd1" class="nj lt it nf b gy nk nl l nm nn">explainer = shap.DeepExplainer(pipeline.model, encoded_x_train[:10])<br/>shap_values = explainer.shap_values(encoded_x_test[:1])</span><span id="4740" class="nj lt it nf b gy no nl l nm nn">x_test_words = prepare_explanation_words(pipeline, encoded_x_test)<br/>y_pred = pipeline.predict(x_test[:1])<br/>print('Actual Category: %s, Predict Category: %s' % (y_test[0], y_pred[0]))</span><span id="453b" class="nj lt it nf b gy no nl l nm nn">shap.force_plot(explainer.expected_value[0], shap_values[0][0], x_test_words[0])</span></pre><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/f38d4a8e0f59d66ae0568cb0b1082593.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sFVO1AqlAg1kxCRU2Cumcw.png"/></div></div></figure><p id="ba62" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">内核解释器</strong></p><pre class="mw mx my mz gt ne nf ng nh aw ni bi"><span id="1b39" class="nj lt it nf b gy nk nl l nm nn">kernel_explainer = shap.KernelExplainer(pipeline.model.predict, encoded_x_train[:10])<br/>kernel_shap_values = kernel_explainer.shap_values(encoded_x_test[:1])</span><span id="b077" class="nj lt it nf b gy no nl l nm nn">x_test_words = prepare_explanation_words(pipeline, encoded_x_test)<br/>y_pred = pipeline.predict(x_test[:1])<br/>print('Actual Category: %s, Predict Category: %s' % (y_test[0], y_pred[0]))</span><span id="9369" class="nj lt it nf b gy no nl l nm nn">shap.force_plot(kernel_explainer.expected_value[0], kernel_shap_values[0][0], x_test_words[0])</span></pre><figure class="mw mx my mz gt ju gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/e484990bb4c9fdcb4683a000054e914d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*SGD0dAQJkKhGJneq_lHsdQ.png"/></div></figure><h1 id="9def" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">外卖食品</h1><p id="d4bd" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">要访问所有代码，你可以访问我的 github repo。</p><ul class=""><li id="e3c0" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">当你阅读<a class="ae kf" href="https://christophm.github.io/interpretable-ml-book/" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu"> Christoph 的博客</strong> </a>时，你可以参考上面代码的<a class="ae kf" href="https://christophm.github.io/interpretable-ml-book/shapley.html" rel="noopener ugc nofollow" target="_blank"> Shapley 值解释</a>部分。</li><li id="047a" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">Shapley 值是在不同情况下预测的特征的平均贡献。换句话说，当特定功能错过了时，这就是<strong class="ki iu">没有谈论差异。</strong></li><li id="0f76" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">SHAP 包括<strong class="ki iu">多种算法</strong>。你可以查看关于石灰、深度提升、夏普利值计算的更多细节。</li><li id="34aa" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">有可能 DeepExplainer 和 KernelExplainer <strong class="ki iu">引入了不同的结果</strong>。</li></ul><h1 id="a159" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">延伸阅读</h1><ul class=""><li id="20e1" class="le lf it ki b kj mq kn mr kr nr kv ns kz nt ld lj lk ll lm bi translated"><a class="ae kf" href="https://www.kaggle.com/dansbecker/advanced-uses-of-shap-values" rel="noopener ugc nofollow" target="_blank">SHAP 值的高级用途</a></li></ul><h1 id="8bed" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">关于我</h1><p id="49f6" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">我是湾区的数据科学家。专注于数据科学、人工智能，尤其是 NLP 和平台相关领域的最新发展。你可以通过<a class="ae kf" href="http://medium.com/@makcedward/" rel="noopener">媒体</a>或者<a class="ae kf" href="https://github.com/makcedward" rel="noopener ugc nofollow" target="_blank"> Github </a>联系到我。</p><h1 id="f1ed" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">参考</h1><p id="5be2" class="pw-post-body-paragraph kg kh it ki b kj mq kl km kn mr kp kq kr ms kt ku kv mt kx ky kz mu lb lc ld im bi translated">[1]伦德伯格 S. M .，李素英。解释模型预测的统一方法。2017.<a class="ae kf" href="http://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions.pdf" rel="noopener ugc nofollow" target="_blank">http://papers . nips . cc/paper/7062-a-unified-approach-to-interpretation-model-predictions . pdf</a></p><p id="d306" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">[2] Lundberg S. M .，Erion G. G .，Lee Su-In .树集成的一致个性化特征属性。2017.<a class="ae kf" href="https://arxiv.org/pdf/1802.03888.pdf" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/1802.03888.pdf</a></p></div></div>    
</body>
</html>