<html>
<head>
<title>Getting started with mlFlow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">mlFlow 入门</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-mlflow-52eff8c09c61?source=collection_archive---------7-----------------------#2018-12-17">https://towardsdatascience.com/getting-started-with-mlflow-52eff8c09c61?source=collection_archive---------7-----------------------#2018-12-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/6582a307d7689d31660c632b616b4799.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*kFyW5qtNayFJQF0QblhWTA.png"/></div></figure><h1 id="ce10" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">什么是 mlFlow？</h1><p id="bbdc" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">mlFlow 是一个支持机器学习生命周期的框架。这意味着它具有在训练和运行期间监控模型的组件，能够存储模型，在生产代码中加载模型并创建管道。</p><p id="0a15" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">该框架引入了 3 个不同的特性，每个特性都有自己的功能。</p><h2 id="9e7a" class="lv jv iq bd jw lw lx dn ka ly lz dp ke ld ma mb ki lh mc md km ll me mf kq mg bi translated">物流跟踪</h2><p id="c873" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">跟踪可能是该框架最有趣的特性。它允许您围绕您的模型创建一个广泛的日志框架。您可以定义自定义指标，以便在运行后可以将输出与之前的运行进行比较。</p><p id="51cc" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">我们将主要关注这一部分，但也给你一窥其他功能。</p><h2 id="3df2" class="lv jv iq bd jw lw lx dn ka ly lz dp ke ld ma mb ki lh mc md km ll me mf kq mg bi translated">MlFlow 项目</h2><p id="b4e2" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">此功能允许您根据需要创建管线。该特性使用自己的模板来定义您希望如何在云环境中运行模型。由于大多数公司都有在生产中运行代码的方法，所以您可能对这个特性不太感兴趣。</p><h2 id="370e" class="lv jv iq bd jw lw lx dn ka ly lz dp ke ld ma mb ki lh mc md km ll me mf kq mg bi translated">ml 流程模型</h2><p id="62bc" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">最后，我们有模型功能。mlFlow 模型是包装机器学习模型的标准格式，可用于各种下游工具，例如，通过 REST API 或 Apache Spark 上的批处理推理进行实时服务。</p><h1 id="632f" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">理论完成:是时候开始了</h1><p id="e7cc" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">理论总是好的，但现在是时候采取更实际的方法了。首先，在我们真正开始之前，我们需要启动一个 mlFlow 服务器。为了正确地做到这一点，我创建了一个 docker 容器以便于部署。</p><p id="9d8e" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在展示代码之前，配置存储后端也很重要。因为我们希望我们的模型存储在某个地方，所以我选择了 Azure blob 存储(请注意，AWS S3 也是受支持的)。</p><p id="703c" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">所以创建一个 blob 存储帐户，并在里面创建一个容器。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi mh"><img src="../Images/af57ec54ba1ca2de8eac3e5ed7d9b2db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nfcJbyWxi8RA-rQoirsXKA.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Blob storage account Azure</figcaption></figure><p id="dd4c" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">一旦它被创建，你将需要写下 wasb 链接，因为你将需要这个值来启动 docker。url 通常定义如下:“wabss://<container>@<storage_account_name>. blob . core . windows . net”</storage_account_name></container></p><p id="5012" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">接下来，我们可以开始构建 docker。因为 mlFlow 需要 python，所以我从 python 图像开始，让我的生活变得简单了一些。基本上，只要确保 Python 在容器中可用，就可以从任何图像开始。对于本例，您只需安装以下两个软件包:</p><ul class=""><li id="12b8" class="mu mv iq ku b kv lq kz lr ld mw lh mx ll my lp mz na nb nc bi translated">mlflow 版本 0.8.0</li><li id="cec9" class="mu mv iq ku b kv nd kz ne ld nf lh ng ll nh lp mz na nb nc bi translated">azure 存储 0.36.0</li></ul><p id="5bdb" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">完整的 docker 解决方案只需看看我的 Github 账户:【https://github.com/Ycallaer/mlflowdocker T2】</p><p id="701a" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">接下来你需要构建容器，如果你不知道怎么做，看看自述文件。</p><p id="b060" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">一旦您在本地机器上启动了 docker 映像，它应该可以通过以下 url 获得:<a class="ae ni" href="http://localhost:5000/#/" rel="noopener ugc nofollow" target="_blank"> http://localhost:5000/ </a></p><p id="ab49" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">如果一切顺利，你的主页可能会像这样。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nj"><img src="../Images/c53b576229157654c3863ba7616f7bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bD28MewQKPjaMGmfqewIow.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Homepage mlFlow</figcaption></figure><h1 id="2417" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">调整模型以使用 mlFlow</h1><p id="8820" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一旦服务器部分准备好了，是时候修改我们的代码了。我创建了一个小的 ARIMA 模型实现来展示这个框架。</p><p id="1d3e" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在开始之前，我们需要定义运行服务器的 URL。您可以通过调用方法“set_tracking_uri”来实现这一点。这已经为这个演示进行了硬编码，但理想情况下，这将指向一个公共端点。</p><p id="2a58" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">接下来，我们需要创建一个实验。这应该是一个唯一的标识符。确保它唯一的一种方法是在每次调用实验方法时生成一个 uuid。在我的例子中，我硬编码它以加速演示。</p><p id="3b57" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">通过调用“start_run()”方法，我们告诉 mlFlow 这是运行的起点，这将为您的运行设置开始日期。不要忘记将实验 id 传递给方法，这样所有的日志记录都保留在实验中。</p><p id="e507" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">省略实验 id 将导致所有日志被写入默认实验。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nk"><img src="../Images/2ee382390b5074eddc7ac290bd52e682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djXeKgjhj63dwbSEwy8Dbw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Start point mlFlow Tracking</figcaption></figure><p id="dee9" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">接下来，我们需要指定在运行过程中要监控的值。一方面，您有“log_param()”，它为字符串值记录一个键值对。另一方面，我们有“log_metric()”，它只允许您将值定义为整数。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nl"><img src="../Images/160687ad75ba7336f628d601f587a5fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WzjNjfR-aXWKLxHEuj60kQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Example of log_param and log_metric</figcaption></figure><h1 id="fffb" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">视觉效果</h1><p id="4a6f" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">现在让我们回到 UI，看看我们运行的视觉结果是什么。在主页上，你会发现你的实验列在左侧。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nm"><img src="../Images/20fa12a4708fa848b204243f86359669.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w7EOcww2-9XxJeICZM3hOQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Homepage with experiment</figcaption></figure><p id="4803" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">如果你点击日期，你会看到那次跑步的概况。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nn"><img src="../Images/3cdf7878cf40c594154226845d1c1a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgBHgcx_vcmgxLEZqLoe1w.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Detailed info of an experiment</figcaption></figure><p id="7381" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在指标旁边，您会看到一个图形符号，如果您单击它，您可以看到在运行过程中该指标是如何变化的。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi no"><img src="../Images/df88325f70bb99aec0d33ede5aef58d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SljIu8IzESWXmjY_-Ul4XQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Detailed graph of a metric</figcaption></figure><h1 id="e7f3" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">保存模型</h1><p id="fc8a" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们还希望能够使用框架保存模型。该框架允许您以与大多数流行框架兼容的格式加载和保存模型(例如:Scikit、Pytorch、Tensorflow 等)。完整的名单请看这里的<a class="ae ni" href="https://mlflow.org/docs/latest/models.html" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="205f" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">将模型保存为工件的代码相当简单:</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi np"><img src="../Images/afa65c2c8bd4f900bce12110c0ca7fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8je68SglkT0W5EQU2BtloQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Example of log_model call in mlFlow</figcaption></figure><p id="1888" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">拟合的结果将作为第一个参数传递给函数，第二部分是目录。如果您导航到 UI 并单击 run，您将在页面底部找到工件信息。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nq"><img src="../Images/fed3fdb5e1c83bad2383a09f3a10afcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wwg5GK3tUPR8WWSfh0KO_A.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Model saved on Azure from mlFlow</figcaption></figure><p id="dcf2" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">如果你是偏执狂类型的，你现在可以看看 blob 存储帐户，以验证模型确实被保存了。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nr"><img src="../Images/68bd20d092edef3a288885259b27aecf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yj5Y9AHxDYmqSvJAigrpGQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Model on blob store</figcaption></figure><p id="8dfb" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">不错吧？如果你愿意，你可以看看加载特性，然后开始围绕这个模型构建应用程序。</p><p id="c64b" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">用于该演示的完整回购可以在<a class="ae ni" href="https://github.com/Ycallaer/ArimaMlfowExample" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。</p><h1 id="ca00" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">问题</h1><p id="22a7" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我发现这个框架更大的问题是，所有的日志都只存储在 docker 容器中，即使你已经定义了一个存储后端。这意味着，如果您重新启动容器，您的所有记录都将丢失。我记录了一个问题(<a class="ae ni" href="https://github.com/mlflow/mlflow/issues/613" rel="noopener ugc nofollow" target="_blank">https://github.com/mlflow/mlflow/issues/613</a>)，得到的回应是当前团队正在重新设计日志功能。所以祈祷吧。</p></div></div>    
</body>
</html>