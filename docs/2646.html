<html>
<head>
<title>Running Jupyter on a remote Docker container using SSH</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SSH在远程Docker容器上运行Jupyter</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-jupyter-notebook-running-on-a-remote-docker-container-via-ssh-ea2c3ebb9055?source=collection_archive---------3-----------------------#2018-02-16">https://towardsdatascience.com/using-jupyter-notebook-running-on-a-remote-docker-container-via-ssh-ea2c3ebb9055?source=collection_archive---------3-----------------------#2018-02-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/f345f77e87d21ab110554e0bf385625c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*JVgWPTXHO7du8r_1F1pySQ.gif"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Own source</figcaption></figure><div class=""/><div class=""><h2 id="6c91" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">设置您的环境，使之与远程实例中运行的Docker和Jupyter一起工作</h2></div><p id="21e2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在我的研究中，我使用机器学习/深度学习算法，我主要使用Python开发这些算法。因此，我发现测试不同的框架很有用(比如<em class="lq"> Keras、PyTorch、Tensorflow… </em>)。这导致我使用<strong class="kw jg"> Docker </strong>，特别是<a class="ae lr" href="https://github.com/ufoym/deepo" rel="noopener ugc nofollow" target="_blank"> ufoym/deepo </a>图像，因为它提供了一个非常完整的环境。</p><p id="9af9" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我使用一台装有GPU的远程机器，在那里我安装了Docker。在编程和测试一些代码片段的时候，我发现使用<a class="ae lr" href="https://jupyter.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw jg"> Jupyter </strong> </a>真的很有帮助。我以前在本地使用过Jupyter…但是这里的问题是<strong class="kw jg">我如何远程使用运行在另一台机器上的Jupyter</strong>。除此之外，如果我在我的远程机器上使用Docker容器会怎么样呢？</p><p id="fd6b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在本教程中，我将尝试分享我是如何解决这个<em class="lq">难题</em>并使本地使用Jupyter web应用程序在远程机器上运行代码成为可能的经验。</p><h1 id="3705" class="ls lt jf bd lu lv lw lx ly lz ma mb mc kl md km me ko mf kp mg kr mh ks mi mj bi translated">我的工作环境</h1><p id="6f9c" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">让我首先说明我的工作环境设置。</p><figure class="mq mr ms mt gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/530e23a8ce4e343bd32711321a24ee59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TAC174dy1N_boaMkCOKrtg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Own source, drawn using <a class="ae lr" href="https://docs.google.com/drawings" rel="noopener ugc nofollow" target="_blank">Google Draw</a></figcaption></figure><ol class=""><li id="851b" class="mu mv jf kw b kx ky la lb ld mw lh mx ll my lp mz na nb nc bi translated">我用我的普通笔记本电脑作为主机。</li><li id="491c" class="mu mv jf kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">我通过ssh连接到我部门的服务器(<strong class="kw jg">远程</strong>)。</li><li id="fb6c" class="mu mv jf kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">然后，我连接到服务器中一台特定的机器，这台机器有GPU。</li><li id="e6dd" class="mu mv jf kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">最后，我启动了那台机器中的<strong class="kw jg">码头工人</strong>集装箱。</li></ol><p id="86db" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在我的例子中，我使用的机器是上图中标为<strong class="kw jg"> GPU </strong>的机器，它恰好只能从服务器中的另一台机器访问。因此有了双ssh……但是在你的情况下，你可以从外部世界直接连接到你的GPU机器。</p><p id="28f8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这听起来很乱，但请耐心听我说，你只需要一劳永逸地组织起来。</p><h1 id="1cd0" class="ls lt jf bd lu lv lw lx ly lz ma mb mc kl md km me ko mf kp mg kr mh ks mi mj bi translated">先决条件</h1><h2 id="0661" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated">码头工人</h2><p id="8155" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">确保在你的远程机器上安装了<a class="ae lr" href="https://docs.docker.com/install/linux/docker-ce/centos/" rel="noopener ugc nofollow" target="_blank"><strong class="kw jg">docker</strong></a><strong class="kw jg"/>。如果你不熟悉Docker，请查看一些可用的资源(我发现<a class="ae lr" href="https://www.youtube.com/watch?v=YFl2mCHdv24" rel="noopener ugc nofollow" target="_blank">这个</a>和<a class="ae lr" href="https://blog.scottlowe.org/2014/03/11/a-quick-introduction-to-docker/" rel="noopener ugc nofollow" target="_blank">这个</a>很有帮助)。如果您的目标是GPU支持环境，请查看下一步。</p><h2 id="90b8" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated">GPU支持</h2><p id="23d8" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">如果您的远程机器有GPU，您可能想利用这一事实。确保你已经安装了<a class="ae lr" href="https://github.com/NVIDIA/nvidia-docker/wiki/Frequently-Asked-Questions#how-do-i-install-the-nvidia-driver" rel="noopener ugc nofollow" target="_blank"> <strong class="kw jg"> NVIDIA驱动</strong> </a>。还需要安装<a class="ae lr" href="https://github.com/NVIDIA/nvidia-docker" rel="noopener ugc nofollow" target="_blank"> <strong class="kw jg"> nvidia-docker </strong> </a>。请注意，通过安装nvidia-docker，我们会自动安装最后一个稳定版本的<a class="ae lr" href="https://www.docker.com/community-edition" rel="noopener ugc nofollow" target="_blank"> docker-ce </a>，因此您之前不需要显式安装docker。</p><h1 id="49b9" class="ls lt jf bd lu lv lw lx ly lz ma mb mc kl md km me ko mf kp mg kr mh ks mi mj bi translated">设置连接</h1><h2 id="ada8" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated">主机—远程</h2><p id="0d97" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">Jupyter笔记本运行在机器的某个端口上。因此，基本的想法是使该端口可以从您的主机到达。幸运的是，<strong class="kw jg"> ssh </strong>提供了-L选项来指定端口转发。</p><pre class="mq mr ms mt gt nu nv nw nx aw ny bi"><span id="46de" class="ni lt jf nv b gy nz oa l ob oc">$ ssh -L &lt;host port&gt;:localhost:&lt;remote port&gt; user@remote</span></pre><p id="5e3f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在我的例子中，我在两端使用端口9999，即<em class="lq"> &lt;主机端口&gt; = &lt;远程端口&gt; = 9999。</em></p><h2 id="d055" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated">远程— GPU</h2><p id="f719" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">这里的方法和以前完全一样。</p><pre class="mq mr ms mt gt nu nv nw nx aw ny bi"><span id="3f36" class="ni lt jf nv b gy nz oa l ob oc">$ ssh -L &lt;remote port&gt;:localhost:&lt;GPU port&gt; user@GPU</span></pre><p id="86c0" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">再次，我用<em class="lq"> &lt;主机端口&gt; = &lt;远程端口&gt; = 9999 </em>。</p><h2 id="4861" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated">GPU — docker</h2><p id="fe6c" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">这一步略有不同。首先，您需要使用您喜欢的docker映像创建一个docker容器。在我的例子中，如上所述，我使用的是<a class="ae lr" href="https://github.com/ufoym/deepo" rel="noopener ugc nofollow" target="_blank"> ufoym/deepo </a>。因为我想要GPU支持，所以我将使用<code class="fe od oe of nv b">nvidia-docker</code>来创建容器。</p><pre class="mq mr ms mt gt nu nv nw nx aw ny bi"><span id="4202" class="ni lt jf nv b gy nz oa l ob oc">$ nvidia-docker run -it \<br/>-p &lt;GPU port&gt;:&lt;container port&gt; \<br/>--name &lt;container name&gt; \<br/>ufoym/deepo  bash</span></pre><p id="64e1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">注意选项<code class="fe od oe of nv b">-p</code>，它告诉docker容器进行端口转发。通过这种方式，我们可以从外部世界访问在某个端口上运行的应用程序。这里我也用<em class="lq"> &lt;主机端口&gt; = &lt;远程端口&gt; = 9999 </em>。</p><p id="1868" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">顺便说一下，创建容器时一个非常有用的选项是<code class="fe od oe of nv b">-v</code>，它允许您从docker容器中访问机器文件。</p><h2 id="d23c" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated"><strong class="ak">运行Jupyter </strong></h2><p id="5e7e" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">一旦所有的隧道都建立好了，我们就可以启动我们的jupyter应用程序了。我们将使用<code class="fe od oe of nv b">0.0.0.0</code> ip和创建docker容器实例时使用的相同端口。同样，在我的例子中，我使用了选项<code class="fe od oe of nv b">--allow-root</code>，因为我在我的容器中是root，除非我使用这个选项，否则Jupyter不会运行。</p><pre class="mq mr ms mt gt nu nv nw nx aw ny bi"><span id="91ab" class="ni lt jf nv b gy nz oa l ob oc">$ jupyter notebook --ip 0.0.0.0 --port &lt;container port&gt; --allow-root</span></pre><p id="6ca5" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">哦，如果你喜欢新的很酷的<a class="ae lr" href="https://github.com/jupyterlab/jupyterlab" rel="noopener ugc nofollow" target="_blank"> jupyter lab </a>，就用下面的命令代替。</p><pre class="mq mr ms mt gt nu nv nw nx aw ny bi"><span id="59dd" class="ni lt jf nv b gy nz oa l ob oc">$ jupyter lab --ip 0.0.0.0 --port &lt;container port&gt; --allow-root</span></pre><p id="333f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">现在，在我的主机上，我只需简单地进入<!-- --> localhost:9999 <!-- -->就可以了。</p><h1 id="d1ec" class="ls lt jf bd lu lv lw lx ly lz ma mb mc kl md km me ko mf kp mg kr mh ks mi mj bi translated">旁注</h1><h2 id="ea93" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated">启用更多端口</h2><p id="4dfb" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">如果您有一个类似的工作环境，我建议启用更多的远程访问端口。您可以使用<code class="fe od oe of nv b">-L &lt;local port&gt;:localhost:&lt;remote port&gt;</code>将它们添加到您的ssh命令中。这样，如果您碰巧在docker机器的某些端口上运行其他服务，您可以轻松地远程访问它们。</p><h2 id="9b8e" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated">自动ssh登录</h2><p id="29ef" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">当您向ssh命令添加更多选项时，它会增加大小。一个选项是在<code class="fe od oe of nv b">~/.ssh/config</code>文件下定义一个主机。在我的例子中，我添加了一个用户<code class="fe od oe of nv b">&lt;name&gt;</code>:</p><pre class="mq mr ms mt gt nu nv nw nx aw ny bi"><span id="f235" class="ni lt jf nv b gy nz oa l ob oc">Host &lt;name&gt;<br/>  Hostname &lt;remote IP&gt;<br/>  Port &lt;remote port for SSH (typically 22)&gt;<br/>  IdentityFile &lt;path to rsa key&gt;<br/>  LocalForward 9999 127.0.0.1:9999</span></pre><h2 id="58b4" class="ni lt jf bd lu nj nk dn ly nl nm dp mc ld nn no me lh np nq mg ll nr ns mi nt bi translated"><strong class="ak">有误差吗？</strong></h2><p id="48e3" class="pw-post-body-paragraph ku kv jf kw b kx mk kg kz la ml kj lc ld mm lf lg lh mn lj lk ll mo ln lo lp ij bi translated">测试隧道是否工作的一个好方法是使用python中的<code class="fe od oe of nv b">http.server</code>。这样，您可以检查每个阶段端口是否被正确转发。使用以下命令在特定端口上运行简单的http服务器。</p><pre class="mq mr ms mt gt nu nv nw nx aw ny bi"><span id="1976" class="ni lt jf nv b gy nz oa l ob oc">$ python -m http.server &lt;remote port&gt;</span></pre><p id="6362" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">注意，这适用于python3，对于python2版本，使用<code class="fe od oe of nv b">python -m SimpleHTTPServer &lt;remote port&gt;</code>代替。</p><p id="0b98" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">如果你有任何其他困难，请在评论中留下，我很乐意帮助你！</p></div></div>    
</body>
</html>