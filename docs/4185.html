<html>
<head>
<title>Using BigQuery’s new geospatial functions to interpolate temperatures</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 BigQuery 的新地理空间函数来插值温度</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-bigquerys-new-geospatial-functions-to-interpolate-temperatures-d9363ff19446?source=collection_archive---------5-----------------------#2018-07-26">https://towardsdatascience.com/using-bigquerys-new-geospatial-functions-to-interpolate-temperatures-d9363ff19446?source=collection_archive---------5-----------------------#2018-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="93d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我写<a class="ae kl" href="https://cloudplatform.googleblog.com/2016/09/global-historical-daily-weather-data-now-available-in-BigQuery.html" rel="noopener ugc nofollow" target="_blank">博文</a>宣布来自全球历史气候网络(GHCN)的天气观测公共 BigQuery 数据集时，我展示了两个查询，一个是<a class="ae kl" href="https://cloud.google.com/bigquery/public-data/noaa-ghcn#find_weather_stations_close_to_a_specific_location" rel="noopener ugc nofollow" target="_blank">在某个边界框内查找气象站</a>，另一个是提取<a class="ae kl" href="https://cloud.google.com/bigquery/public-data/noaa-ghcn#weather_for_the_past_two_weeks" rel="noopener ugc nofollow" target="_blank">某个气象站的最近天气</a>数据。但是，查找边界框的查询使用了难看的纬度-经度限制检查，并且没有简单的方法将两个查询连接起来，以简单地从最近的气象站提取最近的气象数据(并非气象站数据集中的所有气象站现在都在运行，因此不能只使用限制)。</p><p id="5f4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么不容易呢？因为 BigQuery 不支持地理空间功能。但是现在有了！因此，让我们将用例重写为一个单独的查询，并使它变得更好。我们不只是从最近的站获取数据。相反，我们将从附近的站点插入数据。如果您使用过 PostGIS 的<a class="ae kl" href="http://postgis.org/docs/reference.html#Spatial_Relationships_Measurements" rel="noopener ugc nofollow" target="_blank"> ST_ functions </a>，那么 BigQuery 中的地理空间函数对您来说会很熟悉。</p><h2 id="1522" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">到点的距离</h2><p id="b713" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">假设我们在纬度为(41.88，-87.63)的地方有一家比萨饼店，首先计算该点 50 公里范围内所有车站的距离:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="8c36" class="km kn iq lp b gy lt lu l lv lw">#standardSQL<br/>WITH params AS (<br/>  SELECT ST_GeogPoint(-87.63, 41.88) AS center,<br/>         50 AS maxn_stations,<br/>         50 AS maxdist_km<br/>),</span><span id="e405" class="km kn iq lp b gy lx lu l lv lw">distance_from_center AS (<br/>  SELECT<br/>    id,<br/>    name,<br/>    state,<br/>    ST_GeogPoint(longitude, latitude) AS loc,<br/>    ST_Distance(ST_GeogPoint(longitude, latitude), params.center) AS dist_meters<br/>  FROM<br/>    `bigquery-public-data.ghcn_d.ghcnd_stations`,<br/>    params<br/>  WHERE ST_DWithin(ST_GeogPoint(longitude, latitude), params.center, params.maxdist_km*1000)<br/>)</span><span id="f894" class="km kn iq lp b gy lx lu l lv lw">SELECT * from distance_from_center</span></pre><p id="af90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我设置了三个参数:中心位置、要使用的气象站的最大数量和插值的最大距离。然后，我使用 ST_Distance 计算距离，使用 ST_DWithin 过滤站点。(为什么不在 WHERE 子句中使用计算的距离？因为 DWITHIN 可以进行避免计算距离的优化，并且这样，仅针对足够近的站计算距离)。</p><p id="1ce7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时的结果如下所示:</p><figure class="lk ll lm ln gt lz gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/6aedd750f514475ad12e53390961026d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*gz-RrpxhHZrvydUOj240bg.png"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Distance of stations from our pizza joint</figcaption></figure><h2 id="371f" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">排名超过</h2><p id="4493" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">50 公里内有 320 个车站。让我们把这个列表删减到前 50 名。我们不能使用 LIMIT，因为 LIMIT 需要硬编码的数字，而我们希望使用上面参数中的 maxn_stations。所以，有一种方法可以做到:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="4745" class="km kn iq lp b gy lt lu l lv lw">...</span><span id="6726" class="km kn iq lp b gy lx lu l lv lw">nearest_stations AS (<br/>  SELECT <br/>    *, <br/>    RANK() OVER (ORDER BY dist_meters ASC) AS rank<br/>  FROM <br/>    distance_from_center<br/>),</span><span id="c97c" class="km kn iq lp b gy lx lu l lv lw">nearest_nstations AS (<br/>  SELECT <br/>    station.* <br/>  FROM <br/>    nearest_stations AS station, params<br/>  WHERE <br/>    rank &lt;= params.maxn_stations<br/>)</span><span id="22c6" class="km kn iq lp b gy lx lu l lv lw">SELECT * from nearest_nstations</span></pre><p id="45d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，结果按距离排序，并限制为 50:</p><figure class="lk ll lm ln gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi mg"><img src="../Images/2e25644013e17ef28b5fde7a9cbae252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t6SmDjLKNiLbhAtg-VzQeg.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Sorted by distance and limited to closest 50</figcaption></figure><h2 id="70be" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">使用 BigQuery GeoViz 可视化</h2><p id="aef0" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">我们可以用<a class="ae kl" href="https://bigquerygeoviz.appspot.com/" rel="noopener ugc nofollow" target="_blank"> BigQuery mapper </a>来实现这一点:</p><figure class="lk ll lm ln gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="mh mi di mj bf mk"><div class="gh gi ml"><img src="../Images/6fd11924e041bc3748f79518d5af6cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ebcf7HpJ48YszkD5Eypc8w.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Stations with opacity set by distance</figcaption></figure><h2 id="a19c" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">连接表格</h2><p id="4d18" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">现在，让我们通过将上述表格与天气数据表连接起来，并通过 id 将其连接起来，来获取每个站点的最近天气数据:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="72cd" class="km kn iq lp b gy lt lu l lv lw">wxobs AS (<br/>  SELECT<br/>    wx.date AS date,<br/>    IF (wx.element = 'PRCP', wx.value/10, NULL) AS prcp,<br/>    IF (wx.element = 'TMIN', wx.value/10, NULL) AS tmin,<br/>    IF (wx.element = 'TMAX', wx.value/10, NULL) AS tmax,<br/>    station.id AS id, <br/>    station.name AS name, <br/>    station.dist_meters AS dist<br/>  FROM<br/>    `bigquery-public-data.ghcn_d.ghcnd_2018` AS wx<br/>  JOIN nearest_nstations AS station ON wx.id = station.id<br/>  WHERE<br/>    DATE_DIFF(CURRENT_DATE(), wx.date, DAY) &lt; 15<br/>),</span><span id="d3c3" class="km kn iq lp b gy lx lu l lv lw">daily_wx AS (<br/>  SELECT<br/>    date,<br/>    MAX(prcp) AS prcp,<br/>    MAX(tmin) AS tmin,<br/>    MAX(tmax) AS tmax,<br/>    id,<br/>    MAX(name) AS name,<br/>    MAX(dist) AS dist<br/>  FROM <br/>    wxobs<br/>  GROUP BY<br/>    date, id<br/>  HAVING tmin &gt; -100 AND tmax &gt; -100<br/>  ORDER BY<br/>    date ASC<br/>)</span></pre><p id="2c1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的奇怪之处是因为 gchnd_2018 表中的每条记录只包含一个观测值(tmin、tmax 或 prcp ),因此我们必须合并多行才能获得完整的观测值集。结果现在看起来像这样:</p><figure class="lk ll lm ln gt lz gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/3070ace9dbb0be059236d346a4276a28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*9iXidznlOCDzaLj-X4CTbw.png"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Daily weather from the two(!) stations with temperature data for each day</figcaption></figure><h2 id="f19a" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">插入文字</h2><p id="0e77" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">现在，我们可以添加插值代码:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="08c8" class="km kn iq lp b gy lt lu l lv lw">SELECT <br/>  date,<br/>  ROUND(SUM(tmin/(dist*dist))/SUM(1/(dist*dist)),1) AS tmin,<br/>  ROUND(SUM(tmax/(dist*dist))/SUM(1/(dist*dist)),1) AS tmax,<br/>  ROUND(SUM(prcp/(dist*dist))/SUM(1/(dist*dist)),2) AS prcp<br/>FROM <br/>  daily_wx<br/>GROUP BY date<br/>ORDER BY date desc</span></pre><p id="b6a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这给了我们:</p><figure class="lk ll lm ln gt lz gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/60adf97b2a64688b8588a31e02b708be.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/format:webp/1*QChfypPDn4FMnhU5kax4YQ.png"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Recent weather, interpolated to our pizza parlor</figcaption></figure><p id="4033" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是<a class="ae kl" href="https://bigquery.cloud.google.com/savedquery/663413318684:ad97a1054f8c43be968858dc9883f8b4" rel="noopener ugc nofollow" target="_blank">全查询</a>。试试吧！</p><h2 id="1cf2" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">离多边形的距离</h2><p id="535a" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">在上面的查询中，我计算了两点之间的距离。相反，如果您想找到邮政编码方圆 10 公里内的所有气象站，该怎么办呢？这里有一个<a class="ae kl" href="https://bigquery.cloud.google.com/savedquery/663413318684:1346cd46943648b38d48612b03034a20" rel="noopener ugc nofollow" target="_blank">查询</a>可以做到这一点:</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="5749" class="km kn iq lp b gy lt lu l lv lw">#standardsql<br/>WITH params AS (<br/>  SELECT 60626 AS zipcode,<br/>         10    AS maxdist_km<br/>),</span><span id="dd2f" class="km kn iq lp b gy lx lu l lv lw">zipcode AS (<br/>   SELECT <strong class="lp ir">ST_GeogFromText(WKT)</strong> AS polygon <br/>   FROM `cloud-training-demos.demos.zipcode_polygon2017`, params <br/>   WHERE ZCTA5CE10 = params.zipcode<br/>),</span><span id="136b" class="km kn iq lp b gy lx lu l lv lw">stations AS (<br/>  SELECT<br/>    id,<br/>    name,<br/>    ST_GeogPoint(longitude, latitude) AS loc,<br/>    <strong class="lp ir">ST_Distance</strong>(ST_GeogPoint(longitude, latitude), zipcode.polygon) AS dist_meters<br/>  FROM<br/>    `bigquery-public-data.ghcn_d.ghcnd_stations`,<br/>    params,<br/>    zipcode<br/>  WHERE <strong class="lp ir">ST_DWithin</strong>(ST_GeogPoint(longitude, latitude), zipcode.polygon, params.maxdist_km*1000)<br/>)</span><span id="8b6f" class="km kn iq lp b gy lx lu l lv lw">SELECT * from stations<br/>ORDER BY dist_meters ASC<br/>LIMIT 100</span></pre><p id="dce6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要注意的关键是，zipcodes 的 BigQuery 表包含众所周知的文本(WKT)的几何信息，所以我使用 ST_GeogFromText 来解析它。<em class="mo">【注意:不是将列存储为字符串，我可以将它存储为地理类型——这样，我只需解析字符串一次，而不是在每个分析函数中】</em>。一旦我有了多边形几何，我就可以将它传递到 ST_Distance 和 ST_DWithin 函数中，类似于我传递一个点的方式，并可视化结果:</p><figure class="lk ll lm ln gt lz gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/5882959b194228af0f134418c2479b34.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/1*hoR250bGWFUn85nvrlsBGg.png"/></div></figure><figure class="lk ll lm ln gt lz gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/d97d99d07ce9418473388d8a48e538a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*zHF6PYbWcU3QHkRt6xrmJA.png"/></div></figure><p id="db67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，到前两个站点的距离为零，因为它们在邮政编码范围内。其余的在邮政编码边界 10 公里以内。</p><p id="9cb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽情享受吧！</p></div></div>    
</body>
</html>