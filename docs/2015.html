<html>
<head>
<title>Use Python to collect image tags using AWS’ Reverse Image Search Engine, Rekognition</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 通过 AWS 的反向图像搜索引擎 Rekognition 收集图像标签</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/use-python-to-collect-image-tags-using-aws-reverse-image-search-engine-rekognition-eccf1f259a8d?source=collection_archive---------7-----------------------#2017-12-04">https://towardsdatascience.com/use-python-to-collect-image-tags-using-aws-reverse-image-search-engine-rekognition-eccf1f259a8d?source=collection_archive---------7-----------------------#2017-12-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c636" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇博文讨论了如何将你的图片转化为描述图片内容的文本，这样你就可以在 Jupyter 笔记本上对图片的内容和主题进行分析。一个有用的例子是，如果你收到了数千条推文，你想知道图片媒体对参与度有没有影响。幸运的是，亚马逊、谷歌和微软的工程师没有编写自己的图像识别工具，而是完成了这项任务，并使他们的 API 可以访问。这里我们将使用 Rekognition，这是亚马逊基于深度学习的图像和视频分析工具。</p><p id="329a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本博客作为如何使用不同的 Rekognition 操作提取信息的示例，并不能代替阅读文档。我尽我所能提供链接，因为它们可能是有用的。</p><p id="652d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，为了收集图像的文本数据，我们将:</p><ol class=""><li id="18e7" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">将图像存储在 AWS S3 桶中</li><li id="9241" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">使用 AWS Rekognition 反转图像搜索并返回每个图像的标签</li><li id="2c08" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">将数据保存在长数据框和宽数据框中——您可能只需要一个数据框，但是我在代码中给出了将数据保存为两个数据框的方法。</li></ol><p id="7515" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">亚马逊在这里描述了 Rekognition 是如何工作的。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi la"><img src="../Images/4bfeaf29099969e636d1e3e87759b897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kR4W5-FIcPxQzek7dSlkUg.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk"><a class="ae kz" href="https://aws.amazon.com/rekognition/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/rekognition/</a></figcaption></figure><p id="ba9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开 Jupyter 笔记本并将数据存储为 pandas 数据框对象后，我们希望导入相关的库。我使用了来自 Twitter 的数据，那里的图像数据是 URL 形式的。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="ea60" class="lv lw iq lr b gy lx ly l lz ma">import boto<br/>import boto3<br/>conn = boto.connect_s3()<br/>import requests</span></pre><p id="2f1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你在这里遇到了错误，<a class="ae kz" href="http://docs.aws.amazon.com/cli/latest/userguide/tutorial-ec2-ubuntu.html#install-cli" rel="noopener ugc nofollow" target="_blank">安装 AWS CLI </a>，并确保你已经安装了<a class="ae kz" href="http://boto.cloudhackers.com/en/latest/getting_started.html" rel="noopener ugc nofollow" target="_blank"> boto </a>和<a class="ae kz" href="http://boto3.readthedocs.io/en/latest/guide/quickstart.html" rel="noopener ugc nofollow" target="_blank"> boto3 </a>。</p><p id="e6fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在连接到我们的桶:</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="1035" class="lv lw iq lr b gy lx ly l lz ma"><em class="mb"># Uses the creds in ~/.aws/credentials</em><br/>s3 = boto3.resource('s3')<br/>bucket_name_to_upload_image_to = '#########' <em class="mb">#insert the name of your bucket here.</em></span></pre><p id="61a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你如何创建一个桶？什么是水桶？<a class="ae kz" href="http://docs.aws.amazon.com/AmazonS3/latest/user-guide/create-bucket.html" rel="noopener ugc nofollow" target="_blank">点击此处。</a></p><p id="f82d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你连接到你的桶了吗？我从用户<a class="ae kz" href="https://stackoverflow.com/users/5770412/gisd" rel="noopener ugc nofollow" target="_blank"> GISD </a>对以下<a class="ae kz" href="https://stackoverflow.com/questions/14346065/upload-image-available-at-public-url-to-s3-using-boto" rel="noopener ugc nofollow" target="_blank"> StackOverflow 问题</a>的回答中了解到这个检查。</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="0598" class="lv lw iq lr b gy lx ly l lz ma"><em class="mb"># Do this as a quick and easy check to make sure your S3 access is OK</em><br/><strong class="lr ir">for</strong> bucket <strong class="lr ir">in</strong> s3.buckets.all():<br/>    <strong class="lr ir">if</strong> bucket.name == bucket_name_to_upload_image_to:<br/>        print('Good to go. Found the bucket to upload the image into.')<br/>        good_to_go = <strong class="lr ir">True</strong><br/><br/><strong class="lr ir">if</strong> <strong class="lr ir">not</strong> good_to_go:<br/>    print('Not seeing your s3 bucket, might want to double check permissions in IAM')</span></pre><h1 id="fcea" class="mc lw iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">第一步:将图像存储在 AWS S3 桶中</h1><p id="f4fe" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">我们所有的图像都是以网址的形式，我们想把它们都上传到一个 S3 桶，而不必先把它们存储在我们的硬盘上。方法如下:</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a061" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请记住，这还会创建一个 mapping_dict，这样，如果您的图像 URL 列表是从另一个数据框中获得的，您就能够将其与在以下步骤中创建的图像标签数据框合并。</p><h1 id="a8cf" class="mc lw iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">第二步:使用 AWS Rekognition 反向搜索图像并返回每个图像的标签</h1><p id="f9be" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">首先，我们将探索 AWS API 的三个特性，巧合的是，它们对我的目的最有帮助:<a class="ae kz" href="http://docs.aws.amazon.com/rekognition/latest/dg/API_DetectLabels.html" rel="noopener ugc nofollow" target="_blank">检测标签</a>、<a class="ae kz" href="http://docs.aws.amazon.com/rekognition/latest/dg/API_DetectText.html" rel="noopener ugc nofollow" target="_blank">检测文本</a>和<a class="ae kz" href="http://docs.aws.amazon.com/rekognition/latest/dg/celebrities.html" rel="noopener ugc nofollow" target="_blank">识别名人</a>。Rekognition 还拥有许多其他功能<a class="ae kz" href="http://docs.aws.amazon.com/rekognition/latest/dg/how-it-works-types.html" rel="noopener ugc nofollow" target="_blank"/>,包括检测和分析人脸，跟踪人脸，以及检测儿童的不安全内容。</p><p id="f8dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">检测标签</strong></p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">response will be a dictionary with keys [‘OrientationCorrection’, ‘Labels’, ‘ResponseMetadata’]</figcaption></figure><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="d88b" class="lv lw iq lr b gy lx ly l lz ma">[Output]<br/>{'Labels': [{'Confidence': 99.28775787353516, 'Name': 'Human'},<br/>  {'Confidence': 99.2877426147461, 'Name': 'People'},<br/>  {'Confidence': 99.28775787353516, 'Name': 'Person'},<br/>  {'Confidence': 91.67272186279297, 'Name': 'Audience'},<br/>  {'Confidence': 91.67272186279297, 'Name': 'Crowd'},<br/>  {'Confidence': 91.67272186279297, 'Name': 'Speech'},<br/>  {'Confidence': 78.27274322509766, 'Name': 'Clothing'},<br/>  {'Confidence': 78.27274322509766, 'Name': 'Coat'},<br/>  {'Confidence': 78.27274322509766, 'Name': 'Overcoat'},<br/>  {'Confidence': 78.27274322509766, 'Name': 'Suit'}],<br/> 'OrientationCorrection': 'ROTATE_0',<br/> 'ResponseMetadata': {'HTTPHeaders': {'connection': 'keep-alive',<br/>   'content-length': '536',<br/>   'content-type': 'application/x-amz-json-1.1',<br/>   'date': 'Mon, 04 Dec 2017 03:13:26 GMT',<br/>   'x-amzn-requestid': '18599e6b-d8a1-11e7-8234-c9f1716fbb2e'},<br/>  'HTTPStatusCode': 200,<br/>  'RequestId': '18599e6b-d8a1-11e7-8234-c9f1716fbb2e',<br/>  'RetryAttempts': 0}}</span></pre><p id="1de2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于下图:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi ng"><img src="../Images/3d97f318280517f51e45d9f01625ec10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O4HTJZSGXdcBNgOh2xO45w.png"/></div></div></figure><p id="2a0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">检测文本</strong></p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">text_in_image will be a dictionary with keys [‘TextDetections’, ‘ResponseMetadata’]</figcaption></figure><p id="1c04" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意这里的输出是一个字典的字典。既然这么长，这里就不完整收录了。以下是 text _ in _ image[' text detections ']的简短输出:</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="3858" class="lv lw iq lr b gy lx ly l lz ma">[Output]<br/>[{'Confidence': 87.87747955322266,<br/>  'DetectedText': 'Protects',<br/>  'Geometry': {'BoundingBox': {'Height': 0.0289202518761158,<br/>    'Left': 0.8098856210708618,<br/>    'Top': 0.3966602385044098,<br/>    'Width': 0.05391734838485718},<br/>   'Polygon': [{'X': 0.8098856210708618, 'Y': 0.3966602385044098},<br/>    {'X': 0.863802969455719, 'Y': 0.3976689577102661},<br/>    {'X': 0.8636319041252136, 'Y': 0.4265892207622528},<br/>    {'X': 0.8097145557403564, 'Y': 0.4255805015563965}]},<br/>  'Id': 0,<br/>  'Type': 'LINE'},<br/> {'Confidence': 81.16915130615234,<br/>  'DetectedText': 'Minorcuts',<br/>  'Geometry': {'BoundingBox': {'Height': 0.025231996551156044,<br/>    'Left': 0.8168795108795166,<br/>    'Top': 0.4240514636039734,<br/>    'Width': 0.06063205003738403},<br/>   'Polygon': [{'X': 0.8168795108795166, 'Y': 0.4240514636039734},<br/>    {'X': 0.8775115609169006, 'Y': 0.4253864288330078},<br/>    {'X': 0.8773359060287476, 'Y': 0.4506184160709381},<br/>    {'X': 0.8167038559913635, 'Y': 0.4492834508419037}]},<br/>  'Id': 1,<br/>  'Type': 'LINE'},<br/>.<br/>.<br/>.<br/>}]</span></pre><p id="4480" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于下图:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nh"><img src="../Images/5876a1585f1833a8187e84ce399fd64a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H0a6AY6Xxt94WHIefsK9Kg.png"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">See “Protects” and “Minorcuts”?</figcaption></figure><p id="35c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">认识名人</strong></p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">celeb_detect will be a dictionary with keys [‘OrientationCorrection’, ‘CelebrityFaces’, ‘UnrecognizedFaces’, ‘ResponseMetadata’]</figcaption></figure><p id="41ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似于 DetectText，recognize small ness 返回字典的字典。以下是 celeb_detect["CelebrityFaces"]的输出:</p><pre class="lb lc ld le gt lq lr ls lt aw lu bi"><span id="50e9" class="lv lw iq lr b gy lx ly l lz ma">[Output]<br/>[{'Face': {'BoundingBox': {'Height': 0.10687500238418579,<br/>    'Left': 0.4807872474193573,<br/>    'Top': 0.15562500059604645,<br/>    'Width': 0.16026242077350616},<br/>   'Confidence': 99.9999771118164,<br/>   'Landmarks': [{'Type': 'eyeLeft',<br/>     'X': 0.5403168201446533,<br/>     'Y': 0.19756773114204407},<br/>    {'Type': 'eyeRight', 'X': 0.5921167731285095, 'Y': 0.20492416620254517},<br/>    {'Type': 'nose', 'X': 0.5595902800559998, 'Y': 0.22208547592163086},<br/>    {'Type': 'mouthLeft', 'X': 0.5338063836097717, 'Y': 0.23306140303611755},<br/>    {'Type': 'mouthRight', 'X': 0.5765158534049988, 'Y': 0.23889882862567902}],<br/>   'Pose': {'Pitch': -3.3401520252227783,<br/>    'Roll': 11.797859191894531,<br/>    'Yaw': -0.263323575258255},<br/>   'Quality': {'Brightness': 23.701353073120117,<br/>    'Sharpness': 99.99090576171875}},<br/>  'Id': '1ax3nr0o',<br/>  'MatchConfidence': 94.0,<br/>  'Name': 'Kim Kardashian',<br/>  'Urls': ['www.imdb.com/name/nm2578007']}]</span></pre><p id="8b7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于下图:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/ffb0b5d7519d992d49bc1427a11482e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*-bf2gDT8yC71y0YJenUGlg.png"/></div></figure><h1 id="bce4" class="mc lw iq bd md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my bi translated">第三步:将数据保存在长和宽的数据框中</h1><p id="ff64" class="pw-post-body-paragraph jn jo iq jp b jq mz js jt ju na jw jx jy nb ka kb kc nc ke kf kg nd ki kj kk ij bi translated">还不错！现在把它们放在一个 for 循环中，这样你就可以得到一个数据帧，其中包含了我们想要使用 Rekognition 检索的所有信息。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="6034" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">长数据将像这样存储:</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/a431d86f910eba7bf5d3ab184283fd67.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*J6P96TrcJphF6R_ThP2P8Q.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">Data Cleaning idea: If it is a celebrity, remove all other labels as celebrity fashion can be difficult for Rekognition.</figcaption></figure><p id="d12a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">宽数据将像这样存储，每张图片一行，列跨越标签、单词和它们的置信度。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="gh gi nk"><img src="../Images/74b740a2bf821a59a321255629d26132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RE6DjSoQUbkf33vPjLHFEQ.png"/></div></div></figure><p id="8218" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个 for 循环步骤需要很长时间才能用完你的 Jupyter 笔记本。对于 10，000 张图片，我花了大约 8 个小时。Try/except 语句包含在每个组成部分 detect_labels、detect_text 和 recognize _ 中，因为并非所有图像都会从所有三个操作中得到响应。</p><p id="aac0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">图像处理愉快！</p><p id="f5b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于这个主题有很多资源，你可以在我发现每个资源最有用的步骤中找到我使用的链接。我发现 Rekognition 非常有效，但它确实有一些问题(就像任何图像识别工具一样)。特别是，没有被很好分类的照片是特定身体部位(即:嘴)的特写，一张眼影化妆的图像被分类为巧克力或软糖。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/5b52bb1a02c35019bf762b8b27883620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*C_xYLKOVieMsG2PUvvS77w.png"/></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">I can see how this can be mistaken for chocolate or fudge.</figcaption></figure><p id="9aba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您在执行分析之前使用了这段代码，请在评论中链接您的项目，我很乐意看到您的工作。如果 Rekognition 给你的图片带来了任何古怪的标签或者错误的分类，我也想听听。</p><p id="19da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的 GitHub 上找到我的 Jupyter 笔记本:<a class="ae kz" href="https://github.com/nmolivo/Blogs/tree/master/002_AWSRekognition" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/nmolivo/Blogs/tree/master/002 _ AWS recognition</a></p></div></div>    
</body>
</html>