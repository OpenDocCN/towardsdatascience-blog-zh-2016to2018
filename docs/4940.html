<html>
<head>
<title>Get system metrics for 5 min with Docker, Telegraf, Influxdb and Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Docker、Telegraf、Influxdb 和 Grafana 获取 5 分钟的系统指标</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/get-system-metrics-for-5-min-with-docker-telegraf-influxdb-and-grafana-97cfd957f0ac?source=collection_archive---------2-----------------------#2018-09-17">https://towardsdatascience.com/get-system-metrics-for-5-min-with-docker-telegraf-influxdb-and-grafana-97cfd957f0ac?source=collection_archive---------2-----------------------#2018-09-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c921" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总之，这里有一个非常快速的指南，告诉你如何使用一系列现代技术，如 Grafana、Docker 和 Telegraf with Influxdb，为一台或多台服务器配置系统监控。</p><p id="43c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文的主要目标是展示如何快速简单地从服务器获取系统指标，而无需花费大量时间来配置庞大而复杂的监控系统。尤其是如果您只需要管理少数几个 Web 服务器，而不是监控拥有数百台设备的大公司基础架构。</p><p id="9ce6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用 Docker 来快速部署我们的监控系统，这也将使我们能够自由地使用任何软件，并且保持我们的系统干净。话题性的，你也可以从这个角度看 Docker，作为一个跨平台的包系统。</p><p id="c59d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，我们将使用 Tick 堆栈的一部分，即 Influxdb 库来存储我们的指标和 Telegraf，就像远程系统上的代理一样，对于漂亮的图形，我们将采用 Grafana。</p><p id="39b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">图例:</p><p id="7c0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器 1 —监控服务器</p><p id="ed57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器 2、服务器 3 等—我们需要从中获取指标的服务器</p><p id="9857" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在 server1 上，我们将准备我们的监控系统，为此我们需要一个安装了 Docker 和 Docker Compose 的 Linux。</p><blockquote class="kl km kn"><p id="9680" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><a class="ae ks" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">如何获取并安装 Docker </a></p></blockquote><p id="435d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先为我们的项目创建一个文件夹，例如/opt/monitoring:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="4878" class="lc ld iq ky b gy le lf l lg lh">server1$ mkdir /opt/monitoring &amp;&amp; cd /opt/monitoring</span></pre><p id="7b6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在目录中，我们需要用 Grafana 和 Influxdb 服务创建 docker-compose.yml 文件:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="40c3" class="lc ld iq ky b gy le lf l lg lh">version: "2"<br/>services:<br/>  grafana:<br/>    image: grafana/grafana<br/>    container_name: grafana<br/>    restart: always<br/>    ports:<br/>      - 3000:3000<br/>    networks:<br/>      - monitoring<br/>    volumes:<br/>      - grafana-volume:/var/lib/grafana</span><span id="465f" class="lc ld iq ky b gy li lf l lg lh">  influxdb:<br/>    image: influxdb<br/>    container_name: influxdb<br/>    restart: always<br/>    ports:<br/>      - 8086:8086<br/>    networks:<br/>      - monitoring<br/>    volumes:<br/>      - influxdb-volume:/var/lib/influxdb</span><span id="e7b1" class="lc ld iq ky b gy li lf l lg lh">networks:<br/>  monitoring:</span><span id="50df" class="lc ld iq ky b gy li lf l lg lh">volumes:<br/>  grafana-volume:<br/>    external: true<br/>  influxdb-volume:<br/>    external: true</span></pre><p id="9f65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，我们使用自己的 docker 网络来提供这些服务，包括名称监控和外部卷来存储数据和配置，我们使用外部卷来防止容器重启后的任何数据丢失。</p><blockquote class="kl km kn"><p id="b439" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">实际上，为容器组使用自己的网络是一个很好的实践，便于逻辑分离属于同一项目的容器，也便于从 docker 引擎获得内置服务发现。</p></blockquote><p id="b71f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要创建 Docker 网络和卷:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="851f" class="lc ld iq ky b gy le lf l lg lh">server1$ docker network create monitoring<br/>server1$ docker volume create grafana-volume<br/>server1$ docker volume create influxdb-volume</span></pre><p id="b579" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保一切都创建得很好:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="ead8" class="lc ld iq ky b gy le lf l lg lh">server1$ docker network ls<br/>NETWORK ID          NAME                DRIVER              SCOPE<br/>8a744bc6ce04        bridge              bridge              local<br/>a9fe3f026042        host                host                local<br/>75c2b515def9        monitoring          bridge              local<br/>c1a42ddaa998        none                null                local<br/><br/>server1$ docker volume ls<br/>DRIVER              VOLUME NAME<br/>local               69c5364fab3baa7b1c9418ace9c91dfcf13e54f0adce247136d887e46a347baf<br/>local               grafana-volume<br/>local               influxdb-volume</span></pre><p id="4550" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如我们所见，网络和卷已创建完毕，现在我们需要准备 Influxdb 参数，为此，我们将使用一些环境变量来运行容器，以创建数据库和用户:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="237b" class="lc ld iq ky b gy le lf l lg lh">server1$ docker run --rm \<br/>  -e INFLUXDB_DB=telegraf -e INFLUXDB_ADMIN_ENABLED=true \<br/>  -e INFLUXDB_ADMIN_USER=admin \<br/>  -e INFLUXDB_ADMIN_PASSWORD=supersecretpassword \<br/>  -e INFLUXDB_USER=telegraf -e INFLUXDB_USER_PASSWORD=secretpassword \<br/>  -v influxdb-volume:/var/lib/influxdb \<br/>  influxdb /init-influxdb.sh</span></pre><blockquote class="kl km kn"><p id="431e" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated">我们使用–RM 密钥运行此容器，这将仅创建配置并在之后删除容器。</p></blockquote><p id="4fe8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有准备工作都已完成，我们准备启动新的监控系统，使用 docker-compose，转到/opt/monitoring 目录并运行:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="1c2e" class="lc ld iq ky b gy le lf l lg lh">server1$ docker-compose up -d<br/><br/>Creating network "monitoring_monitoring" with the default driver<br/>Creating grafana<br/>Creating influxdb<br/><br/>server1$ docker ps<br/><br/>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES<br/>8128b72bdf44        grafana/grafana     "/run.sh"                23 seconds ago      Up 20 seconds       0.0.0.0:3000-&gt;3000/tcp   grafana<br/>c00416d0d170        influxdb            "/entrypoint.sh infl…"   23 seconds ago      Up 21 seconds       0.0.0.0:8086-&gt;8086/tcp   influxdb</span></pre><p id="53b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，所有的容器都被创建并启动了，所以我们的监控系统准备好为传入的请求服务了。我们公开了几个端口，正如你在 docker-compose 文件中看到的，8086 HTTP API 端口用于 Influxdb 数据，3000 端口用于 Grafana web UI。</p><p id="4101" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们几乎完成了新的监控系统，使用 Docker 真是又快又简单。为了完全完成，我们只需要稍微配置 Grafana，为 Influxdb 创建一个仪表板和新的数据源。</p><p id="73b1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，将在浏览器中访问我们的 server1 public_ip:3000(在我们的示例中为 192.168.0.1:3000 ),并使用以下命令首次登录 Grafana web UI:</p><p id="fd6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">登录:管理员</p><p id="a78d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">密码:admin</p><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lj"><img src="../Images/b22ad23ba1f2fbe2c5bd88191cc10c62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IB_2fT2-mQihHP0l"/></div></div></figure><p id="3229" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后 Grafana 会要求您更改密码，之后您将进入:</p><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lr"><img src="../Images/49cb8bdc241a85b4129b7284e54de456.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*en5CBeaGTKe9Qvfu"/></div></div></figure><p id="3124" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">选择 Add data source 菜单，告诉 Grafana 从哪里获取 Influxdb 数据:</p><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ls"><img src="../Images/70b6c60d491dc82d985cb9604a80c614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FECckMUhT-v_vaXH"/></div></div></figure><p id="0cba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我们需要选择 Type = InfluxDB，给出这个数据源的名称，然后使用我们的 InfluxDB 容器名称作为地址放置 URL。正如我之前所说，Docker 给了我们一个简单的服务发现。</p><p id="f6b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好的，我们还需要为我们的数据库插入数据库名称和用户/密码，这些参数是通过之前运行 Influxdb 容器创建的。</p><p id="d0c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">单击保存和测试，查看您的数据源是否正常:</p><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lt"><img src="../Images/6d2c1ad5171d77f84839ee29799f7e74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*t02qDBYSGrqP2dew"/></div></div></figure><p id="de96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太好了，我们刚刚添加了我们的 influxdb 作为 Grafana 的数据源，为了节省时间，我们将准备一个包含最流行参数的仪表板，转到<a class="ae ks" href="http://grafana.com/" rel="noopener ugc nofollow" target="_blank">grafana.com</a>并选择一个您喜欢的。举个例子:</p><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lu"><img src="../Images/e5dd469b2a869b24d269c43622707324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q83kO3QXSXMzXpSL"/></div></div></figure><p id="71f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">复制数字 914，然后将其插入您的 grafana 导入菜单:</p><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/6b701476f4687d150023ebd377c010fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/0*5-AP0Xow6lfvvc0E"/></div></figure><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lw"><img src="../Images/49bf608d13710c68e99d13b735eb274a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c1azaaywigf9RPjp"/></div></div></figure><p id="1f51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">仅此而已，我们只需要在我们想要控制的系统上安装 telegraf，并将其配置为向 server1 上的 influxdb 发送数据。</p><p id="8a15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以将 telegraf 作为软件包安装，或者编译最新版本并将其复制到远程服务器。</p><blockquote class="kl km kn"><p id="e296" class="jn jo ko jp b jq jr js jt ju jv jw jx kp jz ka kb kq kd ke kf kr kh ki kj kk ij bi translated"><a class="ae ks" href="https://docs.influxdata.com/telegraf/v1.7/introduction/installation/" rel="noopener ugc nofollow" target="_blank">安装 Telegraf </a></p></blockquote><p id="b652" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">更改 telegraf 配置并配置 influxdb 数据库参数。</p><p id="24e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还要启用你需要的插件。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="7a95" class="lc ld iq ky b gy le lf l lg lh"><em class="ko">###############################################################################</em><br/><em class="ko">#                            OUTPUT PLUGINS                                   #</em><br/><em class="ko">###############################################################################</em></span><span id="2b49" class="lc ld iq ky b gy li lf l lg lh"><em class="ko"># Configuration for sending metrics to InfluxDB</em><br/>[[outputs.influxdb]]<br/>  <em class="ko">## The full HTTP or UDP URL for your InfluxDB instance.#### Multiple URLs can be specified for a single cluster, only ONE of the</em></span><span id="c4ae" class="lc ld iq ky b gy li lf l lg lh">urls = ["http://server1_ip:8086"]</span><span id="ebe1" class="lc ld iq ky b gy li lf l lg lh">  <em class="ko">## The target database for metrics; will be created as needed.</em><br/>   database = "telegraf"</span><span id="e364" class="lc ld iq ky b gy li lf l lg lh">  <em class="ko">## If true, no CREATE DATABASE queries will be sent.  Set to true when using## Telegraf with a user without permissions to create databases or when the## database already exists.</em><br/>  skip_database_creation = true</span><span id="e5ce" class="lc ld iq ky b gy li lf l lg lh">  <em class="ko">## Name of existing retention policy to write to.  Empty string writes to## the default retention policy.  Only takes effect when using HTTP.# retention_policy = ""</em></span><span id="3767" class="lc ld iq ky b gy li lf l lg lh">  <em class="ko">## Write consistency (clusters only), can be: "any", "one", "quorum", "all".## Only takes effect when using HTTP.# write_consistency = "any"</em></span><span id="5cea" class="lc ld iq ky b gy li lf l lg lh">  <em class="ko">## Timeout for HTTP messages.</em><br/>   timeout = "5s"</span><span id="6125" class="lc ld iq ky b gy li lf l lg lh">  <em class="ko">## HTTP Basic Auth</em><br/>   username = "telegraf"<br/>   password = "secretpassword"</span></pre><p id="2dbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">干得好:)现在，我们有了一个非常漂亮的仪表板，时间最短:</p><figure class="kt ku kv kw gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lx"><img src="../Images/5d17472c4da0a4c552efc5f67dd7cd7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W-aYg6h58jB3Hjec"/></div></div></figure><p id="48c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在多台服务器上安装 Telegraf，也可以将系统指标发送到一个 InfluxDB base，然后您只需在 Grafana dashboard 中选择服务器名称即可查看它们。</p><p id="8ab4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一件重要的事情是关于在 InfluxDb 中保存数据的持续时间，默认情况下它设置为 7 天，所以如果您需要比这更长的时间，请执行到 influxdb 容器并手动更改保留策略。</p><p id="611b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯，我想现在我们在 5 分钟内就有了一个很好的监控系统:)</p><p id="bc98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝你好运。</p></div></div>    
</body>
</html>