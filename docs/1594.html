<html>
<head>
<title>Create an Azure Machine Learning Web Service with Python and Azure DSVM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python和Azure DSVM创建Azure机器学习Web服务</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/create-an-azure-machine-learning-web-service-with-python-and-azure-dsvm-f7a16a925c4b?source=collection_archive---------2-----------------------#2017-09-24">https://towardsdatascience.com/create-an-azure-machine-learning-web-service-with-python-and-azure-dsvm-f7a16a925c4b?source=collection_archive---------2-----------------------#2017-09-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b587" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上周，当我在阅读关于<a class="ae kl" href="https://www.microsoft.com/en-us/cognitive-toolkit/" rel="noopener ugc nofollow" target="_blank">微软CNTK </a>的文档，并从他们的<a class="ae kl" href="https://github.com/Microsoft/CNTK" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>中检查代码样本时，我碰到了另一个GitHub库，它是关于<a class="ae kl" href="https://github.com/Azure/Machine-Learning-Operationalization" rel="noopener ugc nofollow" target="_blank"> Azure机器学习操作化</a>。</p><blockquote class="km kn ko"><p id="4395" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated">Azure Machine Learning operational ization是Azure CLI的一个组件，它支持您通过Vienna使用CNTK、SPARK和Python机器学习平台创建的模型的可操作性。</p></blockquote><p id="19ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近一直在玩Python和机器学习，所以我想我应该试试这个，并使用用Python构建的机器学习模型创建一个AzureML Web服务。</p><blockquote class="kt"><p id="f88d" class="ku kv iq bd kw kx ky kz la lb lc kk dk translated">重要提示:撰写本文时，Azure机器学习操作化仍处于预览阶段。未来可能会发生一些突破性的变化。</p></blockquote><h1 id="d2ed" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">入门指南</h1><p id="5826" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">要开始Azure机器学习操作化，您需要以下内容:</p><ol class=""><li id="986f" class="mg mh iq jp b jq jr ju jv jy mi kc mj kg mk kk ml mm mn mo bi translated">Azure账户(如果你没有，你可以在这里获得免费试用<a class="ae kl" href="https://azure.microsoft.com/en-us/free/" rel="noopener ugc nofollow" target="_blank"/></li><li id="1c82" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk ml mm mn mo bi translated">azure Data Science Virtual Machine(DSVM)——虽然这并不是必须的，但我认为这是最快最简单的入门方式。你可以点击查看文档<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/machine-learning/machine-learning-data-science-provision-vm" rel="noopener ugc nofollow" target="_blank">来创建一个。</a></li></ol><h1 id="3412" class="ld le iq bd lf lg lh li lj lk ll lm ln lo mu lq lr ls mv lu lv lw mw ly lz ma bi translated">更新(实际上是重新安装)Azure CLI包</h1><p id="b0b0" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">一旦你创建了Azure DSVM，我们要做的第一件事就是通过卸载和安装来更新我们的<code class="fe mx my mz na b">azure-cli</code>、<code class="fe mx my mz na b">azure-cli-ml</code>和<code class="fe mx my mz na b">azure-ml-api-sdk</code>包。</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="fe3a" class="nj le iq na b gy nk nl l nm nn">$ pip uninstall azure-cli azure-cli-ml azure-ml-api-sdk<br/>$ pip install azure-cli azure-cli-ml azure-ml-api-sdk</span></pre><p id="ff26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以前，我尝试用<code class="fe mx my mz na b">pip install</code>中的<code class="fe mx my mz na b">--upgrade</code>选项更新软件包，但我一直在升级软件包时出错。因此，卸载并安装它可以解决问题，因为稍后，我们将使用这些包来生成一个模式，并将我们训练好的模型部署到我们的web服务中。</p><h1 id="4c9c" class="ld le iq bd lf lg lh li lj lk ll lm ln lo mu lq lr ls mv lu lv lw mw ly lz ma bi translated">构建性别分类器模型</h1><p id="932f" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">接下来，我们将使用<code class="fe mx my mz na b">scikit-learn</code>机器学习库创建一个模型，该模型将根据给定的身体指标(<em class="kp">身高、宽度和鞋码</em>)来预测这个人是男是女。创建一个名为<code class="fe mx my mz na b">train.py</code>的文件，您可以复制下面的代码:</p><figure class="nb nc nd ne gt no"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="1e46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行代码，它会在你的项目文件夹中创建一个<code class="fe mx my mz na b">model.pkl</code>。</p><h1 id="cd92" class="ld le iq bd lf lg lh li lj lk ll lm ln lo mu lq lr ls mv lu lv lw mw ly lz ma bi translated">创建score.py</h1><p id="24b8" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">要将我们的模型部署为web服务，我们需要创建一个用于生成模式JSON文件的<code class="fe mx my mz na b">score.py</code>。</p><figure class="nb nc nd ne gt no"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="f33f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe mx my mz na b">score.py</code>，您应该会看到<code class="fe mx my mz na b">service_schema.json</code>已经创建。现在，我们的项目文件夹应该包含以下文件:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="d636" class="nj le iq na b gy nk nl l nm nn">PROJECT_FOLDER<br/>- train.py<br/>- score.py<br/>- model.pkl<br/>- service_schema.json</span></pre><h1 id="7c70" class="ld le iq bd lf lg lh li lj lk ll lm ln lo mu lq lr ls mv lu lv lw mw ly lz ma bi translated">使用Azure CLI创建和部署Web服务</h1><p id="dc7f" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">现在我们已经设置好了一切，我们现在将通过执行以下操作来创建我们的web服务并部署模型:</p><h2 id="0b6e" class="nj le iq bd lf nr ns dn lj nt nu dp ln jy nv nw lr kc nx ny lv kg nz oa lz ob bi translated">在Azure CLI中验证您的帐户</h2><p id="3d64" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">为了能够使用<code class="fe mx my mz na b">azure cli</code>创建我们的<em class="kp">环境</em>和<em class="kp">模型管理帐户</em>，我们首先需要使用以下命令进行认证:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="62cd" class="nj le iq na b gy nk nl l nm nn">$ az login</span></pre><p id="e1bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将显示一条信息，提示您需要打开网络浏览器，进入<a class="ae kl" href="https://aka.ms/devicelogin" rel="noopener ugc nofollow" target="_blank">https://aka.ms/devicelogin</a>并输入终端中提供的代码。</p><h2 id="cb1f" class="nj le iq bd lf nr ns dn lj nt nu dp ln jy nv nw lr kc nx ny lv kg nz oa lz ob bi translated">创造环境</h2><p id="3d39" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">一旦您能够使用<code class="fe mx my mz na b">azure cli</code>验证您的帐户，键入以下命令来创建我们的环境:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="85f1" class="nj le iq na b gy nk nl l nm nn">$  az ml env setup -c -n YOUR_CLUSTER_NAME -l YOUR_LOCATION</span></pre><p id="5d8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我在本教程中使用的:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="16b4" class="nj le iq na b gy nk nl l nm nn">$ az ml env setup -c -n azmldemo -l australiaeast</span></pre><p id="4091" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记住现在支持的位置是<code class="fe mx my mz na b">westcentralus</code>、<code class="fe mx my mz na b">eastus2</code>和<code class="fe mx my mz na b">australiaeast</code>也很重要。</p><h2 id="b0be" class="nj le iq bd lf nr ns dn lj nt nu dp ln jy nv nw lr kc nx ny lv kg nz oa lz ob bi translated">创建模型管理帐户</h2><p id="7c4f" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我们的环境至少需要10-20分钟才能完成配置，因此在等待的同时，我们现在可以创建我们的模型管理帐户，这是一个<strong class="jp ir">一次性设置</strong>的事情。</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="b3b0" class="nj le iq na b gy nk nl l nm nn">$ az ml account modelmanagement create -l YOUR_LOCATION -n YOUR_MODEL_MANAGEMENT_ACCOUNT_NAME -g YOUR_RESOURCE_GROUP</span></pre><p id="6237" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我在本教程中使用的:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="d18b" class="nj le iq na b gy nk nl l nm nn">$ az ml account modelmanagement create -l australiaeast -n azmldemoacc -g azmldemorg</span></pre><p id="66d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想知道，<code class="fe mx my mz na b">azmldemorg</code>资源组是在我们之前创建环境时自动创建的，它基本上是在我们的集群名称<code class="fe mx my mz na b">azmldemo</code>上添加了一个<strong class="jp ir"> rg </strong>。</p><h2 id="4f58" class="nj le iq bd lf nr ns dn lj nt nu dp ln jy nv nw lr kc nx ny lv kg nz oa lz ob bi translated">设置模型管理帐户和环境</h2><p id="2dfa" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">一旦成功创建了模型管理帐户和您的环境，我们现在将使用以下命令设置模型管理帐户和环境:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="77f5" class="nj le iq na b gy nk nl l nm nn">$ az ml account modelmanagement set -n YOUR_MODEL_MANAGEMENT_ACCOUNT_NAME -g YOUR_RESOURCE_GROUP</span><span id="96f2" class="nj le iq na b gy oc nl l nm nn">$ az ml env set -n YOUR_CLUSTER_NAME -g YOUR_RESOURCE_GROUP</span></pre><p id="965d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我在本教程中使用的:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="f6e2" class="nj le iq na b gy nk nl l nm nn">$ az ml account modelmanagement set -n azmldemoacc -g azmldemorg<br/>$ az ml env set -n azmldemo -g azmldemorg</span></pre><p id="56b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样重要的是要记住，您的环境<em class="kp">供应状态</em>应该显示<em class="kp">成功</em>，以便您能够成功设置它。您可以使用以下命令检查资源调配状态:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="7461" class="nj le iq na b gy nk nl l nm nn">$ az ml env show -g YOUR_RESOURCE_GROUP -n YOUR_CLUSTER_NAME</span></pre><h2 id="7875" class="nj le iq bd lf nr ns dn lj nt nu dp ln jy nv nw lr kc nx ny lv kg nz oa lz ob bi translated">创建Web服务</h2><p id="7a15" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">一旦您能够成功设置您的模型管理帐户和环境，我们现在将通过以下方式创建web服务:</p><ol class=""><li id="83a5" class="mg mh iq jp b jq jr ju jv jy mi kc mj kg mk kk ml mm mn mo bi translated">转到我们已经创建了性别分类器模型和JSON模式的项目文件夹</li><li id="7210" class="mg mh iq jp b jq mp ju mq jy mr kc ms kg mt kk ml mm mn mo bi translated">键入以下命令创建web服务:</li></ol><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="df8b" class="nj le iq na b gy nk nl l nm nn">$ az ml service create realtime -f score.py --m model.pkl -s service_schema.json -n genderclassifier -r python</span><span id="b404" class="nj le iq na b gy oc nl l nm nn">or you can also use --help or -h to know the other arguments available</span><span id="18f0" class="nj le iq na b gy oc nl l nm nn">$ az ml service create realtime -h</span></pre><h1 id="1843" class="ld le iq bd lf lg lh li lj lk ll lm ln lo mu lq lr ls mv lu lv lw mw ly lz ma bi translated">测试Web服务</h1><p id="91db" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">一旦成功地创建了web服务，您就可以使用下面的命令来获取可以用来测试web服务的所有重要细节(<em class="kp">像示例CLI命令、Swagger URL、授权载体密钥等等</em>):</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="69b7" class="nj le iq na b gy nk nl l nm nn">$ az ml service usage realtime -i YOUR_SERVICE_ID</span></pre><p id="dccc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用以下命令获得您的<em class="kp">服务Id </em>:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="1603" class="nj le iq na b gy nk nl l nm nn">$ az ml service list realtime</span></pre><h2 id="7d60" class="nj le iq bd lf nr ns dn lj nt nu dp ln jy nv nw lr kc nx ny lv kg nz oa lz ob bi translated">运行示例CLI命令</h2><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="7135" class="nj le iq na b gy nk nl l nm nn">$ az ml service run realtime -i YOUR_SERVICE_ID -d "{\"input_df\": [{\"width\": 60, \"shoe_size\": 38, \"height\": 190}]}"</span></pre><p id="7c44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您在终端中运行时，应该是这样的:</p><figure class="nb nc nd ne gt no gh gi paragraph-image"><div role="button" tabindex="0" class="oe of di og bf oh"><div class="gh gi od"><img src="../Images/51609298486a1409250bc61e3d21d4d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*qkidLNbb9FMfxVlqoT9eVQ.gif"/></div></div></figure><h2 id="dec3" class="nj le iq bd lf nr ns dn lj nt nu dp ln jy nv nw lr kc nx ny lv kg nz oa lz ob bi translated">通过邮递员测试</h2><p id="fe93" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">这里有一个关于如何通过<code class="fe mx my mz na b">Scoring URL</code>测试web服务的例子</p><figure class="nb nc nd ne gt no gh gi paragraph-image"><div role="button" tabindex="0" class="oe of di og bf oh"><div class="gh gi ok"><img src="../Images/dd2c5d62c59113687da706dcf8be4963.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*PM7KmPIovf2AzBCEOJGEjA.gif"/></div></div></figure><p id="033d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经完成了，那么你对Azure机器学习的可操作性有什么看法？同样，您可以在这里查看他们的GitHub库<a class="ae kl" href="https://github.com/Azure/Machine-Learning-Operationalization" rel="noopener ugc nofollow" target="_blank">中的其他示例。</a></p></div></div>    
</body>
</html>