<html>
<head>
<title>High-Availability MySQL cluster with load balancing using HAProxy and Heartbeat.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 HAProxy 和 Heartbeat 实现负载平衡的高可用性 MySQL 集群。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/high-availability-mysql-cluster-with-load-balancing-using-haproxy-and-heartbeat-40a16e134691?source=collection_archive---------1-----------------------#2018-12-03">https://towardsdatascience.com/high-availability-mysql-cluster-with-load-balancing-using-haproxy-and-heartbeat-40a16e134691?source=collection_archive---------1-----------------------#2018-12-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f87e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你好，在这篇文章中，我想分享一些从两个主 MySQL 节点构建高可用性 MySQL 数据库集群的经验，该集群具有基于 HAProxy &amp; Heartbeat 的负载平衡和故障转移功能。</p><p id="4a3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在大多数现代项目中，数据库可用性是生死攸关的问题。好的解决方案是从一个以上的 MySQL 服务器创建一个分布式数据库集群，它可以负责负载平衡、故障转移功能和数据复制。此外，您可以拆分传入的请求并处理高负载。</p><p id="c4b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中，我将展示从两个主节点创建一个 MySQL 集群，主要思想是创建一对具有相同配置的服务器和一个用于接收请求的虚拟 IP。即使完全失去其中一个节点，该群集也将继续工作。</p><p id="2e22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用两台服务器(虚拟或裸机),上面安装一对 MySQL masters 和一对 HAProxy，主虚拟 IP 将配置 Heartbeat。请注意，在本例中，一个时间段内仅使用一个 HAProxy，第二个 HAProxy 将处于热储备状态。MySQL 服务器将循环使用负载平衡类型。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/f7fce12ed9efda730e38f2538df37242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-UDKtIOlY9KCgnT0iTIuCg.png"/></div></div></figure><blockquote class="kx ky kz"><p id="8f05" class="jn jo la jp b jq jr js jt ju jv jw jx lb jz ka kb lc kd ke kf ld kh ki kj kk ij bi translated">选择具有两个服务器的模式是为了使示例更简单。当然，如果您有额外的服务器，您可以创建更复杂的配置，将 HAProxy 与 Heartbeat 放在外部 LB 集群中等等。但是无论如何，这个例子对于在你的项目中构建一个强大的数据库集群来说已经足够了。</p></blockquote><h2 id="0394" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated">0。正在准备。</h2><p id="1a5b" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">首先，我们需要为 MySQL 复制和 HAProxy with Heartbeat 选择几个子网，最好将它们分开，如果您的服务器有几个网络接口，也将这些子网放在不同的接口上。</p><p id="546a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">192 . 168 . 0 . 0/24</strong>-DB 流量网络</p><p id="c5f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">MySQL1 的<strong class="jp ir"> 192.168.0.1 </strong> IP，MySQL2 的<strong class="jp ir"> 192.168.0.2 </strong> IP。</p><p id="c2c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 10.10.10.0/24 </strong> -心跳网络&amp; HAProxy。</p><p id="679a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 10.10.10.1 </strong>虚拟 IP 用于取请求，<strong class="jp ir">10 . 10 . 2</strong>主 IP 用于<strong class="jp ir">服务器 1 </strong>，<strong class="jp ir"> 10.10.10.3 </strong>主 IP 用于<strong class="jp ir">服务器 2 </strong>。</p><blockquote class="kx ky kz"><p id="5268" class="jn jo la jp b jq jr js jt ju jv jw jx lb jz ka kb lc kd ke kf ld kh ki kj kk ij bi translated">事实上/29 子网就足够了:)</p></blockquote><h2 id="5ed9" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated"><strong class="ak"> 1。用主-主复制配置 MySQL 服务器。</strong></h2><p id="6908" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">首先，我们需要在两台服务器上安装 MySQL:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="6e0f" class="le lf iq md b gy mh mi l mj mk"># apt-get update &amp;&amp; apt-get upgrade -y</span><span id="d938" class="le lf iq md b gy ml mi l mj mk"># apt-get install mysql-server mysql-client</span></pre><p id="3646" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在第一个和第二个节点上编辑<strong class="jp ir"> /etc/mysql/my.cnf </strong>，以启用 mysql 服务器之间的复制，并使它们使用来自 192.168.0.0/24 子网的 IP:</p><p id="f86a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器 1 配置。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="174d" class="le lf iq md b gy mh mi l mj mk">[mysqld]</span><span id="501e" class="le lf iq md b gy ml mi l mj mk">bind-address    = 192.168.0.1</span><span id="cc64" class="le lf iq md b gy ml mi l mj mk">server_id           = 1<br/>log_bin             = /var/log/mysql/mysql-bin.log<br/>log_bin_index       = /var/log/mysql/mysql-bin.log.index<br/>relay_log           = /var/log/mysql/mysql-relay-bin<br/>relay_log_index     = /var/log/mysql/mysql-relay-bin.index<br/>expire_logs_days    = 10<br/>max_binlog_size     = 100M<br/>log_slave_updates   = 1<br/>auto-increment-increment = 2<br/>auto-increment-offset = 1</span></pre><p id="f33a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Server2 配置。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="694b" class="le lf iq md b gy mh mi l mj mk">[mysqld]</span><span id="5125" class="le lf iq md b gy ml mi l mj mk">bind-address    = 192.168.0.2</span><span id="7d71" class="le lf iq md b gy ml mi l mj mk">server_id           = 2<br/>log_bin             = /var/log/mysql/mysql-bin.log<br/>log_bin_index       = /var/log/mysql/mysql-bin.log.index<br/>relay_log           = /var/log/mysql/mysql-relay-bin<br/>relay_log_index     = /var/log/mysql/mysql-relay-bin.index<br/>expire_logs_days    = 10<br/>max_binlog_size     = 100M<br/>log_slave_updates   = 1<br/>auto-increment-increment = 2<br/>auto-increment-offset = 2</span></pre><p id="2ec5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后重新启动它们，并确保 MySQL 叶在指定的 IP:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="acf6" class="le lf iq md b gy mh mi l mj mk">server1# systemctl restart mysql</span><span id="f80b" class="le lf iq md b gy ml mi l mj mk">server1# netstat -ntlp</span><span id="1cc6" class="le lf iq md b gy ml mi l mj mk">Active Internet connections (only servers)<br/>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    <br/>tcp        0      0 192.168.0.1:3306        0.0.0.0:*               LISTEN      9057/mysqld</span><span id="e6ac" class="le lf iq md b gy ml mi l mj mk">server2# systemctl restart mysql</span><span id="b106" class="le lf iq md b gy ml mi l mj mk">server2# netstat -ntlp</span><span id="a32a" class="le lf iq md b gy ml mi l mj mk">Active Internet connections (only servers)<br/>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    <br/>tcp        0      0 192.168.0.2:3306        0.0.0.0:*               LISTEN      8740/mysqld</span></pre><p id="29c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在将为数据库之间的复制创建一个用户，你可以使用<strong class="jp ir"> pwgen </strong>实用程序来生成足够强的密码。连接到每个 MySQL 服务器，并使用来自对方服务器的 IP 创建该用户:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="7880" class="le lf iq md b gy mh mi l mj mk">server1# mysql -u root -p</span><span id="64ef" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->GRANT REPLICATION SLAVE ON *.* TO 'replicauser'@'192.168.0.2' IDENTIFIED BY 'somestrongpassword';</span><span id="5de3" class="le lf iq md b gy ml mi l mj mk">server2# <!-- -->mysql -u root -p</span><span id="f964" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; GRANT REPLICATION SLAVE ON *.* TO 'replicauser'@'192.168.0.1' IDENTIFIED BY '<!-- -->somestrongpassword<!-- -->';</span></pre><p id="c4d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查<strong class="jp ir">复制用户</strong>是否可以访问每台 MySQL 服务器。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="b5d6" class="le lf iq md b gy mh mi l mj mk">server1# mysql -u replicauser -p -h 192.168.0.2<br/>Enter password: <!-- -->somestrongpassword<br/>Welcome to the MariaDB monitor.  Commands end with ; or \g.<strong class="md ir"><br/></strong>bla bla....</span><span id="8008" class="le lf iq md b gy ml mi l mj mk">server2# mysql -u replicauser -p -h 192.168.0.1<br/>Enter password: <!-- -->somestrongpassword<br/>Welcome to the MariaDB monitor.  Commands end with ; or \g.<strong class="md ir"><br/></strong>bla bla....</span></pre><p id="d0d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在我们可以继续配置 MySQL 服务器之间的复制。从那时起，最好从两个 MySQL 服务器打开两个控制台，因为我们需要根据另一个服务器的输出输入命令。</p><p id="3580" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取服务器 1 上的 MySQL 主服务器状态:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="35cc" class="le lf iq md b gy mh mi l mj mk">server1# mysql -u root -p</span><span id="3ce9" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->SHOW MASTER STATUS;</span><span id="9418" class="le lf iq md b gy ml mi l mj mk">+------------------+----------+--------------+------------------+<br/>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |<br/>+------------------+----------+--------------+------------------+<br/>| mysql-bin.000002 |      531 |              |                  |<br/>+------------------+----------+--------------+------------------+<br/>1 row in set (0.00 sec)</span></pre><p id="40ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要这个输出中的<strong class="jp ir">文件</strong>和<strong class="jp ir">位置</strong>信息。打开 server2 上的 MySQL 控制台，配置与第一台服务器的从属关系。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="a98a" class="le lf iq md b gy mh mi l mj mk">server2# mysql -u root -p</span><span id="6922" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->STOP SLAVE;</span><span id="78ed" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->CHANGE MASTER TO master_host='192.168.0.1', master_port=3306, master_user='replicauser', master_password='somestrongpassword', master_log_file='<!-- -->mysql-bin.000002<!-- -->', master_log_pos=<!-- -->531<!-- -->;</span><span id="bace" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->START SLAVE;</span></pre><p id="57ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在从 server2 查询主服务器状态，并在第一台服务器上为 MySQL 配置从服务器关系。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="bc8d" class="le lf iq md b gy mh mi l mj mk">server2# mysql -u root -p</span><span id="4d5c" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->SHOW MASTER STATUS;</span><span id="5028" class="le lf iq md b gy ml mi l mj mk">+------------------+----------+--------------+------------------+<br/>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |<br/>+------------------+----------+--------------+------------------+<br/>| mysql-bin.000002 |      531 |              |                  |<br/>+------------------+----------+--------------+------------------+<br/>1 row in set (0.00 sec)</span><span id="b96a" class="le lf iq md b gy ml mi l mj mk">server1# mysql -u root -p</span><span id="ef1e" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->STOP SLAVE;</span><span id="97ea" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->CHANGE MASTER TO master_host='192.168.0.2', master_port=3306, master_user='replicauser', master_password='somestrongpassword', master_log_file='<!-- -->mysql-bin.000002<!-- -->', master_log_pos=<!-- -->531<!-- -->;</span><span id="24e0" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->START SLAVE;</span></pre><p id="4d4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，如果一切都做对了，我们必须在 MySQL 主服务器之间建立一个有效的复制。您可以创建一些测试数据库并检查这一点。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="a3a8" class="le lf iq md b gy mh mi l mj mk">server1# mysql -u root -p</span><span id="8130" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; CREATE DATABASE TESTDB;<br/>MariaDB&gt; <!-- -->CREATE TABLE TESTDB.REPLICA (`id` varchar(40));</span></pre><p id="06d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后检查该数据库是否也出现在第二台服务器上:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="3f4e" class="le lf iq md b gy mh mi l mj mk">server2# mysql -u root -p</span><span id="9c2d" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; <!-- -->SHOW TABLES IN TESTDB;<br/>+------------------+<br/>| Tables_in_TESTDB |<br/>+------------------+<br/>| REPLICA          |<br/>+------------------+<br/>1 row in set (0.00 sec)</span></pre><p id="4247" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您所看到的，TESTDB<strong class="jp ir">base 被成功地复制到了 server2。我们刚刚完成了创建故障转移集群的第一阶段。</strong></p><h2 id="45be" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated">2.<strong class="ak">在两台服务器上配置 HAProxy。</strong></h2><p id="82eb" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在第二阶段，我们将在两台服务器上安装和配置两个完全相同的 HAProxy，用于平衡 MySQL 服务器之间的传入请求。</p><p id="9f38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要在我们的 MySQL 服务器上添加额外的用户(用户必须在没有任何密码的情况下创建)，该用户将由 HAProxy 用于检查 MySQL 服务器的健康状态。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="f16f" class="le lf iq md b gy mh mi l mj mk">server1# mysql -u root -p</span><span id="b91d" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; CREATE USER 'haproxy_check'@'%';<br/>MariaDB&gt; FLUSH PRIVILEGES;</span></pre><p id="443b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在我们的任何 MySQL 服务器上创建这个用户，因为我们在它们之间配置了一个复制。使用以下命令检查用户是否已添加:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="8bb8" class="le lf iq md b gy mh mi l mj mk">server1# mysql -u root -p -e "SELECT User, Host FROM mysql.user"<br/>Enter password: <br/>+---------------+-------------+<br/>| User          | Host        |<br/>+---------------+-------------+<br/>| haproxy_check | %           |<br/>| replicauser   | 192.168.0.2 |<br/>| root          | localhost   |<br/>+---------------+-------------+</span><span id="1768" class="le lf iq md b gy ml mi l mj mk">server2# mysql -u root -p -e "SELECT User, Host FROM mysql.user"<br/>Enter password: <br/>+---------------+-------------+<br/>| User          | Host        |<br/>+---------------+-------------+<br/>| haproxy_check | %           |<br/>| replicauser   | 192.168.0.1 |<br/>| root          | localhost   |<br/>+---------------+-------------+</span></pre><p id="3dd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，让我们创建一个具有 root 权限的用户，以便稍后进行一些测试请求:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="cf22" class="le lf iq md b gy mh mi l mj mk">server1# mysql -u root -p</span><span id="ecff" class="le lf iq md b gy ml mi l mj mk">MariaDB&gt; CREATE USER 'haproxy_root'@'%' IDENTIFIED BY 'password';<br/>MariaDB&gt; GRANT ALL PRIVILEGES ON *.* TO 'haproxy_root'@'%';</span></pre><p id="d286" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在是安装 HAProxy 的时候了:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="0556" class="le lf iq md b gy mh mi l mj mk">server1# apt-get install haproxy<br/>server2# apt-get install haproxy</span></pre><p id="4e7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">保存原始配置并创建新配置:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="e3dc" class="le lf iq md b gy mh mi l mj mk">server1# mv /etc/haproxy/haproxy.cfg{,.back}<br/>server1# vi /etc/haproxy/haproxy.cfg</span></pre><p id="d358" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在两台服务器上添加此配置:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="1096" class="le lf iq md b gy mh mi l mj mk">global<br/>    user haproxy<br/>    group haproxy</span><span id="b576" class="le lf iq md b gy ml mi l mj mk">defaults<br/>    mode http<br/>    log global<br/>    retries 2<br/>    timeout connect 3000ms<br/>    timeout server 5000ms<br/>    timeout client 5000ms</span><span id="c8dc" class="le lf iq md b gy ml mi l mj mk">listen stats<br/>    bind 10.10.10.1:9999<br/>    stats enable<br/>    stats hide-version<br/>    stats uri /stats<br/>    stats auth statadmin:statadminpass</span><span id="c4ea" class="le lf iq md b gy ml mi l mj mk">listen mysql-cluster<br/>    bind 10.10.10.1:3306<br/>    mode tcp<br/>    option mysql-check user haproxy_check<br/>    balance roundrobin<br/>    server mysql-1 192.168.0.1:3306 check<br/>    server mysql-2 192.168.0.2:3306 check</span></pre><p id="21e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以看到，两个 HAProxy 服务都将使用 10.10.10.1，共享 IP 地址。这个虚拟 ip 将在服务器之间移动，因此我们需要使用一些技巧并启用<strong class="jp ir">net . IP v4 . IP _ non local _ bind</strong>sysctl 选项，以允许系统服务绑定在非本地 IP 上。</p><p id="09f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将此选项添加到文件<strong class="jp ir"> /etc/sysctl.conf </strong>中:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="86e1" class="le lf iq md b gy mh mi l mj mk"><em class="la">server1# vi /etc/sysctl.conf</em></span><span id="5c35" class="le lf iq md b gy ml mi l mj mk">net.ipv4.ip_nonlocal_bind=1</span><span id="14b0" class="le lf iq md b gy ml mi l mj mk"><em class="la">server2# vi /etc/sysctl.conf</em></span><span id="cb60" class="le lf iq md b gy ml mi l mj mk">net.ipv4.ip_nonlocal_bind=1</span></pre><p id="a2a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那就跑</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="0832" class="le lf iq md b gy mh mi l mj mk"><em class="la">sysctl -p</em></span></pre><p id="ce47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，我们可以在两台服务器上启动 HAProxy:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="d455" class="le lf iq md b gy mh mi l mj mk">server1# systemctl start haproxy<br/>server2# systemctl start haproxy</span></pre><p id="3eb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查它们是否在共享 IP 10.10.10.1 上启动:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="79a9" class="le lf iq md b gy mh mi l mj mk">server1# netstat -ntlp </span><span id="49f4" class="le lf iq md b gy ml mi l mj mk">Active Internet connections (only servers) <br/>Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name <br/>tcp 0 0 192.168.0.1:3306 0.0.0.0:* LISTEN 918/mysqld <br/>tcp 0 0 10.10.10.1:3306 0.0.0.0:* LISTEN 802/haproxy <br/>tcp 0 0 10.10.10.1:9999 0.0.0.0:* LISTEN 802/haproxy <br/>tcp 0 0 10.10.10.2:22 0.0.0.0:* LISTEN 785/sshd</span><span id="9fdf" class="le lf iq md b gy ml mi l mj mk">server2# netstat -ntlp</span><span id="0521" class="le lf iq md b gy ml mi l mj mk">Active Internet connections (only servers) <br/>Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name <br/>tcp 0 0 192.168.0.2:3306 0.0.0.0:* LISTEN 918/mysqld <br/>tcp 0 0 10.10.10.1:3306 0.0.0.0:* LISTEN 802/haproxy <br/>tcp 0 0 10.10.10.1:9999 0.0.0.0:* LISTEN 802/haproxy <br/>tcp 0 0 10.10.10.3:22 0.0.0.0:* LISTEN 785/sshd</span></pre><p id="ddcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一切看起来都很好，两台服务器都是使用虚拟 IP 启动的，我们还在 9999 端口上配置了一个统计页面，因此您可以使用 statadmin:statadminpass 在<a class="ae mm" href="http://10.10.10.1:9999/stats" rel="noopener ugc nofollow" target="_blank">http://10 . 10 . 10 . 1:9999/stats</a>上检查 HAProxy 状态。</p><h2 id="cccb" class="le lf iq bd lg lh li dn lj lk ll dp lm jy ln lo lp kc lq lr ls kg lt lu lv lw bi translated">3.<strong class="ak">使用共享 IP 配置心跳。</strong></h2><p id="b155" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在最后一个阶段，我们需要在两台服务器上配置 Heartbeat 服务，并创建共享的 IP，它将用于处理传入的请求。如果其中一台服务器发生问题，这个 IP 将在服务器之间迁移。</p><p id="084b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在两台服务器上安装 Heartbeat:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="8d0f" class="le lf iq md b gy mh mi l mj mk">server1# apt-get install heartbeat<br/>server1# systemctl enable heartbeat</span><span id="56ad" class="le lf iq md b gy ml mi l mj mk">server2# apt-get install heartbeat<br/>server2# systemctl enable heartbeat</span></pre><p id="d15a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要为它创建一些配置文件，它们对于 server1 和 server2 来说基本相同。</p><p id="58d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个<strong class="jp ir"> /etc/ha.d/authkeys </strong>，在这个文件中心跳存储数据来认证对方。两个服务器上的文件将是相同的:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="68b2" class="le lf iq md b gy mh mi l mj mk">server1# vi /etc/ha.d/authkeys</span><span id="175e" class="le lf iq md b gy ml mi l mj mk">auth 1<br/>1 md5 securepass</span><span id="4f1a" class="le lf iq md b gy ml mi l mj mk">server2# vi /etc/ha.d/authkeys</span><span id="c028" class="le lf iq md b gy ml mi l mj mk">auth 1<br/>1 md5 securepass</span></pre><p id="af78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<strong class="jp ir"> securepass </strong>改为您的强安全密码。此外，该文件只需要由 root 用户拥有，因此:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="4300" class="le lf iq md b gy mh mi l mj mk">server1# chmod 600 /etc/ha.d/authkeys<br/>server2# chmod 600 /etc/ha.d/authkeys</span></pre><p id="c892" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来将在两台服务器上为 Heartbeat 创建一个主配置，对于 server1 和 server2 会有一点不同，创建<strong class="jp ir"> /etc/ha.d/ha.cf </strong>:</p><p id="2ce9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器 1</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="c80b" class="le lf iq md b gy mh mi l mj mk">server1# vi /etc/ha.d/ha.cf</span><span id="78a7" class="le lf iq md b gy ml mi l mj mk">#       keepalive: how many seconds between heartbeats<br/>#<br/>keepalive 2<br/>#<br/>#       deadtime: seconds-to-declare-host-dead<br/>#<br/>deadtime 10<br/>#<br/>#       What UDP port to use for udp or ppp-udp communication?<br/>#<br/>udpport        694<br/>bcast  ens18<br/>mcast ens18 225.0.0.1 694 1 0<br/>ucast ens18 10.10.10.3<br/>#       What interfaces to heartbeat over?<br/>udp     ens18<br/>#<br/>#       Facility to use for syslog()/logger (alternative to log/debugfile)<br/>#<br/>logfacility     local0<br/>#<br/>#       Tell what machines are in the cluster<br/>#       node    nodename ...    -- must match uname -n<br/>node    server1<br/>node    server2</span></pre><p id="38a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器 2</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="f424" class="le lf iq md b gy mh mi l mj mk">server1# vi /etc/ha.d/ha.cf</span><span id="453f" class="le lf iq md b gy ml mi l mj mk">#       keepalive: how many seconds between heartbeats<br/>#<br/>keepalive 2<br/>#<br/>#       deadtime: seconds-to-declare-host-dead<br/>#<br/>deadtime 10<br/>#<br/>#       What UDP port to use for udp or ppp-udp communication?<br/>#<br/>udpport        694<br/>bcast  ens18<br/>mcast ens18 225.0.0.1 694 1 0<br/>ucast ens18 10.10.10.2<br/>#       What interfaces to heartbeat over?<br/>udp     ens18<br/>#<br/>#       Facility to use for syslog()/logger (alternative to log/debugfile)<br/>#<br/>logfacility     local0<br/>#<br/>#       Tell what machines are in the cluster<br/>#       node    nodename ...    -- must match uname -n<br/>node    server1<br/>node    server2</span></pre><p id="4448" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过在您的服务器上运行<code class="fe mn mo mp md b">uname -n</code>来获得这个配置的<strong class="jp ir">节点</strong>名称。</p><p id="95bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们需要在服务器 1 和服务器 2 上创建<strong class="jp ir"> /etc/ha.d/haresources </strong>文件。文件是相同的，在这个文件中，我们将默认声明我们的共享 IP 地址和主节点:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="8850" class="le lf iq md b gy mh mi l mj mk">server1# vi /etc/ha.d/haresources</span><span id="d963" class="le lf iq md b gy ml mi l mj mk">server1 10.10.10.1</span><span id="de0e" class="le lf iq md b gy ml mi l mj mk">server2# vi /etc/ha.d/haresources</span><span id="24cd" class="le lf iq md b gy ml mi l mj mk">server1 10.10.10.1</span></pre><p id="3de5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">毕竟，让我们在两台服务器上启动我们的心跳服务，您必须看到，在服务器 1 上，我们已经启动了虚拟 IP:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="9e63" class="le lf iq md b gy mh mi l mj mk">server1# ip a <br/>....<br/>2: ens19: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br/>    link/ether bla:bla:bla:bla brd ff:ff:ff:ff:ff:ff<br/>    inet 192.168.0.1/24 brd 192.168.0.255 scope global ens19<br/>       valid_lft forever preferred_lft forever<br/>    inet6 fe80::bla:bla:bla:bla/64 scope link <br/>       valid_lft forever preferred_lft forever<br/>3: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br/>    link/ether bla:bla:bla:bla:bla:bla brd ff:ff:ff:ff:ff:ff<br/>    inet 10.10.10.2/24 brd 10.10.10.255 scope global ens18<br/>       valid_lft forever preferred_lft forever<br/>    inet 10.10.10.1/24 brd 10.10.10.255 scope global secondary <br/>....</span></pre><p id="bf1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，现在我们在 server1 上分配了虚拟 IP，HAProxy 监听它，所以我们可以检查它是如何工作的，发出测试请求。从一些外部服务器运行以下命令:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="4a48" class="le lf iq md b gy mh mi l mj mk"># mysql -h 10.10.10.1 -u haproxy_root -p -e "show variables like 'server_id'"</span><span id="7cca" class="le lf iq md b gy ml mi l mj mk">Enter password: <br/>+---------------+-------+<br/>| Variable_name | Value |<br/>+---------------+-------+<br/>| server_id     | 1     |<br/>+---------------+-------+</span><span id="ba06" class="le lf iq md b gy ml mi l mj mk"># mysql -h 10.10.10.1 -u haproxy_root -p -e "show variables like 'server_id'"</span><span id="5c38" class="le lf iq md b gy ml mi l mj mk">Enter password: <br/>+---------------+-------+<br/>| Variable_name | Value |<br/>+---------------+-------+<br/>| server_id     | 2     |<br/>+---------------+-------+</span></pre><p id="9ae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一切正常，你可以看到我们的 MySQL 服务器之间的“循环”平衡。现在，我们需要检查故障转移，例如当服务器 1 离线时。转到并重新启动或关闭服务器 1，检查虚拟 IP 是否已移动到服务器 2，对 MySQL 服务器的请求是否仍然正常，但现在服务器 2 上只有 MySQL 会响应:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="0e1a" class="le lf iq md b gy mh mi l mj mk">server2# ip a <br/>....<br/>2: ens19: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br/>    link/ether bla:bla:bla:bla brd ff:ff:ff:ff:ff:ff<br/>    inet 192.168.0.2/24 brd 192.168.0.255 scope global ens19<br/>       valid_lft forever preferred_lft forever<br/>    inet6 fe80::bla:bla:bla:bla/64 scope link <br/>       valid_lft forever preferred_lft forever<br/>3: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<br/>    link/ether bla:bla:bla:bla:bla:bla brd ff:ff:ff:ff:ff:ff<br/>    inet 10.10.10.3/24 brd 10.10.10.255 scope global ens18<br/>       valid_lft forever preferred_lft forever<br/>    inet 10.10.10.1/24 brd 10.10.10.255 scope global secondary <br/>....</span></pre><p id="78cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次检查 MySQL 请求:</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="08c1" class="le lf iq md b gy mh mi l mj mk"># mysql -h 10.10.10.1 -u haproxy_root -p -e "show variables like 'server_id'"</span><span id="37fe" class="le lf iq md b gy ml mi l mj mk">Enter password: <br/>+---------------+-------+<br/>| Variable_name | Value |<br/>+---------------+-------+<br/>| server_id     | 2     |<br/>+---------------+-------+</span><span id="ddb1" class="le lf iq md b gy ml mi l mj mk"># mysql -h 10.10.10.1 -u haproxy_root -p -e "show variables like 'server_id'"</span><span id="0829" class="le lf iq md b gy ml mi l mj mk">Enter password: <br/>+---------------+-------+<br/>| Variable_name | Value |<br/>+---------------+-------+<br/>| server_id     | 2     |<br/>+---------------+-------+</span></pre><p id="2412" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在服务器 1 恢复在线后，虚拟 IP 将被移回服务器 1。</p><p id="a3b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们做到了，我们刚刚配置并测试了我们的 MySQL 集群，它现在已经准备好为请求提供服务。</p><p id="d7e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">祝你好运。</p></div></div>    
</body>
</html>