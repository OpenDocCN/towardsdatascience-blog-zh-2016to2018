<html>
<head>
<title>Building a Donut Chart Widget with D3.js and Svidget.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用D3.js和Svidget.js构建圆环图小部件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-donut-chart-widget-with-d3-js-and-svidget-js-8c150ccb01ae?source=collection_archive---------1-----------------------#2016-07-21">https://towardsdatascience.com/building-a-donut-chart-widget-with-d3-js-and-svidget-js-8c150ccb01ae?source=collection_archive---------1-----------------------#2016-07-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a050" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">D3.js 是一个非常著名和受人尊敬的JavaScript库，可以让你创建复杂的数据可视化，比如图表和图形。它已经成为web数据可视化的同义词。<a class="ae kl" href="http://www.svidget.com" rel="noopener ugc nofollow" target="_blank"> Svidget.js </a>是一个JavaScript框架，允许您在纯SVG中创建数据可视化小部件。从表面上看，这两个公司似乎是在相互竞争，但实际上恰恰相反。通过使用D3来输出一些惊人的数据可视化，并使用Svidget.js来简化部署和重用的包装，我们可以创建非常棒的可视化组件，可以轻松地嵌入到任何地方。简单来说，Svidget就是汉堡小圆面包，D3就是肉饼。</p><p id="4416" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们从小部件的角度考虑一个圆环图。它的属性或参数是什么？我们可以调用什么动作或方法？小部件会触发什么事件？Svidget小部件由3个构件组成— <strong class="jp ir">参数</strong>、<strong class="jp ir">动作</strong>和<strong class="jp ir">事件</strong>。定义这些工件是<em class="km">widget化</em>的第一步。(关于构建小部件的完整介绍，包括这些概念，可以在svidget.com上找到。)</p><p id="cbb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">三者中最难的是计算参数。为了获得一些灵感，我们可以看看现有的实现，如<a class="ae kl" href="http://gionkunz.github.io/chartist-js/api-documentation.html#chartistpie-declaration-defaultoptions" rel="noopener ugc nofollow" target="_blank">charist . js</a>或<a class="ae kl" href="https://developers.google.com/chart/interactive/docs/gallery/piechart#configuration-options" rel="noopener ugc nofollow" target="_blank"> Google Charts </a>。请记住，我们通常不想提供所有类型的配置，而是提供一个很好的抽象概念，让消费者快速启动并运行。根据最初的发现，我想出了:</p><ul class=""><li id="edd5" class="kn ko iq jp b jq jr ju jv jy kp kc kq kg kr kk ks kt ku kv bi translated">数据—小部件的数据，以数组形式表示</li><li id="474d" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated">maxSlices —将剩余数据分组到“其他”切片之前的最大切片数</li><li id="3cb7" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated">开始角度—图表开始的角度，以度为单位，通常为0度</li><li id="9f67" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated">排序—如何对图表进行排序:“无”、“asc”或“desc”</li><li id="1f0a" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated">颜色—为切片着色的颜色数组</li><li id="2bc1" class="kn ko iq jp b jq kw ju kx jy ky kc kz kg la kk ks kt ku kv bi translated">宽度-圆环的宽度(终点-起点半径)</li></ul><p id="5d1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意:最终的小部件可能还包含样式参数，我们将在后面介绍。</p><p id="dd93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于小部件操作，图表几乎不需要暴露什么。图表相对被动。但是出于演示的目的，让我们添加一个名为animate的动作，它将强制图表在被调用时自动显示。(第一次加载图表时会播放相同的动画。)</p><p id="ea6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于小部件事件，有两个有用的事件——一个是选择事件，它告诉我们何时通过鼠标悬停(或在移动设备上点击)选择了切片或片段；另一个是激活事件，它告诉我们用户何时点击了切片(在移动设备上，他们将点击以选择，然后再次点击以激活)。</p><p id="1fa4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然我们已经弄清楚了所有的小部件工件，让我们把它们放在一起。在Svidget中，您可以在SVG中用XML声明性地定义所有这些内容。有关这方面的更多信息，请从GitHub repo下载<a class="ae kl" href="https://github.com/joeax/svidget/blob/master/svidget.xsd" rel="noopener ugc nofollow" target="_blank"> svidget.xsd </a>模式。综上所述，小部件SVG最初看起来如下:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="4ae4" class="lk ll iq lg b gy lm ln l lo lp">&lt;svg ae kl" href="http://www.w3.org/2000/svg" rel="noopener ugc nofollow" target="_blank"&gt;http://www.w3.org/2000/svg"<br/>  xmlns:svidget="<a class="ae kl" href="http://www.svidget.org/svidget" rel="noopener ugc nofollow" target="_blank">http://www.svidget.org/svidget</a>" <br/>  width="400" height="400" viewBox="0 0 400 400" svidget:version="0.3.4"&gt;</span><span id="c70a" class="lk ll iq lg b gy lq ln l lo lp">&lt;svidget:params&gt;<br/>  &lt;svidget:param name="data" /&gt;<br/>  &lt;svidget:param name="maxSlices" /&gt;<br/>  &lt;svidget:param name="startAngle" /&gt;<br/>  &lt;svidget:param name="sort" /&gt;<br/>  &lt;svidget:param name="colors" /&gt;<br/>  &lt;svidget:param name="width" /&gt;<br/>&lt;/svidget:params&gt;</span><span id="9cec" class="lk ll iq lg b gy lq ln l lo lp">&lt;svidget:actions&gt;<br/>  &lt;svidget:action name="animate" binding="animate"&gt;<br/>    &lt;svidget:actionparam name="duration" type="number" /&gt;<br/>  &lt;/svidget:action&gt;<br/>&lt;/svidget:actions&gt;</span><span id="e6b4" class="lk ll iq lg b gy lq ln l lo lp">&lt;svidget:events&gt;<br/>  &lt;svidget:event name="sliceSelect" /&gt;<br/>  &lt;svidget:event name="sliceActivate" /&gt;<br/>&lt;/svidget:events&gt;</span></pre><p id="2098" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们布局我们的SVG。这只是一个框架，D3会处理剩下的部分。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="99eb" class="lk ll iq lg b gy lm ln l lo lp">&lt;g id="chart" transform="translate(200 200)"&gt;&lt;/g&gt;</span></pre><p id="27a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，让我们对肉进行编码——使用D3填充甜甜圈图。</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b505" class="lk ll iq lg b gy lm ln l lo lp">// set up<br/>var outerRadius = CHART_RADIUS;<br/>var innerRadius = outerRadius — _width;<br/>var widget = svidget.$; // get an instance to the current widget</span><span id="13d8" class="lk ll iq lg b gy lq ln l lo lp">// params<br/>// note: data in form of [['Item 1', 3], ['Item 2', 6]]<br/>var data = widget.param('data').value();<br/>var startAngle = widget.param('startAngle').value();<br/>var sort = widget.param('sort').value();<br/>var colors = widget.param('colors').value();</span><span id="f91b" class="lk ll iq lg b gy lq ln l lo lp">// colors<br/>var colorRange = d3.scale.ordinal().range(colors);</span><span id="4857" class="lk ll iq lg b gy lq ln l lo lp">// pie layout — for layout out arcs as a pie/donut chart<br/>var pie = d3.layout.pie()<br/> .startAngle(toRadians(startAngle))<br/> .endAngle(toRadians(startAngle + 360))<br/> .sort(sortDataFunc(sort))<br/> .value(function(d) { <br/>   return numIt(d[1]); /* second element in data inner array */ <br/> });</span><span id="eec5" class="lk ll iq lg b gy lq ln l lo lp">// the main arc object<br/>var arc = d3.svg.arc()<br/> .outerRadius(outerRadius)<br/> .innerRadius(innerRadius);</span><span id="0bfa" class="lk ll iq lg b gy lq ln l lo lp">// create chart and slices<br/>var chart = d3.select('#chart');<br/>var slices = chart.selectAll('.slice')<br/> .data(pie(data))<br/> .enter()<br/> .append('g');<br/>var paths = slices.append('path');</span><span id="caef" class="lk ll iq lg b gy lq ln l lo lp">// draw slices<br/>paths.attr('stroke', '#fff')<br/> .attr('stroke-width', 2)<br/> .attr('d', arc)<br/> .style('fill', function(d, i) { <br/>   return colorRange(i); <br/> });</span><span id="ffb5" class="lk ll iq lg b gy lq ln l lo lp">// draw labels<br/>slices.append('text')<br/> .attr('dy', '.35em')<br/> .style('text-anchor', 'middle')<br/> .attr('transform', function(d) { <br/>   return 'translate(' + arc.centroid(d) + ')'; <br/> })<br/> .text(function(d) { <br/>   d.data[0]; // d.data == ['Label', 0]<br/> });</span></pre><p id="c356" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然我们的donutChart.svg小部件文件已经完成并准备就绪，在网站上嵌入就变得容易了。只需使用HTML <object>标签，传递您想要的参数值:</object></p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="4a82" class="lk ll iq lg b gy lm ln l lo lp">&lt;object id="donutChart" role="svidget" data="path/to/donutChart.svg" type="image/svg+xml" width="400" height="400"&gt;<br/>  &lt;param name="data" value="[['banana', 7], ['apple', 6], ['cherry', 2], ['orange', 10], ['grape', 3.5]]" /&gt;<br/>  &lt;param name="maxSlices" value="-1" /&gt;<br/>  &lt;param name="startAngle" value="0" /&gt;<br/>  &lt;param name="sort" value="none" /&gt;<br/>  &lt;param name="colors" value="['#ffb244','#ed723c','#da3333','#b01111','#7a0000']" /&gt;<br/>  &lt;param name="width" value="60" /&gt;<br/>&lt;/object&gt;</span></pre><p id="95f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后的结果是:</p><figure class="lb lc ld le gt ls gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/a2e6a4351e8003ec7323e40d964533e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*czszpOJoN85I3LGb0axA7A.png"/></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk">The resulting donut chart</figcaption></figure><p id="ddde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完整的工作示例代码可以在这里找到<a class="ae kl" href="http://www.svidget.com/examples/donutchart" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="86b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我们使用D3创建了一个圆环图小部件，但是它的使用潜力远远超过了图表。事实是，像Chartist这样的图书馆做图表做得非常好。我们可以将Chartist图表包装成一个Svidget小部件，类似于我们使用D3生成图表的方式，但是对于熟练的JavaScript开发人员来说，其优势可能并不明显。但是对于其他人来说，抽象出使用复杂库D3的实现细节是非常有益的。</p><p id="3a5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有人问我，为什么要创建Svidget.js库？简单来说，它用交互式SVG解决了生产者-消费者抽象问题。在我的行业中，我们在数据中心运营的实时可视化仪表板中使用SVG小部件。消费者可以通过选择这些小部件并将它们连接到数据上来构建任何一个仪表板。相反，一个独立的制作团队可以构建通用的、可重用的小部件。这些小部件远远不止是简单的图表——它们可以代表冷却风扇、发电机、电路，甚至门。</p><p id="4998" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，任何人都可以使用Svidget让非技术人员将复杂的SVG插图嵌入到他们的网站中。</p><p id="a598" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">乔·阿格斯特是基础层的首席软件工程师。编码是我众多努力中的一项。我还写了一部科幻小说《最后的六天》(T7)，现在可以在Kindle上阅读。</p></div></div>    
</body>
</html>