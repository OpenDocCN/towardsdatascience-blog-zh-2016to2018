<html>
<head>
<title>Modelling Customer Churn When Churns Are Not Explicitly Observed, with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当没有明确观察到客户流失时，用R</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/modelling-customer-churn-when-churns-are-not-explicitly-observed-with-r-a768a1c919d5?source=collection_archive---------0-----------------------#2018-04-22">https://towardsdatascience.com/modelling-customer-churn-when-churns-are-not-explicitly-observed-with-r-a768a1c919d5?source=collection_archive---------0-----------------------#2018-04-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0840dbb7f64a4dc7c417b978a7ca866f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nNo4M2mJXLFRSUPqy0k_nw.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo credit: Pexels</figcaption></figure><p id="60ca" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">客户流失可以分为契约性或非契约性。根据取消机制的不同，它还可以分为自愿或非自愿。</p><p id="cf28" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们今天只讨论非契约性和自愿性流失。</p><p id="94b9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">非合同</strong></p><ul class=""><li id="0de0" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">顾客可以随时自由购买或不购买</li><li id="8768" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">未明确观察到流失事件</li></ul><p id="40b7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">自愿</strong></p><ul class=""><li id="c8f5" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">客户选择离开该服务</li></ul><p id="bb61" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一般来说，客户流失是一个分类问题。然而，在包括亚马逊(非prime会员)在内非合同业务中，每一次购买都可能是顾客的最后一次，或者是一长串购买中的一次。因此，非合同业务中的客户流失建模不是一个分类问题，而是一个异常检测问题。为了确定客户何时会流失或可能流失，我们需要知道他们在购买时间间隔内何时表现出异常大的变化。</p><p id="90be" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">异常检测</strong></p><p id="9dd8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">异常检测是一种用于识别不符合预期行为的异常模式(称为异常值)的技术。它在商业中有许多应用，从信用卡欺诈检测(基于“消费金额”)到系统健康监控。</p><p id="9350" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，我们使用异常检测来模拟非合同业务的客户流失。我们希望能够做出这样的声明:“十有八九，顾客X会在Y天内进行下一次购买”。如果顾客X在Y天内没有再次购买，我们知道发生这种情况的概率只有1/10，并且这种行为是异常的。</p><p id="f327" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了做到这一点，我们将需要每个客户的购买时间之间的分布。这可能很难估计，特别是如果分布是多模态的或不规则的。为了避免这一困难，我们将采用非参数方法，并使用<a class="ae lo" href="https://en.wikipedia.org/wiki/Empirical_distribution_function" rel="noopener ugc nofollow" target="_blank">经验累积分布函数</a> (ECDF)来近似每个客户的购买间隔时间分布的分位数。一旦我们有了ECDF，我们就可以接近第90个百分位数，并获得我们上面描述的性质的估计值。我们开始吧！</p><h1 id="2355" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">数据</h1><p id="8d1c" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">我们将使用来自UCI机器学习库的<a class="ae lo" href="http://archive.ics.uci.edu/ml/machine-learning-databases/00352/" rel="noopener ugc nofollow" target="_blank">在线零售数据集。</a></p><p id="635a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">加载库并读取数据:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="5ee2" class="nb lq iq mx b gy nc nd l ne nf">library(tidyverse)<br/>library(lubridate)<br/>library(XLConnect)<br/>library(dplyr)<br/>library(ggplot2)<br/>theme_set(theme_minimal())</span><span id="af01" class="nb lq iq mx b gy ng nd l ne nf">raw.data &lt;- readWorksheet(loadWorkbook("Online_Retail.xlsx"), sheet=1)<br/>data &lt;- raw.data</span></pre><p id="785b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个“总计”栏，显示每位顾客每次购物的花费。然后，我们可以为每位顾客每天的总支出创建一个新的数据框架。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="51e9" class="nb lq iq mx b gy nc nd l ne nf">data$Total &lt;- data$Quantity * data$UnitPrice</span><span id="d92d" class="nb lq iq mx b gy ng nd l ne nf">txns &lt;- data %&gt;% <br/>  mutate(CustomerID = as.factor(CustomerID),<br/>         InvoiceDate = InvoiceDate) %&gt;%<br/>  group_by(CustomerID, InvoiceNo, InvoiceDate) %&gt;% <br/>  summarise(Spend = sum(Total)) %&gt;%<br/>  ungroup() %&gt;% <br/>  filter(Spend&gt;0)</span></pre><p id="499c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">接下来，我们可以计算每个客户的购物间隔时间。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="f4a9" class="nb lq iq mx b gy nc nd l ne nf">time_between &lt;- txns %&gt;% <br/>  arrange(CustomerID, InvoiceDate) %&gt;% <br/>  group_by(CustomerID) %&gt;% <br/>  mutate(dt = as.numeric(InvoiceDate - lag(InvoiceDate), unit=  'days')) %&gt;% <br/>  ungroup() %&gt;% <br/>  na.omit()</span></pre><p id="f904" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此时，我们只对数据中至少购买了20次的客户感兴趣。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="1ba5" class="nb lq iq mx b gy nc nd l ne nf">Ntrans = txns %&gt;% <br/>  group_by(CustomerID) %&gt;% <br/>  summarise(N = n()) %&gt;%<br/>  filter(N&gt;20)</span></pre><p id="98e8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个随机抽样客户的小函数。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="e72e" class="nb lq iq mx b gy nc nd l ne nf">sample_n_groups = function(tbl, size, replace = FALSE, weight = NULL) {<br/>  grps = tbl %&gt;% groups %&gt;% lapply(as.character) %&gt;% unlist<br/>  keep = tbl %&gt;% summarise() %&gt;% ungroup() %&gt;% sample_n(size, replace, weight)<br/>  tbl %&gt;% right_join(keep, by=grps) %&gt;% group_by_(.dots = grps)<br/>}</span></pre><p id="436a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在一系列数据争论之后，我们现在可以可视化随机选择的20个客户的购买天数分布。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="3ad8" class="nb lq iq mx b gy nc nd l ne nf">ecdf_df &lt;- time_between %&gt;% group_by(CustomerID) %&gt;% arrange(dt) %&gt;% mutate(e_cdf = 1:length(dt)/length(dt))<br/>sample_users &lt;- ecdf_df %&gt;% inner_join(Ntrans) %&gt;% sample_n_groups(20)</span><span id="5ed3" class="nb lq iq mx b gy ng nd l ne nf">ggplot(data = time_between %&gt;% inner_join(Ntrans) %&gt;% filter(CustomerID %in% sample_users$CustomerID), aes(dt)) + <br/>  geom_histogram(aes(y = ..count../sum(..count..)), bins = 15) + <br/>  facet_wrap(~CustomerID) +<br/>  labs(x = 'Time Since Last Purchase (Days)',y = 'Frequency')</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nh"><img src="../Images/99a3d5eadefa7b3492224c76b69406d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jEF1XI1X2QZl9cqAFDYtJg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 1</figcaption></figure><p id="a2b7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">解释:</p><ul class=""><li id="49b3" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">大多数CustomerID 12748的购买间隔少于5天，偶尔，他(或她)的购买间隔超过5天甚至10天。</li><li id="6e29" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">CustomerID 13102是一个不经常购买的客户，他(或她)的大部分购买间隔期为5到30天。</li></ul><p id="6a59" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在计算了每个客户的ECDF后，我们将上述客户的ECDF可视化。红线代表大约90%的百分比。因此，如果ECDF在20天内越过红线，这意味着10次中有9次顾客会在20天内再次购买。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="10e0" class="nb lq iq mx b gy nc nd l ne nf">ggplot(data = ecdf_df %&gt;% inner_join(Ntrans) %&gt;% filter(CustomerID %in% sample_users$CustomerID), aes(dt,e_cdf) ) + <br/>  geom_point(size =0.5) +<br/>  geom_line() + <br/>  geom_hline(yintercept = 0.9, color = 'red') + <br/>  facet_wrap(~CustomerID) +<br/>  labs(x = 'Time Since Last Purchase (Days)')</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/25589139173f118613982e4b40e019e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xt1Jz41yM21pqz-osq2OBw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 2</figcaption></figure><p id="a1f3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个函数来计算第90个百分位数。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="c6c8" class="nb lq iq mx b gy nc nd l ne nf">getq &lt;- function(x,a = 0.9){<br/>  if(a&gt;1|a&lt;0){<br/>    print('Check your quantile')<br/>  }<br/>  X &lt;- sort(x)<br/>  e_cdf &lt;- 1:length(X) / length(X)<br/>  aprx = approx(e_cdf, X, xout = c(0.9))<br/>  return(aprx$y)<br/>}</span><span id="5329" class="nb lq iq mx b gy ng nd l ne nf">percentiles = time_between %&gt;% <br/>  inner_join(Ntrans) %&gt;% <br/>  filter(N&gt;5) %&gt;% <br/>  group_by(CustomerID) %&gt;% <br/>  summarise(percentile.90= getq(dt)) %&gt;% <br/>  arrange(percentile.90)</span></pre><p id="3009" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">查看CustomerID 12748:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="fc50" class="nb lq iq mx b gy nc nd l ne nf">percentiles[ which(percentiles$CustomerID==12748), ]</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/8a1fd164683fe03207bf410c3bb2ebb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/1*hGGFwIlMIn-XhdlYsi6qlQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 3</figcaption></figure><p id="21d9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该模型告诉我们:10次中有9次，CustomerID 12748将在4.74天内进行另一次购买，如果CustomerID 12748在4.74天内没有进行另一次购买，我们知道这种情况发生的概率只有1/10，并且这种行为是异常的。此时，我们知道CustomerID 12748开始“反常地”行动。</p><p id="d7bd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们快速浏览一下CustomerID 12748的购买历史，看看我们的模型是否有意义:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="b9b3" class="nb lq iq mx b gy nc nd l ne nf">txns[ which(txns$CustomerID==12748), ]</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/3f3d8e38792704e378d4c667038dea01.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*wv27G1iz4GRuWdOZjumK5w.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 4</figcaption></figure><p id="fe83" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">CustomerID 12748的大部分购买发生在1到4天内。如果他(或她)在4.74天内没有再次购买，我们应该担心，这是有道理的。</p><p id="a835" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">查看CustomerID 13102:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="804f" class="nb lq iq mx b gy nc nd l ne nf">percentiles[ which(percentiles$CustomerID==13102), ]</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/ddaaeb238dea07e09361fba513aa81c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:468/format:webp/1*rwsofsdmo5sLyBlFMI0LeQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 5</figcaption></figure><p id="0b3d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该模型告诉我们:10次中有9次，CustomerID 13102将在31.6天内进行另一次购买，如果CustomerID 13102在31.6天内没有进行另一次购买，我们知道这种情况发生的概率只有1/10，并且这种行为是异常的。此时，我们知道CustomerID 13102开始“反常地”行动。</p><p id="6838" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">同样，我们快速浏览了CustomerID 13102的购买历史，以了解我们的模型是否有意义:</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="e396" class="nb lq iq mx b gy nc nd l ne nf">txns[ which(txns$CustomerID==13102), ]</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/717afcfe69e60507a986a70154de8fc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*Kt79O4relHipTLPX-JGHOQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 6</figcaption></figure><p id="039e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">通过查看CustomerID 13102的购买历史，我们同意该模型！</p><p id="29ed" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">给你！我们现在知道了每个客户开始“反常”行为的时间点。</p><p id="8a43" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">非合同业务的客户流失非常不同。挑战在于定义一个清晰的客户流失事件，这意味着采用不同的方法来模拟客户流失。当一个顾客有所动摇时，他(或她)的购买间隔时间是异常的长，所以我们应该知道“异常”对每个顾客意味着什么。使用ECDF，我们已经以非参数的方式估计了每个顾客在购买时间分布之间的90个百分点。通过检查客户最后一次购买的时间，如果从那时到现在的时间接近第90个百分点，那么我们可以称他们为“有流失风险”,并采取适当的措施来防止他们流失。最重要的是，随着更多的数据，我们的方法将变得越来越好，因为<a class="ae lo" href="https://stats.stackexchange.com/questions/239937/empirical-cdf-vs-cdf/239969" rel="noopener ugc nofollow" target="_blank">ECDF将收敛于人口</a>的基本累积分布函数(CDF)。</p><p id="d3ba" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此外，当我们实现上述模型时，我们可能要考虑季节性。</p><p id="e6b0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">源代码可以在<a class="ae lo" href="https://github.com/susanli2016/Data-Analysis-with-R/blob/master/Retail%20churn.Rmd" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。我期待听到任何问题。</p><p id="e85d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">参考资料:</p><p id="a5e9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae lo" href="https://www.r-bloggers.com/exploratory-data-analysis-conceptual-foundations-of-empirical-cumulative-distribution-functions/" rel="noopener ugc nofollow" target="_blank">探索性数据分析:经验累积分布函数的概念基础</a></p></div></div>    
</body>
</html>