<html>
<head>
<title>Time-Series Calendar Heatmaps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">时序日历热图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/time-series-calendar-heatmaps-9f576578fcfe?source=collection_archive---------12-----------------------#2018-12-26">https://towardsdatascience.com/time-series-calendar-heatmaps-9f576578fcfe?source=collection_archive---------12-----------------------#2018-12-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bdff" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一种可视化时间序列数据的新方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2bfb20619161e45d2f77e287c96b96f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aAnh34x6SNiijoMhz2da1Q.jpeg"/></div></div></figure><h2 id="b370" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">介绍</h2><p id="164d" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">时间序列是按时间顺序编制索引的一系列数据。时间顺序可以用天、周、月或年来表示。可视化时间序列数据的最常见方法是使用简单的折线图，其中横轴绘制时间增量，纵轴绘制所测量的变量。可以使用<code class="fe mg mh mi mj b">ggplot2</code>中的<code class="fe mg mh mi mj b">geom_line()</code>或简单使用<code class="fe mg mh mi mj b">Base R</code>中的<code class="fe mg mh mi mj b">plot()</code>功能来实现可视化。</p><p id="8a12" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv la mm lx ly le mn ma mb li mo md me mf ij bi translated">在本教程中，我将介绍一个名为<strong class="lp ir">时序日历热图</strong>的新工具来可视化时序数据。我们将看看如何使用<code class="fe mg mh mi mj b">ggplot2</code>绘制时间序列日历热图。我们还将探索由 Paul Bleicher 编写的<code class="fe mg mh mi mj b">calendarHeat()</code>函数(在 GPL 许可下作为开源发布),它提供了一种创建可视化的简单方法。</p><h2 id="527b" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">动机</h2><p id="a3db" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">如果你曾经去过 GitHub，你肯定会偶然发现下面的图表，它显示了一个用户在过去一年中所做的贡献。瓷砖的颜色代表贡献的数量(如图表右下角的图例所述)。在这里，日历热图提供了一种直观的方式，在类似日历的视图中直观地显示用户一年中所做的提交数量，从而很容易识别日常模式或异常情况。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/39c953cab87c8c4e07493269d9f8f3f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1nCOi8PYnrX8LDCWA3Ua2w.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Heatmap from Github</figcaption></figure><p id="6866" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv la mm lx ly le mn ma mb li mo md me mf ij bi translated">另一个很好的例子可以在下面这篇由《华尔街日报》发表的文章中找到，这篇文章显示了 70 年来美国所有 50 个州的感染人数。</p><p id="a081" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv la mm lx ly le mn ma mb li mo md me mf ij bi translated"><a class="ae mu" href="http://graphics.wsj.com/infectious-diseases-and-vaccines/" rel="noopener ugc nofollow" target="_blank">http://graphics.wsj.com/infectious-diseases-and-vaccines/</a></p><p id="826e" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv la mm lx ly le mn ma mb li mo md me mf ij bi translated">在这里，日历热图可以很容易地识别各种疾病感染人数的年度模式。</p><h2 id="25ff" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">个案研究</h2><p id="eecd" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">为了说明日历热图的使用，我们将可视化亚马逊过去 5 年的股票价格(NASDAQ: AMZN)。我们将关注调整后的收盘价，该收盘价将通过<code class="fe mg mh mi mj b">tidyquant</code>包获得。</p><h2 id="8b09" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">包装</h2><p id="9ff7" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">我们将安装并导入<code class="fe mg mh mi mj b">tidyquant</code>包来获取亚马逊的股票价格。我们还将安装并导入<code class="fe mg mh mi mj b">ggplot2</code>来执行可视化。<code class="fe mg mh mi mj b">calendarHeat()</code>的 R 代码可以通过 Paul Bleicher 的 Github 页面下载。</p><pre class="kg kh ki kj gt mv mj mw mx aw my bi"><span id="d880" class="kr ks iq mj b gy mz na l nb nc"><em class="nd"># install tidyquant <br/></em>install.packages('tidyquant', repos = "http://cran.us.r-project.org")<br/>library(tidyquant) </span><span id="6e09" class="kr ks iq mj b gy ne na l nb nc"><em class="nd">#install ggplot2 <br/></em>install.packages("ggplot2", repos = "http://cran.us.r-project.org") library(ggplot2) </span><span id="3276" class="kr ks iq mj b gy ne na l nb nc"><em class="nd">#Load the function to the local through Paul Bleicher's GitHub page<br/></em>source("https://raw.githubusercontent.com/iascchen/VisHealth/master/R/calendarHeat.R")</span></pre><h2 id="65d8" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">加载数据</h2><pre class="kg kh ki kj gt mv mj mw mx aw my bi"><span id="ba23" class="kr ks iq mj b gy mz na l nb nc">amznStock = as.data.frame(tidyquant::tq_get(c("AMZN"),get="stock.prices"))<em class="nd"> # get data using tidyquant </em><br/>amznStock = amznStock[year(amznStock$date) &gt; 2012, ]<em class="nd"> # Using data only after 2012</em>Using ggplot2</span></pre><h2 id="2979" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">使用</strong>T10】</h2><p id="755b" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">使用<code class="fe mg mh mi mj b">ggplot2</code>创建日历热图的过程有些麻烦。在制作热图之前，我们需要将数据整理成正确的形状。下面的代码列出了如何使用<code class="fe mg mh mi mj b">ggplot2</code>管理创建日历热图的数据的步骤。</p><pre class="kg kh ki kj gt mv mj mw mx aw my bi"><span id="36f1" class="kr ks iq mj b gy mz na l nb nc">library(plyr)<br/>library(plotly)</span><span id="c996" class="kr ks iq mj b gy ne na l nb nc">amznStock$weekday = as.POSIXlt(amznStock$date)$wday <em class="nd">#finding the day no. of the week</em></span><span id="6d4d" class="kr ks iq mj b gy ne na l nb nc">amznStock$weekdayf&lt;-factor(amznStock$weekday,levels=rev(1:7),labels=rev(c("Mon","Tue","Wed","Thu","Fri","Sat","Sun")),ordered=TRUE) <em class="nd">#converting the day no. to factor </em></span><span id="76f9" class="kr ks iq mj b gy ne na l nb nc">amznStock$monthf&lt;-factor(month(amznStock$date),levels=as.character(1:12),labels=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"),ordered=TRUE) <em class="nd"># finding the month </em></span><span id="f971" class="kr ks iq mj b gy ne na l nb nc">amznStock$yearmonth&lt;- factor(as.yearmon(amznStock$date)) <em class="nd">#finding the year and the month from the date. Eg: Nov 2018 </em></span><span id="af3b" class="kr ks iq mj b gy ne na l nb nc">amznStock$week &lt;- as.numeric(format(amznStock$date,"%W")) #finding the week of the year for each date </span><span id="e077" class="kr ks iq mj b gy ne na l nb nc">amznStock&lt;-ddply(amznStock,.(yearmonth),transform,monthweek=1+week-min(week)) <em class="nd">#normalizing the week to start at 1 for every month </em></span><span id="0038" class="kr ks iq mj b gy ne na l nb nc">p &lt;- ggplot(amznStock, aes(monthweek, weekdayf, fill = amznStock$adjusted)) + geom_tile(colour = "white") + facet_grid(year(amznStock$date)~monthf) + scale_fill_gradient(low="red", high="green") + xlab("Week of Month") + ylab("") + ggtitle("Time-Series Calendar Heatmap: AMZN Stock Prices") + labs(fill = "Price") </span><span id="8e6e" class="kr ks iq mj b gy ne na l nb nc">p</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/b0c6f30095ef80a9579d0fb437f20901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IxIgXAZVcyOJZUv6qyj5bw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Calendar Heatmap using <code class="fe mg mh mi mj b">ggplot2</code></figcaption></figure><h2 id="3540" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">使用<code class="fe mg mh mi mj b"> calendarHeat()</code></h2><p id="3f37" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated"><code class="fe mg mh mi mj b">calendarHeat()</code>使流程变得更加简单。我们只需要调用函数并指定以下五个参数。</p><ul class=""><li id="0ac7" class="ng nh iq lp b lq mk lt ml la ni le nj li nk mf nl nm nn no bi translated"><code class="fe mg mh mi mj b">date</code>:需要绘制数据的日期。</li><li id="b0ca" class="ng nh iq lp b lq np lt nq la nr le ns li nt mf nl nm nn no bi translated"><code class="fe mg mh mi mj b">values</code>:与这些日期相关联的值。</li><li id="4bcf" class="ng nh iq lp b lq np lt nq la nr le ns li nt mf nl nm nn no bi translated"><code class="fe mg mh mi mj b">color</code>:调色板。默认为 r2g(红转绿)。其他预定义选项有 r2b(红到蓝)和 w2b(白到蓝)。您可以通过定义如下所示的向量来创建自己的调色板。</li><li id="8133" class="ng nh iq lp b lq np lt nq la nr le ns li nt mf nl nm nn no bi translated"><code class="fe mg mh mi mj b">ncolors</code>:热图的颜色数量</li><li id="9670" class="ng nh iq lp b lq np lt nq la nr le ns li nt mf nl nm nn no bi translated"><code class="fe mg mh mi mj b">varname</code>:图表标题</li></ul><pre class="kg kh ki kj gt mv mj mw mx aw my bi"><span id="b666" class="kr ks iq mj b gy mz na l nb nc">r2g &lt;- c("#D61818", "#FFAE63", "#FFFFBD", "#B5E384") calendarHeat(amznStock$date, amznStock$adjusted, ncolors = 99, color = "r2g", varname="AMZN Adjusted Close")</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/7dfb37b964ce47654088681497e64447.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-KZqY-HFtIR5FMuSezsjqQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Calendar Heatmap using calendarHeat()</figcaption></figure><h2 id="76ec" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">何时使用<code class="fe mg mh mi mj b">ggplot2?</code>中的<code class="fe mg mh mi mj b">calendarHeat()</code> v/s <code class="fe mg mh mi mj b">geom_tile</code></h2><p id="a100" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated"><code class="fe mg mh mi mj b">calendarHeat()</code>是一个预定义的函数，因此它在如何修改图形方面提供的灵活性较小。为了用除了在<code class="fe mg mh mi mj b">calendarHeat()</code>函数中指定的五个参数之外的其他方式更新数字，我们需要修改底层代码。<code class="fe mg mh mi mj b">ggplot2</code>另一方面提供了灵活性，因为我们从头开始构建可视化。</p><p id="1eb1" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv la mm lx ly le mn ma mb li mo md me mf ij bi translated">此外，<code class="fe mg mh mi mj b">ggplotly</code>可以与<code class="fe mg mh mi mj b">ggplot2</code>图表集成，使其更具交互性。例如，通过使用<code class="fe mg mh mi mj b">ggplotly</code>我们将能够计算每天的价格。<code class="fe mg mh mi mj b">calendarHeat()</code>另一方面，不能与<code class="fe mg mh mi mj b">ggplotly</code>集成(不确定是否有现有的包可以帮助实现相同的功能)。</p><p id="a116" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv la mm lx ly le mn ma mb li mo md me mf ij bi translated">说到方便，<code class="fe mg mh mi mj b">calendarHeat()</code>提供了一种更简单的方法来构建图表。我们只需要调用一个函数，一个相对标准的数据集就可以很容易地可视化，而不需要做太多的数据筛选。</p><h2 id="18e9" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">什么时候应该使用日历热图？</h2><p id="b9b4" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">当“每日值”或“星期几”值很重要时，日历热图很有用。如果我们想查看全年的每日数值，那么日历热图特别有用。</p><p id="5e97" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv la mm lx ly le mn ma mb li mo md me mf ij bi translated">另一方面，如果我们想看到一个趋势(例如:季节性、形状、平稳性等。)，日历热图帮助不大。这些也不能描绘月度或年度趋势。如果我们希望看到数据的总体趋势，那么简单的折线图是更好的方法。</p><h2 id="d8e6" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">参考</h2><p id="67d2" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated"><a class="ae mu" href="https://www.r-bloggers.com/ggplot2-time-series-heatmaps" rel="noopener ugc nofollow" target="_blank">https://www.r-bloggers.com/ggplot2-time-series-heatmaps</a>、<a class="ae mu" href="https://www.rdocumentation.org/packages/iClick/versions/1.4/topics/calendarHeat" rel="noopener ugc nofollow" target="_blank">https://www . rdocumentation . org/packages/iClick/versions/1.4/topics/calendar heat</a>、<a class="ae mu" href="https://github.com/iascchen/VisHealth/blob/master/R/calendarHeat.R" rel="noopener ugc nofollow" target="_blank">https://github . com/iascchen/vis health/blob/master/R/calendar heat。R </a>，<a class="ae mu" href="https://www.tableau.com/about/blog/2017/2/viz-variety-show-heatmaps-66330" rel="noopener ugc nofollow" target="_blank">https://www . tableau . com/about/blog/2017/2/viz-variety-show-heat maps-66330</a></p></div></div>    
</body>
</html>