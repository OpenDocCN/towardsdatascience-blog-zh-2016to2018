# 网飞和希尔:在 Excel 中构建推荐系统

> 原文：<https://towardsdatascience.com/netflix-and-chill-building-a-recommendation-system-in-excel-c69b33c914f4?source=collection_archive---------1----------------------->

![](img/6d8261120e33973cf5c24220b644ffd0.png)

## 学习狂欢背后的机器学习“魔法”

在网上无限的货架空间里，找到你想看的东西可能会让人精疲力尽。幸运的是，对抗决策疲劳是网飞的工作……他们擅长这个。太擅长了。

他们*神奇地*给你推荐最完美的电影，让你的眼睛盯着电视，他们把你的拖延症变成沙发上的周末大餐。

该死的网飞。你的秘诀是什么？你怎么这么了解我们？

![](img/a491baddca5bccbfe0f8e492b0fa79c9.png)

Netflix wins again…

这个“魔术”出奇的简单，在这个教程中，你可以下载 Excel ( *推荐*)或 Google Sheets ( *计算速度较慢)的一步一步的电子表格来揭示其中的秘密；由于兼容性*缺少 1 张图，请跟随以提高您的学习效果:

[*https://drive.google.com/open?id = 1y 4x 8h 56 ts 6m 7 axau 7 yim 0 eyxhqnuy1sz*](https://drive.google.com/open?id=1y4X8H56TS6M7AXAU7yIm0EyxhqNUy1sz)

尽管自 Netflix 奖项竞赛以来，有大量关于推荐系统的论文或视频，但大多数要么(A)太专业，初学者无法接触，要么(B)水平太高，不实用。

在这篇文章中，我们将从头开始建立一个电影推荐系统，用简单的英语解释和一步一步的公式，你可以在 Excel 中遵循。所有梯度下降推导都是手工完成的，您可以使用 Excel 下拉过滤器来微调模型的超参数，增强您的直觉。

# **您将了解到:**

*   构建帮助赢得 100 万美元网飞奖的算法版本 SVD++背后的确切步骤。
*   **机器实际上是如何学习的(梯度下降)。看着网飞了解你的电影品味，即使你从未告诉他们。**
*   **超参数调谐。**查看如何调整模型输入(学习率、L2 正则化、历元数、权重初始化)以获得更好的预测。
*   **模型评估&可视化。**了解训练数据和测试数据的区别，如何防止过拟合，看看如何可视化一个模型的特征。

在简单介绍了推荐系统之后，我将介绍下面的 4 个部分，我们将建立一个模型来预测一些好莱坞明星的电影评级。

![](img/aa14893cae1807299200230bd714026b.png)![](img/cc9b47705ee6e06c0ae1cff500788966.png)![](img/4beec47326c77fc4e9eff45dacf5124a.png)![](img/7afcd6a1a4d5ea352ac6759d219ddaf0.png)![](img/d9b21b8b9d57c80f13d733815e431407.png)

我将解释机器学习*魔法*背后的一步一步的数学，你可以跟随插入批量梯度下降中使用的公式中的实数(没有“宏”或“Excel 解算器”来隐藏细节)。

![](img/5747a4ffd6ab6658c1abea0ae06c8d31.png)![](img/661c5dd876930bc9e506259ebad81117.png)![](img/47dfca9613bf7fe4f02d1662eeb0eb92.png)

# 这是给谁的？

*   人们开始使用推荐系统
*   斋戒的学生。AI 的深度学习课程
*   对好奇心和机器学习感兴趣的人

特别感谢 Fast.AI 的[杰瑞米·霍华德](https://medium.com/u/34ab754f8c5e?source=post_page-----c69b33c914f4--------------------------------)和[瑞秋·托马斯](https://medium.com/u/ee56d0bac1b7?source=post_page-----c69b33c914f4--------------------------------)，这里的电子表格灵感来自他们[关于协同过滤](http://course.fast.ai/lessons/lesson5.html)的课程(见[代码](https://github.com/fastai/fastai/blob/master/courses/dl1/lesson5-movielens.ipynb))。他们呈现的电子表格依靠 Excel 内置的求解器在幕后进行优化计算；然而，我构建的电子表格显示了梯度下降计算的每个步骤，并允许您微调模型的超参数。

如果这些电子表格对你有帮助，请考虑通过点击下面的链接注册我的电子邮件列表，我将向你发送更多的电子表格，帮助你开始机器学习和建立神经网络。

[![](img/13edb0c235def2f62198679d848b02f8.png)](http://bit.ly/2OjiRoi)

# 推荐系统介绍

电影推荐系统可以简化为两大类:

![](img/9769fd79ba546e6357014640b44e1bcb.png)

和

![](img/256e60c76f787026fdc2d447b21e2f0a.png)

## **协同过滤(#1)**

是基于相似行为的想法。

如果罗斯和瑞秋过去也喜欢过类似的东西，那我们就来拿几部罗斯没看过的瑞秋最喜欢的电影推荐给他。把他们想象成“味觉二重身”,他们与另一个人“合作”,过滤掉互联网货架上的所有噪音。2 如果用户的评级与另一个用户的评级具有很强的相关性，并且评级可以是隐式的或显式的，则认为用户是“相似的”:

*   罗斯和瑞秋整个周末都在狂饮老友记。尽管他们都没有“竖起大拇指”，但我们很确定他们喜欢它(他们可能有点自负)。
*   直白的(*喜欢的【*)——罗斯和瑞秋都对这部剧竖起了大拇指。

有两种类型的协同过滤:邻域方法和潜在因素模型(一种矩阵分解的形式)。这篇文章的重点是一个叫做 SVD++的潜在因素模型。

## **基于内容的过滤(#2)**

是基于扮演媒人的想法。

使用明确的标签(类型、演员等。)从你过去喜欢的内容中，网飞向你推荐具有相似标签的新内容。

## 一百万美元的赢家是…

当数据集足够大时，协同过滤(CF)无疑是电影推荐器中基于内容的过滤的赢家。

虽然这两个大类之间有无数的混合和变化，但当 CF 模型足够好时，事实证明添加元数据根本没有帮助，这有点令人惊讶。

但这是为什么呢？

![](img/98930e47724cdf0880c8518a980d9b07.png)

人们说他们喜欢的东西(用户偏好、调查等)之间有很大差距。)和他们的行为。最好是让人们的观影行为自己说话。(*提示:为了获得更好的网飞推荐，在网飞上删除你的“观看活动”，点击* [*点击这里*](http://www.netflix.com/WiViewingActivity) *删除你不喜欢的项目。)*

2009 年，网飞奖给一个研究团队 100 万美元，他们开发的算法将网飞的预测准确率提高了 10%。虽然获胜的算法实际上是 100 多种算法的集合，但 SVD++(一种协作过滤)是贡献最大收益的关键算法之一，并且仍在生产中使用。

我们将要构建的 SVD++模型(“奇异值分解近似值”)类似于 Simon Funk 在 2006 年网飞竞赛开始时在一篇声名狼藉的[博客文章](http://sifter.org/~simon/journal/20061211.html)中首次提出的想法。在 SVD++取得成功之后，几乎所有的网飞参赛者都在参赛作品中使用了它。

**SVD++关键思想:**

*   **“奇异值”(电影评级)可以被“分解”或由一组隐藏的潜在因素(用户偏好和电影特征)**确定，这些因素直观地表示诸如类型、演员等事物..
*   **潜在因素可以使用梯度下降和已知的电影分级来迭代学习**。
*   **用户/电影偏见对某人的评价有贡献，也是习得的。**

简单，但功能强大。让我们开始吃吧。

![](img/aa14893cae1807299200230bd714026b.png)

# 1.1 数据

博客帖子模型使用 30 个虚构的评级(5 个用户 x 6 部电影)来简化教程。

*   为了跟进和试验这个模型，你可以在这里下载电子表格(Excel 或 Google Sheets)。

斋戒。AI lesson 根据 15 部最受关注的电影和 15 名最活跃的用户，使用了 225 个真实评级(在博客文章中很难说明)。除了虚假的“用户名”，收视率数据来自 MovieLens 。

*   查看基于快速的模型(Excel 或 Google Sheets)。AI 课，你可以在这里下载那个。
*   *注意——斋戒。人工智能模型使用 15 个纪元而不是 50 个(由于更多的数据),并且在 Google Sheets 中计算相当慢，所以推荐使用 Excel。*

# 1.2 拆分数据—培训与测试

我们将使用 25 个评分来训练我们的模型，并使用 5 个评分来测试模型的准确性。

我们的目标是建立一个对 25 个已知评级(训练数据)工作良好的系统，并且**希望**它对 5 个隐藏的(但已知的)评级(测试数据)预测良好。

如果我们有更多的数据，我们会将数据分成 3 组—训练组(~70%)、验证组(~20%)和测试组(~10%)，然后使用验证集来验证我们的模型。

# **1.3 评级预测公式**

评级预测是用户/电影特征+用户偏好+电影偏好的矩阵乘法或“点积”。

![](img/cd4df4fa16c29724bcc844adbf222c1e.png)

正式定义:

![](img/3ff2477e8206271690d9d3d7291fd520.png)

## **1.3.1 用户/电影特征**

*   直观地说，这些特征代表了诸如类型、演员、电影长度、导演、电影年份等。即使我们并不十分清楚每个特性是什么，但是在我们将它们形象化到图表上之后，我们可以直观地猜测它们可能代表什么(参见第 4 部分)。
*   为了简单起见，我使用了 3 个特性，但是实际的模型可以有 50 个、100 个或者更多。功能的数量将随着数据的复杂程度成比例增长。如果有太多的特征，模型将“过度拟合/记忆”你的训练数据，并且当它预测隐藏的(但已知的)测试评级时，它不会很好地概括。
*   如果用户对于他们的第一个特征(假设它代表“喜剧”)具有高价值，并且该电影对于这个“喜剧”特征也具有高价值，这可能导致该电影的高评级。

## **1.3.2 用户/电影偏差**

用户偏见是影评人有多苛刻或多好。如果网飞上所有电影的平均评分是 3.5，而你对所有东西的平均评分是 4.0，你就会有 0.5 的偏差。电影偏见也可以这么想。如果《泰坦尼克号》在所有用户中的平均评分为 4.25，那么它将有 0.75 的偏差(= 4.25-3.50)。

# **1.4 RMSE —评估预测精度**

RMSE =均方根误差

RMSE 是一个试图回答“平均而言，你的预测评分与实际评分相差多少颗星(1-5 颗星)”的数字。

RMSE 越低，预测越准确…

![](img/2296c8508bb8ad38cd6da6ba827bc3e6.png)

**观察:**

*   **我们只关心绝对差异**。比实际评级高 1 的预测与比实际评级低 1 的预测具有相同的误差 1。
*   **RMSE 是误差的*量级的平均值，与*绝对平均误差*不同。***在上述示例中，绝对平均误差为 0.75 (1 + 1 + 0.25 = 2.25/3 = 0.75)，但 RMSE 为 0.8292。RMSE 对大误差给予较高的权重，这在不希望出现大误差时很有用。

正式的 RMSE 定义:

![](img/a2d3aa0a8bea22e3e8451d186f949c28.png)

# 1.5 模型输入(超参数调整)

在电子表格中，有 3 个输入的下拉过滤器。您应该尝试这些输入，看看它们对您的错误有什么影响。

*   **训练历元** — 1 历元是贯穿整个数据集的 1 个训练循环
*   **学习率** —控制我们调整权重/偏差的速度
*   **L2 (lambda)惩罚因子** —这是一个帮助模型防止过度拟合或“记忆”训练数据的术语，因此它可以对看不见的测试数据进行归纳

![](img/e02909d124017c2ec3a565648f68c5e7.png)

现在，让我们来看看*魔术*，因为模型从随机权重开始，并学习最优权重。

![](img/4beec47326c77fc4e9eff45dacf5124a.png)

观看梯度下降的动作感觉就像你在观看大卫·布赖恩魔术。

*   他怎么知道我会从 52 个选项中选出那张牌？
*   等等，他真的只是漂浮起来了吗？

最后你会感到敬畏，你想知道这个魔术是如何完成的。我将分两步向你展示这个技巧，然后揭示魔术背后的数学原理。

# **2.1“挑一张牌，任意一张牌”(权重初始化)**

在训练开始时，权重被随机分配给用户/电影特征，然后算法在训练期间学习最佳权重。

为了证明我们可以随机猜测数字，然后让计算机学习最佳数字是多么“疯狂”,下面是两种权重初始化方法的比较:

1.  **简单的**——我随机选择了 0.1、0.2 和 0.3 作为用户特性，其余的都是 0.1。
2.  **“明凯何”** —一种更正式/更好的初始化方法，使用零均值和由特征数量确定的标准偏差，在高斯分布(“钟形曲线”)中随机选择权重(详情如下)

# **2.2“观看魔术”(看训练误差)**

当模型在两种方法的训练期间学习最优值时，观察 RMSE 训练误差从开始(时段 0)到结束(时段 50)发生了什么:

![](img/79fc80ea97887cab21e2258747cbbdc5.png)

如下所示，两种权重初始化方法在训练结束时收敛到类似的“误差”(0.12 对 0.17)，但“[何”](http://www.jefkine.com/deep/2016/08/08/initialization-of-deep-networks-case-of-rectifiers/)方法收敛到较低的误差更快。

**要点提示:无论我们从哪种重量开始，机器都会随着时间的推移获得良好的价值！**

![](img/7afcd6a1a4d5ea352ac6759d219ddaf0.png)

[www.excelwithml.com](http://www.excelwithml.com)

*注意:要试验其他初始权重，请转到工作表“超参数 _ 和 _ 初始 _ 权重”,并在单元格 G3-J7 和 N3-Q8 中键入您自己的值。介于-1 和 1 之间的任何权重都可以。*

要了解更多关于何的初始化，见下文；否则，跳到第 3 部分来学习学习算法背后的数学。

**何权重初始化**

*   权重=使用平均值 0 和标准差(=平方根(2/)的正态分布的随机样本。
*   用于查找电子表格中的值的 Excel 公式:=NORMINV(RAND()，0，SQRT(2/3))

![](img/cd632efe2b434f2f345cb1b8edb91fee.png)![](img/d9b21b8b9d57c80f13d733815e431407.png)

现在，是时候变得书呆子，一步一步地通过梯度下降数学。

如果你不想*真的*知道*魔法*如何工作，跳到第 4 部分。

You don’t have to be a wicked smart or need a degree in calc to understand the math.

梯度下降是在训练期间使用的迭代算法，用于更新电影特征、用户偏好和偏差的值，以获得更好的预测。

一般循环是:

**步骤 1——定义成本/损失函数，以最小化并初始化权重**

**步骤 2 —计算预测值**

**步骤 3 —计算梯度(相对于每个重量的成本变化)**

**第 4 步——在最小化成本的方向上“稍微”更新每个权重(学习率)**

**步骤 5 —重复步骤 2–4**

要跟进我们为蒂娜·菲更新的“用户功能 1 ”,请转到工作表“培训”并查看第 11–16 行。

由于我们有一个小数据集，我们将使用*批量梯度下降。*这意味着我们使用整个数据集(在我们的例子中为 1 个用户的所有电影)来训练算法，而不是像*随机梯度下降*(在我们的例子中为 1 个用户的 1 部电影)那样一次迭代 1 个样本，当你有一个大的数据集时，这样更快。

# 3.1 定义成本函数以最小化

使用下面的公式，我们的目标是找到潜在因子(矩阵 U 和 M)的值，这些值最小化 SSE(误差平方和)加上 L2 权重惩罚，以帮助模型泛化。

![](img/a7968c549e7d0639c5ab05e84a53126e.png)

下面是我们的 Excel 模型中的成本函数 calc。该计算忽略了 1/2 项，因为它们仅在梯度下降过程中使用，以使数学更容易:

![](img/8fe9b824c1dd11dc4cc475169abe46dd.png)

## **L2 正则化和过拟合:**

我们添加了权重惩罚(L2 正则化或“岭回归”)来防止潜在因素变得过高。这确保了模型不会“过度拟合”(即记忆)训练数据，因为它不会在未看过的测试电影上表现良好。

早些时候，我们使用零 L2 正则化惩罚来训练模型，并且在 50 个时期之后，RMSE 训练误差是 0.12。

但是相对于测试数据，模型的表现如何呢？

![](img/00d76ce7adbae5e63f2a2f2e482c7f6a.png)

如果我们将 L2 惩罚因子从 0.000 更改为 0.300，我们的模型将更好地概括未知的测试数据:

![](img/6c37981f269cb0c1afd3114f0d5cb4a4.png)

# 3.2.计算预测

使用随机初始权重，我们将计算蒂娜的电影预测。我们忽略*泰坦尼克号*，因为它是我们测试数据的一部分，不在我们的训练数据中。

![](img/cdcd4bf65cc08fb0f8e6eb43af7e2604.png)![](img/3ff2477e8206271690d9d3d7291fd520.png)

# 3.3.计算渐变

目标是找到相对于您正在更新的重量的误差梯度(“斜率”)。

找到梯度后，你可以“稍微”移动那个重量，因为它在梯度的相反方向“下降”,在你对每个重量都这样做后，你应该在下一个训练时期有更低的成本。

“只是一点点”是你的学习率，在你找到梯度后，在下面的步骤 3 中使用。

![](img/36e220652beaf154dbbb09cdef08db96.png)![](img/5747a4ffd6ab6658c1abea0ae06c8d31.png)![](img/f2038b95e72446087d51429d1086d4f9.png)![](img/015c9b7df10cd29452622ae461303285.png)![](img/af1700fb9a6de80b8d2c7f04676d19f8.png)

# 3.4.更新权重

![](img/9717d8a3bf67c4ee5fdef09f3794b6fa.png)

注:上述计算可在以下“培训”表的 X11-X16 单元格中找到。

![](img/235a5586347522588339a659a27d9322.png)

如果您浏览 Excel calcs，您可以看到电影功能和用户/电影偏好是如何以类似的方式更新的。

在每个训练时期之后，所有电影/用户特征和偏好被同时更新，并且训练循环重复进行。

![](img/661c5dd876930bc9e506259ebad81117.png)

既然我们已经训练了这个模型，让我们想象一下电影中的两个潜在因素来获得一些洞察力。

如果我们的模型更复杂，有 10 个、20 个或 50 多个潜在因素，我们可以使用一种称为“主成分分析(PCA)”的技术来提取最重要的特征，然后将它们可视化在图表上。

相反，我们的模型只有 3 个特征，所以我们将为电影可视化其中的 2 个，并根据电影的学习特征绘制每部电影。在绘制之后，我们可以解释每个特征“可能代表什么”

直观地说，**电影正片 1** 可以被解释为戏剧与喜剧，而**电影正片 3** 可以被视为“面向男性”与“面向女性”

![](img/2893594653b416366d1507624cfdbf92.png)

这并不完美，但却是一个合理的解释。《勇士》与其说是喜剧，不如说是剧情片，但其他的似乎也说得通。

# 摘要

电影评级可以被分解成电影向量和用户向量。一旦一个人对几部电影进行了评价(隐含地或明确地)，推荐系统将利用大众的智慧和你的评价来预测你可能喜欢的其他电影。向量(或“潜在因素”)的大小是通过反复试验确定的，并且基于数据集的大小。

我鼓励您尝试使用电子表格，看看当您更改模型的超参数时会发生什么。

# 订阅和分享

如果你喜欢这一点，并希望获得更多优秀的学习和备忘单直接发送到您的收件箱，请点击下面并输入您的电子邮件地址(它们都是免费的)。

[![](img/5de66db1646f8052c65517158a07efa7.png)](http://bit.ly/2LEyMi8)

与人分享，传播机器学习魔法的快乐:)

![](img/97dbf0620527a7eaa2124af716397a3a.png)[![](img/0654cc7ed85a7bf77f47da474e548a1f.png)](https://www.facebook.com/sharer/sharer.php?u=https%3A//towardsdatascience.com/netflix-and-chill-building-a-recommendation-system-in-excel-c69b33c914f4)[![](img/ae5e6db7eff85ed23160cdb85290cf4b.png)](https://twitter.com/home?status=%22Netflix%20and%20Chill%3A%20Building%20a%20Recommendation%20System%20in%20Excel%22%20%40ExcelwithML%20%23MachineLearning%20%23AI%20https%3A//towardsdatascience.com/netflix-and-chill-building-a-recommendation-system-in-excel-c69b33c914f4)[![](img/d3d744d29f710db18f6af2d0dbb4a5f4.png)](https://twitter.com/@ExcelwithML)