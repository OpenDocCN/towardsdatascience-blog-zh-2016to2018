<html>
<head>
<title>Named Entity Recognition and Classification with Scikit-Learn</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Scikit-Learn 进行命名实体识别和分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/named-entity-recognition-and-classification-with-scikit-learn-f05372f07ba2?source=collection_archive---------0-----------------------#2018-08-27">https://towardsdatascience.com/named-entity-recognition-and-classification-with-scikit-learn-f05372f07ba2?source=collection_archive---------0-----------------------#2018-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/f1b87c99cda954b33a5b2af422d2577b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7DkqpU3E-E9yknyw9c7vCQ.png"/></div></div></figure><div class=""/><div class=""><h2 id="abc3" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">如何使用 Scikit-Learn 的库为 NER 训练机器学习模型</h2></div><p id="dbc5" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><a class="ae lm" href="https://en.wikipedia.org/wiki/Named-entity_recognition" rel="noopener ugc nofollow" target="_blank">命名实体识别和分类</a> (NERC)是一个从非结构化文本中识别信息单元的过程，如名称，包括人、组织和位置名称，以及数字表达式，包括时间、日期、金钱和百分比表达式。目标是开发实用的和独立于领域的技术，以自动检测高精度的命名实体。</p><p id="7118" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">上周，我们给<a class="ae lm" rel="noopener" target="_blank" href="/named-entity-recognition-with-nltk-and-spacy-8c4a7d88e7da">介绍了 NLTK 和 SpaCy </a>中的命名实体识别(NER)。今天，我们更进一步——使用 Scikit-Learn 的一些库为 NER 训练机器学习模型。我们开始吧！</p><h1 id="561e" class="ln lo jb bd lp lq lr ls lt lu lv lw lx kh ly ki lz kk ma kl mb kn mc ko md me bi translated">数据</h1><p id="45d5" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">这些数据是特征工程语料库，标注有<a class="ae lm" href="https://en.wikipedia.org/wiki/Inside%E2%80%93outside%E2%80%93beginning_(tagging)" rel="noopener ugc nofollow" target="_blank"> IOB </a>和<a class="ae lm" href="https://en.wikipedia.org/wiki/Part-of-speech_tagging" rel="noopener ugc nofollow" target="_blank"> POS </a>标签，可以在<a class="ae lm" href="https://www.kaggle.com/abhinavwalia95/how-to-loading-and-fitting-dataset-to-scikit/data" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>找到。我们可以快速浏览一下前几行数据。</p><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mk"><img src="../Images/76dcb022fef830a722c64e3b90737b93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bP_mN9GaZ-6J1ssmpzdzzQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 1</figcaption></figure><p id="14eb" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">实体基本信息</strong>:</p><ul class=""><li id="60d1" class="mt mu jb ks b kt ku kw kx kz mv ld mw lh mx ll my mz na nb bi translated">地理=地理实体</li><li id="cafd" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">org =组织</li><li id="9304" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">per =人</li><li id="ac28" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">地缘政治实体</li><li id="fb9f" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">tim =时间指示器</li><li id="f002" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">艺术=艺术品</li><li id="c52e" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">eve =事件</li><li id="a659" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">自然现象</li></ul><p id="e8da" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">内部-外部-开始(标记)</strong></p><p id="d0cb" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><a class="ae lm" href="https://en.wikipedia.org/wiki/Inside%E2%80%93outside%E2%80%93beginning_(tagging)" rel="noopener ugc nofollow" target="_blank"><strong class="ks jc">IOB</strong></a><strong class="ks jc"/>(内、外、始的简称)是标记令牌的常用标记格式。</p><ul class=""><li id="46b5" class="mt mu jb ks b kt ku kw kx kz mv ld mw lh mx ll my mz na nb bi translated">标签前的 I 前缀表示标签在块中。</li><li id="79c5" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">标签前的 b 前缀表示标签是块的开始。</li><li id="cc46" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll my mz na nb bi translated">O 标记表示令牌不属于任何块(外部)。</li></ul><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="e101" class="nm lo jb ni b gy nn no l np nq">import pandas as pd<br/>import numpy as np<br/>from sklearn.feature_extraction import DictVectorizer<br/>from sklearn.feature_extraction.text import HashingVectorizer<br/>from sklearn.linear_model import Perceptron<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.linear_model import SGDClassifier<br/>from sklearn.linear_model import PassiveAggressiveClassifier<br/>from sklearn.naive_bayes import MultinomialNB<br/>from sklearn.metrics import classification_report</span></pre><p id="d4f2" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">单个计算机的内存无法容纳整个数据集，因此我们选择前 100，000 条记录，并使用<a class="ae lm" href="https://en.wikipedia.org/wiki/External_memory_algorithm" rel="noopener ugc nofollow" target="_blank">核外学习算法</a>来有效地获取和处理数据。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="a4af" class="nm lo jb ni b gy nn no l np nq">df = pd.read_csv('ner_dataset.csv', encoding = "ISO-8859-1")<br/>df = df[:100000]<br/>df.head()</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/2069cb6d4d7b730f0c1b73172caf645c.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*FdxVbqcoy-dON4HFfLScOQ.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 2</figcaption></figure><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="7a92" class="nm lo jb ni b gy nn no l np nq">df.isnull().sum()</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/1c706e9493ffb5b8c3b39e4cccef7b2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/1*dkcB-H4CBQUknbhovFOGag.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 3</figcaption></figure><h1 id="4c52" class="ln lo jb bd lp lq lr ls lt lu lv lw lx kh ly ki lz kk ma kl mb kn mc ko md me bi translated">数据预处理</h1><p id="2dbe" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">我们注意到在“句子#”列中有许多 NaN 值，我们用前面的值填充 NaN。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="1efa" class="nm lo jb ni b gy nn no l np nq">df = df.fillna(method='ffill')</span><span id="a9ad" class="nm lo jb ni b gy nt no l np nq">df['Sentence #'].nunique(), df.Word.nunique(), df.Tag.nunique()</span></pre><p id="7c93" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc"> <em class="nu"> (4544，10922，17) </em> </strong></p><p id="0871" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们有 4544 个句子，包含 10922 个独特的单词，由 17 个标签标记。</p><p id="457a" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">标签分布不均匀。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="2da0" class="nm lo jb ni b gy nn no l np nq">df.groupby('Tag').size().reset_index(name='counts')</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/f2f0a6e655368f734bdee899dfe7ef60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*kEpRnRueEzEQ5-P_uYZdtQ.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 4</figcaption></figure><p id="2442" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">以下代码使用<code class="fe nw nx ny ni b"><a class="ae lm" href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.DictVectorizer.html#sklearn.feature_extraction.DictVectorizer" rel="noopener ugc nofollow" target="_blank"><strong class="ks jc">DictVectorizer</strong></a></code> <strong class="ks jc"> </strong>将文本日期转换为向量，然后拆分为训练集和测试集。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="c32d" class="nm lo jb ni b gy nn no l np nq">X = df.drop('Tag', axis=1)<br/>v = DictVectorizer(sparse=False)<br/>X = v.fit_transform(X.to_dict('records'))<br/>y = df.Tag.values</span><span id="60a9" class="nm lo jb ni b gy nt no l np nq">classes = np.unique(y)<br/>classes = classes.tolist()</span><span id="0286" class="nm lo jb ni b gy nt no l np nq">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size = 0.33, random_state=0)<br/>X_train.shape, y_train.shape</span></pre><p id="710c" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc"> <em class="nu"> ((67000，15507)，(67000)，)</em> </strong></p><h1 id="ecb5" class="ln lo jb bd lp lq lr ls lt lu lv lw lx kh ly ki lz kk ma kl mb kn mc ko md me bi translated">核外算法</h1><p id="ae02" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">我们将尝试一些核外算法，这些算法旨在处理太大而无法放入支持<code class="fe nw nx ny ni b"><strong class="ks jc">partial_fit</strong></code> <strong class="ks jc"> </strong>方法的单个计算机内存中的数据。</p><h2 id="47bf" class="nm lo jb bd lp nz oa dn lt ob oc dp lx kz od oe lz ld of og mb lh oh oi md oj bi translated">感知器</h2><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="e50b" class="nm lo jb ni b gy nn no l np nq">per = Perceptron(verbose=10, n_jobs=-1, max_iter=5)<br/>per.partial_fit(X_train, y_train, classes)</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ok"><img src="../Images/634208d998e301005b42beab62f42b55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-BsapLE5QgedbIFoYne1g.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 5</figcaption></figure><p id="38e7" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">因为标签“O”(外部)是最常见的标签，它会使我们的结果看起来比实际好得多。因此，在评估分类指标时，我们删除了标签“O”。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="9c4f" class="nm lo jb ni b gy nn no l np nq">new_classes = classes.copy()<br/>new_classes.pop()<br/>new_classes</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/70bdf5e9d1274b820d1a47e22f68e985.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/format:webp/1*jxZjucMMkKKvz7mye0As7A.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 6</figcaption></figure><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="5caf" class="nm lo jb ni b gy nn no l np nq">print(classification_report(y_pred=per.predict(X_test), y_true=y_test, labels=new_classes))</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi om"><img src="../Images/3a9cecee9e18136495e3049bfcc8b425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DyeL0kaJ-O0c7iX54om5AA.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 7</figcaption></figure><p id="cbd7" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">带 SGD 训练的线性分类器</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="e7cd" class="nm lo jb ni b gy nn no l np nq">sgd = SGDClassifier()<br/>sgd.partial_fit(X_train, y_train, classes)</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi on"><img src="../Images/9ad75958c7574970f596fe30546f1fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kJ5hYVmwLUcGiaHi_1bqaQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 8</figcaption></figure><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="731b" class="nm lo jb ni b gy nn no l np nq">print(classification_report(y_pred=sgd.predict(X_test), y_true=y_test, labels=new_classes))</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oo"><img src="../Images/07aa54ee74f113c72620ae1367295aca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eDO2n25b88qY9sumhcOdiQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 9</figcaption></figure><p id="21d7" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">多项式模型的朴素贝叶斯分类器</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="005a" class="nm lo jb ni b gy nn no l np nq">nb = MultinomialNB(alpha=0.01)<br/>nb.partial_fit(X_train, y_train, classes)</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi op"><img src="../Images/d462ee6a9c231cfd30d269b393c16e03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yQTsXhQPGws1w9_Mqa8WCw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 10</figcaption></figure><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="b85d" class="nm lo jb ni b gy nn no l np nq">print(classification_report(y_pred=nb.predict(X_test), y_true=y_test, labels = new_classes))</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oq"><img src="../Images/36ab1b0de0247a4be398598b5914b074.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6F7y5n7_344HT8kUYFr4g.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 11</figcaption></figure><p id="ac1b" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">被动攻击分类器</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="12b9" class="nm lo jb ni b gy nn no l np nq">pa =PassiveAggressiveClassifier()<br/>pa.partial_fit(X_train, y_train, classes)</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/6022677d7a7754eb266e5ce8ce33c877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CXi2Vvlr_yZCY9YobXhkIg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 12</figcaption></figure><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="7d3f" class="nm lo jb ni b gy nn no l np nq">print(classification_report(y_pred=pa.predict(X_test), y_true=y_test, labels=new_classes))</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi os"><img src="../Images/76d3ee4f8e0f170db35ab5554f30a165.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*67Hb_9LYoLgSFk_fRJ7kqQ.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 13</figcaption></figure><p id="c98f" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">上述分类器都没有产生令人满意的结果。很明显，使用常规分类器对命名实体进行分类并不容易。</p><h1 id="7f4c" class="ln lo jb bd lp lq lr ls lt lu lv lw lx kh ly ki lz kk ma kl mb kn mc ko md me bi translated"><strong class="ak">条件随机字段</strong></h1><p id="4630" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated"><a class="ae lm" href="https://en.wikipedia.org/wiki/Conditional_random_field" rel="noopener ugc nofollow" target="_blank"> CRFs </a>通常用于标记或解析序列数据，例如自然语言处理和 CRFs 在词性标记、命名实体识别等方面的应用。</p><h2 id="f60c" class="nm lo jb bd lp nz oa dn lt ob oc dp lx kz od oe lz ld of og mb lh oh oi md oj bi translated">sklearn-crfsuite</h2><p id="8245" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated">我们将在数据集上使用 sklearn-crfsuite 训练一个用于命名实体识别的 CRF 模型。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="39ab" class="nm lo jb ni b gy nn no l np nq">import sklearn_crfsuite<br/>from sklearn_crfsuite import scorers<br/>from sklearn_crfsuite import metrics<br/>from collections import Counter</span></pre><p id="474f" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">下面的代码将检索带有词性和标签的句子。感谢<a class="ae lm" href="https://www.depends-on-the-definition.com/named-entity-recognition-conditional-random-fields-python/" rel="noopener ugc nofollow" target="_blank">托拜厄斯</a>的提示。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="e2ce" class="nm lo jb ni b gy nn no l np nq">class SentenceGetter(object):<br/>    <br/>    def __init__(self, data):<br/>        self.n_sent = 1<br/>        self.data = data<br/>        self.empty = False<br/>        agg_func = lambda s: [(w, p, t) for w, p, t in zip(s['Word'].values.tolist(), <br/>                                                           s['POS'].values.tolist(), <br/>                                                           s['Tag'].values.tolist())]<br/>        self.grouped = self.data.groupby('Sentence #').apply(agg_func)<br/>        self.sentences = [s for s in self.grouped]<br/>        <br/>    def get_next(self):<br/>        try: <br/>            s = self.grouped['Sentence: {}'.format(self.n_sent)]<br/>            self.n_sent += 1<br/>            return s <br/>        except:<br/>            return None</span><span id="f72d" class="nm lo jb ni b gy nt no l np nq">getter = SentenceGetter(df)<br/>sentences = getter.sentences</span></pre><p id="bdb5" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">特征提取</strong></p><p id="c3d0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">接下来，我们提取更多的特征(单词部分、简化的 POS 标签、下方/标题/上方标志、附近单词的特征)，并将其转换为<code class="fe nw nx ny ni b"><strong class="ks jc">sklearn-crfsuite</strong></code>格式——每个句子都应转换为一个字典列表。以下代码摘自<a class="ae lm" href="https://sklearn-crfsuite.readthedocs.io/en/latest/tutorial.html" rel="noopener ugc nofollow" target="_blank"> sklearn-crfsuites 官方网站</a>。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="93c5" class="nm lo jb ni b gy nn no l np nq">def word2features(sent, i):<br/>    word = sent[i][0]<br/>    postag = sent[i][1]<br/>    <br/>    features = {<br/>        'bias': 1.0, <br/>        'word.lower()': word.lower(), <br/>        'word[-3:]': word[-3:],<br/>        'word[-2:]': word[-2:],<br/>        'word.isupper()': word.isupper(),<br/>        'word.istitle()': word.istitle(),<br/>        'word.isdigit()': word.isdigit(),<br/>        'postag': postag,<br/>        'postag[:2]': postag[:2],<br/>    }<br/>    if i &gt; 0:<br/>        word1 = sent[i-1][0]<br/>        postag1 = sent[i-1][1]<br/>        features.update({<br/>            '-1:word.lower()': word1.lower(),<br/>            '-1:word.istitle()': word1.istitle(),<br/>            '-1:word.isupper()': word1.isupper(),<br/>            '-1:postag': postag1,<br/>            '-1:postag[:2]': postag1[:2],<br/>        })<br/>    else:<br/>        features['BOS'] = True<br/>    if i &lt; len(sent)-1:<br/>        word1 = sent[i+1][0]<br/>        postag1 = sent[i+1][1]<br/>        features.update({<br/>            '+1:word.lower()': word1.lower(),<br/>            '+1:word.istitle()': word1.istitle(),<br/>            '+1:word.isupper()': word1.isupper(),<br/>            '+1:postag': postag1,<br/>            '+1:postag[:2]': postag1[:2],<br/>        })<br/>    else:<br/>        features['EOS'] = True</span><span id="c067" class="nm lo jb ni b gy nt no l np nq">return features</span><span id="7df9" class="nm lo jb ni b gy nt no l np nq">def sent2features(sent):<br/>    return [word2features(sent, i) for i in range(len(sent))]</span><span id="0ac7" class="nm lo jb ni b gy nt no l np nq">def sent2labels(sent):<br/>    return [label for token, postag, label in sent]</span><span id="e1b6" class="nm lo jb ni b gy nt no l np nq">def sent2tokens(sent):<br/>    return [token for token, postag, label in sent]</span></pre><p id="d6a7" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">拆分训练和测试集</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="7a7f" class="nm lo jb ni b gy nn no l np nq">X = [sent2features(s) for s in sentences]<br/>y = [sent2labels(s) for s in sentences]<br/>X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.33, random_state=0)</span></pre><p id="92d9" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">训练一个 CRF 模型</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="682d" class="nm lo jb ni b gy nn no l np nq">crf = sklearn_crfsuite.CRF(<br/>    algorithm='lbfgs',<br/>    c1=0.1,<br/>    c2=0.1,<br/>    max_iterations=100,<br/>    all_possible_transitions=True<br/>)<br/>crf.fit(X_train, y_train)</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ot"><img src="../Images/bc4914132f027f5cae871d920ec7acf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*77lzl34IIYrr98qruOOEKw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 14</figcaption></figure><p id="8ad0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">评估</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="081e" class="nm lo jb ni b gy nn no l np nq">y_pred = crf.predict(X_test)<br/>print(metrics.flat_classification_report(y_test, y_pred, labels = new_classes))</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ou"><img src="../Images/5a1f820ba470982a08360c4064c1c553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Y5WyOBIZfHw_x9i_sPxGg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 15</figcaption></figure><p id="2432" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">好多了。我们会坚持 sklearn-crfsuite，探索更多！</p><p id="4e51" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">我们的分类器学到了什么？</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="4409" class="nm lo jb ni b gy nn no l np nq">def print_transitions(trans_features):<br/>    for (label_from, label_to), weight in trans_features:<br/>        print("%-6s -&gt; %-7s %0.6f" % (label_from, label_to, weight))</span><span id="b925" class="nm lo jb ni b gy nt no l np nq">print("Top likely transitions:")<br/>print_transitions(Counter(crf.transition_features_).most_common(20))</span><span id="2798" class="nm lo jb ni b gy nt no l np nq">print("\nTop unlikely transitions:")<br/>print_transitions(Counter(crf.transition_features_).most_common()[-20:])</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/3538879bb76b6111fde3caf6ddef47fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/format:webp/1*vOxX1s9wcAJcYpFt_mefow.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 16</figcaption></figure><p id="a2a2" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">解释</strong>:地理实体(B-geo)的开头很可能会跟随着地理实体(I-geo)内部的令牌，但是从带有其他标签的令牌过渡到组织名称(I-org)内部会受到巨大的惩罚。</p><p id="36b6" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">检查状态特性</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="c094" class="nm lo jb ni b gy nn no l np nq">def print_state_features(state_features):<br/>    for (attr, label), weight in state_features:<br/>        print("%0.6f %-8s %s" % (weight, label, attr))</span><span id="59be" class="nm lo jb ni b gy nt no l np nq">print("Top positive:")<br/>print_state_features(Counter(crf.state_features_).most_common(30))</span><span id="56f6" class="nm lo jb ni b gy nt no l np nq">print("\nTop negative:")<br/>print_state_features(Counter(crf.state_features_).most_common()[-30:])</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/6c174afd75beeb972415fa17264e62fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*jMm1tyL5kq_N1ZSY5b1hmA.png"/></div></figure><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/037f12dcb7d07ace659a2c98f954553f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*UeZDZMyblwvcRg5-hTDLEg.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 17</figcaption></figure><p id="b996" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">观察结果</strong>:</p><p id="cd0a" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">1).该模型了解到，如果附近的单词是“day ”,那么该令牌很可能是时间指示符的一部分。</p><p id="8920" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">2).<code class="fe nw nx ny ni b"><strong class="ks jc">3.370614 B-per word.lower():president</strong></code>模型了解到令牌“president”可能在人名的开头。</p><p id="5e07" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">3).<code class="fe nw nx ny ni b"><strong class="ks jc">-3.521244 O postag:NNP</strong></code>该模型了解到专有名词通常是实体。</p><p id="7daa" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">4).<code class="fe nw nx ny ni b"><strong class="ks jc">-3.087828 O word.isdigit()</strong></code>数字可能是实体。</p><p id="1fba" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">5).<code class="fe nw nx ny ni b"><strong class="ks jc">-3.233526 O word.istitle()</strong></code>带标题的单词可能是实体。</p><h2 id="1cbd" class="nm lo jb bd lp nz oa dn lt ob oc dp lx kz od oe lz ld of og mb lh oh oi md oj bi translated">ELI5</h2><p id="b17c" class="pw-post-body-paragraph kq kr jb ks b kt mf kc kv kw mg kf ky kz mh lb lc ld mi lf lg lh mj lj lk ll ij bi translated"><a class="ae lm" href="https://eli5.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> ELI5 </a>是一个 Python 包，允许检查 sklearn_crfsuite 的重量。CRF 模型。</p><p id="6726" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">检查模型重量</strong></p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="eef6" class="nm lo jb ni b gy nn no l np nq">import eli5<br/>eli5.show_weights(crf, top=10)</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oy"><img src="../Images/7c3e3ea3255a489851e329caa88fb816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ah129oQLxIy2wrZzPCAojw.png"/></div></div></figure><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oz"><img src="../Images/82bc65bf1a65d38d5dff106b0ff75c57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JXNzsB1LgKagTQq3B6cs8w.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 18</figcaption></figure><p id="9567" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><strong class="ks jc">观察结果</strong>:</p><ol class=""><li id="ba80" class="mt mu jb ks b kt ku kw kx kz mv ld mw lh mx ll pa mz na nb bi translated">I-entity 必须跟随 B-entity 确实有道理，比如 I-geo 跟随 B-geo，I-org 跟随 B-org，I-per 跟随 B-per，等等。</li><li id="f387" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll pa mz na nb bi translated">我们还可以看到，在这个数据集中，一个组织名称后面紧跟着一个人的情况并不常见(B-org -&gt; I-per 具有很大的负权重)。</li><li id="f94e" class="mt mu jb ks b kt nc kw nd kz ne ld nf lh ng ll pa mz na nb bi translated">该模型学习了像 O -&gt; I-geo、O -&gt; I-org 和 O -&gt; I-tim 等不可能转换的大的负权重。</li></ol><p id="720d" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">为了便于阅读，我们只能检查标签的子集。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="50a3" class="nm lo jb ni b gy nn no l np nq">eli5.show_weights(crf, top=10, targets=['O', 'B-org', 'I-per'])</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pb"><img src="../Images/00502400b94e87da801c75d8a1f28ddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X4qr2uh80onsHFBBfaiX-w.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 19</figcaption></figure><p id="c308" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">或者只检查所有标签的一些特征。</p><pre class="ml mm mn mo gt nh ni nj nk aw nl bi"><span id="7f81" class="nm lo jb ni b gy nn no l np nq">eli5.show_weights(crf, top=10, feature_re='^word\.is',<br/>                  horizontal_layout=False, show=['targets'])</span></pre><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/d69390302e9a6ef16883f21757f2c19d.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/1*-7xoJ1eFal75USDe7JlelQ.png"/></div></figure><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/62f34b4555a3296c409880ecfe115823.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*n6N-7HXF-2aPYrqpJH7fog.png"/></div></figure><figure class="ml mm mn mo gt is gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/fca12f52013176cb2d99ceabe2ae44a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/1*WqkEVJ82zhV-sLHqm0iRfg.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Figure 20</figcaption></figure><p id="fd45" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">暂时就这样了。我喜欢在 sklearn-crfsuite 和 ELI5 上动手动脚，希望你也是。源代码可以在<a class="ae lm" href="https://github.com/susanli2016/NLP-with-Python/blob/master/NER_sklearn.ipynb" rel="noopener ugc nofollow" target="_blank"> Github </a>找到。祝你一周愉快！</p><p id="489f" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">参考资料:</p><p id="5a62" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><a class="ae lm" href="https://sklearn-crfsuite.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> sklearn-crfsuite </a></p><p id="b356" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated"><a class="ae lm" href="https://eli5.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> ELI5 </a></p></div></div>    
</body>
</html>