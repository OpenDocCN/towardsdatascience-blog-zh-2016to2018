<html>
<head>
<title>Using Deep Q-Learning in FIFA 18 to perfect the art of free-kicks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 FIFA 18 中使用深度 Q-Learning 完善任意球艺术</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-deep-q-learning-in-fifa-18-to-perfect-the-art-of-free-kicks-f2e4e979ee66?source=collection_archive---------3-----------------------#2018-06-03">https://towardsdatascience.com/using-deep-q-learning-in-fifa-18-to-perfect-the-art-of-free-kicks-f2e4e979ee66?source=collection_archive---------3-----------------------#2018-06-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f5bc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Tensorflow 中的一个代码教程，使用强化学习来踢任意球。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c85722cf7485c95a299f839319a21b49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*uQZE99PfVc4oMNa4GJ76Nw.gif"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Free-kicks taken by the AI bot, trained through 1000 epochs of the Reinforcement Learning process.</figcaption></figure><p id="50aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我的<a class="ae lu" rel="noopener" target="_blank" href="/building-a-deep-neural-network-to-play-fifa-18-dce54d45e675">上一篇文章</a>中，我展示了一个使用监督学习技术训练来玩国际足联游戏的人工智能机器人。通过这种方法，机器人很快学会了传球和射门等游戏的基本知识。然而，进一步改进它所需的训练数据很快变得难以收集，并且几乎没有改进，使得这种方法非常耗时。出于这个原因，我决定转向强化学习，就像几乎所有评论那篇文章的人所建议的那样！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/1de8ea2d0c5f5f052aea6dd680243695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ytpyZwJeq51sHp6fHPRG3w.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk"><a class="ae lu" rel="noopener" target="_blank" href="/building-a-deep-neural-network-to-play-fifa-18-dce54d45e675">Previous article: Building a Deep Neural Network to play FIFA 18</a></figcaption></figure><p id="d778" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我将简要介绍什么是强化学习，以及我如何将它应用到这个游戏中。实现这一点的一个大挑战是我们无法访问游戏的代码，所以我们只能利用我们在游戏屏幕上看到的东西。由于这个原因，我无法在完整的游戏中训练 AI，但可以找到一个变通办法，在练习模式中为技能游戏实现它。在本教程中，我将尝试教机器人踢 30 码的任意球，但你也可以修改它来玩其他技能游戏。让我们从理解强化学习技术和我们如何制定我们的任意球问题来适应这一技术开始。</p><h2 id="249a" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">什么是强化学习(以及深度 Q 学习)？</h2><p id="558d" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">与监督学习相反，在强化学习中，我们不需要手动标记训练数据。相反，我们与环境互动，并观察互动的结果。我们多次重复这个过程，获得正面和负面经验的例子，作为我们的训练数据。因此，我们通过实验而不是模仿来学习。</p><p id="16fc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设我们的环境处于一个特定的状态<code class="fe mu mv mw mx b">s</code>，当采取一个动作<code class="fe mu mv mw mx b">a</code>时，它会改变到状态<code class="fe mu mv mw mx b">s’</code>。对于这个特定的动作，你在环境中观察到的直接回报是<code class="fe mu mv mw mx b">r</code>。这个行动之后的任何一系列行动都会有它们自己的直接回报，直到你因为一个积极或消极的经历而停止互动。这些被称为未来奖励。因此，对于当前状态<code class="fe mu mv mw mx b">s</code>，我们将尝试估计所有可能的行动中，哪个行动将为我们带来最大的当前+未来回报，用称为 Q 函数的<code class="fe mu mv mw mx b">Q(s,a)</code>表示。这给了我们<code class="fe mu mv mw mx b">Q(s,a) = r + γ * Q(s’,a’)</code>，它表示在状态<code class="fe mu mv mw mx b">s</code>中采取行动<code class="fe mu mv mw mx b">a</code>的预期最终回报。在这里，<code class="fe mu mv mw mx b">γ</code>是一个贴现因子，用来考虑预测未来时的不确定性，因此我们希望更多地相信现在而不是未来。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/53b5869b3794f0a29019f24724b20fac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0_TNa54fr_LsLOllgIsrcw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk"><a class="ae lu" href="http://people.csail.mit.edu/hongzi/content/publications/DeepRM-HotNets16.pdf" rel="noopener ugc nofollow" target="_blank">Image Source</a></figcaption></figure><p id="cbbe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">深度 Q 学习是一种特殊类型的强化学习技术，其中 Q 函数由深度神经网络学习。给定环境的状态作为这个网络的图像输入，它试图预测所有可能行动的预期最终回报，如回归问题。具有最大预测 Q 值的行动被选为我们在环境中要采取的行动。因此得名深度 Q-Learning。</p><h2 id="cb99" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">将国际足联的任意球视为一个 Q 学习问题</h2><ul class=""><li id="5767" class="mz na it la b lb mp le mq lh nb ll nc lp nd lt ne nf ng nh bi translated"><strong class="la iu">状态:</strong>通过 MobileNet CNN 给<code class="fe mu mv mw mx b">128-dimensional flattened feature map</code>处理的游戏截图图片。</li><li id="5eaa" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu">动作:</strong>四种可能采取的动作<code class="fe mu mv mw mx b">shoot_low, shoot_high, move_left, move_right</code>。</li><li id="483a" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu">奖励:</strong>如果按下射击键，游戏内得分增加超过 200，我们就进了一个球<code class="fe mu mv mw mx b">r=+1</code>。如果我们错过了目标，得分保持不变，所以<code class="fe mu mv mw mx b">r=-1</code>。最后，<code class="fe mu mv mw mx b">r=0</code>为与向左或向右移动相关的动作。</li><li id="498f" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated"><strong class="la iu">策略:</strong>双层密集网络，以特征地图为输入，预测所有 4 个动作的最终总奖励。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/d1a2e224ec4f4644f5b218a033bf33f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ahsYUPEx52PK4kvmej1mTg.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Reinforcement Learning process for the bot interacting with the game environment. The Q-Learning Model is the heart of this process and is responsible for predicting the estimated future reward for all possible actions that the bot can take. This model is trained and updated continuously throughout this process.</figcaption></figure><p id="9da0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注:</strong>如果我们在 FIFA 的开球模式中有一个像练习模式中那样的性能表，我们可能已经能够为玩完整场比赛制定这个问题，而不是限制我们自己只罚任意球。或者我们需要访问游戏的内部代码，但我们没有。不管怎样，让我们充分利用我们所拥有的。</p><h2 id="79bf" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">结果</h2><p id="0a0f" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">虽然机器人还没有掌握所有不同种类的任意球，但它已经很好地学会了一些情况。它几乎总是在没有玩家墙的情况下击中目标，但在有玩家墙的情况下却挣扎。此外，当它在训练中没有经常遇到像不面对目标这样的情况时，它会表现得疯狂。然而，随着每个训练时期，这种行为被发现平均减少。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/c41b7a009704817bc07876d4479695fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6YYfIgKNX2DZ5Knfy1v3nw.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">The figure shows, for epoch 1 through 1000, average number of free-kicks that got converted per attempt, calculated over a moving average window of 200 attempts. So, for example, a value of 0.45 at epoch 700 means 45% of attempts got converted to a goal (on an average) around this epoch.</figcaption></figure><p id="72cc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如上图所示，训练 1000 个时代后，平均进球率平均从 30%增长到 50%。这意味着当前机器人的任意球得分约为其尝试的一半(作为参考，人类的平均得分约为 75-80%)。请注意，国际足联倾向于表现出不确定性，这使得学习非常困难。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/b07112944d0fa2ee9dbd6c3374972a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*r2CQqSdAn9s91EPMAtJ2Tg.gif"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Good examples of free kicks (model trained till 1000 epochs). The bot almost always scores in absence of the yellow player cutouts blocking the goal. In presence of the player wall, it gives mixed results.</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/fe36300c91f354bf8ca8b3534422839f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*RHvIt4rB31IIFDCXl7kAoQ.gif"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Bad examples of free kicks. In some cases like above, the bot keeps transitioning between two states by alternating between left and right actions, making it stuck in a never ending loop. Probably a weakness of Reinforcement Learning setup.</figcaption></figure><p id="e6f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">更多视频格式的结果可以在我的<a class="ae lu" href="http://youtube.com/c/DeepGamingAI" rel="noopener ugc nofollow" target="_blank"> YouTube 频道、</a>上找到，下面嵌入了视频。如果你想了解我所有的项目，请订阅我的频道。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="33b8" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">代码实现</h2><p id="bfdf" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">我们将使用深度学习的 Tensorflow (Keras)和 OCR 的 pytesseract 等工具在 python 中实现这一点。下面提供了 git 链接以及存储库描述中的需求设置说明。</p><div class="ns nt gp gr nu nv"><a href="https://github.com/ChintanTrivedi/DeepGamingAI_FIFARL" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">ChintanTrivedi/DeepGamingAI _ FIFARL</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">DeepGamingAI_FIFARL -使用强化学习玩 FIFA</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj ks nv"/></div></div></a></div><p id="8610" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">出于理解本教程的目的，我推荐下面的代码，因为为了简洁起见，已经删除了一些代码。运行 g it 时，请使用 git 的完整代码。让我们看一下代码的 4 个主要部分。</p><h2 id="da1c" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">1.与游戏环境互动</h2><p id="3101" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">我们没有任何现成的 API 可以让我们访问代码。所以，还是自己做 API 吧！我们将使用游戏的截图来观察状态，模拟按键来在游戏环境中采取行动，光学字符识别来读取我们在游戏中的奖励。在我们的 FIFA 类中有三个主要方法:<code class="fe mu mv mw mx b">observe(), act(), _get_reward()</code>和一个额外的方法<code class="fe mu mv mw mx b">is_over()</code>来检查任意球是否被罚。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok nr l"/></div></figure><h2 id="6b16" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">2.收集培训数据</h2><p id="49df" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">在整个培训过程中，我们希望存储我们所有的经验和观察到的奖励。我们将用它作为 Q-Learning 模型的训练数据。因此，对于我们采取的每一个行动，我们都将经验<code class="fe mu mv mw mx b">&lt;s, a, r, s’&gt;</code>和一个<code class="fe mu mv mw mx b">game_over</code>标志存储在一起。我们的模型将尝试学习的目标标签是每个行动的最终回报，它是我们回归问题的实数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok nr l"/></div></figure><h2 id="8965" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">3.培训过程</h2><p id="d011" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">现在，我们可以与游戏进行交互，并将我们的交互存储在内存中，让我们开始训练我们的 Q-Learning 模型。为此，我们将在<strong class="la iu">探索</strong>(在游戏中采取随机行动)和<strong class="la iu">开发</strong>(采取我们的模型预测的行动)<strong class="la iu">之间取得平衡。通过这种方式，我们可以在游戏中进行试错以获得不同的体验。参数<code class="fe mu mv mw mx b">epsilon</code>用于此目的，它是一个平衡勘探和开采的指数递减因子。起初，当我们一无所知时，我们想做更多的探索，但随着时代数量的增加和我们了解的更多，我们想做更多的开发和更少的探索。因此。<code class="fe mu mv mw mx b">epsilon</code>参数的衰减值。</strong></p><p id="537c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本教程中，由于时间和性能的限制，我只训练了<code class="fe mu mv mw mx b">1000 epochs</code>的模型，但在未来，我想把它推到至少 5000 个纪元。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok nr l"/></div></figure><h2 id="da43" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">4.模型定义和开始培训过程</h2><p id="ccce" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">Q 学习过程的核心是一个具有 ReLU 激活的 2 层密集/全连接网络。它将 128 维特征图作为输入状态，并为每个可能的动作输出 4 个 Q 值。具有最大预测 Q 值的动作是根据给定状态的网络策略要采取的期望动作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok nr l"/></div></figure><p id="41ba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是执行这段代码的起点，但你必须确保游戏 FIFA 18 在第二台显示器上以窗口模式运行，并在技能游戏:射门菜单下加载任意球练习模式。确保游戏控件与 FIFA.py 脚本中硬编码的按键同步。</p><h2 id="3819" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated">结论</h2><p id="5e6e" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">总的来说，我认为结果相当令人满意，尽管它未能达到人类的性能水平。从监督学习转换到强化学习有助于减轻收集训练数据的痛苦。如果有足够的时间探索，它在学习如何玩简单游戏等问题上表现得非常好。然而，强化设置在遇到不熟悉的情况时似乎会失败，这使我相信将其公式化为回归问题不能像在监督设置中公式化为分类问题一样外推信息。也许两者的结合可以解决这两种方法的缺点。也许在那里我们会看到为游戏构建人工智能的最佳结果。以后给我尝试的东西！</p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><h2 id="e9e0" class="lw lx it bd ly lz ma dn mb mc md dp me lh mf mg mh ll mi mj mk lp ml mm mn mo bi translated"><strong class="ak">致谢</strong></h2><p id="bf98" class="pw-post-body-paragraph ky kz it la b lb mp ju ld le mq jx lg lh mr lj lk ll ms ln lo lp mt lr ls lt im bi translated">我要感谢<a class="ae lu" href="https://medium.freecodecamp.org/deep-reinforcement-learning-where-to-start-291fb0058c01" rel="noopener ugc nofollow" target="_blank">这个</a>深度 Q-Learning 教程和<a class="ae lu" href="https://github.com/Sentdex/pygta5" rel="noopener ugc nofollow" target="_blank">这个</a> git 游戏库提供了大部分代码。除了 FIFA 的“自定义 API ”,大部分代码的主干都来自这些来源。多亏了这些家伙！</p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><p id="e040" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢您的阅读！如果你喜欢这个教程，请关注我的<a class="ae lu" href="https://medium.com/@chintan.t93" rel="noopener">媒体</a>、<a class="ae lu" href="https://github.com/ChintanTrivedi" rel="noopener ugc nofollow" target="_blank"> github </a>或者订阅我的<a class="ae lu" href="http://youtube.com/c/DeepGamingAI" rel="noopener ugc nofollow" target="_blank"> YouTube 频道</a>。</p></div></div>    
</body>
</html>