<html>
<head>
<title>Getting started with Elasticsearch in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 中的 Elasticsearch 入门</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-elasticsearch-in-python-c3598e718380?source=collection_archive---------0-----------------------#2018-06-02">https://towardsdatascience.com/getting-started-with-elasticsearch-in-python-c3598e718380?source=collection_archive---------0-----------------------#2018-06-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4dc95dded40170c84b9ee3b0f97fd279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zvPL19PUTMslrhXPODj_Og.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk"><em class="kc">Image Credit: tryolabs.com</em></figcaption></figure><p id="8495" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="lb">此贴为 Elasticsearch 7.x 更新版本</em> </strong> <a class="ae lc" href="http://blog.adnansiddiqi.me/getting-started-with-elasticsearch-7-in-python/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="lb">此处</em> </strong> </a> <strong class="kf ir"> <em class="lb">。</em> </strong></p><p id="22d7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我将讨论 Elasticsearch 以及如何将它与不同的 Python 应用程序集成。</p><h1 id="9c68" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">什么是 ElasticSearch？</h1><p id="246b" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">ElasticSearch (ES)是一个高度可用的分布式开源搜索引擎，构建在 Apache Lucene 之上。它是用 Java 构建的开源软件，因此适用于许多平台。你以 JSON 格式存储非结构化数据，这也使它成为一个 NoSQL 数据库。因此，与其他 NoSQL 数据库不同，es 还提供搜索引擎功能和其他相关功能。</p><h1 id="857a" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">弹性搜索用例</h1><p id="8a07" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">您可以将 ES 用于多种目的，下面给出了其中的几种:</p><ul class=""><li id="fbd3" class="mg mh iq kf b kg kh kk kl ko mi ks mj kw mk la ml mm mn mo bi translated">你正在运营一个提供大量动态内容的网站；无论是电子商务网站还是博客。通过实现 ES，你不仅可以为你的 web 应用提供一个强大的搜索引擎，还可以在你的应用中提供原生的自动完成功能。</li><li id="72ca" class="mg mh iq kf b kg mp kk mq ko mr ks ms kw mt la ml mm mn mo bi translated">您可以接收不同种类的日志数据，然后使用来查找趋势和统计数据。</li></ul><h1 id="1f01" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">设置和运行</h1><p id="9857" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">安装 ElasticSearch 最简单的方法就是<a class="ae lc" href="https://www.elastic.co/downloads/elasticsearch" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">下载</strong> </a>并运行可执行文件。您必须确保您使用的是 Java 7 或更高版本。</p><p id="69e5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下载后，解压并运行它的二进制文件。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="5c7c" class="nd le iq mz b gy ne nf l ng nh">elasticsearch-6.2.4 bin/elasticsearch</span></pre><p id="3302" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">滚动窗口中会有大量文本。如果你看到下面这样的东西，那么它似乎是向上的。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="a6d1" class="nd le iq mz b gy ne nf l ng nh">[2018-05-27T17:36:11,744][INFO ][o.e.h.n.Netty4HttpServerTransport] [c6hEGv4] publish_address {127.0.0.1:9200}, bound_addresses {[::1]:9200}, {127.0.0.1:9200}</span></pre><p id="7573" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，因为，眼见为实，在你的浏览器中或通过 cURL 访问 URL <code class="fe ni nj nk mz b">http://localhost:9200</code>，像下面这样的东西应该会欢迎你。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="fa04" class="nd le iq mz b gy ne nf l ng nh">{<br/>  "name" : "c6hEGv4",<br/>  "cluster_name" : "elasticsearch",<br/>  "cluster_uuid" : "HkRyTYXvSkGvkvHX2Q1-oQ",<br/>  "version" : {<br/>    "number" : "6.2.4",<br/>    "build_hash" : "ccec39f",<br/>    "build_date" : "2018-04-12T20:37:28.497551Z",<br/>    "build_snapshot" : false,<br/>    "lucene_version" : "7.2.1",<br/>    "minimum_wire_compatibility_version" : "5.6.0",<br/>    "minimum_index_compatibility_version" : "5.0.0"<br/>  },<br/>  "tagline" : "You Know, for Search"<br/>}</span></pre><p id="4969" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，在我开始用 Python 访问弹性搜索之前，让我们做一些基本的事情。正如我提到的，ES 提供了一个<a class="ae lc" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> REST API </strong> </a>，我们将使用它来执行不同的任务。</p><h1 id="dda8" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">基本示例</h1><p id="5000" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">你要做的第一件事就是创建一个索引。一切都存储在索引中。与<em class="lb">索引</em>相对应的 RDBMS 是一个<em class="lb">数据库</em>，所以不要把它与你在 RDBMS 中学到的典型索引概念相混淆。我正在使用<a class="ae lc" href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop?hl=en" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> PostMan </strong> </a>来运行 REST APIs。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/d7c753243c39d6ed585bdc569779b044.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JjYLmdVIWZQ7UlUtZlTXwQ.png"/></div></div></figure><p id="8b94" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果运行成功，您将会看到类似下面的响应。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="a807" class="nd le iq mz b gy ne nf l ng nh">{<br/>    "acknowledged": true,<br/>    "shards_acknowledged": true,<br/>    "index": "company"<br/>}</span></pre><p id="43c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们创建了一个名为<em class="lb"> company </em>的数据库。换句话说，我们创建了一个名为<em class="lb">公司</em>的<em class="lb">指数</em>。如果您从浏览器访问<code class="fe ni nj nk mz b">http://localhost:9200/company</code>，您将看到如下内容:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="55a3" class="nd le iq mz b gy ne nf l ng nh">{<br/>  "company": {<br/>    "aliases": {<br/>      <br/>    },<br/>    "mappings": {<br/>      <br/>    },<br/>    "settings": {<br/>      "index": {<br/>        "creation_date": "1527638692850",<br/>        "number_of_shards": "5",<br/>        "number_of_replicas": "1",<br/>        "uuid": "RnT-gXISSxKchyowgjZOkQ",<br/>        "version": {<br/>          "created": "6020499"<br/>        },<br/>        "provided_name": "company"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="659b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">暂时忽略<code class="fe ni nj nk mz b">mappings</code>,我们稍后会讨论它。它实际上只是为您的文档创建一个<em class="lb">模式</em>。<code class="fe ni nj nk mz b">creation_date</code>不言自明。<code class="fe ni nj nk mz b">number_of_shards</code>告知将保存该<em class="lb">索引</em>的数据的分区数量。将全部数据保存在一个磁盘上毫无意义。如果您正在运行一个由多个弹性节点组成的集群，那么整个数据将在这些节点上进行拆分。简而言之，如果有 5 个分片，那么整个数据在 5 个分片上都是可用的，ElasticSearch 集群可以为来自任何节点的请求提供服务。</p><p id="f3af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">副本讨论数据的镜像。如果你熟悉<em class="lb">主从</em>概念，那么这对你来说应该不陌生。你可以在这里 了解更多 ES 基本概念<a class="ae lc" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/_basic_concepts.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">。</strong></a></p><p id="0583" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建索引的 cURL 版本是一行程序。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="9228" class="nd le iq mz b gy ne nf l ng nh">➜  elasticsearch-6.2.4 curl -X PUT localhost:9200/company<br/>{"acknowledged":true,"shards_acknowledged":true,"index":"company"}%</span></pre><p id="9b36" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您还可以一次完成索引创建和记录插入任务。你所要做的就是以 JSON 格式传递你的记录。你可以在<em class="lb">邮差里看到类似下面的东西。</em></p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/5ecd26765d28edbac5e3945c3de9ef13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*20FLmsSlIxuiDvSFFC6-RQ.png"/></div></div></figure><p id="c166" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保将<code class="fe ni nj nk mz b">Content-Type</code>设置为<code class="fe ni nj nk mz b">application/json</code></p><p id="316b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它将在这里创建一个名为<code class="fe ni nj nk mz b">company</code>的索引，如果它不存在，然后在这里创建一个名为<em class="lb"> employees </em>的新的<em class="lb">类型</em>。Type 实际上是 RDBMS 中一个<em class="lb">表</em>的 ES 版本。</p><p id="0978" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上述请求将输出以下 JSON 结构。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="c660" class="nd le iq mz b gy ne nf l ng nh">{<br/>    "_index": "company",<br/>    "_type": "employees",<br/>    "_id": "1",<br/>    "_version": 1,<br/>    "result": "created",<br/>    "_shards": {<br/>        "total": 2,<br/>        "successful": 1,<br/>        "failed": 0<br/>    },<br/>    "_seq_no": 0,<br/>    "_primary_term": 1<br/>}</span></pre><p id="4c20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你通过<code class="fe ni nj nk mz b">/1</code>作为你的记录的 ID。但是这不是必须的。它所做的只是用值<code class="fe ni nj nk mz b">1</code>设置<code class="fe ni nj nk mz b">_id</code>字段。然后以 JSON 格式传递数据，这些数据最终将作为新记录或文档插入。如果你从浏览器访问<code class="fe ni nj nk mz b">http://localhost:9200/company/employees/1</code>，你会看到如下内容。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="b03e" class="nd le iq mz b gy ne nf l ng nh">{"_index":"company","_type":"employees","_id":"1","_version":1,"found":true,"_source":{<br/>    "name": "Adnan Siddiqi",<br/>    "occupation": "Consultant"<br/>}}</span></pre><p id="3226" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以看到实际记录和元数据。如果您愿意，您可以将请求更改为<code class="fe ni nj nk mz b">http://localhost:9200/company/employees/1/_source</code>，它将只输出记录的 JSON 结构。</p><p id="310f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">cURL 版本应该是:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="04dd" class="nd le iq mz b gy ne nf l ng nh">➜  elasticsearch-6.2.4 curl -X POST \<br/>&gt;   <a class="ae lc" href="http://localhost:9200/company/employees/1" rel="noopener ugc nofollow" target="_blank">http://localhost:9200/company/employees/1</a> \<br/>&gt;   -H 'content-type: application/json' \<br/>&gt;   -d '{<br/>quote&gt;     "name": "Adnan Siddiqi",<br/>quote&gt;     "occupation": "Consultant"<br/>quote&gt; }'<br/>{"_index":"company","_type":"employees","_id":"1","_version":1,"result":"created","_shards":{"total":2,"successful":1,"failed":0},"_seq_no":0,"_primary_term":1}%</span></pre><p id="76fe" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想更新记录，该怎么办？嗯，这很简单。你所要做的就是改变你的 JSON 记录。如下图所示:</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/7611c5b9c9ed2d193fa90b470136ab33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FteQAi_3CL3Lg4aDCQ1tyQ.png"/></div></div></figure><p id="6886" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它将生成以下输出:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="9f13" class="nd le iq mz b gy ne nf l ng nh">{<br/>    "_index": "company",<br/>    "_type": "employees",<br/>    "_id": "1",<br/>    "_version": 2,<br/>    "result": "updated",<br/>    "_shards": {<br/>        "total": 2,<br/>        "successful": 1,<br/>        "failed": 0<br/>    },<br/>    "_seq_no": 1,<br/>    "_primary_term": 1<br/>}</span></pre><p id="c37d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意<code class="fe ni nj nk mz b">_result</code>字段现在被设置为<code class="fe ni nj nk mz b">updated</code>而不是<code class="fe ni nj nk mz b">created</code></p><p id="72e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然，你也可以删除某些记录。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/51d3cbc00df5dc69b1010aee5a9d4029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GM2eUcYhN4ostmw2rzftNA.png"/></div></div></figure><p id="00bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你快疯了，或者你的女朋友/男朋友把你甩了，你可以从命令行运行<code class="fe ni nj nk mz b">curl -XDELETE localhost:9200/_all</code>烧掉整个世界。</p><p id="2628" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们做一些基本的搜索。如果运行<code class="fe ni nj nk mz b">http://localhost:9200/company/employees/_search?q=adnan</code>，它将搜索类型<code class="fe ni nj nk mz b">employees</code>下的所有字段，并返回相关记录。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="ba13" class="nd le iq mz b gy ne nf l ng nh">{<br/>  "took": 7,<br/>  "timed_out": false,<br/>  "_shards": {<br/>    "total": 5,<br/>    "successful": 5,<br/>    "skipped": 0,<br/>    "failed": 0<br/>  },<br/>  "hits": {<br/>    "total": 1,<br/>    "max_score": 0.2876821,<br/>    "hits": [<br/>      {<br/>        "_index": "company",<br/>        "_type": "employees",<br/>        "_id": "1",<br/>        "_score": 0.2876821,<br/>        "_source": {<br/>          "name": "Adnan Siddiqi",<br/>          "occupation": "Software Consultant"<br/>        }<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="b70b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ni nj nk mz b">max_score</code>字段告诉记录的相关程度，即记录的最高分。如果有多条记录，那么它会是一个不同的数字。</p><p id="b8fd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还可以通过传递字段名将搜索条件限制在某个字段。因此，<code class="fe ni nj nk mz b">http://localhost:9200/company/employees/_search?q=name:Adnan</code>将只在文档的<code class="fe ni nj nk mz b">name</code>字段中搜索。它实际上是<code class="fe ni nj nk mz b">SELECT * from table where name='Adnan'</code>的 SQL 等价物</p><p id="baa0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我只是介绍了一些基本的例子。ES 可以做很多事情，但是我将让您通过阅读文档来进一步探索它，并将切换到用 Python 访问 ES。</p><h1 id="c9f5" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">用 Python 访问 ElasticSearch</h1><p id="e17f" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">老实说，ES 的 REST APIs 已经足够好了，你可以使用<code class="fe ni nj nk mz b">requests</code>库来执行你所有的任务。尽管如此，你还是可以使用一个<a class="ae lc" href="https://elasticsearch-py.readthedocs.io/en/master/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> Python 库</strong> </a>来进行 ElasticSearch，从而专注于你的主要任务，而不是担心如何创建请求。</p><p id="b362" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过 pip 安装它，然后你可以在你的 Python 程序中访问它。</p><p id="7483" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ni nj nk mz b">pip install elasticsearch</code></p><p id="5c4d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要确保安装正确，请从命令行运行以下基本代码片段:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="6258" class="nd le iq mz b gy ne nf l ng nh">➜  elasticsearch-6.2.4 python<br/>Python 3.6.4 |Anaconda custom (64-bit)| (default, Jan 16 2018, 12:04:33) <br/>[GCC 4.2.1 Compatible Clang 4.0.1 (tags/RELEASE_401/final)] on darwin<br/>Type "help", "copyright", "credits" or "license" for more information.<br/>&gt;&gt;&gt; from elasticsearch import Elasticsearch<br/>&gt;&gt;&gt; es = Elasticsearch([{'host': 'localhost', 'port': 9200}])<br/>&gt;&gt;&gt; es<br/>&lt;Elasticsearch([{'host': 'localhost', 'port': 9200}])&gt;</span></pre><h1 id="0283" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">网页抓取和弹性搜索</h1><p id="2e84" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">我们来讨论一个使用 Elasticsearch 的小实际用例。目标是访问在线食谱，并将其存储在 Elasticsearch 中，以用于搜索和分析目的。我们将首先从<em class="lb"> Allrecipes </em>中抓取数据，并将其存储在 es 中。在 ES 的情况下，我们还将创建一个严格的模式或<em class="lb">映射</em>，这样我们可以确保数据以正确的格式和类型被索引。我只是调出沙拉食谱的清单。我们开始吧！</p><h2 id="8360" class="nd le iq bd lf np nq dn lj nr ns dp ln ko nt nu lr ks nv nw lv kw nx ny lz nz bi translated">抓取数据</h2><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="a2ad" class="nd le iq mz b gy ne nf l ng nh">import json<br/>from time import sleep</span><span id="12b4" class="nd le iq mz b gy oa nf l ng nh">import requests<br/>from bs4 import BeautifulSoup</span><span id="a7c9" class="nd le iq mz b gy oa nf l ng nh">def parse(u):<br/>    title = '-'<br/>    submit_by = '-'<br/>    description = '-'<br/>    calories = 0<br/>    ingredients = []<br/>    rec = {}</span><span id="58c9" class="nd le iq mz b gy oa nf l ng nh">try:<br/>        r = requests.get(u, headers=headers)</span><span id="9f07" class="nd le iq mz b gy oa nf l ng nh">if r.status_code == 200:<br/>            html = r.text<br/>            soup = BeautifulSoup(html, 'lxml')<br/>            # title<br/>            title_section = soup.select('.recipe-summary__h1')<br/>            # submitter<br/>            submitter_section = soup.select('.submitter__name')<br/>            # description<br/>            description_section = soup.select('.submitter__description')<br/>            # ingredients<br/>            ingredients_section = soup.select('.recipe-ingred_txt')</span><span id="8840" class="nd le iq mz b gy oa nf l ng nh"># calories<br/>            calories_section = soup.select('.calorie-count')<br/>            if calories_section:<br/>                calories = calories_section[0].text.replace('cals', '').strip()</span><span id="ca7a" class="nd le iq mz b gy oa nf l ng nh">if ingredients_section:<br/>                for ingredient in ingredients_section:<br/>                    ingredient_text = ingredient.text.strip()<br/>                    if 'Add all ingredients to list' not in ingredient_text and ingredient_text != '':<br/>                        ingredients.append({'step': ingredient.text.strip()})</span><span id="daef" class="nd le iq mz b gy oa nf l ng nh">if description_section:<br/>                description = description_section[0].text.strip().replace('"', '')</span><span id="8318" class="nd le iq mz b gy oa nf l ng nh">if submitter_section:<br/>                submit_by = submitter_section[0].text.strip()</span><span id="86a3" class="nd le iq mz b gy oa nf l ng nh">if title_section:<br/>                title = title_section[0].text</span><span id="5302" class="nd le iq mz b gy oa nf l ng nh">rec = {'title': title, 'submitter': submit_by, 'description': description, 'calories': calories,<br/>                   'ingredients': ingredients}<br/>    except Exception as ex:<br/>        print('Exception while parsing')<br/>        print(str(ex))<br/>    finally:<br/>        return json.dumps(rec)</span><span id="6872" class="nd le iq mz b gy oa nf l ng nh">if __name__ == '__main__':<br/>    headers = {<br/>        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36',<br/>        'Pragma': 'no-cache'<br/>    }<br/>    url = '<a class="ae lc" href="https://www.allrecipes.com/recipes/96/salad/'" rel="noopener ugc nofollow" target="_blank">https://www.allrecipes.com/recipes/96/salad/'</a><br/>    r = requests.get(url, headers=headers)<br/>    if r.status_code == 200:<br/>        html = r.text<br/>        soup = BeautifulSoup(html, 'lxml')<br/>        links = soup.select('.fixed-recipe-card__h3 a')<br/>        for link in links:<br/>            sleep(2)<br/>            result = parse(link['href'])<br/>            print(result)<br/>            print('=================================')</span></pre><p id="f4e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是拉取数据的基本程序。由于我们需要 JSON 格式的数据，因此，我相应地转换了它。</p><h2 id="f93a" class="nd le iq bd lf np nq dn lj nr ns dp ln ko nt nu lr ks nv nw lv kw nx ny lz nz bi translated">创建索引</h2><p id="ab62" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">好了，我们得到了想要的数据，我们必须存储它。我们要做的第一件事就是创建一个索引。姑且称之为<em class="lb">食谱</em>。这种沙拉将被称为<em class="lb"/>。我要做的另一件事是为我们的文档结构创建一个<em class="lb">映射</em>。</p><p id="2c81" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们创建索引之前，我们必须连接 ElasticSearch 服务器。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="23e6" class="nd le iq mz b gy ne nf l ng nh">import logging<br/>def connect_elasticsearch():<br/>    _es = None<br/>    _es = Elasticsearch([{'host': 'localhost', 'port': 9200}])<br/>    if _es.ping():<br/>        print('Yay Connect')<br/>    else:<br/>        print('Awww it could not connect!')<br/>    return _es</span><span id="a5da" class="nd le iq mz b gy oa nf l ng nh">if __name__ == '__main__':<br/>  logging.basicConfig(level=logging.ERROR)</span></pre><p id="e461" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ni nj nk mz b">_es.ping()</code>实际上 pings 服务器，如果连接上了就返回<code class="fe ni nj nk mz b">True</code>。我花了一段时间想出如何捕捉堆栈跟踪，<a class="ae lc" href="https://github.com/elastic/elasticsearch-py/issues/666#issuecomment-343145564" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">发现 ou </strong> </a> t 它刚刚被记录！</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="2f0f" class="nd le iq mz b gy ne nf l ng nh">def create_index(es_object, index_name='recipes'):<br/>    created = False<br/>    # index settings<br/>    settings = {<br/>        "settings": {<br/>            "number_of_shards": 1,<br/>            "number_of_replicas": 0<br/>        },<br/>        "mappings": {<br/>            "members": {<br/>                "dynamic": "strict",<br/>                "properties": {<br/>                    "title": {<br/>                        "type": "text"<br/>                    },<br/>                    "submitter": {<br/>                        "type": "text"<br/>                    },<br/>                    "description": {<br/>                        "type": "text"<br/>                    },<br/>                    "calories": {<br/>                        "type": "integer"<br/>                    },<br/>                }<br/>            }<br/>        }<br/>    }</span><span id="6039" class="nd le iq mz b gy oa nf l ng nh">try:<br/>        if not es_object.indices.exists(index_name):<br/>            # Ignore 400 means to ignore "Index Already Exist" error.<br/>            es_object.indices.create(index=index_name, ignore=400, body=settings)<br/>            print('Created Index')<br/>        created = True<br/>    except Exception as ex:<br/>        print(str(ex))<br/>    finally:<br/>        return created</span></pre><p id="6f30" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里发生了很多事情。首先，我们传递了一个包含整个文档结构映射的配置变量。<a class="ae lc" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">映射</strong> </a>是弹性图式的术语。就像我们在表中设置某些字段数据类型一样，我们在这里做一些类似的事情。检查文件，它涵盖了更多。所有字段的类型都是<code class="fe ni nj nk mz b">text</code>，但<code class="fe ni nj nk mz b">calories</code>的类型是<code class="fe ni nj nk mz b">Integer</code></p><p id="9c56" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我将确保该索引根本不存在，然后创建它。检查后不再需要参数<code class="fe ni nj nk mz b">ignore=400</code>,但如果您不检查是否存在，您可以抑制错误并覆盖现有索引。尽管这很冒险。就像覆盖数据库一样。</p><p id="44ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果索引创建成功，您可以通过访问<a class="ae lc" href="http://localhost:9200/recipes/_mappings" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">http://localhost:9200/recipes/_ mappings</strong></a>来验证它，它将打印出如下内容:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="34e8" class="nd le iq mz b gy ne nf l ng nh">{<br/>  "recipes": {<br/>    "mappings": {<br/>      "salads": {<br/>        "dynamic": "strict",<br/>        "properties": {<br/>          "calories": {<br/>            "type": "integer"<br/>          },<br/>          "description": {<br/>            "type": "text"<br/>          },<br/>          "submitter": {<br/>            "type": "text"<br/>          },<br/>          "title": {<br/>            "type": "text"<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="cc4f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过传递<code class="fe ni nj nk mz b">dynamic:strict</code>,我们迫使 Elasticsearch 对任何传入的文档进行严格检查。这里，<code class="fe ni nj nk mz b">salads</code>实际上是文档类型。<code class="fe ni nj nk mz b">Type</code>实际上是 Elasticsearch 对 RDBMS <em class="lb">表</em>的回答。</p><h2 id="00e3" class="nd le iq bd lf np nq dn lj nr ns dp ln ko nt nu lr ks nv nw lv kw nx ny lz nz bi translated">记录索引</h2><p id="c56a" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">下一步是存储实际的数据或文档。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="ea6d" class="nd le iq mz b gy ne nf l ng nh">def store_record(elastic_object, index_name, record):<br/>    try:<br/>        outcome = elastic_object.index(index=index_name, doc_type='salads', body=record)<br/>    except Exception as ex:<br/>        print('Error in indexing data')<br/>        print(str(ex))</span></pre><p id="f7d2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行它，您将受到以下欢迎:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="e9ac" class="nd le iq mz b gy ne nf l ng nh">Error in indexing data<br/>TransportError(400, 'strict_dynamic_mapping_exception', 'mapping set to strict, dynamic introduction of [ingredients] within [salads] is not allowed')</span></pre><p id="6f6a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你能猜到为什么会这样吗？由于我们没有在映射中设置<code class="fe ni nj nk mz b">ingredients</code>，ES 不允许我们存储包含<code class="fe ni nj nk mz b">ingredients</code>字段的文档。现在您知道了首先分配一个映射的好处。这样做可以避免损坏数据。现在，让我们改变映射一点，现在它将看起来如下:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="aea9" class="nd le iq mz b gy ne nf l ng nh">"mappings": {<br/>            "salads": {<br/>                "dynamic": "strict",<br/>                "properties": {<br/>                    "title": {<br/>                        "type": "text"<br/>                    },<br/>                    "submitter": {<br/>                        "type": "text"<br/>                    },<br/>                    "description": {<br/>                        "type": "text"<br/>                    },<br/>                    "calories": {<br/>                        "type": "integer"<br/>                    },<br/>                    "ingredients": {<br/>                        "type": "nested",<br/>                        "properties": {<br/>                            "step": {"type": "text"}<br/>                        }<br/>                    },<br/>                }<br/>            }<br/>        }</span></pre><p id="7a9c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们添加了类型为<code class="fe ni nj nk mz b">nested</code>的<code class="fe ni nj nk mz b">ingrdients</code>，然后分配了内部字段的数据类型。在我们的例子中是<code class="fe ni nj nk mz b">text</code></p><p id="8950" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lc" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">嵌套</strong> </a>数据类型允许您设置嵌套 JSON 对象的类型。再次运行它，您将看到以下输出:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="272f" class="nd le iq mz b gy ne nf l ng nh">{<br/>  '_index': 'recipes',<br/>  '_type': 'salads',<br/>  '_id': 'OvL7s2MBaBpTDjqIPY4m',<br/>  '_version': 1,<br/>  'result': 'created',<br/>  '_shards': {<br/>    'total': 1,<br/>    'successful': 1,<br/>    'failed': 0<br/>  },<br/>  '_seq_no': 0,<br/>  '_primary_term': 1<br/>}</span></pre><p id="b627" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于您根本没有通过<code class="fe ni nj nk mz b">_id</code>，ES 本身为存储的文档分配了一个动态 id。我用 Chrome，我用 ES data viewer 借助一个叫<a class="ae lc" href="https://chrome.google.com/webstore/detail/elasticsearch-toolbox/focdbmjgdonlpdknobfghplhmafpgfbp" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> ElasticSearch 工具箱</strong> </a>的工具查看数据。</p><figure class="mu mv mw mx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/58b0ea70eb3e7229e86cf787300a8510.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q5ewOFkeguAAAb4DbnMKFA.png"/></div></div></figure><p id="834b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们继续之前，让我们在<code class="fe ni nj nk mz b">calories</code>字段中发送一个字符串，看看情况如何。记得我们把它设定为<code class="fe ni nj nk mz b">integer</code>。建立索引时，它给出了以下错误:</p><p id="0a08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ni nj nk mz b">TransportError(400, 'mapper_parsing_exception', 'failed to parse [calories]')</code></p><p id="972b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在您知道了为文档分配映射的好处。如果不这样做，它仍然会工作，因为 Elasticsearch 会在运行时分配自己的映射。</p><h2 id="60b2" class="nd le iq bd lf np nq dn lj nr ns dp ln ko nt nu lr ks nv nw lv kw nx ny lz nz bi translated">查询记录</h2><p id="d2e5" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">现在，记录被索引，是时候根据我们的需要查询它们了。我将创建一个名为<code class="fe ni nj nk mz b">search()</code>的函数，它将显示我们的查询结果。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="1637" class="nd le iq mz b gy ne nf l ng nh">def search(es_object, index_name, search):<br/>    res = es_object.search(index=index_name, body=search)</span></pre><p id="7e07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是非常基本的。您在其中传递索引和搜索标准。让我们尝试一些查询。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="1175" class="nd le iq mz b gy ne nf l ng nh">if __name__ == '__main__':<br/>  es = connect_elasticsearch()<br/>    if es is not None:<br/>        search_object = {'query': {'match': {'calories': '102'}}}<br/>        search(es, 'recipes', json.dumps(search_object))</span></pre><p id="0f77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上述查询将返回所有<code class="fe ni nj nk mz b">calories</code>等于 102 的记录。在我们的例子中，输出将是:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="0dee" class="nd le iq mz b gy ne nf l ng nh">{'_shards': {'failed': 0, 'skipped': 0, 'successful': 1, 'total': 1},<br/> 'hits': {'hits': [{'_id': 'YkTAuGMBzBKRviZYEDdu',<br/>                    '_index': 'recipes',<br/>                    '_score': 1.0,<br/>                    '_source': {'calories': '102',<br/>                                'description': "I've been making variations of "<br/>                                               'this salad for years. I '<br/>                                               'recently learned how to '<br/>                                               'massage the kale and it makes '<br/>                                               'a huge difference. I had a '<br/>                                               'friend ask for my recipe and I '<br/>                                               "realized I don't have one. "<br/>                                               'This is my first attempt at '<br/>                                               'writing a recipe, so please '<br/>                                               'let me know how it works out! '<br/>                                               'I like to change up the '<br/>                                               'ingredients: sometimes a pear '<br/>                                               'instead of an apple, '<br/>                                               'cranberries instead of '<br/>                                               'currants, Parmesan instead of '<br/>                                               'feta, etc. Great as a side '<br/>                                               'dish or by itself the next day '<br/>                                               'for lunch!',<br/>                                'ingredients': [{'step': '1 bunch kale, large '<br/>                                                         'stems discarded, '<br/>                                                         'leaves finely '<br/>                                                         'chopped'},<br/>                                                {'step': '1/2 teaspoon salt'},<br/>                                                {'step': '1 tablespoon apple '<br/>                                                         'cider vinegar'},<br/>                                                {'step': '1 apple, diced'},<br/>                                                {'step': '1/3 cup feta cheese'},<br/>                                                {'step': '1/4 cup currants'},<br/>                                                {'step': '1/4 cup toasted pine '<br/>                                                         'nuts'}],<br/>                                'submitter': 'Leslie',<br/>                                'title': 'Kale and Feta Salad'},<br/>                    '_type': 'salads'}],<br/>          'max_score': 1.0,<br/>          'total': 1},<br/> 'timed_out': False,<br/> 'took': 2}</span></pre><p id="becb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想获得大于 20 的记录呢？</p><p id="52c7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ni nj nk mz b">search_object = {'_source': ['title'], 'query': {'range': {'calories': {'gte': 20}}}}</code></p><p id="c5d1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您还可以指定要返回的列或字段。上述查询将返回卡路里大于 20 的所有记录。此外，它将只在<code class="fe ni nj nk mz b">_source</code>下显示<code class="fe ni nj nk mz b">title</code>字段。</p><h1 id="948c" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">结论</h1><p id="6202" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">Elasticsearch 是一款功能强大的工具，通过提供强大的功能来返回最准确的结果集，可以帮助您搜索现有或新的应用程序。我刚刚谈到了它的要点。一定要阅读文档，熟悉这个强大的工具。尤其是模糊搜索功能相当牛逼。如果有机会，我会在以后的帖子中讨论查询 DSL。</p><p id="ca35" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像往常一样，代码可以在<a class="ae lc" href="https://github.com/kadnan/Python-Elasticsearch" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> Github </strong> </a>上获得。</p><p id="eb18" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">本文原载</em> <a class="ae lc" href="http://blog.adnansiddiqi.me/getting-started-with-elasticsearch-in-python/" rel="noopener ugc nofollow" target="_blank"> <em class="lb">这里</em> </a> <em class="lb">。</em></p><p id="c74e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="lb">点击</em> </strong> <a class="ae lc" href="http://eepurl.com/TZynf" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> <em class="lb">此处</em> </strong> </a> <strong class="kf ir"> <em class="lb">订阅我的简讯以备日后发帖。</em> </strong></p></div></div>    
</body>
</html>