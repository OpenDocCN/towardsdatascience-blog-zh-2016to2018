<html>
<head>
<title>Python PyPI stats in BigQuery: Reclustered</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery 中的 Python PyPI stats:重新集群</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-pypi-stats-in-bigquery-reclustered-d80e583e1bfe?source=collection_archive---------25-----------------------#2018-11-02">https://towardsdatascience.com/python-pypi-stats-in-bigquery-reclustered-d80e583e1bfe?source=collection_archive---------25-----------------------#2018-11-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/6c09173c8851aa1f21ba45ce1c539163.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OoMkOAxeMgaOPYVT_uV2Ug.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Top growing 2018 Python packages (<a class="ae jd" href="https://github.com/fhoffa/code_snippets/blob/master/pypi/top_packages_2018.sql" rel="noopener ugc nofollow" target="_blank">arbitrary</a> selection and highlights)</figcaption></figure><div class=""/><div class=""><h2 id="d9b1" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">让我们深入研究 Python 安装活动的原始日志。在这篇文章中，我们将看到如何测量一个包的流行度，哪个 Python 版本使用它，以及如何充分利用我们的查询。</h2></div><p id="a82b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Python 软件基金会为 Python 包索引中的每次下载提供原始元数据，包括从<code class="fe lr ls lt lu b">pip install</code>开始的活动。现在，任何人都可以使用他们的<a class="ae jd" href="https://cloud.google.com/bigquery/docs/sandbox" rel="noopener ugc nofollow" target="_blank">免费的每月万亿字节的 BigQuery 分析</a>来把握 Python 社区的脉搏，或者只是跟随他们喜欢的项目的趋势。这也是库作者决定他们应该支持什么平台的一个很好的工具。</p><p id="dc0a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以直接从来源阅读更多关于它的信息<a class="ae jd" href="https://packaging.python.org/guides/analyzing-pypi-package-downloads/" rel="noopener ugc nofollow" target="_blank">:</a></p><div class="ip iq gp gr ir lv"><a href="https://packaging.python.org/guides/analyzing-pypi-package-downloads/" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd jh gy z fp ma fr fs mb fu fw jf bi translated">分析 PyPI 包下载——Python 打包用户指南</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">本节将介绍如何使用 PyPI 包数据集来了解关于托管的一个(或多个)包的下载的更多信息…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">packaging.python.org</p></div></div></div></a></div><p id="2940" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，如果我们想检查 PySpark 自从<a class="me mf ep" href="https://medium.com/u/5e502786e0a2?source=post_page-----d80e583e1bfe--------------------------------" rel="noopener" target="_blank">holden karau</a>T9】推出以来的受欢迎程度，我们可以这样做:</p><pre class="mg mh mi mj gt mk lu ml mm aw mn bi"><span id="00a7" class="mo mp jg lu b gy mq mr l ms mt">SELECT TIMESTAMP_TRUNC(timestamp, WEEK) week<br/>  , REGEXP_EXTRACT(details.python, r'^\d*\.\d*') python<br/>  , COUNT(*) downloads<br/>FROM `the-psf.pypi.downloads2017*`<br/>WHERE file.project='pyspark'<br/>GROUP BY week, python<br/>ORDER BY week</span><span id="d90d" class="mo mp jg lu b gy mu mr l ms mt">8.4 sec elapsed, 200.88 GB processed # find improvements below</span></pre><figure class="mg mh mi mj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mv"><img src="../Images/2f1723a70c513a1ec8a77ee2bb0baff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JwvPTvQLgCpkWdpPJx5X2A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">PySpark downloads during 2017. Something seems weird.</figcaption></figure><p id="5a44" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在 10 月至 11 月期间，您可以看到一些奇怪的事情发生:Python 3.6 的下载量激增。谁干的？我们不知道——但是使用 BigQuery，我们可以自由地过滤掉这种可疑的活动，以便更好地了解情况:</p><pre class="mg mh mi mj gt mk lu ml mm aw mn bi"><span id="452f" class="mo mp jg lu b gy mq mr l ms mt">SELECT TIMESTAMP_TRUNC(timestamp, WEEK) week<br/>  , REGEXP_EXTRACT(details.python, r'^\d*\.\d*') python<br/>  , COUNT(*) downloads<br/>FROM `the-psf.pypi.downloads2017*`<br/>WHERE file.project='pyspark'<br/>GROUP BY week, python<br/>HAVING python != '3.6' AND week&lt;'2017-12-30'<br/>ORDER BY week</span><span id="ccba" class="mo mp jg lu b gy mu mr l ms mt">9.0 sec elapsed, 200.88 GB processed # find improvements below</span></pre><figure class="mg mh mi mj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mw"><img src="../Images/e1ebfc093e935d2491f92c325f34cfa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E5UUo2c7pZYFCrV70vf2OQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">PySpark downloads during 2017, excluding Python 3.6.</figcaption></figure><p id="b651" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在这看起来更好了:一旦我们排除 Python 3.6，我们会看到 PySpark 的健康采用曲线——由 Python 2.7 安装所主导。</p><p id="1c9b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这表明，获得原始数据比仅仅预先汇总数据更能让我们的数据更有洞察力。您可能已经注意到，我们每次都必须查询 200GB 的数据——很快就耗尽了我们每月的 1tb 免费查询量。</p><p id="353b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们利用<a class="ae jd" href="https://medium.com/google-cloud/bigquery-optimized-cluster-your-tables-65e2f684594b" rel="noopener">集群表</a>的能力来改进这一点。</p><h1 id="88e1" class="mx mp jg bd my mz na nb nc nd ne nf ng km nh kn ni kp nj kq nk ks nl kt nm nn bi translated">聚集表上的相同查询</h1><p id="9704" class="pw-post-body-paragraph kv kw jg kx b ky no kh la lb np kk ld le nq lg lh li nr lk ll lm ns lo lp lq ij bi translated">让我们重写一个聚集表上的最后一个查询:</p><pre class="mg mh mi mj gt mk lu ml mm aw mn bi"><span id="86bd" class="mo mp jg lu b gy mq mr l ms mt">SELECT TIMESTAMP_TRUNC(timestamp, WEEK) week<br/>  , REGEXP_EXTRACT(details.python, r'^\d*\.\d*') python<br/>  , COUNT(*) downloads<br/>FROM `fh-bigquery.pypi.pypi_2017`<br/>WHERE project='pyspark'<br/>AND timestamp&gt;'2000-01-01' # nag<br/>GROUP BY week, python<br/>HAVING python != '3.6' AND week&lt;'2017-12-30'<br/>ORDER BY week</span><span id="2cd1" class="mo mp jg lu b gy mu mr l ms mt">5.4 sec elapsed, 9.65 GB processed # winning</span></pre><p id="5eb4" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这很酷:如果您使用我的集群表而不是现有的官方表，同样的查询将只扫描大约 5%的数据。</p><p id="5047" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意事项:</p><ul class=""><li id="2029" class="nt nu jg kx b ky kz lb lc le nv li nw lm nx lq ny nz oa ob bi translated"><code class="fe lr ls lt lu b">FROM `fh-bigquery.pypi.pypi_2017`</code>是您可以找到我的集群表的地方。我每年创造一个。</li><li id="831f" class="nt nu jg kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><code class="fe lr ls lt lu b">FROM `fh-bigquery.pypi.pypi_20*`</code>让你年年匹配。</li><li id="695c" class="nt nu jg kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><code class="fe lr ls lt lu b">WHERE project=’pyspark'</code>允许您从集群中受益，集群可以在这些表格中根据项目名称进行修剪。</li><li id="0e81" class="nt nu jg kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated">原始表上的<code class="fe lr ls lt lu b">file.project</code>必须由<code class="fe lr ls lt lu b">project</code>替换，因为集群不能在嵌套列上工作(还不能)。</li><li id="70de" class="nt nu jg kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><code class="fe lr ls lt lu b">timestamp&gt;'2000-01-01'</code>这是我强有力地提醒您这些是时间分区表的方式。如果您将查询限制在一年中的一段时间内，那么您查询的数据会相应减少——或者您可以从一个非常早的日期开始明确地询问所有数据。</li><li id="38b4" class="nt nu jg kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated"><code class="fe lr ls lt lu b">REGEXP_EXTRACT(details.python, r’^\d*\.\d*’)</code>将 Python 版本保留到最高有效位。</li><li id="84de" class="nt nu jg kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated">这些查询将只与<code class="fe lr ls lt lu b">#standardSQL</code>一起运行，因为<code class="fe lr ls lt lu b">#legacySQL</code>不支持集群表。</li></ul><p id="bd75" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我说“我的集群表”是因为我提供它们作为一个非官方的地方来获取这些日志，同时我们改进这个过程。根据您的反馈和意见，我们将努力将这些改进整合到官方资料库中。</p><h1 id="c2b0" class="mx mp jg bd my mz na nb nc nd ne nf ng km nh kn ni kp nj kq nk ks nl kt nm nn bi translated">工作日志</h1><h2 id="4d4a" class="mo mp jg bd my oh oi dn nc oj ok dp ng le ol om ni li on oo nk lm op oq nm or bi translated">重新聚类</h2><p id="8cad" class="pw-post-body-paragraph kv kw jg kx b ky no kh la lb np kk ld le nq lg lh li nr lk ll lm ns lo lp lq ij bi translated">为了对每年的现有数据进行重新聚类，我做了如下工作:</p><pre class="mg mh mi mj gt mk lu ml mm aw mn bi"><span id="0d34" class="mo mp jg lu b gy mq mr l ms mt">CREATE TABLE `fh-bigquery.pypi.pypi_2017`<br/>PARTITION BY DATE(timestamp)<br/>CLUSTER BY project, country_code<br/>OPTIONS(<br/>   description="repartitioned and clustered from <a class="ae jd" href="https://bigquery.cloud.google.com/table/the-psf:pypi.downloads20180906" rel="noopener ugc nofollow" target="_blank">https://bigquery.cloud.google.com/table/the-psf:pypi.downloads20180906</a>"<br/>   , require_partition_filter=true<br/>)<br/>AS<br/>SELECT file.project project<br/>  , STRUCT(file.filename, file.type, file.version) file<br/>  , * EXCEPT(file)<br/>FROM `the-psf.pypi.downloads2017*`</span><span id="d8ca" class="mo mp jg lu b gy mu mr l ms mt">34 min elapsed, 2.44 TB processed</span></pre><h2 id="8af3" class="mo mp jg bd my oh oi dn nc oj ok dp ng le ol om ni li on oo nk lm op oq nm or bi translated">每日更新</h2><p id="95b3" class="pw-post-body-paragraph kv kw jg kx b ky no kh la lb np kk ld le nq lg lh li nr lk ll lm ns lo lp lq ij bi translated">每天凌晨 3 点，我将运行一个<a class="ae jd" href="https://cloud.google.com/bigquery/docs/scheduling-queries" rel="noopener ugc nofollow" target="_blank">计划查询</a>，添加前一天的数据:</p><pre class="mg mh mi mj gt mk lu ml mm aw mn bi"><span id="9bff" class="mo mp jg lu b gy mq mr l ms mt">INSERT INTO `fh-bigquery.pypi.pypi_2018` (project, file, timestamp, country_code, url, details, tls_protocol, tls_cipher)</span><span id="71cb" class="mo mp jg lu b gy mu mr l ms mt">SELECT file.project project<br/>  , STRUCT(file.filename, file.type, file.version) file<br/>  , * EXCEPT(file)<br/>FROM `the-psf.pypi.downloads2018*`<br/>WHERE _TABLE_SUFFIX = FORMAT_TIMESTAMP('%m%d', TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 24 HOUR))<br/>AND timestamp &gt; ( # for idempotency<br/>  SELECT MAX(timestamp) <br/>  FROM `fh-bigquery.pypi.pypi_2018` <br/>  WHERE timestamp&gt;TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 24*2 HOUR)<br/>)</span><span id="96a7" class="mo mp jg lu b gy mu mr l ms mt">48.9 sec elapsed, 24.83 GB processed</span></pre><figure class="mg mh mi mj gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi os"><img src="../Images/f2546f1ba2b77446a01578593645f916.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TQcFHS2YoTn5Wk4nQUHgRQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Configuring a scheduled query</figcaption></figure><h2 id="d855" class="mo mp jg bd my oh oi dn nc oj ok dp ng le ol om ni li on oo nk lm op oq nm or bi translated">常见问题解答</h2><h2 id="647b" class="mo mp jg bd my oh oi dn nc oj ok dp ng le ol om ni li on oo nk lm op oq nm or bi translated">BigQuery 说它将处理大量的千兆字节，而我预期的要少一些</h2><p id="8bc5" class="pw-post-body-paragraph kv kw jg kx b ky no kh la lb np kk ld le nq lg lh li nr lk ll lm ns lo lp lq ij bi translated">使用聚簇表，BigQuery 在运行查询之前给出了最大可计费字节的估计值——但是如果可能的话，查询可能会比这个值小。</p><p id="ca3a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一些例子:</p><pre class="mg mh mi mj gt mk lu ml mm aw mn bi"><span id="a1dc" class="mo mp jg lu b gy mq mr l ms mt">SELECT *<br/>FROM `fh-bigquery.pypi.pypi_2017`<br/>WHERE timestamp&gt;='2017-12-01'<br/>LIMIT 1</span><span id="4744" class="mo mp jg lu b gy mu mr l ms mt"># 1.6s elapsed, 28.6 MB processed<br/># Stops scanning when it finds the first row</span><span id="ab33" class="mo mp jg lu b gy mu mr l ms mt">SELECT *<br/>FROM `fh-bigquery.pypi.pypi_2017`<br/>WHERE timestamp&gt;='2017-12-01'<br/>AND project='rpy2'<br/>LIMIT 1</span><span id="cf7b" class="mo mp jg lu b gy mu mr l ms mt">2.0s elapsed, 386 MB processed<br/># Finds the cluster that contains 'rpy2' and scans that</span><span id="5865" class="mo mp jg lu b gy mu mr l ms mt">SELECT *<br/>FROM `fh-bigquery.pypi.pypi_2017`<br/>WHERE timestamp&gt;='2017-12-01'<br/>AND project='88888'<br/>LIMIT 1</span><span id="8ad4" class="mo mp jg lu b gy mu mr l ms mt">2.4s elapsed, 4.58 GB processed<br/># Finds the clusters which could contain '88888', but it's not there</span><span id="c63d" class="mo mp jg lu b gy mu mr l ms mt">SELECT *<br/>FROM `fh-bigquery.pypi.pypi_2017`<br/>WHERE timestamp&gt;='2017-12-01'<br/>AND project LIKE '%random%'<br/>LIMIT 1</span><span id="fbb1" class="mo mp jg lu b gy mu mr l ms mt">1.8s elapsed, 171 MB processed<br/># Opens all the clusters, until one contains a *random* project</span><span id="5070" class="mo mp jg lu b gy mu mr l ms mt">SELECT *<br/>FROM `fh-bigquery.pypi.pypi_2017`<br/>WHERE timestamp&gt;='2017-12-01'<br/>AND project LIKE '%DOESNT-EXIST%'<br/>LIMIT 1</span><span id="6c1a" class="mo mp jg lu b gy mu mr l ms mt">2.7s elapsed, 221 GB processed<br/># Opens all the clusters, and keeps searching for an un-existing pattern</span></pre><h1 id="959a" class="mx mp jg bd my mz na nb nc nd ne nf ng km nh kn ni kp nj kq nk ks nl kt nm nn bi translated">承认</h1><ul class=""><li id="144c" class="nt nu jg kx b ky no lb np le ot li ou lm ov lq ny nz oa ob bi translated">感谢<a class="me mf ep" href="https://medium.com/u/969ebca04288?source=post_page-----d80e583e1bfe--------------------------------" rel="noopener" target="_blank"> Donald Stufft </a>，让这一切<a class="ae jd" href="https://github.com/pypa/linehaul" rel="noopener ugc nofollow" target="_blank">成为可能</a>。</li><li id="d814" class="nt nu jg kx b ky oc lb od le oe li of lm og lq ny nz oa ob bi translated">欢迎<a class="me mf ep" href="https://medium.com/u/3c2614279236?source=post_page-----d80e583e1bfe--------------------------------" rel="noopener" target="_blank"> di_codes </a>加入 GCP 团队。</li></ul><h1 id="7cef" class="mx mp jg bd my mz na nb nc nd ne nf ng km nh kn ni kp nj kq nk ks nl kt nm nn bi translated">后续步骤</h1><p id="23d1" class="pw-post-body-paragraph kv kw jg kx b ky no kh la lb np kk ld le nq lg lh li nr lk ll lm ns lo lp lq ij bi translated">我们应该将这些聚集的表移动到官方回购中，但让我们先讨论它们:</p><ul class=""><li id="2d76" class="nt nu jg kx b ky kz lb lc le nv li nw lm nx lq ny nz oa ob bi translated">Python <a class="ae jd" href="https://mail.python.org/mm3/archives/list/distutils-sig@python.org/thread/DLDRMK33A4MDXSKUU3BDCE5BFYK5G3WA/#DLDRMK33A4MDXSKUU3BDCE5BFYK5G3WA" rel="noopener ugc nofollow" target="_blank"> distutils-sig@讨论主题</a>。</li></ul><p id="3254" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">想要更多的故事？查看我的<a class="ae jd" href="http://medium.com/@hoffa/" rel="noopener">媒体</a>，<a class="ae jd" href="http://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank">关注我的推特</a>，订阅 reddit.com/r/bigquery<a class="ae jd" href="https://reddit.com/r/bigquery" rel="noopener ugc nofollow" target="_blank"/>。并且<a class="ae jd" href="https://www.reddit.com/r/bigquery/comments/3dg9le/analyzing_50_billion_wikipedia_pageviews_in_5/" rel="noopener ugc nofollow" target="_blank">尝试 big query</a>——每个月你都可以从<a class="ae jd" href="https://cloud.google.com/bigquery/docs/sandbox" rel="noopener ugc nofollow" target="_blank">免费获得一个完整的万亿字节的分析。</a></p><div class="ip iq gp gr ir lv"><a rel="noopener follow" target="_blank" href="/these-are-the-real-stack-overflow-trends-use-the-pageviews-c439903cd1a"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd jh gy z fp ma fr fs mb fu fw jf bi translated">这些是真正的堆栈溢出趋势:使用页面视图</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">直到今天，获得 Stack Overflow 的季度浏览量并不容易。了解如何获得这些…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb ix lv"/></div></div></a></div></div></div>    
</body>
</html>