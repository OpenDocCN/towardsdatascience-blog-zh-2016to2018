<html>
<head>
<title>How to deploy Machine Learning models with TensorFlow. Part 3— into the Cloud!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 TensorFlow 部署机器学习模型？第 3 部分—进入云！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-machine-learning-models-with-tensorflow-part-3-into-the-cloud-7115ff774bb6?source=collection_archive---------1-----------------------#2017-07-01">https://towardsdatascience.com/how-to-deploy-machine-learning-models-with-tensorflow-part-3-into-the-cloud-7115ff774bb6?source=collection_archive---------1-----------------------#2017-07-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/8d5b08123f2a73ecfbe25e16dea6e697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4mCf88OEk8fxEKIZuyqeg.png"/></div></figure></div><div class="ab cl ju jv hu jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="ij ik il im in"><p id="292c" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">在<a class="ae kz" href="https://medium.com/towards-data-science/how-to-deploy-machine-learning-models-with-tensorflow-part-1-make-your-model-ready-for-serving-776a14ec3198" rel="noopener">第 1 部分</a>和<a class="ae kz" href="https://medium.com/towards-data-science/how-to-deploy-machine-learning-models-with-tensorflow-part-2-containerize-it-db0ad7ca35a7" rel="noopener">第 2 部分</a>中，我们创建了一个 GAN 模型来预测<a class="ae kz" href="http://ufldl.stanford.edu/housenumbers/" rel="noopener ugc nofollow" target="_blank">街景门牌号码</a>，并在<a class="ae kz" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>容器中使用<a class="ae kz" href="https://tensorflow.github.io/serving/" rel="noopener ugc nofollow" target="_blank"> TensorFlow 本地服务</a>来托管它。现在是将它引入云的时候了！</p><h1 id="4ce4" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">动机</h1><p id="9b4d" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">当您实现一个 web 服务(比如预测服务)并希望其他人使用它时，您可以在云托管提供商处发布它。通常，您不想关心诸如服务的可用性、可伸缩性之类的事情；你想专注于开发你的模型和算法。</p><p id="3f51" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">如今，你有大量的云平台提供商可供选择。最突出的是亚马逊 AWS、微软 Azure、谷歌云平台、IBM Bluemix。一旦服务被部署到他们的服务器上，他们就提供资源并负责服务的可用性。</p><p id="d887" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">第二个重要任务是自动化。您希望自动部署、扩展和管理您的服务。就我个人而言，我希望每次单击鼠标或运行一个简单的脚本就能部署，我希望我的服务在收到更多请求时能自动扩展，我希望在崩溃时无需手动干预就能恢复，等等。这里一个工具<a class="ae kz" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>开始发挥作用。</p><blockquote class="md me mf"><p id="d00c" class="kb kc mg kd b ke kf kg kh ki kj kk kl mh kn ko kp mi kr ks kt mj kv kw kx ky ij bi translated">Kubernetes 是一个开源系统，用于自动化部署、扩展和管理容器化的应用程序。</p></blockquote><p id="c3ad" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">Kubernetes 是由 Google 开发和支持的。所以你绝对可以依赖它。上面列出的云提供商有内置的 it 支持。因此，我们可以相对容易地将部署设置到云中。</p><h1 id="c4af" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">云提供商选择</h1><p id="4ad3" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">对于这篇文章，我使用微软 Azure。主要是因为一个原因——他们提供 30 天的试用期和 200 美元的信用额度。</p><p id="0cca" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我也看了其他供应商。在 AWS，我没有找到免费获得小型 Kubernetes 集群的可能性。在谷歌你可以免费测试他们的云平台，但是他们用“账户类型=业务”吓到我了(我只是想给自己一个小的测试环境)。IBM Bluemix 不是很直观。</p><p id="945d" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">所以我选择了微软 Azure，他们也有很好的用户界面:-)</p><h1 id="54a8" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">准备 Docker 图像</h1><p id="b233" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">在我们进入 Kubernetes 之前，我们需要保存 Docker 容器以及我们所做的所有更改，作为一个图像。首先，我们需要容器 ID:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="07c0" class="mt lb iq mp b gy mu mv l mw mx">docker ps --all</span></pre><p id="e72c" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您将获得所有 Docker 容器的列表——选择您已经创建的容器。例如:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="7f13" class="mt lb iq mp b gy mu mv l mw mx">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES<br/><strong class="mp ir">35027f92f2f8</strong> &lt;your user name&gt;/tensorflow-serving-devel "/bin/bash" 4 days ago Exited (0) 4 days ago tf_container_cpu</span></pre><p id="619b" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我用粗体字标出了我们需要的 ID。</p></div><div class="ab cl ju jv hu jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="ij ik il im in"><p id="7df6" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">提示</strong>:由于我不想在云中使用昂贵的 GPU 驱动的虚拟机，我选择了 TensorFlow 服务 CPU Docker 容器。</p></div><div class="ab cl ju jv hu jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="ij ik il im in"><p id="84cb" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">现在我们可以从容器中创建 Docker 图像:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4ebf" class="mt lb iq mp b gy mu mv l mw mx">docker commit <strong class="mp ir">35027f92f2f8</strong> $USER/tensorflow-serving-gan:v1.0</span></pre><p id="5c0b" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">如果你查看图片列表(<em class="mg"> docker images </em>命令)，你应该会发现一个新创建的图片<em class="mg"> &lt;你的用户名&gt; /tensorflow-serving-gan </em>标签为<em class="mg"> v1.0 </em>。图像是近似的。比原来的大 5 倍，因为我们下载并制作了很多新东西。</p><h1 id="09dd" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">库伯内特。重要概念简介</h1><p id="792e" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">我鼓励你查看 Kubernetes 的文档,了解它的功能、概念和教程。在这里，我只是给了一个非常粗略的想法，如何与它合作。</p><p id="6b02" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我们将 Docker 映像部署到 Kubernetes 集群中。Kubernetes 集群至少由一个主节点和一个或多个工作节点组成。</p><h2 id="28ba" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">结节</h2><p id="6241" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">节点是 Kubernetes 集群中的一个工作机(虚拟机或裸机)。它由主组件管理，拥有运行<strong class="kd ir"> Pods </strong>的所有服务。这些服务包括，例如，Docker，这对我们很重要。</p><p id="f35d" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我们将创建一个主节点和一个工作节点。主节点不运行任何 Pod，它的职责是集群管理。</p><h2 id="0590" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated"><strong class="ak"> Pod </strong></h2><p id="deec" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">Pod 是由一个或多个容器、这些容器的共享存储以及关于如何运行容器的选项组成的组。所以 Pod 是逻辑相关容器的逻辑主机。</p><p id="87e5" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">在我们的 Pod 中，我们只有一个 Docker 容器，即我们的 TensorFlow GAN 服务。我们将创建两个 pod，尽管它们将在同一个节点上运行。</p><h2 id="bcaf" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">服务</h2><p id="4b88" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">豆荚是会死的。他们出生和死亡。特别是复制控制器动态地创建和销毁 pod。虽然每个 Pod 都有自己的 IP 地址，但是这些 IP 地址并不可靠。因此，如果我们有需要相互通信的 pod(例如前端到后端)，或者我们想要从外部访问一些 pod(在我们的例子中)，那么我们就有问题了。</p><p id="bea6" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">Kubernetes <strong class="kd ir">服务</strong>解决。这是一个抽象概念，它定义了一组逻辑单元和访问它们的策略。在我们的例子中，我们将创建一个抽象两个 pod 的服务。</p><h1 id="f41c" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">在 Microsoft Azure 上设置 Kubernetes 群集</h1><p id="e858" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">Microsoft Azure 提供了一种设置和操作 Kubernetes 集群的便捷方式。首先你需要 Azure 账号。</p><h2 id="176a" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">进入 Microsoft Azure</h2><ul class=""><li id="764c" class="nj nk iq kd b ke ly ki lz km nl kq nm ku nn ky no np nq nr bi translated">在<a class="ae kz" href="https://azure.microsoft.com/free/" rel="noopener ugc nofollow" target="_blank">https://azure.microsoft.com/free/</a>获得 Azure 免费试用账户。如果你已经有微软帐号，你可以使用它。</li><li id="9c47" class="nj nk iq kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated">微软提供 200 美元的信用额度来启动 Azure。这对我们的目的来说已经足够了。</li><li id="6cff" class="nj nk iq kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated">去<a class="ae kz" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure 门户</a>，检查你是否有完全访问权限。</li><li id="68c9" class="nj nk iq kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated">在你的电脑上本地安装<a class="ae kz" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure 命令行界面</a>。在 64 位 Ubuntu 中，您可以从终端完成:</li></ul><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="5cc0" class="mt lb iq mp b gy mu mv l mw mx">echo "deb [arch=amd64] <a class="ae kz" href="https://packages.microsoft.com/repos/azure-cli/" rel="noopener ugc nofollow" target="_blank">https://packages.microsoft.com/repos/azure-cli/</a> wheezy main" | \<br/>sudo tee /etc/apt/sources.list.d/azure-cli.list</span><span id="20af" class="mt lb iq mp b gy nx mv l mw mx">sudo apt-key adv --keyserver packages.microsoft.com --recv-keys 417A0893</span><span id="7995" class="mt lb iq mp b gy nx mv l mw mx">sudo apt-get install apt-transport-https</span><span id="4dda" class="mt lb iq mp b gy nx mv l mw mx">sudo apt-get update &amp;&amp; sudo apt-get install azure-cli</span></pre><p id="94d9" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">然后使用以下命令检查安装的版本:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="8854" class="mt lb iq mp b gy mu mv l mw mx">az --version</span></pre><p id="20ae" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">它应该等于或大于 2.0.x。</p><h2 id="a6c5" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">创建 Kubernetes 集群</h2><p id="1c22" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">您需要通过简单的步骤来创建一个 Kubernetes 集群。</p><p id="8a6f" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">登录 Azure </strong></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="d0f9" class="mt lb iq mp b gy mu mv l mw mx">az login</span></pre><p id="c056" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">并遵循终端和浏览器中的指示。最后，您应该会看到一个带有云信息的<a class="ae kz" href="http://www.json.org/" rel="noopener ugc nofollow" target="_blank"> JSON </a>文档。</p><p id="c4aa" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">创建资源组</strong></p><p id="8657" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">资源组是一个逻辑组，您可以在其中部署资源(例如虚拟机)并管理它们。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="b442" class="mt lb iq mp b gy mu mv l mw mx">az group create --name ganRG --location eastus</span></pre><p id="30c6" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您应该会看到一个包含资源组信息的 JSON 文档。</p><p id="db45" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">创建集群</strong></p><p id="beb0" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">现在是时候创建 Kubernetes 集群了。在 Azure 免费试用版中，我们最多可以使用 4 个内核，因此我们只能创建一个主内核和一个工作内核；它们每个都有两个内核。主节点是自动创建的，<em class="mg"> agent-count </em>指定工作(或代理)节点的数量。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="c154" class="mt lb iq mp b gy mu mv l mw mx">az acs create --orchestrator-type=kubernetes \<br/>--resource-group ganRG \<br/>--name=ganK8sCluster \<br/>--agent-count=1 \<br/>--generate-ssh-keys</span></pre><p id="e2dd" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">提示</strong>:不要使用很长的名称，我在创建 Kubernetes 服务时遇到了一个错误，它抱怨名称太长(Azure 给集群名称添加了相当长的后缀)。</p><p id="fe01" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">如果 SSH 密钥不存在，您还会在默认位置收到生成的 SSH 密钥。稍等几分钟…如果一切正常，那么您应该会看到包含集群信息的相当长且详细的 JSON 文档。确信您的资源组中已经创建了一个集群</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="fb77" class="mt lb iq mp b gy mu mv l mw mx">{<br/>.........<br/>  "resourceGroup": "ganRG"<br/>}</span></pre><p id="2ce6" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您还可以在 Azure Portal 中检查我们在资源组<em class="mg"> ganRG </em>中有两个虚拟机—<em class="mg">k8s-master—…</em>和<em class="mg">k8s-agent—…</em>。</p><p id="4bdb" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">注意事项</strong></p><p id="32b6" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">如果您不使用虚拟机，请注意停止或取消分配虚拟机，以避免额外成本:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="e45d" class="mt lb iq mp b gy mu mv l mw mx">az vm [stop|deallocate] — resource-group=ganRG — name=k8s-agent-…<br/>az vm [stop|deallocate] — resource-group=ganRG — name=k8s-master-…</span></pre><p id="e355" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您可以使用以下命令重新启动它们:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="e01d" class="mt lb iq mp b gy mu mv l mw mx">az vm start — resource-group=ganRG — name=k8s-agent-…<br/>az vm start — resource-group=ganRG — name=k8s-master-…</span></pre><h1 id="aeb7" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">将 Docker 图像上传到 Azure</h1><p id="6a94" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">现在我和 Kubernetes 做一个短暂的休息，把我们的 Docker 图片上传到 Azure 容器注册中心。它是我们在云中的 Docker 私有注册表。我们需要这个注册中心将 Docker 映像放入我们的 Kubernetes 集群。</p><h2 id="685d" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">创建容器注册表</h2><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="1778" class="mt lb iq mp b gy mu mv l mw mx">az acr create --name=ganEcr --resource-group=ganRG --sku=Basic</span></pre><p id="3fa9" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">创建一个私有注册表<em class="mg"> ganEcr </em>。作为响应，您应该得到一个包含注册表信息的 JSON 文档。有趣的领域有:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="8147" class="mt lb iq mp b gy mu mv l mw mx">{<br/>  "adminUserEnabled": false,<br/>  .........<br/>  "loginServer": "ganecr.azurecr.io",<br/>  .........<br/>}</span></pre><p id="f4b9" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">第一个告诉您，注册表没有管理员，第二个告诉您资源组中服务器的名称。为了上传 Docker 图像，我们需要一名管理员，我们必须让他:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="cd89" class="mt lb iq mp b gy mu mv l mw mx">az acr update -n ganEcr --admin-enabled true</span></pre><h2 id="c704" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">上传 Docker 图像</h2><p id="42e2" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">首先，我们必须提供上传凭证:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="8d28" class="mt lb iq mp b gy mu mv l mw mx">az acr credential show --name=ganEcr</span></pre><p id="8d32" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您应该会收到类似以下内容的响应:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="9542" class="mt lb iq mp b gy mu mv l mw mx">{<br/>  "passwords": [<br/>    {<br/>      "name": "password",<br/>      "value": "=bh5wXWOUSrJtKPHReTAgi/bijQCkjsq"<br/>    },<br/>    {<br/>      "name": "password2",<br/>      "value": "OV0Va1QXv=GPL+sGm9ZossmvgIoYBdif"<br/>    }<br/>  ],<br/>  "username": "ganEcr"<br/>}</span></pre><p id="d261" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您使用一个<em class="mg">用户名</em>和一个密码从 Docker:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="dba0" class="mt lb iq mp b gy mu mv l mw mx">docker login ganecr.azurecr.io -u=ganEcr -p=&lt;password value from credentials&gt;</span></pre><p id="3265" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">然后以这种方式标记 GAN Docker 图像:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="d570" class="mt lb iq mp b gy mu mv l mw mx">docker tag $USER/tensorflow-serving-gan:v1.0 ganecr.azurecr.io/tensorflow-serving-gan</span></pre><p id="26d9" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">现在你可以把它推到 Azure 容器注册！</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4bf3" class="mt lb iq mp b gy mu mv l mw mx">docker push ganecr.azurecr.io/tensorflow-serving-gan</span></pre><p id="2e9a" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">耐心点，这需要一段时间:-)记住，这个操作将 Docker 镜像从你的 PC 上传到微软服务器。</p><h1 id="1898" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">在 Kubernetes 集群上运行</h1><p id="3ae9" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">回到库伯内特。对于集群上的操作，我们需要一个名为<em class="mg"> kubectl </em>的工具。它是一个命令行界面，用于对 Kubernetes 集群运行命令。</p><p id="c19f" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我建议您查看 kubectl 文档中的可用命令列表。我在这里使用:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="ae94" class="mt lb iq mp b gy mu mv l mw mx">kubectl get [nodes|pods|services] </span></pre><p id="114e" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">分别获取关于 Kubernetes 节点、pod 和服务的信息</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4c3c" class="mt lb iq mp b gy mu mv l mw mx">kubectl create ...</span></pre><p id="9b94" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">用于从配置文件创建 pod 和服务。</p><h2 id="96ac" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">用 kubectl 连接到 Azure</h2><p id="00fa" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">首先从 Azure 获取凭据:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="d52d" class="mt lb iq mp b gy mu mv l mw mx">az acs kubernetes get-credentials --resource-group=ganRG --name=ganK8sCluster</span></pre><p id="b0cf" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">这个命令从 Azure 获取凭证并将它们本地保存到<em class="mg"> ~/。kube/config </em>。所以你不需要以后再问他们。</p><p id="a720" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">现在，使用<em class="mg"> kubectl </em>验证到集群的连接:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="2662" class="mt lb iq mp b gy mu mv l mw mx">kubectl get nodes</span></pre><p id="fd04" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您应该会看到主节点和工作节点:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="22c8" class="mt lb iq mp b gy mu mv l mw mx">NAME                    STATUS                     AGE       VERSION<br/>k8s-agent-bb8987c3-0    Ready                      7m        v1.6.6<br/>k8s-master-bb8987c3-0   Ready,SchedulingDisabled   7m        v1.6.6</span></pre><h2 id="843a" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">部署配置</h2><p id="cddd" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">我已经为部署到 Kubernetes 集群创建了一个<a class="ae kz" href="https://github.com/Vetal1977/tf_serving_example/blob/master/gan_k8s.yaml" rel="noopener ugc nofollow" target="_blank">配置文件</a> (YAML 格式)。在那里，我定义了一个<a class="ae kz" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">部署控制器</a>和一个<a class="ae kz" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank">服务</a>。我鼓励您阅读 Kubernetes 文档以获取详细信息。</p><p id="6736" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">这里只是一个解释，我所做的。实际上，您可以使用<em class="mg"> kubectl </em>命令来部署 pod 和服务，但是将所需的部署配置一次性写入这样的 YAML 文件并在以后使用它要方便得多。</p><p id="73c3" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">在我们的例子中，它定义了一个部署和一个服务:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="2241" class="mt lb iq mp b gy mu mv l mw mx">......<br/>kind: Deployment<br/>metadata:<br/>  name: gan-deployment<br/>......<br/>---<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    run: gan-service<br/>  name: gan-service</span></pre><p id="20a2" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">部署</strong></p><p id="7725" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我想将我的 Docker 映像部署到两个单元中:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="aa6a" class="mt lb iq mp b gy mu mv l mw mx">spec:<br/>replicas: 2</span></pre><p id="358c" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">并从我的 Azure 容器注册表中提取它:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="c38d" class="mt lb iq mp b gy mu mv l mw mx">spec:<br/>  containers:<br/>  - name: gan-container<br/>    image: ganecr.azurecr.io/tensorflow-serving-gan</span></pre><p id="16c8" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">部署后，Pod 应该启动 Shell 并启动 TensorFlow，在 Docker 容器中为 GAN 模型提供服务:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="788c" class="mt lb iq mp b gy mu mv l mw mx">command:<br/>- /bin/sh<br/>- -c<br/>args:<br/>- /serving/bazel-bin/tensorflow_serving/model_servers/tensorflow_model_server          --port=9000 --model_name=gan --model_base_path=/serving/gan-export</span></pre><p id="01d7" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">在端口 9000 上:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="c8ff" class="mt lb iq mp b gy mu mv l mw mx">ports:<br/>- containerPort: 9000</span></pre><p id="98d7" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">服务</strong></p><p id="3284" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">服务必须在端口 9000 上接受外部请求，并将它们转发到 Pod 中的容器端口 9000:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="b191" class="mt lb iq mp b gy mu mv l mw mx">ports:<br/>- port: 9000<br/>  targetPort: 9000</span></pre><p id="03c0" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">并在两个底层 pod 之间提供负载平衡:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="51c3" class="mt lb iq mp b gy mu mv l mw mx">type: LoadBalancer</span></pre><h2 id="77e3" class="mt lb iq bd lc my mz dn lg na nb dp lk km nc nd lo kq ne nf ls ku ng nh lw ni bi translated">部署到 Kubernetes 集群中</h2><p id="f156" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">现在部署 Docker 映像，让 Kubernetes 来管理它！</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="9ac1" class="mt lb iq mp b gy mu mv l mw mx">cd &lt;path to GAN project&gt;<br/>kubectl create -f gan_k8s.yaml</span></pre><p id="e073" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您应该看到:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="d978" class="mt lb iq mp b gy mu mv l mw mx">deployment "gan-deployment" created<br/>service "gan-service" created</span></pre><p id="25b2" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">现在检查 pod 是否正在运行:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="f841" class="mt lb iq mp b gy mu mv l mw mx">kubectl get pods</span><span id="6e8a" class="mt lb iq mp b gy nx mv l mw mx">NAME                              READY     STATUS    RESTARTS   AGE<br/>gan-deployment-3500298660-3gmkj   1/1       Running   0          24m<br/>gan-deployment-3500298660-h9g3q   1/1       Running   0          24m</span></pre><p id="cff8" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">提示</strong>:状态变为<em class="mg">运行</em>需要一段时间。只有这样你才能确定豆荚已经准备好了。</p><p id="27b6" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">服务准备就绪:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="285e" class="mt lb iq mp b gy mu mv l mw mx">kubectl get services</span><span id="9cd6" class="mt lb iq mp b gy nx mv l mw mx">NAME          CLUSTER-IP     EXTERNAL-IP    PORT(S)          AGE<br/>gan-service   10.0.134.234   40.87.62.198   9000:30694/TCP   24m<br/>kubernetes    10.0.0.1       &lt;none&gt;         443/TCP          7h</span></pre><p id="9e9f" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated"><strong class="kd ir">提示</strong>:gan 服务的外部 IP 必须是有效的 IP(不是<em class="mg">&lt;&gt;</em>或<em class="mg"> &lt;节点&gt; </em>)。否则，该服务不可操作。</p><h1 id="6ff8" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">检查它是否工作</h1><p id="55e4" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">所以现在我们可以检查我们的努力是值得的！</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="1575" class="mt lb iq mp b gy mu mv l mw mx">cd &lt;path to GAN project&gt;<br/>python svnh_semi_supervised_client.py --server=40.87.62.198:9000 --image=./svnh_test_images/image_3.jpg</span></pre><p id="8fe1" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">您应该看到:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="8d1a" class="mt lb iq mp b gy mu mv l mw mx">outputs {<br/>  key: "scores"<br/>  value {<br/>    dtype: DT_FLOAT<br/>    tensor_shape {<br/>      dim {<br/>        size: 1<br/>      }<br/>      dim {<br/>        size: 10<br/>      }<br/>    }<br/>    float_val: 8.630897802584857e-17<br/>    float_val: 1.219293777054986e-09<br/>    float_val: 6.613714575998131e-10<br/>    float_val: 1.5203355241411032e-09<br/>    <strong class="mp ir">float_val: 0.9999998807907104<br/>    </strong>float_val: 9.070973139291283e-12<br/>    float_val: 1.5690838628401593e-09<br/>    float_val: 9.12262028080068e-17<br/>    float_val: 1.0587883991775016e-07<br/>    float_val: 1.0302327879685436e-08<br/>  }<br/>}</span></pre><p id="9dc6" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">如果你得到这个结果，恭喜你！您在 Kubernetes 集群的云中部署了 GAN 模型。Kubernetes 以可靠的方式扩展、负载平衡和管理 GAN 模型。</p><h1 id="2103" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="c226" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">在<a class="ae kz" href="https://medium.com/towards-data-science/how-to-deploy-machine-learning-models-with-tensorflow-part-1-make-your-model-ready-for-serving-776a14ec3198" rel="noopener">第 1 部分</a>和<a class="ae kz" href="https://medium.com/towards-data-science/how-to-deploy-machine-learning-models-with-tensorflow-part-2-containerize-it-db0ad7ca35a7" rel="noopener">第 2 部分</a>中，我们创建了一个 GAN 模型，准备好供 TensorFlow 使用，并将其放入 Docker 容器中。工作量很大，但我们都是在当地生产的。</p><p id="a81f" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">现在我们把它公之于众，并使用最先进的技术，以可靠和可扩展的方式做到了这一点。</p><p id="613e" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">当然，这个模型非常简单，并且以用户不友好的形式给出结果。自动化潜力很大，我做了很多手动步骤来解释其中的机制。所有步骤都可以打包到脚本中进行“一键式”部署，或者成为持续集成/持续部署管道的一部分。</p><p id="a4b7" class="pw-post-body-paragraph kb kc iq kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky ij bi translated">我希望你喜欢这个教程，并发现它很有用。如有任何疑问或问题，请随时与我联系。</p><h1 id="54cc" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">更新 12。2017 年 11 月</h1><p id="f1d5" class="pw-post-body-paragraph kb kc iq kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky ij bi translated">我用<a class="ae kz" href="https://medium.com/@vitaly.bezgachev/creating-restful-api-to-tensorflow-models-c5c57b692c10" rel="noopener">指令</a>扩展了一个教程，如何为模型创建 REST API，由 TensorFlow Serving 托管。</p></div></div>    
</body>
</html>