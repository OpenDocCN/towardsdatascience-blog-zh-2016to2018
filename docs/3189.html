<html>
<head>
<title>How to Run Customized Tensorflow Training in the Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在云中运行定制的 Tensorflow 培训</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-run-customized-tensorflow-training-in-the-cloud-d0c142e3cfb5?source=collection_archive---------9-----------------------#2018-04-17">https://towardsdatascience.com/how-to-run-customized-tensorflow-training-in-the-cloud-d0c142e3cfb5?source=collection_archive---------9-----------------------#2018-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="137e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您的 Tensorflow 代码在本地运行。现在，您希望在生产环境中设置它，以获得所有额外的 GPU 功能。有两种选择。比较流行的两个托管 ML 云平台是 Google Cloud ML Engine 和 AWS Sage Maker。它们让您快速部署您的模型并训练它们。但是，您可能想要构建一个更加定制化的解决方案。为此，您可以使用<a class="ae kl" href="https://aws.amazon.com/batch/" rel="noopener ugc nofollow" target="_blank"> AWS 批次</a>。</p><h2 id="2c51" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated"><strong class="ak">为什么 AWS 批量？</strong></h2><p id="c67c" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">这里的主要思想是尽可能降低成本，同时仍然利用 GPU 的能力。持续运行 GPU 实例会产生巨大的成本。AWS batch 使用一个作业队列，并根据作业需求扩展实例。因此，如果没有作业，就没有正在运行的实例。通过使用<a class="ae kl" href="https://aws.amazon.com/ec2/spot/" rel="noopener ugc nofollow" target="_blank">点实例</a>，您可以进一步降低运行培训工作的成本。</p><h2 id="b812" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated"><strong class="ak">先决条件:</strong></h2><ul class=""><li id="4fa5" class="lk ll iq jp b jq lf ju lg jy lm kc ln kg lo kk lp lq lr ls bi translated">AWS 账户:<a class="ae kl" href="https://aws.amazon.com/console" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/console</a>。</li><li id="c2b4" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">用于部署的 AWS 命令行:<a class="ae kl" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/cli/</a>。</li><li id="e4c1" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">https://docs.docker.com/install/。</li></ul><h2 id="cd93" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated"><strong class="ak">构建 Docker 映像</strong></h2><p id="987a" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">AWS 批处理需要一个 docker 映像，您的 Tensorflow 训练代码将在其中运行。Dockerfile 文件如下。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><ul class=""><li id="c1ae" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated">安装所需的相关 cuda 基础映像和库，从这里获取<a class="ae kl" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/tools/docker/Dockerfile.gpu" rel="noopener ugc nofollow" target="_blank">https://github . com/tensor flow/tensor flow/blob/master/tensor flow/tools/docker/docker file . GPU</a>(版本可能会有所不同)。</li><li id="11ea" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">复制您的代码使用的 Pipfile 并将其安装在映像上。Pipfile 也应该包含 Tensorflow 版本。</li><li id="83f3" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">设置相关的环境变量。</li><li id="2e82" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">复制获取并运行脚本，该脚本将在 s3 上获取一个 shell 脚本(稍后将详细介绍)来处理 Tensorflow 代码的运行(也驻留在 S3 上)。</li></ul><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="dae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">$RUN_SCRIPT 参数将作为环境变量传递给 AWS 批处理作业。</p><p id="6208" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，构建映像并将其推送到 docker 存储库，以便批处理作业可以访问它。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="f63e" class="km kn iq mj b gy mn mo l mp mq">&gt; docker build -t $DOCKER_IMAGE_TAG aws_batch_image<br/>&gt; docker push $DOCKER_IMAGE_TAG</span></pre><p id="9e67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">aws_batch_image 是一个包含 docker 文件以及获取和运行脚本的文件夹。</p><h2 id="62ec" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated"><strong class="ak">建立 AMI </strong></h2><p id="8d5a" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">Tensorflow 依赖于特定的 NVIDIA 驱动程序和软件包来运行。你可以使用 AWS Deeplearning AMI ，它附带了一组预装的驱动程序，或者你也可以自己构建一个。我将通过各种步骤来构建您的自定义 Tensorflow AMI。</p><p id="f0d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建一个 GPU 基础 AMI </strong></p><p id="f2cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从 Amazon EC2 仪表板创建 Amazon Linux AMI。我们将使用带有 16GB 通用 SSD 卷存储的 p2.xlarge 实例。确保生成一个定制的密钥对，您可以用它来 SSH 到实例中。</p><p id="b28f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装 NVIDIA 驱动</strong></p><p id="0b7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先使用以下命令将 ssh 连接到您的实例。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="da69" class="km kn iq mj b gy mn mo l mp mq">&gt; ssh -i custom-key-pair.pem ec2-user@&lt;Public DNS&gt; </span></pre><p id="709e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="b0e8" class="km kn iq mj b gy mn mo l mp mq"># Update package cache and get package updates<br/>&gt; sudo yum update -y</span><span id="06a7" class="km kn iq mj b gy mr mo l mp mq"># Installs gcc compiler and kernel header package<br/>&gt; sudo yum install -y gcc kernel-devel-$(uname -r)</span></pre><p id="8f9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们需要安装基于 Tensorflow 版本的 NVIDIA 驱动程序。P2 实例包含特斯拉 K-80 GPU 的。我们将使用与 CUDA Toolkit 8.0 兼容的 Tensorflow 1.3。你可以使用这个链接帮助找到兼容的驱动程序<a class="ae kl" href="http://www.nvidia.com/Download/Find.aspx" rel="noopener ugc nofollow" target="_blank">http://www.nvidia.com/Download/Find.aspx</a>。我们将使用版本 367.106。</p><p id="debc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载驱动程序安装文件。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="cd04" class="km kn iq mj b gy mn mo l mp mq">&gt; wget http://us.download.nvidia.com/XFree86/Linux-x86_64/367.106/NVIDIA-Linux-x86_64-367.106.run</span></pre><p id="d986" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行安装文件，然后重新启动。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="bb53" class="km kn iq mj b gy mn mo l mp mq">&gt; sudo /bin/bash ./NVIDIA-Linux-x86_64-367.106.run</span><span id="a485" class="km kn iq mj b gy mr mo l mp mq">Verifying archive integrity... OK</span><span id="fb38" class="km kn iq mj b gy mr mo l mp mq">Uncompressing NVIDIA Accelerated Graphics Driver for Linux-x86_64 367.106............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................</span><span id="2d21" class="km kn iq mj b gy mr mo l mp mq">&gt; sudo reboot</span></pre><p id="7aa1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">SSH 到您的实例中，并运行以下命令来测试驱动程序是否安装正确。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="143e" class="km kn iq mj b gy mn mo l mp mq">&gt; nvidia-smi -q | head</span><span id="83b2" class="km kn iq mj b gy mr mo l mp mq">==============NVSMI LOG==============</span><span id="59f7" class="km kn iq mj b gy mr mo l mp mq">Timestamp                           : Tue Apr 10 11:01:04 2018</span><span id="a72b" class="km kn iq mj b gy mr mo l mp mq">Driver Version                      : 367.106</span><span id="6488" class="km kn iq mj b gy mr mo l mp mq">Attached GPUs                       : 1</span><span id="3a01" class="km kn iq mj b gy mr mo l mp mq">GPU 0000:00:1E.0</span><span id="2b25" class="km kn iq mj b gy mr mo l mp mq">Product Name                    : Tesla K80</span><span id="027a" class="km kn iq mj b gy mr mo l mp mq">Product Brand                   : Tesla</span></pre><p id="3fbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您选择的驱动程序不起作用，请尝试使用不同的版本。</p><p id="2791" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">配置 nvidia-docker </strong></p><p id="d90f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">NVIDIA Docker RPM 安装将 NVIDIA 驱动程序复制到 AWS 批处理作业中 Docker 容器的正确位置所需的组件。</p><p id="c1a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用以下内容创建一个 bash 脚本文件。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="19e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行该脚本，验证您可以运行 docker 容器，并使用以下命令访问已安装的驱动程序。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="5dc8" class="km kn iq mj b gy mn mo l mp mq">&gt; ./configure_nvidia_gpu.sh</span><span id="a119" class="km kn iq mj b gy mr mo l mp mq">&gt; sudo docker run --privileged -v /var/lib/nvidia-docker/volumes/nvidia_driver/latest:/usr/local/nvidia nvidia/cuda:8.0-cudnn6-devel nvidia-smi</span></pre><p id="f801" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该得到类似于下面的输出。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/271813fa86dae6a791d1a5f97632b707.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vyWmrHdpC8A2iMsAHzduSg.png"/></div></div></figure><p id="58e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">删除实例上的 docker 容器和映像，以减小 AMI 的大小。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="12e6" class="km kn iq mj b gy mn mo l mp mq">&gt; sudo docker rm $(sudo docker ps -aq)<br/>&gt; sudo docker rmi $(sudo docker images -q)</span></pre><p id="3e69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">从实例中创建 AMI</strong></p><ol class=""><li id="1422" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk mz lq lr ls bi translated">首先，创建图像的快照。可以参考这里<a class="ae kl" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS C2/latest/user guide/EBS-creating-snapshot . html</a>。</li><li id="2938" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk mz lq lr ls bi translated">从 EC2 仪表板中选择您的实例，并选择<strong class="jp ir">操作</strong>、<strong class="jp ir">图像</strong>、<strong class="jp ir">创建图像</strong>。</li><li id="fbef" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk mz lq lr ls bi translated">如下填写字段(我已经将快照 ID 和实例 Id 变白)。</li></ol><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi na"><img src="../Images/590814fc5ca81c35be02c58a5ae18ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sKB4qFik7LmrG3rwvfxicA.png"/></div></div></figure><p id="2c88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.单击创建图像。</p><p id="5242" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您的 ami 现在应该显示在 AMIs 部分。状态变为可用可能需要一段时间。</p><h1 id="bb24" class="nb kn iq bd ko nc nd ne kr nf ng nh ku ni nj nk kx nl nm nn la no np nq ld nr bi translated">设置 AWS 批</h1><p id="fa9f" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated"><strong class="jp ir">先决条件</strong></p><ol class=""><li id="c2ef" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk mz lq lr ls bi translated">创建 AWS 批处理服务角色。参考<a class="ae kl" href="https://docs.aws.amazon.com/batch/latest/userguide/service_IAM_role.html" rel="noopener ugc nofollow" target="_blank">这里的</a>获取信息。</li><li id="b6ba" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk mz lq lr ls bi translated">创建一个 ecsInstanceRole。参考<a class="ae kl" href="https://docs.aws.amazon.com/batch/latest/userguide/instance_IAM_role.html" rel="noopener ugc nofollow" target="_blank">此处的</a>获取信息。</li><li id="c8a2" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk mz lq lr ls bi translated">创建一个 EC2SpotFleetRole。参考<a class="ae kl" href="https://docs.aws.amazon.com/batch/latest/userguide/spot_fleet_IAM_role.html" rel="noopener ugc nofollow" target="_blank">此处</a>获取信息。</li><li id="583b" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk mz lq lr ls bi translated">创建一个 EC2 密钥对。参考<a class="ae kl" href="https://docs.aws.amazon.com/batch/latest/userguide/get-set-up-for-aws-batch.html#create-a-key-pair" rel="noopener ugc nofollow" target="_blank">此处</a>获取信息。</li><li id="7a47" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk mz lq lr ls bi translated">创建一个 EC2ContainerServiceTask 角色，并为其附加一个 AmazonS3FullAccess 策略。</li></ol><p id="6fc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS 批处理可以通过 GUI 或命令行设置。我们将通过命令行完成设置过程。如果你想通过图形用户界面来设置它，请遵循这里的教程<a class="ae kl" href="https://docs.aws.amazon.com/batch/latest/userguide/Batch_GetStarted.html" rel="noopener ugc nofollow" target="_blank">并填写下面给出的信息。</a></p><p id="3bf4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建计算环境</strong></p><p id="8755" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个 JSON 文件来指定计算环境的各种属性。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="e067" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">类型</strong>:我们选择 managed，因为我们希望 AWS Batch 负责调度和管理资源。</p><p id="583a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">状态</strong>:表示您现在是否想要激活。我们将其设置为 enabled。</p><p id="ebaa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">计算资源:</strong></p><ul class=""><li id="3dbf" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated"><strong class="jp ir">类型</strong>:现场实例或按需实例。选择 spot 实例以降低成本。</li><li id="23ea" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated">这是你在上面创建的舰队角色的 arn。</li></ul><p id="c640" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提示:您可以使用 cli 获取您的角色的 arn，如下所示。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="e04c" class="km kn iq mj b gy mn mo l mp mq">&gt; aws iam get-role --role-name aws-batch-spot-fleet-role --query 'Role.Arn' --output text</span></pre><ul class=""><li id="508e" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated">minvCpus :不管作业需求如何，要维护的虚拟 CPU 的最小数量。为了节省成本，我们将其设置为零。</li><li id="4ef6" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> maxvCpus </strong>:我们希望作业运行的虚拟 CPU 的最大数量。</li><li id="9838" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> desiredvCpus </strong>:计算环境在启动时应该拥有的虚拟 CPU 的数量。随着需求的增加或减少，AWS 批次的数量将在最大值和最小值之间进行调整。</li><li id="2ff1" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">实例类型</strong>:要启动的 EC2 实例的类型。我们将把它设置为 p2.xlarge(我们用来创建 AMI 的同一个实例)。</li><li id="b48a" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> bidPercentage </strong>:实例启动前，现货实例价格与该实例类型的按需价格相比必须达到的最大百分比。</li><li id="3b89" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">子网:</strong>要在其中运行批处理实例的虚拟私有云(VPC)子网。</li></ul><p id="8506" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提示:您可以从 cli 查询您的子网 id，如下所示:</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="7704" class="km kn iq mj b gy mn mo l mp mq">&gt; aws ec2 describe-subnets</span></pre><ul class=""><li id="0813" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated"><strong class="jp ir">security groupid:</strong>您希望应用到您的实例的安全组的标识符，例如 SSH 访问。</li></ul><p id="340e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提示:您可以从 cli 查询您的安全组 id，如下所示。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="4f06" class="km kn iq mj b gy mn mo l mp mq">&gt; aws ec2 describe-security-groups</span></pre><ul class=""><li id="010d" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated"><strong class="jp ir"> ec2KeyPair: </strong>用于 SSH 进入实例。将其设置为您在上面创建的值。</li><li id="04c5" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> instanceRole </strong>:将其设置为您在上面创建的角色的名称。</li></ul><p id="d1a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> serviceRole: </strong>将其设置为您在上面创建的角色的名称。</p><p id="0a16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令创建计算环境。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="642f" class="km kn iq mj b gy mn mo l mp mq">&gt; aws batch create-compute-environment --cli-input-json file://&lt;path_to_json_file&gt;/compute_environment_spec.json</span></pre><p id="2832" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会得到类似下面的输出。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ns"><img src="../Images/e02f34dd5709b42f780d617b03226df0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LxC5RACByUfJlb5BuWuuRA.png"/></div></div></figure><p id="2ad1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建作业队列</strong></p><p id="3ad7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个 JSON 文件来指定作业队列参数。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="62c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> jobQueueName: </strong>作业队列的名称。</p><p id="f9dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">状态:</strong>表示您希望它现在激活。我们将其设置为 enabled。</p><p id="8a0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">优先级:</strong>当与相同的计算环境相关联时，优先级参数具有较高整数值的作业队列首先被评估。我们使用单独的计算环境进行培训，因此我们只将其设置为 1。</p><p id="4317" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">计算环境清单:</strong></p><ul class=""><li id="3256" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated"><strong class="jp ir">顺序:</strong>作业调度器使用该参数来确定哪个计算环境应该执行给定的作业。</li><li id="8b20" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">计算环境:</strong>计算环境的名称。</li></ul><p id="94ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令创建作业队列。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="27a6" class="km kn iq mj b gy mn mo l mp mq">&gt; aws batch create-job-queue --cli-input-json file://&lt;path_to_json_file&gt;/job_queue_spec.json</span></pre><p id="d6dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出应该如下所示。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nt"><img src="../Images/b0f090a7caf0f29ac4c86522fbe806e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kbcTYy7IZqfSLhaqry7D6g.png"/></div></div></figure><p id="2d5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">登记工作定义</strong></p><p id="4605" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个 JSON 文件来指定作业定义参数。</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="3a2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">作业定义名称:</strong>作业定义的名称。</p><p id="c544" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">类型:</strong>作业的类型。目前只支持容器类型。</p><p id="c002" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">容器属性:</strong></p><ul class=""><li id="f18b" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated"><strong class="jp ir">图片:</strong>你上面创建的 docker 图片的标签。</li><li id="041c" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">vcpu:</strong>工作所需的 vcpu 数量。</li><li id="92bc" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">内存:</strong>作业所需的内存。</li><li id="597e" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> jobRoleArn: </strong>您在上面创建的 EC2ContainerServiceTask 角色的 Arn。</li><li id="2018" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">卷:</strong>传递给 docker 守护进程的卷。</li><li id="6bf5" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">主机:</strong>数据卷在容器上的位置。我们将把它指向我们在 AMI 上安装的 NVIDIA 驱动程序。</li><li id="5445" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">名称:</strong>卷的名称。</li><li id="41f4" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">挂载点:</strong>容器中卷的挂载点。</li><li id="538b" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> containerPath: </strong>容器上装载主机卷的路径。</li><li id="799a" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> sourceVolume: </strong>上面提到的源卷的名称。</li><li id="08bb" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir"> privileged: </strong>这赋予容器在主机容器实例上的根特权。</li><li id="15c2" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">重试策略:</strong>重试失败作业的策略。</li><li id="05ac" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><strong class="jp ir">尝试次数:</strong>运行作业的尝试次数。我们将它设置为 1，这表示如果失败就不会重试。</li></ul><p id="5a88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下命令创建作业定义。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="7450" class="km kn iq mj b gy mn mo l mp mq">&gt; aws batch register-job-definition --cli-input-json file://&lt;path_to_json_file&gt;/job_definition_spec.json</span></pre><p id="3594" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">输出应该如下所示。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nu"><img src="../Images/ddf6a8467521a23456254ca513484971.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocrFm82n2c_T7tVpwk_13w.png"/></div></div></figure><p id="b943" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">设置代码</strong></p><ol class=""><li id="225f" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk mz lq lr ls bi translated">在 Tensorflow 代码文件夹中创建运行脚本，如下所示</li></ol><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="3ae0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">$ SCRIPT _ DIR:S3 目录路径，包含运行培训的所有脚本。</p><p id="f0e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">$MODEL_DIR:存储检查点的 s3 目录路径。</p><p id="4ac7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">$EXPORT_PATH:保存训练好的模型的 s3 目录路径。</p><p id="4ccf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">$TRAINING_DATA:包含训练数据的 CSV 的 s3 路径。</p><p id="4ff4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">$TEST_DATA:包含测试数据的 CSV 的 s3 路径。</p><p id="3aed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">批处理作业将通过环境变量传递这些变量的值。</p><p id="ad0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.将您的 Tensorflow 代码、训练数据和测试数据上传到 s3 中的文件夹。(样本训练代码和数据可参考 https://github.com/vigbk/tensorflow-ami-example<a class="ae kl" href="https://github.com/vigbk/tensorflow-ami-example" rel="noopener ugc nofollow" target="_blank">的</a></p><p id="137a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">运行批处理作业</strong></p><p id="4e19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建以下 JSON 来指定批处理作业参数</p><figure class="ly lz ma mb gt mc"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="f92b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按如下方式运行批处理作业。</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="1490" class="km kn iq mj b gy mn mo l mp mq">aws batch submit-job --cli-input-json file://&lt;path_to_json_file&gt;/batch_job_spec.json</span></pre><p id="7099" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作业输出应该如下所示。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nv"><img src="../Images/af575311c6d515cebbd9c36696469904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jmaigOxoIlb7yg2V946kAQ.png"/></div></div></figure><p id="cdec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过 Amazon CloudWatch 控制台查看您的作业日志，或者使用以下命令从 cli 获取它</p><pre class="ly lz ma mb gt mi mj mk ml aw mm bi"><span id="3a05" class="km kn iq mj b gy mn mo l mp mq">&gt; aws logs get-log-events --log-group-name /aws/batch/job --log-stream-name TrainModel/default/876da822-4198-45f2-a252-6cea32512ea8--query events[*].message --limit 100</span></pre><h2 id="8fea" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">这就是所有的人…</h2><p id="9df6" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">有许多即插即用的解决方案可以在云中使用 Tensorflow 管理培训，但我希望这篇文章能够让您了解如何定制 Tensorflow 培训，从而在不牺牲性能的情况下降低成本。</p><p id="5431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，请随意点击“鼓掌”按钮👏帮助其他人找到它。</p><p id="df51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">参考文献:- </strong></p><ul class=""><li id="d7f9" class="lk ll iq jp b jq jr ju jv jy mf kc mg kg mh kk lp lq lr ls bi translated"><a class="ae kl" href="https://docs.aws.amazon.com/batch/latest/userguide/batch-gpu-ami.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/batch/latest/user guide/batch-GPU-ami . html</a></li><li id="2461" class="lk ll iq jp b jq lt ju lu jy lv kc lw kg lx kk lp lq lr ls bi translated"><a class="ae kl" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/install-nvidia-driver.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS C2/latest/user guide/install-NVIDIA-driver . html</a></li></ul><p id="37b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nw">我是啰嗦的项目维护者之一，这是一个数据转换库。帮助我们在 GitHub 上宣传这个项目:</em><a class="ae kl" href="https://github.com/productml/blurr" rel="noopener ugc nofollow" target="_blank"><em class="nw">https://github.com/productml/blurr</em></a></p></div></div>    
</body>
</html>