<html>
<head>
<title>TensorFlow + Jupyter Notebook + Nvidia DIY Setup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TensorFlow + Jupyter笔记本+ Nvidia DIY设置</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tensorflow-jupyter-notebook-nvidia-diy-setup-473acfe5b0e?source=collection_archive---------2-----------------------#2017-08-29">https://towardsdatascience.com/tensorflow-jupyter-notebook-nvidia-diy-setup-473acfe5b0e?source=collection_archive---------2-----------------------#2017-08-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2038a66f2dac7767a0d2ed98a41bb892.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*By8YS3p0DAFLA27Phy-A9w.png"/></div></div></figure><p id="e69c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">基于我的<a class="ae kw" href="https://medium.com/@hongcheng79/my-first-step-for-deep-learning-adventure-with-udacity-and-coursera-ee135042ac1e" rel="noopener">第一个故事</a>，更详细的使用Xbuntu / Ubuntu 17.04的逐步设置。请注意，我们将使用拥有sudo权限的用户，而不是直接拥有root权限的用户。</p><h1 id="4dd4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Nvidia驱动程序设置</h1><p id="10af" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">安装Nvidia驱动程序库</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="0a51" class="mj ky iq mf b gy mk ml l mm mn">sudo add-apt-repository ppa:graphics-drivers/ppa<br/>sudo apt-get update  <br/>sudo apt-get upgrade  <br/>sudo apt-get install build-essential cmake g++ gfortran git pkg-config python-dev software-properties-common wget</span></pre><p id="6bce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<a class="ae kw" href="https://developer.nvidia.com/cuda-toolkit" rel="noopener ugc nofollow" target="_blank"> Nvidia </a>安装CUDA 8.0，获得基础安装程序和补丁2。CUDA也将安装nvidia驱动程序，相应地专门针对CUDA版本</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/f70ebd09e1fda22c97ce38ff6c10b8b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uVtnzl2g738zH2wI4mlrlQ.png"/></div></div></figure><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="4a85" class="mj ky iq mf b gy mk ml l mm mn">sudo dpkg -i cuda-repo-ubuntu1<!-- -->604-8-0-local-*amd64.deb<br/>sudo apt-get update<br/>sudo apt-get install cuda</span></pre><p id="78ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为本地用户设置CUDA环境</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="53dc" class="mj ky iq mf b gy mk ml l mm mn">echo 'export PATH=/usr/local/cuda/bin:$PATH' &gt;&gt; ~/.bashrc<br/>echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' &gt;&gt; ~/.bashrc<br/>source ~/.bashrc</span></pre><p id="fdf0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用测试它</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="ad75" class="mj ky iq mf b gy mk ml l mm mn">nvcc -V</span></pre><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/f804df6cfc9909d9834cf282369a4572.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*MRG7YGoyBu3K-zOS35U3SQ.png"/></div></figure><p id="6fd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后安装cuDNN，从<a class="ae kw" href="https://developer.nvidia.com/cudnn" rel="noopener ugc nofollow" target="_blank"> Nvidia </a>获取，这个是后面给Tensorflow的。为当前安装的CUDA获取正确的版本</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/5943b473940aa1d6d211d34365a5507f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNGbPfBo_ng0OLu5AXThJQ.png"/></div></div></figure><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="8f02" class="mj ky iq mf b gy mk ml l mm mn">cd ~/Downloads/<br/>tar xvf cudnn*.tgz<br/>cd cuda<br/>sudo cp */*.h /usr/local/cuda/include/<br/>sudo cp */libcudnn* /usr/local/cuda/lib64/<br/>sudo chmod a+r /usr/local/cuda/lib64/libcudnn*</span></pre><h1 id="03a0" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Anaconda设置</h1><p id="937b" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">使用Python 3.6从<a class="ae kw" href="https://www.anaconda.com/download/" rel="noopener ugc nofollow" target="_blank"> Anaconda </a>获取安装程序，并遵循安装说明</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="eb20" class="mj ky iq mf b gy mk ml l mm mn">cd ~/Downloads/<br/>bash Anaconda3-4.4.0-Linux-x86_64.sh</span></pre><p id="9139" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通常我会将Anaconda安装在/opt文件夹下。</p><p id="f5cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果安装在主文件夹下，我们需要在激活环境后找到环境文件夹</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b9fa" class="mj ky iq mf b gy mk ml l mm mn">source activate tf-gpu<br/>echo $PATH</span></pre><figure class="ma mb mc md gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/fcf4f8dac0a9cf14015c6b6be3dfb243.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7kEOsIdkHI-K6oa1Dy9Ltw.png"/></div></figure><p id="877b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这对以后设置Jupyter笔记本很重要。</p><h1 id="c253" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">TensorFlow设置</h1><p id="9b42" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">一旦我们安装了Anaconda，我们将为Jupyter设置创建一个环境，并安装<a class="ae kw" href="https://www.tensorflow.org/install/install_linux" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a> GPU</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="7673" class="mj ky iq mf b gy mk ml l mm mn">conda create --name tf-gpu python=3.6<br/>source activate tf-gpu<br/>pip install --ignore-installed --upgrade https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-1.3.0-cp36-cp36m-linux_x86_64.whl</span></pre><h1 id="5997" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Jupyter设置</h1><p id="7cd3" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">一旦我们安装了TensorFlow，我们将安装Jupyter，我们将使用conda来管理Jupyter笔记本和shell运行时的包</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="8ba7" class="mj ky iq mf b gy mk ml l mm mn">conda install jupyter notebook numpy pandas matplotlib</span></pre><h1 id="88b6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">DDNS设置</h1><p id="f448" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">安装任何ddns客户端能够更新域，所以我们可以连接回我们的家庭服务器。我们可以为此使用<a class="ae kw" href="https://www.noip.com/free" rel="noopener ugc nofollow" target="_blank"> NoIP </a>，它有<a class="ae kw" href="http://www.noip.com/support/knowledgebase/installing-the-linux-dynamic-update-client/" rel="noopener ugc nofollow" target="_blank"> linux客户端</a>来更新域。</p><h1 id="bc9e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">NGINX设置</h1><p id="9bcf" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">确保我们在使用<a class="ae kw" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> letsencrypt </a>之前停止当前的nginx，而不是购买SSL证书，因为我在节约成本</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="f99d" class="mj ky iq mf b gy mk ml l mm mn">sudo systemctl stop nginx</span></pre><p id="83aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦NGINX停止，我们可以运行初始的letsencrypt命令，该命令将使它自己的内部服务器脱离验证过程</p><p id="8124" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用命令克隆letsencrypt，然后设置初始证书</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="9974" class="mj ky iq mf b gy mk ml l mm mn">sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt</span><span id="a4e8" class="mj ky iq mf b gy ms ml l mm mn">sudo -H /opt/letsencrypt/letsencrypt-auto certonly --<a class="ae kw" href="mailto:email=me@chclab.net" rel="noopener ugc nofollow" target="_blank">email=me@chclab.net</a> -d deeplearning.chclab.net -d jupyter-cpu.chclab.net -d jupyter-nvidia.chclab.net -d monitor.chclab.net</span></pre><p id="3f90" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置cron作业以运行证书续订过程</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="3261" class="mj ky iq mf b gy mk ml l mm mn">0 0 * * *   /opt/letsencrypt/letsencrypt-auto renew --quiet</span></pre><p id="474c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在~/start-tf-jupyter-gpu.sh创建一个shell脚本来启动Jupyter Notebook，这将使用我们之前设置的名为tf-gpu的conda环境。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2237" class="mj ky iq mf b gy mk ml l mm mn">#!/bin/bash<br/>export PATH=/home/chc/.conda/envs/tf-gpu/bin:$PATH<br/>/home/chc/.conda/envs/tf-gpu/bin/jupyter notebook --no-browser --NotebookApp.allow_origin='*' --notebook-dir='/home/chc/project' --NotebookApp.port=9999</span></pre><p id="6621" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下命令保护Jupyter笔记本，更多信息请点击<a class="ae kw" href="http://jupyter-notebook.readthedocs.io/en/latest/public_server.html#securing-a-notebook-server" rel="noopener ugc nofollow" target="_blank">此链接</a></p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="3fad" class="mj ky iq mf b gy mk ml l mm mn">jupyter notebook --generate-config<br/>jupyter notebook password</span></pre><p id="27fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<strong class="ka ir">sudo VI/etc/systemd/system/jupyter-GPU . service</strong>创建一个Systemctl服务</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="4d3d" class="mj ky iq mf b gy mk ml l mm mn">[Unit]<br/>Description=Service for jupyter cpu notebook<br/>After=local-fs.target network.target</span><span id="fc13" class="mj ky iq mf b gy ms ml l mm mn">[Service]<br/>Type=simple<br/>User=chc<br/>Group=chc<br/>ExecStart=/home/chc/start-tf-jupyter-gpu.sh<br/>Restart=always<br/>SyslogIdentifier=jupyter cpu notebook</span><span id="b917" class="mj ky iq mf b gy ms ml l mm mn">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="fa83" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">启用该服务并尝试运行它</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="114d" class="mj ky iq mf b gy mk ml l mm mn">sudo systemctl daemon-reload<br/>sudo systemctl enable jupyter-gpu.service<br/>sudo systemctl start jupyter-gpu.service<br/>sudo systemctl status jupyter-gpu.service</span></pre><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/dcaf693c89b826adb5ce289f82619c9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PliZHOUr0-w2SFYiE31ZuA.png"/></div></div></figure><p id="0ed3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装NGINX</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6ebc" class="mj ky iq mf b gy mk ml l mm mn">sudo apt-get install nginx</span></pre><p id="d34e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置以下NGINX，对我来说是<strong class="ka ir">sudo VI/etc/NGINX/conf . d/jupyter-NVIDIA . chc lab . net . conf</strong></p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2eca" class="mj ky iq mf b gy mk ml l mm mn">upstream notebook-tensorflow {<br/>        server localhost:9999;<br/>}<br/>server {<br/>        server_name jupyter-nvidia.chclab.net;<br/>        listen 443 ssl;<br/>        access_log off;</span><span id="6965" class="mj ky iq mf b gy ms ml l mm mn">ssl_certificate /etc/letsencrypt/live/deeplearning.chclab.net-0001/fullchain.pem;<br/>        ssl_certificate_key /etc/letsencrypt/live/deeplearning.chclab.net-0001/privkey.pem;</span><span id="459d" class="mj ky iq mf b gy ms ml l mm mn">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br/>        ssl_prefer_server_ciphers on;<br/>        ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";<br/>        ssl_ecdh_curve secp384r1;<br/>        ssl_session_cache shared:SSL:10m;<br/>        ssl_session_tickets off;<br/>        ssl_stapling on;<br/>        ssl_stapling_verify on;<br/>        resolver 8.8.8.8 8.8.4.4 valid=300s;<br/>        resolver_timeout 5s;<br/>        # disable HSTS header for now<br/>        #add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";<br/>        add_header X-Frame-Options DENY;<br/>        add_header X-Content-Type-Options nosniff;</span><span id="8114" class="mj ky iq mf b gy ms ml l mm mn">ssl_dhparam /etc/ssl/certs/dhparam.pem;</span><span id="9b50" class="mj ky iq mf b gy ms ml l mm mn">location / {<br/>            proxy_pass            <a class="ae kw" href="http://notebook-tensorflow" rel="noopener ugc nofollow" target="_blank">http://notebook-tensorflow</a>;<br/>            proxy_set_header      Host $host;<br/>        }</span><span id="3659" class="mj ky iq mf b gy ms ml l mm mn">location ~ /api/kernels/ {<br/>            proxy_pass            <a class="ae kw" href="http://notebook-tensorflow" rel="noopener ugc nofollow" target="_blank">http://notebook-tensorflow</a>;<br/>            proxy_set_header      Host $host;<br/>            # websocket support<br/>            proxy_http_version    1.1;<br/>            proxy_set_header      Upgrade "websocket";<br/>            proxy_set_header      Connection "Upgrade";<br/>            proxy_read_timeout    86400;<br/>        }<br/>        location ~ /terminals/ {<br/>            proxy_pass            <a class="ae kw" href="http://notebook-tensorflow" rel="noopener ugc nofollow" target="_blank">http://notebook-tensorflow</a>;<br/>            proxy_set_header      Host $host;<br/>            # websocket support<br/>            proxy_http_version    1.1;<br/>            proxy_set_header      Upgrade "websocket";<br/>            proxy_set_header      Connection "Upgrade";<br/>            proxy_read_timeout    86400;<br/>        }<br/>}</span></pre><p id="d627" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生成一个强dhparam文件</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="da04" class="mj ky iq mf b gy mk ml l mm mn">openssl dhparam -out /etc/ssl/certs/dhparam.pem 4096</span></pre><p id="1755" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重启NGINX</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="7dce" class="mj ky iq mf b gy mk ml l mm mn">sudo systemctl restart nginx</span></pre><p id="c919" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后是使用Jupyter笔记本的样子</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/6f26da97c622e8e0e7a0a97b69c49ddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9duYcySmv90j-66VabPvaQ.png"/></div></div></figure></div></div>    
</body>
</html>