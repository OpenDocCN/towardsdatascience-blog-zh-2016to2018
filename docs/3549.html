<html>
<head>
<title>How to train Machine Learning models in the cloud using Cloud ML Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用云 ML 引擎在云端训练机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-train-machine-learning-models-in-the-cloud-using-cloud-ml-engine-3f0d935294b3?source=collection_archive---------1-----------------------#2018-05-23">https://towardsdatascience.com/how-to-train-machine-learning-models-in-the-cloud-using-cloud-ml-engine-3f0d935294b3?source=collection_archive---------1-----------------------#2018-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f3fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以及如何使用 docopt 包巧妙地编写一个<code class="fe kl km kn ko b">task.py</code></p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/811ba8977c7a4991cbf6ba8fa4b876d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3_oq3tEmuUBgvp1W."/></div></div></figure><p id="24c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在云中训练 ML 模型很有意义。为什么？在许多原因中，它允许你用大量的计算训练大量的数据，并且可能并行训练许多模型。加上也不难做！在 Google 云平台上，可以使用 Cloud ML Engine 在 TensorFlow 和其他 Python ML 库中(如 scikit-learn)训练机器学习模型，而无需管理任何基础设施。为了做到这一点，你需要将你的代码放入一个 Python 包中(即添加<code class="fe kl km kn ko b">setup.py</code>和<code class="fe kl km kn ko b">__init__.py</code>文件)。此外，将您的代码组织成一个<code class="fe kl km kn ko b">model.py</code>和<code class="fe kl km kn ko b">task.py</code>是一个最佳实践。在这篇博文中，我将带你一步一步地了解这涉及到什么。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lb"><img src="../Images/f7487437219114f8e5cac27788e4ca36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2185PkdnkS-e-jNWGC3Hpw.png"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk"><em class="lg">Submitting a job to ML Engine. The file </em><code class="fe kl km kn ko b"><em class="lg">task.py</em></code><em class="lg"> is the file actually executed by ML Engine and it references the model logic located in </em><code class="fe kl km kn ko b"><em class="lg">model.py</em></code><em class="lg">.</em></figcaption></figure><p id="97e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"/><code class="fe kl km kn ko b"><strong class="jp ir">task.py</strong></code><strong class="jp ir">文件</strong></p><p id="b6aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一名教师，我看到学生，尤其是那些刚接触 Python 的学生，最先遇到的事情之一就是创建一个<code class="fe kl km kn ko b">task.py</code>文件。虽然这在技术上是可选的(见下文)，但强烈推荐，因为它允许你将超参数从模型逻辑中分离出来(位于<code class="fe kl km kn ko b">model.py</code>)。它通常是由 ML 引擎调用的实际文件，其目的有两个:</p><ol class=""><li id="def2" class="lh li iq jp b jq jr ju jv jy lj kc lk kg ll kk lm ln lo lp bi translated">读取和解析模型参数，如训练数据和输出模型的位置、隐藏层数、批量大小等。</li><li id="475e" class="lh li iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated">用所述参数调用位于<code class="fe kl km kn ko b">model.py</code>中的模型训练逻辑</li></ol><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lv lw l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk"><em class="lg">An example task.py file that parses command line arguments for training data location, batch size, hidden units, and the output location of the final model.</em></figcaption></figure><p id="98e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有许多不同的方法可以编写一个<code class="fe kl km kn ko b">task.py</code>文件——你甚至可以给它起不同的名字。事实上<code class="fe kl km kn ko b">task.py</code>和<code class="fe kl km kn ko b">model.py</code>约定仅仅是一个约定。我们本来可以称之为<code class="fe kl km kn ko b">task.py</code> <code class="fe kl km kn ko b">aReallyCoolArgument_parser.py </code>和<code class="fe kl km kn ko b">model.py</code> <code class="fe kl km kn ko b">very_deeeep_model.py</code>。</p><p id="7231" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们甚至可以将这两个实体合并到一个文件中，进行参数解析和训练模型。只要你把你的代码安排到一个 Python 包中(即它<a class="ae lx" href="https://python-packaging.readthedocs.io/en/latest/minimal.html" rel="noopener ugc nofollow" target="_blank">必须包含</a> <code class="fe kl km kn ko b">setup.py</code>和<code class="fe kl km kn ko b">__init__.py</code>)，ML 引擎就不会在意。但是，坚持在一个 trainer 文件夹中命名为<code class="fe kl km kn ko b">task.py</code>和<code class="fe kl km kn ko b">model.py</code>的两个文件的惯例(更多细节在下面),这两个文件分别存放您的参数解析和模型逻辑。</p><p id="9ae0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看<a class="ae lx" href="https://github.com/GoogleCloudPlatform/cloudml-samples" rel="noopener ugc nofollow" target="_blank">云 ML 示例</a>和<a class="ae lx" href="https://github.com/GoogleCloudPlatform/training-data-analyst" rel="noopener ugc nofollow" target="_blank">云 ML 培训</a>报告，了解使用云 ML 引擎的完整示例以及<code class="fe kl km kn ko b">model.py</code>和<code class="fe kl km kn ko b">task.py </code>文件的示例。</p><p id="f563" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用 docopt 编写干净</strong> <code class="fe kl km kn ko b"><strong class="jp ir">task.py</strong></code> <strong class="jp ir">文件</strong></p><p id="5762" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管许多人使用 argparse，这是用于解析命令行参数的标准 Python 库，但我更喜欢使用<a class="ae lx" href="https://github.com/docopt/docopt" rel="noopener ugc nofollow" target="_blank"> docopt </a>包来编写我的<code class="fe kl km kn ko b">task.py</code>文件。为什么？因为这是写一个<em class="ly">记载</em> <code class="fe kl km kn ko b">task.py</code>最简洁的方法。事实上，几乎你唯一需要写的就是你的程序的使用信息(即帮助信息),而 docopt 会处理剩下的事情。基于您在模块的 doc 字符串中编写的用法消息(Python 将调用这个<code class="fe kl km kn ko b">__doc__</code>)，您调用<code class="fe kl km kn ko b">docopt(__doc__)</code>，它根据您在 doc 字符串中指定的格式为您生成一个参数解析器。以下是上面使用 docopt 的示例:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="f489" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很不错，对吧？让我来分解一下。第一块代码是您的<code class="fe kl km kn ko b">task.py</code>的用法。如果您不带参数调用它或者错误地调用<code class="fe kl km kn ko b">task.py</code>,这将显示给用户。</p><p id="e8af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第<code class="fe kl km kn ko b">arguments = docopt(__doc__)</code>行从帮助字符串中解析用法模式(“用法:…”)和选项描述(以破折号“-”开头的行)，并确保程序调用与用法模式匹配。</p><p id="ca74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一部分将这些参数分配给<code class="fe kl km kn ko b">model.py</code>变量，然后执行训练和评估。</p><p id="82ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们运行一个任务。记住<code class="fe kl km kn ko b">task.py</code>是称为 Python 包的文件家族的一部分。在实践中，您将花大部分时间编写<code class="fe kl km kn ko b">model.py</code>文件，花一点时间创建<code class="fe kl km kn ko b">task.py file</code>，其余的基本上是样板文件。</p><pre class="kq kr ks kt gt lz ko ma mb aw mc bi"><span id="2717" class="md me iq ko b gy mf mg l mh mi">training_example # root directory<br/>   setup.py # says how to install your package<br/>   trainer # package name, “trainer” is convention<br/>      model.py<br/>      task.py<br/>      __init__.py # Python convention indicating this is a package</span></pre><p id="5e96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们使用的是 docopt，它不是标准库的一部分，我们必须将它添加到<code class="fe kl km kn ko b">setup.py</code>，所以我们在<code class="fe kl km kn ko b">setup.py</code>中插入了一个额外的行:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="fa89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将告诉 Cloud ML Engine 在我们向云提交作业时通过运行<code class="fe kl km kn ko b">pip install docopt</code>来安装 docopt。</p><p id="a924" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，一旦我们有了以上结构的文件，我们就可以向 ML 引擎提交一个作业。在我们这样做之前，让我们首先使用<code class="fe kl km kn ko b">python -m</code>和<code class="fe kl km kn ko b">ml-engine local predict</code>在本地测试我们的包。这两个步骤虽然是可选的，但可以帮助您在提交到云之前调试和测试包的功能。你通常在一个很小的数据集或非常有限的训练步骤上这样做。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lv lw l"/></div><figcaption class="lc ld gj gh gi le lf bd b be z dk">Before you train on the cloud, test your package locally to make sure there are no syntactic or semantic errors.</figcaption></figure><p id="97f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我们在本地测试了我们的模型，我们将使用<code class="fe kl km kn ko b">gcloud ml-engine jobs submit training</code>向 ML 引擎提交我们的作业</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="77a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这两行与我们的讨论相关:</p><pre class="kq kr ks kt gt lz ko ma mb aw mc bi"><span id="cce4" class="md me iq ko b gy mf mg l mh mi">— package-path=$(pwd)/my_model_package/trainer \<br/>— module-name trainer.task</span></pre><p id="2332" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一行表示我们包名的位置，我们总是称之为<code class="fe kl km kn ko b">trainer</code>(一个约定)。第二行表示，在培训师包中，我们将调用培训师包中的任务模块(<code class="fe kl km kn ko b">task.py</code>)。</p><p id="f610" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong></p><p id="8d9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过构建<code class="fe kl km kn ko b">task.py</code>,我们可以将超参数作为命令行参数来处理，这允许我们将模型逻辑从超参数中分离出来。一个重要的好处是，这使我们能够使用不同的参数轻松地并行启动多个作业，以确定最佳超参数集(我们甚至可以使用内置的<a class="ae lx" href="https://cloud.google.com/ml-engine/docs/tensorflow/using-hyperparameter-tuning" rel="noopener ugc nofollow" target="_blank">超参数调整</a>服务！).最后，docopt 包根据用户编写的用法字符串自动为我们的<code class="fe kl km kn ko b">task.py</code>文件生成一个解析器。</p><p id="4dbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！我希望这能清楚地说明如何提交一个 ML 引擎作业并构建一个<code class="fe kl km kn ko b">task.py</code>。如果你觉得这很有帮助，请留下你的掌声，让其他人也能发现。</p><p id="c34f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">附加资源</strong></p><ul class=""><li id="88d8" class="lh li iq jp b jq jr ju jv jy lj kc lk kg ll kk mj ln lo lp bi translated"><a class="ae lx" href="https://github.com/GoogleCloudPlatform/cloudml-samples" rel="noopener ugc nofollow" target="_blank">谷歌云 ML 样本</a></li><li id="19e5" class="lh li iq jp b jq lq ju lr jy ls kc lt kg lu kk mj ln lo lp bi translated"><a class="ae lx" href="https://github.com/GoogleCloudPlatform/training-data-analyst" rel="noopener ugc nofollow" target="_blank">谷歌云机器学习培训</a></li><li id="c322" class="lh li iq jp b jq lq ju lr jy ls kc lt kg lu kk mj ln lo lp bi translated"><a class="ae lx" href="https://cloud.google.com/ml-engine/docs/tensorflow/technical-overview" rel="noopener ugc nofollow" target="_blank">云 ML 引擎文档</a></li><li id="2cb7" class="lh li iq jp b jq lq ju lr jy ls kc lt kg lu kk mj ln lo lp bi translated"><a class="ae lx" href="https://github.com/docopt/docopt" rel="noopener ugc nofollow" target="_blank"> docopt 文档</a></li><li id="ae23" class="lh li iq jp b jq lq ju lr jy ls kc lt kg lu kk mj ln lo lp bi translated"><a class="ae lx" href="http://python-packaging.readthedocs.io/en/latest/minimal.html" rel="noopener ugc nofollow" target="_blank">封装一个 Python 模块</a></li></ul></div></div>    
</body>
</html>