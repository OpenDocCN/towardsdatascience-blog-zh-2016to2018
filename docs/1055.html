<html>
<head>
<title>Visualising temperatures in Amsterdam as a heatmap in R — Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将阿姆斯特丹的温度可视化为 R 中的热图—第一部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualising-temperatures-in-amsterdam-as-a-heatmap-in-r-part-i-7e1be1e251c0?source=collection_archive---------5-----------------------#2017-07-24">https://towardsdatascience.com/visualising-temperatures-in-amsterdam-as-a-heatmap-in-r-part-i-7e1be1e251c0?source=collection_archive---------5-----------------------#2017-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0085" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近在玩热图，决定用它来可视化阿姆斯特丹的温度数据。</p><p id="48d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">获取数据:</strong></p><p id="6513" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">荷兰皇家气象研究所(Koninklijk Nedarlands Meteorologisch Instituut in Dutch，或简称为<a class="ae kl" href="https://knmi.nl" rel="noopener ugc nofollow" target="_blank"> KNMI </a>)免费提供追溯到 20 世纪 50 年代的历史天气数据。你可以从他们的<a class="ae kl" href="http://www.knmi.nl/nederland-nu/klimatologie-metingen-en-waarnemingen" rel="noopener ugc nofollow" target="_blank">测量和观察页面</a>获得你选择的气象站的数据(荷兰语)。他们给出每小时和每天的读数。我从本页的<a class="ae kl" href="http://www.knmi.nl/nederland-nu/klimatologie/daggegevens" rel="noopener ugc nofollow" target="_blank">中获得了史基浦机场(气象站编号 240)的每日数据。</a></p><p id="94ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">阅读和理解数据:</strong></p><p id="ccfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">数据被格式化为 CSV 文件。前几行有用荷兰语和英语描述每个字段的解释。这些行没有任何注释字符(通常是#)作为前缀，所以我们在读取文件时会跳过它们。我们感兴趣的内容从第 48 行开始，即标题行。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="d1dc" class="kv kw iq kr b gy kx ky l kz la">t &lt;- read.csv('~/Downloads/etmgeg_240.txt', skip=47)<br/>str(t)</span><span id="3401" class="kv kw iq kr b gy lb ky l kz la">'data.frame': 24311 obs. of  41 variables:<br/> $ X..STN  : int  240 240 240 240 240 240 240 240 240 240 ...<br/> $ YYYYMMDD: int  19510101 19510102 19510103 19510104 19510105 19510106 19510107 19510108 19510109 19510110 ...<br/> $ DDVEC   : int  188 153 203 193 207 185 240 203 246 176 ...<br/> $ FHVEC   : int  77 41 15 77 82 57 134 77 67 51 ...<br/> $ FG      : int  87 41 21 77 87 62 144 82 72 62 ...<br/> $ FHX     : int  195 82 51 103 144 123 180 103 129 103 ...<br/> $ FHXH    : int  18 4 24 15 21 22 13 20 12 21 ...<br/> $ FHN     : int  41 10 0 51 36 0 62 51 21 26 ...<br/> $ FHNH    : int  24 21 3 1 24 3 24 1 24 3 ...<br/> $ FXX     : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ FXXH    : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ TG      : int  12 13 3 12 48 64 67 61 41 26 ...<br/> $ TN      : int  -13 7 -20 -7 18 46 58 36 6 -8 ...<br/> $ TNH     : int  1 4 9 6 1 4 24 2 24 5 ...<br/> $ TX      : int  26 18 16 19 84 86 86 70 63 61 ...<br/> $ TXH     : int  20 19 23 16 21 24 1 14 1 24 ...<br/> $ T10N    : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ T10NH   : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ SQ      : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ SP      : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ Q       : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ DR      : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ RH      : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ RHX     : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ RHXH    : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ PG      : int  9891 9876 10019 10098 10059 10043 10026 10084 10089 10090 ...<br/> $ PX      : int  9957 9923 10097 10114 10094 10087 10105 10115 10151 10148 ...<br/> $ PXH     : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ PN      : int  9837 9853 9931 10084 10030 9980 9957 10040 10034 10016 ...<br/> $ PNH     : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ VVN     : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ VVNH    : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ VVX     : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ VVXH    : int  NA NA NA NA NA NA NA NA NA NA ...<br/> $ NG      : int  7 8 6 7 8 8 8 7 5 5 ...<br/> $ UG      : int  90 93 94 94 95 89 82 93 89 89 ...<br/> $ UX      : int  98 98 100 97 100 100 94 97 96 95 ...<br/> $ UXH     : int  6 9 21 12 5 3 4 8 1 2 ...<br/> $ UN      : int  73 88 83 89 89 72 76 88 76 78 ...<br/> $ UNH     : int  20 1 12 8 14 23 16 17 14 12 ...<br/> $ EV24    : int  NA NA NA NA NA NA NA NA NA NA ...</span></pre><p id="b35a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们有各种各样的天气观测——尽管有些指标的读数不是每年都有的。越往过去走，数据越粗略。在我们的练习中，让我们从 2016 年的每日气温数据开始。<code class="fe lc ld le kr b">YYYYMMDD</code>是日期栏，而<code class="fe lc ld le kr b">TX</code>和<code class="fe lc ld le kr b">TN</code>栏分别包含最高和最低温度。温度以 0.1°C 为单位(例如，10°C 在本文件中显示为 100 ),因此我们将它们除以 10。</p><p id="bba7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">过滤和修改数据:</strong></p><p id="b137" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用<code class="fe lc ld le kr b">dplyr</code>包中的<code class="fe lc ld le kr b">filter</code>函数来过滤 2016 年的数据。然后我们将使用<code class="fe lc ld le kr b">select</code>函数来挑选我们需要的字段，并将这个子集分配给一个新的数据帧。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="7997" class="kv kw iq kr b gy kx ky l kz la">library(dplyr)<br/>t %&gt;% filter(YYYYMMDD &gt;= 20160101 &amp; YYYYMMDD &lt;= 20161231) %&gt;% select(YYYYMMDD, TN, TX) -&gt; t.2016</span></pre><p id="70f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将对此数据进行一些更改。每次观察的日期(<code class="fe lc ld le kr b">YYYYMMDD</code>列)存储为整数。我们将把它转换成一个适当的日期对象，然后把它分解成方便的单位——年、月、周、工作日和日——供以后使用。同时，我们也将温度除以 10。我们将使用<code class="fe lc ld le kr b">lubridate</code>包来处理日期。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="d9d4" class="kv kw iq kr b gy kx ky l kz la">library(lubridate)<br/>t.2016 %&gt;% mutate(<br/>    date = as.Date(as.character(YYYYMMDD), format="%Y%m%d"),<br/>    year = year(date),<br/>    month = month(date, label=T, abbr=T),<br/>    week = strftime(date,"%W"), <br/>    wday = substring(wday(date, label=T, abbr=T),1,2),<br/>    day = day(date),<br/>    TN = TN / 10,<br/>    TX = TX / 10<br/>) -&gt; t.2016<br/>head(t.2016)</span><span id="8f0c" class="kv kw iq kr b gy lb ky l kz la">  YYYYMMDD  TN  TX       date year month week wday day<br/>1 20160101 1.1 8.0 2016-01-01 2016   Jan   00   Fr   1<br/>2 20160102 4.6 6.5 2016-01-02 2016   Jan   00   Sa   2<br/>3 20160103 5.3 8.5 2016-01-03 2016   Jan   00   Su   3<br/>4 20160104 4.3 7.2 2016-01-04 2016   Jan   01   Mo   4<br/>5 20160105 4.4 7.7 2016-01-05 2016   Jan   01   Tu   5<br/>6 20160106 1.8 4.4 2016-01-06 2016   Jan   01   We   6</span></pre><p id="ab25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">可视化数据:</strong></p><p id="4d82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们首先尝试将最高温度可视化为热图。我们将使用<a class="ae kl" href="https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html" rel="noopener ugc nofollow" target="_blank">绿色</a>调色板来绘制热图。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="84e7" class="kv kw iq kr b gy kx ky l kz la">library(ggplot2)<br/>library(viridis)<br/>ggplot(data = t.2016, aes(x=day,y=month)) + geom_tile(aes(fill=TX)) + scale_fill_viridis()</span></pre><figure class="km kn ko kp gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lf"><img src="../Images/93d4fc76ff0e44cce9bce29a4841642e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PLV-urAz7b1jwxnvxG1H0g.png"/></div></div></figure><p id="ea79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以清楚地看到阿姆斯特丹夏季从 5 月到 9 月的延伸，7 月是一年中最热的一天，1 月和 12 月有几天非常冷。</p><p id="1967" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在将做一些更小的调整:</p><ol class=""><li id="2cd2" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">我们将在 x 轴上标记所有的日子，而不是让 ggplot 为我们选择一些东西。毕竟我们知道一个月不会超过 31 天。此时，我们将确保日期(x 轴)从 1 开始，而不是从 0 开始。我们还会将 y 轴向热图靠近一点。</li><li id="0238" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">因为这是最高温度，我想选择一个能唤起温暖的调色板。Viridis 有 3 个以上的调色板-岩浆，等离子和地狱，我们将选择岩浆主题来完成这项工作。</li><li id="f6bf" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">在上面的截图中，平铺看起来很漂亮，但是根据你的绘图窗口的大小，它们可能看起来被压扁了。我们将锁定图块，使其始终保持 1:1 的比例，而不考虑绘图窗口的宽度和高度。</li><li id="0961" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">最后，我们将使用不同的主题隐藏背景中的灰色网格。我是来自<a class="ae kl" href="https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html" rel="noopener ugc nofollow" target="_blank"> ggthemes </a>套装的塔夫特主题的粉丝。</li></ol><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="e45c" class="kv kw iq kr b gy kx ky l kz la"><strong class="kr ir">library(ggthemes)</strong><br/>ggplot(data = t.2016, aes(x = day,y = month)) + <br/>geom_tile(aes(fill = TX)) + <br/><strong class="kr ir">scale_x_continuous(breaks=c(1:31), expand=c(0,0))</strong> + <strong class="kr ir">coord_equal(ratio = 1) + <br/></strong>scale_fill_viridis(<strong class="kr ir">option="magma"</strong>) + <strong class="kr ir">theme_tufte(base_family="Helvetica")</strong></span></pre><figure class="km kn ko kp gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mb"><img src="../Images/6fd934b6195f1e17a0ee9f33483e9695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jGL3SALYr3-BA3Dm8N0sA.png"/></div></div></figure><p id="cb54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我个人认为岩浆主题会让夏季更加突出。</p><p id="177a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">链接:</strong></p><ol class=""><li id="e1aa" class="ln lo iq jp b jq jr ju jv jy lp kc lq kg lr kk ls lt lu lv bi translated">如果你喜欢<code class="fe lc ld le kr b">viridis</code>库，请务必阅读<a class="ae kl" href="https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html" rel="noopener ugc nofollow" target="_blank">插图</a>。我还发现小插曲中提到的<a class="ae kl" href="https://www.youtube.com/watch?list=PLYx7XA2nY5Gcpabmu61kKcToLz0FapmHu&amp;v=xAoljeRJ3lU" rel="noopener ugc nofollow" target="_blank"> SciPy2015 视频</a>很有教育意义。</li><li id="e543" class="ln lo iq jp b jq lw ju lx jy ly kc lz kg ma kk ls lt lu lv bi translated">我从 Bob Rudis 的这个帖子中学到了很多我在这里使用的技术。</li></ol><p id="186c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">接下来:</strong></p><p id="65ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然我对我们的进展很满意，但我们还可以利用一年的温度数据做更多的事情。在下一篇文章中，我将分享一种让热图看起来像真实日历的方法。</p><p id="7ce7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">更新:</strong> <a class="ae kl" href="https://medium.com/@deepak.gulati/visualising-temperatures-in-amsterdam-as-a-heatmap-in-r-part-ii-92db6b37a5e1" rel="noopener">第二部分现已更新</a>，两部分的<a class="ae kl" href="https://github.com/deepakg/heatmap" rel="noopener ugc nofollow" target="_blank">源代码也已更新</a>。</p></div></div>    
</body>
</html>