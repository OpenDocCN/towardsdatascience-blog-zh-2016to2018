<html>
<head>
<title>Machine Learning for Retail Price Recommendation with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 实现零售价格推荐的机器学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/machine-learning-for-retail-price-suggestion-with-python-64531e64186d?source=collection_archive---------0-----------------------#2018-07-23">https://towardsdatascience.com/machine-learning-for-retail-price-suggestion-with-python-64531e64186d?source=collection_archive---------0-----------------------#2018-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d398deb5a09d5251a957bc24c854e083.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NSbZQn86rz2DDvx1EGTlpg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo credit: Pexels</figcaption></figure><p id="b6a7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">日本最大的社区购物应用 Mercari 深刻地认识到一个问题。他们希望向卖家提供定价建议，但这很难，因为他们的卖家可以在 Mercari 的市场上出售任何东西或任何一捆东西。</p><p id="8e4e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这个机器学习项目中，我们将建立一个自动建议正确产品价格的模型。我们收到以下信息:</p><p id="3370" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">train_id —列表的 id</p><p id="dd90" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">名称—列表的标题</p><p id="a674" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">item_condition_id —卖家提供的物品的状况</p><p id="841f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">类别名称—列表的类别</p><p id="a834" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">品牌名称—品牌的名称</p><p id="6907" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">价格——物件的销售价格。这是我们将要预测的目标变量</p><p id="b2a8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运费—如果运费由卖方支付，则为 1，由买方支付，则为 0</p><p id="ecb7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">item_description —项目的完整描述</p><h1 id="1bf1" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">电子设计自动化(Electronic Design Automation)</h1><p id="7deb" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">数据集可以从<a class="ae la" href="https://www.kaggle.com/saitosean/mercari" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>下载。为了验证结果，我只需要 train.tsv。让我们开始吧！</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="2224" class="mn lc iq mj b gy mo mp l mq mr">import gc<br/>import time<br/>import numpy as np<br/>import pandas as pd<br/>import matplotlib.pyplot as plt<br/>import seaborn as sns<br/>from scipy.sparse import csr_matrix, hstack<br/>from sklearn.feature_extraction.text import CountVectorizer, TfidfVectorizer<br/>from sklearn.preprocessing import LabelBinarizer<br/>from sklearn.model_selection import train_test_split, cross_val_score<br/>from sklearn.metrics import mean_squared_error<br/>import lightgbm as lgb</span><span id="a3ac" class="mn lc iq mj b gy ms mp l mq mr">df = pd.read_csv('train.tsv', sep = '\t')</span></pre><p id="b119" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将数据随机分为训练集和测试集。我们只为 EDA 使用训练集。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="23fd" class="mn lc iq mj b gy mo mp l mq mr">msk = np.random.rand(len(df)) &lt; 0.8<br/>train = df[msk]<br/>test = df[~msk]</span><span id="df6b" class="mn lc iq mj b gy ms mp l mq mr">train.shape, test.shape</span></pre><p id="9c00" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt"> ((1185866，8)，(296669，8)) </em> </strong></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="afb4" class="mn lc iq mj b gy mo mp l mq mr">train.head()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/c6c3ed7470deb714246045e6dc8fde9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4zH2bpqx3M345vg14gY95Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 1</figcaption></figure><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4e07" class="mn lc iq mj b gy mo mp l mq mr">train.info()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/be7925badc9e0aca7493c80eb7ccec35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*JzI7SJyoRtxotqj19ulgDA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 2</figcaption></figure><h2 id="e3a2" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated"><strong class="ak">价格</strong></h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="332c" class="mn lc iq mj b gy mo mp l mq mr">train.price.describe()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/d90d836eef9c0279ec0f55d888030495.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*kwwsVaIJ7sElE3q8bLlmDQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 3</figcaption></figure><p id="fe07" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">项目的价格是右偏的，绝大多数项目的价格在 10-20 英镑。然而，2009 年定价最贵的项目。所以我们将对价格进行对数变换。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6e22" class="mn lc iq mj b gy mo mp l mq mr">plt.subplot(1, 2, 1)<br/>(train['price']).plot.hist(bins=50, figsize=(12, 6), edgecolor = 'white', range = [0, 250])<br/>plt.xlabel('price', fontsize=12)<br/>plt.title('Price Distribution', fontsize=12)</span><span id="2b1e" class="mn lc iq mj b gy ms mp l mq mr">plt.subplot(1, 2, 2)<br/>np.log(train['price']+1).plot.hist(bins=50, figsize=(12,6), edgecolor='white')<br/>plt.xlabel('log(price+1)', fontsize=12)<br/>plt.title('Price Distribution', fontsize=12)</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/16392c6261d5feb8d16322bf703879ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OnHWwWGv3D6rYQMwRQ875A.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 4</figcaption></figure><h2 id="6afa" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated">船舶</h2><p id="e08c" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">超过 55%的项目运费由买家支付。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5696" class="mn lc iq mj b gy mo mp l mq mr">train['shipping'].value_counts() / len(train)</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/485b642c54391cbd4f3a05482f9f11b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*95CW5i9kdEvpN4jKXq7asg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 5</figcaption></figure><p id="92ec" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">运费和价格有什么关系？</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4c03" class="mn lc iq mj b gy mo mp l mq mr">shipping_fee_by_buyer = train.loc[df['shipping'] == 0, 'price']<br/>shipping_fee_by_seller = train.loc[df['shipping'] == 1, 'price']</span><span id="2780" class="mn lc iq mj b gy ms mp l mq mr">fig, ax = plt.subplots(figsize=(18,8))<br/>ax.hist(shipping_fee_by_seller, color='#8CB4E1', alpha=1.0, bins=50, range = [0, 100],<br/>       label='Price when Seller pays Shipping')<br/>ax.hist(shipping_fee_by_buyer, color='#007D00', alpha=0.7, bins=50, range = [0, 100],<br/>       label='Price when Buyer pays Shipping')<br/>plt.xlabel('price', fontsize=12)<br/>plt.ylabel('frequency', fontsize=12)<br/>plt.title('Price Distribution by Shipping Type', fontsize=15)<br/>plt.tick_params(labelsize=12)<br/>plt.legend()<br/>plt.show()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/9681ac7b2fc148b5df9641295f600edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d_eAChv9eet_Kv4g4jIWQA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 6</figcaption></figure><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8a80" class="mn lc iq mj b gy mo mp l mq mr">print('The average price is {}'.format(round(shipping_fee_by_seller.mean(), 2)), 'if seller pays shipping');<br/>print('The average price is {}'.format(round(shipping_fee_by_buyer.mean(), 2)), 'if buyer pays shipping')</span></pre><p id="4b87" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">卖家支付运费的平均价格为 22.58</em></strong></p><p id="3d4d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">如果买家支付运费平均价格为 30.11</em></strong></p><p id="669b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们在价格上进行对数变换后再进行比较。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f7e8" class="mn lc iq mj b gy mo mp l mq mr">fig, ax = plt.subplots(figsize=(18,8))<br/>ax.hist(np.log(shipping_fee_by_seller+1), color='#8CB4E1', alpha=1.0, bins=50,<br/>       label='Price when Seller pays Shipping')<br/>ax.hist(np.log(shipping_fee_by_buyer+1), color='#007D00', alpha=0.7, bins=50,<br/>       label='Price when Buyer pays Shipping')<br/>plt.xlabel('log(price+1)', fontsize=12)<br/>plt.ylabel('frequency', fontsize=12)<br/>plt.title('Price Distribution by Shipping Type', fontsize=15)<br/>plt.tick_params(labelsize=12)<br/>plt.legend()<br/>plt.show()</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/12940b723bd78f5f8794b4a0960e56eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FkM1U7zRx8RG_lVKi9Vf-w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 7</figcaption></figure><p id="1f6e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">很明显，当买家支付运费时，平均价格会更高。</p><h2 id="bdc8" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated">类别名称</h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9769" class="mn lc iq mj b gy mo mp l mq mr">print('There are', train['category_name'].nunique(), 'unique values in category name column')</span></pre><p id="cedc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">类别名称列中有 1265 个唯一值</em> </strong></p><p id="b5de" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">十大最常见的类别名称:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="58b3" class="mn lc iq mj b gy mo mp l mq mr">train['category_name'].value_counts()[:10]</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/65f6192dbe5377555bf9ac888fab84c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JWNUIX2o4R8wos227VRBCQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 8</figcaption></figure><h2 id="cdab" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated"><strong class="ak">项目条件与价格</strong></h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9a70" class="mn lc iq mj b gy mo mp l mq mr">sns.boxplot(x = 'item_condition_id', y = np.log(train['price']+1), data = train, palette = sns.color_palette('RdBu',5))</span></pre><figure class="me mf mg mh gt jr gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/5d0f311d0c9be91da5fcb742f18a6291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*Lr5rmO3U_ZrL59zP1GQlBw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Figure 8</figcaption></figure><p id="fb32" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个项目条件 id 之间的平均价格似乎各不相同。</p><p id="13f0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">经过上述探索性的数据分析，我决定使用所有的功能来建立我们的模型。</p><h1 id="2b1a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">LightGBM</h1><p id="c081" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">在微软<strong class="ke ir">的<a class="ae la" href="https://www.microsoft.com/en-us/research/project/dmtk/" rel="noopener ugc nofollow" target="_blank"> DMTK </a>项目的保护下，</strong> <a class="ae la" href="https://github.com/Microsoft/LightGBM" rel="noopener ugc nofollow" target="_blank"> LightGBM </a>是一个使用基于树的学习算法的梯度推进框架。它被设计为分布式和高效的，具有以下优点:</p><ul class=""><li id="eb1e" class="no np iq ke b kf kg kj kk kn nq kr nr kv ns kz nt nu nv nw bi translated">训练速度更快，效率更高</li><li id="e2aa" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">更低的内存使用率</li><li id="33aa" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">更高的精确度</li><li id="7822" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">支持并行和 GPU 学习</li><li id="8b88" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">能够处理大规模数据</li></ul><p id="d64f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，我们打算试一试。</p><h2 id="4c4a" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated">常规设置:</h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ad05" class="mn lc iq mj b gy mo mp l mq mr">NUM_BRANDS = 4000<br/>NUM_CATEGORIES = 1000<br/>NAME_MIN_DF = 10<br/>MAX_FEATURES_ITEM_DESCRIPTION = 50000</span></pre><p id="7335" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们必须修复列中缺少的值:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="8edd" class="mn lc iq mj b gy mo mp l mq mr">print('There are %d items that do not have a category name.' %train['category_name'].isnull().sum())</span></pre><p id="8af2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">有 5083 个项目没有类别名称。</em>T3】</strong></p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6840" class="mn lc iq mj b gy mo mp l mq mr">print('There are %d items that do not have a brand name.' %train['brand_name'].isnull().sum())</span></pre><p id="135d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">有 506370 件商品没有品牌名称</em> </strong>。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5262" class="mn lc iq mj b gy mo mp l mq mr">print('There are %d items that do not have a description.' %train['item_description'].isnull().sum())</span></pre><p id="b04e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">有 3 项没有描述。</em>T11】</strong></p><p id="3e75" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">LightGBM 的帮助函数:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="61ba" class="mn lc iq mj b gy mo mp l mq mr">def handle_missing_inplace(dataset): <br/>    dataset['category_name'].fillna(value='missing', inplace=True) <br/>    dataset['brand_name'].fillna(value='missing', inplace=True) <br/>    dataset['item_description'].replace('No description yet,''missing', inplace=True) <br/>    dataset['item_description'].fillna(value='missing', inplace=True)</span><span id="f42e" class="mn lc iq mj b gy ms mp l mq mr">def cutting(dataset):<br/>    pop_brand = dataset['brand_name'].value_counts().loc[lambda x: x.index != 'missing'].index[:NUM_BRANDS]<br/>    dataset.loc[~dataset['brand_name'].isin(pop_brand), 'brand_name'] = 'missing'<br/>    pop_category = dataset['category_name'].value_counts().loc[lambda x: x.index != 'missing'].index[:NUM_CATEGORIES]</span><span id="65f0" class="mn lc iq mj b gy ms mp l mq mr">def to_categorical(dataset):<br/>    dataset['category_name'] = dataset['category_name'].astype('category')<br/>    dataset['brand_name'] = dataset['brand_name'].astype('category')<br/>    dataset['item_condition_id'] = dataset['item_condition_id'].astype('category')</span></pre><p id="1e47" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">删除价格= 0 的行</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="65dc" class="mn lc iq mj b gy mo mp l mq mr">df = pd.read_csv('train.tsv', sep = '\t')<br/>msk = np.random.rand(len(df)) &lt; 0.8<br/>train = df[msk]<br/>test = df[~msk]<br/>test_new = test.drop('price', axis=1)<br/>y_test = np.log1p(test["price"])</span><span id="a31c" class="mn lc iq mj b gy ms mp l mq mr">train = train[train.price != 0].reset_index(drop=True)</span></pre><p id="9e9e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">合并训练和新测试数据。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="2947" class="mn lc iq mj b gy mo mp l mq mr">nrow_train = train.shape[0]<br/>y = np.log1p(train["price"])<br/>merge: pd.DataFrame = pd.concat([train, test_new])</span></pre><h2 id="581c" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated">培训准备</h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="97ce" class="mn lc iq mj b gy mo mp l mq mr">handle_missing_inplace(merge)<br/>cutting(merge)<br/>to_categorical(merge)</span></pre><p id="46d8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">计数矢量化名称和类别名称列。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="f366" class="mn lc iq mj b gy mo mp l mq mr">cv = CountVectorizer(min_df=NAME_MIN_DF)<br/>X_name = cv.fit_transform(merge['name'])</span><span id="0fdd" class="mn lc iq mj b gy ms mp l mq mr">cv = CountVectorizer()<br/>X_category = cv.fit_transform(merge['category_name'])</span></pre><p id="27aa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">TF-IDF 矢量化 item_description 列。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e174" class="mn lc iq mj b gy mo mp l mq mr">tv = TfidfVectorizer(max_features=MAX_FEATURES_ITEM_DESCRIPTION, ngram_range=(1, 3), stop_words='english')<br/>X_description = tv.fit_transform(merge['item_description'])</span></pre><p id="4170" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">标签二进制 brand_name 列。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="24ba" class="mn lc iq mj b gy mo mp l mq mr">lb = LabelBinarizer(sparse_output=True)<br/>X_brand = lb.fit_transform(merge['brand_name'])</span></pre><p id="1703" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为 item_condition_id 和 shipping 列创建虚拟变量。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0fae" class="mn lc iq mj b gy mo mp l mq mr">X_dummies = csr_matrix(pd.get_dummies(merge[['item_condition_id', 'shipping']], sparse=True).values)</span></pre><p id="2943" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建稀疏合并。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="5206" class="mn lc iq mj b gy mo mp l mq mr">sparse_merge = hstack((X_dummies, X_description, X_brand, X_category, X_name)).tocsr()</span></pre><p id="43d9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">去除文档频率为&lt;=1.</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="6a4e" class="mn lc iq mj b gy mo mp l mq mr">mask = np.array(np.clip(sparse_merge.getnnz(axis=0) - 1, 0, 1), dtype=bool)<br/>sparse_merge = sparse_merge[:, mask]</span></pre><p id="70ad" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Separate train and test data from sparse merge.</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="9c26" class="mn lc iq mj b gy mo mp l mq mr">X = sparse_merge[:nrow_train]<br/>X_test = sparse_merge[nrow_train:]</span></pre><p id="15bc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Create dataset for lightgbm.</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="fd5c" class="mn lc iq mj b gy mo mp l mq mr">train_X = lgb.Dataset(X, label=y)</span></pre><p id="07a0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Specify our parameters as a dict.</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="745d" class="mn lc iq mj b gy mo mp l mq mr">params = {<br/>        'learning_rate': 0.75,<br/>        'application': 'regression',<br/>        'max_depth': 3,<br/>        'num_leaves': 100,<br/>        'verbosity': -1,<br/>        'metric': 'RMSE',<br/>    }</span></pre><ul class=""><li id="5bd0" class="no np iq ke b kf kg kj kk kn nq kr nr kv ns kz nt nu nv nw bi translated">Use ‘regression’ as application as we are dealing with a regression problem.</li><li id="0644" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">Use ‘RMSE’ as metric because this is a regression problem.</li><li id="5d07" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">“num_leaves”=100 as our data is relative big.</li><li id="09aa" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">Use “max_depth” to avoid overfitting.</li><li id="b4d4" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">Use “verbosity” to control the level of LightGBM’s verbosity (&lt;0: Fatal).</li><li id="e64f" class="no np iq ke b kf nx kj ny kn nz kr oa kv ob kz nt nu nv nw bi translated">“learning_rate” determines the impact of each tree on the final outcome.</li></ul><h2 id="76d7" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated">Training Start</h2><p id="f62b" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Training a model requires a parameter list and data set. And training will take a while.</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="3de7" class="mn lc iq mj b gy mo mp l mq mr">gbm = lgb.train(params, train_set=train_X, num_boost_round=3200, verbose_eval=100)</span></pre><h2 id="c816" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated">Predict</h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="af0a" class="mn lc iq mj b gy mo mp l mq mr">y_pred = gbm.predict(X_test, num_iteration=gbm.best_iteration)</span></pre><h2 id="a6e5" class="mn lc iq bd ld mw mx dn lh my mz dp ll kn na nb lp kr nc nd lt kv ne nf lx ng bi translated">Evaluation</h2><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="561d" class="mn lc iq mj b gy mo mp l mq mr">from sklearn.metrics import mean_squared_error<br/>print('The rmse of prediction is:', mean_squared_error(y_test, y_pred) ** 0.5)</span></pre><p id="2708" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="mt">的特征，预测的 rmse 为:0.46164222941613137 </em> </strong></p><p id="4cbd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">源代码可以在<a class="ae la" href="https://github.com/susanli2016/Machine-Learning-with-Python/blob/master/Mercari%20Price%20Suggestion%20Lightgbm.ipynb" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。祝你一周工作顺利！</p><p id="2596" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">参考:<a class="ae la" href="https://www.kaggle.com/tunguz/more-effective-ridge-lgbm-script-lb-0-44823" rel="noopener ugc nofollow" target="_blank">卡格尔</a></p></div></div>    
</body>
</html>