<html>
<head>
<title>Web Scraping, Regular Expressions, and Data Visualization: Doing it all in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Web 抓取、正则表达式和数据可视化:全部用 Python 完成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/web-scraping-regular-expressions-and-data-visualization-doing-it-all-in-python-37a1aade7924?source=collection_archive---------1-----------------------#2018-04-28">https://towardsdatascience.com/web-scraping-regular-expressions-and-data-visualization-doing-it-all-in-python-37a1aade7924?source=collection_archive---------1-----------------------#2018-04-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/f054ec253fa91f7ba57733715fcca48b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a_l-sgq5LB9jd-hDCMbvbg.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="63a9" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">一个学习三种无价数据科学技能的小型真实项目</h2></div><p id="4034" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">与大多数有趣的项目一样，这个项目以一个简单的问题开始，这个问题被半认真地问了一遍:我为我的大学校长的五分钟时间支付多少学费？在与我们学校的校长(<a class="ae lm" href="https://en.wikipedia.org/wiki/Case_Western_Reserve_University" rel="noopener ugc nofollow" target="_blank"> CWRU </a>)进行了一次偶然而愉快的讨论后，我想知道我的谈话到底花了我多少钱。</p><p id="ac3e" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我的搜索导致了<a class="ae lm" href="http://www.cleveland.com/metro/index.ssf/2017/12/case_western_reserve_university_president_barbara_snyders_base_salary_and_bonus_pay_tops_among_private_colleges_in_ohio.html" rel="noopener ugc nofollow" target="_blank">这篇文章</a>，它和我的校长的薪水一起，有一张显示俄亥俄州私立大学校长薪水的表格:</p><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/1a535e601560191aa563fa007cc26ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*zoekqzsEtDi9BCLmY-bfzQ.png"/></div></figure><p id="e036" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">虽然我可以为我的总统找到答案(剧透一下，是 48 美元/五分钟)，并且感到满意，但我想利用这张桌子进一步推广这个想法。我一直在寻找机会练习 Python 中的<a class="ae lm" href="https://en.wikipedia.org/wiki/Web_scraping" rel="noopener ugc nofollow" target="_blank">网页抓取</a>和<a class="ae lm" href="https://www.regular-expressions.info/tutorial.html" rel="noopener ugc nofollow" target="_blank">正则表达式</a>，并认为这是一个很棒的短期项目。</p><p id="5f7a" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">尽管在 Excel 中手动输入数据几乎肯定会更快，但我不会有宝贵的机会来练习一些技能！数据科学是关于使用各种工具解决问题的，web 抓取和正则表达式是我需要努力的两个领域(更不用说制作图表总是很有趣)。结果是一个非常短但完整的项目，展示了我们如何将这三种技术结合起来解决数据科学问题。</p><p id="8b36" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这个项目的完整代码可以在谷歌联合实验室的 Jupyter 笔记本上获得(这是我正在尝试的一项新服务，你可以在云端分享和合作 Jupyter 笔记本。感觉是未来！)要编辑笔记本，在 Colaboratory 中打开它，选择文件&gt;在驱动器中保存一份副本，然后您可以进行任何更改并运行笔记本。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="39db" class="lz ma jb bd mb mc md me mf mg mh mi mj kh mk ki ml kk mm kl mn kn mo ko mp mq bi translated">网页抓取</h1><p id="c18d" class="pw-post-body-paragraph kq kr jb ks b kt mr kc kv kw ms kf ky kz mt lb lc ld mu lf lg lh mv lj lk ll ij bi translated">虽然课堂和教科书中使用的大多数数据看起来都是现成的，格式简洁，但实际上，世界并没有这么美好。获取数据通常意味着弄脏我们的手，在这种情况下，从网上提取(也称为抓取)数据。Python 有很好的工具来完成这项工作，即用于从网页中检索内容的<code class="fe mw mx my mz b">requests</code>库，以及用于提取相关信息的<code class="fe mw mx my mz b">bs4</code> (BeautifulSoup)。</p><p id="8755" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这两个库通常以下列方式一起使用:首先，我们向网站发出 GET 请求。然后，我们从返回的内容中创建一个漂亮的 Soup 对象，并使用几种方法解析它。</p><pre class="lo lp lq lr gt na mz nb nc aw nd bi"><span id="bdba" class="ne ma jb mz b gy nf ng l nh ni"># requests for fetching html of website<br/>import requests</span><span id="ef32" class="ne ma jb mz b gy nj ng l nh ni"># Make the GET request to a url<br/>r = requests.get('<a class="ae lm" href="http://www.cleveland.com/metro/index.ssf/2017/12/case_western_reserve_university_president_barbara_snyders_base_salary_and_bonus_pay_tops_among_private_colleges_in_ohio.html'" rel="noopener ugc nofollow" target="_blank">http://www.cleveland.com/metro/index.ssf/2017/12/case_western_reserve_university_president_barbara_snyders_base_salary_and_bonus_pay_tops_among_private_colleges_in_ohio.html'</a>)</span><span id="dcc4" class="ne ma jb mz b gy nj ng l nh ni"># Extract the content<br/>c = r.content</span><span id="2319" class="ne ma jb mz b gy nj ng l nh ni">from bs4 import BeautifulSoup</span><span id="6de8" class="ne ma jb mz b gy nj ng l nh ni"># Create a soup object<br/>soup = BeautifulSoup(c)</span></pre><p id="0830" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">由此产生的汤对象相当吓人:</p><figure class="lo lp lq lr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nk"><img src="../Images/92ee5b40e322d6f5c3ea37d5c6ca11a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*AHRSdMwsnOEo08wC-vKSAA.png"/></div></div></figure><p id="6ed1" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们的数据就在那里的某个地方，但我们需要提取它。为了从汤里选择我们的桌子，我们需要找到正确的<a class="ae lm" href="https://www.w3schools.com/cssref/css_selectors.asp" rel="noopener ugc nofollow" target="_blank"> CSS 选择器</a>。一种方法是访问网页并检查元素。在这种情况下，我们也可以只查看 soup，并看到我们的表驻留在带有属性<code class="fe mw mx my mz b">class = "entry-content"</code>的<code class="fe mw mx my mz b">&lt;div&gt;</code> HTML 标签下。使用这些信息和我们的 soup 对象的<code class="fe mw mx my mz b">.find</code>方法，我们可以提取文章的主要内容。</p><pre class="lo lp lq lr gt na mz nb nc aw nd bi"><span id="a6f6" class="ne ma jb mz b gy nf ng l nh ni"># Find the element on the webpage<br/>main_content = soup.find('div', attrs = {'class': 'entry-content'})</span></pre><p id="ecf6" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这将返回另一个不够具体的 soup 对象。要选择表格，我们需要找到<code class="fe mw mx my mz b">&lt;ul&gt;</code>标签(见上图)。我们还想只处理表中的文本，所以我们使用了 soup 的<code class="fe mw mx my mz b">.text</code>属性。</p><pre class="lo lp lq lr gt na mz nb nc aw nd bi"><span id="9016" class="ne ma jb mz b gy nf ng l nh ni"># Extract the relevant information as text<br/>content = main_content.find('ul').text</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/1dde5b440718e4c8d653354c37373c9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*MTQOwEnK5HOVC74SjtJ2MQ.png"/></div></figure><p id="5ef7" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们现在有了字符串形式的表的确切文本，但显然它对我们没有多大用处！为了提取文本字符串的特定部分，我们需要使用正则表达式。这篇文章我没有篇幅(也没有经验！)来完整解释正则表达式，所以这里我只做一个简单的概述，并展示结果。我自己也还在学习，我发现变得更好的唯一方法就是练习。请随意查看本笔记本<a class="ae lm" href="https://colab.research.google.com/drive/1zjMHPv3H7mV5iLWapiW9IF2yUoY2Jggg" rel="noopener ugc nofollow" target="_blank">进行一些练习，并查看 Python <code class="fe mw mx my mz b">re</code> </a><a class="ae lm" href="https://docs.python.org/3/library/re.html" rel="noopener ugc nofollow" target="_blank">文档</a>开始(文档通常很枯燥，但<em class="nm">非常</em>有用)。</p><h1 id="9076" class="lz ma jb bd mb mc nn me mf mg no mi mj kh np ki ml kk nq kl mn kn nr ko mp mq bi translated">正则表达式</h1><p id="eb03" class="pw-post-body-paragraph kq kr jb ks b kt mr kc kv kw ms kf ky kz mt lb lc ld mu lf lg lh mv lj lk ll ij bi translated">正则表达式的基本思想是我们定义一个模式(“正则表达式”或“regex”)，我们希望在一个文本字符串中进行匹配，然后在字符串中搜索以返回匹配。其中一些模式看起来非常奇怪，因为它们既包含我们想要匹配的内容，也包含改变模式解释方式的特殊字符。正则表达式在解析字符串信息时总是出现，并且是至少在基础水平上学习的重要工具！</p><p id="7361" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们需要从文本表中提取 3 条信息:</p><ol class=""><li id="02f5" class="ns nt jb ks b kt ku kw kx kz nu ld nv lh nw ll nx ny nz oa bi translated">总统的名字</li><li id="25a8" class="ns nt jb ks b kt ob kw oc kz od ld oe lh of ll nx ny nz oa bi translated">学院的名称</li><li id="fdb2" class="ns nt jb ks b kt ob kw oc kz od ld oe lh of ll nx ny nz oa bi translated">薪水</li></ol><p id="e925" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">首先是名字。在这个正则表达式中，我利用了这样一个事实，即每个名字都位于一行的开头，以逗号结尾。下面的代码创建一个正则表达式模式，然后在字符串中搜索以找到该模式的所有匹配项:</p><pre class="lo lp lq lr gt na mz nb nc aw nd bi"><span id="da53" class="ne ma jb mz b gy nf ng l nh ni"># Create a pattern to match names<br/>name_pattern = re.compile(r'^([A-Z]{1}.+?)(?:,)', flags = re.M)</span><span id="38c7" class="ne ma jb mz b gy nj ng l nh ni"># Find all occurrences of the pattern<br/>names = name_pattern.findall(content)</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi og"><img src="../Images/b19ba1aeb4351501189f10d8f4d7d278.png" data-original-src="https://miro.medium.com/v2/resize:fit:436/format:webp/1*bkaWdtkvsT8_pbNx8Ptgbg.png"/></div></figure><p id="d77e" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">就像我说的，这个模式非常复杂，但是它确实是我们想要的！不要担心模式的细节，只需要考虑大致的过程:首先定义一个模式，然后搜索一个字符串来找到模式。</p><p id="6082" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们对大学和薪水重复这个过程:</p><pre class="lo lp lq lr gt na mz nb nc aw nd bi"><span id="930f" class="ne ma jb mz b gy nf ng l nh ni"># Make school patttern and extract schools<br/>school_pattern = re.compile(r'(?:,|,\s)([A-Z]{1}.*?)(?:\s\(|:|,)')<br/>schools = school_pattern.findall(content)</span><span id="8173" class="ne ma jb mz b gy nj ng l nh ni"># Pattern to match the salaries<br/>salary_pattern = re.compile(r'\$.+')<br/>salaries = salary_pattern.findall(content)</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/7f90ef4ad61c6de4914111d91d2e0420.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/1*-Zj1bEflPBjBx09ER-WFHw.png"/></div></figure><p id="543b" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">不幸的是，薪水的格式是任何计算机都无法理解的数字。幸运的是，这给了我们一个练习使用 Python <a class="ae lm" href="http://www.pythonforbeginners.com/basics/list-comprehensions-in-python" rel="noopener ugc nofollow" target="_blank">列表理解</a>将字符串 salaries 转换成数字的机会。下面的代码说明了如何使用字符串切片、<code class="fe mw mx my mz b">split</code>和<code class="fe mw mx my mz b">join</code>，所有这些都在一个列表理解中，以获得我们想要的结果:</p><pre class="lo lp lq lr gt na mz nb nc aw nd bi"><span id="9649" class="ne ma jb mz b gy nf ng l nh ni"># Messy salaries<br/>salaries = ['$876,001', '$543,903', '$2453,896']</span><span id="e1f7" class="ne ma jb mz b gy nj ng l nh ni"># Convert salaries to numbers in a list comprehension <br/>[int(''.join(s[1:].split(','))) for s in salaries]</span><span id="4404" class="ne ma jb mz b gy nj ng l nh ni"><strong class="mz jc"><br/>[876001, 543903, 2453896]</strong></span></pre><p id="aece" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我们将这种转换应用到我们的工资中，最终得到我们想要的所有信息。让我们把一切都放进一个<code class="fe mw mx my mz b">pandas</code>数据框架。此时，我手动插入了我的大学(CWRU)的信息，因为它不在主表中。重要的是要知道什么时候手工做事情比编写复杂的程序更有效(尽管整篇文章有点违背这一点！).</p><figure class="lo lp lq lr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oi"><img src="../Images/d517e2ec9a5dd094b87e4be1d62c5e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:940/format:webp/1*0eYcEGtOczSHtdK0ZAKaXQ.png"/></div></div><figcaption class="oj ok gj gh gi ol om bd b be z dk">Subset of Dataframe</figcaption></figure><h1 id="6c2b" class="lz ma jb bd mb mc nn me mf mg no mi mj kh np ki ml kk nq kl mn kn nr ko mp mq bi translated">形象化</h1><p id="21b4" class="pw-post-body-paragraph kq kr jb ks b kt mr kc kv kw ms kf ky kz mt lb lc ld mu lf lg lh mv lj lk ll ij bi translated">这个项目是数据科学的象征，因为大部分时间都花在了收集和格式化数据上。然而，现在我们有了一个干净的数据集，我们可以画一些图了！我们可以使用<code class="fe mw mx my mz b">matplotlib</code>和<code class="fe mw mx my mz b">seaborn</code>来可视化数据。</p><p id="43e3" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">如果我们不太关心美观，我们可以使用内置的数据帧绘图方法来快速显示结果:</p><pre class="lo lp lq lr gt na mz nb nc aw nd bi"><span id="15f6" class="ne ma jb mz b gy nf ng l nh ni"># Make a horizontal bar chart<br/>df.plot(kind='barh', x = 'President', y = 'salary')</span></pre><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi on"><img src="../Images/17979c8cba29cecffb5f1c16406acb79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*CZu5IZvJAXDMW4Cxfo2wcQ.png"/></div><figcaption class="oj ok gj gh gi ol om bd b be z dk">Default plot using dataframe plotting method</figcaption></figure><p id="6397" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">为了得到更好的情节，我们必须做一些工作。像正则表达式一样，用 Python 绘制代码可能有点复杂，需要一些实践来适应。大多数情况下，我通过在 Stack Overflow 等网站上寻找答案或者阅读官方文档来学习。</p><p id="75de" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">经过一点工作，我们得到了下面的情节(详情见笔记本):</p><figure class="lo lp lq lr gt is gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/7fff1039aba4b836cef36d80d798a71c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cSYPbLFonxevpTMR8gZupQ.png"/></div><figcaption class="oj ok gj gh gi ol om bd b be z dk">Better Plot using seaborn</figcaption></figure><p id="65db" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">好多了，但是这还是没有回答我原来的问题！为了显示学生为他们校长的 5 分钟时间支付了多少钱，我们可以将工资转换成美元/5 分钟，假设每年工作 2000 小时。</p><figure class="lo lp lq lr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi op"><img src="../Images/112df6c166c409796f887f9e4d347f0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ETIVF-kSG2PTbeQHO5ubLQ.png"/></div></div><figcaption class="oj ok gj gh gi ol om bd b be z dk">Final Figure</figcaption></figure><p id="8de0" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">这不一定是值得出版的情节，但这是结束一个小项目的好方法。</p><h1 id="507c" class="lz ma jb bd mb mc nn me mf mg no mi mj kh np ki ml kk nq kl mn kn nr ko mp mq bi translated">结论</h1><p id="2021" class="pw-post-body-paragraph kq kr jb ks b kt mr kc kv kw ms kf ky kz mt lb lc ld mu lf lg lh mv lj lk ll ij bi translated">学习技能最有效的方法是实践。虽然整个项目可以通过手动将值插入 Excel 来完成，但我喜欢从长计议，思考在这里学到的技能如何在未来有所帮助。学习的过程比最终结果更重要，在这个项目中，我们能够看到如何将 3 项关键技能用于数据科学:</p><ol class=""><li id="3878" class="ns nt jb ks b kt ku kw kx kz nu ld nv lh nw ll nx ny nz oa bi translated">Web 抓取:检索在线数据</li><li id="5e18" class="ns nt jb ks b kt ob kw oc kz od ld oe lh of ll nx ny nz oa bi translated">正则表达式:解析我们的数据以提取信息</li><li id="29ec" class="ns nt jb ks b kt ob kw oc kz od ld oe lh of ll nx ny nz oa bi translated">可视化:展示我们所有的辛勤工作</li></ol><p id="0f39" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">现在，走出去，开始你自己的项目，记住:不一定要改变世界才有价值。</p><p id="e555" class="pw-post-body-paragraph kq kr jb ks b kt ku kc kv kw kx kf ky kz la lb lc ld le lf lg lh li lj lk ll ij bi translated">我欢迎反馈和讨论，可以通过 Twitter <a class="ae lm" href="https://twitter.com/koehrsen_will" rel="noopener ugc nofollow" target="_blank"> @koehrsen_will </a>联系。</p></div></div>    
</body>
</html>