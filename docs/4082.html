<html>
<head>
<title>How to normalize features in TensorFlow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何归一化 TensorFlow 中的特征</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-normalize-features-in-tensorflow-5b7b0e3a4177?source=collection_archive---------3-----------------------#2018-07-17">https://towardsdatascience.com/how-to-normalize-features-in-tensorflow-5b7b0e3a4177?source=collection_archive---------3-----------------------#2018-07-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3295b1b17ab66d0b9cd1945c7ac78deb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pPFhoV6d9ZYkQsXi"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@inf1783?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Karsten Würth (@inf1783)</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8fb9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"><em class="lb">TL；DR <br/> </em> </strong> <em class="lb">使用</em> <code class="fe lc ld le lf b"><em class="lb">tf.estimator</em></code> <em class="lb">时，使用</em> <code class="fe lc ld le lf b"><em class="lb">tf.feature_column.numeric_feature</em></code> <em class="lb">中的</em> <code class="fe lc ld le lf b"><em class="lb">normalizer_fn</em></code> <em class="lb">参数，使用相同的参数(均值、标准差等)进行归一化。)进行培训、评估和服务。</em></p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="c971" class="lo lp iq lf b gy lq lr l ls lt">def zscore(col):<br/>  mean = 3.04<br/>  std = 1.2<br/>  return (col — mean)/std</span><span id="821b" class="lo lp iq lf b gy lu lr l ls lt">feature_name = ‘total_bedrooms’<br/>normalized_feature = tf.feature_column.numeric_column(<br/>  feature_name,<br/>  normalizer_fn=zscore)</span></pre><h2 id="bcbc" class="lo lp iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated"><strong class="ak">归一化为</strong>T3】</h2><p id="15c4" class="pw-post-body-paragraph kd ke iq kf b kg mm ki kj kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">神经网络激活通常喜欢它们的输入被标准化。将网络中节点的输入标准化有助于防止所谓的消失(和爆炸)梯度。<a class="ae kc" rel="noopener" target="_blank" href="/how-to-use-batch-normalization-with-tensorflow-and-tf-keras-to-train-deep-neural-networks-faster-60ba4d054b73">批量规范化</a>是最全面的规范化方法，但是它会产生额外的成本，并且对于您的问题来说可能是多余的。因此，您可能只想规范化您的输入。</p><p id="c1f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe lc ld le lf b">tf.estimator</code> API(这是构建 TensorFlow 模型最简单的方法)时，有两种规范化输入的方法:在<code class="fe lc ld le lf b">input_fn</code>内部和创建<code class="fe lc ld le lf b">feature_column</code>时。我将向您展示一个执行阶梯的示例，然后我将向您展示如何使用<a class="ae kc" href="https://cloud.google.com/ml-engine/" rel="noopener ugc nofollow" target="_blank"> ML 引擎</a>训练多个模型。</p><h2 id="079a" class="lo lp iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated"><strong class="ak">样板代码:使用</strong> `normalizer_fn` <strong class="ak">参数</strong>进行规范化</h2><p id="47fa" class="pw-post-body-paragraph kd ke iq kf b kg mm ki kj kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">查看<a class="ae kc" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/feature_column_normalization" rel="noopener ugc nofollow" target="_blank">这款笔记本</a>的完整工作示例。</p><p id="f8e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">规范化 input_fn 中的<a class="ae kc" href="https://stackoverflow.com/a/46480180" rel="noopener ugc nofollow" target="_blank">允许更大的灵活性(您也可以在这里执行特征工程)，但是我发现将<code class="fe lc ld le lf b">normalizer_fn</code>与<code class="fe lc ld le lf b">tf.feature_column.numeric_column</code>一起使用更优雅。下面是一个基本的例子:</a></p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="dc86" class="lo lp iq lf b gy lq lr l ls lt"><em class="lb">def zscore(col):<br/>  mean = 3.04<br/>  std = 1.2<br/>  return (col — mean)/std</em></span><span id="0c79" class="lo lp iq lf b gy lu lr l ls lt"><em class="lb">feature_name = ‘total_bedrooms’<br/>normalized_feature = tf.feature_column.numeric_column(<br/>  feature_name,<br/>  normalizer_fn=zscore)</em></span></pre><p id="c157" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面，我将展示一个端到端的例子，以获取规范化参数，然后规范化我的数据集中的所有数值列。</p><p id="891b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该提前计算训练集的规范化参数。在本例中，我使用 Pandas 来获取每个数字列的平均值和标准差:</p><figure class="lg lh li lj gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="71f2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者，<a class="ae kc" href="https://github.com/tensorflow/transform" rel="noopener ugc nofollow" target="_blank"> TensorFlow Transform </a>提供了一种标准化输入的可扩展方法，特别适用于大型数据集。查看这里的中的<a class="ae kc" href="https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/courses/machine_learning/deepdive/06_structured/4_preproc_tft.ipynb" rel="noopener ugc nofollow" target="_blank">例子。</a></p><p id="0feb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行上面的代码后，我们返回每一列的参数:</p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="c166" class="lo lp iq lf b gy lq lr l ls lt">{‘households’: {‘mean’: 501.34073416222617, ‘std’: 382.81658748493305},<br/>‘housing_median_age’: {‘mean’: 28.5441089402013, ‘std’: 12.610144469735635},<br/>‘median_income’: {‘mean’: 3.8814239564831365, ‘std’: 1.9061255708184284},<br/>‘population’: {‘mean’: 1428.941163410302, ‘std’: 1150.5106244960523},<br/>‘total_bedrooms’: {‘mean’: 539.6057578448787, ‘std’: 418.76075045523334},<br/>‘total_rooms’: {‘mean’: 2642.2929988158676, ‘std’: 2162.649970020439}}</span></pre><p id="ef3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以使用上面计算的训练平均值和标准偏差来创建特征列。</p><figure class="lg lh li lj gt jr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="e52e" class="lo lp iq lf b gy lq lr l ls lt">NUMERIC_FEATURES = [‘housing_median_age’, ‘total_rooms’, ‘total_bedrooms’, ‘population’, ‘households’, ‘median_income’]</span><span id="6029" class="lo lp iq lf b gy lu lr l ls lt">feature_columns = create_feature_cols(NUMERIC_FEATURES, use_normalization=True)</span></pre><p id="47df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，您可以使用特性列构建评估器:</p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="c9aa" class="lo lp iq lf b gy lq lr l ls lt">model = tf.estimator.DNNRegressor(hidden_units=[10,4], <br/>                                  model_dir = outdir,<br/>                                  feature_columns = feature_columns)</span></pre><h2 id="7804" class="lo lp iq bd lv lw lx dn ly lz ma dp mb ko mc md me ks mf mg mh kw mi mj mk ml bi translated">使用 ML 引擎在云中训练多个模型</h2><p id="8cfb" class="pw-post-body-paragraph kd ke iq kf b kg mm ki kj kk mn km kn ko mo kq kr ks mp ku kv kw mq ky kz la ij bi translated">归一化是一个超参数，在实践中，评估不同的归一化方案将是有用的。例如，您可能想尝试训练一个模型，只对您的要素进行归一化，并将其与使用批量归一化对隐藏图层的输入进行归一化进行比较。</p><p id="0e57" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用云 ML 引擎并行启动多个实验。这对于较大的数据集尤其有价值，在这种情况下，您希望利用云来扩展模型训练。使用 ML 引擎训练，需要<a class="ae kc" rel="noopener" target="_blank" href="/how-to-train-machine-learning-models-in-the-cloud-using-cloud-ml-engine-3f0d935294b3">将模型代码</a>打包，创建 task.py 和 model.py 模型文件。参见<a class="ae kc" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/feature_column_normalization" rel="noopener ugc nofollow" target="_blank">回购</a>的示例。</p><p id="40c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最佳实践是首先在本地测试模型包，以确保没有语法或语义错误:</p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="e640" class="lo lp iq lf b gy lq lr l ls lt">OUTPUT_DIR=’trained_model’<br/>export PYTHONPATH=${PYTHONPATH}:${PWD}/model_code<br/>python -m trainer.task — outdir $OUTPUT_DIR — normalize_input 1</span></pre><p id="23a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之后，您可以使用“g cloud ML-引擎作业提交培训”向 ML 引擎提交作业:</p><pre class="lg lh li lj gt lk lf ll lm aw ln bi"><span id="189d" class="lo lp iq lf b gy lq lr l ls lt">JOBNAME=my_ml_job_$(date -u +%y%m%d_%H%M%S)<br/>REGION=’us-central1'<br/>BUCKET=’gs://crawles-sandbox’<br/>OUTPUT_DIR=$BUCKET/’housing_trained_model’<br/>PACKAGE_PATH=$PWD/model_code/trainer</span><span id="57b0" class="lo lp iq lf b gy lu lr l ls lt">gcloud ml-engine jobs submit training $JOBNAME \<br/>  -- package-path=$PACKAGE_PATH \<br/>  -- module-name=trainer.task \<br/>  -- region=$REGION \<br/>  --staging-bucket=$BUCKET\<br/>  -- scale-tier=BASIC \<br/>  -- runtime-version=1.8 \<br/>  -- \<br/>  -- outdir=$OUTPUT_DIR\<br/>  -- normalize_input=0</span></pre><p id="4583" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的例子中，我在训练时计算和不计算特征的 z 值:</p><figure class="lg lh li lj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/1c68aa2d6639edf0b62694693e312b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L55EwdYftTCKi6I4"/></div></div></figure><p id="f485" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如预期的那样，规范化输入提高了最终模型的性能。</p><p id="79b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！如果你觉得这篇文章有帮助，请给它一个掌声，这样其他人就可以找到它。</p><p id="6dc1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">其他资源</strong></p><ul class=""><li id="7969" class="mu mv iq kf b kg kh kk kl ko mw ks mx kw my la mz na nb nc bi translated">使用<a class="ae kc" href="https://stackoverflow.com/a/46480180" rel="noopener ugc nofollow" target="_blank"> input_fn </a>归一化</li><li id="31b8" class="mu mv iq kf b kg nd kk ne ko nf ks ng kw nh la mz na nb nc bi translated"><a class="ae kc" rel="noopener" target="_blank" href="/how-to-use-batch-normalization-with-tensorflow-and-tf-keras-to-train-deep-neural-networks-faster-60ba4d054b73">使用 tf.keras 进行批量标准化</a></li><li id="7bd2" class="mu mv iq kf b kg nd kk ne ko nf ks ng kw nh la mz na nb nc bi translated"><a class="ae kc" href="https://en.wikipedia.org/wiki/Standard_score" rel="noopener ugc nofollow" target="_blank">标准分数</a> (z 分数)</li><li id="5490" class="mu mv iq kf b kg nd kk ne ko nf ks ng kw nh la mz na nb nc bi translated"><a class="ae kc" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/feature_column_normalization" rel="noopener ugc nofollow" target="_blank">回购本</a>帖子中的代码</li></ul></div></div>    
</body>
</html>