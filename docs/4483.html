<html>
<head>
<title>Using networkD3 in R to create simple and clear Sankey diagrams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 R 中的 networkD3 创建简单明了的 Sankey 图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-networkd3-in-r-to-create-simple-and-clear-sankey-diagrams-48f8ba8a4ace?source=collection_archive---------5-----------------------#2018-08-19">https://towardsdatascience.com/using-networkd3-in-r-to-create-simple-and-clear-sankey-diagrams-48f8ba8a4ace?source=collection_archive---------5-----------------------#2018-08-19</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><p id="5de5" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">我发现桑基图对于说明人员流动或偏好非常有用。R 中的<code class="fe kq kr ks kt b">networkD3</code>包提供了一种直接生成这些图的方法，不需要知道实际 D3 代码的来龙去脉。</p><p id="ee63" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">为了说明我的意思，我生成了一个桑基图，以显示英国的 12 个地区如何对 2016 年英国退出欧盟公投的整体结果做出贡献，在公投中，选民以 17，410，742 票对 16，141，241 票选择离开欧盟。</p><p id="1c8a" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">如果你想看到完全交互式的 Sankey 图，你可以在 RPubs <a class="ae ku" href="http://rpubs.com/keithmcnulty/brexitsankey" rel="noopener ugc nofollow" target="_blank">这里</a>通过 RMarkdown 文档查看代码。不幸的是，媒体上只能显示静态图像。</p><h2 id="4916" class="kv kw iv bd kx ky kz dn la lb lc dp ld kd le lf lg kh lh li lj kl lk ll lm ln bi translated">使数据成形</h2><p id="e75d" class="pw-post-body-paragraph js jt iv ju b jv lo jx jy jz lp kb kc kd lq kf kg kh lr kj kk kl ls kn ko kp io bi translated">关于英国退出欧盟公投的非常详细的数据可以从英国选举委员会的网站上获得。第一步是加载我们的库，并将数据放入 r 中。由于数据非常详细，直到最本地化的投票中心，我们需要汇总所有的离开和剩余投票，以获得每个地区的总数。</p><pre class="lt lu lv lw gt lx kt ly lz aw ma bi"><span id="027c" class="kv kw iv kt b gy mb mc l md me">## load libraries</span><span id="f29c" class="kv kw iv kt b gy mf mc l md me">library(dplyr)<br/>library(networkD3)<br/>library(tidyr)</span><span id="7375" class="kv kw iv kt b gy mf mc l md me"># read in EU referendum results dataset</span><span id="03a3" class="kv kw iv kt b gy mf mc l md me">refresults &lt;- read.csv("EU-referendum-result-data.csv")</span><span id="9830" class="kv kw iv kt b gy mf mc l md me"># aggregate by region</span><span id="4882" class="kv kw iv kt b gy mf mc l md me">results &lt;- refresults %&gt;% <br/>  dplyr::group_by(Region) %&gt;% <br/>  dplyr::summarise(Remain = sum(Remain), Leave = sum(Leave))</span></pre><p id="e3aa" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">然后我们需要创建两个数据帧供<code class="fe kq kr ks kt b">networkD3</code>在其<code class="fe kq kr ks kt b">sankeyNetwork()</code>函数中使用:</p><ol class=""><li id="8b17" class="mg mh iv ju b jv jw jz ka kd mi kh mj kl mk kp ml mm mn mo bi translated">一个<code class="fe kq kr ks kt b">nodes</code>数据帧，对源节点(即 12 个英国区域)和目的节点(即离开和留下)进行编号，从零开始。</li><li id="fe6a" class="mg mh iv ju b jv mp jz mq kd mr kh ms kl mt kp ml mm mn mo bi translated">一个<code class="fe kq kr ks kt b">links</code>数据框架，使用<code class="fe kq kr ks kt b">source</code>、<code class="fe kq kr ks kt b">target</code>和<code class="fe kq kr ks kt b">value</code>列逐项列出每个流程。例如，西米德兰兹地区为休假投了 1，755，687 票，因此在这种情况下，<code class="fe kq kr ks kt b">source</code>将是西米德兰兹的节点，<code class="fe kq kr ks kt b">target</code>将是休假的节点，<code class="fe kq kr ks kt b">value</code>将是 1，755，687 票。</li></ol><p id="3586" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">以下是以这种方式构建数据的一些简单代码:</p><pre class="lt lu lv lw gt lx kt ly lz aw ma bi"><span id="1f64" class="kv kw iv kt b gy mb mc l md me"># format in prep for sankey diagram</span><span id="cccf" class="kv kw iv kt b gy mf mc l md me">results &lt;- tidyr::gather(results, result, vote, -Region)</span><span id="cb7c" class="kv kw iv kt b gy mf mc l md me"># create nodes dataframe</span><span id="59e9" class="kv kw iv kt b gy mf mc l md me">regions &lt;- unique(as.character(results$Region))<br/>nodes &lt;- data.frame(node = c(0:13), <br/>                    name = c(regions, "Leave", "Remain"))</span><span id="7d03" class="kv kw iv kt b gy mf mc l md me">#create links dataframe</span><span id="9906" class="kv kw iv kt b gy mf mc l md me">results &lt;- merge(results, nodes, by.x = "Region", by.y = "name")<br/>results &lt;- merge(results, nodes, by.x = "result", by.y = "name")<br/>links &lt;- results[ , c("node.x", "node.y", "vote")]<br/>colnames(links) &lt;- c("source", "target", "value")</span></pre><p id="271e" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">现在我们已经以正确的方式构建了数据，我们可以简单地使用<code class="fe kq kr ks kt b">networkD3::sankeyNetwork()</code>函数来创建图表。这产生了一个简单有效的图表，滚动交互显示每个投票流的细节。这里展示的是静态版本。</p><pre class="lt lu lv lw gt lx kt ly lz aw ma bi"><span id="c2f7" class="kv kw iv kt b gy mb mc l md me"># draw sankey network</span><span id="1e2a" class="kv kw iv kt b gy mf mc l md me">networkD3::sankeyNetwork(Links = links, Nodes = nodes, <br/>                         Source = 'source', <br/>                         Target = 'target', <br/>                         Value = 'value', <br/>                         NodeID = 'name',<br/>                         units = 'votes')</span></pre><figure class="lt lu lv lw gt mv gh gi paragraph-image"><div role="button" tabindex="0" class="mw mx di my bf mz"><div class="gh gi mu"><img src="../Images/e7a04fbd565cc145f1163d3ec8d03866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_5brDjDP1MxVQmVRirYqSQ.jpeg"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk">Brexit Referendum 2016 vote flows by region</figcaption></figure><p id="53f5" class="pw-post-body-paragraph js jt iv ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp io bi translated">最初我是一名纯粹的数学家，后来我成为了一名心理计量学家和数据科学家。我热衷于将所有这些学科的严谨性应用到复杂的人的问题上。我也是一个编码极客和日本 RPG 的超级粉丝。在 <a class="ae ku" href="https://www.linkedin.com/in/keith-mcnulty/" rel="noopener ugc nofollow" target="_blank"> <em class="ng"> LinkedIn </em> </a> <em class="ng">或</em><a class="ae ku" href="https://twitter.com/dr_keithmcnulty" rel="noopener ugc nofollow" target="_blank"><em class="ng">Twitter</em></a><em class="ng">上找我。</em></p></div></div>    
</body>
</html>