<html>
<head>
<title>Interpreting Random Forest and other black box models like XGBoost</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释随机森林和其他黑盒模型，如 XGBoost</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/interpreting-random-forest-and-other-black-box-models-like-xgboost-80f9cc4a3c38?source=collection_archive---------1-----------------------#2018-08-06">https://towardsdatascience.com/interpreting-random-forest-and-other-black-box-models-like-xgboost-80f9cc4a3c38?source=collection_archive---------1-----------------------#2018-08-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d8f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在机器学习中，在<strong class="jp ir">表现</strong>和<strong class="jp ir">解释</strong>之间有一个反复出现的困境。通常，模型越好，越复杂，越难理解。</p><p id="96f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一般来说，有两种方式来解释一个模型:</p><ol class=""><li id="51ea" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><em class="ku">总体解读</em>:确定哪些变量(或变量组合)最有预测力，哪些最没有预测力</li><li id="ef10" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><em class="ku">局部解释</em>:对于一个给定的数据点和相关的预测，确定哪些变量(或变量组合)可以解释这个特定的预测</li></ol><p id="24c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据您使用的模型类型，可能会有特定的方式来解释您的模型。例如，决策树模型可以简单地通过绘制树并观察分裂是如何进行的以及叶子的组成来解释。</p><p id="e867" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，RandomForest 或 XGBoost 没有具体的方法来做到这一点，它们通常更擅长进行预测。</p><h1 id="86a7" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">整体解读</h1><p id="05a6" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">在 Python 的大多数模型中，整体解释已经开箱即用，具有“feature_importances_”属性。下面的例子:</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div></figure><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/51ea4c34a8c7b9bda19669976115881c.png" data-original-src="https://miro.medium.com/v2/resize:fit:324/format:webp/1*k82O3uoBloN7ymkJ12pMQQ.png"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk">Example of feature importances for a given model, what I call “feature importances table” in this article (sorted by feature importance in descending order)</figcaption></figure><p id="4378" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解释这个输出非常简单:根据模型，变量<em class="ku">越重要，就越相关。这是一个很好的方式</em></p><ol class=""><li id="d42a" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><strong class="jp ir">确定具有最佳预测能力的变量</strong></li><li id="12f1" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><strong class="jp ir">提出问题/纠正错误</strong>:相对于其他变量来说太重要的变量。<br/>示例:在之前的项目中，我们处理有偏差的数据:类 1 的数据在变量中有许多缺失值，而类 0 的数据没有。我们直到看了特性重要性表才意识到这一点。该模型了解到，如果数据丢失，则它属于类别 1。我们通过从类 0 的数据中抽取缺失值来解决这个问题</li><li id="f472" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><strong class="jp ir">用新变量更新您的模型。</strong>要查看新变量是否与您的模型相关，计算之前的模型<em class="ku">(无新变量)和</em>之后的模型<em class="ku">(有新变量)的特征重要性。分析新变量在要素重要性表中产生的变化。<br/>举例:在进行特征工程时，你可以提出一个更相关的特征，但是在你的数据中引入它可能会降低与新特征直接相关的特征的重要性。</em></li><li id="9b34" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><strong class="jp ir">比较不同的模型</strong>:通过比较变量的重要性来比较两个不同模型(例如 RandomForest 和 XGBoost)的特性重要性。它有助于了解模型是否掌握了变量的预测能力。<br/>例:比较不同深度的 XGBoost 模型，可以帮助你理解当你使用特定深度时，特定变量变得有用。</li></ol><p id="6202" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止，对模型的整体理解还不错。</p><blockquote class="mr"><p id="bfe3" class="ms mt iq bd mu mv mw mx my mz na kk dk translated">现在你如何解释一个给定数据点的预测？</p></blockquote><h1 id="b067" class="la lb iq bd lc ld le lf lg lh li lj lk ll nb ln lo lp nc lr ls lt nd lv lw lx bi translated">本地解释</h1><p id="ad4b" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">在这里，我将定义什么是<em class="ku">本地解释</em>,并提出一个解决方法来处理您拥有的任何模型。</p><h2 id="20ac" class="ne lb iq bd lc nf ng dn lg nh ni dp lk jy nj nk lo kc nl nm ls kg nn no lw np bi translated">如何定义地方解读？</h2><p id="0df3" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">这里启发我的是我从<a class="ae nq" href="https://www.datarobot.com/" rel="noopener ugc nofollow" target="_blank">数据机器人</a>那里得到的一个演示，他们想预测贷款违约。在他们的演示中，对于每个单独的预测，他们还输出了增加违约概率最多的前 3 个变量，以及减少违约概率最多的前 3 个变量。</p><p id="0475" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们保留这个例子(用模拟数据)，为了更好的可读性，让我们仅用 3 个变量来表示局部解释，如下所示:</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nr"><img src="../Images/3005c85feef214ff4b971a4aa570ddcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ymCv3Mfk2OiIptvPsKspUw.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk">Illustration of local interpretation: for each data point, we identify the 3 variables with the most impact on the prediction of default. Variable Var_1 increases the probability of default in the first 2 predictions (resp. +34% and +25%), but decreases it in the 3rd (-12%)</figcaption></figure><h2 id="31d9" class="ne lb iq bd lc nf ng dn lg nh ni dp lk jy nj nk lo kc nl nm ls kg nn no lw np bi translated">从这个解释中最有趣的收获是</h2><p id="4f59" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">解释每个单独的预测可用于:</p><ol class=""><li id="4f6c" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">理解个别情况下预测的原因。<br/>例如:两个人有很高的违约概率，但原因完全不同(即变量不同)</li><li id="25aa" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">了解被过滤人群最常见的预测原因。<em class="ku">这和特性重要性是不一样的！</em> <br/>举例:考虑一个欺诈检测用例。这是一个典型的多数类问题(0.1%的 1 类数据 vs 99.9%的 0 类数据)，特征重要性偏向 0 类。因此，查看第 1 类的每个单独预测，并对最能解释第 1 类的前 3 个变量进行分组，将非常有助于了解哪些特征会导致最大的风险。</li></ol><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nw"><img src="../Images/7be3f66e3b35c87e15099202b7361a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*joBp6qhBfXCE8c_9q2F71Q.png"/></div></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk">For all predictions of defaults (probability &gt; 50%), we rank the variables that are the most frequent in the top 3 variables, to understand which variables explain the most the default. Variable Var_1 is in 43 cases the most contributing variable for the prediction of default, in 15 cases the second, in 12 cases the 3rd</figcaption></figure><h2 id="67f5" class="ne lb iq bd lc nf ng dn lg nh ni dp lk jy nj nk lo kc nl nm ls kg nn no lw np bi translated">用 Python 实现</h2><p id="338d" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">Python 中的<a class="ae nq" href="https://github.com/andosa/treeinterpreter" rel="noopener ugc nofollow" target="_blank"><em class="ku">tree interpreter</em></a><em class="ku"/>库允许我们精确地<strong class="jp ir">计算每个特性对随机森林模型的影响。我让好奇的读者查看了包作者的两篇惊艳文章(<a class="ae nq" href="http://blog.datadive.net/interpreting-random-forests/" rel="noopener ugc nofollow" target="_blank"> 1 </a>和<a class="ae nq" href="http://blog.datadive.net/random-forest-interpretation-conditional-feature-contributions/" rel="noopener ugc nofollow" target="_blank"> 2 </a>)。</strong></p><p id="df58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于其他模型，我们将做一个快速的解决方案:运行一个随机森林模型，并在您的模型和随机森林模型之间的预测匹配时进行局部解释(当它们同时预测违约或非违约时)。这是我在一个客户项目中选择的解决方案，在这个项目中我有一个 XGBoost 模型。在这种情况下，Random Forest 的本地解释很有意义，但是没有专门针对 XGBoost 的框架仍然是一个令人沮丧的解决方法。</p><p id="4bdd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于计算需要一些时间(取决于随机森林模型中的树的数量)，我建议在本练习中使用您的预测的子集。例如，根据模型，最有可能违约的 10 个人。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mn mo gj gh gi mp mq bd b be z dk">For each individual prediction, we compute the individual contribution of each variable in the prediction with the treeinterpreter package</figcaption></figure><p id="9bf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，treeinterpreter 既有可变贡献，也有整体偏差。更深入的了解，推荐<a class="ae nq" href="http://blog.datadive.net/interpreting-random-forests/" rel="noopener ugc nofollow" target="_blank">原创博文</a>。</p><h2 id="14f4" class="ne lb iq bd lc nf ng dn lg nh ni dp lk jy nj nk lo kc nl nm ls kg nn no lw np bi translated">有一点要记住</h2><p id="f3cf" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">假设您有一个变量“年龄”，它的贡献足够高，可以位于前 3 个变量中，从而有助于特定的预测。你可能会对年龄感兴趣，因为你(或专家)会对 18 岁或 35 岁有不同的解释。因此，查看变量的贡献及其值是一个好习惯(就像上面的代码，其中有两列“value_variable”和“contribution_variable”)</p><h1 id="c564" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">超越 treeinterpreter</h1><p id="7345" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">解释黑盒模型一直是许多研究论文的主题，目前也是，特别是当涉及到<a class="ae nq" href="https://deepmind.com/blog/understanding-deep-learning-through-neuron-deletion/" rel="noopener ugc nofollow" target="_blank">深度学习解释</a>时。试验并采用了不同的方法:<a class="ae nq" href="https://github.com/marcotcr/lime" rel="noopener ugc nofollow" target="_blank">石灰</a>、<a class="ae nq" href="http://scikit-learn.org/stable/auto_examples/ensemble/plot_partial_dependence.html" rel="noopener ugc nofollow" target="_blank">偏相关图</a>、<a class="ae nq" href="https://github.com/sato9hara/defragTrees" rel="noopener ugc nofollow" target="_blank"> defragTrees </a> …</p><p id="0ffc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于 treeinterpreter，如果有其他基于树的模型，比如 XGBoost、LightGBM、CatBoost 或其他梯度提升方法，那就太好了。</p><p id="69fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近偶然发现一篇很棒的关于随机森林模型解读的文章:<a class="ae nq" href="https://medium.com/usf-msds/intuitive-interpretation-of-random-forest-2238687cae45" rel="noopener">https://medium . com/usf-MSDS/intuitive-interpretation-of-random-forest-2238687 CAE 45</a>，有瀑布图和部分依赖图。</p><p id="df64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读，如果你觉得这篇文章有用，请考虑给它至少 50 个掌声:)</p></div></div>    
</body>
</html>