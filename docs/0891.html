<html>
<head>
<title>Preprocessing IoT Data: Linear Resampling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">物联网数据预处理:线性重采样</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/preprocessing-iot-data-linear-resampling-dde750910531?source=collection_archive---------1-----------------------#2017-07-06">https://towardsdatascience.com/preprocessing-iot-data-linear-resampling-dde750910531?source=collection_archive---------1-----------------------#2017-07-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="df4b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">处理间隔不均匀的时间序列数据</h2></div><p id="cfeb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我将介绍我们认为在分析来自物联网(IoT)的时间序列数据时最重要的预处理步骤:<strong class="kh ir">线性重采样</strong>。我将描述对物联网传感器数据进行重采样所面临的挑战，并介绍我们为解决这些挑战而设计的简单解决方案。</p><h1 id="4245" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">不规则物联网时间序列数据</h1><p id="b6b8" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">在物联网(IoT)中，传感器和其他连接设备收集数据。这些数据被发送到云端，以便进行处理、分析或建模，从而构建智能应用。</p><p id="0ab6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为物联网设备通常不会定期发出数据，所以物联网时间序列数据在采样率方面非常不规则，无论是在设备内部还是在设备之间。这使得处理和分析变得麻烦，尤其是当来自多个传感器的数据被组合在一起分析时。</p><p id="2a06" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，<a class="ae ly" href="https://en.wikipedia.org/wiki/Sample_rate_conversion" rel="noopener ugc nofollow" target="_blank">重采样</a>不规则和不均匀间隔的时间序列数据到一致和规则的频率是物联网中至关重要的预处理步骤，可以极大地促进数据的连续处理。</p><p id="e206" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在总部位于柏林的风险建筑商<a class="ae ly" href="http://www.wattx.io" rel="noopener ugc nofollow" target="_blank"> WATTx </a>，我们专注于深度技术，包括物联网。在我们最近的一个项目中，我们在一栋安装了数百个传感器的建筑中建造了一个能源优化原型。这些传感器收集关于温度、湿度、亮度和运动的信息。下面，您可以看到一张展示该设置的平面图:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/da773867de6afa46a24c44bb952a4d83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0lCRQBo1uXyVOZM9Vb2Hdg.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Smart Office IoT setup</figcaption></figure><p id="9e9c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过分析来自办公室这些传感器的数据，我们发现了一个特别有趣的现象:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/ec1a74d6444b4f362c06dc9bde362a83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*qRtIjrX_XIvWj_V1nrqCvA.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Clusters of averaged daily temperature curves</figcaption></figure><p id="f643" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该图显示了平均温度曲线簇，并显示了大量房间在夜间和白天都出现过热，这表明 HVAC 系统的使用不理想，因此浪费了能量。</p><h1 id="b49b" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">使用熊猫进行重采样</h1><p id="fcc0" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">在运行与上面类似的分析之前，一个关键的预处理步骤是将不规则的时间序列数据转换为规则的频率，在所有传感器上保持一致。通过这样做，我们消除了在后面的分析过程中必须处理不规则和不一致的跨传感器时间戳的痛苦。</p><p id="1acb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在 WATTx，我们大量使用 Python 及其数据科学堆栈，因此这个过程的自然选择是使用来自<a class="ae ly" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> pandas </a>的<code class="fe mq mr ms mt b"><a class="ae ly" href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.resample.html" rel="noopener ugc nofollow" target="_blank">resample</a></code>功能。</p><p id="5183" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们来看一个简单的模拟温度曲线示例，数据点间距不均匀:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/43223e352c547108a4b58003aa85a1f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8WNUnwa6PnP3SPkz_IN5vg.png"/></div></div></figure><p id="69ec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，假设我们想要使用<em class="mv">平均值</em>作为聚合函数和线性插值，以 50 分钟(任意选择)的频率对此温度曲线进行重新采样:</p><p id="f1bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mq mr ms mt b">pd.resample(tseries, '50min', 'mean').interpolate()</code></p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/ace40ea87328716b861f7fb68c28f812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w1Fi4ORsgsTrTWpl1hXqFw.png"/></div></div></figure><p id="a0eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如上所述，重新采样后的时间序列与原始数据并不完全匹配，但显示出相当大的偏移。这主要是因为 pandas 的重采样功能是一个按时间分组的<em class="mv">操作，这使得它非常容易受到原始数据的精确采样和期望目标频率的影响。</em></p><h1 id="9a10" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">物联网的两步重采样过程</h1><p id="799e" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">为了克服这些不一致性，我们提出了一种解决方案，可以解决我们所有需要线性插值的物联网传感器的这个问题。</p><p id="d2f9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该解决方案由两步重采样过程组成，其中我们<strong class="kh ir"> (1)首先使用<em class="mv">均值</em>作为聚合函数和线性插值将原始时间序列向上采样</strong>到高频(例如 1 分钟或 1 秒，取决于初始数据的分辨率)，然后使用简单的<em class="mv">正向填充</em>聚合将序列向下采样到所需的目标频率。</p><p id="8ac1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应用于上面的示例曲线，代码如下所示:</p><pre class="ma mb mc md gt mw mt mx my aw mz bi"><span id="9a9e" class="na lc iq mt b gy nb nc l nd ne">tmp = pd.resample(tseries, '1min', 'mean').interpolate()<br/>resampled = pd.resample(tmp, '50min', 'ffill')</span></pre><p id="cd63" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们来看看结果:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/2b8d1610edf2c8dc5080b34e2a955652.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lldc4BZBSusD1U6-6OdV6w.png"/></div></div></figure><p id="6c9c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">显然，这种两步重采样过程的结果曲线与底层数据的匹配程度更高，并且在我们所有需要线性重采样的物联网传感器中都是如此。</p><h1 id="6c12" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">增强稳健性:处理缺失数据</h1><p id="ffaf" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">当对物联网传感器数据进行重采样时，我们希望考虑的另一种情况是时间序列中缺失数据的大缺口。例如，传感器离线几个小时就是这种情况。</p><p id="ab8c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是一个模拟温度曲线的示例，显示了传感器在夜间(大约从晚上 10 点到早上 6 点)离线的几个小时间隔:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi nf"><img src="../Images/c93ab83934ad22d61772d8d783fc350f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xHlIpp2FbKNIk-Ap7z9J0g.png"/></div></div></figure><p id="323f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们对这个时间序列进行重新采样，得到的数据点如下所示:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/ae5edad86f494695825ce4d485045872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wC_WDLkw8AE70VJXUoWxkQ.png"/></div></div></figure><p id="7bc2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">显然，重采样的数据与大块数据丢失期间的基本真实温度曲线不匹配。为了涵盖这种情况，我们引入了一个附加参数，该参数规定了缺失数据的最大间隙应该是多大，以便进行插值。如果差距超过这个指定的阈值(我们发现在大多数情况下，1 小时左右是一个好的选择)，数据点不会被插值，而是作为<em class="mv"> NaN(不是数字)</em>值返回。</p><p id="22dc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">应用这个额外的功能，我们得到了我们想要的结果；在无数据传输期间，定期采样的数据为空值:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/8b7340daeaf419f5684aceb216ab9b92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cfg0P-ZxT-vq2-gQTdHfzw.png"/></div></div></figure><h1 id="eace" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">摘要</h1><p id="41af" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">在这篇博文中，我们展示了对不规则物联网时间序列数据进行重采样的挑战，以及我们为克服这些挑战而设计的简单解决方案。我们简单的物联网传感器数据重采样解决方案的代码可在 GitHub gist 的<a class="ae ly" href="https://gist.github.com/neocortex/5d962742ef16b072dee9a04d9015f85d" rel="noopener ugc nofollow" target="_blank">中找到。</a></p><p id="7d04" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇博文的内容是我在<a class="ae ly" href="https://pydata.org/berlin2017/schedule/presentation/3/" rel="noopener ugc nofollow" target="_blank"> PyData Berlin 2017 </a>演讲的一部分，幻灯片可以在<a class="ae ly" href="https://github.com/pydataberlin/conf2017slides/blob/master/smart_iot_applications/building_mart_IoT_applications_Rafael_Schultze-Kraft.pdf" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="feea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要了解我们在 WATTx 工作的更多令人兴奋的内容，请查看我们的博客和<a class="ae ly" href="https://www.statice.io/" rel="noopener ugc nofollow" target="_blank">Statice</a>——我目前正在从事的项目，我们在其中开发技术以实现隐私保护数据科学。</p></div></div>    
</body>
</html>