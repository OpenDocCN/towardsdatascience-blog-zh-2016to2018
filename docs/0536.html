<html>
<head>
<title>Using Open Source Prophet Package to Make Future Predictions in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用开源Prophet包在R</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-open-source-prophet-package-to-make-future-predictions-in-r-ece585b73687?source=collection_archive---------2-----------------------#2017-05-17">https://towardsdatascience.com/using-open-source-prophet-package-to-make-future-predictions-in-r-ece585b73687?source=collection_archive---------2-----------------------#2017-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5859" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几乎每个公司都希望回答一周/一月/一年后他们会在哪里。在规划公司的基础设施、KPI(关键绩效指标)和员工目标时，这些问题的答案可能很有价值。<br/>因此，使用数据预测工具是数据专业人员需要承担的常见任务之一。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="5059" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近作为开源发布的一个工具是脸书的时间序列预测包<a class="ae ks" href="https://facebookincubator.github.io/prophet/" rel="noopener ugc nofollow" target="_blank"> Prophet </a>。R和Python都可以使用，这是一个相对容易实现的模型，带有一些非常需要的定制选项。<br/>在这篇文章中，我将回顾Prophet，并接着介绍一个简单的R代码示例。这个代码流的灵感很大程度上来自于<a class="ae ks" href="https://facebookincubator.github.io/prophet/docs/quick_start.html" rel="noopener ugc nofollow" target="_blank">官方软件包用户指南</a>。</p><p id="0f39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用从wikishark提取的开放数据集，保存勒布朗·詹姆斯维基百科文章页面的每日数据入口。接下来，我们将基于历史数据构建每日预测。<br/> * wikishark在文章发布后被关闭。你可以使用另一个有用的网站<a class="ae ks" href="http://tools.wmflabs.org/pageviews/?project=en.wikipedia.org&amp;platform=all-access&amp;agent=user&amp;range=all-time&amp;pages=LeBron_James" rel="noopener ugc nofollow" target="_blank">获取数据</a>。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h2 id="e321" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">阶段1 —安装和导入prophet</h2><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="0b9c" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">install.packages(‘prophet’)<br/>library(prophet)<br/>library(dplyr)</strong></span></pre><h2 id="1efe" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">阶段2 —加载数据集</h2><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="30a4" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">stats &lt;- read.csv(“lebron.csv”, header=FALSE, sep=”,”)<br/>colnames(stats) &lt;- c(“ds”, “y”)<br/>head(stats)<br/>#daily data points starting from 2014–01–0</strong></span></pre><figure class="lm ln lo lp gt ma gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/0023463a0dd2d30ba3c29f16319da5c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:352/format:webp/1*eMbZQATcmrE3KEK2yTGuVg.png"/></div></figure><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="05cc" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">stats$y &lt;- log10(stats$y)</strong></span></pre><p id="624d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于我们的代码示例，我们将转换数据并使用入口日志。这将有助于我们理解预测可视化。</p><h2 id="90b1" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">第3阶段—探索数据</h2><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="139c" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">View(summary(stats))<br/>plot(y ~ ds, stats, type = "l")</strong></span></pre><div class="lm ln lo lp gt ab cb"><figure class="md ma me mf mg mh mi paragraph-image"><img src="../Images/2d961a237ebb108162ef4c1eb8c00600.png" data-original-src="https://miro.medium.com/v2/resize:fit:556/format:webp/1*2j4prvryRSQzdeJ-v85VhQ.png"/></figure><figure class="md ma mj mf mg mh mi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><img src="../Images/9188d8cf4ef995c948f35279613d7158.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*hzGk2ZQSKpMi0zofPpbIKA.png"/></div></figure></div><p id="71b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到这些数据是从2014年1月1日到2016年12月31日，从4月到6月有一些年度季节性高峰。</p><h2 id="f6a0" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">第4阶段—基本预测</h2><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="94c5" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">m &lt;- prophet(stats)<br/>future &lt;- make_future_dataframe(m, periods = 365)<br/>forecast &lt;- predict(m, future)</strong></span></pre><p id="5990" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像机器学习模型一样，第一个命令适合数据帧上的模型，接下来将使用predict命令部署模型，以便接收所需天数的预测。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="f6b8" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">plot(m, forecast)</strong></span></pre><p id="e7e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">prophet软件包的开箱即用可视化非常好，具有预定义的刻度线、数据点和不确定性区间。这是这个开源包的优点之一，不需要额外的定制，第一个结果足够快和好，可以满足大多数需求。</p><figure class="lm ln lo lp gt ma gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/1c174f38c187711648dce79d4efd0ac9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*qOojLfSa18a4ZgUHKwRNMg.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">predicting one year of future data points</figcaption></figure><p id="e2fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这个图表，我们可以更清楚地发现年度趋势和季节性，以及如何利用它们进行预测。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="892a" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">tail(forecast[c(‘ds’, ‘yhat’, ‘yhat_lower’, ‘yhat_upper’)])</strong></span></pre><figure class="lm ln lo lp gt ma gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/4b1406955fad52ee20806a8345de61ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:692/format:webp/1*tEWaO-zq0OkKYY43Rrugng.jpeg"/></div></figure><p id="14d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预测对象保存原始数据以及按天和不确定间隔的预测值。还可以通过以下方式访问预测趋势和季节性成分:</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="3d49" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">tail(forecast)</strong></span></pre><h2 id="993a" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">阶段5-检查模型组件</h2><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="8eaf" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">prophet_plot_components(m, forecast)</strong></span></pre><p id="85fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了保持简单性，查看模型的组件很容易。显示总体趋势、每周和每年的季节性。</p><figure class="lm ln lo lp gt ma gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/471765be50f32f34344bd403ff555d44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*ub-rfvvZyuxI-BfBlwR0WA.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Model components</figcaption></figure><h2 id="0cd2" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">第6阶段—定制假期和活动</h2><p id="1ad9" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">最后一个组件图显示了在NBA季后赛和NBA总决赛期间对勒布朗·詹姆斯的兴趣增加。此时，模型识别每年返回的年度季节性。另一方面，勒布朗·詹姆斯目前保持着连续6年参加NBA季后赛的记录，从迈阿密开始，继续在骑士队。所以我们应该期待年复一年的季节性。</p><p id="603c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">增加假期和活动是该套餐的一大优势。首先，通过使预测更准确，并允许用户考虑已知的未来事件。开发人员已经使这种定制比以前的时间序列包更容易，在以前的时间序列包中，为了进行预测，应该手动更改或忽略事件和假日。设想一个电子商务网站，它可以添加所有重复出现的活动和促销，并根据已知的未来活动日期设定收入目标。</p><p id="e06d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加事件和假日是通过创建一个新的数据帧来完成的，在该数据帧中，我们传递事件的开始或结束日期以及天数。在这个例子中，我们将添加NBA季后赛和NBA总决赛作为事件</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="7f3a" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">playoff_brackets &lt;- data_frame(<br/> holiday = ‘playoffs’,<br/> ds = as.Date(c(‘2017–04–16’ ,’2016–04–17', ‘2015–04–19’, ‘2014–04–19’)),<br/> lower_window = 0,<br/> upper_window = 45<br/>)</strong></span><span id="87fa" class="kt ku iq lr b gy mz lw l lx ly"><strong class="lr ir">playoff_finals &lt;- data_frame(<br/> holiday = ‘playoff_finals’,<br/> ds = as.Date(c(‘2016–06–02’, ‘2015–06–04’, ‘2014–06–05’)),<br/> lower_window = 0,<br/> upper_window = 20<br/>)</strong></span></pre><p id="aec1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用较低和较高的窗口参数，用户可以设置假期的长度。这些映射将被行绑定到单个对象，并在holidays参数中传递。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="3e47" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">holidays &lt;- bind_rows(playoff_brackets, playoff_finals)<br/>m &lt;- prophet(stats, holidays = playoff_brackets)<br/>forecast &lt;- predict(m, future)<br/>plot(m, forecast)</strong></span></pre><figure class="lm ln lo lp gt ma gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/c4886f0fdc3150c5f498111b39e7057a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*olcxbeVPXeZyE69BxofgZQ.png"/></div></figure><p id="1d95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，该模型可以更好地预测峰值期间的值。再次打印出组件将显示增加的假日行对预测的影响。从理论上讲，您可以绘制许多对业务至关重要的事件，并获得更好的预测。</p><figure class="lm ln lo lp gt ma gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/fc40da2ab01753f69202f08cb724dcbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*dCy3n1b9r3iCkdDpssb0cw.png"/></div></figure><h2 id="3b21" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">第7阶段—去除异常值</h2><p id="c6b3" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">构建预测时，从历史数据中移除异常值非常重要。尽管这些数据点是单次事件或者只是错误的事件日志，但是模型使用这些数据点将它们的影响添加到预测中。与其他包不同，当传递安娜值和历史数据时会崩溃，Prophet将忽略这些日期。</p><p id="7659" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本例中，我们将删除一系列单次事件，其中NBA球员宣布他将离开迈阿密前往克利夫兰，这可能会引起人们对他的维基百科页面的注意。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="0971" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">outliers &lt;- (as.Date(stats$ds) &gt; as.Date(‘2014–07–09’)<br/> &amp; as.Date(stats$ds) &lt; as.Date(‘2014–07–12’))<br/>stats$y[outliers] = NA</strong></span></pre><h2 id="26d1" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">第8阶段—更多功能</h2><p id="f427" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">此时，我们可以看到开发人员在创建这个包时所考虑的简单性和健壮性。一些我没有展示但应该使用的额外功能:</p><ul class=""><li id="d27b" class="na nb iq jp b jq jr ju jv jy nc kc nd kg ne kk nf ng nh ni bi translated">变化的季节性和假日效应量表</li><li id="5dfe" class="na nb iq jp b jq nj ju nk jy nl kc nm kg nn kk nf ng nh ni bi translated">绘制关键趋势变化点</li><li id="1b7a" class="na nb iq jp b jq nj ju nk jy nl kc nm kg nn kk nf ng nh ni bi translated">编辑不确定性区间</li></ul></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h2 id="ab36" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">使用Prophet进行异常检测</h2><p id="4562" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">我希望开发人员的下一步是使用这个包，并利用它对时间序列数据进行异常检测。先前的软件包提供了这样的功能，但是严重依赖于数据结构和严格的季节性。</p><p id="b36b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们使用现有的模型来映射数据中的异常。我们将原始值(y)与预测模型值(yhat)进行比较，并创建一个名为<strong class="jp ir"> diff_values的新列。</strong></p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="3c17" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">combined_data &lt;- cbind(head(forecast, nrow(stats)), stats[order(stats$ds),])<br/>combined_data$diff_values &lt;- (combined_data$y - combined_data$yhat)<br/>summary(combined_data$diff_values)</strong></span><span id="669c" class="kt ku iq lr b gy mz lw l lx ly">Min. 1st Qu. Median Mean 3rd Qu. Max. <br/>0.05269 0.07326 0.10780 0.13490 0.16520 0.29480</span></pre><p id="6507" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更好地概括异常检测，我们还将添加标准化的diff值，表示与实际值的百分比差异。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="95f4" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">combined_data$diff_values_normalized &lt;-<br/>(combined_data$y - combined_data$yhat) / combined_data$y</strong></span></pre><p id="f014" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们继续观察随时间变化的标准化diff值。</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="762b" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">plot(diff_values_normalized ~ ds, combined_data, type = “l”)</strong></span></pre><figure class="lm ln lo lp gt ma gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/602f6ad9cdd581b7a2ab07d657145c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*5Flfy8AMXZIh6ENUIGEUpQ.png"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk">Normalized difference prediction to actual values</figcaption></figure><p id="105d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大多数预测值都非常接近实际值，因为图表倾向于在0值附近移动。我们还可以通过过滤<strong class="jp ir"> diff_values_normalized列的绝对值来询问异常数据点的百分比。</strong>设置一个数据点被视为异常的阈值是一种观察方法。在这个例子中是10%</p><pre class="lm ln lo lp gt lq lr ls lt aw lu bi"><span id="7cb1" class="kt ku iq lr b gy lv lw l lx ly"><strong class="lr ir">nrow(combined_data[abs(combined_data$diff_values_normalized) &gt; 0.1<br/>&amp; !is.na(combined_data$y),]) / nrow(combined_data)</strong></span></pre><p id="315b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们得到0.02，这表明基于给定的阈值，2%的数据点是异常的。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h2 id="e972" class="kt ku iq bd kv kw kx dn ky kz la dp lb jy lc ld le kc lf lg lh kg li lj lk ll bi translated">结束语</h2><p id="04ef" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">做预测是数据专业人员的一项重要技能。感谢像Prophet这样的开源项目，这不需要太困难。这个软件包平衡了简单性、计算速度和适当的定制量，因此初学者和高级用户都可以使用它。</p><p id="0e0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢阅读，<br/> <a class="ae ks" href="http://linkedin.com/in/harelrechavia" rel="noopener ugc nofollow" target="_blank"> Harel Rechavia </a>，<br/>Viber的数据分析师</p></div></div>    
</body>
</html>