<html>
<head>
<title>How to train and predict regression and classification ML models using only SQL — using BigQuery ML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何仅使用 SQL 来训练和预测回归和分类 ML 模型—使用 BigQuery ML</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-train-and-predict-regression-and-classification-ml-models-using-only-sql-using-bigquery-ml-f219b180b947?source=collection_archive---------3-----------------------#2018-07-25">https://towardsdatascience.com/how-to-train-and-predict-regression-and-classification-ml-models-using-only-sql-using-bigquery-ml-f219b180b947?source=collection_archive---------3-----------------------#2018-07-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f1ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的书(<a class="ae kl" href="http://shop.oreilly.com/product/0636920057628.do" rel="noopener ugc nofollow" target="_blank">Google 云平台上的数据科学</a>)中，我讲述了一个航班延误预测问题，并展示了如何使用包括 Spark Mlib 和 TensorFlow 在内的各种工具来解决这个问题。既然已经宣布了 BigQuery ML，我想我应该展示如何使用 BQ ML 预测航班延误。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/0093404ccb040fd5864365dc7b3780f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sx7iHL5omtYYdnc3m1hNTw.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk">Predict whether this flight will arrive late. Using only SQL.</figcaption></figure><p id="1c54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">毫无疑问，您仍然需要收集数据、探索数据、清理数据并丰富数据。基本上所有我在第 1-9 章做的事情。在第十章，我用了 TensorFlow。在本文中，我将使用 BQML。</p><h1 id="df91" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">创建回归模型</h1><p id="99ba" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">下面是一个创建模型的 BigQuery 查询:</p><pre class="kn ko kp kq gt mf mg mh mi aw mj bi"><span id="52ef" class="mk ld iq mg b gy ml mm l mn mo">#standardsql<br/>CREATE OR REPLACE MODEL flights.arrdelay</span><span id="a47a" class="mk ld iq mg b gy mp mm l mn mo">OPTIONS<br/>  (model_type='linear_reg', input_label_cols=['arr_delay']) AS</span><span id="ba12" class="mk ld iq mg b gy mp mm l mn mo">SELECT<br/>  arr_delay,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr`<br/>WHERE<br/>  arr_delay IS NOT NULL</span></pre><p id="754c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意:</p><ol class=""><li id="6484" class="mq mr iq jp b jq jr ju jv jy ms kc mt kg mu kk mv mw mx my bi translated">它从创建模型开始，模型的名称看起来就像一个表名。注意:“flights”是用于存储结果模型的数据集的名称，因此，您需要在运行查询之前创建一个空数据集。</li><li id="cceb" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">这些选项指定了算法，在本例中是线性回归算法，标签为 arr_delay</li><li id="3d4a" class="mq mr iq jp b jq mz ju na jy nb kc nc kg nd kk mv mw mx my bi translated">本质上，我在 SELECT 中引入了预测变量和标签变量</li></ol><p id="0c76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大约 10 分钟后，模型被训练，并且评估结果已经为每个迭代填充:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ne"><img src="../Images/44210e78fc3571592cc6c2383c7b03f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5yJs8iHjSH7ziXotN9LTsw.png"/></div></div></figure><p id="44b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的损失是均方误差，因此模型收敛于迭代#6，RMSE 约为 sqrt(97) = 10 分钟。</p><h1 id="14ba" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">使用模型预测</h1><p id="922b" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">训练模型的目的是用它来预测。您可以使用 SQL 语句进行模型预测:</p><pre class="kn ko kp kq gt mf mg mh mi aw mj bi"><span id="56fe" class="mk ld iq mg b gy ml mm l mn mo">#standardsql<br/>SELECT * FROM ML.PREDICT(MODEL flights.arrdelay,<br/>(<br/>SELECT<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance,<br/>  arr_delay AS actual_arr_delay<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr`<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>LIMIT 10))</span></pre><p id="1728" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这导致:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nf"><img src="../Images/11dd3827d867170cd230dde60e03823e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y55NNK22cdU0U1JFX2pUlw.png"/></div></div></figure><p id="8f79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，因为我们训练了模型来预测一个叫做“arr_delay”的变量，ML。PREDICT 创建一个名为 predicted_arr_delay 的结果列。在本例中，我从原始表中提取 10 行，并预测这些航班的到达延迟。</p><h1 id="6e7b" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">创建分类模型</h1><p id="9ab3" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在书中，我实际上并没有试图预测到达延迟。相反，我预测航班晚点超过 15 分钟的概率。这是一个分类问题，您可以通过稍微更改训练查询来做到这一点:</p><pre class="kn ko kp kq gt mf mg mh mi aw mj bi"><span id="ce05" class="mk ld iq mg b gy ml mm l mn mo">#standardsql<br/>CREATE OR REPLACE MODEL flights.ontime<br/>OPTIONS<br/>  (model_type='logistic_reg', input_label_cols=['on_time']) AS</span><span id="59c9" class="mk ld iq mg b gy mp mm l mn mo">SELECT<br/>  IF(arr_delay &lt; 15, 1, 0) AS on_time,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr`<br/>WHERE<br/>  arr_delay IS NOT NULL</span></pre><p id="67c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是评测结果:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ng"><img src="../Images/c41238cded5023b09f20abc57bde0f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NYVdlHvEzMTbOmg59l998g.png"/></div></div></figure><p id="4585" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预测的一个例子是:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ca"><img src="../Images/1cb5a4ba21e2817f387b0f2dbadd1b80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VokptN-WadcL0a5Fn0e7Iw.png"/></div></div></figure><h1 id="fc2f" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">评估模型</h1><p id="dad0" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">可以在独立的数据集上评估模型。我手边没有，所以我将只向您展示如何在模型训练的同一数据集上运行评估:</p><pre class="kn ko kp kq gt mf mg mh mi aw mj bi"><span id="ba7f" class="mk ld iq mg b gy ml mm l mn mo">#standardsql<br/>SELECT * FROM ML.EVALUATE(MODEL flights.ontime,<br/>(<br/>SELECT<br/>  IF(arr_delay &lt; 15, 1, 0) AS on_time,<br/>  carrier,<br/>  origin,<br/>  dest,<br/>  dep_delay,<br/>  taxi_out,<br/>  distance<br/>FROM<br/>  `cloud-training-demos.flights.tzcorr`<br/>WHERE<br/>  arr_delay IS NOT NULL<br/>))</span></pre><p id="48b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nh"><img src="../Images/b7e8ad05d8c492d2e5d6ab85236b194c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QF71taPhGiMQFIw-T6BBlQ.png"/></div></div></figure><p id="e274" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">BQML 真的很简单，真的很强大。尽情享受吧！</p></div></div>    
</body>
</html>