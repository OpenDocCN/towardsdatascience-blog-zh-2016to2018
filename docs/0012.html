<html>
<head>
<title>Using R to Merge the CSV Files in Code-Point Open Into One Massive File</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 R 将代码点打开的 CSV 文件合并成一个大文件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-r-to-merge-the-csv-files-in-code-point-open-into-one-massive-file-933b1808106?source=collection_archive---------0-----------------------#2017-01-14">https://towardsdatascience.com/using-r-to-merge-the-csv-files-in-code-point-open-into-one-massive-file-933b1808106?source=collection_archive---------0-----------------------#2017-01-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/df46fb7511ae7d9280a9d34d14b07fdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-h1-fFlwqSG1DiEkkQPR4w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Map courtesy Trafford Innovation and Intelligence Lab</figcaption></figure><p id="3caf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你有一个有邮政编码的数据集，例如客户数据或资产信息，你可以做的最有用的事情之一就是把数据放到地图上。为此，需要对每条记录进行地理参考。英国国家测绘局有一个开放的数据集，叫做<a class="ae la" href="https://www.ordnancesurvey.co.uk/business-and-government/products/code-point-open.html" rel="noopener ugc nofollow" target="_blank"> Code-Point Open </a>，你可以从他们的开放数据网站上获得。该数据集允许您在自己的数据中查找邮政编码，以找到它们的坐标，这样您就可以将它们放在地图上。</p><p id="05f4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">英国国家测绘局的数据集包含在一个 zip 文件中，当您提取它时，它由 120 个 csv 文件组成。这可能是一个棘手的问题，所以我将展示如何使用 R(实际上是 R Studio)将所有这些 csv 文件合并成一个文件。还有其他方法可以做到这一点——手动(😱)、编写批处理文件、MS Visual Basic 等，但这是一种优雅而快速的完成方式。</p><p id="56cd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">首先，打开 R Studio，创建一个新项目。在项目文件夹中新建一个文件夹，命名为‘temp’。你现在需要从英国测绘局复制 120 个 csv 文件到这个文件夹。</p><p id="e718" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">之后，在 R Studio 控制台中，我们需要将这个项目的工作目录设置为 temp 文件夹:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="849b" class="lk ll iq lg b gy lm ln l lo lp">setwd(‘temp/’)</span></pre><p id="f756" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后，我们需要将该文件夹中所有内容的文件名传递到一个变量中:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="4a61" class="lk ll iq lg b gy lm ln l lo lp">filenames &lt;- list.files(full.names=TRUE)</span></pre><p id="9486" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这将遍历该文件夹中的文件，挑选出文件名，并将它们传递到变量‘filenames’中。我们现在将使用这些文件名来遍历文件，从每个 csv 文件中提取数据，并将其合并到一个列表中(注意，这将需要几秒钟的时间来完成):</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="d964" class="lk ll iq lg b gy lm ln l lo lp">All &lt;- lapply(filenames,function(i){<br/>read.csv(i, header=FALSE, skip=4)<br/>})</span></pre><p id="8f4c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这会将数据推入变量“All”中。如果我们查看“环境”选项卡，我们可以看到这是一个包含 120 个元素的“大列表”，大小为 156Mb。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lq"><img src="../Images/2b1445f2a788ee114e98ef1a1975ff83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rrv-7vDSJDhQCadyAa3K9g.png"/></div></div></figure><p id="8657" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了使用数据集，或者在 R 中进行匹配，或者保存为它自己的 csv 文件，我们需要将它转换为 dataframe。为此，我们可以运行以下命令:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="465a" class="lk ll iq lg b gy lm ln l lo lp">df &lt;- do.call(rbind.data.frame, All)</span></pre><p id="f484" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了检查数据帧的内容，我们可以使用 head 函数显示前几行数据:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="865b" class="lk ll iq lg b gy lm ln l lo lp">head(df)</span></pre><p id="3eb1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这给了我们这个:</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lr"><img src="../Images/18f4b6dc4508c76440009899a3848ca0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zWVlSLtTT2oY9JoEZ2UWIg.png"/></div></div></figure><p id="8c4b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这看起来不错(尽管将列重命名为更有意义的名称可能是个好习惯)。V1 有邮政编码，V3 和 V4 是英国坐标系参考。最后，要将这个大的邮政编码列表保存为一个新的 csv 文件，我们可以使用 write.csv:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="2a1a" class="lk ll iq lg b gy lm ln l lo lp">write.csv(df,”all_postcodes.csv”, row.names=FALSE)</span></pre><p id="4223" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这将在 R Studio 项目文件夹的 temp 文件夹中创建一个新的(大量的)csv 文件。从这里，您可以将邮政编码文件与您自己的数据合并，以便在 R 中进行地理参考，或者您可以在 Excel 中进行 vlookups。</p><p id="bee5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请注意，本练习之所以有效，是因为每个 csv 文件在数据列数方面具有相同的形状。对于不同的数据集，这种过程变得更加复杂。</p><p id="ba3d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">下面是一次性完成的所有代码:</p><pre class="lb lc ld le gt lf lg lh li aw lj bi"><span id="b091" class="lk ll iq lg b gy lm ln l lo lp">setwd(‘temp/’)<br/>filenames &lt;- list.files(full.names=TRUE)<br/>All &lt;- lapply(filenames,function(i){<br/>read.csv(i, header=FALSE, skip=4)<br/>})<br/>df &lt;- do.call(rbind.data.frame, All)<br/>write.csv(df,”all_postcodes.csv”, row.names=FALSE)</span></pre></div></div>    
</body>
</html>