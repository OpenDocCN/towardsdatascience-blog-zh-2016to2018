<html>
<head>
<title>Building a machine learning ensemble classifier on NY taxi data to predict no tips vs generous tips with Python &amp; Google BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在纽约出租车数据上建立一个机器学习集成分类器，用Python和Google BigQuery预测没有小费和慷慨的小费</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-ml-classifier-on-ny-city-taxi-data-to-predict-no-tips-vs-generous-tips-with-python-92e21d5d9fd0?source=collection_archive---------3-----------------------#2017-05-17">https://towardsdatascience.com/building-a-ml-classifier-on-ny-city-taxi-data-to-predict-no-tips-vs-generous-tips-with-python-92e21d5d9fd0?source=collection_archive---------3-----------------------#2017-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="68a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我通过构建一个分类器来展示Google BigQuery引擎的强大功能，该分类器将预测乘坐纽约市的出租车是会得到丰厚的小费还是根本没有小费。作为这项工作的一部分，我探索数据集并查看数据集中的关系。我还想象了城市周围的拾音器，结果是一个散点图，基本上画出了纽约的街道。</p><p id="0be1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我主要介绍了BigQuery UI、python API和pandas库，这些库与直接从Jupiter notebook和sklearn执行SQL查询相关。我描述了在BigQuery中克服的挑战，包括通过API和UI执行的查询之间的一些语法差异。很多在线文档都过时了，因此我的示例代码应该是执行自己项目的有用资源。</p><p id="90f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，对于那些对构建分类器和元分类器感兴趣的人来说，我使用simple来理解标签和输入，这对那些希望实现自己的分类器的人来说应该是一个有用的参考。我还演示了如何处理缺失值。</p><p id="d930" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">big query背景</strong></p><p id="f928" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">BigQuery是Google内部使用的查询服务Dremel的公共实现。</p><p id="f3d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Dremel可以在几十秒内扫描350亿行而不用索引。云驱动的大规模并行查询服务Dremel共享谷歌的基础设施，因此它可以并行化每个查询，并在数万台服务器上同时运行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4234589e17fdeba4ab65515895b134ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r4wyi56cS7Jbe5S_vQ8Afw.png"/></div></div></figure><p id="db03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用BigQuery的第一步是授权一个google cloud帐户。这是通过访问https://console.cloud.google.com<a class="ae kx" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">并遵循授权协议来完成的。您还需要提供一张信用卡来支付账单。注册开始时，您将获得价值300美元的积分，这对于探索和运行示例查询来说绰绰有余。</a></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/d82eb62d8d036ba35220d494fe50327a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*ztZWEd96QWZk0KUFSZQEgw.png"/></div></figure><p id="b8de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您将登录到google cloud dashboard，下一步是创建一个项目(您可以有多个项目)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kz"><img src="../Images/0a87e8c0d7fdfef497b55be0631e6b46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vNZUfYzSnNNLmvWWuJKi6Q.png"/></div></div></figure><p id="626a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，您可以通过单击左侧的菜单并选择“bigquery”来访问BigQuery</p><p id="1512" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将加载BigQuery WebUI</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi la"><img src="../Images/9dafd62dfa2c7415661777e241a85948.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L69bsoZAxc3sjIzxjUOomg.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lb"><img src="../Images/d2fc734337a12d6865045595800ec70b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R2Htt6TrEvP0mqydsvECPg.png"/></div></div></figure><p id="9dc7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们看到有130GB关于纽约出租车旅行的数据和11亿行。BigQuery处理所有这些数据大约只需要30秒。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lc"><img src="../Images/3cf5976f4379c3b01c2b8d6512d68dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jCDz8LvsqdKtJ_GVcHpRyA.png"/></div></div></figure><p id="8bb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我首先导入pandas，因为pandas中有一个专门设计的方法来查询bigquery，并以pandas dataframe的形式返回结果。</p><p id="b6e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还导入matplotlib进行可视化。</p><p id="0831" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用的数据已经存储在谷歌云中，所有人都可以使用——我使用它是为了演示，因为任何人都可以访问它并运行查询。</p><p id="5019" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为对数据的初步演示和探索，我展示了通过将SQL代码直接传递给pandas方法进行查询的能力，方法是按月查看数据中的出租车出行次数。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ld"><img src="../Images/4b5aa371640318d719653635040c5a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Al14v9f9ixK9JjJ2lbTN5w.png"/></div></div></figure><p id="0fe2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我研究了这些数据，并分析了小费和不同特征之间的关系。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/472cc1dbd3b193a1970bf08fb2b27694.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SxDZvOh04q9iKkqTZUl7fg.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lf"><img src="../Images/c94a7d522cd046357483d6dcfb450fc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4GSPcHMiK4gekEv-_H8zkw.png"/></div></div></figure><p id="7008" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我汇总了纽约每个经度和纬度坐标上的皮卡数量</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/cc6b3da7a85c5eb8119b6ca2c71c4f62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p5_PMUtik5-KIqUbzy23JA.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lg"><img src="../Images/26a6e734a6e2cf5f71ade26b9658b719.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GKwjInLBBhVLZkxfOWKgxQ.png"/></div></div></figure><p id="2706" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我能够将这些数据输入散点图，根据出租车搭载乘客的地点，得出纽约相当清晰的轮廓。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/30cce8a073f0b2e17a0bf7ed5ae57479.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5PZQhbijP5KLJ_wTj7Sudw.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/b1147b922367e20c11fdf4cab9f822f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ThqimSr0KE-Pe4fjFeP7Q.png"/></div></div></figure><p id="dc38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据我对数据的研究，我发现只有3%的用信用卡支付的旅行没有小费，所以我决定为了分类的目的，我们将尝试并预测两种极端情况，这两种情况需要人们在纽约出租车上手动取消——没有小费和非常慷慨的小费(“慷慨”是指超过车费的30%)</p><p id="dd4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我着手提取相关信息，并给它们贴上标签。</p><p id="108d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我首先创建两个独立的数据集，在每个数据集上做标记，然后将它们合并。</p><p id="0f3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我平衡数据，所以一半的数据将是慷慨的，另一半没有提示，所以我的分类器只需要做得比50%更好就可以被认为是有用的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/687f79369d1a2e2a2f2e501be2c76754.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v5cotxBcryu6tv81JgSkeQ.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/abb437339e373eb035138d36c8d4f042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VBvX3McP3MpxaSvD1AQRfw.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/9910be7e4d0def10ab38ebfb9716a8d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rV-HzkpHODnJJ0mPjGRi6Q.png"/></div></div></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/eb160b4c42b83a63ff5aa00e4004d274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gL6Smfn-4xZToipgYuuYzw.png"/></div></div></figure><p id="e048" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在已经得到了我的标签(Y)和特征(X)，我建立分类器。我使用sklearns分类器KNN，贝叶斯，逻辑回归和决策树，并使用它们的输出来输入一个集成或“元分类器”，然后给出结果。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/3c16a49d87952d2261d5007e0b6e508b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5NPN0Gi-wz42LXcCsFh-Rg.png"/></div></div></figure><p id="7469" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们运行培训和测试时，我们会看到以下结果:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi le"><img src="../Images/264cdf425ff4d595838b8658a56c7bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RdrXJvgTit2fKw9XDHgHcQ.png"/></div></div></figure><p id="ffb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">准确度:0.67(+/-0.12)[decision tree classifier]<br/>准确度:0.91(+/-0.14)【LogReg】<br/>准确度:0.77(+/-0.10)【KNN】<br/>准确度:0.67(+/-0.01)【NB】<br/><strong class="jp ir">准确度:0.83 (+/- 0.12)【系综】</strong></p><p id="b9a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论:</strong></p><p id="4e8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">鉴于上述结果，我已经能够成功地建立一个元分类器，它将预测哪里的旅行更有可能导致司机没有小费或“慷慨”的小费。</p><p id="030a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">诸如此类的分类器可能有助于捕捉欺诈。例如，该数据仅使用信用卡交易，因为所有小费信息都被捕获，但当使用现金时，由于税务后果，司机可能不会报告小费-像所构建的分类器这样的分类器可用于了解我们何时应该看到小费被记录，或不被记录，并识别异常。</p><p id="fafb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">github Repo:<a class="ae kx" href="https://github.com/cjflanagan/NYtaxi_Tips_Classifier_with_BigQuery-/blob/master/NYTaxi.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/cjflanagan/ny taxi _ Tips _ Classifier _ with _ big query-/blob/master/ny taxi . ipynb</a></p></div></div>    
</body>
</html>