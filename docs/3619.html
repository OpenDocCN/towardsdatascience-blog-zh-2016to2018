<html>
<head>
<title>OCR with Akka, Tesseract, and JavaCV</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有 Akka、Tesseract 和 JavaCV 的 OCR</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ocr-with-akka-tesseract-and-javacv-part-1-702781fc73ca?source=collection_archive---------2-----------------------#2018-06-01">https://towardsdatascience.com/ocr-with-akka-tesseract-and-javacv-part-1-702781fc73ca?source=collection_archive---------2-----------------------#2018-06-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8d4ff9926e99a1673ac368661e703d50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c8JnSWGYNiGzuys8QbJTjw.jpeg"/></div></div></figure><p id="d920" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我最近有一个用例，需要从 PDF 文档中提取姓名和日期。我认为，利用 google 的 tesseract 来执行基本的 OCR，构建一个快速的程序是非常容易的。只需几行代码，您就可以让 node-tesseract 在图像上运行 OCR。但是，如果图像是倾斜的、有噪声的或者其中有一堆图像，那么来自 tesseract 的文本结果将变得不可用。</p><p id="f82a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Tesseract <a class="ae kw" href="https://github.com/tesseract-ocr/tesseract/wiki/ImproveQuality#dictionaries-word-lists-and-patterns" rel="noopener ugc nofollow" target="_blank">文档</a>列出了一系列预处理图像以提高 OCR 质量的方法:</p><ul class=""><li id="364b" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">重新缩放</li><li id="07b9" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">二值化</li><li id="ef61" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">噪声消除</li><li id="c6ef" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">旋转(去歪斜)</li><li id="5bdc" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">边界移除</li></ul><p id="a2ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从图像中提取文本需要很多步骤。我仍然需要执行日期提取和命名实体提取。问题是我不熟悉这些预处理和提取技术。所以我认为构建一个能够拥有可插拔架构的<em class="ll">系统</em>是一个好主意——我可以在学习如何实现它们时添加步骤。如果图像可以通过这些不同的转换阶段<em class="ll">流动</em>不是很好吗？😉</p><figure class="ln lo lp lq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lm"><img src="../Images/8334c8b09f0c3279e5c77a15337026c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OGVdqQKxy86ZIkZu8StuQA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk">Akka Stream</figcaption></figure><h2 id="e9ed" class="lv lw iq bd lx ly lz dn ma mb mc dp md kj me mf mg kn mh mi mj kr mk ml mm mn bi translated">旅程</h2><p id="9c6a" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">让我们构建一个 REST 服务器，它接受图片作为上传，其中各个端点将返回各种结果。Tess4j 库有许多方便的方法，其中一些我们将用于图像去倾斜和二值化。我们将使用 JavaCV，一个<a class="ae kw" href="https://opencv.org/" rel="noopener ugc nofollow" target="_blank"> OpenCV </a>包装器，用于图像去噪和一般增强。</p><blockquote class="mt mu mv"><p id="87a4" class="jy jz ll ka b kb kc kd ke kf kg kh ki mw kk kl km mx ko kp kq my ks kt ku kv ij bi translated"><em class="iq">我们最终将用</em><a class="ae kw" href="http://opennlp.apache.org/" rel="noopener ugc nofollow" target="_blank"><em class="iq">OpenNLP</em></a><em class="iq">和</em><a class="ae kw" href="https://github.com/joestelmach/natty" rel="noopener ugc nofollow" target="_blank"><em class="iq">Natty</em></a><em class="iq">以及使用拼写检查器</em> <a class="ae kw" rel="noopener" target="_blank" href="/enriching-ocr-with-akka-streams-7e48990be929"> <em class="iq">增强 OCR 输出——第 2 部分</em> </a> <em class="iq">。</em></p></blockquote><p id="8e66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我拍了一本书的一页。这将作为系统的输入。注意图片的微小角度。</p><figure class="ln lo lp lq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/97d426bc40d07c099d66fba1a428097d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0WYAH8HcVg-GR_pQvGmOdg.jpeg"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk">input.jpg</figcaption></figure></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h2 id="d959" class="lv lw iq bd lx ly lz dn ma mb mc dp md kj me mf mg kn mh mi mj kr mk ml mm mn bi translated">必需的软件库</h2><ul class=""><li id="cf36" class="kx ky iq ka b kb mo kf mp kj nh kn ni kr nj kv lc ld le lf bi translated"><a class="ae kw" href="http://tess4j.sourceforge.net/" rel="noopener ugc nofollow" target="_blank"> Tess4j </a></li><li id="7308" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://github.com/bytedeco/javacv" rel="noopener ugc nofollow" target="_blank"> JavaCV </a></li><li id="2ef9" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://akka.io/" rel="noopener ugc nofollow" target="_blank"> Akka HTTP/Streams </a></li></ul><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="0163" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们创建一个特征来保存宇宙魔方；我们稍后将能够混合这个。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="5358" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们将使用 Akka Http 创建我们的基础应用程序，它将绑定到端口 8080。我们创建了一个 rest 端点，它将图像读入内存，并且不做任何处理。该端点最终将返回预处理的图像。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="7dd6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我们所看到的，我们的图像是类型<code class="fe nm nn no np b">BufferedImage</code>的，我们可以使用 Tess4j 的助手方法来创建一个二进制图像。我们将创建一个 BufferedImage 流，它将帮助器函数映射到传入的 BufferedImages。二值化会将图像转换为黑白。这对于文本上有阴影的图像来说效果不好，但是我会在后面详细说明。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="679b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，我们可以再次使用 Tess4j 来消除图像的倾斜。让我们再创建两个流:一个用最小去歪斜角阈值去歪斜一个<code class="fe nm nn no np b">BufferedImage</code>，另一个从一个<code class="fe nm nn no np b">BufferedImage</code>获取字节，这样我们就可以将字节发送回客户端。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="3844" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们可以将上述所有流程结合起来，更新我们的服务器。我们将利用内存中的映像制作一个<code class="fe nm nn no np b">Source</code>，将流链接在一起，并将其传递给 Akka 的<code class="fe nm nn no np b">complete()</code>方法。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="7e3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对我们的服务器运行一个简单的 curl 将会返回我们预处理过的图像。</p><pre class="ln lo lp lq gt nq np nr ns aw nt bi"><span id="2943" class="lv lw iq np b gy nu nv l nw nx">curl -X POST -F 'fileUpload=@/Users/duanebester/Desktop/blog/input.jpg' 'http://localhost:8080/image/process' --output output.png</span></pre><p id="47b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我们的二进制，去歪斜的图像:</p><figure class="ln lo lp lq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/3e8aaa91cb8d2dd3f37a30b80d8ed2e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nxUE9UlnFk3nikMCYHVWSg.png"/></div></div></figure><p id="6513" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">厉害吧！？现在我们已经有了流畅的一切，我们可以简单地添加更多的片段来进一步提升我们的形象。此时，我们可以将图像传递给 tesseract，并让它执行 OCR 以给出一个字符串。然而，我觉得 OpenCV 中有太多的图像处理魔法，我们应该使用。</p><h2 id="f342" class="lv lw iq bd lx ly lz dn ma mb mc dp md kj me mf mg kn mh mi mj kr mk ml mm mn bi translated">JavaCV 和 OpenCV</h2><p id="5f5a" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">JavaCV 和 OpenCV 使用一个称为 Mat 的对象来执行它们的图像处理。面临的挑战是将 Java <code class="fe nm nn no np b">BufferedImage</code>转换成 JavaCV <code class="fe nm nn no np b">Mat</code>，然后再转换回来，下面是实现这一点的流程:</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="1aee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在可以流一个<code class="fe nm nn no np b">BufferedImage ~&gt; Mat ~&gt; BufferedImage</code>😎</p><p id="6052" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">OpenCV 有<em class="ll">fastnlmeansdexing</em>和<em class="ll"> detailEnhance </em>方法，我们可以在<code class="fe nm nn no np b">Mat</code>中使用它们——所以让我们将这些方法包装在<code class="fe nm nn no np b">Flow[Mat]</code>中</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><h2 id="7754" class="lv lw iq bd lx ly lz dn ma mb mc dp md kj me mf mg kn mh mi mj kr mk ml mm mn bi translated">我们现在可以</h2><ol class=""><li id="e419" class="kx ky iq ka b kb mo kf mp kj nh kn ni kr nj kv nz ld le lf bi translated">创建二进制文件<code class="fe nm nn no np b">BufferedImage</code></li><li id="04e1" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv nz ld le lf bi translated">将其转换为<code class="fe nm nn no np b">Mat</code>并增强</li><li id="0de8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv nz ld le lf bi translated">将其转换回一个<code class="fe nm nn no np b">BufferedImage</code></li><li id="7892" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv nz ld le lf bi translated">消除<code class="fe nm nn no np b">BufferedImage</code>的偏斜，然后将其发送回客户端</li></ol><figure class="ln lo lp lq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/b5a8f7006a4dcd5c37278cf38d24cfdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Da8nX91WFrfoHByXx-g4qA.png"/></div></div><figcaption class="lr ls gj gh gi lt lu bd b be z dk">A smoother &amp; enhanced image</figcaption></figure><p id="c1b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以在这里添加缩放，这样我们就可以发送一个更小的图像，基本上是裁剪上面图像中的文本，以便 tesseract 进行处理，但还没有到那一步😅</p><p id="57db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ll">最后一个</em>部分是对<code class="fe nm nn no np b">BufferedImage</code>执行 OCR，并将结果字符串发送回客户端。我们创建一个将返回一个<code class="fe nm nn no np b">String</code>的<code class="fe nm nn no np b">Flow[BufferedImage]</code>——我们还更新了我们的 web 服务器以添加这些额外的流。</p><figure class="ln lo lp lq gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="6bc7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们运行新的 curl 来获得 JSON 响应时:</p><pre class="ln lo lp lq gt nq np nr ns aw nt bi"><span id="97ed" class="lv lw iq np b gy nu nv l nw nx">curl -X POST -F 'fileUpload=@/Users/duanebester/Desktop/blog/input.jpg' 'http://localhost:8080/image/ocr'</span></pre><p id="da7d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们得到我们的文本结果:</p><pre class="ln lo lp lq gt nq np nr ns aw nt bi"><span id="26e5" class="lv lw iq np b gy nu nv l nw nx">CHAPTER 1<br/>THE COMPOUND EFFECT IN ACTION<br/>You know that expression, ”Slow and steady Wins the<br/>race”? Ever heard the story of the tortoise and the hare?<br/>Ladies and gentlemen, I’m the tortoise. Give me enough<br/>time, and I will beat Virtually anybody, anytime, in any<br/>competition. Why? Not because I’m the best or the smartest<br/>or the fastest. I’ll win because of the positive habits I’ve<br/>developed, and because of the consistency I use in applying<br/>those habits. I’m the world’s biggest believer in consistency.<br/>I’m living proof that it’s the ultimate key to success, yet it’s<br/>one of the biggest pitfalls for people struggling to achieve.<br/>Most people don’t know how to sustain it. I do. I have my<br/>father to thank for that. In essence, he was my first coach<br/>for igniting the power of the Compound Effect.<br/>My parents divorced when I was eighteen <strong class="np ir">mohths 01d</strong>,<br/>and my dad raised me as a single father. He <strong class="np ir">wasn t</strong> exactly</span></pre><p id="1303" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">页面朝着图片的底部变得波浪状，宇宙魔方认错了<em class="ll">个月大的</em>，忘记了<em class="ll">中的撇号不是</em>。尽管如此，我们在上述转换中实现了 99.67%的准确率！</p><p id="413a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如你所看到的，有了这个系统，添加我们需要的部件非常容易。我们可以考虑获取字符串结果，并将其传递给更多的阶段，这些阶段可以执行某些拼写检查和名称/日期提取。</p><p id="3a9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢并继续<a class="ae kw" rel="noopener" target="_blank" href="/enriching-ocr-with-akka-streams-7e48990be929"> Part 2 </a>！</p><p id="9597" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">~杜安</p></div></div>    
</body>
</html>