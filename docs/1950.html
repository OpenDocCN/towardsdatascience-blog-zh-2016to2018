<html>
<head>
<title>How to build recurring web spider jobs using Scrapy, ScrapingHub, and Amazon S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Scrapy，ScrapingHub 和亚马逊 S3 建立重复的网络蜘蛛工作</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-build-recurring-web-spider-jobs-using-scrapy-scrapinghub-and-amazon-s3-43dbe3c73b69?source=collection_archive---------3-----------------------#2017-11-21">https://towardsdatascience.com/how-to-build-recurring-web-spider-jobs-using-scrapy-scrapinghub-and-amazon-s3-43dbe3c73b69?source=collection_archive---------3-----------------------#2017-11-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/1555cc777981fc7831467c540e87f2be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDkOuq2YeX-3meeovZAWQg.jpeg"/></div></div></figure><p id="a3d6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最近我和一个好朋友一直在尝试自学机器学习。根据许多行业专家的说法，在未来 10-15 年内保持有收入的工作是编程世界的必要的下一步。</p><p id="8f59" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="kz">注:如果你听说过同样的事情，但不确定从哪里开始，我会给你指出这个不可思议的</em> <a class="ae la" href="https://medium.com/machine-learning-for-humans/why-machine-learning-matters-6164faf1df12" rel="noopener"> <em class="kz">中帖</em> </a> <em class="kz">和这个</em> <a class="ae la" href="https://www.coursera.org/learn/machine-learning" rel="noopener ugc nofollow" target="_blank"> <em class="kz"> Coursera 课程</em> </a> <em class="kz">来开始。</em></p><p id="34db" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们很快遇到的一个问题是需要一个数据集。虽然世界上有很多令人难以置信的有趣的数据集可以免费下载，但我们有特定的兴趣(<a class="ae la" href="https://launchmanifest.io/" rel="noopener ugc nofollow" target="_blank">火箭发射</a>，太空探索，火星等等。)并认为通过刮刮来建造我们自己的会很有趣。</p><p id="fddb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就我个人而言，我从来没有构建过一个 scraper(或者使用 Python)，但是我认为这不会太难。我们花了大约一天半的时间来构建我们的蜘蛛，让它们按照每天的时间表运行，并将数据放入 S3 桶中。</p><p id="6b02" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">很难找到任何关于这个过程的指南，所以我想我应该写下我们是如何做的，并在互联网上公开我们的过程。如果您看到我们做错了什么，请随时告诉我们如何才能做得更好。我们正在学习。</p><h2 id="3ba2" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">建造蜘蛛</h2><ol class=""><li id="2bc1" class="lu lv it kd b ke lw ki lx km ly kq lz ku ma ky mb mc md me bi translated">安装<a class="ae la" href="https://scrapy.org/" rel="noopener ugc nofollow" target="_blank">Scrapy</a>——他们的文档是令人敬畏的。如果您遵循<a class="ae la" href="https://docs.scrapy.org/en/latest/intro/install.html" rel="noopener ugc nofollow" target="_blank">安装指南</a>，应该没有问题</li><li id="5f58" class="lu lv it kd b ke mf ki mg km mh kq mi ku mj ky mb mc md me bi translated">安装依赖项:<a class="ae la" href="https://github.com/boto/boto" rel="noopener ugc nofollow" target="_blank"> boto </a>(可能已经安装，这取决于你如何安装 Scrapy) &amp; <a class="ae la" href="https://github.com/theskumar/python-dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a>(这是为了不检查 AWS 的秘密到我们的 VCS)</li><li id="eb6e" class="lu lv it kd b ke mf ki mg km mh kq mi ku mj ky mb mc md me bi translated">用<code class="fe mk ml mm mn b">scrapy startproject directoryname</code>建立一个新的 Scrapy 项目</li></ol><p id="fc77" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您应该有一个<code class="fe mk ml mm mn b">scrapy.cfg</code>文件和一个目录(在上面的步骤中命名。)在目录内部，您将看到 Scrapy 的工作原理。首先，我们将使用<code class="fe mk ml mm mn b">settings.py</code>和<code class="fe mk ml mm mn b">/spiders</code>目录。</p><p id="5c6f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们开始建造蜘蛛。进入您的<code class="fe mk ml mm mn b">/spiders</code>目录并创建一个新的<code class="fe mk ml mm mn b">spidername.py</code>文件。这里有一个使用 CSS 和 XPath 选择器的蜘蛛示例。</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="dd03" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是一个难以置信的简化版本，但让我们现实一点。你的需求会有所不同，Scrapy 的文档比我在这篇文章中写的要好 100 倍。重要的是要认识到，你可以创建多个<code class="fe mk ml mm mn b">spider.py</code>文件，并为不同的网站有不同的蜘蛛。</p><p id="0497" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦你的蜘蛛启动并运行，下一步就是正确设置你的<code class="fe mk ml mm mn b">settings.py</code>文件。</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="530b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Scrapy 为您提供了大量样板代码。我只包括我修改过的相关部分。您会注意到几件重要的事情:</p><ol class=""><li id="44a2" class="lu lv it kd b ke kf ki kj km mu kq mv ku mw ky mb mc md me bi translated">通过遵守<code class="fe mk ml mm mn b">robots.txt</code>并在抓取之前手动检查每个网站的服务条款，我们成为了互联网的好公民。我们不刮那些要求不被刮的网站。</li><li id="38ff" class="lu lv it kd b ke mf ki mg km mh kq mi ku mj ky mb mc md me bi translated">我们使用<code class="fe mk ml mm mn b">dotenv</code>来保护我们的 AWS 访问密钥 id 和秘密访问密钥。这意味着您将在与<code class="fe mk ml mm mn b">settings.py</code>相同的目录中拥有一个<code class="fe mk ml mm mn b">.env</code>文件。您会希望将<code class="fe mk ml mm mn b">.env</code>包含在您的<code class="fe mk ml mm mn b">.gitignore</code>中。</li><li id="26c1" class="lu lv it kd b ke mf ki mg km mh kq mi ku mj ky mb mc md me bi translated">Scrapy 的超级合法部分是，你需要的只是为它设置的几个选项，以处理向 S3 的推送。</li></ol><p id="7431" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">酷毙了。我们已经准备好了。一旦我们给了它正确的凭证，蜘蛛就被构建好了，并且<code class="fe mk ml mm mn b">settings.py</code>已经准备好将数据推送到 S3。</p><h2 id="7515" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">设置 AWS</h2><p id="7121" class="pw-post-body-paragraph kb kc it kd b ke lw kg kh ki lx kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">如果你不熟悉 AWS，它可能会相当吓人。我们需要做两件事:</p><ol class=""><li id="e94a" class="lu lv it kd b ke kf ki kj km mu kq mv ku mw ky mb mc md me bi translated">创建一个 IAM 用户，并获取访问密钥 id 和秘密访问密钥</li><li id="460f" class="lu lv it kd b ke mf ki mg km mh kq mi ku mj ky mb mc md me bi translated">设置一个存储桶并添加正确的权限</li></ol><p id="10b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">IAM 用户可能有点棘手，所以我建议阅读 AWS 的<a class="ae la" href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html" rel="noopener ugc nofollow" target="_blank">文档</a>。实际上，您需要登录 AWS 控制台，进入 IAM 部分，创建一个新用户，然后<a class="ae la" href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html" rel="noopener ugc nofollow" target="_blank">生成一个访问密钥</a>。我建议创建这个用户仅仅是为了对您的 bucket 进行 API 调用。您将需要来自您创建的用户的三个字符串。把它们保存在安全的地方。</p><ul class=""><li id="5266" class="lu lv it kd b ke kf ki kj km mu kq mv ku mw ky na mc md me bi translated">用户 ARN</li><li id="6b48" class="lu lv it kd b ke mf ki mg km mh kq mi ku mj ky na mc md me bi translated">访问密钥 ID</li><li id="fc97" class="lu lv it kd b ke mf ki mg km mh kq mi ku mj ky na mc md me bi translated">秘密访问密钥</li></ul><p id="3ab3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，让我们设置一个新的铲斗。这很简单。<a class="ae la" href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html#create-bucket-intro" rel="noopener ugc nofollow" target="_blank">创建您的存储桶</a>，然后导航至“权限”选项卡。您需要设置一个 bucket 策略，允许您刚刚创建的 IAM 用户将数据推送到这个 bucket。这是我们的样子:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="c07b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">必要时，交换<code class="fe mk ml mm mn b">[your-user-id]</code>和<code class="fe mk ml mm mn b">[your-bucket-name]</code>部件。这可能不言而喻，但不包括[]。</p><p id="06fc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，将访问 id 和密钥添加到 Scrapy 项目中的<code class="fe mk ml mm mn b">.env</code>文件中。</p><h2 id="c0bf" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">部署到报废网络</h2><p id="d5e4" class="pw-post-body-paragraph kb kc it kd b ke lw kg kh ki lx kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">ScrapingHub 是由支持 Scrapy 和十几个其他开源项目的了不起的人运营的一个漂亮的服务。手动触发蜘蛛抓取是免费的，但它有一个非常合理的价格<a class="ae la" href="https://scrapinghub.com/scrapy-cloud" rel="noopener ugc nofollow" target="_blank"> $9 /月计划</a>，允许单个蜘蛛在任何给定时间并发运行。对于我们的需求，它允许我们每 5 分钟调度不同的蜘蛛，即 280+独特的蜘蛛，只要它们的运行时间是&lt; 5 分钟。</p><p id="f40d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们在最后冲刺阶段。这部分很简单。您将创建一个 ScrapingHub 帐户，登录并生成一个 API 密钥。你将<a class="ae la" href="https://github.com/scrapinghub/shub" rel="noopener ugc nofollow" target="_blank">安装</a> <code class="fe mk ml mm mn b">shub</code>，清除掉 Hub 的命令行界面，并按照指示添加你的密钥和项目 ID。</p><p id="8f38" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">注意:</strong>如果你已经用<code class="fe mk ml mm mn b">.env</code>混淆了你的 AWS id &amp;密钥，那么在部署到 ScrapingHub 之前，你需要在你的<code class="fe mk ml mm mn b">settings.py</code>中注释掉几行。即上面要点中的第 5-7 行和第 14-18 行。</p><p id="eaae" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦一切就绪，你就可以使用<code class="fe mk ml mm mn b">shub deploy</code>将你的项目推向报废。</p><p id="f0ff" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您需要做的最后一件事是进入蜘蛛设置区域，手动添加 AWS 凭证。您会注意到，我们还添加了一个超时，以确保如果出现任何错误，我们会正常失败。</p><figure class="mo mp mq mr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/45747e664c0cff49583917a6b907d4cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GEUOc3MuAT__0aOZKEAyCw.png"/></div></div></figure><p id="b6af" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你完了！嗯，差不多了。</p><p id="4f8b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我建议首先至少手动运行一次蜘蛛，检查 S3 桶中生成的文件，并确保您对所有结果都满意。一旦你对此感到满意，转到你的项目的定期作业部分，设置你的蜘蛛在你需要的任何时间间隔运行。例如，世界协调时每天 04:30。</p><h2 id="8fc0" class="lb lc it bd ld le lf dn lg lh li dp lj km lk ll lm kq ln lo lp ku lq lr ls lt bi translated">摘要</h2><p id="fc9a" class="pw-post-body-paragraph kb kc it kd b ke lw kg kh ki lx kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">我意识到这并不是对每一行代码或点击的每一个按钮的完全详尽的指导，但希望它能让你步入正轨。接下来，我们将获取生成的 CSV 文件，规范化数据，并将其插入 Postgres 数据库。</p><p id="c8d3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请关注我的最新消息！</p></div></div>    
</body>
</html>