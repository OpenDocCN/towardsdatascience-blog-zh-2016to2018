<html>
<head>
<title>Getting Started with Airflow Using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Docker 开始使用气流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-airflow-using-docker-cd8b44dbff98?source=collection_archive---------1-----------------------#2018-11-01">https://towardsdatascience.com/getting-started-with-airflow-using-docker-cd8b44dbff98?source=collection_archive---------1-----------------------#2018-11-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/c84dc70ed1f7c636a3df66a3aab83f29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ok0GasdsSJD0Qrv_OfkC5g.jpeg"/></div></div></figure><div class=""/><p id="db0c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最近，在受到 Robert Chang 的这篇介绍数据工程领域的伟大文章的启发后，我一直在集中阅读该领域的内容。这篇文章的潜在信息真的引起了我的共鸣:当大多数人想到数据科学时，他们会立即想到谷歌或 Twitter 等非常成熟的科技公司正在做的事情，比如一直部署超级复杂的机器学习模型。</p><p id="15b7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而，许多组织还没有达到将这类模型作为首要任务的阶段。这是因为，为了高效地构建和部署这类模型，您需要有一个基础数据基础设施来构建模型。是的，你可以用你组织中的数据开发一个机器学习模型，但你必须问:你花了多长时间做这件事，你的工作是可重复/可自动化的吗，你能够以有意义和可靠的方式部署或实际使用你的解决方案吗？这就是数据工程的用武之地:它是关于构建数据仓库和 ETL 管道(提取-转换-加载)的，这些管道提供了做其他事情所需的基础管道。</p><p id="bd6b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我对数据工程的研究中不断出现的一个工具是<a class="ae kz" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>，它是“一个以编程方式创作、调度和监控工作流的平台”。本质上，气流是类固醇上的<a class="ae kz" href="https://en.wikipedia.org/wiki/Cron" rel="noopener ugc nofollow" target="_blank"> cron </a>:它允许你安排任务运行，以特定的顺序运行它们，并且监控/管理你所有的任务。它在数据工程师/数据科学家中变得非常流行，成为编排 ETL 管道并在它们运行时监控它们的一个很好的工具。</p><p id="4bb9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇文章中，我将对气流中的一些关键概念做一个简单的概述，然后展示气流在 Docker 容器中的一步一步的部署。</p><h1 id="c094" class="la lb je bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">关键气流概念</h1><p id="5c6a" class="pw-post-body-paragraph kb kc je kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">在我们开始部署气流之前，有几个基本概念需要介绍。参见气流文档中的<a class="ae kz" href="https://airflow.apache.org/concepts.html" rel="noopener ugc nofollow" target="_blank">这一页，其中详细介绍了这些内容，并描述了其他概念。</a></p><p id="86fd" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf"><em class="md">【DAG】</em></strong>:DAG 是你要运行的任务的集合，以及任务之间的关系和依赖关系。Dag 可以直观地表示为具有节点和边的图，其中节点表示任务，边表示任务之间的依赖性(即任务必须运行的顺序)。本质上，dag 表示您希望在 Airflow 中编排和监控的工作流。它们是“非循环的”，这意味着该图没有循环——在英语中，这意味着您的工作流必须有开始和结束(如果有循环，工作流将陷入无限循环)。</p><p id="a9a5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf"> <em class="md">操作符</em> </strong>:操作符代表在组成 DAG 工作流的任务中实际完成的事情。具体来说，一个操作符代表 DAG 中的一个任务。Airflow 提供了许多预定义的类，这些类非常灵活，可以作为任务运行。这包括用于非常常见任务的类，如 BashOperator、PythonOperator、EmailOperator、OracleOperator 等。除了众多可用的操作符类之外，Airflow 还提供了定义自己的操作符的能力。因此，DAG 中的任务几乎可以做任何您想做的事情，并且您可以使用 Airflow 对其进行调度和监控。</p><p id="81be" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf"> <em class="md">任务</em> </strong>:一个操作符的运行实例。在实例化期间，您可以定义与操作符相关联的特定参数，并且参数化的任务成为 DAG 中的一个节点。</p><h1 id="8aa1" class="la lb je bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用 Docker 部署气流并运行您的第一个 DAG</h1><p id="c803" class="pw-post-body-paragraph kb kc je kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">这篇文章的其余部分将重点介绍如何使用 docker 部署 Airflow，并且假设您对 Docker 有所了解，或者您已经阅读了我之前的文章<a class="ae kz" href="http://www.marknagelberg.com/digging-into-data-science-tools-docker/" rel="noopener ugc nofollow" target="_blank">关于如何开始使用 Docker </a>。</p><p id="6e88" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为第一步，你显然需要安装 Docker 并拥有一个 Docker Hub 帐户。一旦你这样做了，进入<a class="ae kz" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>并在存储库列表中搜索“Airflow ”,这会产生一堆结果。我们将使用第二个:<em class="md"> puckel/docker-airflow </em>，它有超过 100 万个拉点和近 100 颗星。您可以在此处找到此回购<a class="ae kz" href="https://hub.docker.com/r/puckel/docker-airflow/" rel="noopener ugc nofollow" target="_blank">的文档。你可以在这里</a>找到与这个容器<a class="ae kz" href="https://github.com/puckel/docker-airflow" rel="noopener ugc nofollow" target="_blank">相关的 github repo。</a></p><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi me"><img src="../Images/773bd9653580f16b051750231bed2f65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-4a4bsGXyXUU6dzwBek7Bw.png"/></div></div></figure><p id="2812" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，要让这个预制的容器运行 Apache Airflow，您只需输入:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="e024" class="mo lb je mk b gy mp mq l mr ms">docker pull puckel/docker-airflow</span></pre><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mt"><img src="../Images/1aca72f241410cf1e4a56a251427583b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8hFYL7ehyxTg2cB48cy6GQ.png"/></div></div></figure><p id="b193" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">过了一会儿，你就有了一个 Docker 镜像，用于运行 Docker 容器中的气流。您可以通过键入以下命令来查看您的图像已被下载:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="56fa" class="mo lb je mk b gy mp mq l mr ms">docker images</span></pre><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mu"><img src="../Images/f788168366e006099f9bd2daba539aa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKNsSm2EF65_t21qKTmvUA.png"/></div></div></figure><p id="aada" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在您已经下载了映像，您可以使用以下命令创建一个运行容器:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="c973" class="mo lb je mk b gy mp mq l mr ms">docker run -d -p 8080:8080 puckel/docker-airflow webserver</span></pre><p id="58f8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一旦你这样做了，Airflow 就在你的机器上运行，你可以通过访问<a class="ae kz" href="http://localhost:8080/admin/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/admin/</a>来访问 UI</p><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mu"><img src="../Images/67e4d006450365e0d2d22961a1da2e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bzcosU71pWXx7GxXmxSklw.png"/></div></div></figure><p id="5527" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在命令行上，您可以通过运行以下命令来查找容器名称:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="4d8c" class="mo lb je mk b gy mp mq l mr ms">docker ps</span></pre><p id="5a34" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以使用以下命令跳转到正在运行的容器的命令行:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="3c89" class="mo lb je mk b gy mp mq l mr ms">docker exec -ti &lt;container name&gt; bash</span></pre><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mv"><img src="../Images/ea082261e3ac9c35fd9c8c88d20ccdd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yLf5Tq9QJV2s-ChDbBnNMw.png"/></div></div></figure><p id="cc43" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">(在我的例子中，我的容器被 Docker 自动命名为<em class="md">主管 _ 沃恩</em></p><h2 id="964d" class="mo lb je bd lc mw mx dn lg my mz dp lk km na nb lo kq nc nd ls ku ne nf lw ng bi translated">运行 DAG</h2><p id="d6aa" class="pw-post-body-paragraph kb kc je kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">因此，您的容器已经启动并运行。现在，我们如何开始定义 Dag？</p><p id="a602" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在 Airflow 中，DAGs 定义文件是 python 脚本(“配置为代码”是 Airflow 的优势之一)。您可以通过定义脚本并简单地将其添加到 AIRFLOW _ HOME 目录下的文件夹“dags”中来创建 DAG。在我们的例子中，我们需要在容器中添加 Dag 的目录是:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="2984" class="mo lb je mk b gy mp mq l mr ms">/usr/local/airflow/dags</span></pre><p id="cd50" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">事实是，您不希望直接跳到您的容器中并在其中添加 DAG 定义文件。一个原因是安装在容器中的 Linux 最小版本甚至没有文本编辑器。但一个更重要的原因是，在 Docker 中跳转到容器中并编辑它们被认为是不好的做法，而且是“hacky ”,因为您不能再从 Docker 文件中构建容器运行的映像。</p><p id="48b1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">相反，一个解决方案是使用“volumes”，它允许您在本地机器和 Docker 容器之间共享一个目录。您添加到本地容器中的任何内容都将被添加到 Docker 中与之连接的目录中。在我们的示例中，我们将使用以下命令创建一个卷，该卷映射本地计算机上保存 DAG 定义的目录，以及 Airflow 在容器上读取它们的位置:</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="f373" class="mo lb je mk b gy mp mq l mr ms">docker run -d -p 8080:8080 -v /path/to/dags/on/your/local/machine/:/usr/local/airflow/dags  puckel/docker-airflow webserver</span></pre><p id="fa1e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们要添加的 DAG 可以在<a class="ae kz" href="https://github.com/dalvimanasi/Data-Pipe-lining-Tools/tree/master/Airflow" rel="noopener ugc nofollow" target="_blank">中找到，这个 repo 是由 Manasi Dalvi </a>创建的。DAG 被称为 Helloworld，您可以在这里找到 DAG 定义文件<a class="ae kz" href="https://github.com/dalvimanasi/Data-Pipe-lining-Tools/blob/master/Airflow/AirflowDemo/Helloworld.py" rel="noopener ugc nofollow" target="_blank"/>。(另见<a class="ae kz" href="https://www.youtube.com/watch?v=Qs02p3mh8m4" rel="noopener ugc nofollow" target="_blank">这个 YouTube 视频</a>，她介绍了气流，并展示了这个 DAG 的运行情况。)</p><p id="a188" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要将其添加到 Airflow 中，请将<em class="md"> Helloworld.py </em>复制到<em class="md">/path/to/DAGs/on/your/local/machine</em>。等待几分钟后，刷新您的 Airflow GUI，瞧，您应该会看到新的 DAG <em class="md"> Helloworld </em>:</p><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nh"><img src="../Images/5d7c04c3ce66025cbc4388031438bd54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KRrhY-3TfqI4tpZkj2jnfQ.png"/></div></div></figure><p id="79c6" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以通过进入容器并运行命令气流测试来测试 DAG 中的单个任务。首先，使用前面描述的<em class="md"> docker exec </em>命令进入容器。一旦你进入，你可以通过运行<em class="md">气流列表 _dags </em>看到你所有的 Dag。您可以在下面看到结果，我们的 Helloworld DAG 位于列表的顶部:</p><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mu"><img src="../Images/36b764900194b41879495931dfe25bf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DRefxp8mekE2PK2GwOS20g.png"/></div></div></figure><p id="9ee5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在运行完整 DAG 之前，您可以在命令行上运行的一个有用的命令是 airflow test 命令，它允许您将单个测试作为 DAG 的一部分进行测试，并将输出记录到命令行。您指定一个日期/时间，它模拟当时的运行。该命令不考虑依赖性，也不与数据库交流状态(运行、成功、失败等)，因此您不会在 Airflow GUI 中看到测试结果。因此，使用我们的 Helloworld DAG，您可以在 task_1 上运行测试</p><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="4796" class="mo lb je mk b gy mp mq l mr ms">airflow test Helloworld task_1 2015-06-01</span></pre><p id="05f4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，当我这样做时，它似乎运行没有错误；然而，我没有得到任何输出到控制台的日志。如果有人对为什么会这样有任何建议，请告诉我。</p><p id="1cbe" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以运行回填命令，指定开始日期和结束日期，以便在这些日期运行 Helloworld DAG。在下面的示例中，我从 2015 年 6 月 1 日到 6 月 7 日每天运行 dag 7 次:</p><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ni"><img src="../Images/12e2f3ed1cc984a1462f6c5cbff46c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v7P6sMtwaT2YDPBybjkggA.png"/></div></div></figure><p id="b7aa" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行此命令时，您可以在 Airflow GUI 中看到以下内容，它显示了各个任务的成功以及 DAG 的每次运行。</p><figure class="mf mg mh mi gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mu"><img src="../Images/ca24f8f1a4c5177a4e7bc3092d7b3363.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33R0oZ7a_295hWujiXKp-Q.png"/></div></div></figure><h1 id="7603" class="la lb je bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">资源</h1><ul class=""><li id="243b" class="nj nk je kd b ke ly ki lz km nl kq nm ku nn ky no np nq nr bi translated">我对你能否用 UI 创建 Dag 感到困惑，并且<a class="ae kz" href="https://stackoverflow.com/questions/48986732/airflow-creating-a-dag-in-airflow-via-ui" rel="noopener ugc nofollow" target="_blank">这个 Stackoverflow 线程</a>似乎表明你不能。注意在回答中，回答者提到了一些潜在有用的工具，用于开发用户可以在不了解 Python 的情况下定义 Dag 的 UI。</li><li id="fed8" class="nj nk je kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated"><a class="ae kz" href="https://stackoverflow.com/questions/52453414/docker-airflow-configuration-issues-puckel-docker" rel="noopener ugc nofollow" target="_blank">这个 Stackoverflow 线程</a>有助于找出体积是将 Dag 添加到容器中运行的气流的解决方案。</li><li id="2cb4" class="nj nk je kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated"><a class="ae kz" href="https://airflow.apache.org/tutorial.html" rel="noopener ugc nofollow" target="_blank">来自阿帕奇气流的官方教程</a></li><li id="9124" class="nj nk je kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated"><a class="ae kz" href="https://cwiki.apache.org/confluence/display/AIRFLOW/Common+Pitfalls" rel="noopener ugc nofollow" target="_blank">与阿帕奇气流相关的常见陷阱</a></li><li id="b687" class="nj nk je kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated"><a class="ae kz" href="https://gtoonstra.github.io/etl-with-airflow/index.html" rel="noopener ugc nofollow" target="_blank">使用气流的 ETL 最佳实践</a></li><li id="1a7b" class="nj nk je kd b ke ns ki nt km nu kq nv ku nw ky no np nq nr bi translated">如果你对学习 Docker 感兴趣，<a class="ae kz" href="http://downloadmarksbrain.marknagelberg.com/decks?search=docker" rel="noopener ugc nofollow" target="_blank">我在我的网站上有一些资源的链接</a>，还有 Anki 抽认卡，这样你就可以无限期地记住它们</li></ul></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><p id="bb2e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="md">原载于 2018 年 11 月 1 日</em><a class="ae kz" href="http://www.marknagelberg.com/getting-started-with-airflow-using-docker/" rel="noopener ugc nofollow" target="_blank"><em class="md">【www.marknagelberg.com】</em></a><em class="md">。要访问我共享的 Anki deck 和 Roam Research notes 知识库，以及关于间隔重复和提高学习效率的技巧和想法的定期更新，</em> <a class="ae kz" href="http://downloadmarksbrain.marknagelberg.com/auth" rel="noopener ugc nofollow" target="_blank"> <em class="md">加入“下载马克的大脑”。</em>T11】</a></p></div></div>    
</body>
</html>