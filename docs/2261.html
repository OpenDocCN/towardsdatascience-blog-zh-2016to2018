<html>
<head>
<title>How to Set Up a Deep Learning Environment on AWS with Keras/Theano</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Keras/Theano在AWS上搭建深度学习环境</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-set-up-a-deep-learning-environment-on-aws-with-keras-theano-b0f39e3d861c?source=collection_archive---------0-----------------------#2016-12-22">https://towardsdatascience.com/how-to-set-up-a-deep-learning-environment-on-aws-with-keras-theano-b0f39e3d861c?source=collection_archive---------0-----------------------#2016-12-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/be31f513870e085a467fde80e4fbcb1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZmOZBNPRYSY5DjaH9sP6w.jpeg"/></div></div></figure><p id="4bbc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">更新:</strong>2017年5月19日——在这篇文章中，我将一步一步地解释如何建立一个运行在<a class="ae kw" href="https://aws.amazon.com/ec2/instance-types/" rel="noopener ugc nofollow" target="_blank">亚马逊的EC2 GPU实例</a>上的深度学习环境，使用:</p><ul class=""><li id="d352" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">图片:ami-b 03 ffedf(Ubuntu Server 16.04 LTS(HVM)，SSD卷类型)</li><li id="8343" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">区域:欧盟中部-1(欧盟法兰克福)</li><li id="6b3d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">实例类型:g2.2xlarge</li><li id="3759" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">存储:30 GB(建议至少20gb以上)</li></ul><p id="5f7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">软件:</p><ul class=""><li id="1aa4" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://developer.nvidia.com/accelerated-computing-toolkit" rel="noopener ugc nofollow" target="_blank"> CUDA 8.0 </a> / <a class="ae kw" href="https://developer.nvidia.com/cudnn" rel="noopener ugc nofollow" target="_blank"> cuDNN 5.0 </a></li><li id="cea0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://www.continuum.io/downloads" rel="noopener ugc nofollow" target="_blank">带Python 3的Anaconda 4.20】</a></li><li id="255d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://keras.io/" rel="noopener ugc nofollow" target="_blank"> Keras </a> / <a class="ae kw" href="http://deeplearning.net/software/theano/" rel="noopener ugc nofollow" target="_blank"> Theano </a></li></ul><h1 id="da4f" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak"> 1。创建一个新的EC2 GPU实例</strong></h1><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/34a922833bdd790a735992deddf4617d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3hLaHOpIW7B-ATSfnTh7w.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Select the Ubuntu Server 16.04 LTS AMI.</figcaption></figure><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/24a59f8b68be3f55b426da8d916b4bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*56_-Ipv4yYvPB9lXH13r2w.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Take the g2.2xlarge GPU Instance. Alternatively, you could also take the g2.8xlarge if you need more computing power.</figcaption></figure><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/c4b9a01e5d25e0781c4f7173b41fc8f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WfHFDJkv89GRAEgAmrb97w.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Change the standard storage size to 30 GB.</figcaption></figure><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/6e6d1fae49209066067df6c33c8d7546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Wthy5Ik4oRG2F_2GCWQNg.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Launch the cluster and assign an EC2 key pair.</figcaption></figure><h1 id="cc4b" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak"> 2。在GPU实例上安装CUDA/cud nn</strong></h1><h2 id="bcba" class="mv lm iq bd ln mw mx dn lr my mz dp lv kj na nb lz kn nc nd md kr ne nf mh ng bi translated">NVIDIA驱动程序</h2><p id="1744" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">更新图形驱动程序:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="f43b" class="mv lm iq nn b gy nr ns l nt nu">$ sudo add-apt-repository ppa:graphics-drivers/ppa <!-- -->-y<br/>$ sudo apt-get update<br/>$ sudo apt-get install -y nvidia-375 nvidia-settings</span></pre><h2 id="f8be" class="mv lm iq bd ln mw mx dn lr my mz dp lv kj na nb lz kn nc nd md kr ne nf mh ng bi translated"><strong class="ak"> CUDA </strong></h2><p id="0374" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">SSH到EC2 GPU实例:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="9ec0" class="mv lm iq nn b gy nr ns l nt nu">$ ssh -i ~/folder_key_pair/key_pair.pem ubuntu@public_dns_ec2</span></pre><p id="51e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先下载CUDA 8.0到你的$HOME文件夹(<em class="nv"> /home/ubuntu </em>):</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="771f" class="mv lm iq nn b gy nr ns l nt nu">$ wget <a class="ae kw" href="https://developer.nvidia.com/compute/cuda/8.0/Prod2/local_installers/cuda-repo-ubuntu1604-8-0-local-ga2_8.0.61-1_amd64-deb" rel="noopener ugc nofollow" target="_blank">https://developer.nvidia.com/compute/cuda/8.0/Prod2/local_installers/cuda-repo-ubuntu1604-8-0-local-ga2_8.0.61-1_amd64-deb</a></span></pre><p id="ee27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装CUDA:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="f0fc" class="mv lm iq nn b gy nr ns l nt nu">$ sudo dpkg -i cuda-repo-ubuntu1604-8-0-local_8.0.44-1_amd64-deb<br/>$ sudo apt-get update<br/>$ sudo apt-get install -y cuda nvidia-cuda-toolkit</span></pre><p id="5b6c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查所有安装是否正确:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="0ef1" class="mv lm iq nn b gy nr ns l nt nu">$ nvidia-smi</span></pre><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/c331c82aedaa04411b0eb40e5d3e3dfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*0QFCFIsO1oN5tbprO680PA.png"/></div></figure><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="db8f" class="mv lm iq nn b gy nr ns l nt nu">$ nvcc --version</span></pre><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/1d792608ed99f8a8c4d13d3b64a09a18.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*tlBcy6mxD0Mcsq1nYKw9uA.png"/></div></figure><h2 id="dfa3" class="mv lm iq bd ln mw mx dn lr my mz dp lv kj na nb lz kn nc nd md kr ne nf mh ng bi translated"><strong class="ak"> cuDNN </strong></h2><p id="3bff" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">接下来，在<a class="ae kw" href="https://developer.nvidia.com/cudnn" rel="noopener ugc nofollow" target="_blank"> NVIDIA的加速计算开发者计划</a>上注册一个帐户，并将cuDNN 5.0下载到您的本地机器上:</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/0f57094ca4e0966356175844242e860c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JCDYjn_M4KhZpeokmEwoxw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">Select cuDNN v5 Library for Linux</figcaption></figure><p id="44ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将TAR归档文件SCP到EC2 GPU实例:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="2739" class="mv lm iq nn b gy nr ns l nt nu">$ scp -i ~/folder_key_pair/key_pair.pem ~/folder_tar_file/cudnn-8.0-linux-x64-v5.0-ga.tgz ubuntu@public_dns_ec2:/home/ubuntu/</span></pre><p id="395c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SSH到EC2 GPU实例并解压缩文件:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="4039" class="mv lm iq nn b gy nr ns l nt nu">$ tar -zxvf cudnn-8.0-linux-x64-v5.0-ga.tgz</span></pre><p id="8f1f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，打开<em class="nv">。巴沙尔</em>然后加上这个:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="78f1" class="mv lm iq nn b gy nr ns l nt nu">export LD_LIBRARY_PATH=/home/ubuntu/cuda/lib64:$LD_LIBRARY_PATH</span><span id="465f" class="mv lm iq nn b gy nz ns l nt nu">export CPATH=/home/ubuntu/cuda/include:$CPATH</span><span id="9f36" class="mv lm iq nn b gy nz ns l nt nu">export LIBRARY_PATH=/home/ubuntu/cuda/lib64:$LD_LIBRARY_PATH</span></pre><p id="8b7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重新装上<em class="nv">。巴沙尔:</em></p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="99cb" class="mv lm iq nn b gy nr ns l nt nu">$ source ~/.bashrc</span></pre><h1 id="806e" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak"> 3。安装Keras和Theano </strong></h1><p id="3577" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">在EC2实例上下载Anaconda并安装它:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="031b" class="mv lm iq nn b gy nr ns l nt nu">$ wget <a class="ae kw" href="https://repo.continuum.io/archive/Anaconda3-4.2.0-Linux-x86_64.sh" rel="noopener ugc nofollow" target="_blank">https://repo.continuum.io/archive/Anaconda3-4.2.0-Linux-x86_64.sh</a></span><span id="1551" class="mv lm iq nn b gy nz ns l nt nu">$ bash Anaconda3-4.2.0-Linux-x86_64.sh</span></pre><p id="5ca9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nv">注意:重新加载您的bash概要文件(源代码。bashrc)以便激活Anaconda。</em></p><p id="e28a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，安装Keras和Theano:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="ca83" class="mv lm iq nn b gy nr ns l nt nu">$ pip install --upgrade --no-deps git+git://github.com/Theano/Theano.git</span><span id="f332" class="mv lm iq nn b gy nz ns l nt nu">$ pip install keras</span></pre><p id="8722" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nv">注意:确保在Keras中将Theano用作后端。如果没有，您需要在Keras配置中更改它。keras/keras.json)，通常在python中第一次导入后创建。</em></p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="689f" class="mv lm iq nn b gy nr ns l nt nu">1 {<br/>2     "backend": "theano",<br/>3     "epsilon": 1e-07,<br/>4     "floatx": "float32",<br/>5     "image_dim_ordering": "th"<br/>6 }</span></pre><h1 id="a315" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak"> 4。测试您的环境:</strong></h1><p id="7fc3" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">现在你可以走了！通常，我倾向于用一个简单的脚本来测试我的环境，看看是否一切都像预期的那样工作。</p><p id="0c59" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是一个用于训练MNIST数据集的简单MLP网络:</p><figure class="mk ml mm mn gt jr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="1fe1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过调用以下命令运行脚本:</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="1a93" class="mv lm iq nn b gy nr ns l nt nu">$ THEANO_FLAGS=floatX=float32,device=gpu0,lib.cnmem=0.8,nvcc.flags=-D_FORCE_INLINES,dnn.enabled=True python mnist_gpu_test_script.py</span></pre><p id="f485" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者，您可以在<a class="ae kw" href="http://deeplearning.net/software/theano_versions/dev/library/config.html" rel="noopener ugc nofollow" target="_blank">的no配置</a>文件(<em class="nv">中指定设置。theanorc </em>):</p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="dfb6" class="mv lm iq nn b gy nr ns l nt nu">[global]</span><span id="03e5" class="mv lm iq nn b gy nz ns l nt nu">floatX = float32</span><span id="28f7" class="mv lm iq nn b gy nz ns l nt nu">device = gpu</span><span id="777a" class="mv lm iq nn b gy nz ns l nt nu">[lib]</span><span id="a08b" class="mv lm iq nn b gy nz ns l nt nu">cnmem = 0.8</span><span id="6844" class="mv lm iq nn b gy nz ns l nt nu">[dnn]</span><span id="b4eb" class="mv lm iq nn b gy nz ns l nt nu">enabled = true</span><span id="57af" class="mv lm iq nn b gy nz ns l nt nu">[nvcc]</span><span id="cbe6" class="mv lm iq nn b gy nz ns l nt nu">flags = -D_FORCE_INLINES</span></pre><p id="3062" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nv">注意:标志“nvcc.flags=-D_FORCE_INLINES”对于Ubuntu 16.04非常重要，因为CUDA 8.0似乎不支持默认的gcc版本(5.4.0)(参见</em> <a class="ae kw" href="https://github.com/Theano/Theano/issues/4430" rel="noopener ugc nofollow" target="_blank"> <em class="nv"> Ubuntu 16.04和CUDA</em></a><em class="nv"/><a class="ae kw" href="https://github.com/Theano/Theano/pull/4369" rel="noopener ugc nofollow" target="_blank"><em class="nv">glibc 2.23</em></a><em class="nv">)的修复)。目前这是一个棘手的问题。或者，您也可以通过使用update-alternatives将CUDA链接到一个较旧的gcc版本(参见</em> <a class="ae kw" href="http://stackoverflow.com/questions/34670989/cuda-7-5-installation-unsupported-compiler-error" rel="noopener ugc nofollow" target="_blank"> <em class="nv">此处</em> </a> <em class="nv">)。</em></p><p id="c2ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最终，这里是输出:</p><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/d4da08eaf416410b13e9895addf7200a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XG-6dCBVwA9NsES1IzT0Kw.png"/></div></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk">We can see that cuDNN is enabled (cuDNN 5005).</figcaption></figure><p id="dd4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nv">注意:监视NVIDIA的系统管理界面以查看是否有一些活动也很有趣，例如内存使用、运行进程和GPU利用率。</em></p><pre class="mk ml mm mn gt nm nn no np aw nq bi"><span id="8d80" class="mv lm iq nn b gy nr ns l nt nu">$ watch -n1 nvidia-smi</span></pre><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div class="gh gi od"><img src="../Images/d401c3effa7d3a3790682cd610a1f6be.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*tdIo1v_fBosakHRKtqkDTQ.png"/></div></figure><h1 id="47d5" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">结论/展望</strong></h1><p id="3d6b" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">在这篇博文中，我一步一步地描述了如何在AWS上建立深度学习环境。如果有不清楚的地方，请通过twitter <a class="ae kw" href="https://twitter.com/datitran" rel="noopener ugc nofollow" target="_blank"> @datitran </a>联系我，或者关注我。在下一篇文章中，我将关注如何通过使用<a class="ae kw" href="https://github.com/NVIDIA/nvidia-docker" rel="noopener ugc nofollow" target="_blank"> docker </a>来自动化上面解释的那些步骤，从而极大地加快设置过程。</p></div></div>    
</body>
</html>