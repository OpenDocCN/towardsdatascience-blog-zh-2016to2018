<html>
<head>
<title>Text Classification with State of the Art NLP Library — Flair</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用最先进的 NLP 库 Flair 进行文本分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/text-classification-with-state-of-the-art-nlp-library-flair-b541d7add21f?source=collection_archive---------1-----------------------#2018-12-24">https://towardsdatascience.com/text-classification-with-state-of-the-art-nlp-library-flair-b541d7add21f?source=collection_archive---------1-----------------------#2018-12-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="095a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Zalando Research 刚刚发布了 Flair - simple Python NLP 库的新版本！</h2></div><p id="63e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">为什么这是 NLP 的大新闻？</strong> Flair 在解决自然语言处理问题方面提供了一流的性能，例如命名实体识别(NER)、词性标注(PoS)、词义消歧和文本分类。这是一个建立在 PyTorch 之上的 NLP 框架。</p><p id="08b5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文解释了如何使用 Flair 来使用现有的和构建定制的文本分类器。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/8507007b41e2656163edf2739b0abdb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eWYm3Dm7s0t8lLWYRW4pow.jpeg"/></div></div></figure><h1 id="a945" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">介绍</h1><p id="a787" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">文本分类是一种受监督的机器学习方法，用于将句子或文本文档分类到一个或多个定义的类别中。这是一项广泛使用的自然语言处理任务，在垃圾邮件过滤、情感分析、新闻文章分类和许多其他商业相关问题中发挥着重要作用。</p><p id="df1a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">大多数当前技术水平的方法依赖于一种称为文本嵌入的技术。它将文本转换成高维空间中的数字表示。它允许将文档、句子、单词、字符(取决于我们使用的嵌入方式)表示为高维空间中的向量。</p><p id="fe66" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于 NLP 来说，Flair 是一个令人兴奋的消息，因为 Zalando Research 最近的一篇论文<a class="ae mk" href="http://alanakbik.github.io/papers/coling2018.pdf" rel="noopener ugc nofollow" target="_blank">用于序列标记的上下文字符串嵌入</a> <em class="ml"> </em>涵盖了一种始终优于以前最先进解决方案的方法。它在<strong class="kh ir"> Flair </strong>中得到实现和完全支持，可以用来构建文本分类器。</p><h1 id="6b4c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">1.做好准备</h1><p id="dc14" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">要安装 Flair，你需要<strong class="kh ir"> Python 3.6 </strong>。如果你还没有，这里有一个关于如何做的指南。然后，要安装 Flair，请运行:</p><pre class="lc ld le lf gt mm mn mo mp aw mq bi"><span id="8ea2" class="mr lo iq mn b gy ms mt l mu mv">pip install flair</span></pre><p id="09a8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将安装运行 Flair 所需的所有软件包。它还将包括 PyTorch，Flair 位于顶部。</p><h1 id="648c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">2.使用预先训练的分类模型</h1><p id="e4c8" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">新发布的<em class="ml"> 0.4 </em>带有两个预训练模型。在 IMDB 数据集上训练的情感分析模型和“攻击性语言检测”模型(目前仅支持德语)。</p><p id="ff38" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用、下载和存储模型都被合并到一个方法中，使得使用预训练模型的整个过程出奇地简单。</p><p id="e1e1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要使用情绪分析模型，只需运行:</p><pre class="lc ld le lf gt mm mn mo mp aw mq bi"><span id="6414" class="mr lo iq mn b gy ms mt l mu mv">from flair.models import TextClassifier<br/>from flair.data import Sentence</span><span id="a9b0" class="mr lo iq mn b gy mw mt l mu mv">classifier = TextClassifier.load('en-sentiment')</span><span id="9458" class="mr lo iq mn b gy mw mt l mu mv">sentence = Sentence('Flair is pretty neat!')<br/>classifier.predict(sentence)</span><span id="d4e6" class="mr lo iq mn b gy mw mt l mu mv"># print sentence with predicted labels<br/>print('Sentence above is: ', sentence.labels)</span></pre><p id="1f88" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一次运行时，Flair 将下载情感分析模型，并默认将其存储到主目录的<code class="fe mx my mz mn b">.flair</code>子文件夹中。这可能需要几分钟时间。</p><p id="0516" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面的代码首先加载所需的库，然后将情感分析模型加载到内存中(如果需要，可以先下载它)，然后预测句子<em class="ml">“Flair 非常漂亮！”</em>在 0 到 1 的刻度上<em class="ml">。</em>最后一条命令打印出来:<code class="fe mx my mz mn b">The sentence above is: [Positive (1.0)]</code>。</p><p id="e623" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！例如，现在你可以将代码整合到 REST api 中，并提供类似于 Google 的云自然语言 api 的情感分析的服务，这在大量请求的生产中使用时会被证明是非常昂贵的。</p><h1 id="e004" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">3.训练自定义文本分类器</h1><p id="f9c5" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">为了训练一个定制的文本分类器，我们首先需要一个带标签的数据集。Flair 的分类数据集格式基于脸书的<a class="ae mk" href="https://fasttext.cc/docs/en/supervised-tutorial.html" rel="noopener ugc nofollow" target="_blank">快速文本格式</a>。该格式要求在以前缀<code class="fe mx my mz mn b">__label__</code>开始的每一行的开头定义一个或多个标签。格式如下:</p><pre class="lc ld le lf gt mm mn mo mp aw mq bi"><span id="6310" class="mr lo iq mn b gy ms mt l mu mv">__label__&lt;class_1&gt; &lt;text&gt;<br/>__label__&lt;class_2&gt; &lt;text&gt;</span></pre><p id="55c8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将使用 Kaggle 的垃圾短信检测数据集来构建一个垃圾/非垃圾分类器。该数据集适合于学习，因为它仅包含 5572 行，并且足够小，可以在 CPU 上在几分钟内训练一个模型。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi na"><img src="../Images/5b28ef6c4cdbbc9b81e44d3124c62dde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YNyXbVjTDoFylV2hTwR5ng.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk">SMS messages from the dataset labelled as either spam or ham (not spam)</figcaption></figure><h2 id="c141" class="mr lo iq bd lp nf ng dn lt nh ni dp lx ko nj nk lz ks nl nm mb kw nn no md np bi translated">3.1 预处理-构建数据集</h2><p id="3287" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">我们首先从 Kaggle 上的<a class="ae mk" href="https://www.kaggle.com/uciml/sms-spam-collection-dataset" rel="noopener ugc nofollow" target="_blank">这个链接下载数据集以获得<code class="fe mx my mz mn b">spam.csv</code>。然后，在与我们的数据集相同的目录中，我们运行下面的预处理片段，它将进行一些预处理，并将我们的数据集分成训练集、开发集和测试集。</a></p><p id="3f5e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">确保你已经安装了熊猫。如果没有，先运行<code class="fe mx my mz mn b">pip install pandas</code>。</p><pre class="lc ld le lf gt mm mn mo mp aw mq bi"><span id="286e" class="mr lo iq mn b gy ms mt l mu mv">import pandas as pd<br/>data = pd.read_csv("./spam.csv", encoding='latin-1').sample(frac=1).drop_duplicates()</span><span id="bfc7" class="mr lo iq mn b gy mw mt l mu mv">data = data[['v1', 'v2']].rename(columns={"v1":"label", "v2":"text"})<br/> <br/>data['label'] = '__label__' + data['label'].astype(str)</span><span id="cbf8" class="mr lo iq mn b gy mw mt l mu mv">data.iloc[0:int(len(data)*0.8)].to_csv('train.csv', sep='\t', index = False, header = False)<br/>data.iloc[int(len(data)*0.8):int(len(data)*0.9)].to_csv('test.csv', sep='\t', index = False, header = False)<br/>data.iloc[int(len(data)*0.9):].to_csv('dev.csv', sep='\t', index = False, header = False);</span></pre><p id="b719" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将从我们的数据集中删除一些重复的数据，对其进行混洗(随机化行)，并使用 80/10/10 拆分将数据分为训练集、开发集和测试集。</p><p id="48e8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果运行成功，你将得到以 FastText 格式格式化的<code class="fe mx my mz mn b">train.csv</code>、<code class="fe mx my mz mn b">test.csv</code>和<code class="fe mx my mz mn b">dev.csv</code>，准备与 Flair 一起使用。</p><h2 id="557a" class="mr lo iq bd lp nf ng dn lt nh ni dp lx ko nj nk lz ks nl nm mb kw nn no md np bi translated">3.2 训练自定义文本分类模型</h2><p id="316a" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">若要定型模型，请在与生成的数据集相同的目录中运行此代码片段。</p><pre class="lc ld le lf gt mm mn mo mp aw mq bi"><span id="23b7" class="mr lo iq mn b gy ms mt l mu mv">from flair.data_fetcher import NLPTaskDataFetcher<br/>from flair.embeddings import WordEmbeddings, FlairEmbeddings, DocumentLSTMEmbeddings<br/>from flair.models import TextClassifier<br/>from flair.trainers import ModelTrainer<br/>from pathlib import Path</span><span id="7c28" class="mr lo iq mn b gy mw mt l mu mv">corpus = NLPTaskDataFetcher.load_classification_corpus(Path('./'), test_file='test.csv', dev_file='dev.csv', train_file='train.csv')</span><span id="616c" class="mr lo iq mn b gy mw mt l mu mv">word_embeddings = [WordEmbeddings('glove'), FlairEmbeddings('news-forward-fast'), FlairEmbeddings('news-backward-fast')]</span><span id="7c18" class="mr lo iq mn b gy mw mt l mu mv">document_embeddings = DocumentLSTMEmbeddings(word_embeddings, hidden_size=512, reproject_words=True, reproject_words_dimension=256)</span><span id="1581" class="mr lo iq mn b gy mw mt l mu mv">classifier = TextClassifier(document_embeddings, label_dictionary=corpus.make_label_dictionary(), multi_label=False)</span><span id="ef6d" class="mr lo iq mn b gy mw mt l mu mv">trainer = ModelTrainer(classifier, corpus)</span><span id="917b" class="mr lo iq mn b gy mw mt l mu mv">trainer.train('./', max_epochs=10)</span></pre><p id="b237" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一次运行这段代码时，Flair 将下载所有需要的嵌入模型，这可能需要几分钟的时间。整个训练过程还需要 5 分钟。</p><p id="8c5e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个代码片段首先将所需的库和数据集加载到一个 corpus 对象中。</p><p id="ca83" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们创建一个嵌入列表(两个 Flair 上下文 sting 嵌入和一个 GloVe 单词嵌入)。然后，这个列表被用作我们的文档嵌入对象的输入。堆叠和文档嵌入是 Flair 最有趣的概念之一。它们提供了将不同的嵌入组合在一起的方法。您可以将传统的单词嵌入(如 GloVe、word2vec、ELMo)与 Flair 上下文 sting 嵌入一起使用。在上面的例子中，我们使用了基于 LSTM 的方法来组合单词和上下文串嵌入，以生成文档嵌入。你可以在这里了解更多关于<a class="ae mk" href="https://github.com/zalandoresearch/flair/blob/master/resources/docs/TUTORIAL_5_DOCUMENT_EMBEDDINGS.md" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="f5b7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，代码片段训练模型，产生代表我们存储的训练模型的<code class="fe mx my mz mn b">final-model.pt</code>和<code class="fe mx my mz mn b">best-model.pt</code>文件。</p><h2 id="84e7" class="mr lo iq bd lp nf ng dn lt nh ni dp lx ko nj nk lz ks nl nm mb kw nn no md np bi translated">3.3 使用训练好的模型进行预测</h2><p id="2743" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">现在，我们可以通过从同一目录运行以下代码片段，使用导出的模型来生成预测:</p><pre class="lc ld le lf gt mm mn mo mp aw mq bi"><span id="4d5d" class="mr lo iq mn b gy ms mt l mu mv">from flair.models import TextClassifier<br/>from flair.data import Sentence</span><span id="16c0" class="mr lo iq mn b gy mw mt l mu mv">classifier = TextClassifier.load_from_file('./best-model.pt')</span><span id="9d41" class="mr lo iq mn b gy mw mt l mu mv">sentence = Sentence('Hi. Yes mum, I will...')</span><span id="a803" class="mr lo iq mn b gy mw mt l mu mv">classifier.predict(sentence)</span><span id="6f60" class="mr lo iq mn b gy mw mt l mu mv">print(sentence.labels)</span></pre><p id="5d03" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该代码片段打印出'<em class="ml">[火腿(1.0)]'【T5]，这意味着模型 100%确定我们的示例消息不是垃圾邮件。</em></p><h1 id="3c27" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">与其他框架相比，它的表现如何？</h1><p id="d9da" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">与脸书的 FastText 甚至谷歌的 AutoML 自然语言平台不同，用 Flair 进行文本分类仍然是一项相对低级的任务。我们可以通过设置学习速率、批量大小、退火因子、损失函数、优化器选择等参数选项，完全控制文本嵌入和训练的完成方式……为了实现最佳性能，需要调整这些超级参数。Flair 为我们提供了一个众所周知的 hyper parameter tuning library hyperpt(<a class="ae mk" href="https://github.com/zalandoresearch/flair/blob/master/resources/docs/TUTORIAL_8_MODEL_OPTIMIZATION.md" rel="noopener ugc nofollow" target="_blank">在这里描述</a>)的包装器，我们可以使用它来调整我们的 hyper parameters 以获得最佳性能。</p><p id="ef7b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，为了简单起见，我们使用了默认的 hyper 参数。使用大多数默认参数<strong class="kh ir">，我们的 Flair 模型</strong>在 10 个周期后获得了 0.973 的<strong class="kh ir"> f1 分数。</strong></p><p id="c3c2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了进行比较，我们在 AutoML 自然语言平台上用 FastText 训练了一个文本分类模型。我们首先使用默认参数运行了<strong class="kh ir"> FastText </strong>，并获得了 0.883 的<strong class="kh ir"> f1 分数，这意味着我们的模型远远超过了 FastText。然而，FastText 只需要几秒钟就可以完成训练，而我们定制的 Flair 模型则需要 5 分钟。</strong></p><p id="6e4b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们还将我们的结果与在谷歌的自动自然语言平台上获得的结果进行了比较。该平台首先需要 20 分钟来解析数据集。之后，我们开始了训练过程，花了近 3 个小时完成(花费了近 10 美元的免费积分)，但取得了 99.211 - 的<strong class="kh ir"> f1 分数，比我们的定制天赋模型略好。</strong></p><h1 id="95c1" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">最后的想法</h1><p id="1b80" class="pw-post-body-paragraph kf kg iq kh b ki mf jr kk kl mg ju kn ko mh kq kr ks mi ku kv kw mj ky kz la ij bi translated">这篇文章应该让你大致了解如何使用 Flair 进行文本分类。</p><p id="b340" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae mk" rel="noopener" target="_blank" href="/how-to-beat-automl-hyperparameter-optimisation-with-flair-3b2f5092d9f5">在下一期出版物</a>中，我们将解释如何调整 Flair 的 hyper 参数以实现最佳性能，并在文本分类方面击败谷歌的 AutoML。</p></div></div>    
</body>
</html>