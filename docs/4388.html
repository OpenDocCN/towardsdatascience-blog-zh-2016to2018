<html>
<head>
<title>A Machine Learning Approach — Building a Hotel Recommendation Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">机器学习方法——构建酒店推荐引擎</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-machine-learning-approach-building-a-hotel-recommendation-engine-6812bfd53f50?source=collection_archive---------3-----------------------#2018-08-13">https://towardsdatascience.com/a-machine-learning-approach-building-a-hotel-recommendation-engine-6812bfd53f50?source=collection_archive---------3-----------------------#2018-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/7653065a531c12249c770f011bba7f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uRcsFm82IbkfOVFzVQ85Kw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">source: Expedia</figcaption></figure><div class=""/><div class=""><h2 id="1ae0" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">人工智能驱动的个性化，旅游推荐</h2></div><p id="1d20" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">所有在线旅行社都在争先恐后地满足亚马逊和网飞设定的人工智能驱动的个性化标准。此外，在线旅游世界已经成为一个竞争激烈的空间，品牌试图通过推荐、比较、匹配和分享来吸引我们的注意力(和钱包)。</p><p id="c9ad" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在本帖中，我们的目标是为 Expedia 的用户创建最佳酒店推荐，这些用户正在搜索要预订的酒店。我们将把这个问题建模为一个多类分类问题，并使用集成方法建立 SVM 和决策树，以预测用户在给定他(或她)的搜索细节的情况下可能预订哪个“酒店群”。</p><h1 id="a8c2" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">数据</h1><p id="0fdd" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">数据是匿名的，几乎所有的字段都是数字格式。数据集可以在<a class="ae mn" href="https://www.kaggle.com/c/expedia-hotel-recommendations/data" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>找到，我们将使用 train.csv 和 destinations.csv，前者捕获用户行为的日志，后者包含与用户对酒店的评论相关的信息。</p><p id="a264" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">下面的图 1 提供了 train.csv 的模式:</p><figure class="mp mq mr ms gt is gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/7a0b58ef4e8fdef94bb46eb26c7f82c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*bWe_c12XHK1CF02IQFm0xA.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 1</figcaption></figure><p id="8be8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">下面的图 2 提供了 destinations.csv 的模式:</p><figure class="mp mq mr ms gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mt"><img src="../Images/8566ccd8f8a5d55f799745a48b6104c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gq3jTrfzouEstun9DPw4pw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 2</figcaption></figure><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="d844" class="mz lr jf mv b gy na nb l nc nd">import datetime<br/>import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>import seaborn as sns<br/>%matplotlib inline</span><span id="0c1b" class="mz lr jf mv b gy ne nb l nc nd">from sklearn.model_selection import cross_val_score<br/>from sklearn.ensemble import RandomForestClassifier<br/>from sklearn.pipeline import make_pipeline<br/>from sklearn import preprocessing<br/>from sklearn.preprocessing import StandardScaler<br/>from sklearn import svm</span></pre><p id="4c3e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">为了能够在本地处理，我们随机抽取 1%的记录。之后我们还有大量的记录在 241179。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="fac7" class="mz lr jf mv b gy na nb l nc nd">df = pd.read_csv('train.csv.gz', sep=',').dropna()<br/>dest = pd.read_csv('destinations.csv.gz')<br/>df = df.sample(frac=0.01, random_state=99)<br/>df.shape</span></pre><p id="ab8a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"> <em class="nf"> (241179，24) </em> </strong></p><h1 id="0beb" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">电子设计自动化(Electronic Design Automation)</h1><p id="ef90" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">目标是根据用户搜索中的信息，预测用户将预订哪个酒店。总共有 100 个集群。换句话说，我们正在处理一个 100 级的分类问题。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="1069" class="mz lr jf mv b gy na nb l nc nd">plt.figure(figsize=(12, 6))<br/>sns.distplot(df['hotel_cluster'])</span></pre><figure class="mp mq mr ms gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/c662cb483166c7b2e09ca010d40b013c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BCaacZ5jVZd8mDs4MoYf0Q.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 3</figcaption></figure><p id="dda8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">数据分布在所有 100 个集群中，并且数据中存在偏斜。</p><h1 id="1d58" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">特征工程</h1><p id="905e" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">日期时间、入住日期和退房日期列不能直接使用，我们将从中提取年和月。首先，我们定义了几个函数来实现这一点，我们还定义了一个函数来与 destination.csv 合并。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="403f" class="mz lr jf mv b gy na nb l nc nd">from datetime import datetime<br/>def get_year(x):<br/>    if x is not None and type(x) is not float:<br/>        try:<br/>            return datetime.strptime(x, '%Y-%m-%d').year<br/>        except ValueError:<br/>            return datetime.strptime(x, '%Y-%m-%d %H:%M:%S').year<br/>    else:<br/>        return 2013<br/>    pass</span><span id="6e88" class="mz lr jf mv b gy ne nb l nc nd">def get_month(x):<br/>    if x is not None and type(x) is not float:<br/>        try:<br/>            return datetime.strptime(x, '%Y-%m-%d').month<br/>        except:<br/>            return datetime.strptime(x, '%Y-%m-%d %H:%M:%S').month<br/>    else:<br/>        return 1<br/>    pass<br/>    <br/>def left_merge_dataset(left_dframe, right_dframe, merge_column):<br/>    return pd.merge(left_dframe, right_dframe, on=merge_column, how='left')</span></pre><p id="ffdb" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">处理日期时间列:</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="bee0" class="mz lr jf mv b gy na nb l nc nd">df['date_time_year'] = pd.Series(df.date_time, index = df.index)<br/>df['date_time_month'] = pd.Series(df.date_time, index = df.index)</span><span id="9daa" class="mz lr jf mv b gy ne nb l nc nd">from datetime import datetime<br/>df.date_time_year = df.date_time_year.apply(lambda x: get_year(x))<br/>df.date_time_month = df.date_time_month.apply(lambda x: get_month(x))</span><span id="2d05" class="mz lr jf mv b gy ne nb l nc nd">del df['date_time']</span></pre><p id="e15e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">处理 srch_ci 列:</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="3d05" class="mz lr jf mv b gy na nb l nc nd">df['srch_ci_year'] = pd.Series(df.srch_ci, index=df.index)<br/>df['srch_ci_month'] = pd.Series(df.srch_ci, index=df.index)</span><span id="094f" class="mz lr jf mv b gy ne nb l nc nd"># convert year &amp; months to int<br/>df.srch_ci_year = df.srch_ci_year.apply(lambda x: get_year(x))<br/>df.srch_ci_month = df.srch_ci_month.apply(lambda x: get_month(x))</span><span id="36f8" class="mz lr jf mv b gy ne nb l nc nd"># remove the srch_ci column<br/>del df['srch_ci']</span></pre><p id="1290" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">处理 srch_co 列:</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="3e80" class="mz lr jf mv b gy na nb l nc nd">df['srch_co_year'] = pd.Series(df.srch_co, index=df.index)<br/>df['srch_co_month'] = pd.Series(df.srch_co, index=df.index)</span><span id="95af" class="mz lr jf mv b gy ne nb l nc nd"># convert year &amp; months to int<br/>df.srch_co_year = df.srch_co_year.apply(lambda x: get_year(x))<br/>df.srch_co_month = df.srch_co_month.apply(lambda x: get_month(x))</span><span id="8d25" class="mz lr jf mv b gy ne nb l nc nd"># remove the srch_co column<br/>del df['srch_co']</span></pre><h1 id="287d" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">初步分析</h1><p id="c593" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">在创建新特性并删除无用的特性后，我们想知道是否有任何东西与 hotel_cluster 有很好的关联。这将告诉我们是否应该更加关注任何特定的功能。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="481b" class="mz lr jf mv b gy na nb l nc nd">df.corr()["hotel_cluster"].sort_values()</span></pre><figure class="mp mq mr ms gt is gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/81579edd884b29e0ae7e74f34f750cc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*M9gjvFVjMJjOeC3bsgC27A.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 4</figcaption></figure><p id="0278" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">没有与 hotel_cluster 线性相关的列，这意味着对特征之间的线性关系建模的方法可能不适合该问题。</p><h1 id="67cb" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">战略</h1><p id="4f95" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">快速谷歌搜索后，不难发现，对于搜索目的地、酒店国家、酒店市场的已知组合，肯定有助于找到酒店集群。就这么办吧。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="e7c0" class="mz lr jf mv b gy na nb l nc nd">pieces = [df.groupby(['srch_destination_id','hotel_country','hotel_market','hotel_cluster'])['is_booking'].agg(['sum','count'])]<br/>agg = pd.concat(pieces).groupby(level=[0,1,2,3]).sum()<br/>agg.dropna(inplace=True)<br/>agg.head()</span></pre><figure class="mp mq mr ms gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/d494f33dec3a92c894b87aec06184b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3k6KD1lXpqqxeERtqLy7OQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 5</figcaption></figure><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="dec6" class="mz lr jf mv b gy na nb l nc nd">agg['sum_and_cnt'] = 0.85*agg['sum'] + 0.15*agg['count']<br/>agg = agg.groupby(level=[0,1,2]).apply(lambda x: x.astype(float)/x.sum())<br/>agg.reset_index(inplace=True)<br/>agg.head()</span></pre><figure class="mp mq mr ms gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nj"><img src="../Images/90cfff2406cadee6bd4ad9d3a4d44ec4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o3zrCykmqpzDaHRO1O34Ag.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 6</figcaption></figure><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="ef03" class="mz lr jf mv b gy na nb l nc nd">agg_pivot = agg.pivot_table(index=['srch_destination_id','hotel_country','hotel_market'], columns='hotel_cluster', values='sum_and_cnt').reset_index()<br/>agg_pivot.head()</span></pre><figure class="mp mq mr ms gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nk"><img src="../Images/ee52ee54fbf4f753c1e48d2a17919677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQ_2xpMTYIg42HqFIuqBkA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Figure 7</figcaption></figure><p id="b5f7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">与目标表和我们新创建的聚合数据透视表合并。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="109c" class="mz lr jf mv b gy na nb l nc nd">df = pd.merge(df, dest, how='left', on='srch_destination_id')<br/>df = pd.merge(df, agg_pivot, how='left', on=['srch_destination_id','hotel_country','hotel_market'])<br/>df.fillna(0, inplace=True)<br/>df.shape</span></pre><p id="3fcb" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"> <em class="nf"> (241179，276) </em> </strong></p><h1 id="529d" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">实现算法</h1><p id="d500" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">我们只对预订活动感兴趣。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="6c31" class="mz lr jf mv b gy na nb l nc nd">df = df.loc[df['is_booking'] == 1]</span></pre><p id="8093" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">获取要素和标签。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="9836" class="mz lr jf mv b gy na nb l nc nd">X = df.drop(['user_id', 'hotel_cluster', 'is_booking'], axis=1)<br/>y = df.hotel_cluster</span></pre><h2 id="7c30" class="mz lr jf bd ls nl nm dn lw nn no dp ma ld np nq mc lh nr ns me ll nt nu mg nv bi translated">朴素贝叶斯</h2><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="cc4c" class="mz lr jf mv b gy na nb l nc nd">from sklearn.naive_bayes import GaussianNB</span><span id="d14a" class="mz lr jf mv b gy ne nb l nc nd">clf = make_pipeline(preprocessing.StandardScaler(), GaussianNB(priors=None))<br/>np.mean(cross_val_score(clf, X, y, cv=10))</span></pre><p id="9a27" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"><em class="nf">0.10347912437041926</em></strong></p><h2 id="72d9" class="mz lr jf bd ls nl nm dn lw nn no dp ma ld np nq mc lh nr ns me ll nt nu mg nv bi translated">k 近邻分类器</h2><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="6a7e" class="mz lr jf mv b gy na nb l nc nd">from sklearn.neighbors import KNeighborsClassifier</span><span id="cf24" class="mz lr jf mv b gy ne nb l nc nd">clf = make_pipeline(preprocessing.StandardScaler(), KNeighborsClassifier(n_neighbors=5))<br/>np.mean(cross_val_score(clf, X, y, cv=10, scoring='accuracy'))</span></pre><p id="11d8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">T5 0.25631461834732266T7】</strong></p><h2 id="e1dc" class="mz lr jf bd ls nl nm dn lw nn no dp ma ld np nq mc lh nr ns me ll nt nu mg nv bi translated">随机森林分类器</h2><p id="b416" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">我们通过<a class="ae mn" href="http://scikit-learn.org/stable/modules/cross_validation.html" rel="noopener ugc nofollow" target="_blank"><em class="nf">k</em>-折叠交叉验证</a>来报告性能测量，并且<a class="ae mn" href="http://scikit-learn.org/stable/modules/generated/sklearn.pipeline.make_pipeline.html" rel="noopener ugc nofollow" target="_blank">流水线</a>使得构建评估器更加容易。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="3abf" class="mz lr jf mv b gy na nb l nc nd">clf = make_pipeline(preprocessing.StandardScaler(), RandomForestClassifier(n_estimators=273,max_depth=10,random_state=0))<br/>np.mean(cross_val_score(clf, X, y, cv=10))</span></pre><p id="4031" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"><em class="nf">0.24865023372782996</em></strong></p><h2 id="9793" class="mz lr jf bd ls nl nm dn lw nn no dp ma ld np nq mc lh nr ns me ll nt nu mg nv bi translated">多类逻辑回归</h2><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="ad2b" class="mz lr jf mv b gy na nb l nc nd">from sklearn.linear_model import LogisticRegression</span><span id="e670" class="mz lr jf mv b gy ne nb l nc nd">clf = make_pipeline(preprocessing.StandardScaler(), LogisticRegression(multi_class='ovr'))<br/>np.mean(cross_val_score(clf, X, y, cv=10))</span></pre><p id="13b6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"><em class="nf">0.3045543572367767</em></strong></p><h2 id="42a0" class="mz lr jf bd ls nl nm dn lw nn no dp ma ld np nq mc lh nr ns me ll nt nu mg nv bi translated">SVM 分类器</h2><p id="8cff" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">SVM 非常耗时。然而，我们取得了更好的结果。</p><pre class="mp mq mr ms gt mu mv mw mx aw my bi"><span id="770d" class="mz lr jf mv b gy na nb l nc nd">from sklearn import svm</span><span id="717a" class="mz lr jf mv b gy ne nb l nc nd">clf = make_pipeline(preprocessing.StandardScaler(), svm.SVC(decision_function_shape='ovo'))<br/>np.mean(cross_val_score(clf, X, y, cv=10))</span></pre><p id="5613" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"><em class="nf">0.3228727137315005</em></strong></p><p id="e966" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">似乎我们需要做更多的特征工程来改善结果。敬请期待进一步的改进！</p><p id="9e2c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">源代码可以在<a class="ae mn" href="https://github.com/susanli2016/Machine-Learning-with-Python/blob/master/Hotel%20recommendation.ipynb" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。祝你一周愉快！</p></div></div>    
</body>
</html>